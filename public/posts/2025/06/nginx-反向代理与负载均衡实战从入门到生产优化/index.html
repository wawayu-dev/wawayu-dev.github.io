<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ– | åšå®¢å–µ</title>
<meta name="keywords" content="Nginx, Linux, æœ€ä½³å®è·µ">
<meta name="description" content="æ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„åŸç†ä¸å®è·µï¼Œæ¶µç›–é…ç½®ä¼˜åŒ–ã€å¥åº·æ£€æŸ¥ã€ä¼šè¯ä¿æŒç­‰ç”Ÿäº§çº§æ–¹æ¡ˆ">
<meta name="author" content="wawayu">
<link rel="canonical" href="http://localhost:1313/posts/2025/06/nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E6%88%98%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E4%BC%98%E5%8C%96/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.a29c24210eb31d9ce56f669c66a35c9c51b17376b7764e336a49af7dec914cf0.css" integrity="sha256-opwkIQ6zHZzlb2acZqNcnFGxc3a3dk4zakmvfeyRTPA=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/2025/06/nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E6%88%98%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E4%BC%98%E5%8C%96/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="http://localhost:1313/posts/2025/06/nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E6%88%98%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E4%BC%98%E5%8C%96/">
  <meta property="og:site_name" content="åšå®¢å–µ">
  <meta property="og:title" content="Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ–">
  <meta property="og:description" content="æ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„åŸç†ä¸å®è·µï¼Œæ¶µç›–é…ç½®ä¼˜åŒ–ã€å¥åº·æ£€æŸ¥ã€ä¼šè¯ä¿æŒç­‰ç”Ÿäº§çº§æ–¹æ¡ˆ">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-06-25T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-06-25T00:00:00+00:00">
    <meta property="article:tag" content="Nginx">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="æœ€ä½³å®è·µ">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ–">
<meta name="twitter:description" content="æ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„åŸç†ä¸å®è·µï¼Œæ¶µç›–é…ç½®ä¼˜åŒ–ã€å¥åº·æ£€æŸ¥ã€ä¼šè¯ä¿æŒç­‰ç”Ÿäº§çº§æ–¹æ¡ˆ">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ–",
      "item": "http://localhost:1313/posts/2025/06/nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E6%88%98%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E4%BC%98%E5%8C%96/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ–",
  "name": "Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ–",
  "description": "æ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„åŸç†ä¸å®è·µï¼Œæ¶µç›–é…ç½®ä¼˜åŒ–ã€å¥åº·æ£€æŸ¥ã€ä¼šè¯ä¿æŒç­‰ç”Ÿäº§çº§æ–¹æ¡ˆ",
  "keywords": [
    "Nginx", "Linux", "æœ€ä½³å®è·µ"
  ],
  "articleBody": "Nginx ä½œä¸ºé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå·²ç»æˆä¸ºäº’è”ç½‘æ¶æ„ä¸­çš„æ ‡é…ç»„ä»¶ã€‚æ— è®ºæ˜¯é™æ€èµ„æºæœåŠ¡ã€åå‘ä»£ç†è¿˜æ˜¯è´Ÿè½½å‡è¡¡ï¼ŒNginx éƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚\næœ¬æ–‡å°†ä»å®é™…åœºæ™¯å‡ºå‘ï¼Œæ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œå¸®åŠ©ä½ æ„å»ºé«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åå‘ä»£ç†ä¸æ­£å‘ä»£ç†çš„åŒºåˆ« æŒæ¡ Nginx è´Ÿè½½å‡è¡¡çš„å¤šç§ç­–ç•¥ å­¦ä¼šé…ç½®å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» äº†è§£ä¼šè¯ä¿æŒçš„å®ç°æ–¹æ¡ˆ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§ åå‘ä»£ç†åŸºç¡€ æ­£å‘ä»£ç† vs åå‘ä»£ç† æ­£å‘ä»£ç†ï¼šå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®\n1å®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨ 2ï¼ˆå®¢æˆ·ç«¯é…ç½®ä»£ç†ï¼‰ åå‘ä»£ç†ï¼šå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å†³å®šè½¬å‘åˆ°å“ªå°æœåŠ¡å™¨\n1å®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨é›†ç¾¤ 2ï¼ˆæœåŠ¡ç«¯é…ç½®ä»£ç†ï¼‰ åå‘ä»£ç†çš„ä¼˜åŠ¿ è´Ÿè½½å‡è¡¡ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨ éšè—çœŸå®æœåŠ¡å™¨ï¼šæé«˜å®‰å…¨æ€§ SSL å¸è½½ï¼šåœ¨ä»£ç†å±‚å¤„ç† HTTPS ç¼“å­˜é™æ€èµ„æºï¼šå‡è½»åç«¯å‹åŠ› ç»Ÿä¸€å…¥å£ï¼šä¾¿äºç®¡ç†å’Œç›‘æ§ æ¶æ„æ€è€ƒï¼š åå‘ä»£ç†ä¸ä»…æ˜¯æµé‡åˆ†å‘å™¨ï¼Œæ›´æ˜¯æ¶æ„ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•ã€æµé‡æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚\nNginx åå‘ä»£ç†é…ç½® åŸºç¡€é…ç½® 1# /etc/nginx/nginx.conf 2 3user nginx; 4worker_processes auto; # è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° 5error_log /var/log/nginx/error.log warn; 6pid /var/run/nginx.pid; 7 8events { 9 worker_connections 1024; # æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° 10 use epoll; # Linux ä¸‹ä½¿ç”¨ epoll 11} 12 13http { 14 include /etc/nginx/mime.types; 15 default_type application/octet-stream; 16 17 # æ—¥å¿—æ ¼å¼ 18 log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' 19 '$status $body_bytes_sent \"$http_referer\" ' 20 '\"$http_user_agent\" \"$http_x_forwarded_for\" ' 21 '$request_time $upstream_response_time'; 22 23 access_log /var/log/nginx/access.log main; 24 25 sendfile on; 26 tcp_nopush on; 27 tcp_nodelay on; 28 keepalive_timeout 65; 29 types_hash_max_size 2048; 30 31 # åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶ 32 include /etc/nginx/conf.d/*.conf; 33} ç®€å•åå‘ä»£ç† 1# /etc/nginx/conf.d/api.conf 2 3server { 4 listen 80; 5 server_name api.example.com; 6 7 location / { 8 # ä»£ç†åˆ°åç«¯æœåŠ¡å™¨ 9 proxy_pass http://192.168.1.100:8080; 10 11 # è®¾ç½®è¯·æ±‚å¤´ 12 proxy_set_header Host $host; 13 proxy_set_header X-Real-IP $remote_addr; 14 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 15 proxy_set_header X-Forwarded-Proto $scheme; 16 17 # è¶…æ—¶è®¾ç½® 18 proxy_connect_timeout 60s; 19 proxy_send_timeout 60s; 20 proxy_read_timeout 60s; 21 } 22} è·¯å¾„é‡å†™ 1server { 2 listen 80; 3 server_name api.example.com; 4 5 # å°† /api/v1/users ä»£ç†åˆ° http://backend/users 6 location /api/v1/ { 7 proxy_pass http://backend/; # æ³¨æ„æœ«å°¾çš„ / 8 proxy_set_header Host $host; 9 } 10 11 # å°† /old-api é‡å†™ä¸º /new-api 12 location /old-api { 13 rewrite ^/old-api/(.*)$ /new-api/$1 break; 14 proxy_pass http://backend; 15 } 16} è´Ÿè½½å‡è¡¡ç­–ç•¥ 1. è½®è¯¢ï¼ˆRound Robinï¼‰ é»˜è®¤ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†é…è¯·æ±‚ï¼š\n1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5} 6 7server { 8 listen 80; 9 server_name api.example.com; 10 11 location / { 12 proxy_pass http://backend; 13 } 14} 2. åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰ æ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…ä¸åŒæƒé‡ï¼š\n1upstream backend { 2 server 192.168.1.101:8080 weight=3; # æƒé‡ 3 3 server 192.168.1.102:8080 weight=2; # æƒé‡ 2 4 server 192.168.1.103:8080 weight=1; # æƒé‡ 1 5} æƒé‡ä¸º 3:2:1ï¼Œæ„å‘³ç€æ¯ 6 ä¸ªè¯·æ±‚ä¸­ï¼Œ101 æœåŠ¡å™¨å¤„ç† 3 ä¸ªï¼Œ102 å¤„ç† 2 ä¸ªï¼Œ103 å¤„ç† 1 ä¸ªã€‚\n3. IP Hash æ ¹æ®å®¢æˆ·ç«¯ IP è¿›è¡Œå“ˆå¸Œï¼ŒåŒä¸€ IP çš„è¯·æ±‚æ€»æ˜¯åˆ†é…åˆ°åŒä¸€å°æœåŠ¡å™¨ï¼š\n1upstream backend { 2 ip_hash; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šéœ€è¦ä¼šè¯ä¿æŒçš„åº”ç”¨ï¼ˆå¦‚è´­ç‰©è½¦ã€ç™»å½•çŠ¶æ€ï¼‰\nç¼ºç‚¹ï¼š\nè´Ÿè½½å¯èƒ½ä¸å‡è¡¡ï¼ˆIP åˆ†å¸ƒä¸å‡ï¼‰ æ— æ³•åº”å¯¹æœåŠ¡å™¨æ•…éšœï¼ˆIP é‡æ–°å“ˆå¸Œï¼‰ 4. æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰ å°†è¯·æ±‚åˆ†é…ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ï¼š\n1upstream backend { 2 least_conn; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šè¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚è¾ƒå¤§çš„åº”ç”¨\n5. ä¸€è‡´æ€§å“ˆå¸Œï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ 1upstream backend { 2 hash $request_uri consistent; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šç¼“å­˜æœåŠ¡å™¨é›†ç¾¤\nè´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯” ç­–ç•¥ ä¼˜ç‚¹ ç¼ºç‚¹ é€‚ç”¨åœºæ™¯ è½®è¯¢ ç®€å•ã€å‡è¡¡ æ— ä¼šè¯ä¿æŒ æ— çŠ¶æ€æœåŠ¡ åŠ æƒè½®è¯¢ è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½ æ— ä¼šè¯ä¿æŒ æœåŠ¡å™¨æ€§èƒ½ä¸åŒ IP Hash ä¼šè¯ä¿æŒ è´Ÿè½½å¯èƒ½ä¸å‡ æœ‰çŠ¶æ€æœåŠ¡ æœ€å°‘è¿æ¥ åŠ¨æ€å‡è¡¡ è®¡ç®—å¼€é”€å¤§ é•¿è¿æ¥æœåŠ¡ ä¸€è‡´æ€§å“ˆå¸Œ ç¼“å­˜å‘½ä¸­ç‡é«˜ å®ç°å¤æ‚ ç¼“å­˜é›†ç¾¤ å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» è¢«åŠ¨å¥åº·æ£€æŸ¥ Nginx é»˜è®¤çš„å¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œå½“è¯·æ±‚å¤±è´¥æ—¶æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¯ç”¨ï¼š\n1upstream backend { 2 server 192.168.1.101:8080 max_fails=3 fail_timeout=30s; 3 server 192.168.1.102:8080 max_fails=3 fail_timeout=30s; 4 server 192.168.1.103:8080 max_fails=3 fail_timeout=30s; 5} å‚æ•°è¯´æ˜ï¼š\nmax_fails=3ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡åæ ‡è®°ä¸ºä¸å¯ç”¨ fail_timeout=30sï¼šæ ‡è®°ä¸ºä¸å¯ç”¨åï¼Œ30 ç§’å†…ä¸å†åˆ†é…è¯·æ±‚ ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆNginx Plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ ä½¿ç”¨ nginx_upstream_check_module æ¨¡å—ï¼š\n1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5 6 check interval=3000 rise=2 fall=3 timeout=1000 type=http; 7 check_http_send \"HEAD /health HTTP/1.0\\r\\n\\r\\n\"; 8 check_http_expect_alive http_2xx http_3xx; 9} 10 11server { 12 listen 80; 13 14 location /status { 15 check_status; 16 access_log off; 17 } 18} å‚æ•°è¯´æ˜ï¼š\ninterval=3000ï¼šæ¯ 3 ç§’æ£€æŸ¥ä¸€æ¬¡ rise=2ï¼šè¿ç»­æˆåŠŸ 2 æ¬¡æ ‡è®°ä¸ºå¯ç”¨ fall=3ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡æ ‡è®°ä¸ºä¸å¯ç”¨ timeout=1000ï¼šè¶…æ—¶æ—¶é—´ 1 ç§’ type=httpï¼šä½¿ç”¨ HTTP åè®®æ£€æŸ¥ å¤‡ç”¨æœåŠ¡å™¨ 1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5 server 192.168.1.104:8080 backup; # å¤‡ç”¨æœåŠ¡å™¨ 6} åªæœ‰å½“æ‰€æœ‰ä¸»æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶ï¼Œæ‰ä¼šä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨ã€‚\næ•…éšœè½¬ç§»é…ç½® 1location / { 2 proxy_pass http://backend; 3 proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504; 4 proxy_next_upstream_tries 2; # æœ€å¤šå°è¯• 2 æ¬¡ 5 proxy_next_upstream_timeout 10s; # æ€»è¶…æ—¶æ—¶é—´ 10 ç§’ 6} ä¼šè¯ä¿æŒæ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šIP Hash 1upstream backend { 2 ip_hash; 3 server 192.168.1.101:8080; 4 server 192.168.1.102:8080; 5} ä¼˜ç‚¹ï¼šé…ç½®ç®€å• ç¼ºç‚¹ï¼šè´Ÿè½½å¯èƒ½ä¸å‡è¡¡\næ–¹æ¡ˆäºŒï¼šCookie ç»‘å®š 1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 5 sticky cookie srv_id expires=1h domain=.example.com path=/; 6} Nginx ä¼šåœ¨å“åº”ä¸­è®¾ç½®ä¸€ä¸ª Cookieï¼Œåç»­è¯·æ±‚æ ¹æ® Cookie è·¯ç”±åˆ°åŒä¸€å°æœåŠ¡å™¨ã€‚\næ–¹æ¡ˆä¸‰ï¼šSession å…±äº«ï¼ˆæ¨èï¼‰ ä¸ä¾èµ– Nginxï¼Œåœ¨åº”ç”¨å±‚å®ç° Session å…±äº«ï¼š\nä½¿ç”¨ Redis å­˜å‚¨ Sessionï¼š\n1@Configuration 2@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800) 3public class SessionConfig { 4 5 @Bean 6 public LettuceConnectionFactory connectionFactory() { 7 return new LettuceConnectionFactory(); 8 } 9} ä½¿ç”¨ JWT Tokenï¼š\n1@RestController 2public class AuthController { 3 4 @PostMapping(\"/login\") 5 public Result login(@RequestBody LoginRequest request) { 6 // éªŒè¯ç”¨æˆ·åå¯†ç  7 User user = userService.authenticate(request.getUsername(), request.getPassword()); 8 9 // ç”Ÿæˆ JWT Token 10 String token = JwtUtil.generateToken(user.getId()); 11 12 return Result.success(token); 13 } 14} æ¶æ„æ€è€ƒï¼š ä¼šè¯ä¿æŒçš„æœ€ä½³å®è·µæ˜¯åœ¨åº”ç”¨å±‚å®ç°æ— çŠ¶æ€åŒ–ã€‚é€šè¿‡ Redis å…±äº« Session æˆ–ä½¿ç”¨ JWT Tokenï¼Œå¯ä»¥å®ç°çœŸæ­£çš„æ°´å¹³æ‰©å±•ï¼Œè€Œä¸ä¾èµ–äºè´Ÿè½½å‡è¡¡å™¨çš„ç‰¹å®šåŠŸèƒ½ã€‚\nHTTPS é…ç½® SSL è¯ä¹¦é…ç½® 1server { 2 listen 443 ssl http2; 3 server_name api.example.com; 4 5 # SSL è¯ä¹¦ 6 ssl_certificate /etc/nginx/ssl/api.example.com.crt; 7 ssl_certificate_key /etc/nginx/ssl/api.example.com.key; 8 9 # SSL åè®®å’ŒåŠ å¯†å¥—ä»¶ 10 ssl_protocols TLSv1.2 TLSv1.3; 11 ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256'; 12 ssl_prefer_server_ciphers on; 13 14 # SSL ä¼šè¯ç¼“å­˜ 15 ssl_session_cache shared:SSL:10m; 16 ssl_session_timeout 10m; 17 18 # HSTS 19 add_header Strict-Transport-Security \"max-age=31536000\" always; 20 21 location / { 22 proxy_pass http://backend; 23 proxy_set_header Host $host; 24 proxy_set_header X-Real-IP $remote_addr; 25 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 26 proxy_set_header X-Forwarded-Proto $scheme; 27 } 28} 29 30# HTTP é‡å®šå‘åˆ° HTTPS 31server { 32 listen 80; 33 server_name api.example.com; 34 return 301 https://$server_name$request_uri; 35} å…è´¹ SSL è¯ä¹¦ï¼ˆLetâ€™s Encryptï¼‰ 1# å®‰è£… Certbot 2sudo yum install certbot python3-certbot-nginx 3 4# è·å–è¯ä¹¦ 5sudo certbot --nginx -d api.example.com 6 7# è‡ªåŠ¨ç»­æœŸ 8sudo certbot renew --dry-run æ€§èƒ½ä¼˜åŒ– 1. è¿æ¥ä¼˜åŒ– 1http { 2 # é•¿è¿æ¥é…ç½® 3 keepalive_timeout 65; 4 keepalive_requests 100; 5 6 # ä¸Šæ¸¸æœåŠ¡å™¨é•¿è¿æ¥ 7 upstream backend { 8 server 192.168.1.101:8080; 9 server 192.168.1.102:8080; 10 11 keepalive 32; # ä¿æŒ 32 ä¸ªç©ºé—²è¿æ¥ 12 } 13 14 server { 15 location / { 16 proxy_pass http://backend; 17 proxy_http_version 1.1; 18 proxy_set_header Connection \"\"; 19 } 20 } 21} 2. ç¼“å­˜é…ç½® 1# å®šä¹‰ç¼“å­˜è·¯å¾„ 2proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m; 3 4server { 5 location / { 6 proxy_pass http://backend; 7 8 # å¯ç”¨ç¼“å­˜ 9 proxy_cache my_cache; 10 proxy_cache_valid 200 304 10m; 11 proxy_cache_valid 404 1m; 12 proxy_cache_key $scheme$proxy_host$request_uri; 13 14 # ç¼“å­˜å¤´ä¿¡æ¯ 15 add_header X-Cache-Status $upstream_cache_status; 16 } 17 18 # é™æ€èµ„æºç¼“å­˜ 19 location ~* \\.(jpg|jpeg|png|gif|ico|css|js)$ { 20 proxy_pass http://backend; 21 proxy_cache my_cache; 22 proxy_cache_valid 200 30d; 23 expires 30d; 24 } 25} 3. Gzip å‹ç¼© 1http { 2 gzip on; 3 gzip_vary on; 4 gzip_proxied any; 5 gzip_comp_level 6; 6 gzip_types text/plain text/css text/xml text/javascript 7 application/json application/javascript application/xml+rss 8 application/rss+xml font/truetype font/opentype 9 application/vnd.ms-fontobject image/svg+xml; 10 gzip_disable \"msie6\"; 11} 4. é™æµé…ç½® 1http { 2 # å®šä¹‰é™æµåŒºåŸŸ 3 limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s; 4 limit_conn_zone $binary_remote_addr zone=conn_limit:10m; 5 6 server { 7 location /api/ { 8 # é™åˆ¶è¯·æ±‚é€Ÿç‡ï¼šæ¯ç§’ 10 ä¸ªè¯·æ±‚ï¼Œçªå‘ 20 ä¸ª 9 limit_req zone=api_limit burst=20 nodelay; 10 11 # é™åˆ¶å¹¶å‘è¿æ¥æ•°ï¼šæ¯ä¸ª IP æœ€å¤š 10 ä¸ªè¿æ¥ 12 limit_conn conn_limit 10; 13 14 proxy_pass http://backend; 15 } 16 } 17} 5. Worker è¿›ç¨‹ä¼˜åŒ– 1# è‡ªåŠ¨è®¾ç½® worker è¿›ç¨‹æ•°ä¸º CPU æ ¸å¿ƒæ•° 2worker_processes auto; 3 4# ç»‘å®š worker è¿›ç¨‹åˆ° CPU æ ¸å¿ƒ 5worker_cpu_affinity auto; 6 7# æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•° 8worker_rlimit_nofile 65535; 9 10events { 11 # æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° 12 worker_connections 10240; 13 14 # ä½¿ç”¨ epoll äº‹ä»¶æ¨¡å‹ 15 use epoll; 16 17 # å°½å¯èƒ½å¤šåœ°æ¥å—è¿æ¥ 18 multi_accept on; 19} ç›‘æ§ä¸æ—¥å¿— è®¿é—®æ—¥å¿—åˆ†æ 1# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ 2log_format detailed '$remote_addr - $remote_user [$time_local] ' 3 '\"$request\" $status $body_bytes_sent ' 4 '\"$http_referer\" \"$http_user_agent\" ' 5 '$request_time $upstream_response_time ' 6 '$upstream_addr $upstream_status'; 7 8access_log /var/log/nginx/access.log detailed; ä½¿ç”¨ GoAccess åˆ†ææ—¥å¿— 1# å®‰è£… GoAccess 2sudo yum install goaccess 3 4# å®æ—¶åˆ†ææ—¥å¿— 5goaccess /var/log/nginx/access.log -o /var/www/html/report.html --log-format=COMBINED --real-time-html Nginx çŠ¶æ€ç›‘æ§ 1server { 2 listen 8080; 3 server_name localhost; 4 5 location /nginx_status { 6 stub_status on; 7 access_log off; 8 allow 127.0.0.1; 9 deny all; 10 } 11} è®¿é—® http://localhost:8080/nginx_status æŸ¥çœ‹çŠ¶æ€ï¼š\n1Active connections: 291 2server accepts handled requests 3 16630948 16630948 31070465 4Reading: 6 Writing: 179 Waiting: 106 Prometheus ç›‘æ§ ä½¿ç”¨ nginx-prometheus-exporterï¼š\n1# ä¸‹è½½å¹¶è¿è¡Œ exporter 2docker run -p 9113:9113 nginx/nginx-prometheus-exporter:latest \\ 3 -nginx.scrape-uri=http://nginx:8080/nginx_status ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ 1. é…ç½®æ–‡ä»¶ç»„ç»‡ 1/etc/nginx/ 2â”œâ”€â”€ nginx.conf # ä¸»é…ç½®æ–‡ä»¶ 3â”œâ”€â”€ conf.d/ 4â”‚ â”œâ”€â”€ api.conf # API æœåŠ¡é…ç½® 5â”‚ â”œâ”€â”€ web.conf # Web æœåŠ¡é…ç½® 6â”‚ â””â”€â”€ admin.conf # ç®¡ç†åå°é…ç½® 7â”œâ”€â”€ upstream/ 8â”‚ â”œâ”€â”€ api-backend.conf # API åç«¯æœåŠ¡å™¨åˆ—è¡¨ 9â”‚ â””â”€â”€ web-backend.conf # Web åç«¯æœåŠ¡å™¨åˆ—è¡¨ 10â””â”€â”€ ssl/ 11 â”œâ”€â”€ api.example.com.crt 12 â””â”€â”€ api.example.com.key 2. é…ç½®æ£€æŸ¥ä¸é‡è½½ 1# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³• 2sudo nginx -t 3 4# é‡è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰ 5sudo nginx -s reload 6 7# æŸ¥çœ‹ Nginx ç‰ˆæœ¬å’Œç¼–è¯‘å‚æ•° 8nginx -V 3. å®‰å…¨åŠ å›º 1# éšè— Nginx ç‰ˆæœ¬å· 2server_tokens off; 3 4# é™åˆ¶è¯·æ±‚æ–¹æ³• 5if ($request_method !~ ^(GET|POST|PUT|DELETE|HEAD)$) { 6 return 405; 7} 8 9# é˜²æ­¢ç‚¹å‡»åŠ«æŒ 10add_header X-Frame-Options \"SAMEORIGIN\" always; 11 12# XSS é˜²æŠ¤ 13add_header X-XSS-Protection \"1; mode=block\" always; 14 15# å†…å®¹ç±»å‹å—…æ¢é˜²æŠ¤ 16add_header X-Content-Type-Options \"nosniff\" always; 17 18# CSP ç­–ç•¥ 19add_header Content-Security-Policy \"default-src 'self'\" always; 4. æ—¥å¿—è½®è½¬ 1# /etc/logrotate.d/nginx 2 3/var/log/nginx/*.log { 4 daily 5 missingok 6 rotate 14 7 compress 8 delaycompress 9 notifempty 10 create 0640 nginx adm 11 sharedscripts 12 postrotate 13 [ -f /var/run/nginx.pid ] \u0026\u0026 kill -USR1 `cat /var/run/nginx.pid` 14 endscript 15} é¿å‘æç¤ºï¼š ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒåŠ¡å¿…åšå¥½ä»¥ä¸‹å‡ ç‚¹ï¼š1) å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶ï¼›2) ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®ï¼›3) é…ç½®å˜æ›´å‰å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼›4) è®¾ç½®ç›‘æ§å‘Šè­¦ï¼›5) å‡†å¤‡å›æ»šæ–¹æ¡ˆã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº† Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§å®è·µï¼š\nåå‘ä»£ç†ï¼šç†è§£åŸç†ï¼ŒæŒæ¡åŸºç¡€é…ç½®å’Œè·¯å¾„é‡å†™ è´Ÿè½½å‡è¡¡ï¼šæŒæ¡å¤šç§ç­–ç•¥ï¼Œæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ å¥åº·æ£€æŸ¥ï¼šå®ç°æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨è½¬ç§» ä¼šè¯ä¿æŒï¼šäº†è§£å¤šç§æ–¹æ¡ˆï¼Œæ¨èåº”ç”¨å±‚æ— çŠ¶æ€åŒ– HTTPS é…ç½®ï¼šSSL è¯ä¹¦é…ç½®å’Œå®‰å…¨åŠ å›º æ€§èƒ½ä¼˜åŒ–ï¼šè¿æ¥ä¼˜åŒ–ã€ç¼“å­˜ã€å‹ç¼©ã€é™æµç­‰ ç›‘æ§æ—¥å¿—ï¼šæ—¥å¿—åˆ†æå’ŒçŠ¶æ€ç›‘æ§ åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒNginx çš„ä½œç”¨è¿œä¸æ­¢äºæ­¤ã€‚é€šè¿‡åˆç†é…ç½®ï¼Œè¿˜å¯ä»¥å®ç°ï¼š\nç°åº¦å‘å¸ƒï¼šæ ¹æ®æ¡ä»¶å°†éƒ¨åˆ†æµé‡å¯¼å‘æ–°ç‰ˆæœ¬ A/B æµ‹è¯•ï¼šå°†ä¸åŒç”¨æˆ·å¯¼å‘ä¸åŒç‰ˆæœ¬ æµé‡æ§åˆ¶ï¼šé™æµã€ç†”æ–­ã€é™çº§ å®‰å…¨é˜²æŠ¤ï¼šWAFã€DDoS é˜²æŠ¤ ä¸‹æ¬¡å½“ä½ éœ€è¦æ­å»ºé«˜å¯ç”¨æœåŠ¡æ¶æ„æ—¶ï¼ŒNginx å°†æ˜¯ä½ çš„å¾—åŠ›åŠ©æ‰‹ã€‚\n",
  "wordCount" : "1443",
  "inLanguage": "en",
  "datePublished": "2025-06-25T00:00:00Z",
  "dateModified": "2025-06-25T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "wawayu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/2025/06/nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E6%88%98%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E4%BC%98%E5%8C%96/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "åšå®¢å–µ",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="åšå®¢å–µ (Alt + H)">åšå®¢å–µ</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="ğŸ“ æ–‡ç« ">
                    <span>ğŸ“ æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="ğŸ·ï¸ æ ‡ç­¾">
                    <span>ğŸ·ï¸ æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="ğŸ“‚ åˆ†ç±»">
                    <span>ğŸ“‚ åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/skills/" title="ğŸ’» æŠ€èƒ½">
                    <span>ğŸ’» æŠ€èƒ½</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="ğŸ‘¤ å…³äº">
                    <span>ğŸ‘¤ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ” æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ–
    </h1>
    <div class="post-description">
      æ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„åŸç†ä¸å®è·µï¼Œæ¶µç›–é…ç½®ä¼˜åŒ–ã€å¥åº·æ£€æŸ¥ã€ä¼šè¯ä¿æŒç­‰ç”Ÿäº§çº§æ–¹æ¡ˆ
    </div>
    <div class="post-meta"><span title='2025-06-25 00:00:00 +0000 UTC'>June 25, 2025</span>&nbsp;Â·&nbsp;<span>7 min</span>&nbsp;Â·&nbsp;<span>1443 words</span>&nbsp;Â·&nbsp;<span>wawayu</span>&nbsp;|&nbsp;<span>
    <a href="https://github.com/wawayu-dev/wawayu-dev.github.io/tree/main/content/posts/nginx-reverse-proxy-load-balance.md" rel="noopener noreferrer edit" target="_blank">å»ºè®®ä¿®æ”¹</a>
</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#æœ¬æ–‡äº®ç‚¹">æœ¬æ–‡äº®ç‚¹</a></li>
      </ul>
    </li>
    <li><a href="#åå‘ä»£ç†åŸºç¡€">åå‘ä»£ç†åŸºç¡€</a>
      <ul>
        <li><a href="#æ­£å‘ä»£ç†-vs-åå‘ä»£ç†">æ­£å‘ä»£ç† vs åå‘ä»£ç†</a></li>
        <li><a href="#åå‘ä»£ç†çš„ä¼˜åŠ¿">åå‘ä»£ç†çš„ä¼˜åŠ¿</a></li>
      </ul>
    </li>
    <li><a href="#nginx-åå‘ä»£ç†é…ç½®">Nginx åå‘ä»£ç†é…ç½®</a>
      <ul>
        <li><a href="#åŸºç¡€é…ç½®">åŸºç¡€é…ç½®</a></li>
        <li><a href="#ç®€å•åå‘ä»£ç†">ç®€å•åå‘ä»£ç†</a></li>
        <li><a href="#è·¯å¾„é‡å†™">è·¯å¾„é‡å†™</a></li>
      </ul>
    </li>
    <li><a href="#è´Ÿè½½å‡è¡¡ç­–ç•¥">è´Ÿè½½å‡è¡¡ç­–ç•¥</a>
      <ul>
        <li><a href="#1-è½®è¯¢round-robin">1. è½®è¯¢ï¼ˆRound Robinï¼‰</a></li>
        <li><a href="#2-åŠ æƒè½®è¯¢weighted-round-robin">2. åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰</a></li>
        <li><a href="#3-ip-hash">3. IP Hash</a></li>
        <li><a href="#4-æœ€å°‘è¿æ¥least-connections">4. æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰</a></li>
        <li><a href="#5-ä¸€è‡´æ€§å“ˆå¸Œéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—">5. ä¸€è‡´æ€§å“ˆå¸Œï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰</a></li>
        <li><a href="#è´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯”">è´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯”</a></li>
      </ul>
    </li>
    <li><a href="#å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»">å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»</a>
      <ul>
        <li><a href="#è¢«åŠ¨å¥åº·æ£€æŸ¥">è¢«åŠ¨å¥åº·æ£€æŸ¥</a></li>
        <li><a href="#ä¸»åŠ¨å¥åº·æ£€æŸ¥nginx-plus-æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—">ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆNginx Plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰</a></li>
        <li><a href="#å¤‡ç”¨æœåŠ¡å™¨">å¤‡ç”¨æœåŠ¡å™¨</a></li>
        <li><a href="#æ•…éšœè½¬ç§»é…ç½®">æ•…éšœè½¬ç§»é…ç½®</a></li>
      </ul>
    </li>
    <li><a href="#ä¼šè¯ä¿æŒæ–¹æ¡ˆ">ä¼šè¯ä¿æŒæ–¹æ¡ˆ</a>
      <ul>
        <li><a href="#æ–¹æ¡ˆä¸€ip-hash">æ–¹æ¡ˆä¸€ï¼šIP Hash</a></li>
        <li><a href="#æ–¹æ¡ˆäºŒcookie-ç»‘å®š">æ–¹æ¡ˆäºŒï¼šCookie ç»‘å®š</a></li>
        <li><a href="#æ–¹æ¡ˆä¸‰session-å…±äº«æ¨è">æ–¹æ¡ˆä¸‰ï¼šSession å…±äº«ï¼ˆæ¨èï¼‰</a></li>
      </ul>
    </li>
    <li><a href="#https-é…ç½®">HTTPS é…ç½®</a>
      <ul>
        <li><a href="#ssl-è¯ä¹¦é…ç½®">SSL è¯ä¹¦é…ç½®</a></li>
        <li><a href="#å…è´¹-ssl-è¯ä¹¦lets-encrypt">å…è´¹ SSL è¯ä¹¦ï¼ˆLet&rsquo;s Encryptï¼‰</a></li>
      </ul>
    </li>
    <li><a href="#æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ–</a>
      <ul>
        <li><a href="#1-è¿æ¥ä¼˜åŒ–">1. è¿æ¥ä¼˜åŒ–</a></li>
        <li><a href="#2-ç¼“å­˜é…ç½®">2. ç¼“å­˜é…ç½®</a></li>
        <li><a href="#3-gzip-å‹ç¼©">3. Gzip å‹ç¼©</a></li>
        <li><a href="#4-é™æµé…ç½®">4. é™æµé…ç½®</a></li>
        <li><a href="#5-worker-è¿›ç¨‹ä¼˜åŒ–">5. Worker è¿›ç¨‹ä¼˜åŒ–</a></li>
      </ul>
    </li>
    <li><a href="#ç›‘æ§ä¸æ—¥å¿—">ç›‘æ§ä¸æ—¥å¿—</a>
      <ul>
        <li><a href="#è®¿é—®æ—¥å¿—åˆ†æ">è®¿é—®æ—¥å¿—åˆ†æ</a></li>
        <li><a href="#ä½¿ç”¨-goaccess-åˆ†ææ—¥å¿—">ä½¿ç”¨ GoAccess åˆ†ææ—¥å¿—</a></li>
        <li><a href="#nginx-çŠ¶æ€ç›‘æ§">Nginx çŠ¶æ€ç›‘æ§</a></li>
        <li><a href="#prometheus-ç›‘æ§">Prometheus ç›‘æ§</a></li>
      </ul>
    </li>
    <li><a href="#ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ">ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ</a>
      <ul>
        <li><a href="#1-é…ç½®æ–‡ä»¶ç»„ç»‡">1. é…ç½®æ–‡ä»¶ç»„ç»‡</a></li>
        <li><a href="#2-é…ç½®æ£€æŸ¥ä¸é‡è½½">2. é…ç½®æ£€æŸ¥ä¸é‡è½½</a></li>
        <li><a href="#3-å®‰å…¨åŠ å›º">3. å®‰å…¨åŠ å›º</a></li>
        <li><a href="#4-æ—¥å¿—è½®è½¬">4. æ—¥å¿—è½®è½¬</a></li>
      </ul>
    </li>
    <li><a href="#æ€»ç»“ä¸æ€è€ƒ">æ€»ç»“ä¸æ€è€ƒ</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>Nginx ä½œä¸ºé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå·²ç»æˆä¸ºäº’è”ç½‘æ¶æ„ä¸­çš„æ ‡é…ç»„ä»¶ã€‚æ— è®ºæ˜¯é™æ€èµ„æºæœåŠ¡ã€åå‘ä»£ç†è¿˜æ˜¯è´Ÿè½½å‡è¡¡ï¼ŒNginx éƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚</p>
<p>æœ¬æ–‡å°†ä»å®é™…åœºæ™¯å‡ºå‘ï¼Œæ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œå¸®åŠ©ä½ æ„å»ºé«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ã€‚</p>
<h3 id="æœ¬æ–‡äº®ç‚¹">æœ¬æ–‡äº®ç‚¹<a hidden class="anchor" aria-hidden="true" href="#æœ¬æ–‡äº®ç‚¹">#</a></h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> ç†è§£åå‘ä»£ç†ä¸æ­£å‘ä»£ç†çš„åŒºåˆ«</li>
<li><input checked="" disabled="" type="checkbox"> æŒæ¡ Nginx è´Ÿè½½å‡è¡¡çš„å¤šç§ç­–ç•¥</li>
<li><input checked="" disabled="" type="checkbox"> å­¦ä¼šé…ç½®å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»</li>
<li><input checked="" disabled="" type="checkbox"> äº†è§£ä¼šè¯ä¿æŒçš„å®ç°æ–¹æ¡ˆ</li>
<li><input checked="" disabled="" type="checkbox"> æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§</li>
</ul>
<hr>
<h2 id="åå‘ä»£ç†åŸºç¡€">åå‘ä»£ç†åŸºç¡€<a hidden class="anchor" aria-hidden="true" href="#åå‘ä»£ç†åŸºç¡€">#</a></h2>
<h3 id="æ­£å‘ä»£ç†-vs-åå‘ä»£ç†">æ­£å‘ä»£ç† vs åå‘ä»£ç†<a hidden class="anchor" aria-hidden="true" href="#æ­£å‘ä»£ç†-vs-åå‘ä»£ç†">#</a></h3>
<p><strong>æ­£å‘ä»£ç†</strong>ï¼šå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">å®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨
</span></span><span class="line"><span class="ln">2</span><span class="cl">ï¼ˆå®¢æˆ·ç«¯é…ç½®ä»£ç†ï¼‰
</span></span></code></pre></div><p><strong>åå‘ä»£ç†</strong>ï¼šå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å†³å®šè½¬å‘åˆ°å“ªå°æœåŠ¡å™¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">å®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨é›†ç¾¤
</span></span><span class="line"><span class="ln">2</span><span class="cl">ï¼ˆæœåŠ¡ç«¯é…ç½®ä»£ç†ï¼‰
</span></span></code></pre></div><h3 id="åå‘ä»£ç†çš„ä¼˜åŠ¿">åå‘ä»£ç†çš„ä¼˜åŠ¿<a hidden class="anchor" aria-hidden="true" href="#åå‘ä»£ç†çš„ä¼˜åŠ¿">#</a></h3>
<ol>
<li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨</li>
<li><strong>éšè—çœŸå®æœåŠ¡å™¨</strong>ï¼šæé«˜å®‰å…¨æ€§</li>
<li><strong>SSL å¸è½½</strong>ï¼šåœ¨ä»£ç†å±‚å¤„ç† HTTPS</li>
<li><strong>ç¼“å­˜é™æ€èµ„æº</strong>ï¼šå‡è½»åç«¯å‹åŠ›</li>
<li><strong>ç»Ÿä¸€å…¥å£</strong>ï¼šä¾¿äºç®¡ç†å’Œç›‘æ§</li>
</ol>
<blockquote>
<p><strong>æ¶æ„æ€è€ƒï¼š</strong> åå‘ä»£ç†ä¸ä»…æ˜¯æµé‡åˆ†å‘å™¨ï¼Œæ›´æ˜¯æ¶æ„ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•ã€æµé‡æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚</p>
</blockquote>
<hr>
<h2 id="nginx-åå‘ä»£ç†é…ç½®">Nginx åå‘ä»£ç†é…ç½®<a hidden class="anchor" aria-hidden="true" href="#nginx-åå‘ä»£ç†é…ç½®">#</a></h2>
<h3 id="åŸºç¡€é…ç½®">åŸºç¡€é…ç½®<a hidden class="anchor" aria-hidden="true" href="#åŸºç¡€é…ç½®">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># /etc/nginx/nginx.conf
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="k">user</span> <span class="s">nginx</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="k">worker_processes</span> <span class="s">auto</span><span class="p">;</span>  <span class="c1"># è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="k">error_log</span> <span class="s">/var/log/nginx/error.log</span> <span class="s">warn</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="k">pid</span> <span class="s">/var/run/nginx.pid</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="k">events</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="kn">worker_connections</span> <span class="mi">1024</span><span class="p">;</span>  <span class="c1"># æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°
</span></span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="kn">use</span> <span class="s">epoll</span><span class="p">;</span>  <span class="c1"># Linux ä¸‹ä½¿ç”¨ epoll
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="kn">include</span> <span class="s">/etc/nginx/mime.types</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="kn">default_type</span> <span class="s">application/octet-stream</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="c1"># æ—¥å¿—æ ¼å¼
</span></span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="kn">log_format</span> <span class="s">main</span> <span class="s">&#39;</span><span class="nv">$remote_addr</span> <span class="s">-</span> <span class="nv">$remote_user</span> <span class="s">[</span><span class="nv">$time_local]</span> <span class="s">&#34;</span><span class="nv">$request&#34;</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">                    <span class="s">&#39;</span><span class="nv">$status</span> <span class="nv">$body_bytes_sent</span> <span class="s">&#34;</span><span class="nv">$http_referer&#34;</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">                    <span class="s">&#39;&#34;</span><span class="nv">$http_user_agent&#34;</span> <span class="s">&#34;</span><span class="nv">$http_x_forwarded_for&#34;</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">                    <span class="s">&#39;</span><span class="nv">$request_time</span> <span class="nv">$upstream_response_time&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="kn">access_log</span> <span class="s">/var/log/nginx/access.log</span> <span class="s">main</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="kn">sendfile</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="kn">tcp_nopush</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="kn">tcp_nodelay</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="kn">keepalive_timeout</span> <span class="mi">65</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="kn">types_hash_max_size</span> <span class="mi">2048</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    
</span></span><span class="line"><span class="ln">31</span><span class="cl">    <span class="c1"># åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶
</span></span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="kn">include</span> <span class="s">/etc/nginx/conf.d/*.conf</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="ç®€å•åå‘ä»£ç†">ç®€å•åå‘ä»£ç†<a hidden class="anchor" aria-hidden="true" href="#ç®€å•åå‘ä»£ç†">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># /etc/nginx/conf.d/api.conf
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="kn">server_name</span> <span class="s">api.example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="c1"># ä»£ç†åˆ°åç«¯æœåŠ¡å™¨
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://192.168.1.100:8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="c1"># è®¾ç½®è¯·æ±‚å¤´
</span></span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="c1"># è¶…æ—¶è®¾ç½®
</span></span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="kn">proxy_connect_timeout</span> <span class="s">60s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="kn">proxy_send_timeout</span> <span class="s">60s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="kn">proxy_read_timeout</span> <span class="s">60s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="è·¯å¾„é‡å†™">è·¯å¾„é‡å†™<a hidden class="anchor" aria-hidden="true" href="#è·¯å¾„é‡å†™">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kn">server_name</span> <span class="s">api.example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="c1"># å°† /api/v1/users ä»£ç†åˆ° http://backend/users
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="kn">location</span> <span class="s">/api/v1/</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://backend/</span><span class="p">;</span>  <span class="c1"># æ³¨æ„æœ«å°¾çš„ /
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="c1"># å°† /old-api é‡å†™ä¸º /new-api
</span></span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="kn">location</span> <span class="s">/old-api</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="kn">rewrite</span> <span class="s">^/old-api/(.*)</span>$ <span class="s">/new-api/</span><span class="nv">$1</span> <span class="s">break</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h2 id="è´Ÿè½½å‡è¡¡ç­–ç•¥">è´Ÿè½½å‡è¡¡ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#è´Ÿè½½å‡è¡¡ç­–ç•¥">#</a></h2>
<h3 id="1-è½®è¯¢round-robin">1. è½®è¯¢ï¼ˆRound Robinï¼‰<a hidden class="anchor" aria-hidden="true" href="#1-è½®è¯¢round-robin">#</a></h3>
<p>é»˜è®¤ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†é…è¯·æ±‚ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.103</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="kn">server_name</span> <span class="s">api.example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="2-åŠ æƒè½®è¯¢weighted-round-robin">2. åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰<a hidden class="anchor" aria-hidden="true" href="#2-åŠ æƒè½®è¯¢weighted-round-robin">#</a></h3>
<p>æ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…ä¸åŒæƒé‡ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span> <span class="s">weight=3</span><span class="p">;</span>  <span class="c1"># æƒé‡ 3
</span></span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span> <span class="s">weight=2</span><span class="p">;</span>  <span class="c1"># æƒé‡ 2
</span></span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.103</span><span class="p">:</span><span class="mi">8080</span> <span class="s">weight=1</span><span class="p">;</span>  <span class="c1"># æƒé‡ 1
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æƒé‡ä¸º 3:2:1ï¼Œæ„å‘³ç€æ¯ 6 ä¸ªè¯·æ±‚ä¸­ï¼Œ101 æœåŠ¡å™¨å¤„ç† 3 ä¸ªï¼Œ102 å¤„ç† 2 ä¸ªï¼Œ103 å¤„ç† 1 ä¸ªã€‚</p>
<h3 id="3-ip-hash">3. IP Hash<a hidden class="anchor" aria-hidden="true" href="#3-ip-hash">#</a></h3>
<p>æ ¹æ®å®¢æˆ·ç«¯ IP è¿›è¡Œå“ˆå¸Œï¼ŒåŒä¸€ IP çš„è¯·æ±‚æ€»æ˜¯åˆ†é…åˆ°åŒä¸€å°æœåŠ¡å™¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="kn">ip_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.103</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šéœ€è¦ä¼šè¯ä¿æŒçš„åº”ç”¨ï¼ˆå¦‚è´­ç‰©è½¦ã€ç™»å½•çŠ¶æ€ï¼‰</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>è´Ÿè½½å¯èƒ½ä¸å‡è¡¡ï¼ˆIP åˆ†å¸ƒä¸å‡ï¼‰</li>
<li>æ— æ³•åº”å¯¹æœåŠ¡å™¨æ•…éšœï¼ˆIP é‡æ–°å“ˆå¸Œï¼‰</li>
</ul>
<h3 id="4-æœ€å°‘è¿æ¥least-connections">4. æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰<a hidden class="anchor" aria-hidden="true" href="#4-æœ€å°‘è¿æ¥least-connections">#</a></h3>
<p>å°†è¯·æ±‚åˆ†é…ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="kn">least_conn</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.103</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šè¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚è¾ƒå¤§çš„åº”ç”¨</p>
<h3 id="5-ä¸€è‡´æ€§å“ˆå¸Œéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—">5. ä¸€è‡´æ€§å“ˆå¸Œï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰<a hidden class="anchor" aria-hidden="true" href="#5-ä¸€è‡´æ€§å“ˆå¸Œéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="kn">hash</span> <span class="nv">$request_uri</span> <span class="s">consistent</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.103</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šç¼“å­˜æœåŠ¡å™¨é›†ç¾¤</p>
<h3 id="è´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯”">è´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯”<a hidden class="anchor" aria-hidden="true" href="#è´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯”">#</a></h3>
<table>
  <thead>
      <tr>
          <th>ç­–ç•¥</th>
          <th>ä¼˜ç‚¹</th>
          <th>ç¼ºç‚¹</th>
          <th>é€‚ç”¨åœºæ™¯</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>è½®è¯¢</td>
          <td>ç®€å•ã€å‡è¡¡</td>
          <td>æ— ä¼šè¯ä¿æŒ</td>
          <td>æ— çŠ¶æ€æœåŠ¡</td>
      </tr>
      <tr>
          <td>åŠ æƒè½®è¯¢</td>
          <td>è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½</td>
          <td>æ— ä¼šè¯ä¿æŒ</td>
          <td>æœåŠ¡å™¨æ€§èƒ½ä¸åŒ</td>
      </tr>
      <tr>
          <td>IP Hash</td>
          <td>ä¼šè¯ä¿æŒ</td>
          <td>è´Ÿè½½å¯èƒ½ä¸å‡</td>
          <td>æœ‰çŠ¶æ€æœåŠ¡</td>
      </tr>
      <tr>
          <td>æœ€å°‘è¿æ¥</td>
          <td>åŠ¨æ€å‡è¡¡</td>
          <td>è®¡ç®—å¼€é”€å¤§</td>
          <td>é•¿è¿æ¥æœåŠ¡</td>
      </tr>
      <tr>
          <td>ä¸€è‡´æ€§å“ˆå¸Œ</td>
          <td>ç¼“å­˜å‘½ä¸­ç‡é«˜</td>
          <td>å®ç°å¤æ‚</td>
          <td>ç¼“å­˜é›†ç¾¤</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»">å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»<a hidden class="anchor" aria-hidden="true" href="#å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»">#</a></h2>
<h3 id="è¢«åŠ¨å¥åº·æ£€æŸ¥">è¢«åŠ¨å¥åº·æ£€æŸ¥<a hidden class="anchor" aria-hidden="true" href="#è¢«åŠ¨å¥åº·æ£€æŸ¥">#</a></h3>
<p>Nginx é»˜è®¤çš„å¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œå½“è¯·æ±‚å¤±è´¥æ—¶æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¯ç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=30s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=30s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.103</span><span class="p">:</span><span class="mi">8080</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=30s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li><code>max_fails=3</code>ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡åæ ‡è®°ä¸ºä¸å¯ç”¨</li>
<li><code>fail_timeout=30s</code>ï¼šæ ‡è®°ä¸ºä¸å¯ç”¨åï¼Œ30 ç§’å†…ä¸å†åˆ†é…è¯·æ±‚</li>
</ul>
<h3 id="ä¸»åŠ¨å¥åº·æ£€æŸ¥nginx-plus-æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—">ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆNginx Plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰<a hidden class="anchor" aria-hidden="true" href="#ä¸»åŠ¨å¥åº·æ£€æŸ¥nginx-plus-æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—">#</a></h3>
<p>ä½¿ç”¨ <code>nginx_upstream_check_module</code> æ¨¡å—ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.103</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="kn">check</span> <span class="s">interval=3000</span> <span class="s">rise=2</span> <span class="s">fall=3</span> <span class="s">timeout=1000</span> <span class="s">type=http</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="kn">check_http_send</span> <span class="s">&#34;HEAD</span> <span class="s">/health</span> <span class="s">HTTP/1.0\r\n\r\n&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="kn">check_http_expect_alive</span> <span class="s">http_2xx</span> <span class="s">http_3xx</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="kn">location</span> <span class="s">/status</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="kn">check_status</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li><code>interval=3000</code>ï¼šæ¯ 3 ç§’æ£€æŸ¥ä¸€æ¬¡</li>
<li><code>rise=2</code>ï¼šè¿ç»­æˆåŠŸ 2 æ¬¡æ ‡è®°ä¸ºå¯ç”¨</li>
<li><code>fall=3</code>ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡æ ‡è®°ä¸ºä¸å¯ç”¨</li>
<li><code>timeout=1000</code>ï¼šè¶…æ—¶æ—¶é—´ 1 ç§’</li>
<li><code>type=http</code>ï¼šä½¿ç”¨ HTTP åè®®æ£€æŸ¥</li>
</ul>
<h3 id="å¤‡ç”¨æœåŠ¡å™¨">å¤‡ç”¨æœåŠ¡å™¨<a hidden class="anchor" aria-hidden="true" href="#å¤‡ç”¨æœåŠ¡å™¨">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.103</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.104</span><span class="p">:</span><span class="mi">8080</span> <span class="s">backup</span><span class="p">;</span>  <span class="c1"># å¤‡ç”¨æœåŠ¡å™¨
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åªæœ‰å½“æ‰€æœ‰ä¸»æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶ï¼Œæ‰ä¼šä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨ã€‚</p>
<h3 id="æ•…éšœè½¬ç§»é…ç½®">æ•…éšœè½¬ç§»é…ç½®<a hidden class="anchor" aria-hidden="true" href="#æ•…éšœè½¬ç§»é…ç½®">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="kn">proxy_next_upstream</span> <span class="s">error</span> <span class="s">timeout</span> <span class="s">invalid_header</span> <span class="s">http_500</span> <span class="s">http_502</span> <span class="s">http_503</span> <span class="s">http_504</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="kn">proxy_next_upstream_tries</span> <span class="mi">2</span><span class="p">;</span>  <span class="c1"># æœ€å¤šå°è¯• 2 æ¬¡
</span></span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="kn">proxy_next_upstream_timeout</span> <span class="s">10s</span><span class="p">;</span>  <span class="c1"># æ€»è¶…æ—¶æ—¶é—´ 10 ç§’
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h2 id="ä¼šè¯ä¿æŒæ–¹æ¡ˆ">ä¼šè¯ä¿æŒæ–¹æ¡ˆ<a hidden class="anchor" aria-hidden="true" href="#ä¼šè¯ä¿æŒæ–¹æ¡ˆ">#</a></h2>
<h3 id="æ–¹æ¡ˆä¸€ip-hash">æ–¹æ¡ˆä¸€ï¼šIP Hash<a hidden class="anchor" aria-hidden="true" href="#æ–¹æ¡ˆä¸€ip-hash">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="kn">ip_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>ä¼˜ç‚¹</strong>ï¼šé…ç½®ç®€å•
<strong>ç¼ºç‚¹</strong>ï¼šè´Ÿè½½å¯èƒ½ä¸å‡è¡¡</p>
<h3 id="æ–¹æ¡ˆäºŒcookie-ç»‘å®š">æ–¹æ¡ˆäºŒï¼šCookie ç»‘å®š<a hidden class="anchor" aria-hidden="true" href="#æ–¹æ¡ˆäºŒcookie-ç»‘å®š">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="kn">sticky</span> <span class="s">cookie</span> <span class="s">srv_id</span> <span class="s">expires=1h</span> <span class="s">domain=.example.com</span> <span class="s">path=/</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Nginx ä¼šåœ¨å“åº”ä¸­è®¾ç½®ä¸€ä¸ª Cookieï¼Œåç»­è¯·æ±‚æ ¹æ® Cookie è·¯ç”±åˆ°åŒä¸€å°æœåŠ¡å™¨ã€‚</p>
<h3 id="æ–¹æ¡ˆä¸‰session-å…±äº«æ¨è">æ–¹æ¡ˆä¸‰ï¼šSession å…±äº«ï¼ˆæ¨èï¼‰<a hidden class="anchor" aria-hidden="true" href="#æ–¹æ¡ˆä¸‰session-å…±äº«æ¨è">#</a></h3>
<p>ä¸ä¾èµ– Nginxï¼Œåœ¨åº”ç”¨å±‚å®ç° Session å…±äº«ï¼š</p>
<p><strong>ä½¿ç”¨ Redis å­˜å‚¨ Session</strong>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nd">@EnableRedisHttpSession</span><span class="p">(</span><span class="n">maxInactiveIntervalInSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1800</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SessionConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">LettuceConnectionFactory</span><span class="w"> </span><span class="nf">connectionFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LettuceConnectionFactory</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>ä½¿ç”¨ JWT Token</strong>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&#34;/login&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">LoginRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="c1">// éªŒè¯ç”¨æˆ·åå¯†ç </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userService</span><span class="p">.</span><span class="na">authenticate</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getPassword</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="c1">// ç”Ÿæˆ JWT Token</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JwtUtil</span><span class="p">.</span><span class="na">generateToken</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="na">success</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p><strong>æ¶æ„æ€è€ƒï¼š</strong> ä¼šè¯ä¿æŒçš„æœ€ä½³å®è·µæ˜¯åœ¨åº”ç”¨å±‚å®ç°æ— çŠ¶æ€åŒ–ã€‚é€šè¿‡ Redis å…±äº« Session æˆ–ä½¿ç”¨ JWT Tokenï¼Œå¯ä»¥å®ç°çœŸæ­£çš„æ°´å¹³æ‰©å±•ï¼Œè€Œä¸ä¾èµ–äºè´Ÿè½½å‡è¡¡å™¨çš„ç‰¹å®šåŠŸèƒ½ã€‚</p>
</blockquote>
<hr>
<h2 id="https-é…ç½®">HTTPS é…ç½®<a hidden class="anchor" aria-hidden="true" href="#https-é…ç½®">#</a></h2>
<h3 id="ssl-è¯ä¹¦é…ç½®">SSL è¯ä¹¦é…ç½®<a hidden class="anchor" aria-hidden="true" href="#ssl-è¯ä¹¦é…ç½®">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kn">server_name</span> <span class="s">api.example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="c1"># SSL è¯ä¹¦
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="kn">ssl_certificate</span> <span class="s">/etc/nginx/ssl/api.example.com.crt</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="kn">ssl_certificate_key</span> <span class="s">/etc/nginx/ssl/api.example.com.key</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="c1"># SSL åè®®å’ŒåŠ å¯†å¥—ä»¶
</span></span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="kn">ssl_protocols</span> <span class="s">TLSv1.2</span> <span class="s">TLSv1.3</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="kn">ssl_ciphers</span> <span class="s">&#39;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="kn">ssl_prefer_server_ciphers</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="c1"># SSL ä¼šè¯ç¼“å­˜
</span></span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="kn">ssl_session_cache</span> <span class="s">shared:SSL:10m</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="kn">ssl_session_timeout</span> <span class="mi">10m</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="c1"># HSTS
</span></span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="kn">add_header</span> <span class="s">Strict-Transport-Security</span> <span class="s">&#34;max-age=31536000&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"># HTTP é‡å®šå‘åˆ° HTTPS
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    <span class="kn">server_name</span> <span class="s">api.example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://</span><span class="nv">$server_name$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="å…è´¹-ssl-è¯ä¹¦lets-encrypt">å…è´¹ SSL è¯ä¹¦ï¼ˆLet&rsquo;s Encryptï¼‰<a hidden class="anchor" aria-hidden="true" href="#å…è´¹-ssl-è¯ä¹¦lets-encrypt">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># å®‰è£… Certbot</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">sudo yum install certbot python3-certbot-nginx
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># è·å–è¯ä¹¦</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">sudo certbot --nginx -d api.example.com
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="c1"># è‡ªåŠ¨ç»­æœŸ</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">sudo certbot renew --dry-run
</span></span></code></pre></div><hr>
<h2 id="æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#æ€§èƒ½ä¼˜åŒ–">#</a></h2>
<h3 id="1-è¿æ¥ä¼˜åŒ–">1. è¿æ¥ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#1-è¿æ¥ä¼˜åŒ–">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="c1"># é•¿è¿æ¥é…ç½®
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kn">keepalive_timeout</span> <span class="mi">65</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="kn">keepalive_requests</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="c1"># ä¸Šæ¸¸æœåŠ¡å™¨é•¿è¿æ¥
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="kn">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="kn">keepalive</span> <span class="mi">32</span><span class="p">;</span>  <span class="c1"># ä¿æŒ 32 ä¸ªç©ºé—²è¿æ¥
</span></span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">            <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">            <span class="kn">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="2-ç¼“å­˜é…ç½®">2. ç¼“å­˜é…ç½®<a hidden class="anchor" aria-hidden="true" href="#2-ç¼“å­˜é…ç½®">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># å®šä¹‰ç¼“å­˜è·¯å¾„
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">proxy_cache_path</span> <span class="s">/var/cache/nginx</span> <span class="s">levels=1:2</span> <span class="s">keys_zone=my_cache:10m</span> <span class="s">max_size=1g</span> <span class="s">inactive=60m</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="c1"># å¯ç”¨ç¼“å­˜
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="kn">proxy_cache</span> <span class="s">my_cache</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="kn">proxy_cache_valid</span> <span class="mi">200</span> <span class="mi">304</span> <span class="mi">10m</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="kn">proxy_cache_valid</span> <span class="mi">404</span> <span class="mi">1m</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="kn">proxy_cache_key</span> <span class="nv">$scheme$proxy_host$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="c1"># ç¼“å­˜å¤´ä¿¡æ¯
</span></span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="kn">add_header</span> <span class="s">X-Cache-Status</span> <span class="nv">$upstream_cache_status</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="c1"># é™æ€èµ„æºç¼“å­˜
</span></span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="kn">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">\.(jpg|jpeg|png|gif|ico|css|js)</span>$ <span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="kn">proxy_cache</span> <span class="s">my_cache</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="kn">proxy_cache_valid</span> <span class="mi">200</span> <span class="s">30d</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="kn">expires</span> <span class="s">30d</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="3-gzip-å‹ç¼©">3. Gzip å‹ç¼©<a hidden class="anchor" aria-hidden="true" href="#3-gzip-å‹ç¼©">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="kn">gzip</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kn">gzip_vary</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="kn">gzip_proxied</span> <span class="s">any</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="kn">gzip_comp_level</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="kn">gzip_types</span> <span class="s">text/plain</span> <span class="s">text/css</span> <span class="s">text/xml</span> <span class="s">text/javascript</span> 
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">               <span class="s">application/json</span> <span class="s">application/javascript</span> <span class="s">application/xml+rss</span> 
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">               <span class="s">application/rss+xml</span> <span class="s">font/truetype</span> <span class="s">font/opentype</span> 
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">               <span class="s">application/vnd.ms-fontobject</span> <span class="s">image/svg+xml</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="kn">gzip_disable</span> <span class="s">&#34;msie6&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="4-é™æµé…ç½®">4. é™æµé…ç½®<a hidden class="anchor" aria-hidden="true" href="#4-é™æµé…ç½®">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="c1"># å®šä¹‰é™æµåŒºåŸŸ
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=api_limit:10m</span> <span class="s">rate=10r/s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="kn">limit_conn_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=conn_limit:10m</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="kn">location</span> <span class="s">/api/</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">            <span class="c1"># é™åˆ¶è¯·æ±‚é€Ÿç‡ï¼šæ¯ç§’ 10 ä¸ªè¯·æ±‚ï¼Œçªå‘ 20 ä¸ª
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl">            <span class="kn">limit_req</span> <span class="s">zone=api_limit</span> <span class="s">burst=20</span> <span class="s">nodelay</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">            
</span></span><span class="line"><span class="ln">11</span><span class="cl">            <span class="c1"># é™åˆ¶å¹¶å‘è¿æ¥æ•°ï¼šæ¯ä¸ª IP æœ€å¤š 10 ä¸ªè¿æ¥
</span></span></span><span class="line"><span class="ln">12</span><span class="cl">            <span class="kn">limit_conn</span> <span class="s">conn_limit</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">            
</span></span><span class="line"><span class="ln">14</span><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="5-worker-è¿›ç¨‹ä¼˜åŒ–">5. Worker è¿›ç¨‹ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#5-worker-è¿›ç¨‹ä¼˜åŒ–">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># è‡ªåŠ¨è®¾ç½® worker è¿›ç¨‹æ•°ä¸º CPU æ ¸å¿ƒæ•°
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">worker_processes</span> <span class="s">auto</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># ç»‘å®š worker è¿›ç¨‹åˆ° CPU æ ¸å¿ƒ
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="k">worker_cpu_affinity</span> <span class="s">auto</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"># æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="k">worker_rlimit_nofile</span> <span class="mi">65535</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="k">events</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="c1"># æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°
</span></span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="kn">worker_connections</span> <span class="mi">10240</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="c1"># ä½¿ç”¨ epoll äº‹ä»¶æ¨¡å‹
</span></span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="kn">use</span> <span class="s">epoll</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="c1"># å°½å¯èƒ½å¤šåœ°æ¥å—è¿æ¥
</span></span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="kn">multi_accept</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h2 id="ç›‘æ§ä¸æ—¥å¿—">ç›‘æ§ä¸æ—¥å¿—<a hidden class="anchor" aria-hidden="true" href="#ç›‘æ§ä¸æ—¥å¿—">#</a></h2>
<h3 id="è®¿é—®æ—¥å¿—åˆ†æ">è®¿é—®æ—¥å¿—åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#è®¿é—®æ—¥å¿—åˆ†æ">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="k">log_format</span> <span class="s">detailed</span> <span class="s">&#39;</span><span class="nv">$remote_addr</span> <span class="s">-</span> <span class="nv">$remote_user</span> <span class="s">[</span><span class="nv">$time_local]</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">                    <span class="s">&#39;&#34;</span><span class="nv">$request&#34;</span> <span class="nv">$status</span> <span class="nv">$body_bytes_sent</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">                    <span class="s">&#39;&#34;</span><span class="nv">$http_referer&#34;</span> <span class="s">&#34;</span><span class="nv">$http_user_agent&#34;</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">                    <span class="s">&#39;</span><span class="nv">$request_time</span> <span class="nv">$upstream_response_time</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">                    <span class="s">&#39;</span><span class="nv">$upstream_addr</span> <span class="nv">$upstream_status&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">
</span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="k">access_log</span> <span class="s">/var/log/nginx/access.log</span> <span class="s">detailed</span><span class="p">;</span>
</span></span></code></pre></div><h3 id="ä½¿ç”¨-goaccess-åˆ†ææ—¥å¿—">ä½¿ç”¨ GoAccess åˆ†ææ—¥å¿—<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨-goaccess-åˆ†ææ—¥å¿—">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># å®‰è£… GoAccess</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">sudo yum install goaccess
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># å®æ—¶åˆ†ææ—¥å¿—</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">goaccess /var/log/nginx/access.log -o /var/www/html/report.html --log-format<span class="o">=</span>COMBINED --real-time-html
</span></span></code></pre></div><h3 id="nginx-çŠ¶æ€ç›‘æ§">Nginx çŠ¶æ€ç›‘æ§<a hidden class="anchor" aria-hidden="true" href="#nginx-çŠ¶æ€ç›‘æ§">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="kn">listen</span> <span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kn">server_name</span> <span class="s">localhost</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="kn">location</span> <span class="s">/nginx_status</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="kn">stub_status</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="kn">allow</span> <span class="n">127.0.0.1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="kn">deny</span> <span class="s">all</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è®¿é—® <code>http://localhost:8080/nginx_status</code> æŸ¥çœ‹çŠ¶æ€ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">Active connections: 291
</span></span><span class="line"><span class="ln">2</span><span class="cl">server accepts handled requests
</span></span><span class="line"><span class="ln">3</span><span class="cl"> 16630948 16630948 31070465
</span></span><span class="line"><span class="ln">4</span><span class="cl">Reading: 6 Writing: 179 Waiting: 106
</span></span></code></pre></div><h3 id="prometheus-ç›‘æ§">Prometheus ç›‘æ§<a hidden class="anchor" aria-hidden="true" href="#prometheus-ç›‘æ§">#</a></h3>
<p>ä½¿ç”¨ <code>nginx-prometheus-exporter</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># ä¸‹è½½å¹¶è¿è¡Œ exporter</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">docker run -p 9113:9113 nginx/nginx-prometheus-exporter:latest <span class="se">\
</span></span></span><span class="line"><span class="ln">3</span><span class="cl">  -nginx.scrape-uri<span class="o">=</span>http://nginx:8080/nginx_status
</span></span></code></pre></div><hr>
<h2 id="ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ">ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ<a hidden class="anchor" aria-hidden="true" href="#ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ">#</a></h2>
<h3 id="1-é…ç½®æ–‡ä»¶ç»„ç»‡">1. é…ç½®æ–‡ä»¶ç»„ç»‡<a hidden class="anchor" aria-hidden="true" href="#1-é…ç½®æ–‡ä»¶ç»„ç»‡">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln"> 1</span><span class="cl">/etc/nginx/
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">â”œâ”€â”€ nginx.conf              # ä¸»é…ç½®æ–‡ä»¶
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">â”œâ”€â”€ conf.d/
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">â”‚   â”œâ”€â”€ api.conf           # API æœåŠ¡é…ç½®
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">â”‚   â”œâ”€â”€ web.conf           # Web æœåŠ¡é…ç½®
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">â”‚   â””â”€â”€ admin.conf         # ç®¡ç†åå°é…ç½®
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">â”œâ”€â”€ upstream/
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">â”‚   â”œâ”€â”€ api-backend.conf   # API åç«¯æœåŠ¡å™¨åˆ—è¡¨
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">â”‚   â””â”€â”€ web-backend.conf   # Web åç«¯æœåŠ¡å™¨åˆ—è¡¨
</span></span><span class="line"><span class="ln">10</span><span class="cl">â””â”€â”€ ssl/
</span></span><span class="line"><span class="ln">11</span><span class="cl">    â”œâ”€â”€ api.example.com.crt
</span></span><span class="line"><span class="ln">12</span><span class="cl">    â””â”€â”€ api.example.com.key
</span></span></code></pre></div><h3 id="2-é…ç½®æ£€æŸ¥ä¸é‡è½½">2. é…ç½®æ£€æŸ¥ä¸é‡è½½<a hidden class="anchor" aria-hidden="true" href="#2-é…ç½®æ£€æŸ¥ä¸é‡è½½">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">sudo nginx -t
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># é‡è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">sudo nginx -s reload
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="c1"># æŸ¥çœ‹ Nginx ç‰ˆæœ¬å’Œç¼–è¯‘å‚æ•°</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">nginx -V
</span></span></code></pre></div><h3 id="3-å®‰å…¨åŠ å›º">3. å®‰å…¨åŠ å›º<a hidden class="anchor" aria-hidden="true" href="#3-å®‰å…¨åŠ å›º">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># éšè— Nginx ç‰ˆæœ¬å·
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">server_tokens</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># é™åˆ¶è¯·æ±‚æ–¹æ³•
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="k">if</span> <span class="s">(</span><span class="nv">$request_method</span> <span class="s">!~</span> <span class="s">^(GET|POST|PUT|DELETE|HEAD)</span>$<span class="s">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="kn">return</span> <span class="mi">405</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"># é˜²æ­¢ç‚¹å‡»åŠ«æŒ
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="k">add_header</span> <span class="s">X-Frame-Options</span> <span class="s">&#34;SAMEORIGIN&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"># XSS é˜²æŠ¤
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="k">add_header</span> <span class="s">X-XSS-Protection</span> <span class="s">&#34;1</span><span class="p">;</span> <span class="k">mode=block&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1"># å†…å®¹ç±»å‹å—…æ¢é˜²æŠ¤
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="k">add_header</span> <span class="s">X-Content-Type-Options</span> <span class="s">&#34;nosniff&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1"># CSP ç­–ç•¥
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="k">add_header</span> <span class="s">Content-Security-Policy</span> <span class="s">&#34;default-src</span> <span class="s">&#39;self&#39;&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span></code></pre></div><h3 id="4-æ—¥å¿—è½®è½¬">4. æ—¥å¿—è½®è½¬<a hidden class="anchor" aria-hidden="true" href="#4-æ—¥å¿—è½®è½¬">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># /etc/logrotate.d/nginx</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">/var/log/nginx/*.log <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    daily
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    missingok
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    rotate <span class="m">14</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    compress
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    delaycompress
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    notifempty
</span></span><span class="line"><span class="ln">10</span><span class="cl">    create <span class="m">0640</span> nginx adm
</span></span><span class="line"><span class="ln">11</span><span class="cl">    sharedscripts
</span></span><span class="line"><span class="ln">12</span><span class="cl">    postrotate
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="o">[</span> -f /var/run/nginx.pid <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> -USR1 <span class="sb">`</span>cat /var/run/nginx.pid<span class="sb">`</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    endscript
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><blockquote>
<p><strong>é¿å‘æç¤ºï¼š</strong> ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒåŠ¡å¿…åšå¥½ä»¥ä¸‹å‡ ç‚¹ï¼š1) å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶ï¼›2) ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®ï¼›3) é…ç½®å˜æ›´å‰å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼›4) è®¾ç½®ç›‘æ§å‘Šè­¦ï¼›5) å‡†å¤‡å›æ»šæ–¹æ¡ˆã€‚</p>
</blockquote>
<hr>
<h2 id="æ€»ç»“ä¸æ€è€ƒ">æ€»ç»“ä¸æ€è€ƒ<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“ä¸æ€è€ƒ">#</a></h2>
<p>æœ¬æ–‡æ·±å…¥è®²è§£äº† Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§å®è·µï¼š</p>
<ul>
<li><strong>åå‘ä»£ç†</strong>ï¼šç†è§£åŸç†ï¼ŒæŒæ¡åŸºç¡€é…ç½®å’Œè·¯å¾„é‡å†™</li>
<li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šæŒæ¡å¤šç§ç­–ç•¥ï¼Œæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ</li>
<li><strong>å¥åº·æ£€æŸ¥</strong>ï¼šå®ç°æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨è½¬ç§»</li>
<li><strong>ä¼šè¯ä¿æŒ</strong>ï¼šäº†è§£å¤šç§æ–¹æ¡ˆï¼Œæ¨èåº”ç”¨å±‚æ— çŠ¶æ€åŒ–</li>
<li><strong>HTTPS é…ç½®</strong>ï¼šSSL è¯ä¹¦é…ç½®å’Œå®‰å…¨åŠ å›º</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šè¿æ¥ä¼˜åŒ–ã€ç¼“å­˜ã€å‹ç¼©ã€é™æµç­‰</li>
<li><strong>ç›‘æ§æ—¥å¿—</strong>ï¼šæ—¥å¿—åˆ†æå’ŒçŠ¶æ€ç›‘æ§</li>
</ul>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒNginx çš„ä½œç”¨è¿œä¸æ­¢äºæ­¤ã€‚é€šè¿‡åˆç†é…ç½®ï¼Œè¿˜å¯ä»¥å®ç°ï¼š</p>
<ul>
<li><strong>ç°åº¦å‘å¸ƒ</strong>ï¼šæ ¹æ®æ¡ä»¶å°†éƒ¨åˆ†æµé‡å¯¼å‘æ–°ç‰ˆæœ¬</li>
<li><strong>A/B æµ‹è¯•</strong>ï¼šå°†ä¸åŒç”¨æˆ·å¯¼å‘ä¸åŒç‰ˆæœ¬</li>
<li><strong>æµé‡æ§åˆ¶</strong>ï¼šé™æµã€ç†”æ–­ã€é™çº§</li>
<li><strong>å®‰å…¨é˜²æŠ¤</strong>ï¼šWAFã€DDoS é˜²æŠ¤</li>
</ul>
<p>ä¸‹æ¬¡å½“ä½ éœ€è¦æ­å»ºé«˜å¯ç”¨æœåŠ¡æ¶æ„æ—¶ï¼ŒNginx å°†æ˜¯ä½ çš„å¾—åŠ›åŠ©æ‰‹ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/nginx/">Nginx</a></li>
      <li><a href="http://localhost:1313/tags/linux/">Linux</a></li>
      <li><a href="http://localhost:1313/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">æœ€ä½³å®è·µ</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/2025/07/git-%E5%B7%A5%E4%BD%9C%E6%B5%81%E4%BB%8E%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86%E5%88%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">
    <span class="title">Â« Prev</span>
    <br>
    <span>Git å·¥ä½œæµï¼šä»åˆ†æ”¯ç®¡ç†åˆ°ä»£ç å®¡æŸ¥çš„æœ€ä½³å®è·µ</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/2025/05/easyexcel-%E7%99%BE%E4%B8%87%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E7%9A%84%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/">
    <span class="title">Next Â»</span>
    <br>
    <span>EasyExcel ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„å†…å­˜ä¼˜åŒ–å®æˆ˜</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ– on x"
            href="https://x.com/intent/tweet/?text=Nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e4%b8%8e%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%85%a5%e9%97%a8%e5%88%b0%e7%94%9f%e4%ba%a7%e4%bc%98%e5%8c%96&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f06%2fnginx-%25E5%258F%258D%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%25E4%25B8%258E%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E5%25AE%259E%25E6%2588%2598%25E4%25BB%258E%25E5%2585%25A5%25E9%2597%25A8%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E4%25BC%2598%25E5%258C%2596%2f&amp;hashtags=Nginx%2cLinux%2c%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ– on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f06%2fnginx-%25E5%258F%258D%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%25E4%25B8%258E%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E5%25AE%259E%25E6%2588%2598%25E4%25BB%258E%25E5%2585%25A5%25E9%2597%25A8%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E4%25BC%2598%25E5%258C%2596%2f&amp;title=Nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e4%b8%8e%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%85%a5%e9%97%a8%e5%88%b0%e7%94%9f%e4%ba%a7%e4%bc%98%e5%8c%96&amp;summary=Nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e4%b8%8e%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%85%a5%e9%97%a8%e5%88%b0%e7%94%9f%e4%ba%a7%e4%bc%98%e5%8c%96&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f06%2fnginx-%25E5%258F%258D%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%25E4%25B8%258E%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E5%25AE%259E%25E6%2588%2598%25E4%25BB%258E%25E5%2585%25A5%25E9%2597%25A8%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E4%25BC%2598%25E5%258C%2596%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ– on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f06%2fnginx-%25E5%258F%258D%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%25E4%25B8%258E%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E5%25AE%259E%25E6%2588%2598%25E4%25BB%258E%25E5%2585%25A5%25E9%2597%25A8%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E4%25BC%2598%25E5%258C%2596%2f&title=Nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e4%b8%8e%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%85%a5%e9%97%a8%e5%88%b0%e7%94%9f%e4%ba%a7%e4%bc%98%e5%8c%96">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ– on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f06%2fnginx-%25E5%258F%258D%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%25E4%25B8%258E%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E5%25AE%259E%25E6%2588%2598%25E4%25BB%258E%25E5%2585%25A5%25E9%2597%25A8%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E4%25BC%2598%25E5%258C%2596%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ– on whatsapp"
            href="https://api.whatsapp.com/send?text=Nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e4%b8%8e%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%85%a5%e9%97%a8%e5%88%b0%e7%94%9f%e4%ba%a7%e4%bc%98%e5%8c%96%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f06%2fnginx-%25E5%258F%258D%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%25E4%25B8%258E%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E5%25AE%259E%25E6%2588%2598%25E4%25BB%258E%25E5%2585%25A5%25E9%2597%25A8%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E4%25BC%2598%25E5%258C%2596%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ– on telegram"
            href="https://telegram.me/share/url?text=Nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e4%b8%8e%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%85%a5%e9%97%a8%e5%88%b0%e7%94%9f%e4%ba%a7%e4%bc%98%e5%8c%96&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f06%2fnginx-%25E5%258F%258D%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%25E4%25B8%258E%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E5%25AE%259E%25E6%2588%2598%25E4%25BB%258E%25E5%2585%25A5%25E9%2597%25A8%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E4%25BC%2598%25E5%258C%2596%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ– on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e4%b8%8e%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ae%9e%e6%88%98%ef%bc%9a%e4%bb%8e%e5%85%a5%e9%97%a8%e5%88%b0%e7%94%9f%e4%ba%a7%e4%bc%98%e5%8c%96&u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f06%2fnginx-%25E5%258F%258D%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%25E4%25B8%258E%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E5%25AE%259E%25E6%2588%2598%25E4%25BB%258E%25E5%2585%25A5%25E9%2597%25A8%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E4%25BC%2598%25E5%258C%2596%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">åšå®¢å–µ</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
