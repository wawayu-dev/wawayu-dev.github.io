<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜ | åšå®¢å–µ</title>
<meta name="keywords" content="Netty, åˆ†å¸ƒå¼ç³»ç»Ÿ, é«˜å¹¶å‘, æœ€ä½³å®è·µ">
<meta name="description" content="æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–åè®®å‡çº§ã€å¿ƒè·³æœºåˆ¶ã€é›†ç¾¤éƒ¨ç½²ç­‰ç”Ÿäº§çº§å®è·µ">
<meta name="author" content="wawayu">
<link rel="canonical" href="http://localhost:1313/posts/2025/04/netty--websocket-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.a29c24210eb31d9ce56f669c66a35c9c51b17376b7764e336a49af7dec914cf0.css" integrity="sha256-opwkIQ6zHZzlb2acZqNcnFGxc3a3dk4zakmvfeyRTPA=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/2025/04/netty--websocket-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="http://localhost:1313/posts/2025/04/netty--websocket-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/">
  <meta property="og:site_name" content="åšå®¢å–µ">
  <meta property="og:title" content="Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜">
  <meta property="og:description" content="æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–åè®®å‡çº§ã€å¿ƒè·³æœºåˆ¶ã€é›†ç¾¤éƒ¨ç½²ç­‰ç”Ÿäº§çº§å®è·µ">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-18T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-04-18T00:00:00+00:00">
    <meta property="article:tag" content="Netty">
    <meta property="article:tag" content="åˆ†å¸ƒå¼ç³»ç»Ÿ">
    <meta property="article:tag" content="é«˜å¹¶å‘">
    <meta property="article:tag" content="æœ€ä½³å®è·µ">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜">
<meta name="twitter:description" content="æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–åè®®å‡çº§ã€å¿ƒè·³æœºåˆ¶ã€é›†ç¾¤éƒ¨ç½²ç­‰ç”Ÿäº§çº§å®è·µ">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Netty + WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜",
      "item": "http://localhost:1313/posts/2025/04/netty--websocket-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Netty + WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜",
  "name": "Netty \u002b WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜",
  "description": "æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–åè®®å‡çº§ã€å¿ƒè·³æœºåˆ¶ã€é›†ç¾¤éƒ¨ç½²ç­‰ç”Ÿäº§çº§å®è·µ",
  "keywords": [
    "Netty", "åˆ†å¸ƒå¼ç³»ç»Ÿ", "é«˜å¹¶å‘", "æœ€ä½³å®è·µ"
  ],
  "articleBody": "åœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå®æ—¶æ¶ˆæ¯æ¨é€å·²æˆä¸ºæ ‡é…åŠŸèƒ½ã€‚ä»å³æ—¶é€šè®¯ã€åœ¨çº¿å®¢æœåˆ°å®æ—¶ç›‘æ§å¤§å±ï¼Œéƒ½ç¦»ä¸å¼€é«˜æ€§èƒ½çš„æ¶ˆæ¯æ¨é€èƒ½åŠ›ã€‚ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼å­˜åœ¨å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹ç­‰é—®é¢˜ï¼Œè€Œ WebSocket åè®®çš„å‡ºç°å®Œç¾è§£å†³äº†è¿™äº›ç—›ç‚¹ã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty æ¡†æ¶å®ç°åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜ï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¨é€æœåŠ¡ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ WebSocket åè®®åŸç†ä¸æ¡æ‰‹æµç¨‹ å­¦ä¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨ ç†è§£å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ç®¡ç†ç­–ç•¥ æŒæ¡é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±æ–¹æ¡ˆ äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§ ä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket WebSocket åè®®ä¼˜åŠ¿ ç›¸æ¯”ä¼ ç»Ÿçš„ HTTP è½®è¯¢ï¼ŒWebSocket å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\nç‰¹æ€§ HTTP è½®è¯¢ WebSocket é€šä¿¡æ–¹å¼ åŠåŒå·¥ å…¨åŒå·¥ è¿æ¥å¼€é”€ æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥ ä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥ å®æ—¶æ€§ å–å†³äºè½®è¯¢é—´éš”ï¼ˆç§’çº§ï¼‰ æ¯«ç§’çº§ æœåŠ¡å™¨å‹åŠ› é«˜ï¼ˆé¢‘ç¹çš„ HTTP è¯·æ±‚ï¼‰ ä½ï¼ˆé•¿è¿æ¥ï¼‰ å¸¦å®½æ¶ˆè€— é«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰ HTTP å¤´ï¼‰ ä½ï¼ˆåªä¼ è¾“æ•°æ®å¸§ï¼‰ Netty æ¡†æ¶ä¼˜åŠ¿ Netty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\né«˜æ€§èƒ½ï¼šåŸºäº NIOï¼Œæ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥ æ˜“ç”¨æ€§ï¼šæä¾›äº†ä¸°å¯Œçš„ç¼–è§£ç å™¨å’Œå¤„ç†å™¨ ç¨³å®šæ€§ï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯ æ‰©å±•æ€§ï¼šçµæ´»çš„ Pipeline æœºåˆ¶ æ¶æ„æ€è€ƒï¼š é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œä¸ä»…è¦çœ‹æŠ€æœ¯æœ¬èº«çš„ä¼˜åŠ¿ï¼Œæ›´è¦è€ƒè™‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€è¿ç»´æˆæœ¬å’Œç¤¾åŒºç”Ÿæ€ã€‚Netty åœ¨ Java ç”Ÿæ€ä¸­å·²ç»æˆä¸ºäº‹å®æ ‡å‡†ï¼ŒDubboã€RocketMQã€Elasticsearch ç­‰çŸ¥åé¡¹ç›®éƒ½åœ¨ä½¿ç”¨ã€‚\nWebSocket åè®®åŸç† æ¡æ‰‹æµç¨‹ WebSocket åŸºäº HTTP åè®®è¿›è¡Œæ¡æ‰‹ï¼Œç„¶åå‡çº§ä¸º WebSocket åè®®ï¼š\n1å®¢æˆ·ç«¯è¯·æ±‚ï¼š 2GET /chat HTTP/1.1 3Host: server.example.com 4Upgrade: websocket 5Connection: Upgrade 6Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ== 7Sec-WebSocket-Version: 13 8 9æœåŠ¡ç«¯å“åº”ï¼š 10HTTP/1.1 101 Switching Protocols 11Upgrade: websocket 12Connection: Upgrade 13Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo= æ•°æ®å¸§æ ¼å¼ WebSocket ä½¿ç”¨å¸§ï¼ˆFrameï¼‰æ¥ä¼ è¾“æ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ï¼š\næ–‡æœ¬å¸§ï¼šä¼ è¾“ UTF-8 ç¼–ç çš„æ–‡æœ¬ äºŒè¿›åˆ¶å¸§ï¼šä¼ è¾“äºŒè¿›åˆ¶æ•°æ® æ§åˆ¶å¸§ï¼šPingã€Pongã€Close Netty WebSocket æœåŠ¡å™¨å®ç° é¡¹ç›®ä¾èµ– 1 2 3 4 io.netty 5 netty-all 6 4.1.100.Final 7 8 9 10 11 com.alibaba.fastjson2 12 fastjson2 13 2.0.43 14 15 æœåŠ¡å™¨å¯åŠ¨ç±» 1@Slf4j 2@Component 3public class WebSocketServer { 4 5 private final int port = 8888; 6 private EventLoopGroup bossGroup; 7 private EventLoopGroup workerGroup; 8 9 @PostConstruct 10 public void start() throws InterruptedException { 11 bossGroup = new NioEventLoopGroup(1); 12 workerGroup = new NioEventLoopGroup(); 13 14 try { 15 ServerBootstrap bootstrap = new ServerBootstrap(); 16 bootstrap.group(bossGroup, workerGroup) 17 .channel(NioServerSocketChannel.class) 18 .childHandler(new WebSocketChannelInitializer()) 19 .option(ChannelOption.SO_BACKLOG, 128) 20 .childOption(ChannelOption.SO_KEEPALIVE, true); 21 22 ChannelFuture future = bootstrap.bind(port).sync(); 23 log.info(\"WebSocket æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç«¯å£ï¼š{}\", port); 24 25 // ç­‰å¾…æœåŠ¡å™¨å…³é—­ 26 future.channel().closeFuture().sync(); 27 } finally { 28 shutdown(); 29 } 30 } 31 32 @PreDestroy 33 public void shutdown() { 34 if (bossGroup != null) { 35 bossGroup.shutdownGracefully(); 36 } 37 if (workerGroup != null) { 38 workerGroup.shutdownGracefully(); 39 } 40 log.info(\"WebSocket æœåŠ¡å™¨å·²å…³é—­\"); 41 } 42} Channel åˆå§‹åŒ–å™¨ 1public class WebSocketChannelInitializer extends ChannelInitializer\u003cSocketChannel\u003e { 2 3 @Override 4 protected void initChannel(SocketChannel ch) { 5 ChannelPipeline pipeline = ch.pipeline(); 6 7 // HTTP ç¼–è§£ç å™¨ 8 pipeline.addLast(new HttpServerCodec()); 9 // HTTP èšåˆå™¨ï¼ˆå°†å¤šä¸ª HTTP æ¶ˆæ¯èšåˆæˆä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼‰ 10 pipeline.addLast(new HttpObjectAggregator(65536)); 11 // HTTP å‹ç¼© 12 pipeline.addLast(new HttpContentCompressor()); 13 14 // WebSocket åè®®å¤„ç†å™¨ï¼ˆå¤„ç†æ¡æ‰‹ã€Closeã€Pingã€Pongï¼‰ 15 pipeline.addLast(new WebSocketServerProtocolHandler(\"/ws\", null, true)); 16 17 // å¿ƒè·³æ£€æµ‹ï¼ˆè¯»ç©ºé—² 60 ç§’ï¼Œå†™ç©ºé—² 0 ç§’ï¼Œè¯»å†™ç©ºé—² 0 ç§’ï¼‰ 18 pipeline.addLast(new IdleStateHandler(60, 0, 0, TimeUnit.SECONDS)); 19 20 // è‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†å™¨ 21 pipeline.addLast(new WebSocketHandler()); 22 } 23} ä¸šåŠ¡å¤„ç†å™¨ 1@Slf4j 2@ChannelHandler.Sharable 3public class WebSocketHandler extends SimpleChannelInboundHandler\u003cTextWebSocketFrame\u003e { 4 5 @Override 6 public void channelActive(ChannelHandlerContext ctx) { 7 // è¿æ¥å»ºç«‹æ—¶ 8 Channel channel = ctx.channel(); 9 log.info(\"å®¢æˆ·ç«¯è¿æ¥ï¼š{}\", channel.id().asShortText()); 10 11 // å°† Channel åŠ å…¥ç®¡ç†å™¨ 12 ChannelManager.addChannel(channel); 13 } 14 15 @Override 16 protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) { 17 // æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ 18 String content = msg.text(); 19 log.info(\"æ”¶åˆ°æ¶ˆæ¯ï¼š{}\", content); 20 21 // è§£ææ¶ˆæ¯ 22 Message message = JSON.parseObject(content, Message.class); 23 24 // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ 25 switch (message.getType()) { 26 case \"auth\": 27 handleAuth(ctx, message); 28 break; 29 case \"heartbeat\": 30 handleHeartbeat(ctx); 31 break; 32 case \"message\": 33 handleMessage(ctx, message); 34 break; 35 default: 36 log.warn(\"æœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼š{}\", message.getType()); 37 } 38 } 39 40 @Override 41 public void channelInactive(ChannelHandlerContext ctx) { 42 // è¿æ¥æ–­å¼€æ—¶ 43 Channel channel = ctx.channel(); 44 log.info(\"å®¢æˆ·ç«¯æ–­å¼€ï¼š{}\", channel.id().asShortText()); 45 46 // ä»ç®¡ç†å™¨ä¸­ç§»é™¤ 47 ChannelManager.removeChannel(channel); 48 } 49 50 @Override 51 public void userEventTriggered(ChannelHandlerContext ctx, Object evt) { 52 // å¤„ç†ç©ºé—²äº‹ä»¶ 53 if (evt instanceof IdleStateEvent) { 54 IdleStateEvent event = (IdleStateEvent) evt; 55 if (event.state() == IdleState.READER_IDLE) { 56 log.warn(\"å®¢æˆ·ç«¯ {} è¯»ç©ºé—²ï¼Œå…³é—­è¿æ¥\", ctx.channel().id().asShortText()); 57 ctx.close(); 58 } 59 } 60 } 61 62 @Override 63 public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) { 64 log.error(\"è¿æ¥å¼‚å¸¸ï¼š{}\", cause.getMessage(), cause); 65 ctx.close(); 66 } 67 68 /** 69 * å¤„ç†è®¤è¯æ¶ˆæ¯ 70 */ 71 private void handleAuth(ChannelHandlerContext ctx, Message message) { 72 String userId = message.getUserId(); 73 Channel channel = ctx.channel(); 74 75 // ç»‘å®šç”¨æˆ· ID å’Œ Channel 76 ChannelManager.bindUser(userId, channel); 77 78 // å‘é€è®¤è¯æˆåŠŸæ¶ˆæ¯ 79 Message response = Message.builder() 80 .type(\"auth_response\") 81 .content(\"è®¤è¯æˆåŠŸ\") 82 .build(); 83 ctx.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(response))); 84 85 log.info(\"ç”¨æˆ· {} è®¤è¯æˆåŠŸ\", userId); 86 } 87 88 /** 89 * å¤„ç†å¿ƒè·³æ¶ˆæ¯ 90 */ 91 private void handleHeartbeat(ChannelHandlerContext ctx) { 92 Message response = Message.builder() 93 .type(\"heartbeat_response\") 94 .content(\"pong\") 95 .build(); 96 ctx.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(response))); 97 } 98 99 /** 100 * å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ 101 */ 102 private void handleMessage(ChannelHandlerContext ctx, Message message) { 103 // æ ¹æ®ä¸šåŠ¡é€»è¾‘å¤„ç†æ¶ˆæ¯ 104 log.info(\"å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ï¼š{}\", message.getContent()); 105 106 // ç¤ºä¾‹ï¼šå¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ· 107 ChannelManager.broadcast(message); 108 } 109} è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯æ¨é€ Channel ç®¡ç†å™¨ 1@Slf4j 2public class ChannelManager { 3 4 // æ‰€æœ‰è¿æ¥çš„ Channel 5 private static final ChannelGroup CHANNELS = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE); 6 7 // ç”¨æˆ· ID ä¸ Channel çš„æ˜ å°„ 8 private static final ConcurrentHashMap\u003cString, Channel\u003e USER_CHANNELS = new ConcurrentHashMap\u003c\u003e(); 9 10 /** 11 * æ·»åŠ  Channel 12 */ 13 public static void addChannel(Channel channel) { 14 CHANNELS.add(channel); 15 log.info(\"å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}\", CHANNELS.size()); 16 } 17 18 /** 19 * ç§»é™¤ Channel 20 */ 21 public static void removeChannel(Channel channel) { 22 CHANNELS.remove(channel); 23 24 // ç§»é™¤ç”¨æˆ·ç»‘å®š 25 USER_CHANNELS.entrySet().removeIf(entry -\u003e entry.getValue().equals(channel)); 26 27 log.info(\"å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}\", CHANNELS.size()); 28 } 29 30 /** 31 * ç»‘å®šç”¨æˆ·å’Œ Channel 32 */ 33 public static void bindUser(String userId, Channel channel) { 34 USER_CHANNELS.put(userId, channel); 35 log.info(\"ç”¨æˆ· {} ç»‘å®šæˆåŠŸï¼Œå½“å‰åœ¨çº¿ç”¨æˆ·æ•°ï¼š{}\", userId, USER_CHANNELS.size()); 36 } 37 38 /** 39 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ· 40 */ 41 public static void pushToUser(String userId, Message message) { 42 Channel channel = USER_CHANNELS.get(userId); 43 if (channel != null \u0026\u0026 channel.isActive()) { 44 channel.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(message))); 45 log.info(\"æ¨é€æ¶ˆæ¯ç»™ç”¨æˆ· {}ï¼š{}\", userId, message.getContent()); 46 } else { 47 log.warn(\"ç”¨æˆ· {} ä¸åœ¨çº¿æˆ–è¿æ¥å·²æ–­å¼€\", userId); 48 } 49 } 50 51 /** 52 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ· 53 */ 54 public static void broadcast(Message message) { 55 TextWebSocketFrame frame = new TextWebSocketFrame(JSON.toJSONString(message)); 56 CHANNELS.writeAndFlush(frame); 57 log.info(\"å¹¿æ’­æ¶ˆæ¯ç»™ {} ä¸ªç”¨æˆ·ï¼š{}\", CHANNELS.size(), message.getContent()); 58 } 59 60 /** 61 * è·å–åœ¨çº¿ç”¨æˆ·æ•° 62 */ 63 public static int getOnlineUserCount() { 64 return USER_CHANNELS.size(); 65 } 66} æ¶ˆæ¯æ¨é€æœåŠ¡ 1@Slf4j 2@Service 3public class MessagePushService { 4 5 /** 6 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ· 7 */ 8 public void pushToUser(String userId, String content) { 9 Message message = Message.builder() 10 .type(\"push\") 11 .content(content) 12 .timestamp(System.currentTimeMillis()) 13 .build(); 14 15 ChannelManager.pushToUser(userId, message); 16 } 17 18 /** 19 * æ¨é€æ¶ˆæ¯ç»™å¤šä¸ªç”¨æˆ· 20 */ 21 public void pushToUsers(List\u003cString\u003e userIds, String content) { 22 Message message = Message.builder() 23 .type(\"push\") 24 .content(content) 25 .timestamp(System.currentTimeMillis()) 26 .build(); 27 28 userIds.forEach(userId -\u003e ChannelManager.pushToUser(userId, message)); 29 } 30 31 /** 32 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ· 33 */ 34 public void broadcast(String content) { 35 Message message = Message.builder() 36 .type(\"broadcast\") 37 .content(content) 38 .timestamp(System.currentTimeMillis()) 39 .build(); 40 41 ChannelManager.broadcast(message); 42 } 43} å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ä¿æ´» ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³ åœ¨é•¿è¿æ¥åœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nç½‘ç»œä¸­æ–­æ£€æµ‹ï¼šç½‘ç»œå¼‚å¸¸æ—¶ï¼ŒTCP è¿æ¥ä¸ä¼šç«‹å³æ–­å¼€ NAT è¶…æ—¶ï¼šNAT è®¾å¤‡ä¼šæ¸…ç†é•¿æ—¶é—´æ— æ•°æ®ä¼ è¾“çš„è¿æ¥ è´Ÿè½½å‡è¡¡è¶…æ—¶ï¼šè´Ÿè½½å‡è¡¡å™¨å¯èƒ½ä¼šå…³é—­ç©ºé—²è¿æ¥ å¿ƒè·³å®ç°æ–¹æ¡ˆ æœåŠ¡ç«¯å¿ƒè·³æ£€æµ‹ï¼š\n1// åœ¨ ChannelInitializer ä¸­æ·»åŠ  2pipeline.addLast(new IdleStateHandler(60, 0, 0, TimeUnit.SECONDS)); å®¢æˆ·ç«¯å¿ƒè·³å‘é€ï¼ˆJavaScript ç¤ºä¾‹ï¼‰ï¼š\n1class WebSocketClient { 2 constructor(url) { 3 this.url = url; 4 this.ws = null; 5 this.heartbeatTimer = null; 6 this.reconnectTimer = null; 7 } 8 9 connect() { 10 this.ws = new WebSocket(this.url); 11 12 this.ws.onopen = () =\u003e { 13 console.log('WebSocket è¿æ¥æˆåŠŸ'); 14 this.startHeartbeat(); 15 16 // å‘é€è®¤è¯æ¶ˆæ¯ 17 this.send({ 18 type: 'auth', 19 userId: 'user123', 20 token: 'xxx' 21 }); 22 }; 23 24 this.ws.onmessage = (event) =\u003e { 25 const message = JSON.parse(event.data); 26 console.log('æ”¶åˆ°æ¶ˆæ¯ï¼š', message); 27 28 // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ 29 switch (message.type) { 30 case 'auth_response': 31 console.log('è®¤è¯æˆåŠŸ'); 32 break; 33 case 'push': 34 this.handlePush(message); 35 break; 36 case 'heartbeat_response': 37 // æ”¶åˆ°å¿ƒè·³å“åº” 38 break; 39 } 40 }; 41 42 this.ws.onclose = () =\u003e { 43 console.log('WebSocket è¿æ¥å…³é—­'); 44 this.stopHeartbeat(); 45 this.reconnect(); 46 }; 47 48 this.ws.onerror = (error) =\u003e { 49 console.error('WebSocket é”™è¯¯ï¼š', error); 50 }; 51 } 52 53 send(message) { 54 if (this.ws \u0026\u0026 this.ws.readyState === WebSocket.OPEN) { 55 this.ws.send(JSON.stringify(message)); 56 } 57 } 58 59 startHeartbeat() { 60 this.heartbeatTimer = setInterval(() =\u003e { 61 this.send({ 62 type: 'heartbeat', 63 timestamp: Date.now() 64 }); 65 }, 30000); // æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ 66 } 67 68 stopHeartbeat() { 69 if (this.heartbeatTimer) { 70 clearInterval(this.heartbeatTimer); 71 this.heartbeatTimer = null; 72 } 73 } 74 75 reconnect() { 76 if (this.reconnectTimer) { 77 return; 78 } 79 80 this.reconnectTimer = setTimeout(() =\u003e { 81 console.log('å°è¯•é‡æ–°è¿æ¥...'); 82 this.reconnectTimer = null; 83 this.connect(); 84 }, 5000); // 5 ç§’åé‡è¿ 85 } 86 87 handlePush(message) { 88 // å¤„ç†æ¨é€æ¶ˆæ¯ 89 console.log('æ”¶åˆ°æ¨é€ï¼š', message.content); 90 } 91 92 close() { 93 this.stopHeartbeat(); 94 if (this.ws) { 95 this.ws.close(); 96 } 97 } 98} 99 100// ä½¿ç”¨ç¤ºä¾‹ 101const client = new WebSocketClient('ws://localhost:8888/ws'); 102client.connect(); é¿å‘æç¤ºï¼š å¿ƒè·³é—´éš”çš„è®¾ç½®éœ€è¦æƒè¡¡ï¼šé—´éš”å¤ªçŸ­ä¼šå¢åŠ æœåŠ¡å™¨å‹åŠ›ï¼Œé—´éš”å¤ªé•¿å¯èƒ½æ— æ³•åŠæ—¶å‘ç°è¿æ¥æ–­å¼€ã€‚å»ºè®®å®¢æˆ·ç«¯å¿ƒè·³é—´éš”ä¸º 30 ç§’ï¼ŒæœåŠ¡ç«¯è¶…æ—¶æ—¶é—´ä¸º 60 ç§’ã€‚\né›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”± å•æœºæ¶æ„çš„å±€é™ å•æœº WebSocket æœåŠ¡å™¨å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nè¿æ¥æ•°é™åˆ¶ï¼šå•æœºæœ€å¤šæ”¯æŒå‡ ä¸‡åˆ°åå‡ ä¸‡è¿æ¥ å•ç‚¹æ•…éšœï¼šæœåŠ¡å™¨å®•æœºå¯¼è‡´æ‰€æœ‰è¿æ¥æ–­å¼€ æ¶ˆæ¯è·¯ç”±ï¼šæ— æ³•æ¨é€æ¶ˆæ¯ç»™å…¶ä»–æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ· é›†ç¾¤æ¶æ„æ–¹æ¡ˆ 1 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2 â”‚ Nginx â”‚ 3 â”‚ (è´Ÿè½½å‡è¡¡) â”‚ 4 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ 5 â”‚ 6 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 7 â”‚ â”‚ â”‚ 8 â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” 9 â”‚ WS Serverâ”‚ â”‚ WS Serverâ”‚ â”‚ WS Serverâ”‚ 10 â”‚ Node1 â”‚ â”‚ Node2 â”‚ â”‚ Node3 â”‚ 11 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ 12 â”‚ â”‚ â”‚ 13 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 14 â”‚ 15 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” 16 â”‚ Redis â”‚ 17 â”‚ (æ¶ˆæ¯è·¯ç”±) â”‚ 18 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Nginx é…ç½® 1upstream websocket { 2 # IP Hash ç­–ç•¥ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·è¿æ¥åˆ°åŒä¸€å°æœåŠ¡å™¨ 3 ip_hash; 4 5 server 192.168.1.101:8888; 6 server 192.168.1.102:8888; 7 server 192.168.1.103:8888; 8} 9 10server { 11 listen 80; 12 server_name ws.example.com; 13 14 location /ws { 15 proxy_pass http://websocket; 16 proxy_http_version 1.1; 17 proxy_set_header Upgrade $http_upgrade; 18 proxy_set_header Connection \"upgrade\"; 19 proxy_set_header Host $host; 20 proxy_set_header X-Real-IP $remote_addr; 21 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 22 23 # è¶…æ—¶è®¾ç½® 24 proxy_connect_timeout 60s; 25 proxy_send_timeout 60s; 26 proxy_read_timeout 60s; 27 } 28} Redis æ¶ˆæ¯è·¯ç”± 1@Slf4j 2@Component 3public class RedisMessageRouter { 4 5 @Autowired 6 private RedisTemplate\u003cString, String\u003e redisTemplate; 7 8 private static final String CHANNEL_PREFIX = \"ws:message:\"; 9 10 @PostConstruct 11 public void init() { 12 // è®¢é˜… Redis é¢‘é“ 13 redisTemplate.getConnectionFactory().getConnection() 14 .subscribe((message, pattern) -\u003e { 15 String msg = new String(message.getBody()); 16 handleMessage(msg); 17 }, (CHANNEL_PREFIX + \"*\").getBytes()); 18 } 19 20 /** 21 * å‘å¸ƒæ¶ˆæ¯åˆ° Redis 22 */ 23 public void publish(String userId, Message message) { 24 String channel = CHANNEL_PREFIX + userId; 25 redisTemplate.convertAndSend(channel, JSON.toJSONString(message)); 26 } 27 28 /** 29 * å¤„ç†ä» Redis æ¥æ”¶åˆ°çš„æ¶ˆæ¯ 30 */ 31 private void handleMessage(String msg) { 32 Message message = JSON.parseObject(msg, Message.class); 33 String userId = message.getUserId(); 34 35 // å¦‚æœç”¨æˆ·åœ¨æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥æ¨é€ 36 ChannelManager.pushToUser(userId, message); 37 } 38} æ”¹è¿›çš„æ¨é€æœåŠ¡ 1@Slf4j 2@Service 3public class ClusterMessagePushService { 4 5 @Autowired 6 private RedisMessageRouter redisMessageRouter; 7 8 @Autowired 9 private RedisTemplate\u003cString, String\u003e redisTemplate; 10 11 /** 12 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰ 13 */ 14 public void pushToUser(String userId, String content) { 15 Message message = Message.builder() 16 .type(\"push\") 17 .userId(userId) 18 .content(content) 19 .timestamp(System.currentTimeMillis()) 20 .build(); 21 22 // å…ˆå°è¯•æœ¬åœ°æ¨é€ 23 Channel channel = ChannelManager.getUserChannel(userId); 24 if (channel != null \u0026\u0026 channel.isActive()) { 25 ChannelManager.pushToUser(userId, message); 26 } else { 27 // ç”¨æˆ·ä¸åœ¨æœ¬èŠ‚ç‚¹ï¼Œé€šè¿‡ Redis è·¯ç”± 28 redisMessageRouter.publish(userId, message); 29 } 30 } 31 32 /** 33 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰ 34 */ 35 public void broadcast(String content) { 36 Message message = Message.builder() 37 .type(\"broadcast\") 38 .content(content) 39 .timestamp(System.currentTimeMillis()) 40 .build(); 41 42 // å‘å¸ƒåˆ° Redis å¹¿æ’­é¢‘é“ 43 redisTemplate.convertAndSend(\"ws:broadcast\", JSON.toJSONString(message)); 44 } 45} æ¶æ„æ€è€ƒï¼š åœ¨é›†ç¾¤æ¶æ„ä¸­ï¼Œæ¶ˆæ¯è·¯ç”±æ˜¯æ ¸å¿ƒé—®é¢˜ã€‚é™¤äº† Redis Pub/Subï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ RocketMQã€Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—ã€‚é€‰æ‹©æ—¶éœ€è¦è€ƒè™‘ï¼š1) æ¶ˆæ¯å¯é æ€§è¦æ±‚ï¼›2) æ¶ˆæ¯é¡ºåºæ€§è¦æ±‚ï¼›3) ç³»ç»Ÿå¤æ‚åº¦ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜ä½†å¯é æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼ŒRedis Pub/Sub æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚\nç”Ÿäº§ç¯å¢ƒä¼˜åŒ– æ€§èƒ½ä¼˜åŒ– 1. çº¿ç¨‹æ± é…ç½®\n1// Boss çº¿ç¨‹ç»„ï¼šå¤„ç†è¿æ¥è¯·æ±‚ 2EventLoopGroup bossGroup = new NioEventLoopGroup(1); 3 4// Worker çº¿ç¨‹ç»„ï¼šå¤„ç† I/O æ“ä½œ 5// é»˜è®¤çº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2 6EventLoopGroup workerGroup = new NioEventLoopGroup(); 7 8// ä¸šåŠ¡çº¿ç¨‹æ± ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ 9ThreadPoolExecutor businessExecutor = new ThreadPoolExecutor( 10 10, 50, 60L, TimeUnit.SECONDS, 11 new LinkedBlockingQueue\u003c\u003e(1000), 12 new ThreadFactoryBuilder().setNameFormat(\"business-%d\").build(), 13 new ThreadPoolExecutor.CallerRunsPolicy() 14); 2. å†…å­˜ä¼˜åŒ–\n1// ä½¿ç”¨æ± åŒ–çš„ ByteBuf 2bootstrap.option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); 3bootstrap.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); 4 5// è®¾ç½®æ¥æ”¶ç¼“å†²åŒºå¤§å° 6bootstrap.childOption(ChannelOption.RCVBUF_ALLOCATOR, 7 new AdaptiveRecvByteBufAllocator(64, 1024, 65536)); 3. è¿æ¥æ•°ä¼˜åŒ–\n1// å¢åŠ  TCP è¿æ¥é˜Ÿåˆ—é•¿åº¦ 2bootstrap.option(ChannelOption.SO_BACKLOG, 1024); 3 4// å¯ç”¨ TCP_NODELAYï¼ˆç¦ç”¨ Nagle ç®—æ³•ï¼‰ 5bootstrap.childOption(ChannelOption.TCP_NODELAY, true); 6 7// å¯ç”¨ SO_KEEPALIVE 8bootstrap.childOption(ChannelOption.SO_KEEPALIVE, true); ç›‘æ§æŒ‡æ ‡ 1@Component 2public class WebSocketMetrics { 3 4 private final AtomicLong totalConnections = new AtomicLong(0); 5 private final AtomicLong activeConnections = new AtomicLong(0); 6 private final AtomicLong totalMessages = new AtomicLong(0); 7 8 /** 9 * è®°å½•è¿æ¥å»ºç«‹ 10 */ 11 public void recordConnect() { 12 totalConnections.incrementAndGet(); 13 activeConnections.incrementAndGet(); 14 } 15 16 /** 17 * è®°å½•è¿æ¥æ–­å¼€ 18 */ 19 public void recordDisconnect() { 20 activeConnections.decrementAndGet(); 21 } 22 23 /** 24 * è®°å½•æ¶ˆæ¯å‘é€ 25 */ 26 public void recordMessage() { 27 totalMessages.incrementAndGet(); 28 } 29 30 /** 31 * è·å–ç›‘æ§æ•°æ® 32 */ 33 public Map\u003cString, Object\u003e getMetrics() { 34 Map\u003cString, Object\u003e metrics = new HashMap\u003c\u003e(); 35 metrics.put(\"totalConnections\", totalConnections.get()); 36 metrics.put(\"activeConnections\", activeConnections.get()); 37 metrics.put(\"totalMessages\", totalMessages.get()); 38 metrics.put(\"onlineUsers\", ChannelManager.getOnlineUserCount()); 39 return metrics; 40 } 41} å®‰å…¨åŠ å›º 1. è®¤è¯é‰´æƒ\n1private void handleAuth(ChannelHandlerContext ctx, Message message) { 2 String token = message.getToken(); 3 4 // éªŒè¯ Token 5 if (!validateToken(token)) { 6 ctx.writeAndFlush(new TextWebSocketFrame( 7 JSON.toJSONString(Message.builder() 8 .type(\"auth_response\") 9 .code(401) 10 .content(\"è®¤è¯å¤±è´¥\") 11 .build()) 12 )); 13 ctx.close(); 14 return; 15 } 16 17 // è®¤è¯æˆåŠŸï¼Œç»‘å®šç”¨æˆ· 18 String userId = getUserIdFromToken(token); 19 ChannelManager.bindUser(userId, ctx.channel()); 20} 2. æ¶ˆæ¯é™æµ\n1@Component 2public class MessageRateLimiter { 3 4 private final LoadingCache\u003cString, RateLimiter\u003e limiters = CacheBuilder.newBuilder() 5 .maximumSize(10000) 6 .expireAfterAccess(1, TimeUnit.HOURS) 7 .build(new CacheLoader\u003cString, RateLimiter\u003e() { 8 @Override 9 public RateLimiter load(String key) { 10 // æ¯ç§’æœ€å¤š 10 æ¡æ¶ˆæ¯ 11 return RateLimiter.create(10.0); 12 } 13 }); 14 15 public boolean tryAcquire(String userId) { 16 try { 17 RateLimiter limiter = limiters.get(userId); 18 return limiter.tryAcquire(); 19 } catch (ExecutionException e) { 20 return false; 21 } 22 } 23} 3. XSS é˜²æŠ¤\n1private String sanitizeContent(String content) { 2 // è¿‡æ»¤ HTML æ ‡ç­¾å’Œè„šæœ¬ 3 return content.replaceAll(\"\u003c[^\u003e]*\u003e\", \"\") 4 .replaceAll(\"javascript:\", \"\") 5 .replaceAll(\"on\\\\w+\\\\s*=\", \"\"); 6} é¿å‘æç¤ºï¼š ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå®‰å…¨æ€§è‡³å…³é‡è¦ã€‚é™¤äº†ä¸Šè¿°æªæ–½ï¼Œè¿˜éœ€è¦ï¼š1) ä½¿ç”¨ WSSï¼ˆWebSocket over TLSï¼‰åŠ å¯†ä¼ è¾“ï¼›2) è®¾ç½®åˆç†çš„æ¶ˆæ¯å¤§å°é™åˆ¶ï¼›3) å®æ–½ IP é»‘ç™½åå•ï¼›4) è®°å½•å®¡è®¡æ—¥å¿—ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–äº†ä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜çš„å®Œæ•´å†…å®¹ï¼š\nåè®®åŸç†ï¼šç†è§£ WebSocket æ¡æ‰‹æµç¨‹å’Œæ•°æ®å¸§æ ¼å¼ æœåŠ¡å™¨å®ç°ï¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨ è¿æ¥ç®¡ç†ï¼šå®ç° Channel ç®¡ç†å’Œæ¶ˆæ¯æ¨é€ å¿ƒè·³æœºåˆ¶ï¼šä¿è¯è¿æ¥å¯é æ€§å’ŒåŠæ—¶æ£€æµ‹æ–­çº¿ é›†ç¾¤éƒ¨ç½²ï¼šé€šè¿‡ Redis å®ç°è·¨èŠ‚ç‚¹æ¶ˆæ¯è·¯ç”± æ€§èƒ½ä¼˜åŒ–ï¼šçº¿ç¨‹æ± ã€å†…å­˜ã€è¿æ¥æ•°ç­‰å¤šæ–¹é¢ä¼˜åŒ– å®‰å…¨åŠ å›ºï¼šè®¤è¯é‰´æƒã€é™æµã€XSS é˜²æŠ¤ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯è¿›è¡Œè°ƒæ•´ã€‚ä¾‹å¦‚ï¼š\nå³æ—¶é€šè®¯ï¼šéœ€è¦è€ƒè™‘æ¶ˆæ¯å¯é æ€§ã€ç¦»çº¿æ¶ˆæ¯ã€æ¶ˆæ¯é¡ºåº åœ¨çº¿å®¢æœï¼šéœ€è¦è€ƒè™‘ä¼šè¯ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±ã€å®¢æœåˆ†é… å®æ—¶ç›‘æ§ï¼šéœ€è¦è€ƒè™‘æ•°æ®èšåˆã€å‘Šè­¦æ¨é€ã€å¤§å±å±•ç¤º ä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°å®æ—¶æ¶ˆæ¯æ¨é€åŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯• Netty + WebSocket è¿™ä¸ªå¼ºå¤§çš„ç»„åˆã€‚\n",
  "wordCount" : "2175",
  "inLanguage": "en",
  "datePublished": "2025-04-18T00:00:00Z",
  "dateModified": "2025-04-18T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "wawayu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/2025/04/netty--websocket-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "åšå®¢å–µ",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="åšå®¢å–µ (Alt + H)">åšå®¢å–µ</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="ğŸ“ æ–‡ç« ">
                    <span>ğŸ“ æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="ğŸ·ï¸ æ ‡ç­¾">
                    <span>ğŸ·ï¸ æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="ğŸ“‚ åˆ†ç±»">
                    <span>ğŸ“‚ åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/skills/" title="ğŸ’» æŠ€èƒ½">
                    <span>ğŸ’» æŠ€èƒ½</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="ğŸ‘¤ å…³äº">
                    <span>ğŸ‘¤ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ” æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜
    </h1>
    <div class="post-description">
      æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–åè®®å‡çº§ã€å¿ƒè·³æœºåˆ¶ã€é›†ç¾¤éƒ¨ç½²ç­‰ç”Ÿäº§çº§å®è·µ
    </div>
    <div class="post-meta"><span title='2025-04-18 00:00:00 +0000 UTC'>April 18, 2025</span>&nbsp;Â·&nbsp;<span>11 min</span>&nbsp;Â·&nbsp;<span>2175 words</span>&nbsp;Â·&nbsp;<span>wawayu</span>&nbsp;|&nbsp;<span>
    <a href="https://github.com/wawayu-dev/wawayu-dev.github.io/tree/main/content/posts/netty-websocket-realtime-push.md" rel="noopener noreferrer edit" target="_blank">å»ºè®®ä¿®æ”¹</a>
</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#æœ¬æ–‡äº®ç‚¹">æœ¬æ–‡äº®ç‚¹</a></li>
      </ul>
    </li>
    <li><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©-netty--websocket">ä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket</a>
      <ul>
        <li><a href="#websocket-åè®®ä¼˜åŠ¿">WebSocket åè®®ä¼˜åŠ¿</a></li>
        <li><a href="#netty-æ¡†æ¶ä¼˜åŠ¿">Netty æ¡†æ¶ä¼˜åŠ¿</a></li>
      </ul>
    </li>
    <li><a href="#websocket-åè®®åŸç†">WebSocket åè®®åŸç†</a>
      <ul>
        <li><a href="#æ¡æ‰‹æµç¨‹">æ¡æ‰‹æµç¨‹</a></li>
        <li><a href="#æ•°æ®å¸§æ ¼å¼">æ•°æ®å¸§æ ¼å¼</a></li>
      </ul>
    </li>
    <li><a href="#netty-websocket-æœåŠ¡å™¨å®ç°">Netty WebSocket æœåŠ¡å™¨å®ç°</a>
      <ul>
        <li><a href="#é¡¹ç›®ä¾èµ–">é¡¹ç›®ä¾èµ–</a></li>
        <li><a href="#æœåŠ¡å™¨å¯åŠ¨ç±»">æœåŠ¡å™¨å¯åŠ¨ç±»</a></li>
        <li><a href="#channel-åˆå§‹åŒ–å™¨">Channel åˆå§‹åŒ–å™¨</a></li>
        <li><a href="#ä¸šåŠ¡å¤„ç†å™¨">ä¸šåŠ¡å¤„ç†å™¨</a></li>
      </ul>
    </li>
    <li><a href="#è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯æ¨é€">è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯æ¨é€</a>
      <ul>
        <li><a href="#channel-ç®¡ç†å™¨">Channel ç®¡ç†å™¨</a></li>
        <li><a href="#æ¶ˆæ¯æ¨é€æœåŠ¡">æ¶ˆæ¯æ¨é€æœåŠ¡</a></li>
      </ul>
    </li>
    <li><a href="#å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ä¿æ´»">å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ä¿æ´»</a>
      <ul>
        <li><a href="#ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³">ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³</a></li>
        <li><a href="#å¿ƒè·³å®ç°æ–¹æ¡ˆ">å¿ƒè·³å®ç°æ–¹æ¡ˆ</a></li>
      </ul>
    </li>
    <li><a href="#é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±">é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±</a>
      <ul>
        <li><a href="#å•æœºæ¶æ„çš„å±€é™">å•æœºæ¶æ„çš„å±€é™</a></li>
        <li><a href="#é›†ç¾¤æ¶æ„æ–¹æ¡ˆ">é›†ç¾¤æ¶æ„æ–¹æ¡ˆ</a></li>
        <li><a href="#nginx-é…ç½®">Nginx é…ç½®</a></li>
        <li><a href="#redis-æ¶ˆæ¯è·¯ç”±">Redis æ¶ˆæ¯è·¯ç”±</a></li>
        <li><a href="#æ”¹è¿›çš„æ¨é€æœåŠ¡">æ”¹è¿›çš„æ¨é€æœåŠ¡</a></li>
      </ul>
    </li>
    <li><a href="#ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–">ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–</a>
      <ul>
        <li><a href="#æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ–</a></li>
        <li><a href="#ç›‘æ§æŒ‡æ ‡">ç›‘æ§æŒ‡æ ‡</a></li>
        <li><a href="#å®‰å…¨åŠ å›º">å®‰å…¨åŠ å›º</a></li>
      </ul>
    </li>
    <li><a href="#æ€»ç»“ä¸æ€è€ƒ">æ€»ç»“ä¸æ€è€ƒ</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>åœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå®æ—¶æ¶ˆæ¯æ¨é€å·²æˆä¸ºæ ‡é…åŠŸèƒ½ã€‚ä»å³æ—¶é€šè®¯ã€åœ¨çº¿å®¢æœåˆ°å®æ—¶ç›‘æ§å¤§å±ï¼Œéƒ½ç¦»ä¸å¼€é«˜æ€§èƒ½çš„æ¶ˆæ¯æ¨é€èƒ½åŠ›ã€‚ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼å­˜åœ¨å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹ç­‰é—®é¢˜ï¼Œè€Œ WebSocket åè®®çš„å‡ºç°å®Œç¾è§£å†³äº†è¿™äº›ç—›ç‚¹ã€‚</p>
<p>æœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty æ¡†æ¶å®ç°åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜ï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¨é€æœåŠ¡ã€‚</p>
<h3 id="æœ¬æ–‡äº®ç‚¹">æœ¬æ–‡äº®ç‚¹<a hidden class="anchor" aria-hidden="true" href="#æœ¬æ–‡äº®ç‚¹">#</a></h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> æŒæ¡ WebSocket åè®®åŸç†ä¸æ¡æ‰‹æµç¨‹</li>
<li><input checked="" disabled="" type="checkbox"> å­¦ä¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨</li>
<li><input checked="" disabled="" type="checkbox"> ç†è§£å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ç®¡ç†ç­–ç•¥</li>
<li><input checked="" disabled="" type="checkbox"> æŒæ¡é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±æ–¹æ¡ˆ</li>
<li><input checked="" disabled="" type="checkbox"> äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§</li>
</ul>
<hr>
<h2 id="ä¸ºä»€ä¹ˆé€‰æ‹©-netty--websocket">ä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket<a hidden class="anchor" aria-hidden="true" href="#ä¸ºä»€ä¹ˆé€‰æ‹©-netty--websocket">#</a></h2>
<h3 id="websocket-åè®®ä¼˜åŠ¿">WebSocket åè®®ä¼˜åŠ¿<a hidden class="anchor" aria-hidden="true" href="#websocket-åè®®ä¼˜åŠ¿">#</a></h3>
<p>ç›¸æ¯”ä¼ ç»Ÿçš„ HTTP è½®è¯¢ï¼ŒWebSocket å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<table>
  <thead>
      <tr>
          <th>ç‰¹æ€§</th>
          <th>HTTP è½®è¯¢</th>
          <th>WebSocket</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>é€šä¿¡æ–¹å¼</td>
          <td>åŠåŒå·¥</td>
          <td>å…¨åŒå·¥</td>
      </tr>
      <tr>
          <td>è¿æ¥å¼€é”€</td>
          <td>æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥</td>
          <td>ä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥</td>
      </tr>
      <tr>
          <td>å®æ—¶æ€§</td>
          <td>å–å†³äºè½®è¯¢é—´éš”ï¼ˆç§’çº§ï¼‰</td>
          <td>æ¯«ç§’çº§</td>
      </tr>
      <tr>
          <td>æœåŠ¡å™¨å‹åŠ›</td>
          <td>é«˜ï¼ˆé¢‘ç¹çš„ HTTP è¯·æ±‚ï¼‰</td>
          <td>ä½ï¼ˆé•¿è¿æ¥ï¼‰</td>
      </tr>
      <tr>
          <td>å¸¦å®½æ¶ˆè€—</td>
          <td>é«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰ HTTP å¤´ï¼‰</td>
          <td>ä½ï¼ˆåªä¼ è¾“æ•°æ®å¸§ï¼‰</td>
      </tr>
  </tbody>
</table>
<h3 id="netty-æ¡†æ¶ä¼˜åŠ¿">Netty æ¡†æ¶ä¼˜åŠ¿<a hidden class="anchor" aria-hidden="true" href="#netty-æ¡†æ¶ä¼˜åŠ¿">#</a></h3>
<p>Netty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li><strong>é«˜æ€§èƒ½</strong>ï¼šåŸºäº NIOï¼Œæ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥</li>
<li><strong>æ˜“ç”¨æ€§</strong>ï¼šæä¾›äº†ä¸°å¯Œçš„ç¼–è§£ç å™¨å’Œå¤„ç†å™¨</li>
<li><strong>ç¨³å®šæ€§</strong>ï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯</li>
<li><strong>æ‰©å±•æ€§</strong>ï¼šçµæ´»çš„ Pipeline æœºåˆ¶</li>
</ol>
<blockquote>
<p><strong>æ¶æ„æ€è€ƒï¼š</strong> é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œä¸ä»…è¦çœ‹æŠ€æœ¯æœ¬èº«çš„ä¼˜åŠ¿ï¼Œæ›´è¦è€ƒè™‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€è¿ç»´æˆæœ¬å’Œç¤¾åŒºç”Ÿæ€ã€‚Netty åœ¨ Java ç”Ÿæ€ä¸­å·²ç»æˆä¸ºäº‹å®æ ‡å‡†ï¼ŒDubboã€RocketMQã€Elasticsearch ç­‰çŸ¥åé¡¹ç›®éƒ½åœ¨ä½¿ç”¨ã€‚</p>
</blockquote>
<hr>
<h2 id="websocket-åè®®åŸç†">WebSocket åè®®åŸç†<a hidden class="anchor" aria-hidden="true" href="#websocket-åè®®åŸç†">#</a></h2>
<h3 id="æ¡æ‰‹æµç¨‹">æ¡æ‰‹æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#æ¡æ‰‹æµç¨‹">#</a></h3>
<p>WebSocket åŸºäº HTTP åè®®è¿›è¡Œæ¡æ‰‹ï¼Œç„¶åå‡çº§ä¸º WebSocket åè®®ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln"> 1</span><span class="cl">å®¢æˆ·ç«¯è¯·æ±‚ï¼š
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">GET /chat HTTP/1.1
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Host: server.example.com
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">Upgrade: websocket
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">Connection: Upgrade
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Sec-WebSocket-Version: 13
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">æœåŠ¡ç«¯å“åº”ï¼š
</span></span><span class="line"><span class="ln">10</span><span class="cl">HTTP/1.1 101 Switching Protocols
</span></span><span class="line"><span class="ln">11</span><span class="cl">Upgrade: websocket
</span></span><span class="line"><span class="ln">12</span><span class="cl">Connection: Upgrade
</span></span><span class="line"><span class="ln">13</span><span class="cl">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
</span></span></code></pre></div><h3 id="æ•°æ®å¸§æ ¼å¼">æ•°æ®å¸§æ ¼å¼<a hidden class="anchor" aria-hidden="true" href="#æ•°æ®å¸§æ ¼å¼">#</a></h3>
<p>WebSocket ä½¿ç”¨å¸§ï¼ˆFrameï¼‰æ¥ä¼ è¾“æ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>æ–‡æœ¬å¸§</strong>ï¼šä¼ è¾“ UTF-8 ç¼–ç çš„æ–‡æœ¬</li>
<li><strong>äºŒè¿›åˆ¶å¸§</strong>ï¼šä¼ è¾“äºŒè¿›åˆ¶æ•°æ®</li>
<li><strong>æ§åˆ¶å¸§</strong>ï¼šPingã€Pongã€Close</li>
</ul>
<hr>
<h2 id="netty-websocket-æœåŠ¡å™¨å®ç°">Netty WebSocket æœåŠ¡å™¨å®ç°<a hidden class="anchor" aria-hidden="true" href="#netty-websocket-æœåŠ¡å™¨å®ç°">#</a></h2>
<h3 id="é¡¹ç›®ä¾èµ–">é¡¹ç›®ä¾èµ–<a hidden class="anchor" aria-hidden="true" href="#é¡¹ç›®ä¾èµ–">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="c">&lt;!-- Netty --&gt;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="nt">&lt;groupId&gt;</span>io.netty<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>netty-all<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="nt">&lt;version&gt;</span>4.1.100.Final<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="c">&lt;!-- JSON å¤„ç† --&gt;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.alibaba.fastjson2<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>fastjson2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="nt">&lt;version&gt;</span>2.0.43<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h3 id="æœåŠ¡å™¨å¯åŠ¨ç±»">æœåŠ¡å™¨å¯åŠ¨ç±»<a hidden class="anchor" aria-hidden="true" href="#æœåŠ¡å™¨å¯åŠ¨ç±»">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSocketServer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">8888</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">EventLoopGroup</span><span class="w"> </span><span class="n">bossGroup</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">EventLoopGroup</span><span class="w"> </span><span class="n">workerGroup</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@PostConstruct</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">bossGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NioEventLoopGroup</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">workerGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NioEventLoopGroup</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="n">ServerBootstrap</span><span class="w"> </span><span class="n">bootstrap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServerBootstrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="n">bootstrap</span><span class="p">.</span><span class="na">group</span><span class="p">(</span><span class="n">bossGroup</span><span class="p">,</span><span class="w"> </span><span class="n">workerGroup</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">channel</span><span class="p">(</span><span class="n">NioServerSocketChannel</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">childHandler</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebSocketChannelInitializer</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="n">ChannelOption</span><span class="p">.</span><span class="na">SO_BACKLOG</span><span class="p">,</span><span class="w"> </span><span class="n">128</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">childOption</span><span class="p">(</span><span class="n">ChannelOption</span><span class="p">.</span><span class="na">SO_KEEPALIVE</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span><span class="n">ChannelFuture</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bootstrap</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="n">port</span><span class="p">).</span><span class="na">sync</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;WebSocket æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç«¯å£ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="c1">// ç­‰å¾…æœåŠ¡å™¨å…³é—­</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="n">future</span><span class="p">.</span><span class="na">channel</span><span class="p">().</span><span class="na">closeFuture</span><span class="p">().</span><span class="na">sync</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">            </span><span class="n">shutdown</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="nd">@PreDestroy</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bossGroup</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">            </span><span class="n">bossGroup</span><span class="p">.</span><span class="na">shutdownGracefully</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">workerGroup</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">            </span><span class="n">workerGroup</span><span class="p">.</span><span class="na">shutdownGracefully</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;WebSocket æœåŠ¡å™¨å·²å…³é—­&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="channel-åˆå§‹åŒ–å™¨">Channel åˆå§‹åŒ–å™¨<a hidden class="anchor" aria-hidden="true" href="#channel-åˆå§‹åŒ–å™¨">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSocketChannelInitializer</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initChannel</span><span class="p">(</span><span class="n">SocketChannel</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">ChannelPipeline</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">.</span><span class="na">pipeline</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="c1">// HTTP ç¼–è§£ç å™¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HttpServerCodec</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="c1">// HTTP èšåˆå™¨ï¼ˆå°†å¤šä¸ª HTTP æ¶ˆæ¯èšåˆæˆä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HttpObjectAggregator</span><span class="p">(</span><span class="n">65536</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="c1">// HTTP å‹ç¼©</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HttpContentCompressor</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="c1">// WebSocket åè®®å¤„ç†å™¨ï¼ˆå¤„ç†æ¡æ‰‹ã€Closeã€Pingã€Pongï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebSocketServerProtocolHandler</span><span class="p">(</span><span class="s">&#34;/ws&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="c1">// å¿ƒè·³æ£€æµ‹ï¼ˆè¯»ç©ºé—² 60 ç§’ï¼Œå†™ç©ºé—² 0 ç§’ï¼Œè¯»å†™ç©ºé—² 0 ç§’ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">IdleStateHandler</span><span class="p">(</span><span class="n">60</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="c1">// è‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†å™¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebSocketHandler</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="ä¸šåŠ¡å¤„ç†å™¨">ä¸šåŠ¡å¤„ç†å™¨<a hidden class="anchor" aria-hidden="true" href="#ä¸šåŠ¡å¤„ç†å™¨">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="nd">@ChannelHandler.Sharable</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSocketHandler</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">TextWebSocketFrame</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">channelActive</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">        </span><span class="c1">// è¿æ¥å»ºç«‹æ—¶</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">        </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å®¢æˆ·ç«¯è¿æ¥ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="na">id</span><span class="p">().</span><span class="na">asShortText</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">        </span><span class="c1">// å°† Channel åŠ å…¥ç®¡ç†å™¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">        </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">addChannel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">channelRead0</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">TextWebSocketFrame</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">        </span><span class="c1">// æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">text</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ”¶åˆ°æ¶ˆæ¯ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">        </span><span class="c1">// è§£ææ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">parseObject</span><span class="p">(</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">        </span><span class="c1">// å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;auth&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">                </span><span class="n">handleAuth</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;heartbeat&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">                </span><span class="n">handleHeartbeat</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;message&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">                </span><span class="n">handleMessage</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">            </span><span class="k">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;æœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getType</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">channelInactive</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">        </span><span class="c1">// è¿æ¥æ–­å¼€æ—¶</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">        </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å®¢æˆ·ç«¯æ–­å¼€ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="na">id</span><span class="p">().</span><span class="na">asShortText</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">        </span><span class="c1">// ä»ç®¡ç†å™¨ä¸­ç§»é™¤</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">        </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">removeChannel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">userEventTriggered</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">evt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">        </span><span class="c1">// å¤„ç†ç©ºé—²äº‹ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">evt</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">IdleStateEvent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">            </span><span class="n">IdleStateEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">IdleStateEvent</span><span class="p">)</span><span class="w"> </span><span class="n">evt</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">state</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IdleState</span><span class="p">.</span><span class="na">READER_IDLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;å®¢æˆ·ç«¯ {} è¯»ç©ºé—²ï¼Œå…³é—­è¿æ¥&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">().</span><span class="na">id</span><span class="p">().</span><span class="na">asShortText</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">                </span><span class="n">ctx</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">exceptionCaught</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">cause</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;è¿æ¥å¼‚å¸¸ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cause</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(),</span><span class="w"> </span><span class="n">cause</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="cm">     * å¤„ç†è®¤è¯æ¶ˆæ¯
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleAuth</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getUserId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">        </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">        </span><span class="c1">// ç»‘å®šç”¨æˆ· ID å’Œ Channel</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">        </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">bindUser</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">channel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">        </span><span class="c1">// å‘é€è®¤è¯æˆåŠŸæ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">type</span><span class="p">(</span><span class="s">&#34;auth_response&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">content</span><span class="p">(</span><span class="s">&#34;è®¤è¯æˆåŠŸ&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">writeAndFlush</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TextWebSocketFrame</span><span class="p">(</span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">response</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç”¨æˆ· {} è®¤è¯æˆåŠŸ&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="cm">     * å¤„ç†å¿ƒè·³æ¶ˆæ¯
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleHeartbeat</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">type</span><span class="p">(</span><span class="s">&#34;heartbeat_response&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">content</span><span class="p">(</span><span class="s">&#34;pong&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">writeAndFlush</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TextWebSocketFrame</span><span class="p">(</span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">response</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="cm">     * å¤„ç†ä¸šåŠ¡æ¶ˆæ¯
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleMessage</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">        </span><span class="c1">// æ ¹æ®ä¸šåŠ¡é€»è¾‘å¤„ç†æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getContent</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">        </span><span class="c1">// ç¤ºä¾‹ï¼šå¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">        </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">broadcast</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯æ¨é€">è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯æ¨é€<a hidden class="anchor" aria-hidden="true" href="#è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯æ¨é€">#</a></h2>
<h3 id="channel-ç®¡ç†å™¨">Channel ç®¡ç†å™¨<a hidden class="anchor" aria-hidden="true" href="#channel-ç®¡ç†å™¨">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ChannelManager</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// æ‰€æœ‰è¿æ¥çš„ Channel</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ChannelGroup</span><span class="w"> </span><span class="n">CHANNELS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultChannelGroup</span><span class="p">(</span><span class="n">GlobalEventExecutor</span><span class="p">.</span><span class="na">INSTANCE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="c1">// ç”¨æˆ· ID ä¸ Channel çš„æ˜ å°„</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Channel</span><span class="o">&gt;</span><span class="w"> </span><span class="n">USER_CHANNELS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="cm">     * æ·»åŠ  Channel
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addChannel</span><span class="p">(</span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">CHANNELS</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">CHANNELS</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="cm">     * ç§»é™¤ Channel
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeChannel</span><span class="p">(</span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">CHANNELS</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="c1">// ç§»é™¤ç”¨æˆ·ç»‘å®š</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="n">USER_CHANNELS</span><span class="p">.</span><span class="na">entrySet</span><span class="p">().</span><span class="na">removeIf</span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">CHANNELS</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="cm">     * ç»‘å®šç”¨æˆ·å’Œ Channel
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bindUser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="n">USER_CHANNELS</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">channel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç”¨æˆ· {} ç»‘å®šæˆåŠŸï¼Œå½“å‰åœ¨çº¿ç”¨æˆ·æ•°ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">USER_CHANNELS</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="cm">     * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pushToUser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USER_CHANNELS</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="na">isActive</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">            </span><span class="n">channel</span><span class="p">.</span><span class="na">writeAndFlush</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TextWebSocketFrame</span><span class="p">(</span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">message</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ¨é€æ¶ˆæ¯ç»™ç”¨æˆ· {}ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getContent</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;ç”¨æˆ· {} ä¸åœ¨çº¿æˆ–è¿æ¥å·²æ–­å¼€&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="cm">     * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ·
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">broadcast</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">        </span><span class="n">TextWebSocketFrame</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TextWebSocketFrame</span><span class="p">(</span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">message</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">        </span><span class="n">CHANNELS</span><span class="p">.</span><span class="na">writeAndFlush</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å¹¿æ’­æ¶ˆæ¯ç»™ {} ä¸ªç”¨æˆ·ï¼š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">CHANNELS</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getContent</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="cm">     * è·å–åœ¨çº¿ç”¨æˆ·æ•°
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getOnlineUserCount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">USER_CHANNELS</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="æ¶ˆæ¯æ¨é€æœåŠ¡">æ¶ˆæ¯æ¨é€æœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆæ¯æ¨é€æœåŠ¡">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MessagePushService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="cm">     * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pushToUser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">type</span><span class="p">(</span><span class="s">&#34;push&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">pushToUser</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="cm">     * æ¨é€æ¶ˆæ¯ç»™å¤šä¸ªç”¨æˆ·
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pushToUsers</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userIds</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">type</span><span class="p">(</span><span class="s">&#34;push&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="n">userIds</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">pushToUser</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="cm">     * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">broadcast</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">type</span><span class="p">(</span><span class="s">&#34;broadcast&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">broadcast</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ä¿æ´»">å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ä¿æ´»<a hidden class="anchor" aria-hidden="true" href="#å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ä¿æ´»">#</a></h2>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³">ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³<a hidden class="anchor" aria-hidden="true" href="#ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³">#</a></h3>
<p>åœ¨é•¿è¿æ¥åœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li><strong>ç½‘ç»œä¸­æ–­æ£€æµ‹</strong>ï¼šç½‘ç»œå¼‚å¸¸æ—¶ï¼ŒTCP è¿æ¥ä¸ä¼šç«‹å³æ–­å¼€</li>
<li><strong>NAT è¶…æ—¶</strong>ï¼šNAT è®¾å¤‡ä¼šæ¸…ç†é•¿æ—¶é—´æ— æ•°æ®ä¼ è¾“çš„è¿æ¥</li>
<li><strong>è´Ÿè½½å‡è¡¡è¶…æ—¶</strong>ï¼šè´Ÿè½½å‡è¡¡å™¨å¯èƒ½ä¼šå…³é—­ç©ºé—²è¿æ¥</li>
</ol>
<h3 id="å¿ƒè·³å®ç°æ–¹æ¡ˆ">å¿ƒè·³å®ç°æ–¹æ¡ˆ<a hidden class="anchor" aria-hidden="true" href="#å¿ƒè·³å®ç°æ–¹æ¡ˆ">#</a></h3>
<p><strong>æœåŠ¡ç«¯å¿ƒè·³æ£€æµ‹</strong>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// åœ¨ ChannelInitializer ä¸­æ·»åŠ </span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">IdleStateHandler</span><span class="p">(</span><span class="n">60</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><p><strong>å®¢æˆ·ç«¯å¿ƒè·³å‘é€</strong>ï¼ˆJavaScript ç¤ºä¾‹ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kr">class</span> <span class="nx">WebSocketClient</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl">    <span class="nx">constructor</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">ws</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">heartbeatTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">reconnectTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl">    
</span></span><span class="line"><span class="ln">  9</span><span class="cl">    <span class="nx">connect</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">        
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WebSocket è¿æ¥æˆåŠŸ&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">startHeartbeat</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">            
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">            <span class="c1">// å‘é€è®¤è¯æ¶ˆæ¯
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;auth&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">                <span class="nx">userId</span><span class="o">:</span> <span class="s1">&#39;user123&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">                <span class="nx">token</span><span class="o">:</span> <span class="s1">&#39;xxx&#39;</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">        
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">            <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;æ”¶åˆ°æ¶ˆæ¯ï¼š&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">            
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">            <span class="c1">// å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">                <span class="k">case</span> <span class="s1">&#39;auth_response&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;è®¤è¯æˆåŠŸ&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 32</span><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">                <span class="k">case</span> <span class="s1">&#39;push&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="nx">handlePush</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">                <span class="k">case</span> <span class="s1">&#39;heartbeat_response&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">                    <span class="c1">// æ”¶åˆ°å¿ƒè·³å“åº”
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 41</span><span class="cl">        
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WebSocket è¿æ¥å…³é—­&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">stopHeartbeat</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">reconnect</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">        
</span></span><span class="line"><span class="ln"> 48</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;WebSocket é”™è¯¯ï¼š&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 50</span><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">    <span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">    <span class="nx">startHeartbeat</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">heartbeatTimer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;heartbeat&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">                <span class="nx">timestamp</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">        <span class="p">},</span> <span class="mi">30000</span><span class="p">);</span> <span class="c1">// æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">    <span class="nx">stopHeartbeat</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">heartbeatTimer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">            <span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">heartbeatTimer</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">heartbeatTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">    <span class="nx">reconnect</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnectTimer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">        
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">reconnectTimer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;å°è¯•é‡æ–°è¿æ¥...&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">reconnectTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">        <span class="p">},</span> <span class="mi">5000</span><span class="p">);</span> <span class="c1">// 5 ç§’åé‡è¿
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">    <span class="nx">handlePush</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">        <span class="c1">// å¤„ç†æ¨é€æ¶ˆæ¯
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;æ”¶åˆ°æ¨é€ï¼š&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">    <span class="nx">close</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">stopHeartbeat</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">
</span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="c1">// ä½¿ç”¨ç¤ºä¾‹
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketClient</span><span class="p">(</span><span class="s1">&#39;ws://localhost:8888/ws&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
</span></span></code></pre></div><blockquote>
<p><strong>é¿å‘æç¤ºï¼š</strong> å¿ƒè·³é—´éš”çš„è®¾ç½®éœ€è¦æƒè¡¡ï¼šé—´éš”å¤ªçŸ­ä¼šå¢åŠ æœåŠ¡å™¨å‹åŠ›ï¼Œé—´éš”å¤ªé•¿å¯èƒ½æ— æ³•åŠæ—¶å‘ç°è¿æ¥æ–­å¼€ã€‚å»ºè®®å®¢æˆ·ç«¯å¿ƒè·³é—´éš”ä¸º 30 ç§’ï¼ŒæœåŠ¡ç«¯è¶…æ—¶æ—¶é—´ä¸º 60 ç§’ã€‚</p>
</blockquote>
<hr>
<h2 id="é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±">é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±<a hidden class="anchor" aria-hidden="true" href="#é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±">#</a></h2>
<h3 id="å•æœºæ¶æ„çš„å±€é™">å•æœºæ¶æ„çš„å±€é™<a hidden class="anchor" aria-hidden="true" href="#å•æœºæ¶æ„çš„å±€é™">#</a></h3>
<p>å•æœº WebSocket æœåŠ¡å™¨å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li><strong>è¿æ¥æ•°é™åˆ¶</strong>ï¼šå•æœºæœ€å¤šæ”¯æŒå‡ ä¸‡åˆ°åå‡ ä¸‡è¿æ¥</li>
<li><strong>å•ç‚¹æ•…éšœ</strong>ï¼šæœåŠ¡å™¨å®•æœºå¯¼è‡´æ‰€æœ‰è¿æ¥æ–­å¼€</li>
<li><strong>æ¶ˆæ¯è·¯ç”±</strong>ï¼šæ— æ³•æ¨é€æ¶ˆæ¯ç»™å…¶ä»–æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·</li>
</ol>
<h3 id="é›†ç¾¤æ¶æ„æ–¹æ¡ˆ">é›†ç¾¤æ¶æ„æ–¹æ¡ˆ<a hidden class="anchor" aria-hidden="true" href="#é›†ç¾¤æ¶æ„æ–¹æ¡ˆ">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln"> 1</span><span class="cl">                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">                    â”‚   Nginx     â”‚
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">                    â”‚ (è´Ÿè½½å‡è¡¡)   â”‚
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">                           â”‚
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">            â”‚              â”‚              â”‚
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">      â”‚ WS Serverâ”‚   â”‚ WS Serverâ”‚   â”‚ WS Serverâ”‚
</span></span><span class="line"><span class="ln">10</span><span class="cl">      â”‚   Node1  â”‚   â”‚   Node2  â”‚   â”‚   Node3  â”‚
</span></span><span class="line"><span class="ln">11</span><span class="cl">      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
</span></span><span class="line"><span class="ln">12</span><span class="cl">            â”‚              â”‚              â”‚
</span></span><span class="line"><span class="ln">13</span><span class="cl">            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class="line"><span class="ln">14</span><span class="cl">                           â”‚
</span></span><span class="line"><span class="ln">15</span><span class="cl">                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
</span></span><span class="line"><span class="ln">16</span><span class="cl">                    â”‚    Redis    â”‚
</span></span><span class="line"><span class="ln">17</span><span class="cl">                    â”‚ (æ¶ˆæ¯è·¯ç”±)   â”‚
</span></span><span class="line"><span class="ln">18</span><span class="cl">                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></div><h3 id="nginx-é…ç½®">Nginx é…ç½®<a hidden class="anchor" aria-hidden="true" href="#nginx-é…ç½®">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">upstream</span> <span class="s">websocket</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="c1"># IP Hash ç­–ç•¥ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·è¿æ¥åˆ°åŒä¸€å°æœåŠ¡å™¨
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kn">ip_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.101</span><span class="p">:</span><span class="mi">8888</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.102</span><span class="p">:</span><span class="mi">8888</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="kn">server</span> <span class="n">192.168.1.103</span><span class="p">:</span><span class="mi">8888</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="kn">server_name</span> <span class="s">ws.example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="kn">location</span> <span class="s">/ws</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://websocket</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Upgrade</span> <span class="nv">$http_upgrade</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&#34;upgrade&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="c1"># è¶…æ—¶è®¾ç½®
</span></span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="kn">proxy_connect_timeout</span> <span class="s">60s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="kn">proxy_send_timeout</span> <span class="s">60s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">        <span class="kn">proxy_read_timeout</span> <span class="s">60s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="redis-æ¶ˆæ¯è·¯ç”±">Redis æ¶ˆæ¯è·¯ç”±<a hidden class="anchor" aria-hidden="true" href="#redis-æ¶ˆæ¯è·¯ç”±">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RedisMessageRouter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">CHANNEL_PREFIX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;ws:message:&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nd">@PostConstruct</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="c1">// è®¢é˜… Redis é¢‘é“</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">getConnectionFactory</span><span class="p">().</span><span class="na">getConnection</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">subscribe</span><span class="p">((</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">pattern</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">                    </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getBody</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">                    </span><span class="n">handleMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">                </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="n">CHANNEL_PREFIX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;*&#34;</span><span class="p">).</span><span class="na">getBytes</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="cm">     * å‘å¸ƒæ¶ˆæ¯åˆ° Redis
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">publish</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CHANNEL_PREFIX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">message</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="cm">     * å¤„ç†ä» Redis æ¥æ”¶åˆ°çš„æ¶ˆæ¯
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">parseObject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getUserId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="c1">// å¦‚æœç”¨æˆ·åœ¨æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥æ¨é€</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">pushToUser</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="æ”¹è¿›çš„æ¨é€æœåŠ¡">æ”¹è¿›çš„æ¨é€æœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#æ”¹è¿›çš„æ¨é€æœåŠ¡">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ClusterMessagePushService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RedisMessageRouter</span><span class="w"> </span><span class="n">redisMessageRouter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cm">     * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pushToUser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">type</span><span class="p">(</span><span class="s">&#34;push&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="c1">// å…ˆå°è¯•æœ¬åœ°æ¨é€</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">getUserChannel</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="na">isActive</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">pushToUser</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">            </span><span class="c1">// ç”¨æˆ·ä¸åœ¨æœ¬èŠ‚ç‚¹ï¼Œé€šè¿‡ Redis è·¯ç”±</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">            </span><span class="n">redisMessageRouter</span><span class="p">.</span><span class="na">publish</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="cm">     * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">broadcast</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">type</span><span class="p">(</span><span class="s">&#34;broadcast&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="c1">// å‘å¸ƒåˆ° Redis å¹¿æ’­é¢‘é“</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&#34;ws:broadcast&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">message</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p><strong>æ¶æ„æ€è€ƒï¼š</strong> åœ¨é›†ç¾¤æ¶æ„ä¸­ï¼Œæ¶ˆæ¯è·¯ç”±æ˜¯æ ¸å¿ƒé—®é¢˜ã€‚é™¤äº† Redis Pub/Subï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ RocketMQã€Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—ã€‚é€‰æ‹©æ—¶éœ€è¦è€ƒè™‘ï¼š1) æ¶ˆæ¯å¯é æ€§è¦æ±‚ï¼›2) æ¶ˆæ¯é¡ºåºæ€§è¦æ±‚ï¼›3) ç³»ç»Ÿå¤æ‚åº¦ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜ä½†å¯é æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼ŒRedis Pub/Sub æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</p>
</blockquote>
<hr>
<h2 id="ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–">ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–">#</a></h2>
<h3 id="æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#æ€§èƒ½ä¼˜åŒ–">#</a></h3>
<p><strong>1. çº¿ç¨‹æ± é…ç½®</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// Boss çº¿ç¨‹ç»„ï¼šå¤„ç†è¿æ¥è¯·æ±‚</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">EventLoopGroup</span><span class="w"> </span><span class="n">bossGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NioEventLoopGroup</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1">// Worker çº¿ç¨‹ç»„ï¼šå¤„ç† I/O æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1">// é»˜è®¤çº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">EventLoopGroup</span><span class="w"> </span><span class="n">workerGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NioEventLoopGroup</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1">// ä¸šåŠ¡çº¿ç¨‹æ± ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="n">businessExecutor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">50</span><span class="p">,</span><span class="w"> </span><span class="n">60L</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">1000</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadFactoryBuilder</span><span class="p">().</span><span class="na">setNameFormat</span><span class="p">(</span><span class="s">&#34;business-%d&#34;</span><span class="p">).</span><span class="na">build</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">.</span><span class="na">CallerRunsPolicy</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><strong>2. å†…å­˜ä¼˜åŒ–</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// ä½¿ç”¨æ± åŒ–çš„ ByteBuf</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">bootstrap</span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="n">ChannelOption</span><span class="p">.</span><span class="na">ALLOCATOR</span><span class="p">,</span><span class="w"> </span><span class="n">PooledByteBufAllocator</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="n">bootstrap</span><span class="p">.</span><span class="na">childOption</span><span class="p">(</span><span class="n">ChannelOption</span><span class="p">.</span><span class="na">ALLOCATOR</span><span class="p">,</span><span class="w"> </span><span class="n">PooledByteBufAllocator</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1">// è®¾ç½®æ¥æ”¶ç¼“å†²åŒºå¤§å°</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="n">bootstrap</span><span class="p">.</span><span class="na">childOption</span><span class="p">(</span><span class="n">ChannelOption</span><span class="p">.</span><span class="na">RCVBUF_ALLOCATOR</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">AdaptiveRecvByteBufAllocator</span><span class="p">(</span><span class="n">64</span><span class="p">,</span><span class="w"> </span><span class="n">1024</span><span class="p">,</span><span class="w"> </span><span class="n">65536</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><p><strong>3. è¿æ¥æ•°ä¼˜åŒ–</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// å¢åŠ  TCP è¿æ¥é˜Ÿåˆ—é•¿åº¦</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">bootstrap</span><span class="p">.</span><span class="na">option</span><span class="p">(</span><span class="n">ChannelOption</span><span class="p">.</span><span class="na">SO_BACKLOG</span><span class="p">,</span><span class="w"> </span><span class="n">1024</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1">// å¯ç”¨ TCP_NODELAYï¼ˆç¦ç”¨ Nagle ç®—æ³•ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="n">bootstrap</span><span class="p">.</span><span class="na">childOption</span><span class="p">(</span><span class="n">ChannelOption</span><span class="p">.</span><span class="na">TCP_NODELAY</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="c1">// å¯ç”¨ SO_KEEPALIVE</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="n">bootstrap</span><span class="p">.</span><span class="na">childOption</span><span class="p">(</span><span class="n">ChannelOption</span><span class="p">.</span><span class="na">SO_KEEPALIVE</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h3 id="ç›‘æ§æŒ‡æ ‡">ç›‘æ§æŒ‡æ ‡<a hidden class="anchor" aria-hidden="true" href="#ç›‘æ§æŒ‡æ ‡">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSocketMetrics</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">totalConnections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">activeConnections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">totalMessages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="cm">     * è®°å½•è¿æ¥å»ºç«‹
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordConnect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">totalConnections</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">activeConnections</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="cm">     * è®°å½•è¿æ¥æ–­å¼€
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordDisconnect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="n">activeConnections</span><span class="p">.</span><span class="na">decrementAndGet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="cm">     * è®°å½•æ¶ˆæ¯å‘é€
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordMessage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="n">totalMessages</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="cm">     * è·å–ç›‘æ§æ•°æ®
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getMetrics</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;totalConnections&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">totalConnections</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;activeConnections&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">activeConnections</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;totalMessages&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">totalMessages</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;onlineUsers&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">getOnlineUserCount</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">metrics</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="å®‰å…¨åŠ å›º">å®‰å…¨åŠ å›º<a hidden class="anchor" aria-hidden="true" href="#å®‰å…¨åŠ å›º">#</a></h3>
<p><strong>1. è®¤è¯é‰´æƒ</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleAuth</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getToken</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// éªŒè¯ Token</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">validateToken</span><span class="p">(</span><span class="n">token</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">writeAndFlush</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TextWebSocketFrame</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">type</span><span class="p">(</span><span class="s">&#34;auth_response&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">401</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">content</span><span class="p">(</span><span class="s">&#34;è®¤è¯å¤±è´¥&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="c1">// è®¤è¯æˆåŠŸï¼Œç»‘å®šç”¨æˆ·</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUserIdFromToken</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="n">ChannelManager</span><span class="p">.</span><span class="na">bindUser</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>2. æ¶ˆæ¯é™æµ</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MessageRateLimiter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">RateLimiter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">limiters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CacheBuilder</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">maximumSize</span><span class="p">(</span><span class="n">10000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">expireAfterAccess</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">HOURS</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">RateLimiter</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">                </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="n">RateLimiter</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                    </span><span class="c1">// æ¯ç§’æœ€å¤š 10 æ¡æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">RateLimiter</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="na">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">tryAcquire</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">RateLimiter</span><span class="w"> </span><span class="n">limiter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">limiters</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">limiter</span><span class="p">.</span><span class="na">tryAcquire</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ExecutionException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>3. XSS é˜²æŠ¤</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">sanitizeContent</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    </span><span class="c1">// è¿‡æ»¤ HTML æ ‡ç­¾å’Œè„šæœ¬</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="p">.</span><span class="na">replaceAll</span><span class="p">(</span><span class="s">&#34;&lt;[^&gt;]*&gt;&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">                  </span><span class="p">.</span><span class="na">replaceAll</span><span class="p">(</span><span class="s">&#34;javascript:&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">                  </span><span class="p">.</span><span class="na">replaceAll</span><span class="p">(</span><span class="s">&#34;on\\w+\\s*=&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p><strong>é¿å‘æç¤ºï¼š</strong> ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå®‰å…¨æ€§è‡³å…³é‡è¦ã€‚é™¤äº†ä¸Šè¿°æªæ–½ï¼Œè¿˜éœ€è¦ï¼š1) ä½¿ç”¨ WSSï¼ˆWebSocket over TLSï¼‰åŠ å¯†ä¼ è¾“ï¼›2) è®¾ç½®åˆç†çš„æ¶ˆæ¯å¤§å°é™åˆ¶ï¼›3) å®æ–½ IP é»‘ç™½åå•ï¼›4) è®°å½•å®¡è®¡æ—¥å¿—ã€‚</p>
</blockquote>
<hr>
<h2 id="æ€»ç»“ä¸æ€è€ƒ">æ€»ç»“ä¸æ€è€ƒ<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“ä¸æ€è€ƒ">#</a></h2>
<p>æœ¬æ–‡æ·±å…¥è®²è§£äº†å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–äº†ä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜çš„å®Œæ•´å†…å®¹ï¼š</p>
<ul>
<li><strong>åè®®åŸç†</strong>ï¼šç†è§£ WebSocket æ¡æ‰‹æµç¨‹å’Œæ•°æ®å¸§æ ¼å¼</li>
<li><strong>æœåŠ¡å™¨å®ç°</strong>ï¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨</li>
<li><strong>è¿æ¥ç®¡ç†</strong>ï¼šå®ç° Channel ç®¡ç†å’Œæ¶ˆæ¯æ¨é€</li>
<li><strong>å¿ƒè·³æœºåˆ¶</strong>ï¼šä¿è¯è¿æ¥å¯é æ€§å’ŒåŠæ—¶æ£€æµ‹æ–­çº¿</li>
<li><strong>é›†ç¾¤éƒ¨ç½²</strong>ï¼šé€šè¿‡ Redis å®ç°è·¨èŠ‚ç‚¹æ¶ˆæ¯è·¯ç”±</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šçº¿ç¨‹æ± ã€å†…å­˜ã€è¿æ¥æ•°ç­‰å¤šæ–¹é¢ä¼˜åŒ–</li>
<li><strong>å®‰å…¨åŠ å›º</strong>ï¼šè®¤è¯é‰´æƒã€é™æµã€XSS é˜²æŠ¤</li>
</ul>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯è¿›è¡Œè°ƒæ•´ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li><strong>å³æ—¶é€šè®¯</strong>ï¼šéœ€è¦è€ƒè™‘æ¶ˆæ¯å¯é æ€§ã€ç¦»çº¿æ¶ˆæ¯ã€æ¶ˆæ¯é¡ºåº</li>
<li><strong>åœ¨çº¿å®¢æœ</strong>ï¼šéœ€è¦è€ƒè™‘ä¼šè¯ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±ã€å®¢æœåˆ†é…</li>
<li><strong>å®æ—¶ç›‘æ§</strong>ï¼šéœ€è¦è€ƒè™‘æ•°æ®èšåˆã€å‘Šè­¦æ¨é€ã€å¤§å±å±•ç¤º</li>
</ul>
<p>ä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°å®æ—¶æ¶ˆæ¯æ¨é€åŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯• Netty + WebSocket è¿™ä¸ªå¼ºå¤§çš„ç»„åˆã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/netty/">Netty</a></li>
      <li><a href="http://localhost:1313/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">åˆ†å¸ƒå¼ç³»ç»Ÿ</a></li>
      <li><a href="http://localhost:1313/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/">é«˜å¹¶å‘</a></li>
      <li><a href="http://localhost:1313/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">æœ€ä½³å®è·µ</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/2025/05/easyexcel-%E7%99%BE%E4%B8%87%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E7%9A%84%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/">
    <span class="title">Â« Prev</span>
    <br>
    <span>EasyExcel ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„å†…å­˜ä¼˜åŒ–å®æˆ˜</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/2025/03/redis-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E4%BB%8E%E7%A9%BF%E9%80%8F%E5%88%B0%E9%9B%AA%E5%B4%A9%E7%9A%84%E5%85%A8%E9%93%BE%E8%B7%AF%E9%98%B2%E6%8A%A4/">
    <span class="title">Next Â»</span>
    <br>
    <span>Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜ on x"
            href="https://x.com/intent/tweet/?text=Netty%20%2b%20WebSocket%20%e5%ae%9e%e7%8e%b0%e5%ae%9e%e6%97%b6%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81%ef%bc%9a%e4%bb%8e%e5%8e%9f%e7%90%86%e5%88%b0%e7%94%9f%e4%ba%a7%e5%ae%9e%e6%88%98&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f04%2fnetty--websocket-%25E5%25AE%259E%25E7%258E%25B0%25E5%25AE%259E%25E6%2597%25B6%25E6%25B6%2588%25E6%2581%25AF%25E6%258E%25A8%25E9%2580%2581%25E4%25BB%258E%25E5%258E%259F%25E7%2590%2586%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E5%25AE%259E%25E6%2588%2598%2f&amp;hashtags=Netty%2c%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%2c%e9%ab%98%e5%b9%b6%e5%8f%91%2c%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜ on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f04%2fnetty--websocket-%25E5%25AE%259E%25E7%258E%25B0%25E5%25AE%259E%25E6%2597%25B6%25E6%25B6%2588%25E6%2581%25AF%25E6%258E%25A8%25E9%2580%2581%25E4%25BB%258E%25E5%258E%259F%25E7%2590%2586%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E5%25AE%259E%25E6%2588%2598%2f&amp;title=Netty%20%2b%20WebSocket%20%e5%ae%9e%e7%8e%b0%e5%ae%9e%e6%97%b6%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81%ef%bc%9a%e4%bb%8e%e5%8e%9f%e7%90%86%e5%88%b0%e7%94%9f%e4%ba%a7%e5%ae%9e%e6%88%98&amp;summary=Netty%20%2b%20WebSocket%20%e5%ae%9e%e7%8e%b0%e5%ae%9e%e6%97%b6%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81%ef%bc%9a%e4%bb%8e%e5%8e%9f%e7%90%86%e5%88%b0%e7%94%9f%e4%ba%a7%e5%ae%9e%e6%88%98&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f04%2fnetty--websocket-%25E5%25AE%259E%25E7%258E%25B0%25E5%25AE%259E%25E6%2597%25B6%25E6%25B6%2588%25E6%2581%25AF%25E6%258E%25A8%25E9%2580%2581%25E4%25BB%258E%25E5%258E%259F%25E7%2590%2586%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E5%25AE%259E%25E6%2588%2598%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜ on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f04%2fnetty--websocket-%25E5%25AE%259E%25E7%258E%25B0%25E5%25AE%259E%25E6%2597%25B6%25E6%25B6%2588%25E6%2581%25AF%25E6%258E%25A8%25E9%2580%2581%25E4%25BB%258E%25E5%258E%259F%25E7%2590%2586%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E5%25AE%259E%25E6%2588%2598%2f&title=Netty%20%2b%20WebSocket%20%e5%ae%9e%e7%8e%b0%e5%ae%9e%e6%97%b6%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81%ef%bc%9a%e4%bb%8e%e5%8e%9f%e7%90%86%e5%88%b0%e7%94%9f%e4%ba%a7%e5%ae%9e%e6%88%98">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜ on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f04%2fnetty--websocket-%25E5%25AE%259E%25E7%258E%25B0%25E5%25AE%259E%25E6%2597%25B6%25E6%25B6%2588%25E6%2581%25AF%25E6%258E%25A8%25E9%2580%2581%25E4%25BB%258E%25E5%258E%259F%25E7%2590%2586%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E5%25AE%259E%25E6%2588%2598%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜ on whatsapp"
            href="https://api.whatsapp.com/send?text=Netty%20%2b%20WebSocket%20%e5%ae%9e%e7%8e%b0%e5%ae%9e%e6%97%b6%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81%ef%bc%9a%e4%bb%8e%e5%8e%9f%e7%90%86%e5%88%b0%e7%94%9f%e4%ba%a7%e5%ae%9e%e6%88%98%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f04%2fnetty--websocket-%25E5%25AE%259E%25E7%258E%25B0%25E5%25AE%259E%25E6%2597%25B6%25E6%25B6%2588%25E6%2581%25AF%25E6%258E%25A8%25E9%2580%2581%25E4%25BB%258E%25E5%258E%259F%25E7%2590%2586%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E5%25AE%259E%25E6%2588%2598%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜ on telegram"
            href="https://telegram.me/share/url?text=Netty%20%2b%20WebSocket%20%e5%ae%9e%e7%8e%b0%e5%ae%9e%e6%97%b6%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81%ef%bc%9a%e4%bb%8e%e5%8e%9f%e7%90%86%e5%88%b0%e7%94%9f%e4%ba%a7%e5%ae%9e%e6%88%98&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f04%2fnetty--websocket-%25E5%25AE%259E%25E7%258E%25B0%25E5%25AE%259E%25E6%2597%25B6%25E6%25B6%2588%25E6%2581%25AF%25E6%258E%25A8%25E9%2580%2581%25E4%25BB%258E%25E5%258E%259F%25E7%2590%2586%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E5%25AE%259E%25E6%2588%2598%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Netty &#43; WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜ on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Netty%20%2b%20WebSocket%20%e5%ae%9e%e7%8e%b0%e5%ae%9e%e6%97%b6%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81%ef%bc%9a%e4%bb%8e%e5%8e%9f%e7%90%86%e5%88%b0%e7%94%9f%e4%ba%a7%e5%ae%9e%e6%88%98&u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f04%2fnetty--websocket-%25E5%25AE%259E%25E7%258E%25B0%25E5%25AE%259E%25E6%2597%25B6%25E6%25B6%2588%25E6%2581%25AF%25E6%258E%25A8%25E9%2580%2581%25E4%25BB%258E%25E5%258E%259F%25E7%2590%2586%25E5%2588%25B0%25E7%2594%259F%25E4%25BA%25A7%25E5%25AE%259E%25E6%2588%2598%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">åšå®¢å–µ</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
