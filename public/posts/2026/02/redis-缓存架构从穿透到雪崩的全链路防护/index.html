<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤ | åšå®¢å–µ</title>
<meta name="keywords" content="Redis, ç¼“å­˜, é«˜å¹¶å‘, æœ€ä½³å®è·µ">
<meta name="description" content="æ·±å…¥ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é—®é¢˜ï¼Œæ„å»ºé«˜å¯ç”¨çš„Redisç¼“å­˜æ¶æ„">
<meta name="author" content="wawayu">
<link rel="canonical" href="http://localhost:1313/posts/2026/02/redis-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E4%BB%8E%E7%A9%BF%E9%80%8F%E5%88%B0%E9%9B%AA%E5%B4%A9%E7%9A%84%E5%85%A8%E9%93%BE%E8%B7%AF%E9%98%B2%E6%8A%A4/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.a29c24210eb31d9ce56f669c66a35c9c51b17376b7764e336a49af7dec914cf0.css" integrity="sha256-opwkIQ6zHZzlb2acZqNcnFGxc3a3dk4zakmvfeyRTPA=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/2026/02/redis-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E4%BB%8E%E7%A9%BF%E9%80%8F%E5%88%B0%E9%9B%AA%E5%B4%A9%E7%9A%84%E5%85%A8%E9%93%BE%E8%B7%AF%E9%98%B2%E6%8A%A4/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="http://localhost:1313/posts/2026/02/redis-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E4%BB%8E%E7%A9%BF%E9%80%8F%E5%88%B0%E9%9B%AA%E5%B4%A9%E7%9A%84%E5%85%A8%E9%93%BE%E8%B7%AF%E9%98%B2%E6%8A%A4/">
  <meta property="og:site_name" content="åšå®¢å–µ">
  <meta property="og:title" content="Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤">
  <meta property="og:description" content="æ·±å…¥ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é—®é¢˜ï¼Œæ„å»ºé«˜å¯ç”¨çš„Redisç¼“å­˜æ¶æ„">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2026-02-12T00:00:00+00:00">
    <meta property="article:modified_time" content="2026-02-12T00:00:00+00:00">
    <meta property="article:tag" content="Redis">
    <meta property="article:tag" content="ç¼“å­˜">
    <meta property="article:tag" content="é«˜å¹¶å‘">
    <meta property="article:tag" content="æœ€ä½³å®è·µ">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤">
<meta name="twitter:description" content="æ·±å…¥ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é—®é¢˜ï¼Œæ„å»ºé«˜å¯ç”¨çš„Redisç¼“å­˜æ¶æ„">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤",
      "item": "http://localhost:1313/posts/2026/02/redis-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E4%BB%8E%E7%A9%BF%E9%80%8F%E5%88%B0%E9%9B%AA%E5%B4%A9%E7%9A%84%E5%85%A8%E9%93%BE%E8%B7%AF%E9%98%B2%E6%8A%A4/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤",
  "name": "Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤",
  "description": "æ·±å…¥ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é—®é¢˜ï¼Œæ„å»ºé«˜å¯ç”¨çš„Redisç¼“å­˜æ¶æ„",
  "keywords": [
    "Redis", "ç¼“å­˜", "é«˜å¹¶å‘", "æœ€ä½³å®è·µ"
  ],
  "articleBody": "åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚ä½†ç¼“å­˜ä½¿ç”¨ä¸å½“ä¼šå¼•å‘ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æè¿™äº›é—®é¢˜çš„åŸç†ï¼Œå¹¶æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„æœ¬è´¨åŒºåˆ« æŒæ¡å¸ƒéš†è¿‡æ»¤å™¨ã€äº’æ–¥é”ç­‰é˜²æŠ¤æ‰‹æ®µ å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„ç¼“å­˜æ¶æ„ äº†è§£ç¼“å­˜é¢„çƒ­ã€é™çº§ç­‰æœ€ä½³å®è·µ ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜ é—®é¢˜å¯¹æ¯” é—®é¢˜ åŸå›  å½±å“ è§£å†³æ–¹æ¡ˆ ç¼“å­˜ç©¿é€ æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® å¤§é‡è¯·æ±‚æ‰“åˆ°DB å¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜ ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹keyè¿‡æœŸ ç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°DB äº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ ç¼“å­˜é›ªå´© å¤§é‡keyåŒæ—¶è¿‡æœŸ DBå‹åŠ›éª¤å¢ è¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜ ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® é—®é¢˜åœºæ™¯ 1// æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID 2for (int i = -1000000; i \u003c 0; i--) { 3 User user = getUser(i); // ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æŸ¥DB 4} æµç¨‹ï¼š\n1è¯·æ±‚ â†’ æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ æŸ¥æ•°æ®åº“ï¼ˆæœªå‘½ä¸­ï¼‰â†’ è¿”å›null æ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\nè§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨ åŸç†ï¼š ç”¨ä½æ•°ç»„åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚\n1@Configuration 2public class BloomFilterConfig { 3 4 @Bean 5 public BloomFilter\u003cLong\u003e userBloomFilter() { 6 // é¢„æœŸå…ƒç´ æ•°é‡ï¼š1000ä¸‡ï¼Œè¯¯åˆ¤ç‡ï¼š0.01% 7 BloomFilter\u003cLong\u003e bloomFilter = BloomFilter.create( 8 Funnels.longFunnel(), 9 10000000, 10 0.0001 11 ); 12 13 // åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ 14 List\u003cLong\u003e userIds = userMapper.selectAllIds(); 15 userIds.forEach(bloomFilter::put); 16 17 return bloomFilter; 18 } 19} 1@Service 2public class UserService { 3 4 @Autowired 5 private BloomFilter\u003cLong\u003e userBloomFilter; 6 7 @Autowired 8 private RedisTemplate\u003cString, User\u003e redisTemplate; 9 10 @Autowired 11 private UserMapper userMapper; 12 13 public User getUser(Long userId) { 14 // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ 15 if (!userBloomFilter.mightContain(userId)) { 16 return null; // ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å› 17 } 18 19 // 2. æŸ¥ç¼“å­˜ 20 String key = \"user:\" + userId; 21 User user = redisTemplate.opsForValue().get(key); 22 if (user != null) { 23 return user; 24 } 25 26 // 3. æŸ¥æ•°æ®åº“ 27 user = userMapper.selectById(userId); 28 if (user != null) { 29 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 30 } 31 32 return user; 33 } 34} ä¼˜ç‚¹ï¼š\nå†…å­˜å ç”¨å°ï¼ˆ1000ä¸‡æ•°æ®åªéœ€çº¦12MBï¼‰ æŸ¥è¯¢é€Ÿåº¦å¿«ï¼ˆO(k)ï¼Œkä¸ºå“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼‰ ç¼ºç‚¹ï¼š\nå­˜åœ¨è¯¯åˆ¤ï¼ˆå¯èƒ½åˆ¤æ–­å­˜åœ¨ä½†å®é™…ä¸å­˜åœ¨ï¼‰ æ— æ³•åˆ é™¤å…ƒç´  è§£å†³æ–¹æ¡ˆ2ï¼šç¼“å­˜ç©ºå€¼ 1public User getUser(Long userId) { 2 String key = \"user:\" + userId; 3 4 // 1. æŸ¥ç¼“å­˜ 5 User user = redisTemplate.opsForValue().get(key); 6 if (user != null) { 7 // ç©ºå¯¹è±¡æ ‡è®° 8 if (user.getId() == null) { 9 return null; 10 } 11 return user; 12 } 13 14 // 2. æŸ¥æ•°æ®åº“ 15 user = userMapper.selectById(userId); 16 17 // 3. ç¼“å­˜ç»“æœï¼ˆåŒ…æ‹¬nullï¼‰ 18 if (user == null) { 19 // ç¼“å­˜ç©ºå¯¹è±¡ï¼Œè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ 20 User emptyUser = new User(); 21 redisTemplate.opsForValue().set(key, emptyUser, 5, TimeUnit.MINUTES); 22 } else { 23 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 24 } 25 26 return user; 27} ä¼˜ç‚¹ï¼š\nå®ç°ç®€å• å¯ä»¥é˜²æ­¢åŒä¸€ä¸ªä¸å­˜åœ¨çš„keyåå¤æŸ¥è¯¢ ç¼ºç‚¹ï¼š\nå ç”¨ç¼“å­˜ç©ºé—´ å¯èƒ½ç¼“å­˜å¤§é‡æ— æ•ˆæ•°æ® è§£å†³æ–¹æ¡ˆ3ï¼šå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜ 1public User getUser(Long userId) { 2 // 1. å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­ 3 if (!userBloomFilter.mightContain(userId)) { 4 return null; 5 } 6 7 String key = \"user:\" + userId; 8 9 // 2. æŸ¥ç¼“å­˜ï¼ˆåŒ…æ‹¬ç©ºå€¼ï¼‰ 10 User user = redisTemplate.opsForValue().get(key); 11 if (user != null) { 12 return user.getId() == null ? null : user; 13 } 14 15 // 3. æŸ¥æ•°æ®åº“ 16 user = userMapper.selectById(userId); 17 18 // 4. ç¼“å­˜ç»“æœ 19 if (user == null) { 20 User emptyUser = new User(); 21 redisTemplate.opsForValue().set(key, emptyUser, 5, TimeUnit.MINUTES); 22 } else { 23 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 24 } 25 26 return user; 27} æ¶æ„æ€è€ƒï¼š å¸ƒéš†è¿‡æ»¤å™¨é€‚åˆè¿‡æ»¤å¤§éƒ¨åˆ†ä¸å­˜åœ¨çš„è¯·æ±‚ï¼Œç©ºå€¼ç¼“å­˜é€‚åˆå¤„ç†å°‘é‡ä¸å­˜åœ¨ä½†è¢«é¢‘ç¹æŸ¥è¯¢çš„keyã€‚ä¸¤è€…ç»“åˆä½¿ç”¨ï¼Œå¯ä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœã€‚\nç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyè¿‡æœŸ é—®é¢˜åœºæ™¯ 1çƒ­ç‚¹å•†å“è¯¦æƒ…é¡µï¼Œç¼“å­˜è¿‡æœŸç¬é—´ï¼Œ1000ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“ æµç¨‹ï¼š\n1æ—¶åˆ»Tï¼šç¼“å­˜è¿‡æœŸ 2æ—¶åˆ»T+1msï¼š1000ä¸ªè¯·æ±‚åŒæ—¶æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ åŒæ—¶æŸ¥æ•°æ®åº“ è§£å†³æ–¹æ¡ˆ1ï¼šäº’æ–¥é” 1public Product getProduct(Long productId) { 2 String key = \"product:\" + productId; 3 4 // 1. æŸ¥ç¼“å­˜ 5 Product product = redisTemplate.opsForValue().get(key); 6 if (product != null) { 7 return product; 8 } 9 10 // 2. è·å–äº’æ–¥é” 11 String lockKey = \"lock:product:\" + productId; 12 Boolean locked = redisTemplate.opsForValue() 13 .setIfAbsent(lockKey, \"1\", 10, TimeUnit.SECONDS); 14 15 if (locked) { 16 try { 17 // 3. åŒé‡æ£€æŸ¥ 18 product = redisTemplate.opsForValue().get(key); 19 if (product != null) { 20 return product; 21 } 22 23 // 4. æŸ¥æ•°æ®åº“ 24 product = productMapper.selectById(productId); 25 26 // 5. å†™å…¥ç¼“å­˜ 27 if (product != null) { 28 redisTemplate.opsForValue().set(key, product, 1, TimeUnit.HOURS); 29 } 30 31 return product; 32 } finally { 33 // 6. é‡Šæ”¾é” 34 redisTemplate.delete(lockKey); 35 } 36 } else { 37 // 7. æœªè·å–åˆ°é”ï¼Œç­‰å¾…åé‡è¯• 38 try { 39 Thread.sleep(50); 40 } catch (InterruptedException e) { 41 Thread.currentThread().interrupt(); 42 } 43 return getProduct(productId); // é€’å½’é‡è¯• 44 } 45} ä¼˜ç‚¹ï¼š\nä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®åº“ å®ç°ç®€å• ç¼ºç‚¹ï¼š\nå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾… å¯èƒ½å¯¼è‡´è¯·æ±‚å †ç§¯ è§£å†³æ–¹æ¡ˆ2ï¼šé€»è¾‘è¿‡æœŸ 1@Data 2public class CacheData\u003cT\u003e { 3 private T data; 4 private LocalDateTime expireTime; 5} 1public Product getProduct(Long productId) { 2 String key = \"product:\" + productId; 3 4 // 1. æŸ¥ç¼“å­˜ï¼ˆæ°¸ä¸è¿‡æœŸï¼‰ 5 CacheData\u003cProduct\u003e cacheData = redisTemplate.opsForValue().get(key); 6 7 if (cacheData == null) { 8 // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ 9 return loadAndCache(productId); 10 } 11 12 // 2. åˆ¤æ–­é€»è¾‘è¿‡æœŸ 13 if (cacheData.getExpireTime().isBefore(LocalDateTime.now())) { 14 // 3. å¼‚æ­¥æ›´æ–°ç¼“å­˜ 15 String lockKey = \"lock:product:\" + productId; 16 Boolean locked = redisTemplate.opsForValue() 17 .setIfAbsent(lockKey, \"1\", 10, TimeUnit.SECONDS); 18 19 if (locked) { 20 CompletableFuture.runAsync(() -\u003e { 21 try { 22 loadAndCache(productId); 23 } finally { 24 redisTemplate.delete(lockKey); 25 } 26 }); 27 } 28 } 29 30 // 4. è¿”å›æ—§æ•°æ® 31 return cacheData.getData(); 32} 33 34private Product loadAndCache(Long productId) { 35 Product product = productMapper.selectById(productId); 36 if (product != null) { 37 CacheData\u003cProduct\u003e cacheData = new CacheData\u003c\u003e(); 38 cacheData.setData(product); 39 cacheData.setExpireTime(LocalDateTime.now().plusHours(1)); 40 41 redisTemplate.opsForValue().set(\"product:\" + productId, cacheData); 42 } 43 return product; 44} ä¼˜ç‚¹ï¼š\nä¸ä¼šé˜»å¡è¯·æ±‚ å§‹ç»ˆè¿”å›æ•°æ®ï¼ˆå³ä½¿æ˜¯æ—§æ•°æ®ï¼‰ ç¼ºç‚¹ï¼š\nå¯èƒ½è¿”å›è¿‡æœŸæ•°æ® å®ç°å¤æ‚ è§£å†³æ–¹æ¡ˆ3ï¼šçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ 1public Product getProduct(Long productId) { 2 String key = \"product:\" + productId; 3 4 // çƒ­ç‚¹å•†å“æ°¸ä¸è¿‡æœŸ 5 Product product = redisTemplate.opsForValue().get(key); 6 if (product != null) { 7 return product; 8 } 9 10 // æŸ¥æ•°æ®åº“å¹¶ç¼“å­˜ï¼ˆä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰ 11 product = productMapper.selectById(productId); 12 if (product != null) { 13 redisTemplate.opsForValue().set(key, product); 14 } 15 16 return product; 17} 18 19// é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ›´æ–°ç¼“å­˜ 20@RabbitListener(queues = \"product.update\") 21public void updateProductCache(Long productId) { 22 Product product = productMapper.selectById(productId); 23 redisTemplate.opsForValue().set(\"product:\" + productId, product); 24} ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸ é—®é¢˜åœºæ™¯ 1å‡Œæ™¨2ç‚¹ï¼Œç³»ç»Ÿé‡å¯ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶åŠ è½½ï¼Œè®¾ç½®1å°æ—¶è¿‡æœŸ 2å‡Œæ™¨3ç‚¹ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ è§£å†³æ–¹æ¡ˆ1ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ– 1public void setCache(String key, Object value, long baseExpireSeconds) { 2 // åœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¸Šå¢åŠ éšæœºå€¼ 3 long randomSeconds = ThreadLocalRandom.current().nextLong(0, 300); 4 long expireSeconds = baseExpireSeconds + randomSeconds; 5 6 redisTemplate.opsForValue().set(key, value, expireSeconds, TimeUnit.SECONDS); 7} 1// ä½¿ç”¨ç¤ºä¾‹ 2setCache(\"user:1\", user, 3600); // 3600 ~ 3900ç§’ 3setCache(\"user:2\", user, 3600); // 3600 ~ 3900ç§’ è§£å†³æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜ 1è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â†’ Redis â†’ æ•°æ®åº“ 1@Configuration 2public class CacheConfig { 3 4 @Bean 5 public Cache\u003cString, Object\u003e localCache() { 6 return Caffeine.newBuilder() 7 .maximumSize(10000) 8 .expireAfterWrite(5, TimeUnit.MINUTES) 9 .build(); 10 } 11} 1@Service 2public class UserService { 3 4 @Autowired 5 private Cache\u003cString, Object\u003e localCache; 6 7 @Autowired 8 private RedisTemplate\u003cString, User\u003e redisTemplate; 9 10 @Autowired 11 private UserMapper userMapper; 12 13 public User getUser(Long userId) { 14 String key = \"user:\" + userId; 15 16 // 1. æŸ¥æœ¬åœ°ç¼“å­˜ 17 User user = (User) localCache.getIfPresent(key); 18 if (user != null) { 19 return user; 20 } 21 22 // 2. æŸ¥Redis 23 user = redisTemplate.opsForValue().get(key); 24 if (user != null) { 25 localCache.put(key, user); 26 return user; 27 } 28 29 // 3. æŸ¥æ•°æ®åº“ 30 user = userMapper.selectById(userId); 31 if (user != null) { 32 // å†™å…¥Rediså’Œæœ¬åœ°ç¼“å­˜ 33 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 34 localCache.put(key, user); 35 } 36 37 return user; 38 } 39} è§£å†³æ–¹æ¡ˆ3ï¼šç¼“å­˜é¢„çƒ­ 1@Component 2public class CacheWarmUp implements ApplicationRunner { 3 4 @Autowired 5 private RedisTemplate\u003cString, Object\u003e redisTemplate; 6 7 @Autowired 8 private ProductMapper productMapper; 9 10 @Override 11 public void run(ApplicationArguments args) { 12 log.info(\"å¼€å§‹ç¼“å­˜é¢„çƒ­...\"); 13 14 // åŠ è½½çƒ­ç‚¹å•†å“ 15 List\u003cProduct\u003e hotProducts = productMapper.selectHotProducts(100); 16 for (Product product : hotProducts) { 17 String key = \"product:\" + product.getId(); 18 long expireSeconds = 3600 + ThreadLocalRandom.current().nextLong(0, 300); 19 redisTemplate.opsForValue().set(key, product, expireSeconds, TimeUnit.SECONDS); 20 } 21 22 log.info(\"ç¼“å­˜é¢„çƒ­å®Œæˆï¼Œå…±åŠ è½½ {} ä¸ªå•†å“\", hotProducts.size()); 23 } 24} è§£å†³æ–¹æ¡ˆ4ï¼šé™æµé™çº§ 1@Service 2public class ProductService { 3 4 @Autowired 5 private RedisTemplate\u003cString, Product\u003e redisTemplate; 6 7 @Autowired 8 private ProductMapper productMapper; 9 10 /** 11 * ä½¿ç”¨ Sentinel é™æµ 12 */ 13 @SentinelResource( 14 value = \"getProduct\", 15 blockHandler = \"getProductBlockHandler\", 16 fallback = \"getProductFallback\" 17 ) 18 public Product getProduct(Long productId) { 19 String key = \"product:\" + productId; 20 21 // æŸ¥ç¼“å­˜ 22 Product product = redisTemplate.opsForValue().get(key); 23 if (product != null) { 24 return product; 25 } 26 27 // æŸ¥æ•°æ®åº“ 28 product = productMapper.selectById(productId); 29 if (product != null) { 30 redisTemplate.opsForValue().set(key, product, 1, TimeUnit.HOURS); 31 } 32 33 return product; 34 } 35 36 /** 37 * é™æµé™çº§å¤„ç† 38 */ 39 public Product getProductBlockHandler(Long productId, BlockException ex) { 40 log.warn(\"è§¦å‘é™æµ: productId={}\", productId); 41 // è¿”å›é»˜è®¤å•†å“æˆ–æç¤ºä¿¡æ¯ 42 return getDefaultProduct(); 43 } 44 45 /** 46 * å¼‚å¸¸é™çº§å¤„ç† 47 */ 48 public Product getProductFallback(Long productId, Throwable ex) { 49 log.error(\"æŸ¥è¯¢å¼‚å¸¸: productId={}\", productId, ex); 50 // è¿”å›é»˜è®¤å•†å“ 51 return getDefaultProduct(); 52 } 53} ç¼“å­˜æ›´æ–°ç­–ç•¥ ç­–ç•¥å¯¹æ¯” ç­–ç•¥ ä¸€è‡´æ€§ å®ç°å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ Cache Aside å¼±ä¸€è‡´æ€§ ç®€å• è¯»å¤šå†™å°‘ Read/Write Through å¼ºä¸€è‡´æ€§ å¤æ‚ è¯»å†™å‡è¡¡ Write Behind æœ€ç»ˆä¸€è‡´æ€§ å¤æ‚ å†™å¤šè¯»å°‘ Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰ 1// è¯»æ“ä½œ 2public User getUser(Long userId) { 3 String key = \"user:\" + userId; 4 5 // 1. æŸ¥ç¼“å­˜ 6 User user = redisTemplate.opsForValue().get(key); 7 if (user != null) { 8 return user; 9 } 10 11 // 2. æŸ¥æ•°æ®åº“ 12 user = userMapper.selectById(userId); 13 14 // 3. å†™å…¥ç¼“å­˜ 15 if (user != null) { 16 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 17 } 18 19 return user; 20} 21 22// å†™æ“ä½œ 23public void updateUser(User user) { 24 // 1. æ›´æ–°æ•°æ®åº“ 25 userMapper.updateById(user); 26 27 // 2. åˆ é™¤ç¼“å­˜ 28 String key = \"user:\" + user.getId(); 29 redisTemplate.delete(key); 30} ä¸ºä»€ä¹ˆæ˜¯åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ\næ›´æ–°ç¼“å­˜å¯èƒ½æµªè´¹ï¼ˆæ›´æ–°åå¯èƒ½æ²¡äººæŸ¥è¯¢ï¼‰ å¹¶å‘æ›´æ–°å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ å»¶è¿ŸåŒåˆ  1public void updateUser(User user) { 2 String key = \"user:\" + user.getId(); 3 4 // 1. åˆ é™¤ç¼“å­˜ 5 redisTemplate.delete(key); 6 7 // 2. æ›´æ–°æ•°æ®åº“ 8 userMapper.updateById(user); 9 10 // 3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜ 11 CompletableFuture.runAsync(() -\u003e { 12 try { 13 Thread.sleep(500); // å»¶è¿Ÿ500ms 14 redisTemplate.delete(key); 15 } catch (InterruptedException e) { 16 Thread.currentThread().interrupt(); 17 } 18 }); 19} ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿ŸåŒåˆ ï¼Ÿ\né˜²æ­¢ä»¥ä¸‹åœºæ™¯çš„æ•°æ®ä¸ä¸€è‡´ï¼š\n1æ—¶åˆ»1ï¼šçº¿ç¨‹Aåˆ é™¤ç¼“å­˜ 2æ—¶åˆ»2ï¼šçº¿ç¨‹BæŸ¥è¯¢ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰ 3æ—¶åˆ»3ï¼šçº¿ç¨‹BæŸ¥è¯¢æ•°æ®åº“ï¼ˆæ—§æ•°æ®ï¼‰ 4æ—¶åˆ»4ï¼šçº¿ç¨‹Aæ›´æ–°æ•°æ®åº“ 5æ—¶åˆ»5ï¼šçº¿ç¨‹Bå†™å…¥ç¼“å­˜ï¼ˆæ—§æ•°æ®ï¼‰ å»¶è¿ŸåŒåˆ å¯ä»¥åˆ é™¤çº¿ç¨‹Bå†™å…¥çš„æ—§æ•°æ®ã€‚\nç¼“å­˜ç›‘æ§ å…³é”®æŒ‡æ ‡ 1@Component 2public class CacheMonitor { 3 4 @Autowired 5 private RedisTemplate\u003cString, Object\u003e redisTemplate; 6 7 @Scheduled(fixedDelay = 60000) 8 public void monitor() { 9 RedisConnection connection = redisTemplate.getConnectionFactory().getConnection(); 10 Properties info = connection.info(); 11 12 // 1. å†…å­˜ä½¿ç”¨ 13 long usedMemory = Long.parseLong(info.getProperty(\"used_memory\")); 14 long maxMemory = Long.parseLong(info.getProperty(\"maxmemory\")); 15 double memoryUsageRate = (double) usedMemory / maxMemory * 100; 16 17 // 2. å‘½ä¸­ç‡ 18 long hits = Long.parseLong(info.getProperty(\"keyspace_hits\")); 19 long misses = Long.parseLong(info.getProperty(\"keyspace_misses\")); 20 double hitRate = (double) hits / (hits + misses) * 100; 21 22 // 3. è¿æ¥æ•° 23 int connectedClients = Integer.parseInt(info.getProperty(\"connected_clients\")); 24 25 log.info(\"Redisç›‘æ§ - å†…å­˜ä½¿ç”¨ç‡: {}%, å‘½ä¸­ç‡: {}%, è¿æ¥æ•°: {}\", 26 memoryUsageRate, hitRate, connectedClients); 27 28 // 4. å‘Šè­¦ 29 if (memoryUsageRate \u003e 80) { 30 log.warn(\"Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {}%\", memoryUsageRate); 31 } 32 if (hitRate \u003c 80) { 33 log.warn(\"Rediså‘½ä¸­ç‡è¿‡ä½: {}%\", hitRate); 34 } 35 } 36} æœ€ä½³å®è·µ 1. åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´\nçƒ­ç‚¹æ•°æ®ï¼š1-2å°æ—¶ æ™®é€šæ•°æ®ï¼š30åˆ†é’Ÿ-1å°æ—¶ å†·æ•°æ®ï¼š5-10åˆ†é’Ÿ 2. ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„\nStringï¼šç®€å•key-value Hashï¼šå¯¹è±¡å­˜å‚¨ Listï¼šåˆ—è¡¨ã€é˜Ÿåˆ— Setï¼šå»é‡ã€äº¤é›† ZSetï¼šæ’è¡Œæ¦œ 3. é¿å…å¤§key\nå•ä¸ªkeyä¸è¶…è¿‡10KB é›†åˆå…ƒç´ ä¸è¶…è¿‡5000ä¸ª ä½¿ç”¨SCANä»£æ›¿KEYS 4. è®¾ç½®å†…å­˜æ·˜æ±°ç­–ç•¥\n1# redis.conf 2maxmemory 2gb 3maxmemory-policy allkeys-lru 5. ç›‘æ§å‘Šè­¦\nå†…å­˜ä½¿ç”¨ç‡ \u003e 80% å‘½ä¸­ç‡ \u003c 80% æ…¢æŸ¥è¯¢ \u003e 10ms é¿å‘æç¤ºï¼š ç¼“å­˜ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¸è¦ä¸ºäº†ç¼“å­˜è€Œç¼“å­˜ã€‚åªæœ‰é«˜é¢‘è®¿é—®ã€å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®æ‰é€‚åˆç¼“å­˜ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜çš„æ•°æ®ï¼Œç›´æ¥æŸ¥æ•°æ®åº“å¯èƒ½æ›´åˆé€‚ã€‚\næ€»ç»“ä¸æ€è€ƒ Redis ç¼“å­˜æ¶æ„çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€ ä½¿ç”¨äº’æ–¥é”æˆ–é€»è¾‘è¿‡æœŸé˜²æ­¢ç¼“å­˜å‡»ç©¿ ä½¿ç”¨è¿‡æœŸæ—¶é—´éšæœºåŒ–å’Œå¤šçº§ç¼“å­˜é˜²æ­¢ç¼“å­˜é›ªå´© ä½¿ç”¨ Cache Aside æ¨¡å¼æ›´æ–°ç¼“å­˜ ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œå†…å­˜ä½¿ç”¨ç‡ ç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„åˆ©å™¨ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¤æ‚åº¦ã€‚åœ¨è®¾è®¡ç¼“å­˜æ¶æ„æ—¶è¦æƒè¡¡ï¼š\næ˜¯å¦çœŸçš„éœ€è¦ç¼“å­˜ï¼Ÿ ç¼“å­˜ä»€ä¹ˆæ•°æ®ï¼Ÿ å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ å¦‚ä½•åº”å¯¹ç¼“å­˜å¤±æ•ˆï¼Ÿ ä¸‹æ¬¡å½“ä½ çš„ç³»ç»Ÿé¢ä¸´é«˜å¹¶å‘æŒ‘æˆ˜æ—¶ï¼Œä¸å¦¨è¯•è¯•æœ¬æ–‡ä»‹ç»çš„ç¼“å­˜æ¶æ„æ–¹æ¡ˆï¼Œè®©ç³»ç»Ÿæ€§èƒ½æ›´ä¸Šä¸€å±‚æ¥¼ã€‚\n",
  "wordCount" : "1679",
  "inLanguage": "en",
  "datePublished": "2026-02-12T00:00:00Z",
  "dateModified": "2026-02-12T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "wawayu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/2026/02/redis-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E4%BB%8E%E7%A9%BF%E9%80%8F%E5%88%B0%E9%9B%AA%E5%B4%A9%E7%9A%84%E5%85%A8%E9%93%BE%E8%B7%AF%E9%98%B2%E6%8A%A4/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "åšå®¢å–µ",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="åšå®¢å–µ (Alt + H)">åšå®¢å–µ</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="ğŸ“ æ–‡ç« ">
                    <span>ğŸ“ æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="ğŸ·ï¸ æ ‡ç­¾">
                    <span>ğŸ·ï¸ æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="ğŸ“‚ åˆ†ç±»">
                    <span>ğŸ“‚ åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/skills/" title="ğŸ’» æŠ€èƒ½">
                    <span>ğŸ’» æŠ€èƒ½</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="ğŸ‘¤ å…³äº">
                    <span>ğŸ‘¤ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ” æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤
    </h1>
    <div class="post-description">
      æ·±å…¥ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é—®é¢˜ï¼Œæ„å»ºé«˜å¯ç”¨çš„Redisç¼“å­˜æ¶æ„
    </div>
    <div class="post-meta"><span title='2026-02-12 00:00:00 +0000 UTC'>February 12, 2026</span>&nbsp;Â·&nbsp;<span>8 min</span>&nbsp;Â·&nbsp;<span>1679 words</span>&nbsp;Â·&nbsp;<span>wawayu</span>&nbsp;|&nbsp;<span>
    <a href="https://github.com/wawayu-dev/wawayu-dev.github.io/tree/main/content/posts/redis-cache-architecture.md" rel="noopener noreferrer edit" target="_blank">å»ºè®®ä¿®æ”¹</a>
</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#æœ¬æ–‡äº®ç‚¹">æœ¬æ–‡äº®ç‚¹</a></li>
      </ul>
    </li>
    <li><a href="#ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜">ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜</a>
      <ul>
        <li><a href="#é—®é¢˜å¯¹æ¯”">é—®é¢˜å¯¹æ¯”</a></li>
      </ul>
    </li>
    <li><a href="#ç¼“å­˜ç©¿é€æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®">ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®</a>
      <ul>
        <li><a href="#é—®é¢˜åœºæ™¯">é—®é¢˜åœºæ™¯</a></li>
        <li><a href="#è§£å†³æ–¹æ¡ˆ1å¸ƒéš†è¿‡æ»¤å™¨">è§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨</a></li>
        <li><a href="#è§£å†³æ–¹æ¡ˆ2ç¼“å­˜ç©ºå€¼">è§£å†³æ–¹æ¡ˆ2ï¼šç¼“å­˜ç©ºå€¼</a></li>
        <li><a href="#è§£å†³æ–¹æ¡ˆ3å¸ƒéš†è¿‡æ»¤å™¨--ç©ºå€¼ç¼“å­˜">è§£å†³æ–¹æ¡ˆ3ï¼šå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜</a></li>
      </ul>
    </li>
    <li><a href="#ç¼“å­˜å‡»ç©¿çƒ­ç‚¹keyè¿‡æœŸ">ç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyè¿‡æœŸ</a>
      <ul>
        <li><a href="#é—®é¢˜åœºæ™¯-1">é—®é¢˜åœºæ™¯</a></li>
        <li><a href="#è§£å†³æ–¹æ¡ˆ1äº’æ–¥é”">è§£å†³æ–¹æ¡ˆ1ï¼šäº’æ–¥é”</a></li>
        <li><a href="#è§£å†³æ–¹æ¡ˆ2é€»è¾‘è¿‡æœŸ">è§£å†³æ–¹æ¡ˆ2ï¼šé€»è¾‘è¿‡æœŸ</a></li>
        <li><a href="#è§£å†³æ–¹æ¡ˆ3çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ">è§£å†³æ–¹æ¡ˆ3ï¼šçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ</a></li>
      </ul>
    </li>
    <li><a href="#ç¼“å­˜é›ªå´©å¤§é‡keyåŒæ—¶è¿‡æœŸ">ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸ</a>
      <ul>
        <li><a href="#é—®é¢˜åœºæ™¯-2">é—®é¢˜åœºæ™¯</a></li>
        <li><a href="#è§£å†³æ–¹æ¡ˆ1è¿‡æœŸæ—¶é—´éšæœºåŒ–">è§£å†³æ–¹æ¡ˆ1ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ–</a></li>
        <li><a href="#è§£å†³æ–¹æ¡ˆ2å¤šçº§ç¼“å­˜">è§£å†³æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜</a></li>
        <li><a href="#è§£å†³æ–¹æ¡ˆ3ç¼“å­˜é¢„çƒ­">è§£å†³æ–¹æ¡ˆ3ï¼šç¼“å­˜é¢„çƒ­</a></li>
        <li><a href="#è§£å†³æ–¹æ¡ˆ4é™æµé™çº§">è§£å†³æ–¹æ¡ˆ4ï¼šé™æµé™çº§</a></li>
      </ul>
    </li>
    <li><a href="#ç¼“å­˜æ›´æ–°ç­–ç•¥">ç¼“å­˜æ›´æ–°ç­–ç•¥</a>
      <ul>
        <li><a href="#ç­–ç•¥å¯¹æ¯”">ç­–ç•¥å¯¹æ¯”</a></li>
        <li><a href="#cache-asideæ—è·¯ç¼“å­˜">Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰</a></li>
        <li><a href="#å»¶è¿ŸåŒåˆ ">å»¶è¿ŸåŒåˆ </a></li>
      </ul>
    </li>
    <li><a href="#ç¼“å­˜ç›‘æ§">ç¼“å­˜ç›‘æ§</a>
      <ul>
        <li><a href="#å…³é”®æŒ‡æ ‡">å…³é”®æŒ‡æ ‡</a></li>
      </ul>
    </li>
    <li><a href="#æœ€ä½³å®è·µ">æœ€ä½³å®è·µ</a></li>
    <li><a href="#æ€»ç»“ä¸æ€è€ƒ">æ€»ç»“ä¸æ€è€ƒ</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚ä½†ç¼“å­˜ä½¿ç”¨ä¸å½“ä¼šå¼•å‘ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æè¿™äº›é—®é¢˜çš„åŸç†ï¼Œå¹¶æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h3 id="æœ¬æ–‡äº®ç‚¹">æœ¬æ–‡äº®ç‚¹<a hidden class="anchor" aria-hidden="true" href="#æœ¬æ–‡äº®ç‚¹">#</a></h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„æœ¬è´¨åŒºåˆ«</li>
<li><input checked="" disabled="" type="checkbox"> æŒæ¡å¸ƒéš†è¿‡æ»¤å™¨ã€äº’æ–¥é”ç­‰é˜²æŠ¤æ‰‹æ®µ</li>
<li><input checked="" disabled="" type="checkbox"> å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„ç¼“å­˜æ¶æ„</li>
<li><input checked="" disabled="" type="checkbox"> äº†è§£ç¼“å­˜é¢„çƒ­ã€é™çº§ç­‰æœ€ä½³å®è·µ</li>
</ul>
<hr>
<h2 id="ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜">ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜">#</a></h2>
<h3 id="é—®é¢˜å¯¹æ¯”">é—®é¢˜å¯¹æ¯”<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜å¯¹æ¯”">#</a></h3>
<table>
  <thead>
      <tr>
          <th>é—®é¢˜</th>
          <th>åŸå› </th>
          <th>å½±å“</th>
          <th>è§£å†³æ–¹æ¡ˆ</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ç¼“å­˜ç©¿é€</td>
          <td>æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®</td>
          <td>å¤§é‡è¯·æ±‚æ‰“åˆ°DB</td>
          <td>å¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜</td>
      </tr>
      <tr>
          <td>ç¼“å­˜å‡»ç©¿</td>
          <td>çƒ­ç‚¹keyè¿‡æœŸ</td>
          <td>ç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°DB</td>
          <td>äº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ</td>
      </tr>
      <tr>
          <td>ç¼“å­˜é›ªå´©</td>
          <td>å¤§é‡keyåŒæ—¶è¿‡æœŸ</td>
          <td>DBå‹åŠ›éª¤å¢</td>
          <td>è¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="ç¼“å­˜ç©¿é€æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®">ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#ç¼“å­˜ç©¿é€æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®">#</a></h2>
<h3 id="é—®é¢˜åœºæ™¯">é—®é¢˜åœºæ™¯<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜åœºæ™¯">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">1000000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUser</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æŸ¥DB</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>æµç¨‹ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">è¯·æ±‚ â†’ æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ æŸ¥æ•°æ®åº“ï¼ˆæœªå‘½ä¸­ï¼‰â†’ è¿”å›null
</span></span></code></pre></div><p>æ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚</p>
<h3 id="è§£å†³æ–¹æ¡ˆ1å¸ƒéš†è¿‡æ»¤å™¨">è§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨<a hidden class="anchor" aria-hidden="true" href="#è§£å†³æ–¹æ¡ˆ1å¸ƒéš†è¿‡æ»¤å™¨">#</a></h3>
<p><strong>åŸç†ï¼š</strong> ç”¨ä½æ•°ç»„åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BloomFilterConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BloomFilter</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">userBloomFilter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="c1">// é¢„æœŸå…ƒç´ æ•°é‡ï¼š1000ä¸‡ï¼Œè¯¯åˆ¤ç‡ï¼š0.01%</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">BloomFilter</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bloomFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BloomFilter</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="n">Funnels</span><span class="p">.</span><span class="na">longFunnel</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="n">10000000</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">            </span><span class="n">0</span><span class="p">.</span><span class="na">0001</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="c1">// åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userMapper</span><span class="p">.</span><span class="na">selectAllIds</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">userIds</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">bloomFilter</span><span class="p">::</span><span class="n">put</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bloomFilter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BloomFilter</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userBloomFilter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UserMapper</span><span class="w"> </span><span class="n">userMapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">getUser</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="c1">// 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">userBloomFilter</span><span class="p">.</span><span class="na">mightContain</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="c1">// 2. æŸ¥ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;user:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="c1">// 3. æŸ¥æ•°æ®åº“</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userMapper</span><span class="p">.</span><span class="na">selectById</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">            </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">HOURS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>å†…å­˜å ç”¨å°ï¼ˆ1000ä¸‡æ•°æ®åªéœ€çº¦12MBï¼‰</li>
<li>æŸ¥è¯¢é€Ÿåº¦å¿«ï¼ˆO(k)ï¼Œkä¸ºå“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼‰</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>å­˜åœ¨è¯¯åˆ¤ï¼ˆå¯èƒ½åˆ¤æ–­å­˜åœ¨ä½†å®é™…ä¸å­˜åœ¨ï¼‰</li>
<li>æ— æ³•åˆ é™¤å…ƒç´ </li>
</ul>
<h3 id="è§£å†³æ–¹æ¡ˆ2ç¼“å­˜ç©ºå€¼">è§£å†³æ–¹æ¡ˆ2ï¼šç¼“å­˜ç©ºå€¼<a hidden class="anchor" aria-hidden="true" href="#è§£å†³æ–¹æ¡ˆ2ç¼“å­˜ç©ºå€¼">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">getUser</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;user:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// 1. æŸ¥ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="c1">// ç©ºå¯¹è±¡æ ‡è®°</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="c1">// 2. æŸ¥æ•°æ®åº“</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userMapper</span><span class="p">.</span><span class="na">selectById</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="c1">// 3. ç¼“å­˜ç»“æœï¼ˆåŒ…æ‹¬nullï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="c1">// ç¼“å­˜ç©ºå¯¹è±¡ï¼Œè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">emptyUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">emptyUser</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">HOURS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>å®ç°ç®€å•</li>
<li>å¯ä»¥é˜²æ­¢åŒä¸€ä¸ªä¸å­˜åœ¨çš„keyåå¤æŸ¥è¯¢</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>å ç”¨ç¼“å­˜ç©ºé—´</li>
<li>å¯èƒ½ç¼“å­˜å¤§é‡æ— æ•ˆæ•°æ®</li>
</ul>
<h3 id="è§£å†³æ–¹æ¡ˆ3å¸ƒéš†è¿‡æ»¤å™¨--ç©ºå€¼ç¼“å­˜">è§£å†³æ–¹æ¡ˆ3ï¼šå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#è§£å†³æ–¹æ¡ˆ3å¸ƒéš†è¿‡æ»¤å™¨--ç©ºå€¼ç¼“å­˜">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">getUser</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="c1">// 1. å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">userBloomFilter</span><span class="p">.</span><span class="na">mightContain</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;user:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="c1">// 2. æŸ¥ç¼“å­˜ï¼ˆåŒ…æ‹¬ç©ºå€¼ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="c1">// 3. æŸ¥æ•°æ®åº“</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userMapper</span><span class="p">.</span><span class="na">selectById</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="c1">// 4. ç¼“å­˜ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">emptyUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">emptyUser</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">HOURS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p><strong>æ¶æ„æ€è€ƒï¼š</strong> å¸ƒéš†è¿‡æ»¤å™¨é€‚åˆè¿‡æ»¤å¤§éƒ¨åˆ†ä¸å­˜åœ¨çš„è¯·æ±‚ï¼Œç©ºå€¼ç¼“å­˜é€‚åˆå¤„ç†å°‘é‡ä¸å­˜åœ¨ä½†è¢«é¢‘ç¹æŸ¥è¯¢çš„keyã€‚ä¸¤è€…ç»“åˆä½¿ç”¨ï¼Œå¯ä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœã€‚</p>
</blockquote>
<hr>
<h2 id="ç¼“å­˜å‡»ç©¿çƒ­ç‚¹keyè¿‡æœŸ">ç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyè¿‡æœŸ<a hidden class="anchor" aria-hidden="true" href="#ç¼“å­˜å‡»ç©¿çƒ­ç‚¹keyè¿‡æœŸ">#</a></h2>
<h3 id="é—®é¢˜åœºæ™¯-1">é—®é¢˜åœºæ™¯<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜åœºæ™¯-1">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">çƒ­ç‚¹å•†å“è¯¦æƒ…é¡µï¼Œç¼“å­˜è¿‡æœŸç¬é—´ï¼Œ1000ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“
</span></span></code></pre></div><p><strong>æµç¨‹ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">æ—¶åˆ»Tï¼šç¼“å­˜è¿‡æœŸ
</span></span><span class="line"><span class="ln">2</span><span class="cl">æ—¶åˆ»T+1msï¼š1000ä¸ªè¯·æ±‚åŒæ—¶æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ åŒæ—¶æŸ¥æ•°æ®åº“
</span></span></code></pre></div><h3 id="è§£å†³æ–¹æ¡ˆ1äº’æ–¥é”">è§£å†³æ–¹æ¡ˆ1ï¼šäº’æ–¥é”<a hidden class="anchor" aria-hidden="true" href="#è§£å†³æ–¹æ¡ˆ1äº’æ–¥é”">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="nf">getProduct</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">productId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;product:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">productId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// 1. æŸ¥ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">product</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="c1">// 2. è·å–äº’æ–¥é”</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">lockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;lock:product:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">productId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">Boolean</span><span class="w"> </span><span class="n">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setIfAbsent</span><span class="p">(</span><span class="n">lockKey</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">locked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="c1">// 3. åŒé‡æ£€æŸ¥</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">product</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="c1">// 4. æŸ¥æ•°æ®åº“</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productMapper</span><span class="p">.</span><span class="na">selectById</span><span class="p">(</span><span class="n">productId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="c1">// 5. å†™å…¥ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">                </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">HOURS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">product</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="c1">// 6. é‡Šæ”¾é”</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">            </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="c1">// 7. æœªè·å–åˆ°é”ï¼Œç­‰å¾…åé‡è¯•</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">50</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getProduct</span><span class="p">(</span><span class="n">productId</span><span class="p">);</span><span class="w">  </span><span class="c1">// é€’å½’é‡è¯•</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®åº“</li>
<li>å®ç°ç®€å•</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>å…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…</li>
<li>å¯èƒ½å¯¼è‡´è¯·æ±‚å †ç§¯</li>
</ul>
<h3 id="è§£å†³æ–¹æ¡ˆ2é€»è¾‘è¿‡æœŸ">è§£å†³æ–¹æ¡ˆ2ï¼šé€»è¾‘è¿‡æœŸ<a hidden class="anchor" aria-hidden="true" href="#è§£å†³æ–¹æ¡ˆ2é€»è¾‘è¿‡æœŸ">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CacheData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">expireTime</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="nf">getProduct</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">productId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;product:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">productId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// 1. æŸ¥ç¼“å­˜ï¼ˆæ°¸ä¸è¿‡æœŸï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">CacheData</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cacheData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cacheData</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="c1">// ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">loadAndCache</span><span class="p">(</span><span class="n">productId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="c1">// 2. åˆ¤æ–­é€»è¾‘è¿‡æœŸ</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cacheData</span><span class="p">.</span><span class="na">getExpireTime</span><span class="p">().</span><span class="na">isBefore</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="c1">// 3. å¼‚æ­¥æ›´æ–°ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">lockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;lock:product:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">productId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">setIfAbsent</span><span class="p">(</span><span class="n">lockKey</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">locked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">runAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">                    </span><span class="n">loadAndCache</span><span class="p">(</span><span class="n">productId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">                    </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="c1">// 4. è¿”å›æ—§æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cacheData</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="nf">loadAndCache</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">productId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productMapper</span><span class="p">.</span><span class="na">selectById</span><span class="p">(</span><span class="n">productId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="n">CacheData</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cacheData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CacheData</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="n">cacheData</span><span class="p">.</span><span class="na">setData</span><span class="p">(</span><span class="n">product</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="n">cacheData</span><span class="p">.</span><span class="na">setExpireTime</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">plusHours</span><span class="p">(</span><span class="n">1</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="s">&#34;product:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">productId</span><span class="p">,</span><span class="w"> </span><span class="n">cacheData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">product</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>ä¸ä¼šé˜»å¡è¯·æ±‚</li>
<li>å§‹ç»ˆè¿”å›æ•°æ®ï¼ˆå³ä½¿æ˜¯æ—§æ•°æ®ï¼‰</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>å¯èƒ½è¿”å›è¿‡æœŸæ•°æ®</li>
<li>å®ç°å¤æ‚</li>
</ul>
<h3 id="è§£å†³æ–¹æ¡ˆ3çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ">è§£å†³æ–¹æ¡ˆ3ï¼šçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ<a hidden class="anchor" aria-hidden="true" href="#è§£å†³æ–¹æ¡ˆ3çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="nf">getProduct</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">productId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;product:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">productId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// çƒ­ç‚¹å•†å“æ°¸ä¸è¿‡æœŸ</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">product</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="c1">// æŸ¥æ•°æ®åº“å¹¶ç¼“å­˜ï¼ˆä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productMapper</span><span class="p">.</span><span class="na">selectById</span><span class="p">(</span><span class="n">productId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">product</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1">// é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ›´æ–°ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;product.update&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateProductCache</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">productId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productMapper</span><span class="p">.</span><span class="na">selectById</span><span class="p">(</span><span class="n">productId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="s">&#34;product:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">productId</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="ç¼“å­˜é›ªå´©å¤§é‡keyåŒæ—¶è¿‡æœŸ">ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸ<a hidden class="anchor" aria-hidden="true" href="#ç¼“å­˜é›ªå´©å¤§é‡keyåŒæ—¶è¿‡æœŸ">#</a></h2>
<h3 id="é—®é¢˜åœºæ™¯-2">é—®é¢˜åœºæ™¯<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜åœºæ™¯-2">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">å‡Œæ™¨2ç‚¹ï¼Œç³»ç»Ÿé‡å¯ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶åŠ è½½ï¼Œè®¾ç½®1å°æ—¶è¿‡æœŸ
</span></span><span class="line"><span class="ln">2</span><span class="cl">å‡Œæ™¨3ç‚¹ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“
</span></span></code></pre></div><h3 id="è§£å†³æ–¹æ¡ˆ1è¿‡æœŸæ—¶é—´éšæœºåŒ–">è§£å†³æ–¹æ¡ˆ1ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ–<a hidden class="anchor" aria-hidden="true" href="#è§£å†³æ–¹æ¡ˆ1è¿‡æœŸæ—¶é—´éšæœºåŒ–">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setCache</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">baseExpireSeconds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    </span><span class="c1">// åœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¸Šå¢åŠ éšæœºå€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">randomSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ThreadLocalRandom</span><span class="p">.</span><span class="na">current</span><span class="p">().</span><span class="na">nextLong</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">300</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">expireSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseExpireSeconds</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">randomSeconds</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">expireSeconds</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// ä½¿ç”¨ç¤ºä¾‹</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">setCache</span><span class="p">(</span><span class="s">&#34;user:1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">3600</span><span class="p">);</span><span class="w">  </span><span class="c1">// 3600 ~ 3900ç§’</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="n">setCache</span><span class="p">(</span><span class="s">&#34;user:2&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">3600</span><span class="p">);</span><span class="w">  </span><span class="c1">// 3600 ~ 3900ç§’</span><span class="w">
</span></span></span></code></pre></div><h3 id="è§£å†³æ–¹æ¡ˆ2å¤šçº§ç¼“å­˜">è§£å†³æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#è§£å†³æ–¹æ¡ˆ2å¤šçº§ç¼“å­˜">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â†’ Redis â†’ æ•°æ®åº“
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CacheConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Cache</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">localCache</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Caffeine</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">maximumSize</span><span class="p">(</span><span class="n">10000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">expireAfterWrite</span><span class="p">(</span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Cache</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">localCache</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UserMapper</span><span class="w"> </span><span class="n">userMapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">getUser</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;user:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="c1">// 1. æŸ¥æœ¬åœ°ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="n">localCache</span><span class="p">.</span><span class="na">getIfPresent</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="c1">// 2. æŸ¥Redis</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="n">localCache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="c1">// 3. æŸ¥æ•°æ®åº“</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userMapper</span><span class="p">.</span><span class="na">selectById</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">            </span><span class="c1">// å†™å…¥Rediså’Œæœ¬åœ°ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">HOURS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">            </span><span class="n">localCache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="è§£å†³æ–¹æ¡ˆ3ç¼“å­˜é¢„çƒ­">è§£å†³æ–¹æ¡ˆ3ï¼šç¼“å­˜é¢„çƒ­<a hidden class="anchor" aria-hidden="true" href="#è§£å†³æ–¹æ¡ˆ3ç¼“å­˜é¢„çƒ­">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CacheWarmUp</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ApplicationRunner</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ProductMapper</span><span class="w"> </span><span class="n">productMapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">ApplicationArguments</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å¼€å§‹ç¼“å­˜é¢„çƒ­...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="c1">// åŠ è½½çƒ­ç‚¹å•†å“</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span><span class="w"> </span><span class="n">hotProducts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productMapper</span><span class="p">.</span><span class="na">selectHotProducts</span><span class="p">(</span><span class="n">100</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">hotProducts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;product:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">product</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">expireSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">3600</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ThreadLocalRandom</span><span class="p">.</span><span class="na">current</span><span class="p">().</span><span class="na">nextLong</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">300</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">            </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">,</span><span class="w"> </span><span class="n">expireSeconds</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç¼“å­˜é¢„çƒ­å®Œæˆï¼Œå…±åŠ è½½ {} ä¸ªå•†å“&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">hotProducts</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="è§£å†³æ–¹æ¡ˆ4é™æµé™çº§">è§£å†³æ–¹æ¡ˆ4ï¼šé™æµé™çº§<a hidden class="anchor" aria-hidden="true" href="#è§£å†³æ–¹æ¡ˆ4é™æµé™çº§">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ProductService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Product</span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ProductMapper</span><span class="w"> </span><span class="n">productMapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="cm">     * ä½¿ç”¨ Sentinel é™æµ
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="nd">@SentinelResource</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;getProduct&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">blockHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;getProductBlockHandler&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="n">fallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;getProductFallback&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="nf">getProduct</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">productId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;product:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">productId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="c1">// æŸ¥ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">product</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="c1">// æŸ¥æ•°æ®åº“</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productMapper</span><span class="p">.</span><span class="na">selectById</span><span class="p">(</span><span class="n">productId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">            </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">HOURS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">product</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="cm">     * é™æµé™çº§å¤„ç†
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="nf">getProductBlockHandler</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">productId</span><span class="p">,</span><span class="w"> </span><span class="n">BlockException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;è§¦å‘é™æµ: productId={}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">productId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="c1">// è¿”å›é»˜è®¤å•†å“æˆ–æç¤ºä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getDefaultProduct</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="cm">     * å¼‚å¸¸é™çº§å¤„ç†
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="nf">getProductFallback</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">productId</span><span class="p">,</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;æŸ¥è¯¢å¼‚å¸¸: productId={}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">productId</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">        </span><span class="c1">// è¿”å›é»˜è®¤å•†å“</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getDefaultProduct</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="ç¼“å­˜æ›´æ–°ç­–ç•¥">ç¼“å­˜æ›´æ–°ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#ç¼“å­˜æ›´æ–°ç­–ç•¥">#</a></h2>
<h3 id="ç­–ç•¥å¯¹æ¯”">ç­–ç•¥å¯¹æ¯”<a hidden class="anchor" aria-hidden="true" href="#ç­–ç•¥å¯¹æ¯”">#</a></h3>
<table>
  <thead>
      <tr>
          <th>ç­–ç•¥</th>
          <th>ä¸€è‡´æ€§</th>
          <th>å®ç°å¤æ‚åº¦</th>
          <th>é€‚ç”¨åœºæ™¯</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Cache Aside</td>
          <td>å¼±ä¸€è‡´æ€§</td>
          <td>ç®€å•</td>
          <td>è¯»å¤šå†™å°‘</td>
      </tr>
      <tr>
          <td>Read/Write Through</td>
          <td>å¼ºä¸€è‡´æ€§</td>
          <td>å¤æ‚</td>
          <td>è¯»å†™å‡è¡¡</td>
      </tr>
      <tr>
          <td>Write Behind</td>
          <td>æœ€ç»ˆä¸€è‡´æ€§</td>
          <td>å¤æ‚</td>
          <td>å†™å¤šè¯»å°‘</td>
      </tr>
  </tbody>
</table>
<h3 id="cache-asideæ—è·¯ç¼“å­˜">Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰<a hidden class="anchor" aria-hidden="true" href="#cache-asideæ—è·¯ç¼“å­˜">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// è¯»æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">getUser</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;user:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="c1">// 1. æŸ¥ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="c1">// 2. æŸ¥æ•°æ®åº“</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userMapper</span><span class="p">.</span><span class="na">selectById</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="c1">// 3. å†™å…¥ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">HOURS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="c1">// å†™æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateUser</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="c1">// 1. æ›´æ–°æ•°æ®åº“</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    </span><span class="n">userMapper</span><span class="p">.</span><span class="na">updateById</span><span class="p">(</span><span class="n">user</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="c1">// 2. åˆ é™¤ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;user:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>ä¸ºä»€ä¹ˆæ˜¯åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ</strong></p>
<ol>
<li>æ›´æ–°ç¼“å­˜å¯èƒ½æµªè´¹ï¼ˆæ›´æ–°åå¯èƒ½æ²¡äººæŸ¥è¯¢ï¼‰</li>
<li>å¹¶å‘æ›´æ–°å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´</li>
</ol>
<h3 id="å»¶è¿ŸåŒåˆ ">å»¶è¿ŸåŒåˆ <a hidden class="anchor" aria-hidden="true" href="#å»¶è¿ŸåŒåˆ ">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateUser</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;user:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// 1. åˆ é™¤ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="c1">// 2. æ›´æ–°æ•°æ®åº“</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="n">userMapper</span><span class="p">.</span><span class="na">updateById</span><span class="p">(</span><span class="n">user</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="c1">// 3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">runAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">500</span><span class="p">);</span><span class="w">  </span><span class="c1">// å»¶è¿Ÿ500ms</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">            </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿ŸåŒåˆ ï¼Ÿ</strong></p>
<p>é˜²æ­¢ä»¥ä¸‹åœºæ™¯çš„æ•°æ®ä¸ä¸€è‡´ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">æ—¶åˆ»1ï¼šçº¿ç¨‹Aåˆ é™¤ç¼“å­˜
</span></span><span class="line"><span class="ln">2</span><span class="cl">æ—¶åˆ»2ï¼šçº¿ç¨‹BæŸ¥è¯¢ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰
</span></span><span class="line"><span class="ln">3</span><span class="cl">æ—¶åˆ»3ï¼šçº¿ç¨‹BæŸ¥è¯¢æ•°æ®åº“ï¼ˆæ—§æ•°æ®ï¼‰
</span></span><span class="line"><span class="ln">4</span><span class="cl">æ—¶åˆ»4ï¼šçº¿ç¨‹Aæ›´æ–°æ•°æ®åº“
</span></span><span class="line"><span class="ln">5</span><span class="cl">æ—¶åˆ»5ï¼šçº¿ç¨‹Bå†™å…¥ç¼“å­˜ï¼ˆæ—§æ•°æ®ï¼‰
</span></span></code></pre></div><p>å»¶è¿ŸåŒåˆ å¯ä»¥åˆ é™¤çº¿ç¨‹Bå†™å…¥çš„æ—§æ•°æ®ã€‚</p>
<hr>
<h2 id="ç¼“å­˜ç›‘æ§">ç¼“å­˜ç›‘æ§<a hidden class="anchor" aria-hidden="true" href="#ç¼“å­˜ç›‘æ§">#</a></h2>
<h3 id="å…³é”®æŒ‡æ ‡">å…³é”®æŒ‡æ ‡<a hidden class="anchor" aria-hidden="true" href="#å…³é”®æŒ‡æ ‡">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CacheMonitor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">fixedDelay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">60000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">monitor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">RedisConnection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">getConnectionFactory</span><span class="p">().</span><span class="na">getConnection</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">Properties</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="na">info</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="c1">// 1. å†…å­˜ä½¿ç”¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">usedMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">parseLong</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;used_memory&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">maxMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">parseLong</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;maxmemory&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">memoryUsageRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">usedMemory</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">maxMemory</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="c1">// 2. å‘½ä¸­ç‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">hits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">parseLong</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;keyspace_hits&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">misses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">parseLong</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;keyspace_misses&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">hitRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">hits</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">hits</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">misses</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="c1">// 3. è¿æ¥æ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">connectedClients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;connected_clients&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Redisç›‘æ§ - å†…å­˜ä½¿ç”¨ç‡: {}%, å‘½ä¸­ç‡: {}%, è¿æ¥æ•°: {}&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="n">memoryUsageRate</span><span class="p">,</span><span class="w"> </span><span class="n">hitRate</span><span class="p">,</span><span class="w"> </span><span class="n">connectedClients</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="c1">// 4. å‘Šè­¦</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memoryUsageRate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {}%&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">memoryUsageRate</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hitRate</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;Rediså‘½ä¸­ç‡è¿‡ä½: {}%&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">hitRate</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="æœ€ä½³å®è·µ">æœ€ä½³å®è·µ<a hidden class="anchor" aria-hidden="true" href="#æœ€ä½³å®è·µ">#</a></h2>
<p><strong>1. åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´</strong></p>
<ul>
<li>çƒ­ç‚¹æ•°æ®ï¼š1-2å°æ—¶</li>
<li>æ™®é€šæ•°æ®ï¼š30åˆ†é’Ÿ-1å°æ—¶</li>
<li>å†·æ•°æ®ï¼š5-10åˆ†é’Ÿ</li>
</ul>
<p><strong>2. ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„</strong></p>
<ul>
<li>Stringï¼šç®€å•key-value</li>
<li>Hashï¼šå¯¹è±¡å­˜å‚¨</li>
<li>Listï¼šåˆ—è¡¨ã€é˜Ÿåˆ—</li>
<li>Setï¼šå»é‡ã€äº¤é›†</li>
<li>ZSetï¼šæ’è¡Œæ¦œ</li>
</ul>
<p><strong>3. é¿å…å¤§key</strong></p>
<ul>
<li>å•ä¸ªkeyä¸è¶…è¿‡10KB</li>
<li>é›†åˆå…ƒç´ ä¸è¶…è¿‡5000ä¸ª</li>
<li>ä½¿ç”¨SCANä»£æ›¿KEYS</li>
</ul>
<p><strong>4. è®¾ç½®å†…å­˜æ·˜æ±°ç­–ç•¥</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl"># redis.conf
</span></span><span class="line"><span class="ln">2</span><span class="cl">maxmemory 2gb
</span></span><span class="line"><span class="ln">3</span><span class="cl">maxmemory-policy allkeys-lru
</span></span></code></pre></div><p><strong>5. ç›‘æ§å‘Šè­¦</strong></p>
<ul>
<li>å†…å­˜ä½¿ç”¨ç‡ &gt; 80%</li>
<li>å‘½ä¸­ç‡ &lt; 80%</li>
<li>æ…¢æŸ¥è¯¢ &gt; 10ms</li>
</ul>
<blockquote>
<p><strong>é¿å‘æç¤ºï¼š</strong> ç¼“å­˜ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¸è¦ä¸ºäº†ç¼“å­˜è€Œç¼“å­˜ã€‚åªæœ‰é«˜é¢‘è®¿é—®ã€å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®æ‰é€‚åˆç¼“å­˜ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜çš„æ•°æ®ï¼Œç›´æ¥æŸ¥æ•°æ®åº“å¯èƒ½æ›´åˆé€‚ã€‚</p>
</blockquote>
<hr>
<h2 id="æ€»ç»“ä¸æ€è€ƒ">æ€»ç»“ä¸æ€è€ƒ<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“ä¸æ€è€ƒ">#</a></h2>
<p>Redis ç¼“å­˜æ¶æ„çš„æ ¸å¿ƒè¦ç‚¹ï¼š</p>
<ul>
<li>ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€</li>
<li>ä½¿ç”¨äº’æ–¥é”æˆ–é€»è¾‘è¿‡æœŸé˜²æ­¢ç¼“å­˜å‡»ç©¿</li>
<li>ä½¿ç”¨è¿‡æœŸæ—¶é—´éšæœºåŒ–å’Œå¤šçº§ç¼“å­˜é˜²æ­¢ç¼“å­˜é›ªå´©</li>
<li>ä½¿ç”¨ Cache Aside æ¨¡å¼æ›´æ–°ç¼“å­˜</li>
<li>ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œå†…å­˜ä½¿ç”¨ç‡</li>
</ul>
<p>ç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„åˆ©å™¨ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¤æ‚åº¦ã€‚åœ¨è®¾è®¡ç¼“å­˜æ¶æ„æ—¶è¦æƒè¡¡ï¼š</p>
<ul>
<li>æ˜¯å¦çœŸçš„éœ€è¦ç¼“å­˜ï¼Ÿ</li>
<li>ç¼“å­˜ä»€ä¹ˆæ•°æ®ï¼Ÿ</li>
<li>å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ</li>
<li>å¦‚ä½•åº”å¯¹ç¼“å­˜å¤±æ•ˆï¼Ÿ</li>
</ul>
<p>ä¸‹æ¬¡å½“ä½ çš„ç³»ç»Ÿé¢ä¸´é«˜å¹¶å‘æŒ‘æˆ˜æ—¶ï¼Œä¸å¦¨è¯•è¯•æœ¬æ–‡ä»‹ç»çš„ç¼“å­˜æ¶æ„æ–¹æ¡ˆï¼Œè®©ç³»ç»Ÿæ€§èƒ½æ›´ä¸Šä¸€å±‚æ¥¼ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/redis/">Redis</a></li>
      <li><a href="http://localhost:1313/tags/%E7%BC%93%E5%AD%98/">ç¼“å­˜</a></li>
      <li><a href="http://localhost:1313/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/">é«˜å¹¶å‘</a></li>
      <li><a href="http://localhost:1313/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">æœ€ä½³å®è·µ</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="http://localhost:1313/posts/2026/02/shardingsphere-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9A%84%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/">
    <span class="title">Next Â»</span>
    <br>
    <span>ShardingSphere åˆ†åº“åˆ†è¡¨çš„ç”Ÿäº§å®æˆ˜</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤ on x"
            href="https://x.com/intent/tweet/?text=Redis%20%e7%bc%93%e5%ad%98%e6%9e%b6%e6%9e%84%ef%bc%9a%e4%bb%8e%e7%a9%bf%e9%80%8f%e5%88%b0%e9%9b%aa%e5%b4%a9%e7%9a%84%e5%85%a8%e9%93%be%e8%b7%af%e9%98%b2%e6%8a%a4&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2026%2f02%2fredis-%25E7%25BC%2593%25E5%25AD%2598%25E6%259E%25B6%25E6%259E%2584%25E4%25BB%258E%25E7%25A9%25BF%25E9%2580%258F%25E5%2588%25B0%25E9%259B%25AA%25E5%25B4%25A9%25E7%259A%2584%25E5%2585%25A8%25E9%2593%25BE%25E8%25B7%25AF%25E9%2598%25B2%25E6%258A%25A4%2f&amp;hashtags=Redis%2c%e7%bc%93%e5%ad%98%2c%e9%ab%98%e5%b9%b6%e5%8f%91%2c%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤ on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2026%2f02%2fredis-%25E7%25BC%2593%25E5%25AD%2598%25E6%259E%25B6%25E6%259E%2584%25E4%25BB%258E%25E7%25A9%25BF%25E9%2580%258F%25E5%2588%25B0%25E9%259B%25AA%25E5%25B4%25A9%25E7%259A%2584%25E5%2585%25A8%25E9%2593%25BE%25E8%25B7%25AF%25E9%2598%25B2%25E6%258A%25A4%2f&amp;title=Redis%20%e7%bc%93%e5%ad%98%e6%9e%b6%e6%9e%84%ef%bc%9a%e4%bb%8e%e7%a9%bf%e9%80%8f%e5%88%b0%e9%9b%aa%e5%b4%a9%e7%9a%84%e5%85%a8%e9%93%be%e8%b7%af%e9%98%b2%e6%8a%a4&amp;summary=Redis%20%e7%bc%93%e5%ad%98%e6%9e%b6%e6%9e%84%ef%bc%9a%e4%bb%8e%e7%a9%bf%e9%80%8f%e5%88%b0%e9%9b%aa%e5%b4%a9%e7%9a%84%e5%85%a8%e9%93%be%e8%b7%af%e9%98%b2%e6%8a%a4&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2f2026%2f02%2fredis-%25E7%25BC%2593%25E5%25AD%2598%25E6%259E%25B6%25E6%259E%2584%25E4%25BB%258E%25E7%25A9%25BF%25E9%2580%258F%25E5%2588%25B0%25E9%259B%25AA%25E5%25B4%25A9%25E7%259A%2584%25E5%2585%25A8%25E9%2593%25BE%25E8%25B7%25AF%25E9%2598%25B2%25E6%258A%25A4%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤ on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2026%2f02%2fredis-%25E7%25BC%2593%25E5%25AD%2598%25E6%259E%25B6%25E6%259E%2584%25E4%25BB%258E%25E7%25A9%25BF%25E9%2580%258F%25E5%2588%25B0%25E9%259B%25AA%25E5%25B4%25A9%25E7%259A%2584%25E5%2585%25A8%25E9%2593%25BE%25E8%25B7%25AF%25E9%2598%25B2%25E6%258A%25A4%2f&title=Redis%20%e7%bc%93%e5%ad%98%e6%9e%b6%e6%9e%84%ef%bc%9a%e4%bb%8e%e7%a9%bf%e9%80%8f%e5%88%b0%e9%9b%aa%e5%b4%a9%e7%9a%84%e5%85%a8%e9%93%be%e8%b7%af%e9%98%b2%e6%8a%a4">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤ on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2026%2f02%2fredis-%25E7%25BC%2593%25E5%25AD%2598%25E6%259E%25B6%25E6%259E%2584%25E4%25BB%258E%25E7%25A9%25BF%25E9%2580%258F%25E5%2588%25B0%25E9%259B%25AA%25E5%25B4%25A9%25E7%259A%2584%25E5%2585%25A8%25E9%2593%25BE%25E8%25B7%25AF%25E9%2598%25B2%25E6%258A%25A4%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤ on whatsapp"
            href="https://api.whatsapp.com/send?text=Redis%20%e7%bc%93%e5%ad%98%e6%9e%b6%e6%9e%84%ef%bc%9a%e4%bb%8e%e7%a9%bf%e9%80%8f%e5%88%b0%e9%9b%aa%e5%b4%a9%e7%9a%84%e5%85%a8%e9%93%be%e8%b7%af%e9%98%b2%e6%8a%a4%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2f2026%2f02%2fredis-%25E7%25BC%2593%25E5%25AD%2598%25E6%259E%25B6%25E6%259E%2584%25E4%25BB%258E%25E7%25A9%25BF%25E9%2580%258F%25E5%2588%25B0%25E9%259B%25AA%25E5%25B4%25A9%25E7%259A%2584%25E5%2585%25A8%25E9%2593%25BE%25E8%25B7%25AF%25E9%2598%25B2%25E6%258A%25A4%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤ on telegram"
            href="https://telegram.me/share/url?text=Redis%20%e7%bc%93%e5%ad%98%e6%9e%b6%e6%9e%84%ef%bc%9a%e4%bb%8e%e7%a9%bf%e9%80%8f%e5%88%b0%e9%9b%aa%e5%b4%a9%e7%9a%84%e5%85%a8%e9%93%be%e8%b7%af%e9%98%b2%e6%8a%a4&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2026%2f02%2fredis-%25E7%25BC%2593%25E5%25AD%2598%25E6%259E%25B6%25E6%259E%2584%25E4%25BB%258E%25E7%25A9%25BF%25E9%2580%258F%25E5%2588%25B0%25E9%259B%25AA%25E5%25B4%25A9%25E7%259A%2584%25E5%2585%25A8%25E9%2593%25BE%25E8%25B7%25AF%25E9%2598%25B2%25E6%258A%25A4%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤ on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Redis%20%e7%bc%93%e5%ad%98%e6%9e%b6%e6%9e%84%ef%bc%9a%e4%bb%8e%e7%a9%bf%e9%80%8f%e5%88%b0%e9%9b%aa%e5%b4%a9%e7%9a%84%e5%85%a8%e9%93%be%e8%b7%af%e9%98%b2%e6%8a%a4&u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2026%2f02%2fredis-%25E7%25BC%2593%25E5%25AD%2598%25E6%259E%25B6%25E6%259E%2584%25E4%25BB%258E%25E7%25A9%25BF%25E9%2580%258F%25E5%2588%25B0%25E9%259B%25AA%25E5%25B4%25A9%25E7%259A%2584%25E5%2585%25A8%25E9%2593%25BE%25E8%25B7%25AF%25E9%2598%25B2%25E6%258A%25A4%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">åšå®¢å–µ</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
