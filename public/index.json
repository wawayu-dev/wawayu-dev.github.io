[{"content":"é¡¹ç›®ç®€ä»‹ [ç”¨ 2-3 å¥è¯è¯´æ¸…æ¥šï¼šåšäº†ä»€ä¹ˆã€è§£å†³ä»€ä¹ˆé—®é¢˜]\næºç ï¼šGitHub\næ¼”ç¤ºï¼šåœ¨çº¿åœ°å€ï¼ˆå¯é€‰ï¼‰\næŠ€æœ¯æ ˆ åç«¯ï¼š å‰ç«¯ï¼š æ•°æ®åº“ï¼š éƒ¨ç½²ï¼š æ ¸å¿ƒåŠŸèƒ½ æŠ€æœ¯äº®ç‚¹ [äº®ç‚¹1ï¼šæ¯”å¦‚æ€§èƒ½ä¼˜åŒ–] [ç®€è¿°é—®é¢˜ + è§£å†³æ–¹æ¡ˆ]\n1// å…³é”®ä»£ç ç‰‡æ®µï¼ˆå¯é€‰ï¼‰ [äº®ç‚¹2ï¼šæ¯”å¦‚æ¶æ„è®¾è®¡] [ç®€è¿°æ€è·¯]\né¡¹ç›®æˆæœ æ•°æ®æŒ‡æ ‡ï¼ˆå¦‚æœ‰ï¼‰ å­¦åˆ°äº†ä»€ä¹ˆ ğŸ’¡ å¤åˆ¶è¿™ä¸ªæ¨¡æ¿ï¼Œå¡«å…¥ä½ çš„çœŸå®é¡¹ç›®\n","permalink":"http://localhost:1313/projects/example-project/","summary":"\u003ch2 id=\"é¡¹ç›®ç®€ä»‹\"\u003eé¡¹ç›®ç®€ä»‹\u003c/h2\u003e\n\u003cp\u003e[ç”¨ 2-3 å¥è¯è¯´æ¸…æ¥šï¼šåšäº†ä»€ä¹ˆã€è§£å†³ä»€ä¹ˆé—®é¢˜]\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæºç \u003c/strong\u003eï¼š\u003ca href=\"https://github.com/%E4%BD%A0%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D/%E9%A1%B9%E7%9B%AE%E5%90%8D\"\u003eGitHub\u003c/a\u003e\u003cbr\u003e\n\u003cstrong\u003eæ¼”ç¤º\u003c/strong\u003eï¼š\u003ca href=\"#\"\u003eåœ¨çº¿åœ°å€\u003c/a\u003eï¼ˆå¯é€‰ï¼‰\u003c/p\u003e\n\u003ch2 id=\"æŠ€æœ¯æ ˆ\"\u003eæŠ€æœ¯æ ˆ\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eåç«¯ï¼š\u003c/li\u003e\n\u003cli\u003eå‰ç«¯ï¼š\u003c/li\u003e\n\u003cli\u003eæ•°æ®åº“ï¼š\u003c/li\u003e\n\u003cli\u003eéƒ¨ç½²ï¼š\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"æ ¸å¿ƒåŠŸèƒ½\"\u003eæ ¸å¿ƒåŠŸèƒ½\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"æŠ€æœ¯äº®ç‚¹\"\u003eæŠ€æœ¯äº®ç‚¹\u003c/h2\u003e\n\u003ch3 id=\"äº®ç‚¹1æ¯”å¦‚æ€§èƒ½ä¼˜åŒ–\"\u003e[äº®ç‚¹1ï¼šæ¯”å¦‚æ€§èƒ½ä¼˜åŒ–]\u003c/h3\u003e\n\u003cp\u003e[ç®€è¿°é—®é¢˜ + è§£å†³æ–¹æ¡ˆ]\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e// å…³é”®ä»£ç ç‰‡æ®µï¼ˆå¯é€‰ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"äº®ç‚¹2æ¯”å¦‚æ¶æ„è®¾è®¡\"\u003e[äº®ç‚¹2ï¼šæ¯”å¦‚æ¶æ„è®¾è®¡]\u003c/h3\u003e\n\u003cp\u003e[ç®€è¿°æ€è·¯]\u003c/p\u003e\n\u003ch2 id=\"é¡¹ç›®æˆæœ\"\u003eé¡¹ç›®æˆæœ\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eæ•°æ®æŒ‡æ ‡ï¼ˆå¦‚æœ‰ï¼‰\u003c/li\u003e\n\u003cli\u003eå­¦åˆ°äº†ä»€ä¹ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cblockquote\u003e\n\u003cp\u003eğŸ’¡ å¤åˆ¶è¿™ä¸ªæ¨¡æ¿ï¼Œå¡«å…¥ä½ çš„çœŸå®é¡¹ç›®\u003c/p\u003e\n\u003c/blockquote\u003e","title":"[é¡¹ç›®åç§°]"},{"content":"åœ¨ç¢ç‰‡åŒ–ä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œæ‹¥æœ‰ä¸€å¥—å®Œå…¨å—è‡ªå·±æŒæ§çš„æŠ€æœ¯ä¸“æ ï¼Œæ˜¯æ¯ä½å¼€å‘è€…æ²‰æ·€æ€è€ƒã€æ‰“é€ ä¸ªäººå“ç‰Œçš„æ ¸å¿ƒèµ„äº§ã€‚ç›¸æ¯”äºè¢«å¹³å°ç®—æ³•ç»‘æ¶çš„å…¬ä¼—å·ï¼Œæˆ–æ˜¯å……æ–¥å¹¿å‘Šçš„ç¬¬ä¸‰æ–¹åšå®¢ï¼ŒHugo è¿™ç±»é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ç»™äº†æˆ‘ä»¬çœŸæ­£çš„è‡ªç”±ï¼šæ¯«ç§’çº§æ„å»ºã€Markdown åŸç”Ÿæ”¯æŒã€å®Œå…¨çš„æ ·å¼æ§åˆ¶æƒã€‚\nä½†å¾ˆå¤šäººåœ¨æ­å»º Hugo åšå®¢æ—¶ï¼Œå¾€å¾€é™·å…¥\u0026quot;ç…§ç€æ–‡æ¡£æ•²å‘½ä»¤\u0026quot;çš„æœºæ¢°é‡å¤ã€‚æœ¬æ–‡ä¸æ˜¯åˆä¸€ç¯‡å®‰è£…æ•™ç¨‹ï¼Œè€Œæ˜¯ä»ç³»ç»Ÿæ¶æ„çš„è§’åº¦ï¼Œå¸¦ä½ ç†è§£ Hugo + PaperMod è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡é€»è¾‘ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Hugo Extended ä¸ PaperMod çš„ä¾èµ–å…³ç³» æŒæ¡ Git Submodule çš„ä¸»é¢˜ç®¡ç†æ–¹æ¡ˆ è®¾è®¡åŸºäº GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿ å»ºç«‹å·¥ç¨‹åŒ–æ€ç»´è€Œé\u0026quot;è·Ÿç€åš\u0026quot;çš„æ“ä½œæ€ç»´ 01. åŸºç¡€è®¾æ–½ï¼šä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ Hugo Extendedï¼Ÿ å¾ˆå¤šäººç¬¬ä¸€æ¬¡æ­å»º Hugo åšå®¢æ—¶ï¼Œä¼šé‡åˆ°ä¸€ä¸ªè¯¡å¼‚çš„æŠ¥é”™ï¼šTOCSS: failed to transform \u0026quot;css/main.css\u0026quot;ã€‚æ˜æ˜æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è£…äº† Hugoï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºé”™ï¼Ÿ\né—®é¢˜å‡ºåœ¨ç‰ˆæœ¬é€‰æ‹©ä¸Šã€‚Hugo åˆ†ä¸ºæ™®é€šç‰ˆå’Œ Extended ç‰ˆï¼Œåè€…å†…ç½®äº† LibSass ç¼–è¯‘å™¨ã€‚è€Œ PaperMod è¿™ç±»ç°ä»£ä¸»é¢˜å¤§é‡ä½¿ç”¨ SCSS/SASS æ¥å®ç°ä¸»é¢˜å˜é‡ã€æš—é»‘æ¨¡å¼åˆ‡æ¢ç­‰ç‰¹æ€§ã€‚å¦‚æœä½ ç”¨æ™®é€šç‰ˆ Hugoï¼Œç¼–è¯‘æµç¨‹ä¼šåœ¨ CSS è½¬æ¢ç¯èŠ‚ç›´æ¥å´©æºƒã€‚\nåœ¨ Windows ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ç”¨ Winget æ¥å®‰è£…ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ä¸‹è½½ zip åŒ…ï¼š\n1# ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œç¡®ä¿ç‰ˆæœ¬å¯è¿½æº¯ 2winget install Hugo.Hugo.Extended 3 4# éªŒè¯å®‰è£…ï¼šå¿…é¡»çœ‹åˆ° +extended æ ‡è¯† 5hugo version 6# é¢„æœŸè¾“å‡º: hugo v0.12x.x+extended windows/amd64 ä¸ºä»€ä¹ˆåšæŒç”¨åŒ…ç®¡ç†å™¨ï¼Ÿå› ä¸ºè¿™æ˜¯\u0026quot;å¯å¤ç°ç¯å¢ƒ\u0026quot;çš„ç¬¬ä¸€æ­¥ã€‚å½“ä½ çš„åšå®¢éœ€è¦å›¢é˜Ÿåä½œï¼Œæˆ–è€…æ¢äº†å°ç”µè„‘é‡æ–°éƒ¨ç½²æ—¶ï¼Œä¸€æ¡å‘½ä»¤å°±èƒ½æ¢å¤å®Œå…¨ä¸€è‡´çš„ç¯å¢ƒï¼Œè€Œä¸æ˜¯åœ¨\u0026quot;æˆ‘ç”µè„‘ä¸Šèƒ½è·‘\u0026quot;çš„æ³¥æ½­é‡ŒæŒ£æ‰ã€‚\næ¥ä¸‹æ¥åˆå§‹åŒ–ç«™ç‚¹éª¨æ¶ï¼š\n1hugo new site myblog 2cd myblog 3git init è¿™ä¸‰è¡Œå‘½ä»¤çœ‹ä¼¼ç®€å•ï¼Œä½†èƒŒåæ˜¯ Hugo çš„\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;å“²å­¦ï¼šcontent/ å­˜æ”¾å†…å®¹æºæ–‡ä»¶ï¼Œthemes/ ç®¡ç†è§†è§‰å±‚ï¼Œpublic/ ä½œä¸ºç¼–è¯‘äº§ç‰©è¾“å‡ºã€‚è¿™ç§æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œè®©æˆ‘ä»¬å¯ä»¥ç‹¬ç«‹ç®¡ç†å†…å®¹ã€ä¸»é¢˜å’Œæ„å»ºæµç¨‹ã€‚\næ¶æ„æ€è€ƒï¼š Hugo çš„ç›®å½•ç»“æ„æœ¬è´¨ä¸Šæ˜¯ä¸€ç§\u0026quot;å…³æ³¨ç‚¹åˆ†ç¦»\u0026quot;çš„è®¾è®¡æ¨¡å¼ã€‚å†…å®¹åˆ›ä½œè€…åªéœ€è¦å…³å¿ƒ content/ ä¸‹çš„ Markdownï¼Œä¸»é¢˜å¼€å‘è€…ä¸“æ³¨äº themes/ çš„æ¨¡æ¿é€»è¾‘ï¼Œè€Œ CI/CD æµæ°´çº¿åªéœ€è¦å¤„ç† public/ çš„éƒ¨ç½²ã€‚è¿™ç§è§£è€¦è®¾è®¡ï¼Œæ˜¯å¤§è§„æ¨¡å†…å®¹ç”Ÿäº§çš„åŸºç¡€ã€‚\n02. ä¸»é¢˜ä¾èµ–ï¼šä¸ºä»€ä¹ˆé€‰æ‹© Git Submoduleï¼Ÿ å¼•å…¥ PaperMod ä¸»é¢˜æœ‰ä¸¤ç§æ–¹å¼ï¼šç›´æ¥ä¸‹è½½ zip åŒ…è§£å‹åˆ° themes/ ç›®å½•ï¼Œæˆ–è€…ç”¨ Git Submoduleã€‚å¾ˆå¤šæ•™ç¨‹ä¼šæ¨èå‰è€…ï¼Œå› ä¸º\u0026quot;ç®€å•\u0026quot;ã€‚ä½†è¿™ç§ç®€å•æ˜¯æœ‰ä»£ä»·çš„ã€‚\næƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šPaperMod å®˜æ–¹ä¿®å¤äº†ä¸€ä¸ªæš—é»‘æ¨¡å¼çš„ Bugï¼Œæˆ–è€…æ–°å¢äº†æœç´¢åŠŸèƒ½ã€‚å¦‚æœä½ æ˜¯ç›´æ¥ä¸‹è½½çš„ä¸»é¢˜ï¼Œæ›´æ–°æµç¨‹ä¼šå˜æˆï¼šå» GitHub ä¸‹è½½æ–°ç‰ˆ â†’ åˆ é™¤æ—§æ–‡ä»¶ â†’ è§£å‹è¦†ç›– â†’ ç¥ˆç¥·æ²¡æœ‰å†²çªã€‚è€Œå¦‚æœç”¨ Submoduleï¼Œåªéœ€è¦ä¸€æ¡å‘½ä»¤ï¼š\n1# å»ºç«‹ä¸»é¢˜å­æ¨¡å—ä¾èµ– 2git submodule add --depth=1 https://github.com/adityatelange/hugo-PaperMod.git themes/PaperMod 3 4# æœªæ¥æ›´æ–°ä¸»é¢˜åªéœ€è¦ 5git submodule update --remote --merge Submodule çš„æœ¬è´¨æ˜¯\u0026quot;ä¾èµ–å¤–éƒ¨åŒ–\u0026quot;ã€‚ä¸»é¢˜ä»£ç ä¸ä¼šæ±¡æŸ“ä½ çš„ä¸»ä»“åº“æäº¤å†å²ï¼ŒåŒæ—¶åˆèƒ½é€šè¿‡ .gitmodules æ–‡ä»¶ç²¾ç¡®é”å®šä¾èµ–ç‰ˆæœ¬ã€‚è¿™ç§è®¾è®¡åœ¨å¤§å‹å¼€æºé¡¹ç›®ä¸­æä¸ºå¸¸è§ï¼ˆæ¯”å¦‚ Linux å†…æ ¸çš„é©±åŠ¨æ¨¡å—ç®¡ç†ï¼‰ã€‚\nç„¶ååœ¨ hugo.toml ä¸­æ¿€æ´»ä¸»é¢˜ï¼š\n1theme = \u0026#34;PaperMod\u0026#34; è¿™ä¸€è¡Œé…ç½®æ˜¯æ•´ä¸ªç«™ç‚¹çš„\u0026quot;æ§åˆ¶æ¢çº½\u0026quot;ï¼Œå®ƒå‘Šè¯‰ Hugo åœ¨ç¼–è¯‘æ—¶å» themes/PaperMod/ ç›®å½•å¯»æ‰¾æ¨¡æ¿æ–‡ä»¶ã€‚\né¿å‘æç¤ºï¼š å¦‚æœä½ å…‹éš†äº†åˆ«äººçš„ Hugo é¡¹ç›®ï¼Œè®°å¾—æ‰§è¡Œ git submodule update --init --recursiveï¼Œå¦åˆ™ themes/ ç›®å½•ä¼šæ˜¯ç©ºçš„ï¼Œå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚\n03. å†…å®¹ç”Ÿäº§ï¼šä»æ¨¡æ¿åˆ°å®æ—¶é¢„è§ˆ åˆ›å»ºç¬¬ä¸€ç¯‡æ–‡ç« ï¼š\n1hugo new posts/my-first-post.md è¿™æ¡å‘½ä»¤ä¼šæ ¹æ® archetypes/default.md æ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆæ–‡ç« éª¨æ¶ï¼ŒåŒ…æ‹¬ Front Matterï¼ˆæ ‡é¢˜ã€æ—¥æœŸã€æ ‡ç­¾ç­‰å…ƒæ•°æ®ï¼‰ã€‚è¿™ä¿è¯äº†å…¨ç«™æ–‡ç« æ ¼å¼çš„ä¸€è‡´æ€§ï¼Œé¿å…äº†æ‰‹åŠ¨ç¼–å†™ YAML æ—¶çš„ä½çº§é”™è¯¯ã€‚\né»˜è®¤ç”Ÿæˆçš„æ–‡ç« åŒ…å« draft: true å­—æ®µï¼Œè¿™æ˜¯ Hugo çš„\u0026quot;è‰ç¨¿æ€\u0026quot;æœºåˆ¶ã€‚åœ¨æ­£å¼æ„å»ºæ—¶ï¼Œè‰ç¨¿ä¸ä¼šè¢«ç¼–è¯‘ã€‚è¿™ä¸ªè®¾è®¡å¾ˆè´´å¿ƒï¼šä½ å¯ä»¥åœ¨æœ¬åœ°éšæ„å†™åŠæˆå“æ–‡ç« ï¼Œä¸ç”¨æ‹…å¿ƒå®ƒä»¬è¢«æ„å¤–å‘å¸ƒã€‚\nå¯åŠ¨æœ¬åœ°é¢„è§ˆæœåŠ¡å™¨ï¼š\n1hugo server -D 2# è®¿é—® http://localhost:1313 -D å‚æ•°è¡¨ç¤ºé¢„è§ˆè‰ç¨¿ã€‚Hugo çš„å®æ—¶é¢„è§ˆèƒ½åŠ›æºäºå…¶\u0026quot;å¢é‡ç¼–è¯‘\u0026quot;è®¾è®¡ï¼šå®ƒä¸ä¼šåœ¨æ¯æ¬¡æ–‡ä»¶å˜æ›´æ—¶é‡æ–°æ„å»ºæ•´ä¸ªç«™ç‚¹ï¼Œè€Œæ˜¯é€šè¿‡ä¾èµ–å›¾åˆ†æï¼Œåªé‡æ–°ç¼–è¯‘å—å½±å“çš„é¡µé¢ã€‚å³ä½¿ä½ çš„åšå®¢æœ‰ä¸Šåƒç¯‡æ–‡ç« ï¼Œé¢„è§ˆå»¶è¿Ÿä¹Ÿèƒ½æ§åˆ¶åœ¨ 100ms ä»¥å†…ã€‚\nè¿™ç§æ¯«ç§’çº§çš„åé¦ˆå¾ªç¯ï¼Œè®©å†™ä½œå˜æˆäº†ä¸€ç§\u0026quot;æ‰€è§å³æ‰€å¾—\u0026quot;çš„æµç•…ä½“éªŒã€‚ä½ æ”¹ä¸€ä¸ªæ ‡ç‚¹ï¼Œæµè§ˆå™¨ç«‹åˆ»åˆ·æ–°ï¼›ä½ è°ƒæ•´ä¸€ä¸ªæ ·å¼ï¼Œæ•ˆæœç¬é—´å‘ˆç°ã€‚è¿™ç§å³æ—¶åé¦ˆï¼Œæ˜¯ä¿æŒåˆ›ä½œå¿ƒæµçš„å…³é”®ã€‚\n04. è‡ªåŠ¨åŒ–æµæ°´çº¿ï¼šæäº¤å³å‘å¸ƒçš„é­”æ³• æ‰‹åŠ¨æ„å»ºã€æ‰‹åŠ¨ä¸Šä¼ çš„æ—¶ä»£æ—©è¯¥ç»“æŸäº†ã€‚æˆ‘ä»¬è¦çš„æ˜¯\u0026quot;git push ä¹‹åå–æ¯å’–å•¡ï¼Œå›æ¥åšå®¢å°±æ›´æ–°äº†\u0026quot;çš„ä¸æ»‘ä½“éªŒã€‚\nGitHub Actions æ˜¯å®ç°è¿™ä¸ªç›®æ ‡çš„æœ€ä½³å·¥å…·ã€‚å®ƒçš„å·¥ä½œæµç¨‹æ˜¯ï¼šä½ æ¨é€ä»£ç åˆ° GitHub â†’ Actions è‡ªåŠ¨æ‹‰å–ä»£ç  â†’ è°ƒç”¨ Hugo ç¼–è¯‘ â†’ å°†ç”Ÿæˆçš„é™æ€æ–‡ä»¶éƒ¨ç½²åˆ° GitHub Pagesã€‚\nåœ¨ .github/workflows/hugo.yml ä¸­åˆ›å»ºå·¥ä½œæµé…ç½®ï¼š\n1name: Deploy Hugo site to Pages 2 3on: 4 push: 5 branches: [\u0026#34;main\u0026#34;] 6 7permissions: 8 contents: read 9 pages: write 10 id-token: write 11 12jobs: 13 build: 14 runs-on: ubuntu-latest 15 steps: 16 - name: Checkout 17 uses: actions/checkout@v4 18 with: 19 submodules: recursive # å…³é”®ï¼šé€’å½’æ‹‰å–ä¸»é¢˜å­æ¨¡å— 20 fetch-depth: 0 21 22 - name: Setup Hugo 23 uses: peaceiris/actions-hugo@v3 24 with: 25 hugo-version: \u0026#39;latest\u0026#39; 26 extended: true # å¿…é¡»å¼€å¯ Extended æ”¯æŒ 27 28 - name: Build 29 run: hugo --minify # å‹ç¼© HTML/CSS/JS 30 31 - name: Upload artifact 32 uses: actions/upload-pages-artifact@v3 33 with: 34 path: ./public 35 36 deploy: 37 environment: 38 name: github-pages 39 runs-on: ubuntu-latest 40 needs: build 41 steps: 42 - id: deployment 43 uses: actions/deploy-pages@v4 è¿™ä¸ªé…ç½®æ–‡ä»¶çš„æ ¸å¿ƒæ˜¯ submodules: recursiveã€‚å¦‚æœæ¼æ‰è¿™ä¸€è¡Œï¼ŒActions æ‹‰å–ä»£ç æ—¶ä¸ä¼šä¸‹è½½ PaperMod ä¸»é¢˜ï¼Œå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚è¿™æ˜¯å¾ˆå¤šäººç¬¬ä¸€æ¬¡é…ç½® CI/CD æ—¶è¸©çš„å‘ã€‚\nhugo --minify ä¼šå‹ç¼©ç”Ÿæˆçš„ HTMLã€CSSã€JS æ–‡ä»¶ï¼Œå‡å°‘ä¼ è¾“ä½“ç§¯ã€‚å¯¹äºä¸€ä¸ªä¸­ç­‰è§„æ¨¡çš„åšå®¢ï¼Œè¿™èƒ½èŠ‚çœ 30-40% çš„å¸¦å®½ã€‚\næ¶æ„æ€è€ƒï¼š è¿™å¥— CI/CD æµæ°´çº¿çš„æœ¬è´¨æ˜¯\u0026quot;åŸºç¡€è®¾æ–½å³ä»£ç \u0026quot;ï¼ˆInfrastructure as Codeï¼‰ã€‚éƒ¨ç½²æµç¨‹ä¸å†æ˜¯å£å£ç›¸ä¼ çš„æ“ä½œæ‰‹å†Œï¼Œè€Œæ˜¯ç‰ˆæœ¬æ§åˆ¶çš„ YAML æ–‡ä»¶ã€‚ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°éƒ¨ç½²é€»è¾‘ï¼Œä»»ä½•ä¿®æ”¹éƒ½æœ‰å®¡è®¡è®°å½•ã€‚è¿™ç§é€æ˜æ€§å’Œå¯å¤ç°æ€§ï¼Œæ˜¯ç°ä»£ DevOps çš„æ ¸å¿ƒç†å¿µã€‚\n05. æ€»ç»“ä¸æ€è€ƒ æˆ‘ä»¬ä» Hugo Extended çš„ç‰ˆæœ¬é€‰æ‹©ï¼Œåˆ° Git Submodule çš„ä¾èµ–ç®¡ç†ï¼Œå†åˆ° GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œæ„å»ºäº†ä¸€å¥—å®Œæ•´çš„åšå®¢å·¥ç¨‹åŒ–æ–¹æ¡ˆã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸ºäº†\u0026quot;æ­ä¸ªåšå®¢\u0026quot;ï¼Œæ›´æ˜¯ä¸€æ¬¡å¯¹é™æ€ç«™ç‚¹ç¼–è¯‘æµç¨‹ã€ä¾èµ–ç®¡ç†æ€æƒ³ã€CI/CD å®è·µçš„æ·±åº¦ç†è§£ã€‚\nå¦‚æœä½ çš„åšå®¢æœªæ¥éœ€è¦æ”¯æŒå¤šè¯­è¨€ç‰ˆæœ¬ï¼Œæˆ–è€…éœ€è¦é’ˆå¯¹ä¸åŒç»ˆç«¯æä¾›å·®å¼‚åŒ–çš„æœç´¢ä½“éªŒï¼Œä½ ä¼šå¦‚ä½•ä» hugo.toml çš„é…ç½®å±‚çº§è¿›è¡Œè§£è€¦è®¾è®¡ï¼Ÿæç¤ºï¼šå¯ä»¥ç ”ç©¶ Hugo çš„ languages é…ç½®å’Œ outputFormats æœºåˆ¶ã€‚\næŠ€æœ¯çš„æœ¬è´¨ä¸æ˜¯å·¥å…·çš„å †ç Œï¼Œè€Œæ˜¯å¯¹é—®é¢˜çš„æ·±åº¦ç†è§£ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ è·³å‡º\u0026quot;ç…§ç€åš\u0026quot;çš„æ€ç»´å®šå¼ï¼ŒçœŸæ­£ç†è§£ Hugo è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡å“²å­¦ã€‚\n","permalink":"http://localhost:1313/posts/2026/02/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%9E%84%E5%BB%BA-hugo--papermod-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/","summary":"\u003cp\u003eåœ¨ç¢ç‰‡åŒ–ä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œæ‹¥æœ‰ä¸€å¥—å®Œå…¨å—è‡ªå·±æŒæ§çš„æŠ€æœ¯ä¸“æ ï¼Œæ˜¯æ¯ä½å¼€å‘è€…æ²‰æ·€æ€è€ƒã€æ‰“é€ ä¸ªäººå“ç‰Œçš„æ ¸å¿ƒèµ„äº§ã€‚ç›¸æ¯”äºè¢«å¹³å°ç®—æ³•ç»‘æ¶çš„å…¬ä¼—å·ï¼Œæˆ–æ˜¯å……æ–¥å¹¿å‘Šçš„ç¬¬ä¸‰æ–¹åšå®¢ï¼ŒHugo è¿™ç±»é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ç»™äº†æˆ‘ä»¬çœŸæ­£çš„è‡ªç”±ï¼šæ¯«ç§’çº§æ„å»ºã€Markdown åŸç”Ÿæ”¯æŒã€å®Œå…¨çš„æ ·å¼æ§åˆ¶æƒã€‚\u003c/p\u003e\n\u003cp\u003eä½†å¾ˆå¤šäººåœ¨æ­å»º Hugo åšå®¢æ—¶ï¼Œå¾€å¾€é™·å…¥\u0026quot;ç…§ç€æ–‡æ¡£æ•²å‘½ä»¤\u0026quot;çš„æœºæ¢°é‡å¤ã€‚æœ¬æ–‡ä¸æ˜¯åˆä¸€ç¯‡å®‰è£…æ•™ç¨‹ï¼Œè€Œæ˜¯ä»ç³»ç»Ÿæ¶æ„çš„è§’åº¦ï¼Œå¸¦ä½ ç†è§£ Hugo + PaperMod è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡é€»è¾‘ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Hugo Extended ä¸ PaperMod çš„ä¾èµ–å…³ç³»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Git Submodule çš„ä¸»é¢˜ç®¡ç†æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è®¾è®¡åŸºäº GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹å·¥ç¨‹åŒ–æ€ç»´è€Œé\u0026quot;è·Ÿç€åš\u0026quot;çš„æ“ä½œæ€ç»´\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"01-åŸºç¡€è®¾æ–½ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯-hugo-extended\"\u003e01. åŸºç¡€è®¾æ–½ï¼šä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ Hugo Extendedï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eå¾ˆå¤šäººç¬¬ä¸€æ¬¡æ­å»º Hugo åšå®¢æ—¶ï¼Œä¼šé‡åˆ°ä¸€ä¸ªè¯¡å¼‚çš„æŠ¥é”™ï¼š\u003ccode\u003eTOCSS: failed to transform \u0026quot;css/main.css\u0026quot;\u003c/code\u003eã€‚æ˜æ˜æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è£…äº† Hugoï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºé”™ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eé—®é¢˜å‡ºåœ¨ç‰ˆæœ¬é€‰æ‹©ä¸Šã€‚Hugo åˆ†ä¸ºæ™®é€šç‰ˆå’Œ Extended ç‰ˆï¼Œåè€…å†…ç½®äº† LibSass ç¼–è¯‘å™¨ã€‚è€Œ PaperMod è¿™ç±»ç°ä»£ä¸»é¢˜å¤§é‡ä½¿ç”¨ SCSS/SASS æ¥å®ç°ä¸»é¢˜å˜é‡ã€æš—é»‘æ¨¡å¼åˆ‡æ¢ç­‰ç‰¹æ€§ã€‚å¦‚æœä½ ç”¨æ™®é€šç‰ˆ Hugoï¼Œç¼–è¯‘æµç¨‹ä¼šåœ¨ CSS è½¬æ¢ç¯èŠ‚ç›´æ¥å´©æºƒã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ Windows ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ç”¨ Winget æ¥å®‰è£…ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ä¸‹è½½ zip åŒ…ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-powershell\" data-lang=\"powershell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œç¡®ä¿ç‰ˆæœ¬å¯è¿½æº¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ewinget\u003c/span\u003e \u003cspan class=\"n\"\u003einstall\u003c/span\u003e \u003cspan class=\"n\"\u003eHugo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"py\"\u003eHugo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"py\"\u003eExtended\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# éªŒè¯å®‰è£…ï¼šå¿…é¡»çœ‹åˆ° +extended æ ‡è¯†\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ehugo\u003c/span\u003e \u003cspan class=\"n\"\u003eversion\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# é¢„æœŸè¾“å‡º: hugo v0.12x.x+extended windows/amd64\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¸ºä»€ä¹ˆåšæŒç”¨åŒ…ç®¡ç†å™¨ï¼Ÿå› ä¸ºè¿™æ˜¯\u0026quot;å¯å¤ç°ç¯å¢ƒ\u0026quot;çš„ç¬¬ä¸€æ­¥ã€‚å½“ä½ çš„åšå®¢éœ€è¦å›¢é˜Ÿåä½œï¼Œæˆ–è€…æ¢äº†å°ç”µè„‘é‡æ–°éƒ¨ç½²æ—¶ï¼Œä¸€æ¡å‘½ä»¤å°±èƒ½æ¢å¤å®Œå…¨ä¸€è‡´çš„ç¯å¢ƒï¼Œè€Œä¸æ˜¯åœ¨\u0026quot;æˆ‘ç”µè„‘ä¸Šèƒ½è·‘\u0026quot;çš„æ³¥æ½­é‡ŒæŒ£æ‰ã€‚\u003c/p\u003e","title":"ä»é›¶åˆ°ä¸€ï¼šæ„å»º Hugo + PaperMod è‡ªåŠ¨åŒ–åšå®¢ç³»ç»Ÿ"},{"content":"å¼€å§‹å†™åšå®¢ é‚£æ˜¯ä¸€æ¡ç¥å¥‡çš„å¤©è·¯å•Š ğŸµ\nä»Šå¤©å¼€å§‹äº†æˆ‘çš„åšå®¢ä¹‹æ—…ï¼Œå¸Œæœ›èƒ½åœ¨è¿™é‡Œè®°å½•ä¸‹ï¼š\nğŸ’¡ æŠ€æœ¯å­¦ä¹ çš„å¿ƒå¾— ğŸš€ é¡¹ç›®å¼€å‘çš„ç»éªŒ ğŸ“– è¯»ä¹¦æ€è€ƒçš„æ€»ç»“ ğŸŒŸ ç”Ÿæ´»ä¸­çš„æ„Ÿæ‚Ÿ ä¸ºä»€ä¹ˆå†™åšå®¢ å†™åšå®¢ä¸ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯ï¼š\næ•´ç†æ€è·¯ï¼šé€šè¿‡å†™ä½œæ¢³ç†çŸ¥è¯†ä½“ç³» æ·±åŒ–ç†è§£ï¼šæ•™æ˜¯æœ€å¥½çš„å­¦ åˆ†äº«äº¤æµï¼šä¸ä»–äººäº¤æµæƒ³æ³• è®°å½•æˆé•¿ï¼šè§è¯è‡ªå·±çš„è¿›æ­¥ æœªæ¥è®¡åˆ’ æ¥ä¸‹æ¥æˆ‘ä¼šåˆ†äº«æ›´å¤šå…³äºæŠ€æœ¯å’Œç”Ÿæ´»çš„å†…å®¹ï¼Œæ•¬è¯·æœŸå¾…ï¼\n\u0026ldquo;The journey of a thousand miles begins with one step.\u0026rdquo; - è€å­\n","permalink":"http://localhost:1313/posts/2026/02/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0/","summary":"\u003ch2 id=\"å¼€å§‹å†™åšå®¢\"\u003eå¼€å§‹å†™åšå®¢\u003c/h2\u003e\n\u003cp\u003eé‚£æ˜¯ä¸€æ¡ç¥å¥‡çš„å¤©è·¯å•Š ğŸµ\u003c/p\u003e\n\u003cp\u003eä»Šå¤©å¼€å§‹äº†æˆ‘çš„åšå®¢ä¹‹æ—…ï¼Œå¸Œæœ›èƒ½åœ¨è¿™é‡Œè®°å½•ä¸‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eğŸ’¡ æŠ€æœ¯å­¦ä¹ çš„å¿ƒå¾—\u003c/li\u003e\n\u003cli\u003eğŸš€ é¡¹ç›®å¼€å‘çš„ç»éªŒ\u003c/li\u003e\n\u003cli\u003eğŸ“– è¯»ä¹¦æ€è€ƒçš„æ€»ç»“\u003c/li\u003e\n\u003cli\u003eğŸŒŸ ç”Ÿæ´»ä¸­çš„æ„Ÿæ‚Ÿ\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆå†™åšå®¢\"\u003eä¸ºä»€ä¹ˆå†™åšå®¢\u003c/h2\u003e\n\u003cp\u003eå†™åšå®¢ä¸ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæ•´ç†æ€è·¯\u003c/strong\u003eï¼šé€šè¿‡å†™ä½œæ¢³ç†çŸ¥è¯†ä½“ç³»\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ·±åŒ–ç†è§£\u003c/strong\u003eï¼šæ•™æ˜¯æœ€å¥½çš„å­¦\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåˆ†äº«äº¤æµ\u003c/strong\u003eï¼šä¸ä»–äººäº¤æµæƒ³æ³•\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè®°å½•æˆé•¿\u003c/strong\u003eï¼šè§è¯è‡ªå·±çš„è¿›æ­¥\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"æœªæ¥è®¡åˆ’\"\u003eæœªæ¥è®¡åˆ’\u003c/h2\u003e\n\u003cp\u003eæ¥ä¸‹æ¥æˆ‘ä¼šåˆ†äº«æ›´å¤šå…³äºæŠ€æœ¯å’Œç”Ÿæ´»çš„å†…å®¹ï¼Œæ•¬è¯·æœŸå¾…ï¼\u003c/p\u003e\n\u003chr\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u0026ldquo;The journey of a thousand miles begins with one step.\u0026rdquo; - è€å­\u003c/p\u003e\n\u003c/blockquote\u003e","title":"æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢æ–‡ç« "},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œå¾€å¾€éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯è¿™äº›æ“ä½œçš„ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªç»å…¸éš¾é¢˜ã€‚æœ¬æ–‡å°†ç³»ç»Ÿè®²è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒé—®é¢˜ æŒæ¡2PCã€3PCã€TCCã€Sagaç­‰æ–¹æ¡ˆ å­¦ä¼šä½¿ç”¨Seataæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ äº†è§£å„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ ä¸šåŠ¡åœºæ™¯ ç”µå•†ä¸‹å•åœºæ™¯ï¼Œæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼š\n1ç”¨æˆ·ä¸‹å• 2 â†“ 3è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å• 4 â†“ 5åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜ 6 â†“ 7è´¦æˆ·æœåŠ¡ï¼šæ‰£å‡ä½™é¢ 8 â†“ 9ç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ† é—®é¢˜ï¼šå¦‚æœæŸä¸ªæœåŠ¡å¤±è´¥ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\nCAPç†è®º åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸‰ä¸ªç‰¹æ€§ï¼š\nC (Consistency)ï¼šä¸€è‡´æ€§ A (Availability)ï¼šå¯ç”¨æ€§ P (Partition Tolerance)ï¼šåˆ†åŒºå®¹é”™æ€§ CAPå®šç†ï¼šä¸‰è€…æœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤ä¸ª\nå®é™…é€‰æ‹©ï¼š\nCPï¼šç‰ºç‰²å¯ç”¨æ€§ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ˆå¦‚ZooKeeperï¼‰ APï¼šç‰ºç‰²ä¸€è‡´æ€§ï¼Œä¿è¯å¯ç”¨æ€§ï¼ˆå¦‚Eurekaï¼‰ BASEç†è®º BA (Basically Available)ï¼šåŸºæœ¬å¯ç”¨ S (Soft State)ï¼šè½¯çŠ¶æ€ E (Eventually Consistent)ï¼šæœ€ç»ˆä¸€è‡´æ€§ æ¶æ„æ€è€ƒï¼š åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¼ºä¸€è‡´æ€§å¾€å¾€éš¾ä»¥å®ç°ä¸”ä»£ä»·é«˜æ˜‚ã€‚å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼Œè¿™ä¹Ÿæ˜¯ç°ä»£åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆçš„åŸºç¡€ã€‚\n2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ åŸç† ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰\nåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€Prepareè¯·æ±‚ å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤ å‚ä¸è€…è¿”å›Yesæˆ–No ç¬¬äºŒé˜¶æ®µï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰\nå¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›Yesï¼Œåè°ƒè€…å‘é€Commitè¯·æ±‚ å¦‚æœæœ‰å‚ä¸è€…è¿”å›Noï¼Œåè°ƒè€…å‘é€Rollbackè¯·æ±‚ æµç¨‹å›¾ 1åè°ƒè€… å‚ä¸è€…1 å‚ä¸è€…2 2 | | | 3 |---Prepare----------\u0026gt;| | 4 |---Prepare----------------------------\u0026gt;| 5 | | | 6 |\u0026lt;--Yes/No------------| | 7 |\u0026lt;--Yes/No-------------------------------| 8 | | | 9 |---Commit/Rollback--\u0026gt;| | 10 |---Commit/Rollback----------------------\u0026gt;| ä»£ç ç¤ºä¾‹ 1public class TwoPhaseCommitCoordinator { 2 3 private List\u0026lt;Participant\u0026gt; participants; 4 5 public boolean executeTransaction() { 6 // ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡ 7 boolean canCommit = prepare(); 8 9 // ç¬¬äºŒé˜¶æ®µï¼šæäº¤æˆ–å›æ»š 10 if (canCommit) { 11 commit(); 12 return true; 13 } else { 14 rollback(); 15 return false; 16 } 17 } 18 19 private boolean prepare() { 20 for (Participant participant : participants) { 21 if (!participant.prepare()) { 22 return false; 23 } 24 } 25 return true; 26 } 27 28 private void commit() { 29 for (Participant participant : participants) { 30 participant.commit(); 31 } 32 } 33 34 private void rollback() { 35 for (Participant participant : participants) { 36 participant.rollback(); 37 } 38 } 39} 40 41interface Participant { 42 boolean prepare(); 43 void commit(); 44 void rollback(); 45} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nå¼ºä¸€è‡´æ€§ å®ç°ç›¸å¯¹ç®€å• ç¼ºç‚¹ï¼š\nåŒæ­¥é˜»å¡ï¼šå‚ä¸è€…åœ¨ç­‰å¾…åè°ƒè€…æŒ‡ä»¤æ—¶ä¼šé˜»å¡ å•ç‚¹æ•…éšœï¼šåè°ƒè€…æ•…éšœä¼šå¯¼è‡´å‚ä¸è€…ä¸€ç›´é˜»å¡ æ•°æ®ä¸ä¸€è‡´ï¼šç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´éƒ¨åˆ†å‚ä¸è€…æäº¤ï¼Œéƒ¨åˆ†å›æ»š 3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰ åŸç† åœ¨2PCåŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶æœºåˆ¶å’ŒCanCommité˜¶æ®µï¼š\nç¬¬ä¸€é˜¶æ®µï¼šCanCommit\nåè°ƒè€…è¯¢é—®å‚ä¸è€…æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡ ç¬¬äºŒé˜¶æ®µï¼šPreCommit\nå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤ ç¬¬ä¸‰é˜¶æ®µï¼šDoCommit\nå‚ä¸è€…æäº¤æˆ–å›æ»šäº‹åŠ¡ æ”¹è¿› è¶…æ—¶æœºåˆ¶ï¼šå‚ä¸è€…ç­‰å¾…è¶…æ—¶åè‡ªåŠ¨æäº¤ å‡å°‘é˜»å¡ï¼šCanCommité˜¶æ®µä¸å ç”¨èµ„æº ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\né™ä½äº†é˜»å¡èŒƒå›´ å¢åŠ äº†è¶…æ—¶æœºåˆ¶ ç¼ºç‚¹ï¼š\nä»ç„¶å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„é£é™© å®ç°æ›´å¤æ‚ æ€§èƒ½å¼€é”€æ›´å¤§ TCCï¼ˆTry-Confirm-Cancelï¼‰ åŸç† å°†äº‹åŠ¡åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š\nTryé˜¶æ®µï¼š\nå°è¯•æ‰§è¡Œä¸šåŠ¡ å®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ é¢„ç•™å¿…é¡»çš„ä¸šåŠ¡èµ„æº Confirmé˜¶æ®µï¼š\nç¡®è®¤æ‰§è¡Œä¸šåŠ¡ ä¸åšä»»ä½•ä¸šåŠ¡æ£€æŸ¥ åªä½¿ç”¨Tryé˜¶æ®µé¢„ç•™çš„èµ„æº Cancelé˜¶æ®µï¼š\nå–æ¶ˆæ‰§è¡Œä¸šåŠ¡ é‡Šæ”¾Tryé˜¶æ®µé¢„ç•™çš„èµ„æº ä»£ç ç¤ºä¾‹ 1// è®¢å•æœåŠ¡ 2@Service 3public class OrderService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 /** 9 * Tryï¼šåˆ›å»ºè®¢å•ï¼ŒçŠ¶æ€ä¸ºINIT 10 */ 11 @Transactional 12 public Long tryCreateOrder(OrderDTO orderDTO) { 13 Order order = new Order(); 14 order.setUserId(orderDTO.getUserId()); 15 order.setAmount(orderDTO.getAmount()); 16 order.setStatus(OrderStatus.INIT); // åˆå§‹çŠ¶æ€ 17 orderMapper.insert(order); 18 return order.getId(); 19 } 20 21 /** 22 * Confirmï¼šç¡®è®¤è®¢å•ï¼ŒçŠ¶æ€æ”¹ä¸ºSUCCESS 23 */ 24 @Transactional 25 public void confirmOrder(Long orderId) { 26 Order order = orderMapper.selectById(orderId); 27 order.setStatus(OrderStatus.SUCCESS); 28 orderMapper.updateById(order); 29 } 30 31 /** 32 * Cancelï¼šå–æ¶ˆè®¢å•ï¼ŒçŠ¶æ€æ”¹ä¸ºCANCEL 33 */ 34 @Transactional 35 public void cancelOrder(Long orderId) { 36 Order order = orderMapper.selectById(orderId); 37 order.setStatus(OrderStatus.CANCEL); 38 orderMapper.updateById(order); 39 } 40} 41 42// åº“å­˜æœåŠ¡ 43@Service 44public class InventoryService { 45 46 @Autowired 47 private InventoryMapper inventoryMapper; 48 49 /** 50 * Tryï¼šå†»ç»“åº“å­˜ 51 */ 52 @Transactional 53 public void tryDeductInventory(Long productId, Integer quantity) { 54 Inventory inventory = inventoryMapper.selectByProductId(productId); 55 56 // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³ 57 if (inventory.getAvailable() \u0026lt; quantity) { 58 throw new BusinessException(\u0026#34;åº“å­˜ä¸è¶³\u0026#34;); 59 } 60 61 // å†»ç»“åº“å­˜ 62 inventory.setAvailable(inventory.getAvailable() - quantity); 63 inventory.setFrozen(inventory.getFrozen() + quantity); 64 inventoryMapper.updateById(inventory); 65 } 66 67 /** 68 * Confirmï¼šæ‰£å‡å†»ç»“åº“å­˜ 69 */ 70 @Transactional 71 public void confirmDeductInventory(Long productId, Integer quantity) { 72 Inventory inventory = inventoryMapper.selectByProductId(productId); 73 inventory.setFrozen(inventory.getFrozen() - quantity); 74 inventoryMapper.updateById(inventory); 75 } 76 77 /** 78 * Cancelï¼šé‡Šæ”¾å†»ç»“åº“å­˜ 79 */ 80 @Transactional 81 public void cancelDeductInventory(Long productId, Integer quantity) { 82 Inventory inventory = inventoryMapper.selectByProductId(productId); 83 inventory.setAvailable(inventory.getAvailable() + quantity); 84 inventory.setFrozen(inventory.getFrozen() - quantity); 85 inventoryMapper.updateById(inventory); 86 } 87} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nä¸ä¾èµ–èµ„æºç®¡ç†å™¨çš„äº‹åŠ¡æ”¯æŒ æ€§èƒ½è¾ƒå¥½ï¼Œä¸ä¼šé•¿æ—¶é—´é”å®šèµ„æº å¯ä»¥è·¨æ•°æ®åº“ã€è·¨åº”ç”¨ ç¼ºç‚¹ï¼š\nä¸šåŠ¡ä¾µå…¥æ€§å¼ºï¼Œéœ€è¦å®ç°Tryã€Confirmã€Cancelä¸‰ä¸ªæ–¹æ³• å®ç°å¤æ‚ï¼Œéœ€è¦è€ƒè™‘å¹‚ç­‰æ€§ã€ç©ºå›æ»šã€æ‚¬æŒ‚ç­‰é—®é¢˜ Sagaæ¨¡å¼ åŸç† å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°çŸ­äº‹åŠ¡ï¼Œæ¯ä¸ªçŸ­äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿äº‹åŠ¡ã€‚\næ­£å‘æµç¨‹ï¼šT1 â†’ T2 â†’ T3 â†’ \u0026hellip; â†’ Tn\nè¡¥å¿æµç¨‹ï¼šC1 â† C2 â† C3 â† \u0026hellip; â† Cn\nå®ç°æ–¹å¼ 1. äº‹ä»¶é©±åŠ¨ï¼ˆChoreographyï¼‰ï¼š\næ¯ä¸ªæœåŠ¡å®Œæˆåå‘å¸ƒäº‹ä»¶ ä¸‹ä¸€ä¸ªæœåŠ¡ç›‘å¬äº‹ä»¶å¹¶æ‰§è¡Œ 2. å‘½ä»¤åè°ƒï¼ˆOrchestrationï¼‰ï¼š\nä¸­å¤®åè°ƒå™¨æ§åˆ¶æ•´ä¸ªæµç¨‹ åè°ƒå™¨è°ƒç”¨å„ä¸ªæœåŠ¡ ä»£ç ç¤ºä¾‹ 1// Sagaåè°ƒå™¨ 2@Service 3public class OrderSagaOrchestrator { 4 5 @Autowired 6 private OrderService orderService; 7 8 @Autowired 9 private InventoryService inventoryService; 10 11 @Autowired 12 private AccountService accountService; 13 14 public void createOrder(OrderDTO orderDTO) { 15 Long orderId = null; 16 try { 17 // 1. åˆ›å»ºè®¢å• 18 orderId = orderService.createOrder(orderDTO); 19 20 // 2. æ‰£å‡åº“å­˜ 21 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 22 23 // 3. æ‰£å‡ä½™é¢ 24 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 25 26 // 4. å®Œæˆè®¢å• 27 orderService.completeOrder(orderId); 28 29 } catch (Exception e) { 30 // è¡¥å¿æµç¨‹ 31 if (orderId != null) { 32 accountService.refundBalance(orderDTO.getUserId(), orderDTO.getAmount()); 33 inventoryService.restoreInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 34 orderService.cancelOrder(orderId); 35 } 36 throw e; 37 } 38 } 39} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nä¸€é˜¶æ®µæäº¤ï¼Œæ€§èƒ½å¥½ å‚ä¸è€…å¯ä»¥å¼‚æ­¥æ‰§è¡Œ è¡¥å¿æœºåˆ¶çµæ´» ç¼ºç‚¹ï¼š\nä¸ä¿è¯éš”ç¦»æ€§ éœ€è¦è®¾è®¡è¡¥å¿é€»è¾‘ å®ç°å¤æ‚åº¦é«˜ Seataæ¡†æ¶ æ¶æ„ 1åº”ç”¨å±‚ 2 â†“ 3Seata Client (RM + TM) 4 â†“ 5Seata Server (TC) 6 â†“ 7æ•°æ®åº“ ä¸‰ä¸ªè§’è‰²ï¼š\nTC (Transaction Coordinator)ï¼šäº‹åŠ¡åè°ƒå™¨ï¼Œç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ TM (Transaction Manager)ï¼šäº‹åŠ¡ç®¡ç†å™¨ï¼Œå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ RM (Resource Manager)ï¼šèµ„æºç®¡ç†å™¨ï¼Œç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æº ATæ¨¡å¼ Seataçš„é»˜è®¤æ¨¡å¼ï¼ŒåŸºäºæ”¯æŒæœ¬åœ°ACIDäº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“ã€‚\nåŸç†ï¼š\nä¸€é˜¶æ®µï¼šä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—è®°å½•åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æäº¤ äºŒé˜¶æ®µï¼š æäº¤ï¼šå¼‚æ­¥åŒ–ï¼Œå¿«é€Ÿå®Œæˆ å›æ»šï¼šé€šè¿‡å›æ»šæ—¥å¿—è¿›è¡Œåå‘è¡¥å¿ å¿«é€Ÿå¼€å§‹ 1. æ·»åŠ ä¾èµ–ï¼š\n1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;io.seata\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;seata-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;1.7.1\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; 2. é…ç½®Seataï¼š\n1seata: 2 enabled: true 3 application-id: order-service 4 tx-service-group: my_test_tx_group 5 service: 6 vgroup-mapping: 7 my_test_tx_group: default 8 grouplist: 9 default: 127.0.0.1:8091 10 registry: 11 type: nacos 12 nacos: 13 server-addr: 127.0.0.1:8848 14 namespace: public 15 group: SEATA_GROUP 3. åˆ›å»ºundo_logè¡¨ï¼š\n1CREATE TABLE `undo_log` ( 2 `id` bigint(20) NOT NULL AUTO_INCREMENT, 3 `branch_id` bigint(20) NOT NULL, 4 `xid` varchar(100) NOT NULL, 5 `context` varchar(128) NOT NULL, 6 `rollback_info` longblob NOT NULL, 7 `log_status` int(11) NOT NULL, 8 `log_created` datetime NOT NULL, 9 `log_modified` datetime NOT NULL, 10 PRIMARY KEY (`id`), 11 UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`) 12) ENGINE=InnoDB DEFAULT CHARSET=utf8; 4. ä½¿ç”¨@GlobalTransactionalï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 @Autowired 8 private InventoryServiceClient inventoryService; 9 10 @Autowired 11 private AccountServiceClient accountService; 12 13 @GlobalTransactional(name = \u0026#34;create-order\u0026#34;, rollbackFor = Exception.class) 14 public void createOrder(OrderDTO orderDTO) { 15 // 1. åˆ›å»ºè®¢å• 16 Order order = new Order(); 17 order.setUserId(orderDTO.getUserId()); 18 order.setAmount(orderDTO.getAmount()); 19 orderMapper.insert(order); 20 21 // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰ 22 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 23 24 // 3. æ‰£å‡ä½™é¢ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰ 25 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 26 } 27} TCCæ¨¡å¼ Seataä¹Ÿæ”¯æŒTCCæ¨¡å¼ï¼Œéœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š\n1@LocalTCC 2public interface InventoryTccAction { 3 4 @TwoPhaseBusinessAction(name = \u0026#34;deductInventory\u0026#34;, commitMethod = \u0026#34;commit\u0026#34;, rollbackMethod = \u0026#34;rollback\u0026#34;) 5 boolean prepare(BusinessActionContext context, 6 @BusinessActionContextParameter(paramName = \u0026#34;productId\u0026#34;) Long productId, 7 @BusinessActionContextParameter(paramName = \u0026#34;quantity\u0026#34;) Integer quantity); 8 9 boolean commit(BusinessActionContext context); 10 11 boolean rollback(BusinessActionContext context); 12} 13 14@Service 15public class InventoryTccActionImpl implements InventoryTccAction { 16 17 @Override 18 @Transactional 19 public boolean prepare(BusinessActionContext context, Long productId, Integer quantity) { 20 // Tryï¼šå†»ç»“åº“å­˜ 21 inventoryMapper.freezeInventory(productId, quantity); 22 return true; 23 } 24 25 @Override 26 @Transactional 27 public boolean commit(BusinessActionContext context) { 28 // Confirmï¼šæ‰£å‡å†»ç»“åº“å­˜ 29 Long productId = (Long) context.getActionContext(\u0026#34;productId\u0026#34;); 30 Integer quantity = (Integer) context.getActionContext(\u0026#34;quantity\u0026#34;); 31 inventoryMapper.deductFrozenInventory(productId, quantity); 32 return true; 33 } 34 35 @Override 36 @Transactional 37 public boolean rollback(BusinessActionContext context) { 38 // Cancelï¼šé‡Šæ”¾å†»ç»“åº“å­˜ 39 Long productId = (Long) context.getActionContext(\u0026#34;productId\u0026#34;); 40 Integer quantity = (Integer) context.getActionContext(\u0026#34;quantity\u0026#34;); 41 inventoryMapper.releaseFrozenInventory(productId, quantity); 42 return true; 43 } 44} Sagaæ¨¡å¼ Seataçš„Sagaæ¨¡å¼åŸºäºçŠ¶æ€æœºå¼•æ“ï¼š\n1{ 2 \u0026#34;Name\u0026#34;: \u0026#34;CreateOrderSaga\u0026#34;, 3 \u0026#34;Comment\u0026#34;: \u0026#34;åˆ›å»ºè®¢å•Saga\u0026#34;, 4 \u0026#34;StartState\u0026#34;: \u0026#34;CreateOrder\u0026#34;, 5 \u0026#34;States\u0026#34;: { 6 \u0026#34;CreateOrder\u0026#34;: { 7 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 8 \u0026#34;ServiceName\u0026#34;: \u0026#34;orderService\u0026#34;, 9 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;createOrder\u0026#34;, 10 \u0026#34;CompensateState\u0026#34;: \u0026#34;CancelOrder\u0026#34;, 11 \u0026#34;Next\u0026#34;: \u0026#34;DeductInventory\u0026#34; 12 }, 13 \u0026#34;DeductInventory\u0026#34;: { 14 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 15 \u0026#34;ServiceName\u0026#34;: \u0026#34;inventoryService\u0026#34;, 16 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;deductInventory\u0026#34;, 17 \u0026#34;CompensateState\u0026#34;: \u0026#34;RestoreInventory\u0026#34;, 18 \u0026#34;Next\u0026#34;: \u0026#34;DeductBalance\u0026#34; 19 }, 20 \u0026#34;DeductBalance\u0026#34;: { 21 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 22 \u0026#34;ServiceName\u0026#34;: \u0026#34;accountService\u0026#34;, 23 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;deductBalance\u0026#34;, 24 \u0026#34;CompensateState\u0026#34;: \u0026#34;RefundBalance\u0026#34;, 25 \u0026#34;IsEnd\u0026#34;: true 26 }, 27 \u0026#34;CancelOrder\u0026#34;: { 28 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 29 \u0026#34;ServiceName\u0026#34;: \u0026#34;orderService\u0026#34;, 30 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;cancelOrder\u0026#34;, 31 \u0026#34;IsEnd\u0026#34;: true 32 }, 33 \u0026#34;RestoreInventory\u0026#34;: { 34 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 35 \u0026#34;ServiceName\u0026#34;: \u0026#34;inventoryService\u0026#34;, 36 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;restoreInventory\u0026#34;, 37 \u0026#34;Next\u0026#34;: \u0026#34;CancelOrder\u0026#34; 38 }, 39 \u0026#34;RefundBalance\u0026#34;: { 40 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 41 \u0026#34;ServiceName\u0026#34;: \u0026#34;accountService\u0026#34;, 42 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;refundBalance\u0026#34;, 43 \u0026#34;Next\u0026#34;: \u0026#34;RestoreInventory\u0026#34; 44 } 45 } 46} XAæ¨¡å¼ Seataçš„XAæ¨¡å¼æ˜¯å¯¹ä¼ ç»ŸXAåè®®çš„å°è£…ï¼š\n1@GlobalTransactional 2public void createOrderXA(OrderDTO orderDTO) { 3 // XAæ¨¡å¼ä¸‹ï¼ŒSeataä¼šè‡ªåŠ¨ç®¡ç†XAäº‹åŠ¡ 4 // ä¸šåŠ¡ä»£ç ä¸ATæ¨¡å¼ç›¸åŒ 5 orderService.createOrder(orderDTO); 6 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 7 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 8} XA vs ATï¼š\nXAï¼šå¼ºä¸€è‡´æ€§ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œéœ€è¦æ•°æ®åº“æ”¯æŒXAåè®® ATï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½è¾ƒå¥½ï¼ŒåŸºäºæœ¬åœ°äº‹åŠ¡ æ–¹æ¡ˆå¯¹æ¯” æ–¹æ¡ˆ ä¸€è‡´æ€§ æ€§èƒ½ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ 2PC/3PC å¼ºä¸€è‡´ ä½ ä¸­ çŸ­äº‹åŠ¡ï¼Œå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜ TCC æœ€ç»ˆä¸€è‡´ é«˜ é«˜ å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œå¯æ¥å—æœ€ç»ˆä¸€è‡´ Saga æœ€ç»ˆä¸€è‡´ é«˜ ä¸­ é•¿äº‹åŠ¡ï¼Œä¸šåŠ¡æµç¨‹å¤æ‚ Seata AT æœ€ç»ˆä¸€è‡´ ä¸­ ä½ ä¸šåŠ¡ä¾µå…¥å°ï¼Œå¿«é€Ÿæ¥å…¥ Seata TCC æœ€ç»ˆä¸€è‡´ é«˜ é«˜ å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶ Seata XA å¼ºä¸€è‡´ ä½ ä½ éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œæ•°æ®åº“æ”¯æŒXA ç”Ÿäº§å®è·µ 1. å¹‚ç­‰æ€§è®¾è®¡ 1@Service 2public class OrderService { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 6 7 @GlobalTransactional 8 public void createOrder(OrderDTO orderDTO) { 9 String idempotentKey = \u0026#34;order:create:\u0026#34; + orderDTO.getRequestId(); 10 11 // æ£€æŸ¥å¹‚ç­‰æ€§ 12 Boolean success = redisTemplate.opsForValue().setIfAbsent( 13 idempotentKey, \u0026#34;1\u0026#34;, 10, TimeUnit.MINUTES 14 ); 15 16 if (!success) { 17 throw new BusinessException(\u0026#34;é‡å¤è¯·æ±‚\u0026#34;); 18 } 19 20 try { 21 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 22 doCreateOrder(orderDTO); 23 } catch (Exception e) { 24 // åˆ é™¤å¹‚ç­‰é”®ï¼Œå…è®¸é‡è¯• 25 redisTemplate.delete(idempotentKey); 26 throw e; 27 } 28 } 29} 2. è¶…æ—¶æ§åˆ¶ 1@GlobalTransactional( 2 name = \u0026#34;create-order\u0026#34;, 3 timeoutMills = 30000, // 30ç§’è¶…æ—¶ 4 rollbackFor = Exception.class 5) 6public void createOrder(OrderDTO orderDTO) { 7 // ä¸šåŠ¡é€»è¾‘ 8} 3. å¼‚å¸¸å¤„ç† 1@Service 2public class OrderService { 3 4 @GlobalTransactional(rollbackFor = Exception.class) 5 public void createOrder(OrderDTO orderDTO) { 6 try { 7 // ä¸šåŠ¡é€»è¾‘ 8 doCreateOrder(orderDTO); 9 } catch (BusinessException e) { 10 // ä¸šåŠ¡å¼‚å¸¸ï¼Œå›æ»š 11 log.error(\u0026#34;åˆ›å»ºè®¢å•å¤±è´¥ï¼š{}\u0026#34;, e.getMessage()); 12 throw e; 13 } catch (Exception e) { 14 // ç³»ç»Ÿå¼‚å¸¸ï¼Œå›æ»š 15 log.error(\u0026#34;ç³»ç»Ÿå¼‚å¸¸\u0026#34;, e); 16 throw new SystemException(\u0026#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); 17 } 18 } 19} 4. ç›‘æ§å‘Šè­¦ 1@Aspect 2@Component 3public class SeataMonitorAspect { 4 5 @Around(\u0026#34;@annotation(globalTransactional)\u0026#34;) 6 public Object monitor(ProceedingJoinPoint pjp, GlobalTransactional globalTransactional) throws Throwable { 7 String txName = globalTransactional.name(); 8 long startTime = System.currentTimeMillis(); 9 10 try { 11 Object result = pjp.proceed(); 12 long duration = System.currentTimeMillis() - startTime; 13 14 // è®°å½•æˆåŠŸæŒ‡æ ‡ 15 Metrics.counter(\u0026#34;seata.transaction.success\u0026#34;, \u0026#34;name\u0026#34;, txName).increment(); 16 Metrics.timer(\u0026#34;seata.transaction.duration\u0026#34;, \u0026#34;name\u0026#34;, txName).record(duration, TimeUnit.MILLISECONDS); 17 18 return result; 19 } catch (Exception e) { 20 // è®°å½•å¤±è´¥æŒ‡æ ‡ 21 Metrics.counter(\u0026#34;seata.transaction.failure\u0026#34;, \u0026#34;name\u0026#34;, txName).increment(); 22 throw e; 23 } 24 } 25} é¿å‘æç¤ºï¼š åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼ŒåŠ¡å¿…æ³¨æ„ï¼š1) è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼›2) å®ç°å¹‚ç­‰æ€§ï¼›3) åšå¥½ç›‘æ§å‘Šè­¦ï¼›4) å‡†å¤‡é™çº§æ–¹æ¡ˆï¼›5) å®šæœŸæ¸…ç†undo_logè¡¨ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼š\n2PC/3PCï¼šå¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½å·®ï¼Œé€‚åˆçŸ­äº‹åŠ¡ TCCï¼šæ€§èƒ½å¥½ï¼Œä½†å®ç°å¤æ‚ï¼Œé€‚åˆå¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ Sagaï¼šé€‚åˆé•¿äº‹åŠ¡ï¼Œè¡¥å¿æœºåˆ¶çµæ´» Seata ATï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸šåŠ¡ä¾µå…¥å°ï¼Œé€‚åˆå¿«é€Ÿæ¥å…¥ Seata TCCï¼šæ€§èƒ½å¥½ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶ Seata XAï¼šå¼ºä¸€è‡´æ€§ï¼Œå®ç°ç®€å•ï¼Œä½†æ€§èƒ½è¾ƒå·® é€‰æ‹©åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆæ—¶ï¼Œéœ€è¦è€ƒè™‘ï¼š\nä¸€è‡´æ€§è¦æ±‚ï¼šå¼ºä¸€è‡´è¿˜æ˜¯æœ€ç»ˆä¸€è‡´ æ€§èƒ½è¦æ±‚ï¼šèƒ½å¦æ¥å—é˜»å¡å’Œé”å®š ä¸šåŠ¡å¤æ‚åº¦ï¼šäº‹åŠ¡é“¾è·¯é•¿åº¦å’Œå¤æ‚åº¦ å¼€å‘æˆæœ¬ï¼šå®ç°å’Œç»´æŠ¤çš„å¤æ‚åº¦ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå»ºè®®ï¼š\nä¼˜å…ˆè€ƒè™‘ä¸šåŠ¡è®¾è®¡ï¼Œé¿å…åˆ†å¸ƒå¼äº‹åŠ¡ èƒ½ç”¨æœ€ç»ˆä¸€è‡´æ€§å°±ä¸ç”¨å¼ºä¸€è‡´æ€§ Seata ATæ¨¡å¼é€‚åˆå¿«é€Ÿæ¥å…¥ å¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ä½¿ç”¨TCCæˆ–Saga éœ€è¦å¼ºä¸€è‡´æ€§ä¸”æ•°æ®åº“æ”¯æŒXAæ—¶ä½¿ç”¨XAæ¨¡å¼ ä¸‹æ¬¡å½“ä½ éœ€è¦å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œä¸å¦¨æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\n","permalink":"http://localhost:1313/posts/2025/12/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%BB%8E-2pc-%E5%88%B0-seata-%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B8%8E%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œå¾€å¾€éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯è¿™äº›æ“ä½œçš„ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªç»å…¸éš¾é¢˜ã€‚æœ¬æ–‡å°†ç³»ç»Ÿè®²è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒé—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡2PCã€3PCã€TCCã€Sagaç­‰æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨Seataæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜\"\u003eåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"ä¸šåŠ¡åœºæ™¯\"\u003eä¸šåŠ¡åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eç”µå•†ä¸‹å•åœºæ™¯ï¼Œæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eç”¨æˆ·ä¸‹å•\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003eè®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003eåº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003eè´¦æˆ·æœåŠ¡ï¼šæ‰£å‡ä½™é¢\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003eç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ†\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eé—®é¢˜\u003c/strong\u003eï¼šå¦‚æœæŸä¸ªæœåŠ¡å¤±è´¥ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\u003c/p\u003e\n\u003ch3 id=\"capç†è®º\"\u003eCAPç†è®º\u003c/h3\u003e\n\u003cp\u003eåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸‰ä¸ªç‰¹æ€§ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eC (Consistency)\u003c/strong\u003eï¼šä¸€è‡´æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eA (Availability)\u003c/strong\u003eï¼šå¯ç”¨æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eP (Partition Tolerance)\u003c/strong\u003eï¼šåˆ†åŒºå®¹é”™æ€§\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eCAPå®šç†\u003c/strong\u003eï¼šä¸‰è€…æœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤ä¸ª\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå®é™…é€‰æ‹©\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCPï¼šç‰ºç‰²å¯ç”¨æ€§ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ˆå¦‚ZooKeeperï¼‰\u003c/li\u003e\n\u003cli\u003eAPï¼šç‰ºç‰²ä¸€è‡´æ€§ï¼Œä¿è¯å¯ç”¨æ€§ï¼ˆå¦‚Eurekaï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"baseç†è®º\"\u003eBASEç†è®º\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eBA (Basically Available)\u003c/strong\u003eï¼šåŸºæœ¬å¯ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eS (Soft State)\u003c/strong\u003eï¼šè½¯çŠ¶æ€\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eE (Eventually Consistent)\u003c/strong\u003eï¼šæœ€ç»ˆä¸€è‡´æ€§\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¼ºä¸€è‡´æ€§å¾€å¾€éš¾ä»¥å®ç°ä¸”ä»£ä»·é«˜æ˜‚ã€‚å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼Œè¿™ä¹Ÿæ˜¯ç°ä»£åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆçš„åŸºç¡€ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"2pcä¸¤é˜¶æ®µæäº¤\"\u003e2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰\u003c/h2\u003e\n\u003ch3 id=\"åŸç†\"\u003eåŸç†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€Prepareè¯·æ±‚\u003c/li\u003e\n\u003cli\u003eå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤\u003c/li\u003e\n\u003cli\u003eå‚ä¸è€…è¿”å›Yesæˆ–No\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eç¬¬äºŒé˜¶æ®µï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›Yesï¼Œåè°ƒè€…å‘é€Commitè¯·æ±‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœæœ‰å‚ä¸è€…è¿”å›Noï¼Œåè°ƒè€…å‘é€Rollbackè¯·æ±‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"æµç¨‹å›¾\"\u003eæµç¨‹å›¾\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003eåè°ƒè€…                å‚ä¸è€…1              å‚ä¸è€…2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Prepare----------\u0026gt;|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Prepare----------------------------\u0026gt;|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |\u0026lt;--Yes/No------------|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |\u0026lt;--Yes/No-------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Commit/Rollback--\u0026gt;|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Commit/Rollback----------------------\u0026gt;|\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ä»£ç ç¤ºä¾‹\"\u003eä»£ç ç¤ºä¾‹\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eTwoPhaseCommitCoordinator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eexecuteTransaction\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecanCommit\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¬¬äºŒé˜¶æ®µï¼šæäº¤æˆ–å›æ»š\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecanCommit\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e                \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e35\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e36\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e37\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e38\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e39\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e40\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e41\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e42\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e43\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e44\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e45\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ä¼˜ç¼ºç‚¹\"\u003eä¼˜ç¼ºç‚¹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¼˜ç‚¹\u003c/strong\u003eï¼š\u003c/p\u003e","title":"åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼šä» 2PC åˆ° Seata çš„æ¼”è¿›ä¸å®æˆ˜"},{"content":"é˜…è¯»ä¼˜ç§€çš„å¼€æºé¡¹ç›®æºç æ˜¯æå‡æŠ€æœ¯èƒ½åŠ›çš„æœ€ä½³é€”å¾„ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œé¢å¯¹åŠ¨è¾„å‡ åä¸‡è¡Œçš„ä»£ç ï¼Œå¾ˆå¤šäººä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹ã€‚æœ¬æ–‡å°†ä»¥Spring Bootä¸ºä¾‹ï¼Œç³»ç»Ÿè®²è§£å¦‚ä½•é«˜æ•ˆåœ°é˜…è¯»å’Œå­¦ä¹ å¼€æºé¡¹ç›®æºç ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æºç é˜…è¯»çš„ç³»ç»Ÿæ–¹æ³•è®º å­¦ä¼šä½¿ç”¨å·¥å…·è¾…åŠ©æºç é˜…è¯» ç†è§£Spring Bootçš„æ ¸å¿ƒè®¾è®¡æ€æƒ³ æŒæ¡ä»å®è§‚åˆ°å¾®è§‚çš„é˜…è¯»ç­–ç•¥ å»ºç«‹æºç å­¦ä¹ çš„é•¿æ•ˆæœºåˆ¶ ä¸ºä»€ä¹ˆè¦è¯»æºç  æºç é˜…è¯»çš„ä»·å€¼ æ·±å…¥ç†è§£åŸç†ï¼šçŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶ å­¦ä¹ è®¾è®¡æ¨¡å¼ï¼šçœ‹å¤§å¸ˆå¦‚ä½•è®¾è®¡æ¶æ„ æå‡ç¼–ç èƒ½åŠ›ï¼šå­¦ä¹ ä¼˜ç§€çš„ä»£ç é£æ ¼ è§£å†³ç–‘éš¾é—®é¢˜ï¼šé‡åˆ°é—®é¢˜èƒ½å¿«é€Ÿå®šä½ å‚ä¸å¼€æºè´¡çŒ®ï¼šä¸ºå¼€æºç¤¾åŒºåšè´¡çŒ® å¸¸è§è¯¯åŒº âŒ ä»ç¬¬ä¸€è¡Œå¼€å§‹è¯»ï¼šå®¹æ˜“è¿·å¤±åœ¨ç»†èŠ‚ä¸­ âŒ è¿½æ±‚å®Œå…¨ç†è§£ï¼šè¯•å›¾ç†è§£æ¯ä¸€è¡Œä»£ç  âŒ æ²¡æœ‰ç›®æ ‡ï¼šæ¼«æ— ç›®çš„åœ°æµè§ˆä»£ç  âŒ åªçœ‹ä¸ç»ƒï¼šåªçœ‹ä¸å†™ï¼Œæ— æ³•çœŸæ­£æŒæ¡\nâœ… å¸¦ç€é—®é¢˜è¯»ï¼šå›´ç»•å…·ä½“é—®é¢˜å±•å¼€ âœ… æŠ“ä½ä¸»çº¿ï¼šç†è§£æ ¸å¿ƒæµç¨‹å’Œè®¾è®¡æ€æƒ³ âœ… å¾ªåºæ¸è¿›ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥ âœ… è¾¹è¯»è¾¹å†™ï¼šé€šè¿‡å®è·µåŠ æ·±ç†è§£\næ¶æ„æ€è€ƒï¼š é˜…è¯»æºç ä¸æ˜¯ä¸ºäº†è®°ä½æ¯ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯ç†è§£è®¾è®¡æ€æƒ³å’Œæ¶æ„æ¨¡å¼ã€‚è¦å­¦ä¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œä»æ•´ä½“åˆ°ç»†èŠ‚çš„é˜…è¯»æ–¹æ³•ã€‚\næºç é˜…è¯»æ–¹æ³•è®º 1. å‡†å¤‡é˜¶æ®µ é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼š\né€‰æ‹©ç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚Spring Boot 2.7.xï¼‰ é¿å…é€‰æ‹©æœ€æ–°çš„å¼€å‘ç‰ˆæœ¬ æŸ¥çœ‹ç‰ˆæœ¬çš„Release Notes æ­å»ºè°ƒè¯•ç¯å¢ƒï¼š\n1# 1. å…‹éš†æºç  2git clone https://github.com/spring-projects/spring-boot.git 3cd spring-boot 4 5# 2. åˆ‡æ¢åˆ°ç¨³å®šç‰ˆæœ¬ 6git checkout v2.7.18 7 8# 3. å¯¼å…¥IDEï¼ˆIDEAï¼‰ 9# File -\u0026gt; Open -\u0026gt; é€‰æ‹©spring-bootç›®å½• å‡†å¤‡ç¤ºä¾‹é¡¹ç›®ï¼š\n1\u0026lt;!-- pom.xml --\u0026gt; 2\u0026lt;parent\u0026gt; 3 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 4 \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; 5 \u0026lt;version\u0026gt;2.7.18\u0026lt;/version\u0026gt; 6\u0026lt;/parent\u0026gt; 7 8\u0026lt;dependencies\u0026gt; 9 \u0026lt;dependency\u0026gt; 10 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 11 \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; 12 \u0026lt;/dependency\u0026gt; 13\u0026lt;/dependencies\u0026gt; 2. å®è§‚é˜¶æ®µ äº†è§£é¡¹ç›®ç»“æ„ï¼š\n1spring-boot/ 2â”œâ”€â”€ spring-boot-project/ 3â”‚ â”œâ”€â”€ spring-boot/ # æ ¸å¿ƒæ¨¡å— 4â”‚ â”œâ”€â”€ spring-boot-autoconfigure/ # è‡ªåŠ¨é…ç½® 5â”‚ â”œâ”€â”€ spring-boot-starters/ # Starterä¾èµ– 6â”‚ â”œâ”€â”€ spring-boot-actuator/ # ç›‘æ§ç«¯ç‚¹ 7â”‚ â””â”€â”€ spring-boot-test/ # æµ‹è¯•æ”¯æŒ 8â”œâ”€â”€ spring-boot-samples/ # ç¤ºä¾‹é¡¹ç›® 9â””â”€â”€ spring-boot-tests/ # é›†æˆæµ‹è¯• é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼š\nSpring Boot Reference Documentation äº†è§£æ ¸å¿ƒç‰¹æ€§å’Œä½¿ç”¨æ–¹å¼ ç†è§£è®¾è®¡ç†å¿µå’Œæ¶æ„æ€æƒ³ ç»˜åˆ¶æ¶æ„å›¾ï¼š\n1åº”ç”¨å¯åŠ¨ 2 â†“ 3@SpringBootApplication 4 â†“ 5SpringApplication.run() 6 â†“ 7åˆ›å»ºApplicationContext 8 â†“ 9è‡ªåŠ¨é…ç½®ï¼ˆAutoConfigurationï¼‰ 10 â†“ 11å¯åŠ¨å†…åµŒWebæœåŠ¡å™¨ 12 â†“ 13åº”ç”¨å°±ç»ª 3. å¾®è§‚é˜¶æ®µ é€‰æ‹©åˆ‡å…¥ç‚¹ï¼š\nä»æœ€å¸¸ç”¨çš„åŠŸèƒ½å¼€å§‹ï¼ˆå¦‚å¯åŠ¨æµç¨‹ï¼‰ ä»é‡åˆ°çš„é—®é¢˜å¼€å§‹ï¼ˆå¦‚è‡ªåŠ¨é…ç½®åŸç†ï¼‰ ä»æ„Ÿå…´è¶£çš„ç‰¹æ€§å¼€å§‹ï¼ˆå¦‚æ¡ä»¶æ³¨è§£ï¼‰ ä½¿ç”¨è°ƒè¯•å·¥å…·ï¼š\næ–­ç‚¹è°ƒè¯•ï¼šè§‚å¯Ÿæ‰§è¡Œæµç¨‹ è°ƒç”¨æ ˆï¼šç†è§£æ–¹æ³•è°ƒç”¨å…³ç³» å˜é‡ç›‘è§†ï¼šæŸ¥çœ‹å¯¹è±¡çŠ¶æ€ Spring Boot å¯åŠ¨æµç¨‹åˆ†æ å…¥å£ï¼š@SpringBootApplication 1@SpringBootApplication 2public class DemoApplication { 3 public static void main(String[] args) { 4 SpringApplication.run(DemoApplication.class, args); 5 } 6} @SpringBootApplication æ³¨è§£ï¼š\n1@Target(ElementType.TYPE) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4@Inherited 5@SpringBootConfiguration // 1. é…ç½®ç±» 6@EnableAutoConfiguration // 2. è‡ªåŠ¨é…ç½® 7@ComponentScan // 3. ç»„ä»¶æ‰«æ 8public @interface SpringBootApplication { 9 // ... 10} ä¸‰ä¸ªæ ¸å¿ƒæ³¨è§£ï¼š\n@SpringBootConfigurationï¼šæ ‡è®°ä¸ºé…ç½®ç±» @EnableAutoConfigurationï¼šå¯ç”¨è‡ªåŠ¨é…ç½® @ComponentScanï¼šæ‰«æç»„ä»¶ SpringApplication.run() æµç¨‹ 1public class SpringApplication { 2 3 public static ConfigurableApplicationContext run(Class\u0026lt;?\u0026gt; primarySource, String... args) { 4 return run(new Class\u0026lt;?\u0026gt;[] { primarySource }, args); 5 } 6 7 public static ConfigurableApplicationContext run(Class\u0026lt;?\u0026gt;[] primarySources, String[] args) { 8 // åˆ›å»ºSpringApplicationå®ä¾‹å¹¶è¿è¡Œ 9 return new SpringApplication(primarySources).run(args); 10 } 11 12 public ConfigurableApplicationContext run(String... args) { 13 // 1. åˆ›å»ºStopWatchï¼Œè®°å½•å¯åŠ¨æ—¶é—´ 14 StopWatch stopWatch = new StopWatch(); 15 stopWatch.start(); 16 17 // 2. åˆ›å»ºBootstrapä¸Šä¸‹æ–‡ 18 DefaultBootstrapContext bootstrapContext = createBootstrapContext(); 19 ConfigurableApplicationContext context = null; 20 21 // 3. é…ç½®Headlesså±æ€§ 22 configureHeadlessProperty(); 23 24 // 4. è·å–SpringApplicationRunListeners 25 SpringApplicationRunListeners listeners = getRunListeners(args); 26 listeners.starting(bootstrapContext, this.mainApplicationClass); 27 28 try { 29 // 5. å‡†å¤‡ç¯å¢ƒ 30 ApplicationArguments applicationArguments = new DefaultApplicationArguments(args); 31 ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments); 32 33 // 6. æ‰“å°Banner 34 Banner printedBanner = printBanner(environment); 35 36 // 7. åˆ›å»ºApplicationContext 37 context = createApplicationContext(); 38 context.setApplicationStartup(this.applicationStartup); 39 40 // 8. å‡†å¤‡Context 41 prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner); 42 43 // 9. åˆ·æ–°Contextï¼ˆæ ¸å¿ƒï¼‰ 44 refreshContext(context); 45 46 // 10. åˆ·æ–°åå¤„ç† 47 afterRefresh(context, applicationArguments); 48 49 stopWatch.stop(); 50 51 // 11. å‘å¸ƒå¯åŠ¨å®Œæˆäº‹ä»¶ 52 listeners.started(context); 53 54 // 12. è°ƒç”¨Runners 55 callRunners(context, applicationArguments); 56 } 57 catch (Throwable ex) { 58 handleRunFailure(context, ex, listeners); 59 throw new IllegalStateException(ex); 60 } 61 62 try { 63 listeners.running(context); 64 } 65 catch (Throwable ex) { 66 handleRunFailure(context, ex, null); 67 throw new IllegalStateException(ex); 68 } 69 70 return context; 71 } 72} å¯åŠ¨æµç¨‹å›¾ï¼š\n11. åˆ›å»ºStopWatch 2 â†“ 32. åˆ›å»ºBootstrapä¸Šä¸‹æ–‡ 4 â†“ 53. è·å–RunListeners 6 â†“ 74. å‡†å¤‡Environment 8 â†“ 95. æ‰“å°Banner 10 â†“ 116. åˆ›å»ºApplicationContext 12 â†“ 137. å‡†å¤‡Context 14 â†“ 158. åˆ·æ–°Contextï¼ˆåŠ è½½Beanï¼‰ 16 â†“ 179. è°ƒç”¨Runners 18 â†“ 1910. å‘å¸ƒå¯åŠ¨å®Œæˆäº‹ä»¶ è‡ªåŠ¨é…ç½®åŸç† @EnableAutoConfiguration 1@Target(ElementType.TYPE) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4@Inherited 5@AutoConfigurationPackage 6@Import(AutoConfigurationImportSelector.class) // æ ¸å¿ƒ 7public @interface EnableAutoConfiguration { 8 // ... 9} AutoConfigurationImportSelector 1public class AutoConfigurationImportSelector implements DeferredImportSelector { 2 3 @Override 4 public String[] selectImports(AnnotationMetadata annotationMetadata) { 5 if (!isEnabled(annotationMetadata)) { 6 return NO_IMPORTS; 7 } 8 9 // 1. è·å–è‡ªåŠ¨é…ç½®ç±» 10 AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(annotationMetadata); 11 return StringUtils.toStringArray(autoConfigurationEntry.getConfigurations()); 12 } 13 14 protected AutoConfigurationEntry getAutoConfigurationEntry(AnnotationMetadata annotationMetadata) { 15 if (!isEnabled(annotationMetadata)) { 16 return EMPTY_ENTRY; 17 } 18 19 AnnotationAttributes attributes = getAttributes(annotationMetadata); 20 21 // 2. åŠ è½½å€™é€‰é…ç½®ç±» 22 List\u0026lt;String\u0026gt; configurations = getCandidateConfigurations(annotationMetadata, attributes); 23 24 // 3. å»é‡ 25 configurations = removeDuplicates(configurations); 26 27 // 4. æ’é™¤æŒ‡å®šçš„é…ç½®ç±» 28 Set\u0026lt;String\u0026gt; exclusions = getExclusions(annotationMetadata, attributes); 29 checkExcludedClasses(configurations, exclusions); 30 configurations.removeAll(exclusions); 31 32 // 5. è¿‡æ»¤ï¼ˆæ ¹æ®æ¡ä»¶æ³¨è§£ï¼‰ 33 configurations = getConfigurationClassFilter().filter(configurations); 34 35 // 6. è§¦å‘è‡ªåŠ¨é…ç½®å¯¼å…¥äº‹ä»¶ 36 fireAutoConfigurationImportEvents(configurations, exclusions); 37 38 return new AutoConfigurationEntry(configurations, exclusions); 39 } 40 41 protected List\u0026lt;String\u0026gt; getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) { 42 // ä»META-INF/spring.factoriesåŠ è½½é…ç½®ç±» 43 List\u0026lt;String\u0026gt; configurations = SpringFactoriesLoader.loadFactoryNames( 44 getSpringFactoriesLoaderFactoryClass(), 45 getBeanClassLoader() 46 ); 47 return configurations; 48 } 49} spring.factories 1# spring-boot-autoconfigure/META-INF/spring.factories 2 3org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 4org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\\ 5org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\\ 6org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\\ 7org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\\ 8org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration,\\ 9... è‡ªåŠ¨é…ç½®ç¤ºä¾‹ 1@Configuration(proxyBeanMethods = false) 2@ConditionalOnClass({ DataSource.class, EmbeddedDatabaseType.class }) 3@ConditionalOnMissingBean(type = \u0026#34;io.r2dbc.spi.ConnectionFactory\u0026#34;) 4@EnableConfigurationProperties(DataSourceProperties.class) 5@Import({ DataSourcePoolMetadataProvidersConfiguration.class }) 6public class DataSourceAutoConfiguration { 7 8 @Configuration(proxyBeanMethods = false) 9 @Conditional(EmbeddedDatabaseCondition.class) 10 @ConditionalOnMissingBean({ DataSource.class, XADataSource.class }) 11 @Import(EmbeddedDataSourceConfiguration.class) 12 protected static class EmbeddedDatabaseConfiguration { 13 } 14 15 @Configuration(proxyBeanMethods = false) 16 @Conditional(PooledDataSourceCondition.class) 17 @ConditionalOnMissingBean({ DataSource.class, XADataSource.class }) 18 @Import({ DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class, 19 DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.OracleUcp.class, 20 DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class }) 21 protected static class PooledDataSourceConfiguration { 22 } 23} æ¡ä»¶æ³¨è§£ï¼š\n@ConditionalOnClassï¼šç±»è·¯å¾„å­˜åœ¨æŒ‡å®šç±» @ConditionalOnMissingBeanï¼šå®¹å™¨ä¸­ä¸å­˜åœ¨æŒ‡å®šBean @ConditionalOnPropertyï¼šé…ç½®æ–‡ä»¶å­˜åœ¨æŒ‡å®šå±æ€§ æ¡ä»¶æ³¨è§£åŸç† @Conditional 1@Target({ ElementType.TYPE, ElementType.METHOD }) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4public @interface Conditional { 5 Class\u0026lt;? extends Condition\u0026gt;[] value(); 6} Conditionæ¥å£ 1@FunctionalInterface 2public interface Condition { 3 boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata); 4} OnClassConditionå®ç° 1@Order(Ordered.HIGHEST_PRECEDENCE) 2class OnClassCondition extends FilteringSpringBootCondition { 3 4 @Override 5 public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) { 6 ClassLoader classLoader = context.getClassLoader(); 7 ConditionMessage matchMessage = ConditionMessage.empty(); 8 9 // è·å–@ConditionalOnClassæ³¨è§£çš„value 10 List\u0026lt;String\u0026gt; onClasses = getCandidates(metadata, ConditionalOnClass.class); 11 if (onClasses != null) { 12 // æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨ 13 List\u0026lt;String\u0026gt; missing = filter(onClasses, ClassNameFilter.MISSING, classLoader); 14 if (!missing.isEmpty()) { 15 return ConditionOutcome.noMatch( 16 ConditionMessage.forCondition(ConditionalOnClass.class) 17 .didNotFind(\u0026#34;required class\u0026#34;, \u0026#34;required classes\u0026#34;) 18 .items(Style.QUOTE, missing) 19 ); 20 } 21 matchMessage = matchMessage.andCondition(ConditionalOnClass.class) 22 .found(\u0026#34;required class\u0026#34;, \u0026#34;required classes\u0026#34;) 23 .items(Style.QUOTE, filter(onClasses, ClassNameFilter.PRESENT, classLoader)); 24 } 25 26 // è·å–@ConditionalOnMissingClassæ³¨è§£çš„value 27 List\u0026lt;String\u0026gt; onMissingClasses = getCandidates(metadata, ConditionalOnMissingClass.class); 28 if (onMissingClasses != null) { 29 // æ£€æŸ¥ç±»æ˜¯å¦ä¸å­˜åœ¨ 30 List\u0026lt;String\u0026gt; present = filter(onMissingClasses, ClassNameFilter.PRESENT, classLoader); 31 if (!present.isEmpty()) { 32 return ConditionOutcome.noMatch( 33 ConditionMessage.forCondition(ConditionalOnMissingClass.class) 34 .found(\u0026#34;unwanted class\u0026#34;, \u0026#34;unwanted classes\u0026#34;) 35 .items(Style.QUOTE, present) 36 ); 37 } 38 matchMessage = matchMessage.andCondition(ConditionalOnMissingClass.class) 39 .didNotFind(\u0026#34;unwanted class\u0026#34;, \u0026#34;unwanted classes\u0026#34;) 40 .items(Style.QUOTE, filter(onMissingClasses, ClassNameFilter.MISSING, classLoader)); 41 } 42 43 return ConditionOutcome.match(matchMessage); 44 } 45} æºç é˜…è¯»æŠ€å·§ 1. ä½¿ç”¨IDEAè°ƒè¯• è®¾ç½®æ–­ç‚¹ï¼š\n1// åœ¨å…³é”®æ–¹æ³•è®¾ç½®æ–­ç‚¹ 2public ConfigurableApplicationContext run(String... args) { 3 // æ–­ç‚¹1ï¼šå¯åŠ¨å…¥å£ 4 StopWatch stopWatch = new StopWatch(); 5 stopWatch.start(); 6 7 // æ–­ç‚¹2ï¼šåˆ›å»ºContext 8 context = createApplicationContext(); 9 10 // æ–­ç‚¹3ï¼šåˆ·æ–°Context 11 refreshContext(context); 12 13 return context; 14} æŸ¥çœ‹è°ƒç”¨æ ˆï¼š\nä½¿ç”¨Ctrl+Alt+HæŸ¥çœ‹æ–¹æ³•è°ƒç”¨å±‚æ¬¡ ä½¿ç”¨Alt+F7æŸ¥æ‰¾æ–¹æ³•ä½¿ç”¨ä½ç½® æ¡ä»¶æ–­ç‚¹ï¼š\n1// åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è§¦å‘æ–­ç‚¹ 2if (beanName.equals(\u0026#34;dataSource\u0026#34;)) { 3 // æ–­ç‚¹ï¼šåªåœ¨åˆ›å»ºdataSourceæ—¶è§¦å‘ 4} 2. ç»˜åˆ¶æµç¨‹å›¾ ä½¿ç”¨å·¥å…·ç»˜åˆ¶å…³é”®æµç¨‹ï¼š\nDraw.io PlantUML Mermaid 1sequenceDiagram 2 participant Main 3 participant SpringApplication 4 participant Context 5 participant AutoConfig 6 7 Main-\u0026gt;\u0026gt;SpringApplication: run() 8 SpringApplication-\u0026gt;\u0026gt;Context: createApplicationContext() 9 SpringApplication-\u0026gt;\u0026gt;AutoConfig: loadAutoConfiguration() 10 AutoConfig-\u0026gt;\u0026gt;Context: registerBeans() 11 SpringApplication-\u0026gt;\u0026gt;Context: refresh() 12 Context--\u0026gt;\u0026gt;Main: ApplicationContext 3. åšç¬”è®° è®°å½•å…³é”®ç‚¹ï¼š\næ ¸å¿ƒç±»å’Œæ¥å£ è®¾è®¡æ¨¡å¼çš„åº”ç”¨ å·§å¦™çš„å®ç°æŠ€å·§ ç–‘é—®å’Œå¾…ç ”ç©¶çš„é—®é¢˜ ç¤ºä¾‹ç¬”è®°ï¼š\n1## SpringApplicationå¯åŠ¨æµç¨‹ 2 3### æ ¸å¿ƒæ–¹æ³• 4- `run(String... args)`: å¯åŠ¨å…¥å£ 5- `prepareEnvironment()`: å‡†å¤‡ç¯å¢ƒ 6- `createApplicationContext()`: åˆ›å»ºä¸Šä¸‹æ–‡ 7- `refreshContext()`: åˆ·æ–°ä¸Šä¸‹æ–‡ 8 9### è®¾è®¡æ¨¡å¼ 10- æ¨¡æ¿æ–¹æ³•ï¼šrun()æ–¹æ³•å®šä¹‰æµç¨‹ï¼Œå­ç±»å¯æ‰©å±• 11- ç­–ç•¥æ¨¡å¼ï¼šApplicationContextFactoryåˆ›å»ºä¸åŒç±»å‹çš„Context 12- è§‚å¯Ÿè€…æ¨¡å¼ï¼šSpringApplicationRunListenersç›‘å¬å¯åŠ¨äº‹ä»¶ 13 14### ç–‘é—® 15- [ ] Environmentæ˜¯å¦‚ä½•åŠ è½½é…ç½®æ–‡ä»¶çš„ï¼Ÿ 16- [ ] Beançš„å¾ªç¯ä¾èµ–æ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ 4. å†™æµ‹è¯•ä»£ç  éªŒè¯ç†è§£ï¼š\n1@Test 2public void testAutoConfiguration() { 3 // 1. åˆ›å»ºAnnotationConfigApplicationContext 4 AnnotationConfigApplicationContext context = 5 new AnnotationConfigApplicationContext(); 6 7 // 2. æ³¨å†Œé…ç½®ç±» 8 context.register(DataSourceAutoConfiguration.class); 9 10 // 3. åˆ·æ–°å®¹å™¨ 11 context.refresh(); 12 13 // 4. éªŒè¯Beanæ˜¯å¦åˆ›å»º 14 DataSource dataSource = context.getBean(DataSource.class); 15 assertNotNull(dataSource); 16} æ¨¡ä»¿å®ç°ï¼š\n1// æ¨¡ä»¿Spring Bootçš„æ¡ä»¶æ³¨è§£ 2@Target({ ElementType.TYPE, ElementType.METHOD }) 3@Retention(RetentionPolicy.RUNTIME) 4@Conditional(OnMyClassCondition.class) 5public @interface ConditionalOnMyClass { 6 String value(); 7} 8 9public class OnMyClassCondition implements Condition { 10 @Override 11 public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) { 12 Map\u0026lt;String, Object\u0026gt; attributes = metadata.getAnnotationAttributes( 13 ConditionalOnMyClass.class.getName() 14 ); 15 String className = (String) attributes.get(\u0026#34;value\u0026#34;); 16 17 try { 18 Class.forName(className); 19 return true; 20 } catch (ClassNotFoundException e) { 21 return false; 22 } 23 } 24} å­¦ä¹ è·¯å¾„å»ºè®® åˆçº§é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰ ç›®æ ‡ï¼šç†è§£Spring Bootçš„åŸºæœ¬ä½¿ç”¨å’Œæ ¸å¿ƒæ¦‚å¿µ\né˜…è¯»å®˜æ–¹æ–‡æ¡£ è¿è¡Œç¤ºä¾‹é¡¹ç›® ç†è§£@SpringBootApplicationæ³¨è§£ äº†è§£è‡ªåŠ¨é…ç½®çš„åŸºæœ¬åŸç† æ¨èé˜…è¯»ï¼š\nSpringApplication.java @SpringBootApplicationç›¸å…³æ³¨è§£ ç®€å•çš„AutoConfigurationç±» ä¸­çº§é˜¶æ®µï¼ˆ2-4å‘¨ï¼‰ ç›®æ ‡ï¼šæ·±å…¥ç†è§£å¯åŠ¨æµç¨‹å’Œè‡ªåŠ¨é…ç½®æœºåˆ¶\nè°ƒè¯•å¯åŠ¨æµç¨‹ åˆ†æAutoConfigurationImportSelector ç ”ç©¶æ¡ä»¶æ³¨è§£çš„å®ç° å­¦ä¹ å¸¸ç”¨çš„AutoConfiguration æ¨èé˜…è¯»ï¼š\nSpringApplication.run()å®Œæ•´æµç¨‹ AutoConfigurationImportSelector.java OnClassCondition.java DataSourceAutoConfiguration.java WebMvcAutoConfiguration.java é«˜çº§é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ ç›®æ ‡ï¼šæŒæ¡Spring Bootçš„è®¾è®¡æ€æƒ³å’Œæ‰©å±•æœºåˆ¶\nç ”ç©¶SPIæœºåˆ¶ï¼ˆSpringFactoriesLoaderï¼‰ åˆ†æApplicationContextçš„åˆ›å»ºå’Œåˆ·æ–° å­¦ä¹ Actuatorçš„å®ç° ç ”ç©¶Spring Bootçš„æµ‹è¯•æ”¯æŒ æ¨èé˜…è¯»ï¼š\nSpringFactoriesLoader.java ConfigurableApplicationContextç›¸å…³ç±» spring-boot-actuatoræ¨¡å— spring-boot-testæ¨¡å— ä¸“å®¶é˜¶æ®µï¼ˆæŒç»­å­¦ä¹ ï¼‰ ç›®æ ‡ï¼šå‚ä¸å¼€æºè´¡çŒ®ï¼Œæ·±åº¦å®šåˆ¶Spring Boot\né˜…è¯»Issueå’ŒPR å‚ä¸ç¤¾åŒºè®¨è®º æäº¤Bugä¿®å¤æˆ–æ–°ç‰¹æ€§ å¼€å‘è‡ªå®šä¹‰Starter å®æˆ˜ï¼šå¼€å‘è‡ªå®šä¹‰Starter 1. åˆ›å»ºStarteré¡¹ç›® 1\u0026lt;!-- my-spring-boot-starter/pom.xml --\u0026gt; 2\u0026lt;dependencies\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;spring-boot-autoconfigure\u0026lt;/artifactId\u0026gt; 6 \u0026lt;/dependency\u0026gt; 7 \u0026lt;dependency\u0026gt; 8 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 9 \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; 10 \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; 11 \u0026lt;/dependency\u0026gt; 12\u0026lt;/dependencies\u0026gt; 2. å®šä¹‰é…ç½®å±æ€§ 1@ConfigurationProperties(prefix = \u0026#34;my.service\u0026#34;) 2public class MyServiceProperties { 3 4 private String name = \u0026#34;default\u0026#34;; 5 private int timeout = 3000; 6 7 // getters and setters 8} 3. åˆ›å»ºè‡ªåŠ¨é…ç½®ç±» 1@Configuration 2@ConditionalOnClass(MyService.class) 3@EnableConfigurationProperties(MyServiceProperties.class) 4public class MyServiceAutoConfiguration { 5 6 @Bean 7 @ConditionalOnMissingBean 8 public MyService myService(MyServiceProperties properties) { 9 return new MyService(properties.getName(), properties.getTimeout()); 10 } 11} 4. æ³¨å†Œè‡ªåŠ¨é…ç½® 1# META-INF/spring.factories 2org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 3com.example.MyServiceAutoConfiguration 5. ä½¿ç”¨Starter 1\u0026lt;!-- åº”ç”¨é¡¹ç›®çš„pom.xml --\u0026gt; 2\u0026lt;dependency\u0026gt; 3 \u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt; 4 \u0026lt;artifactId\u0026gt;my-spring-boot-starter\u0026lt;/artifactId\u0026gt; 5 \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; 6\u0026lt;/dependency\u0026gt; 1# application.yml 2my: 3 service: 4 name: my-service 5 timeout: 5000 1@SpringBootApplication 2public class Application { 3 4 @Autowired 5 private MyService myService; // è‡ªåŠ¨æ³¨å…¥ 6 7 public static void main(String[] args) { 8 SpringApplication.run(Application.class, args); 9 } 10} æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡ç³»ç»Ÿè®²è§£äº†å¦‚ä½•é˜…è¯»å¼€æºé¡¹ç›®æºç ï¼Œä»¥Spring Bootä¸ºä¾‹ï¼š\næ–¹æ³•è®ºï¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œå¸¦ç€é—®é¢˜è¯»æºç  å¯åŠ¨æµç¨‹ï¼šç†è§£SpringApplication.run()çš„å®Œæ•´æµç¨‹ è‡ªåŠ¨é…ç½®ï¼šæŒæ¡@EnableAutoConfigurationçš„å®ç°åŸç† æ¡ä»¶æ³¨è§£ï¼šå­¦ä¹ @Conditionalçš„è®¾è®¡å’Œå®ç° å­¦ä¹ è·¯å¾„ï¼šä»åˆçº§åˆ°ä¸“å®¶çš„è¿›é˜¶è·¯çº¿ å®æˆ˜ç»ƒä¹ ï¼šå¼€å‘è‡ªå®šä¹‰Starterå·©å›ºç†è§£ é˜…è¯»æºç çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nç›®æ ‡æ˜ç¡®ï¼šå¸¦ç€é—®é¢˜å’Œç›®æ ‡å»è¯» å¾ªåºæ¸è¿›ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥ åŠ¨æ‰‹å®è·µï¼šé€šè¿‡è°ƒè¯•å’Œç¼–ç åŠ æ·±ç†è§£ æŒç»­å­¦ä¹ ï¼šæºç é˜…è¯»æ˜¯ä¸€ä¸ªé•¿æœŸè¿‡ç¨‹ æ¨èçš„å­¦ä¹ èµ„æºï¼š\nSpring Bootå®˜æ–¹æ–‡æ¡£ Spring Bootæºç  Spring Frameworkæºç  ä¸‹æ¬¡å½“ä½ æƒ³æ·±å…¥å­¦ä¹ ä¸€ä¸ªå¼€æºé¡¹ç›®æ—¶ï¼Œä¸å¦¨æŒ‰ç…§æœ¬æ–‡çš„æ–¹æ³•ï¼Œç³»ç»Ÿæ€§åœ°é˜…è¯»å’Œå­¦ä¹ ã€‚è®°ä½ï¼Œæºç é˜…è¯»ä¸æ˜¯ç›®çš„ï¼Œç†è§£è®¾è®¡æ€æƒ³å’Œæå‡ç¼–ç èƒ½åŠ›æ‰æ˜¯æœ€ç»ˆç›®æ ‡ã€‚\n","permalink":"http://localhost:1313/posts/2025/11/%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E4%BB%A5-spring-boot-%E4%B8%BA%E4%BE%8B/","summary":"\u003cp\u003eé˜…è¯»ä¼˜ç§€çš„å¼€æºé¡¹ç›®æºç æ˜¯æå‡æŠ€æœ¯èƒ½åŠ›çš„æœ€ä½³é€”å¾„ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œé¢å¯¹åŠ¨è¾„å‡ åä¸‡è¡Œçš„ä»£ç ï¼Œå¾ˆå¤šäººä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹ã€‚æœ¬æ–‡å°†ä»¥Spring Bootä¸ºä¾‹ï¼Œç³»ç»Ÿè®²è§£å¦‚ä½•é«˜æ•ˆåœ°é˜…è¯»å’Œå­¦ä¹ å¼€æºé¡¹ç›®æºç ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æºç é˜…è¯»çš„ç³»ç»Ÿæ–¹æ³•è®º\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å·¥å…·è¾…åŠ©æºç é˜…è¯»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£Spring Bootçš„æ ¸å¿ƒè®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ä»å®è§‚åˆ°å¾®è§‚çš„é˜…è¯»ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹æºç å­¦ä¹ çš„é•¿æ•ˆæœºåˆ¶\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆè¦è¯»æºç \"\u003eä¸ºä»€ä¹ˆè¦è¯»æºç \u003c/h2\u003e\n\u003ch3 id=\"æºç é˜…è¯»çš„ä»·å€¼\"\u003eæºç é˜…è¯»çš„ä»·å€¼\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæ·±å…¥ç†è§£åŸç†\u003c/strong\u003eï¼šçŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå­¦ä¹ è®¾è®¡æ¨¡å¼\u003c/strong\u003eï¼šçœ‹å¤§å¸ˆå¦‚ä½•è®¾è®¡æ¶æ„\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæå‡ç¼–ç èƒ½åŠ›\u003c/strong\u003eï¼šå­¦ä¹ ä¼˜ç§€çš„ä»£ç é£æ ¼\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè§£å†³ç–‘éš¾é—®é¢˜\u003c/strong\u003eï¼šé‡åˆ°é—®é¢˜èƒ½å¿«é€Ÿå®šä½\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå‚ä¸å¼€æºè´¡çŒ®\u003c/strong\u003eï¼šä¸ºå¼€æºç¤¾åŒºåšè´¡çŒ®\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"å¸¸è§è¯¯åŒº\"\u003eå¸¸è§è¯¯åŒº\u003c/h3\u003e\n\u003cp\u003eâŒ \u003cstrong\u003eä»ç¬¬ä¸€è¡Œå¼€å§‹è¯»\u003c/strong\u003eï¼šå®¹æ˜“è¿·å¤±åœ¨ç»†èŠ‚ä¸­\nâŒ \u003cstrong\u003eè¿½æ±‚å®Œå…¨ç†è§£\u003c/strong\u003eï¼šè¯•å›¾ç†è§£æ¯ä¸€è¡Œä»£ç \nâŒ \u003cstrong\u003eæ²¡æœ‰ç›®æ ‡\u003c/strong\u003eï¼šæ¼«æ— ç›®çš„åœ°æµè§ˆä»£ç \nâŒ \u003cstrong\u003eåªçœ‹ä¸ç»ƒ\u003c/strong\u003eï¼šåªçœ‹ä¸å†™ï¼Œæ— æ³•çœŸæ­£æŒæ¡\u003c/p\u003e\n\u003cp\u003eâœ… \u003cstrong\u003eå¸¦ç€é—®é¢˜è¯»\u003c/strong\u003eï¼šå›´ç»•å…·ä½“é—®é¢˜å±•å¼€\nâœ… \u003cstrong\u003eæŠ“ä½ä¸»çº¿\u003c/strong\u003eï¼šç†è§£æ ¸å¿ƒæµç¨‹å’Œè®¾è®¡æ€æƒ³\nâœ… \u003cstrong\u003eå¾ªåºæ¸è¿›\u003c/strong\u003eï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥\nâœ… \u003cstrong\u003eè¾¹è¯»è¾¹å†™\u003c/strong\u003eï¼šé€šè¿‡å®è·µåŠ æ·±ç†è§£\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e é˜…è¯»æºç ä¸æ˜¯ä¸ºäº†è®°ä½æ¯ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯ç†è§£è®¾è®¡æ€æƒ³å’Œæ¶æ„æ¨¡å¼ã€‚è¦å­¦ä¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œä»æ•´ä½“åˆ°ç»†èŠ‚çš„é˜…è¯»æ–¹æ³•ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"æºç é˜…è¯»æ–¹æ³•è®º\"\u003eæºç é˜…è¯»æ–¹æ³•è®º\u003c/h2\u003e\n\u003ch3 id=\"1-å‡†å¤‡é˜¶æ®µ\"\u003e1. å‡†å¤‡é˜¶æ®µ\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eé€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé€‰æ‹©ç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚Spring Boot 2.7.xï¼‰\u003c/li\u003e\n\u003cli\u003eé¿å…é€‰æ‹©æœ€æ–°çš„å¼€å‘ç‰ˆæœ¬\u003c/li\u003e\n\u003cli\u003eæŸ¥çœ‹ç‰ˆæœ¬çš„Release Notes\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eæ­å»ºè°ƒè¯•ç¯å¢ƒ\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. å…‹éš†æºç \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/spring-projects/spring-boot.git\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e spring-boot\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. åˆ‡æ¢åˆ°ç¨³å®šç‰ˆæœ¬\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout v2.7.18\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 3. å¯¼å…¥IDEï¼ˆIDEAï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# File -\u0026gt; Open -\u0026gt; é€‰æ‹©spring-bootç›®å½•\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eå‡†å¤‡ç¤ºä¾‹é¡¹ç›®\u003c/strong\u003eï¼š\u003c/p\u003e","title":"å¦‚ä½•é˜…è¯»å¼€æºé¡¹ç›®æºç ï¼šä»¥ Spring Boot ä¸ºä¾‹"},{"content":"\u0026ldquo;è¿™ä¸ªæ¥å£æ€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿ\u0026ldquo;è¿™æ˜¯æ¯ä¸ªåç«¯å¼€å‘éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å½“ç”¨æˆ·æŠ±æ€¨ç³»ç»Ÿå¡é¡¿ï¼Œå½“ç›‘æ§å‘Šè­¦é¢‘ç¹è§¦å‘ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç³»ç»Ÿæ€§åœ°å®šä½å’Œè§£å†³æ€§èƒ½é—®é¢˜ï¼Ÿ\næœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå¸¦ä½ ç»å†ä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ï¼Œä»é—®é¢˜å‘ç°åˆ°æœ€ç»ˆä¼˜åŒ–ï¼Œå°†æ¥å£å“åº”æ—¶é—´ä»3ç§’é™ä½åˆ°300msã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æ€§èƒ½é—®é¢˜çš„ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³• å­¦ä¼šä½¿ç”¨å„ç§æ€§èƒ½åˆ†æå·¥å…· ç†è§£å¸¸è§çš„æ€§èƒ½ç“¶é¢ˆåŠè§£å†³æ–¹æ¡ˆ äº†è§£æ•°æ®åº“ã€ç¼“å­˜ã€ä»£ç å±‚é¢çš„ä¼˜åŒ–æŠ€å·§ å»ºç«‹å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹ é—®é¢˜èƒŒæ™¯ ä¸šåŠ¡åœºæ™¯ æŸç”µå•†ç³»ç»Ÿçš„è®¢å•è¯¦æƒ…æ¥å£ï¼Œç”¨æˆ·åé¦ˆé¡µé¢åŠ è½½ç¼“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚\næ¥å£å®šä¹‰ï¼š\n1@GetMapping(\u0026#34;/api/orders/{orderId}\u0026#34;) 2public Result\u0026lt;OrderDetailVO\u0026gt; getOrderDetail(@PathVariable Long orderId) { 3 return Result.success(orderService.getOrderDetail(orderId)); 4} ç›‘æ§æ•°æ®ï¼š\nå¹³å‡å“åº”æ—¶é—´ï¼š2.8ç§’ P95å“åº”æ—¶é—´ï¼š3.5ç§’ P99å“åº”æ—¶é—´ï¼š5ç§’ QPSï¼š100 ä¸šåŠ¡è¦æ±‚ï¼š\nå“åº”æ—¶é—´ \u0026lt; 500ms P99 \u0026lt; 1ç§’ æ¶æ„æ€è€ƒï¼š æ€§èƒ½ä¼˜åŒ–ä¸æ˜¯ç›²ç›®åœ°ä¼˜åŒ–ï¼Œè€Œæ˜¯è¦åŸºäºæ•°æ®å’Œç›®æ ‡ã€‚é¦–å…ˆè¦æ˜ç¡®æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŒ–ç›®æ ‡ï¼Œç„¶åç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚\nç¬¬ä¸€æ­¥ï¼šé—®é¢˜å®šä½ 1. æ·»åŠ ç›‘æ§åŸ‹ç‚¹ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ—¶é—´éƒ½èŠ±åœ¨å“ªé‡Œäº†ï¼š\n1@Service 2@Slf4j 3public class OrderService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 @Autowired 9 private UserService userService; 10 11 @Autowired 12 private ProductService productService; 13 14 @Autowired 15 private LogisticsService logisticsService; 16 17 public OrderDetailVO getOrderDetail(Long orderId) { 18 long startTime = System.currentTimeMillis(); 19 20 // 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯ 21 long step1Start = System.currentTimeMillis(); 22 Order order = orderMapper.selectById(orderId); 23 log.info(\u0026#34;æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step1Start); 24 25 // 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ 26 long step2Start = System.currentTimeMillis(); 27 User user = userService.getUserById(order.getUserId()); 28 log.info(\u0026#34;æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step2Start); 29 30 // 3. æŸ¥è¯¢å•†å“ä¿¡æ¯ 31 long step3Start = System.currentTimeMillis(); 32 List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 33 List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 34 for (OrderItem item : items) { 35 Product product = productService.getProductById(item.getProductId()); 36 products.add(product); 37 } 38 log.info(\u0026#34;æŸ¥è¯¢å•†å“è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step3Start); 39 40 // 4. æŸ¥è¯¢ç‰©æµä¿¡æ¯ 41 long step4Start = System.currentTimeMillis(); 42 Logistics logistics = logisticsService.getLogisticsByOrderId(orderId); 43 log.info(\u0026#34;æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step4Start); 44 45 // 5. ç»„è£…è¿”å›æ•°æ® 46 OrderDetailVO vo = buildOrderDetailVO(order, user, products, logistics); 47 48 log.info(\u0026#34;æ€»è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - startTime); 49 return vo; 50 } 51} æ—¥å¿—è¾“å‡ºï¼š\n1æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š50ms 2æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š100ms 3æŸ¥è¯¢å•†å“è€—æ—¶ï¼š2500ms â† ç“¶é¢ˆï¼ 4æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š150ms 5æ€»è€—æ—¶ï¼š2800ms 2. åˆ†æç“¶é¢ˆ é€šè¿‡æ—¥å¿—å‘ç°ï¼ŒæŸ¥è¯¢å•†å“ä¿¡æ¯è€—æ—¶æœ€é•¿ï¼Œå æ€»è€—æ—¶çš„89%ã€‚è¿›ä¸€æ­¥åˆ†æä»£ç ï¼š\n1// é—®é¢˜ä»£ç ï¼šN+1æŸ¥è¯¢ 2List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); // 1æ¬¡æŸ¥è¯¢ 3List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 4for (OrderItem item : items) { 5 Product product = productService.getProductById(item.getProductId()); // Næ¬¡æŸ¥è¯¢ 6 products.add(product); 7} é—®é¢˜åˆ†æï¼š\nè®¢å•æœ‰10ä¸ªå•†å“ æ¯ä¸ªå•†å“æŸ¥è¯¢è€—æ—¶250ms æ€»è€—æ—¶ï¼š10 Ã— 250ms = 2500ms ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“ä¼˜åŒ– ä¼˜åŒ–1ï¼šæ‰¹é‡æŸ¥è¯¢ å°†N+1æŸ¥è¯¢æ”¹ä¸ºæ‰¹é‡æŸ¥è¯¢ï¼š\n1// ä¼˜åŒ–åçš„ä»£ç  2List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 3 4// æ”¶é›†æ‰€æœ‰å•†å“ID 5List\u0026lt;Long\u0026gt; productIds = items.stream() 6 .map(OrderItem::getProductId) 7 .collect(Collectors.toList()); 8 9// æ‰¹é‡æŸ¥è¯¢å•†å“ 10List\u0026lt;Product\u0026gt; products = productService.getProductsByIds(productIds); Mapperå®ç°ï¼š\n1@Mapper 2public interface ProductMapper { 3 4 /** 5 * æ‰¹é‡æŸ¥è¯¢å•†å“ 6 */ 7 @Select(\u0026#34;\u0026lt;script\u0026gt;\u0026#34; + 8 \u0026#34;SELECT * FROM t_product WHERE id IN \u0026#34; + 9 \u0026#34;\u0026lt;foreach collection=\u0026#39;ids\u0026#39; item=\u0026#39;id\u0026#39; open=\u0026#39;(\u0026#39; separator=\u0026#39;,\u0026#39; close=\u0026#39;)\u0026#39;\u0026gt;\u0026#34; + 10 \u0026#34;#{id}\u0026#34; + 11 \u0026#34;\u0026lt;/foreach\u0026gt;\u0026#34; + 12 \u0026#34;\u0026lt;/script\u0026gt;\u0026#34;) 13 List\u0026lt;Product\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); 14} ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢å•†å“è€—æ—¶ï¼š2500ms â†’ 300ms æ€»è€—æ—¶ï¼š2800ms â†’ 600ms ä¼˜åŒ–2ï¼šç´¢å¼•ä¼˜åŒ– åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå‘ç°è®¢å•é¡¹æŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼š\n1-- æ…¢æŸ¥è¯¢SQL 2SELECT * FROM t_order_item WHERE order_id = 123456; 3 4-- æ‰§è¡Œè®¡åˆ’ 5EXPLAIN SELECT * FROM t_order_item WHERE order_id = 123456; 6-- type: ALLï¼ˆå…¨è¡¨æ‰«æï¼‰ æ·»åŠ ç´¢å¼•ï¼š\n1CREATE INDEX idx_order_id ON t_order_item(order_id); ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢è®¢å•é¡¹è€—æ—¶ï¼š50ms â†’ 5ms æ€»è€—æ—¶ï¼š600ms â†’ 555ms ä¼˜åŒ–3ï¼šæŸ¥è¯¢å­—æ®µä¼˜åŒ– åŸæŸ¥è¯¢ä½¿ç”¨äº†SELECT *ï¼Œä½†å®é™…åªéœ€è¦éƒ¨åˆ†å­—æ®µï¼š\n1// ä¼˜åŒ–å‰ 2@Select(\u0026#34;SELECT * FROM t_product WHERE id IN (...)\u0026#34;) 3List\u0026lt;Product\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); 4 5// ä¼˜åŒ–åï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ 6@Select(\u0026#34;SELECT id, name, price, image_url FROM t_product WHERE id IN (...)\u0026#34;) 7List\u0026lt;ProductDTO\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢å•†å“è€—æ—¶ï¼š300ms â†’ 200ms æ€»è€—æ—¶ï¼š555ms â†’ 455ms ç¬¬ä¸‰æ­¥ï¼šç¼“å­˜ä¼˜åŒ– ä¼˜åŒ–4ï¼šæ·»åŠ Redisç¼“å­˜ å•†å“ä¿¡æ¯å˜åŒ–ä¸é¢‘ç¹ï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼š\n1@Service 2@Slf4j 3public class ProductService { 4 5 @Autowired 6 private ProductMapper productMapper; 7 8 @Autowired 9 private RedisTemplate\u0026lt;String, Product\u0026gt; redisTemplate; 10 11 private static final String PRODUCT_CACHE_KEY = \u0026#34;product:\u0026#34;; 12 private static final long CACHE_EXPIRE_TIME = 30; // 30åˆ†é’Ÿ 13 14 public List\u0026lt;Product\u0026gt; getProductsByIds(List\u0026lt;Long\u0026gt; productIds) { 15 List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 16 List\u0026lt;Long\u0026gt; missIds = new ArrayList\u0026lt;\u0026gt;(); 17 18 // 1. æ‰¹é‡ä»ç¼“å­˜è·å– 19 List\u0026lt;String\u0026gt; keys = productIds.stream() 20 .map(id -\u0026gt; PRODUCT_CACHE_KEY + id) 21 .collect(Collectors.toList()); 22 23 List\u0026lt;Product\u0026gt; cachedProducts = redisTemplate.opsForValue().multiGet(keys); 24 25 // 2. æ‰¾å‡ºç¼“å­˜æœªå‘½ä¸­çš„ID 26 for (int i = 0; i \u0026lt; productIds.size(); i++) { 27 Product product = cachedProducts.get(i); 28 if (product != null) { 29 products.add(product); 30 } else { 31 missIds.add(productIds.get(i)); 32 } 33 } 34 35 // 3. æŸ¥è¯¢æ•°æ®åº“ 36 if (!missIds.isEmpty()) { 37 List\u0026lt;Product\u0026gt; dbProducts = productMapper.selectByIds(missIds); 38 products.addAll(dbProducts); 39 40 // 4. å†™å…¥ç¼“å­˜ 41 for (Product product : dbProducts) { 42 redisTemplate.opsForValue().set( 43 PRODUCT_CACHE_KEY + product.getId(), 44 product, 45 CACHE_EXPIRE_TIME, 46 TimeUnit.MINUTES 47 ); 48 } 49 } 50 51 return products; 52 } 53} ä¼˜åŒ–æ•ˆæœï¼š\nç¼“å­˜å‘½ä¸­ç‡ï¼š80% æŸ¥è¯¢å•†å“è€—æ—¶ï¼š200ms â†’ 50msï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰ æ€»è€—æ—¶ï¼š455ms â†’ 305ms ä¼˜åŒ–5ï¼šæœ¬åœ°ç¼“å­˜ å¯¹äºçƒ­ç‚¹å•†å“ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š\n1@Service 2public class ProductService { 3 4 // ä½¿ç”¨Caffeineæœ¬åœ°ç¼“å­˜ 5 private final LoadingCache\u0026lt;Long, Product\u0026gt; localCache = Caffeine.newBuilder() 6 .maximumSize(1000) 7 .expireAfterWrite(5, TimeUnit.MINUTES) 8 .build(this::loadProduct); 9 10 private Product loadProduct(Long productId) { 11 // å…ˆæŸ¥Redisï¼Œå†æŸ¥æ•°æ®åº“ 12 String key = PRODUCT_CACHE_KEY + productId; 13 Product product = redisTemplate.opsForValue().get(key); 14 15 if (product == null) { 16 product = productMapper.selectById(productId); 17 if (product != null) { 18 redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES); 19 } 20 } 21 22 return product; 23 } 24 25 public Product getProductById(Long productId) { 26 return localCache.get(productId); 27 } 28} ç¼“å­˜å±‚çº§ï¼š\n1è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â†’ Redis â†’ æ•°æ®åº“ ä¼˜åŒ–æ•ˆæœï¼š\næœ¬åœ°ç¼“å­˜å‘½ä¸­ç‡ï¼š50% æŸ¥è¯¢å•†å“è€—æ—¶ï¼š50ms â†’ 20msï¼ˆæœ¬åœ°ç¼“å­˜å‘½ä¸­æ—¶ï¼‰ æ€»è€—æ—¶ï¼š305ms â†’ 275ms ç¬¬å››æ­¥ï¼šå¹¶å‘ä¼˜åŒ– ä¼˜åŒ–6ï¼šå¹¶è¡ŒæŸ¥è¯¢ ç”¨æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€ç‰©æµä¿¡æ¯ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯ä»¥å¹¶è¡ŒæŸ¥è¯¢ï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private ThreadPoolExecutor executor; 6 7 public OrderDetailVO getOrderDetail(Long orderId) { 8 // 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯ 9 Order order = orderMapper.selectById(orderId); 10 11 // 2. å¹¶è¡ŒæŸ¥è¯¢ç”¨æˆ·ã€å•†å“ã€ç‰©æµä¿¡æ¯ 12 CompletableFuture\u0026lt;User\u0026gt; userFuture = CompletableFuture.supplyAsync( 13 () -\u0026gt; userService.getUserById(order.getUserId()), 14 executor 15 ); 16 17 CompletableFuture\u0026lt;List\u0026lt;Product\u0026gt;\u0026gt; productsFuture = CompletableFuture.supplyAsync(() -\u0026gt; { 18 List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 19 List\u0026lt;Long\u0026gt; productIds = items.stream() 20 .map(OrderItem::getProductId) 21 .collect(Collectors.toList()); 22 return productService.getProductsByIds(productIds); 23 }, executor); 24 25 CompletableFuture\u0026lt;Logistics\u0026gt; logisticsFuture = CompletableFuture.supplyAsync( 26 () -\u0026gt; logisticsService.getLogisticsByOrderId(orderId), 27 executor 28 ); 29 30 // 3. ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ 31 CompletableFuture.allOf(userFuture, productsFuture, logisticsFuture).join(); 32 33 // 4. ç»„è£…è¿”å›æ•°æ® 34 User user = userFuture.join(); 35 List\u0026lt;Product\u0026gt; products = productsFuture.join(); 36 Logistics logistics = logisticsFuture.join(); 37 38 return buildOrderDetailVO(order, user, products, logistics); 39 } 40} ä¼˜åŒ–æ•ˆæœï¼š\nåŸä¸²è¡Œè€—æ—¶ï¼š50msï¼ˆè®¢å•ï¼‰+ 100msï¼ˆç”¨æˆ·ï¼‰+ 20msï¼ˆå•†å“ï¼‰+ 150msï¼ˆç‰©æµï¼‰= 320ms å¹¶è¡Œè€—æ—¶ï¼š50msï¼ˆè®¢å•ï¼‰+ max(100ms, 20ms, 150ms) = 200ms æ€»è€—æ—¶ï¼š275ms â†’ 200ms ç¬¬äº”æ­¥ï¼šä»£ç ä¼˜åŒ– ä¼˜åŒ–7ï¼šå‡å°‘å¯¹è±¡åˆ›å»º 1// ä¼˜åŒ–å‰ï¼šé¢‘ç¹åˆ›å»ºå¯¹è±¡ 2public OrderDetailVO buildOrderDetailVO(Order order, User user, 3 List\u0026lt;Product\u0026gt; products, Logistics logistics) { 4 OrderDetailVO vo = new OrderDetailVO(); 5 vo.setOrderId(order.getId()); 6 vo.setOrderNo(order.getOrderNo()); 7 // ... è®¾ç½®æ›´å¤šå­—æ®µ 8 9 UserVO userVO = new UserVO(); 10 userVO.setUserId(user.getId()); 11 userVO.setUserName(user.getName()); 12 vo.setUser(userVO); 13 14 List\u0026lt;ProductVO\u0026gt; productVOs = new ArrayList\u0026lt;\u0026gt;(); 15 for (Product product : products) { 16 ProductVO productVO = new ProductVO(); 17 productVO.setProductId(product.getId()); 18 productVO.setProductName(product.getName()); 19 productVOs.add(productVO); 20 } 21 vo.setProducts(productVOs); 22 23 return vo; 24} 25 26// ä¼˜åŒ–åï¼šä½¿ç”¨å¯¹è±¡æ˜ å°„å·¥å…· 27@Autowired 28private ModelMapper modelMapper; 29 30public OrderDetailVO buildOrderDetailVO(Order order, User user, 31 List\u0026lt;Product\u0026gt; products, Logistics logistics) { 32 OrderDetailVO vo = modelMapper.map(order, OrderDetailVO.class); 33 vo.setUser(modelMapper.map(user, UserVO.class)); 34 vo.setProducts(products.stream() 35 .map(p -\u0026gt; modelMapper.map(p, ProductVO.class)) 36 .collect(Collectors.toList())); 37 vo.setLogistics(modelMapper.map(logistics, LogisticsVO.class)); 38 return vo; 39} ä¼˜åŒ–8ï¼šé¿å…ä¸å¿…è¦çš„è®¡ç®— 1// ä¼˜åŒ–å‰ï¼šæ¯æ¬¡éƒ½è®¡ç®— 2public BigDecimal calculateTotalAmount(List\u0026lt;OrderItem\u0026gt; items) { 3 BigDecimal total = BigDecimal.ZERO; 4 for (OrderItem item : items) { 5 BigDecimal itemAmount = item.getPrice().multiply(new BigDecimal(item.getQuantity())); 6 total = total.add(itemAmount); 7 } 8 return total; 9} 10 11// ä¼˜åŒ–åï¼šä½¿ç”¨æ•°æ®åº“è®¡ç®—å¥½çš„å­—æ®µ 12public BigDecimal getTotalAmount(Order order) { 13 return order.getTotalAmount(); // ä¸‹å•æ—¶å·²è®¡ç®—å¹¶å­˜å‚¨ 14} ç¬¬å…­æ­¥ï¼šç›‘æ§ä¸éªŒè¯ æ€§èƒ½æµ‹è¯• ä½¿ç”¨JMeterè¿›è¡Œå‹æµ‹ï¼š\n1# å‹æµ‹é…ç½® 2çº¿ç¨‹æ•°ï¼š100 3æŒç»­æ—¶é—´ï¼š5åˆ†é’Ÿ ä¼˜åŒ–å‰åå¯¹æ¯”ï¼š\næŒ‡æ ‡ ä¼˜åŒ–å‰ ä¼˜åŒ–å æå‡ å¹³å‡å“åº”æ—¶é—´ 2800ms 280ms 90% P95å“åº”æ—¶é—´ 3500ms 350ms 90% P99å“åº”æ—¶é—´ 5000ms 450ms 91% QPS 100 500 400% CPUä½¿ç”¨ç‡ 80% 40% 50% ç›‘æ§å‘Šè­¦ é…ç½®Prometheuså‘Šè­¦è§„åˆ™ï¼š\n1groups: 2 - name: api_performance 3 rules: 4 - alert: HighResponseTime 5 expr: http_request_duration_seconds{quantile=\u0026#34;0.99\u0026#34;} \u0026gt; 1 6 for: 5m 7 labels: 8 severity: warning 9 annotations: 10 summary: \u0026#34;APIå“åº”æ—¶é—´è¿‡é«˜\u0026#34; 11 description: \u0026#34;{{ $labels.api }} P99å“åº”æ—¶é—´è¶…è¿‡1ç§’\u0026#34; ä¼˜åŒ–æ€»ç»“ ä¼˜åŒ–è·¯å¾„ 1åŸå§‹æ€§èƒ½ï¼š2800ms 2 â†“ æ‰¹é‡æŸ¥è¯¢ï¼ˆN+1é—®é¢˜ï¼‰ 31. 600msï¼ˆä¼˜åŒ–78%ï¼‰ 4 â†“ æ·»åŠ ç´¢å¼• 52. 555msï¼ˆä¼˜åŒ–7%ï¼‰ 6 â†“ æŸ¥è¯¢å­—æ®µä¼˜åŒ– 73. 455msï¼ˆä¼˜åŒ–18%ï¼‰ 8 â†“ Redisç¼“å­˜ 94. 305msï¼ˆä¼˜åŒ–33%ï¼‰ 10 â†“ æœ¬åœ°ç¼“å­˜ 115. 275msï¼ˆä¼˜åŒ–10%ï¼‰ 12 â†“ å¹¶è¡ŒæŸ¥è¯¢ 136. 200msï¼ˆä¼˜åŒ–27%ï¼‰ 14 â†“ ä»£ç ä¼˜åŒ– 15æœ€ç»ˆï¼š280msï¼ˆæ€»ä¼˜åŒ–90%ï¼‰ ä¼˜åŒ–åŸåˆ™ å…ˆå®šä½ï¼Œåä¼˜åŒ–ï¼šé€šè¿‡ç›‘æ§æ‰¾åˆ°çœŸæ­£çš„ç“¶é¢ˆ æŠ“å¤§æ”¾å°ï¼šä¼˜å…ˆä¼˜åŒ–å æ¯”æœ€å¤§çš„éƒ¨åˆ† åˆ†å±‚ä¼˜åŒ–ï¼šæ•°æ®åº“ â†’ ç¼“å­˜ â†’ ä»£ç  â†’ æ¶æ„ é‡åŒ–è¯„ä¼°ï¼šæ¯æ¬¡ä¼˜åŒ–éƒ½è¦æœ‰æ•°æ®æ”¯æ’‘ æŒç»­ç›‘æ§ï¼šä¼˜åŒ–åè¦æŒç»­è§‚å¯Ÿæ•ˆæœ å¸¸è§æ€§èƒ½ç“¶é¢ˆ ç“¶é¢ˆç±»å‹ å…¸å‹è¡¨ç° è§£å†³æ–¹æ¡ˆ æ•°æ®åº“æ…¢æŸ¥è¯¢ å“åº”æ—¶é—´é•¿ï¼Œæ•°æ®åº“CPUé«˜ ç´¢å¼•ä¼˜åŒ–ã€SQLä¼˜åŒ–ã€åˆ†åº“åˆ†è¡¨ N+1æŸ¥è¯¢ å¤§é‡é‡å¤æŸ¥è¯¢ æ‰¹é‡æŸ¥è¯¢ã€JOINæŸ¥è¯¢ ç¼“å­˜æœªå‘½ä¸­ æ•°æ®åº“å‹åŠ›å¤§ æ·»åŠ ç¼“å­˜ã€é¢„çƒ­ç¼“å­˜ ä¸²è¡Œè°ƒç”¨ å“åº”æ—¶é—´=å„æ­¥éª¤ä¹‹å’Œ å¹¶è¡Œè°ƒç”¨ã€å¼‚æ­¥å¤„ç† å¯¹è±¡åˆ›å»º GCé¢‘ç¹ å¯¹è±¡å¤ç”¨ã€æ± åŒ–æŠ€æœ¯ é”ç«äº‰ å¹¶å‘æ€§èƒ½å·® å‡å°é”ç²’åº¦ã€æ— é”åŒ– æ€§èƒ½ä¼˜åŒ–å·¥å…·ç®± 1. ç›‘æ§å·¥å…· APMå·¥å…·ï¼š\nSkyWalkingï¼šåˆ†å¸ƒå¼è¿½è¸ª Prometheus + Grafanaï¼šæŒ‡æ ‡ç›‘æ§ ELKï¼šæ—¥å¿—åˆ†æ æ•°æ®åº“ç›‘æ§ï¼š\nMySQLæ…¢æŸ¥è¯¢æ—¥å¿— Explainæ‰§è¡Œè®¡åˆ’ Performance Schema 2. åˆ†æå·¥å…· JVMåˆ†æï¼š\n1# æŸ¥çœ‹GCæƒ…å†µ 2jstat -gcutil \u0026lt;pid\u0026gt; 1000 3 4# ç”Ÿæˆå †è½¬å‚¨ 5jmap -dump:format=b,file=heap.hprof \u0026lt;pid\u0026gt; 6 7# çº¿ç¨‹åˆ†æ 8jstack \u0026lt;pid\u0026gt; \u0026gt; thread.txt ç«ç„°å›¾ï¼š\n1# ä½¿ç”¨async-profiler 2./profiler.sh -d 60 -f flamegraph.html \u0026lt;pid\u0026gt; 3. å‹æµ‹å·¥å…· JMeterï¼š\n1jmeter -n -t test-plan.jmx -l result.jtl -e -o report Gatlingï¼š\n1setUp( 2 scn.inject(rampUsersPerSec(10) to 1000 during (5 minutes)) 3).protocols(httpProtocol) æœ€ä½³å®è·µ 1. æ€§èƒ½ä¼˜åŒ–checklist æ·»åŠ ç›‘æ§åŸ‹ç‚¹ï¼Œé‡åŒ–æ€§èƒ½æŒ‡æ ‡ åˆ†ææ…¢æŸ¥è¯¢ï¼Œä¼˜åŒ–SQLå’Œç´¢å¼• è¯†åˆ«N+1æŸ¥è¯¢ï¼Œæ”¹ä¸ºæ‰¹é‡æŸ¥è¯¢ æ·»åŠ ç¼“å­˜ï¼Œæé«˜è¯»æ€§èƒ½ å¹¶è¡ŒåŒ–ç‹¬ç«‹æ“ä½œï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ ä¼˜åŒ–ä»£ç é€»è¾‘ï¼Œå‡å°‘ä¸å¿…è¦çš„è®¡ç®— å‹æµ‹éªŒè¯ï¼Œç¡®ä¿ä¼˜åŒ–æ•ˆæœ æŒç»­ç›‘æ§ï¼Œé˜²æ­¢æ€§èƒ½é€€åŒ– 2. æ€§èƒ½ä¼˜åŒ–è¯¯åŒº âŒ è¿‡æ—©ä¼˜åŒ–ï¼šåœ¨æ²¡æœ‰æ€§èƒ½é—®é¢˜æ—¶å°±å¼€å§‹ä¼˜åŒ– âœ… åŸºäºæ•°æ®ä¼˜åŒ–ï¼šå…ˆæµ‹é‡ï¼Œå†ä¼˜åŒ–\nâŒ ç›²ç›®ä¼˜åŒ–ï¼šä¸çŸ¥é“ç“¶é¢ˆåœ¨å“ªå°±å¼€å§‹ä¼˜åŒ– âœ… å®šä½ç“¶é¢ˆï¼šæ‰¾åˆ°çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆ\nâŒ å±€éƒ¨ä¼˜åŒ–ï¼šåªä¼˜åŒ–æŸä¸ªç‚¹ âœ… ç³»ç»Ÿä¼˜åŒ–ï¼šä»æ•´ä½“è§’åº¦ä¼˜åŒ–\nâŒ å¿½ç•¥ç›‘æ§ï¼šä¼˜åŒ–åä¸ç›‘æ§æ•ˆæœ âœ… æŒç»­ç›‘æ§ï¼šä¼˜åŒ–åæŒç»­è§‚å¯Ÿ\n3. æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹ 1å‘ç°é—®é¢˜ 2 â†“ 3æ·»åŠ ç›‘æ§ï¼ˆé‡åŒ–é—®é¢˜ï¼‰ 4 â†“ 5å®šä½ç“¶é¢ˆï¼ˆæ‰¾åˆ°æ ¹å› ï¼‰ 6 â†“ 7åˆ¶å®šæ–¹æ¡ˆï¼ˆè¯„ä¼°æ”¶ç›Šï¼‰ 8 â†“ 9å®æ–½ä¼˜åŒ–ï¼ˆå°æ­¥å¿«è·‘ï¼‰ 10 â†“ 11éªŒè¯æ•ˆæœï¼ˆå‹æµ‹éªŒè¯ï¼‰ 12 â†“ 13æŒç»­ç›‘æ§ï¼ˆé˜²æ­¢é€€åŒ–ï¼‰ é¿å‘æç¤ºï¼š æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§çš„å·¥ä½œã€‚è¦å»ºç«‹æ€§èƒ½ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³æ€§èƒ½é—®é¢˜ã€‚åŒæ—¶è¦æ³¨æ„ï¼Œè¿‡åº¦ä¼˜åŒ–å¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿå¤æ‚åº¦ï¼Œè¦åœ¨æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå±•ç¤ºäº†å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ï¼š\né—®é¢˜å®šä½ï¼šé€šè¿‡ç›‘æ§åŸ‹ç‚¹æ‰¾åˆ°ç“¶é¢ˆ æ•°æ®åº“ä¼˜åŒ–ï¼šæ‰¹é‡æŸ¥è¯¢ã€ç´¢å¼•ä¼˜åŒ–ã€å­—æ®µä¼˜åŒ– ç¼“å­˜ä¼˜åŒ–ï¼šRedisç¼“å­˜ã€æœ¬åœ°ç¼“å­˜ å¹¶å‘ä¼˜åŒ–ï¼šå¹¶è¡ŒæŸ¥è¯¢ã€å¼‚æ­¥å¤„ç† ä»£ç ä¼˜åŒ–ï¼šå‡å°‘å¯¹è±¡åˆ›å»ºã€é¿å…é‡å¤è®¡ç®— ç›‘æ§éªŒè¯ï¼šå‹æµ‹éªŒè¯ã€æŒç»­ç›‘æ§ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯ï¼š\né‡åŒ–é—®é¢˜ï¼šç”¨æ•°æ®è¯´è¯ å®šä½ç“¶é¢ˆï¼šæ‰¾åˆ°çœŸæ­£çš„é—®é¢˜ ç³»ç»Ÿä¼˜åŒ–ï¼šä»æ•´ä½“è§’åº¦æ€è€ƒ æŒç»­æ”¹è¿›ï¼šå»ºç«‹é•¿æ•ˆæœºåˆ¶ ä¸‹æ¬¡å½“ä½ é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶ï¼Œä¸å¦¨æŒ‰ç…§æœ¬æ–‡çš„æ€è·¯ï¼Œç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚è®°ä½ï¼Œæ€§èƒ½ä¼˜åŒ–ä¸æ˜¯é“¶å¼¹ï¼Œè€Œæ˜¯ä¸€ä¸ªæŒç»­æ”¹è¿›çš„è¿‡ç¨‹ã€‚\n","permalink":"http://localhost:1313/posts/2025/10/%E6%8E%A5%E5%8F%A3%E5%93%8D%E5%BA%94%E6%85%A2%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8B%E6%97%85/","summary":"\u003cp\u003e\u0026ldquo;è¿™ä¸ªæ¥å£æ€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿ\u0026ldquo;è¿™æ˜¯æ¯ä¸ªåç«¯å¼€å‘éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å½“ç”¨æˆ·æŠ±æ€¨ç³»ç»Ÿå¡é¡¿ï¼Œå½“ç›‘æ§å‘Šè­¦é¢‘ç¹è§¦å‘ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç³»ç»Ÿæ€§åœ°å®šä½å’Œè§£å†³æ€§èƒ½é—®é¢˜ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå¸¦ä½ ç»å†ä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ï¼Œä»é—®é¢˜å‘ç°åˆ°æœ€ç»ˆä¼˜åŒ–ï¼Œå°†æ¥å£å“åº”æ—¶é—´ä»3ç§’é™ä½åˆ°300msã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ€§èƒ½é—®é¢˜çš„ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å„ç§æ€§èƒ½åˆ†æå·¥å…·\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å¸¸è§çš„æ€§èƒ½ç“¶é¢ˆåŠè§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£æ•°æ®åº“ã€ç¼“å­˜ã€ä»£ç å±‚é¢çš„ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"é—®é¢˜èƒŒæ™¯\"\u003eé—®é¢˜èƒŒæ™¯\u003c/h2\u003e\n\u003ch3 id=\"ä¸šåŠ¡åœºæ™¯\"\u003eä¸šåŠ¡åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿçš„è®¢å•è¯¦æƒ…æ¥å£ï¼Œç”¨æˆ·åé¦ˆé¡µé¢åŠ è½½ç¼“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ¥å£å®šä¹‰\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@GetMapping\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/api/orders/{orderId}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nd\"\u003e@PathVariable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esuccess\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eç›‘æ§æ•°æ®\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¹³å‡å“åº”æ—¶é—´ï¼š2.8ç§’\u003c/li\u003e\n\u003cli\u003eP95å“åº”æ—¶é—´ï¼š3.5ç§’\u003c/li\u003e\n\u003cli\u003eP99å“åº”æ—¶é—´ï¼š5ç§’\u003c/li\u003e\n\u003cli\u003eQPSï¼š100\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡è¦æ±‚\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå“åº”æ—¶é—´ \u0026lt; 500ms\u003c/li\u003e\n\u003cli\u003eP99 \u0026lt; 1ç§’\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e æ€§èƒ½ä¼˜åŒ–ä¸æ˜¯ç›²ç›®åœ°ä¼˜åŒ–ï¼Œè€Œæ˜¯è¦åŸºäºæ•°æ®å’Œç›®æ ‡ã€‚é¦–å…ˆè¦æ˜ç¡®æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŒ–ç›®æ ‡ï¼Œç„¶åç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥é—®é¢˜å®šä½\"\u003eç¬¬ä¸€æ­¥ï¼šé—®é¢˜å®šä½\u003c/h2\u003e\n\u003ch3 id=\"1-æ·»åŠ ç›‘æ§åŸ‹ç‚¹\"\u003e1. æ·»åŠ ç›‘æ§åŸ‹ç‚¹\u003c/h3\u003e\n\u003cp\u003eé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ—¶é—´éƒ½èŠ±åœ¨å“ªé‡Œäº†ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Slf4j\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrderService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderMapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eProductService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLogisticsService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogisticsService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estartTime\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep1Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep1Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep2Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep2Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. æŸ¥è¯¢å•†å“ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep3Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectItemsByOrderId\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eProduct\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eArrayList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e35\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eProduct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproduct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e36\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eproduct\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e37\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e38\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢å•†å“è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep3Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e39\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e40\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. æŸ¥è¯¢ç‰©æµä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e41\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep4Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e42\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eLogistics\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogistics\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogisticsService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetLogisticsByOrderId\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e43\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep4Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e44\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e45\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 5. ç»„è£…è¿”å›æ•°æ®\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e46\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003evo\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebuildOrderDetailVO\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogistics\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e47\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e48\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æ€»è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estartTime\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e49\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003evo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e50\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e51\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ—¥å¿—è¾“å‡º\u003c/strong\u003eï¼š\u003c/p\u003e","title":"æ¥å£å“åº”æ…¢ï¼Ÿä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…"},{"content":"åœ¨å¤§ä¿ƒã€ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œç³»ç»Ÿèƒ½å¦æ‰›ä½æµé‡å†²å‡»æ˜¯æ¯ä¸ªæŠ€æœ¯å›¢é˜Ÿæœ€å…³å¿ƒçš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„å•æ¥å£å‹æµ‹æ— æ³•çœŸå®åæ˜ ç³»ç»Ÿçš„æ•´ä½“æ‰¿è½½èƒ½åŠ›ï¼Œè€Œå…¨é“¾è·¯å‹æµ‹é€šè¿‡æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºï¼Œå¯ä»¥å…¨é¢éªŒè¯ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºå®Œæ•´çš„å‹æµ‹ä½“ç³»ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£å…¨é“¾è·¯å‹æµ‹çš„æ ¸å¿ƒä»·å€¼ æŒæ¡å‹æµ‹ç¯å¢ƒçš„æ­å»ºæ–¹æ¡ˆ å­¦ä¼šæ•°æ®éš”ç¦»ä¸æµé‡æ ‡è®° äº†è§£å‹æµ‹å·¥å…·çš„é€‰å‹ä¸ä½¿ç”¨ æŒæ¡æ€§èƒ½ç“¶é¢ˆçš„åˆ†æä¸ä¼˜åŒ– ä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹ ä¼ ç»Ÿå‹æµ‹ vs å…¨é“¾è·¯å‹æµ‹ ä¼ ç»Ÿå‹æµ‹ï¼š\né’ˆå¯¹å•ä¸ªæ¥å£æˆ–æœåŠ¡è¿›è¡Œå‹æµ‹ ä½¿ç”¨æµ‹è¯•ç¯å¢ƒæˆ–é¢„å‘å¸ƒç¯å¢ƒ æ•°æ®é‡å°ï¼Œæ— æ³•åæ˜ çœŸå®æƒ…å†µ å…¨é“¾è·¯å‹æµ‹ï¼š\nåœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå‹æµ‹ æ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„å®Œæ•´ä¸šåŠ¡æµç¨‹ ä½¿ç”¨çœŸå®çš„æ•°æ®é‡å’Œç³»ç»Ÿé…ç½® å…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼ çœŸå®æ€§ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œç»“æœæœ€å¯ä¿¡ å…¨é¢æ€§ï¼šè¦†ç›–æ‰€æœ‰ç³»ç»Ÿç»„ä»¶å’Œä¾èµ– åŠæ—¶æ€§ï¼šæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ æŒ‡å¯¼æ€§ï¼šä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æŒ å‹æµ‹åœºæ™¯ 1ç”¨æˆ·è®¿é—® â†’ ç½‘å…³ â†’ åº”ç”¨æœåŠ¡ â†’ ç¼“å­˜ â†’ æ•°æ®åº“ 2 â†“ 3 æ¶ˆæ¯é˜Ÿåˆ— â†’ å¼‚æ­¥æœåŠ¡ 4 â†“ 5 ç¬¬ä¸‰æ–¹æœåŠ¡ æ¶æ„æ€è€ƒï¼š å…¨é“¾è·¯å‹æµ‹ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯ä¸šåŠ¡é—®é¢˜ã€‚éœ€è¦äº§å“ã€è¿è¥ã€æŠ€æœ¯å›¢é˜Ÿå…±åŒå‚ä¸ï¼Œåˆ¶å®šåˆç†çš„å‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡†ã€‚\nå‹æµ‹æ–¹æ¡ˆè®¾è®¡ 1. å‹æµ‹ç›®æ ‡è®¾å®š æ€§èƒ½æŒ‡æ ‡ï¼š\nTPS/QPSï¼šæ¯ç§’äº‹åŠ¡æ•°/æŸ¥è¯¢æ•° å“åº”æ—¶é—´ï¼šP50ã€P95ã€P99 æˆåŠŸç‡ï¼šè¯·æ±‚æˆåŠŸçš„æ¯”ä¾‹ èµ„æºä½¿ç”¨ç‡ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ ä¸šåŠ¡æŒ‡æ ‡ï¼š\nè®¢å•åˆ›å»ºæˆåŠŸç‡ æ”¯ä»˜æˆåŠŸç‡ åº“å­˜æ‰£å‡å‡†ç¡®æ€§ ç¤ºä¾‹ç›®æ ‡ï¼š\n1å¤§ä¿ƒåœºæ™¯ï¼š 2- å³°å€¼ TPSï¼š10000 3- P99 å“åº”æ—¶é—´ï¼š\u0026lt; 500ms 4- æˆåŠŸç‡ï¼š\u0026gt; 99.9% 5- CPU ä½¿ç”¨ç‡ï¼š\u0026lt; 70% 2. å‹æµ‹æµé‡æ¨¡å‹ æµé‡ç‰¹å¾ï¼š\næµé‡æ›²çº¿ï¼šæ¨¡æ‹ŸçœŸå®çš„æµé‡æ³¢åŠ¨ ç”¨æˆ·è¡Œä¸ºï¼šæµè§ˆã€æœç´¢ã€ä¸‹å•ã€æ”¯ä»˜ ä¸šåŠ¡æ¯”ä¾‹ï¼šè¯»å†™æ¯”ä¾‹ã€çƒ­ç‚¹æ•°æ®åˆ†å¸ƒ å‹æµ‹è„šæœ¬ç¤ºä¾‹ï¼ˆJMeterï¼‰ï¼š\n1\u0026lt;TestPlan\u0026gt; 2 \u0026lt;ThreadGroup\u0026gt; 3 \u0026lt;stringProp name=\u0026#34;ThreadGroup.num_threads\u0026#34;\u0026gt;1000\u0026lt;/stringProp\u0026gt; 4 \u0026lt;stringProp name=\u0026#34;ThreadGroup.ramp_time\u0026#34;\u0026gt;60\u0026lt;/stringProp\u0026gt; 5 \u0026lt;stringProp name=\u0026#34;ThreadGroup.duration\u0026#34;\u0026gt;600\u0026lt;/stringProp\u0026gt; 6 7 \u0026lt;!-- æµè§ˆå•†å“ 60% --\u0026gt; 8 \u0026lt;HTTPSamplerProxy name=\u0026#34;æµè§ˆå•†å“\u0026#34;\u0026gt; 9 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/products/${productId}\u0026lt;/stringProp\u0026gt; 10 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;GET\u0026lt;/stringProp\u0026gt; 11 \u0026lt;/HTTPSamplerProxy\u0026gt; 12 13 \u0026lt;!-- åŠ å…¥è´­ç‰©è½¦ 30% --\u0026gt; 14 \u0026lt;HTTPSamplerProxy name=\u0026#34;åŠ å…¥è´­ç‰©è½¦\u0026#34;\u0026gt; 15 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/cart\u0026lt;/stringProp\u0026gt; 16 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;POST\u0026lt;/stringProp\u0026gt; 17 \u0026lt;/HTTPSamplerProxy\u0026gt; 18 19 \u0026lt;!-- ä¸‹å• 10% --\u0026gt; 20 \u0026lt;HTTPSamplerProxy name=\u0026#34;åˆ›å»ºè®¢å•\u0026#34;\u0026gt; 21 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/orders\u0026lt;/stringProp\u0026gt; 22 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;POST\u0026lt;/stringProp\u0026gt; 23 \u0026lt;/HTTPSamplerProxy\u0026gt; 24 \u0026lt;/ThreadGroup\u0026gt; 25\u0026lt;/TestPlan\u0026gt; 3. æ•°æ®éš”ç¦»æ–¹æ¡ˆ åœ¨ç”Ÿäº§ç¯å¢ƒå‹æµ‹ï¼Œå¿…é¡»åšå¥½æ•°æ®éš”ç¦»ï¼Œé¿å…å½±å“çœŸå®ç”¨æˆ·ï¼š\næ–¹æ¡ˆä¸€ï¼šå½±å­è¡¨\n1-- çœŸå®è¡¨ 2CREATE TABLE t_order ( 3 id BIGINT PRIMARY KEY, 4 user_id BIGINT, 5 amount DECIMAL(10,2), 6 status INT, 7 create_time DATETIME 8); 9 10-- å½±å­è¡¨ï¼ˆå‹æµ‹æ•°æ®ï¼‰ 11CREATE TABLE t_order_shadow ( 12 id BIGINT PRIMARY KEY, 13 user_id BIGINT, 14 amount DECIMAL(10,2), 15 status INT, 16 create_time DATETIME 17); æ–¹æ¡ˆäºŒï¼šå½±å­åº“\n1ç”Ÿäº§åº“ï¼šprod_db 2å½±å­åº“ï¼šprod_db_shadow æ–¹æ¡ˆä¸‰ï¼šæ•°æ®æ ‡è®°\n1// åœ¨æ•°æ®ä¸­æ·»åŠ å‹æµ‹æ ‡è®° 2@Data 3public class Order { 4 private Long id; 5 private Long userId; 6 private BigDecimal amount; 7 private Boolean isStressTest; // å‹æµ‹æ ‡è®° 8} æµé‡æ ‡è®°ä¸è·¯ç”± 1. æµé‡æ ‡è®° åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ å‹æµ‹æ ‡è®°ï¼š\n1public class StressTestFilter implements Filter { 2 3 private static final String STRESS_TEST_HEADER = \u0026#34;X-Stress-Test\u0026#34;; 4 5 @Override 6 public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) { 7 HttpServletRequest httpRequest = (HttpServletRequest) request; 8 9 // æ£€æŸ¥æ˜¯å¦ä¸ºå‹æµ‹æµé‡ 10 String stressTest = httpRequest.getHeader(STRESS_TEST_HEADER); 11 if (\u0026#34;true\u0026#34;.equals(stressTest)) { 12 // è®¾ç½®åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡ 13 StressTestContext.setStressTest(true); 14 } 15 16 try { 17 chain.doFilter(request, response); 18 } finally { 19 StressTestContext.clear(); 20 } 21 } 22} 2. æ•°æ®è·¯ç”± æ ¹æ®å‹æµ‹æ ‡è®°è·¯ç”±åˆ°å½±å­è¡¨/å½±å­åº“ï¼š\n1@Component 2public class StressTestDataSourceRouter extends AbstractRoutingDataSource { 3 4 @Override 5 protected Object determineCurrentLookupKey() { 6 // å¦‚æœæ˜¯å‹æµ‹æµé‡ï¼Œè·¯ç”±åˆ°å½±å­åº“ 7 if (StressTestContext.isStressTest()) { 8 return \u0026#34;shadow\u0026#34;; 9 } 10 return \u0026#34;master\u0026#34;; 11 } 12} 13 14@Configuration 15public class DataSourceConfig { 16 17 @Bean 18 public DataSource dataSource() { 19 StressTestDataSourceRouter router = new StressTestDataSourceRouter(); 20 21 Map\u0026lt;Object, Object\u0026gt; targetDataSources = new HashMap\u0026lt;\u0026gt;(); 22 targetDataSources.put(\u0026#34;master\u0026#34;, masterDataSource()); 23 targetDataSources.put(\u0026#34;shadow\u0026#34;, shadowDataSource()); 24 25 router.setTargetDataSources(targetDataSources); 26 router.setDefaultTargetDataSource(masterDataSource()); 27 28 return router; 29 } 30} 3. MyBatis æ‹¦æˆªå™¨ è‡ªåŠ¨åˆ‡æ¢è¡¨åï¼š\n1@Intercepts({ 2 @Signature(type = StatementHandler.class, method = \u0026#34;prepare\u0026#34;, args = {Connection.class, Integer.class}) 3}) 4public class StressTestInterceptor implements Interceptor { 5 6 @Override 7 public Object intercept(Invocation invocation) throws Throwable { 8 StatementHandler statementHandler = (StatementHandler) invocation.getTarget(); 9 BoundSql boundSql = statementHandler.getBoundSql(); 10 String sql = boundSql.getSql(); 11 12 // å¦‚æœæ˜¯å‹æµ‹æµé‡ï¼Œæ›¿æ¢è¡¨å 13 if (StressTestContext.isStressTest()) { 14 sql = sql.replaceAll(\u0026#34;t_(\\\\w+)\u0026#34;, \u0026#34;t_$1_shadow\u0026#34;); 15 16 // åå°„ä¿®æ”¹ SQL 17 Field field = boundSql.getClass().getDeclaredField(\u0026#34;sql\u0026#34;); 18 field.setAccessible(true); 19 field.set(boundSql, sql); 20 } 21 22 return invocation.proceed(); 23 } 24} å‹æµ‹å·¥å…·é€‰å‹ 1. JMeter ä¼˜ç‚¹ï¼š\nåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå¤šç§åè®® å›¾å½¢åŒ–ç•Œé¢ï¼Œæ˜“äºä½¿ç”¨ æ’ä»¶ä¸°å¯Œ ç¼ºç‚¹ï¼š\nå•æœºæ€§èƒ½æœ‰é™ èµ„æºæ¶ˆè€—è¾ƒå¤§ ä½¿ç”¨ç¤ºä¾‹ï¼š\n1# å‘½ä»¤è¡Œæ¨¡å¼è¿è¡Œ 2jmeter -n -t test-plan.jmx -l result.jtl -e -o report 3 4# åˆ†å¸ƒå¼å‹æµ‹ 5jmeter -n -t test-plan.jmx -R 192.168.1.101,192.168.1.102,192.168.1.103 2. Gatling ä¼˜ç‚¹ï¼š\nåŸºäº Scalaï¼Œæ€§èƒ½ä¼˜ç§€ DSL è„šæœ¬ï¼Œæ˜“äºç»´æŠ¤ æŠ¥å‘Šç¾è§‚ ç¤ºä¾‹è„šæœ¬ï¼š\n1import io.gatling.core.Predef._ 2import io.gatling.http.Predef._ 3import scala.concurrent.duration._ 4 5class OrderSimulation extends Simulation { 6 7 val httpProtocol = http 8 .baseUrl(\u0026#34;https://api.example.com\u0026#34;) 9 .header(\u0026#34;X-Stress-Test\u0026#34;, \u0026#34;true\u0026#34;) 10 11 val scn = scenario(\u0026#34;è®¢å•åœºæ™¯\u0026#34;) 12 .exec(http(\u0026#34;æµè§ˆå•†å“\u0026#34;) 13 .get(\u0026#34;/api/products/${productId}\u0026#34;) 14 .check(status.is(200))) 15 .pause(2) 16 .exec(http(\u0026#34;åŠ å…¥è´­ç‰©è½¦\u0026#34;) 17 .post(\u0026#34;/api/cart\u0026#34;) 18 .body(StringBody(\u0026#34;\u0026#34;\u0026#34;{\u0026#34;productId\u0026#34;: \u0026#34;${productId}\u0026#34;, \u0026#34;quantity\u0026#34;: 1}\u0026#34;\u0026#34;\u0026#34;)) 19 .check(status.is(200))) 20 .pause(3) 21 .exec(http(\u0026#34;åˆ›å»ºè®¢å•\u0026#34;) 22 .post(\u0026#34;/api/orders\u0026#34;) 23 .body(StringBody(\u0026#34;\u0026#34;\u0026#34;{\u0026#34;items\u0026#34;: [{\u0026#34;productId\u0026#34;: \u0026#34;${productId}\u0026#34;, \u0026#34;quantity\u0026#34;: 1}]}\u0026#34;\u0026#34;\u0026#34;)) 24 .check(status.is(200))) 25 26 setUp( 27 scn.inject( 28 rampUsersPerSec(10) to 1000 during (5 minutes), 29 constantUsersPerSec(1000) during (10 minutes) 30 ) 31 ).protocols(httpProtocol) 32} 3. é˜¿é‡Œäº‘ PTS ä¼˜ç‚¹ï¼š\näº‘ç«¯å‹æµ‹ï¼Œæ— éœ€æ­å»ºç¯å¢ƒ æ”¯æŒå¤§è§„æ¨¡å¹¶å‘ é›†æˆç›‘æ§å’ŒæŠ¥å‘Š é€‚ç”¨åœºæ™¯ï¼š\nå¤§è§„æ¨¡å‹æµ‹ï¼ˆä¸‡çº§å¹¶å‘ï¼‰ å¿«é€ŸéªŒè¯ æ— å‹æµ‹ç¯å¢ƒ å·¥å…·å¯¹æ¯” å·¥å…· æ€§èƒ½ æ˜“ç”¨æ€§ æˆæœ¬ é€‚ç”¨åœºæ™¯ JMeter ä¸­ é«˜ å…è´¹ ä¸­å°è§„æ¨¡å‹æµ‹ Gatling é«˜ ä¸­ å…è´¹ å¤§è§„æ¨¡å‹æµ‹ é˜¿é‡Œäº‘ PTS å¾ˆé«˜ é«˜ ä»˜è´¹ è¶…å¤§è§„æ¨¡å‹æµ‹ ç›‘æ§ä¸åˆ†æ 1. åº”ç”¨ç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nQPS/TPSï¼šæ¯ç§’è¯·æ±‚æ•° å“åº”æ—¶é—´ï¼šP50ã€P95ã€P99 é”™è¯¯ç‡ï¼š4xxã€5xx é”™è¯¯ çº¿ç¨‹æ± ï¼šæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ Prometheus + Grafanaï¼š\n1# prometheus.yml 2scrape_configs: 3 - job_name: \u0026#39;spring-boot\u0026#39; 4 metrics_path: \u0026#39;/actuator/prometheus\u0026#39; 5 static_configs: 6 - targets: [\u0026#39;192.168.1.101:8080\u0026#39;, \u0026#39;192.168.1.102:8080\u0026#39;] 2. ç³»ç»Ÿç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nCPUï¼šä½¿ç”¨ç‡ã€è´Ÿè½½ å†…å­˜ï¼šä½¿ç”¨ç‡ã€GC é¢‘ç‡ ç£ç›˜ï¼šIOPSã€ååé‡ ç½‘ç»œï¼šå¸¦å®½ã€è¿æ¥æ•° ä½¿ç”¨ Node Exporterï¼š\n1# å¯åŠ¨ Node Exporter 2docker run -d \\ 3 --name=node-exporter \\ 4 -p 9100:9100 \\ 5 prom/node-exporter 3. æ•°æ®åº“ç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nQPSï¼šæŸ¥è¯¢æ•° æ…¢æŸ¥è¯¢ï¼šæ‰§è¡Œæ—¶é—´ \u0026gt; 1s è¿æ¥æ•°ï¼šæ´»è·ƒè¿æ¥ é”ç­‰å¾…ï¼šè¡Œé”ã€è¡¨é” MySQL æ…¢æŸ¥è¯¢åˆ†æï¼š\n1-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— 2SET GLOBAL slow_query_log = \u0026#39;ON\u0026#39;; 3SET GLOBAL long_query_time = 1; 4 5-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ 6SELECT * FROM mysql.slow_log ORDER BY query_time DESC LIMIT 10; 4. æ€§èƒ½åˆ†æ ç«ç„°å›¾ï¼š\n1# ä½¿ç”¨ async-profiler 2./profiler.sh -d 60 -f flamegraph.html \u0026lt;pid\u0026gt; JVM åˆ†æï¼š\n1# æŸ¥çœ‹ GC æƒ…å†µ 2jstat -gcutil \u0026lt;pid\u0026gt; 1000 3 4# ç”Ÿæˆå †è½¬å‚¨ 5jmap -dump:format=b,file=heap.hprof \u0026lt;pid\u0026gt; 6 7# åˆ†æå †è½¬å‚¨ 8jhat heap.hprof æ€§èƒ½ä¼˜åŒ–å®æˆ˜ æ¡ˆä¾‹ä¸€ï¼šæ•°æ®åº“æ…¢æŸ¥è¯¢ é—®é¢˜ï¼šè®¢å•æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´ P99 è¾¾åˆ° 2 ç§’\nåˆ†æï¼š\n1-- æ…¢æŸ¥è¯¢ SQL 2SELECT * FROM t_order 3WHERE user_id = 123 AND status = 1 4ORDER BY create_time DESC 5LIMIT 10; 6 7-- æ‰§è¡Œè®¡åˆ’ 8EXPLAIN SELECT * FROM t_order 9WHERE user_id = 123 AND status = 1 10ORDER BY create_time DESC 11LIMIT 10; 12 13-- ç»“æœï¼štype=ALLï¼Œå…¨è¡¨æ‰«æ ä¼˜åŒ–ï¼š\n1-- æ·»åŠ å¤åˆç´¢å¼• 2CREATE INDEX idx_user_status_time ON t_order(user_id, status, create_time); 3 4-- ä¼˜åŒ–åï¼štype=refï¼Œä½¿ç”¨ç´¢å¼• æ•ˆæœï¼šå“åº”æ—¶é—´é™ä½åˆ° 50ms\næ¡ˆä¾‹äºŒï¼šç¼“å­˜ç©¿é€ é—®é¢˜ï¼šRedis ç¼“å­˜æœªå‘½ä¸­ï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“\nåˆ†æï¼š\n1// åŸä»£ç  2public Order getOrder(Long orderId) { 3 // æŸ¥è¯¢ç¼“å­˜ 4 Order order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 5 if (order == null) { 6 // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ 7 order = orderMapper.selectById(orderId); 8 if (order != null) { 9 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, order, 30, TimeUnit.MINUTES); 10 } 11 } 12 return order; 13} ä¼˜åŒ–ï¼š\n1// ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ 2@Autowired 3private BloomFilter\u0026lt;Long\u0026gt; orderBloomFilter; 4 5public Order getOrder(Long orderId) { 6 // å…ˆæ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨ 7 if (!orderBloomFilter.mightContain(orderId)) { 8 return null; // è®¢å•ä¸å­˜åœ¨ 9 } 10 11 // æŸ¥è¯¢ç¼“å­˜ 12 Order order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 13 if (order == null) { 14 // ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿ 15 String lockKey = \u0026#34;lock:order:\u0026#34; + orderId; 16 if (redisTemplate.opsForValue().setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS)) { 17 try { 18 // å†æ¬¡æ£€æŸ¥ç¼“å­˜ 19 order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 20 if (order == null) { 21 // æŸ¥è¯¢æ•°æ®åº“ 22 order = orderMapper.selectById(orderId); 23 if (order != null) { 24 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, order, 30, TimeUnit.MINUTES); 25 } else { 26 // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç©¿é€ 27 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, new Order(), 5, TimeUnit.MINUTES); 28 } 29 } 30 } finally { 31 redisTemplate.delete(lockKey); 32 } 33 } 34 } 35 return order; 36} æ¡ˆä¾‹ä¸‰ï¼šçº¿ç¨‹æ± æ»¡ é—®é¢˜ï¼šçº¿ç¨‹æ± é˜Ÿåˆ—æ»¡ï¼Œè¯·æ±‚è¢«æ‹’ç»\nåˆ†æï¼š\n1// åŸé…ç½® 2@Bean 3public ThreadPoolExecutor executor() { 4 return new ThreadPoolExecutor( 5 10, // æ ¸å¿ƒçº¿ç¨‹æ•° 6 20, // æœ€å¤§çº¿ç¨‹æ•° 7 60L, TimeUnit.SECONDS, 8 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), // é˜Ÿåˆ—å®¹é‡ 100 9 new ThreadPoolExecutor.AbortPolicy() // æ‹’ç»ç­–ç•¥ï¼šæŠ›å¼‚å¸¸ 10 ); 11} ä¼˜åŒ–ï¼š\n1@Bean 2public ThreadPoolExecutor executor() { 3 return new ThreadPoolExecutor( 4 50, // å¢åŠ æ ¸å¿ƒçº¿ç¨‹æ•° 5 100, // å¢åŠ æœ€å¤§çº¿ç¨‹æ•° 6 60L, TimeUnit.SECONDS, 7 new LinkedBlockingQueue\u0026lt;\u0026gt;(1000), // å¢åŠ é˜Ÿåˆ—å®¹é‡ 8 new ThreadFactoryBuilder() 9 .setNameFormat(\u0026#34;business-thread-%d\u0026#34;) 10 .build(), 11 new ThreadPoolExecutor.CallerRunsPolicy() // æ”¹ä¸ºè°ƒç”¨è€…è¿è¡Œç­–ç•¥ 12 ); 13} 14 15// æ·»åŠ ç›‘æ§ 16@Scheduled(fixedRate = 5000) 17public void monitorThreadPool() { 18 ThreadPoolExecutor executor = (ThreadPoolExecutor) this.executor; 19 log.info(\u0026#34;çº¿ç¨‹æ± çŠ¶æ€ - æ´»è·ƒçº¿ç¨‹ï¼š{}ï¼Œé˜Ÿåˆ—å¤§å°ï¼š{}ï¼Œå®Œæˆä»»åŠ¡ï¼š{}\u0026#34;, 20 executor.getActiveCount(), 21 executor.getQueue().size(), 22 executor.getCompletedTaskCount()); 23} å‹æµ‹æµç¨‹ 1. å‡†å¤‡é˜¶æ®µ ç¡®å®šå‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡† å‡†å¤‡å‹æµ‹ç¯å¢ƒå’Œæ•°æ® é…ç½®æµé‡æ ‡è®°å’Œæ•°æ®éš”ç¦» ç¼–å†™å‹æµ‹è„šæœ¬ æ­å»ºç›‘æ§ç³»ç»Ÿ 2. é¢„æ¼”é˜¶æ®µ å°æµé‡å‹æµ‹ï¼ˆ10% ç›®æ ‡æµé‡ï¼‰ éªŒè¯æ•°æ®éš”ç¦»æ˜¯å¦ç”Ÿæ•ˆ æ£€æŸ¥ç›‘æ§æŒ‡æ ‡æ˜¯å¦æ­£å¸¸ ç¡®è®¤æ— çœŸå®ç”¨æˆ·å½±å“ 3. æ­£å¼å‹æµ‹ é€æ­¥å¢åŠ å‹åŠ›ï¼ˆæ¢¯åº¦å‹æµ‹ï¼‰ å®æ—¶ç›‘æ§ç³»ç»ŸæŒ‡æ ‡ è®°å½•æ€§èƒ½ç“¶é¢ˆ è¾¾åˆ°ç›®æ ‡åæŒç»­ 10-30 åˆ†é’Ÿ 4. åˆ†æé˜¶æ®µ æ±‡æ€»å‹æµ‹æ•°æ® åˆ†ææ€§èƒ½ç“¶é¢ˆ åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ è¯„ä¼°å®¹é‡è§„åˆ’ 5. ä¼˜åŒ–é˜¶æ®µ å®æ–½ä¼˜åŒ–æ–¹æ¡ˆ å›å½’å‹æµ‹éªŒè¯ æŒç»­è¿­ä»£ä¼˜åŒ– æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼š\nå‹æµ‹ä»·å€¼ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ç³»ç»ŸçœŸå®æ‰¿è½½èƒ½åŠ› æ–¹æ¡ˆè®¾è®¡ï¼šç›®æ ‡è®¾å®šã€æµé‡æ¨¡å‹ã€æ•°æ®éš”ç¦» æµé‡æ ‡è®°ï¼šè¯·æ±‚æ ‡è®°ã€æ•°æ®è·¯ç”±ã€è¡¨ååˆ‡æ¢ å·¥å…·é€‰å‹ï¼šJMeterã€Gatlingã€é˜¿é‡Œäº‘ PTS ç›‘æ§åˆ†æï¼šåº”ç”¨ç›‘æ§ã€ç³»ç»Ÿç›‘æ§ã€æ•°æ®åº“ç›‘æ§ æ€§èƒ½ä¼˜åŒ–ï¼šæ…¢æŸ¥è¯¢ã€ç¼“å­˜ç©¿é€ã€çº¿ç¨‹æ±  å‹æµ‹æµç¨‹ï¼šå‡†å¤‡ã€é¢„æ¼”ã€æ­£å¼ã€åˆ†æã€ä¼˜åŒ– åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå…¨é“¾è·¯å‹æµ‹æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦ï¼š\nå®šæœŸå‹æµ‹ï¼šæ¯æ¬¡å¤§ä¿ƒå‰ã€é‡å¤§åŠŸèƒ½ä¸Šçº¿å‰ æŒç»­ä¼˜åŒ–ï¼šæ ¹æ®å‹æµ‹ç»“æœä¸æ–­ä¼˜åŒ– å®¹é‡è§„åˆ’ï¼šä¸ºä¸šåŠ¡å¢é•¿é¢„ç•™èµ„æº åº”æ€¥é¢„æ¡ˆï¼šåˆ¶å®šé™çº§ã€é™æµã€ç†”æ–­ç­–ç•¥ ä¸‹æ¬¡å½“ä½ éœ€è¦éªŒè¯ç³»ç»Ÿæ‰¿è½½èƒ½åŠ›æ—¶ï¼Œä¸å¦¨è¯•è¯•å…¨é“¾è·¯å‹æµ‹è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ã€‚\n","permalink":"http://localhost:1313/posts/2025/09/%E5%85%A8%E9%93%BE%E8%B7%AF%E5%8E%8B%E6%B5%8B%E5%A6%82%E4%BD%95%E9%AA%8C%E8%AF%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%9C%9F%E5%AE%9E%E6%89%BF%E8%BD%BD%E8%83%BD%E5%8A%9B/","summary":"\u003cp\u003eåœ¨å¤§ä¿ƒã€ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œç³»ç»Ÿèƒ½å¦æ‰›ä½æµé‡å†²å‡»æ˜¯æ¯ä¸ªæŠ€æœ¯å›¢é˜Ÿæœ€å…³å¿ƒçš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„å•æ¥å£å‹æµ‹æ— æ³•çœŸå®åæ˜ ç³»ç»Ÿçš„æ•´ä½“æ‰¿è½½èƒ½åŠ›ï¼Œè€Œå…¨é“¾è·¯å‹æµ‹é€šè¿‡æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºï¼Œå¯ä»¥å…¨é¢éªŒè¯ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†æ·±å…¥è®²è§£å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºå®Œæ•´çš„å‹æµ‹ä½“ç³»ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å…¨é“¾è·¯å‹æµ‹çš„æ ¸å¿ƒä»·å€¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å‹æµ‹ç¯å¢ƒçš„æ­å»ºæ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šæ•°æ®éš”ç¦»ä¸æµé‡æ ‡è®°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å‹æµ‹å·¥å…·çš„é€‰å‹ä¸ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ€§èƒ½ç“¶é¢ˆçš„åˆ†æä¸ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹\"\u003eä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹\u003c/h2\u003e\n\u003ch3 id=\"ä¼ ç»Ÿå‹æµ‹-vs-å…¨é“¾è·¯å‹æµ‹\"\u003eä¼ ç»Ÿå‹æµ‹ vs å…¨é“¾è·¯å‹æµ‹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿå‹æµ‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé’ˆå¯¹å•ä¸ªæ¥å£æˆ–æœåŠ¡è¿›è¡Œå‹æµ‹\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨æµ‹è¯•ç¯å¢ƒæˆ–é¢„å‘å¸ƒç¯å¢ƒ\u003c/li\u003e\n\u003cli\u003eæ•°æ®é‡å°ï¼Œæ— æ³•åæ˜ çœŸå®æƒ…å†µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå…¨é“¾è·¯å‹æµ‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå‹æµ‹\u003c/li\u003e\n\u003cli\u003eæ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„å®Œæ•´ä¸šåŠ¡æµç¨‹\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨çœŸå®çš„æ•°æ®é‡å’Œç³»ç»Ÿé…ç½®\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"å…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼\"\u003eå…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eçœŸå®æ€§\u003c/strong\u003eï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œç»“æœæœ€å¯ä¿¡\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå…¨é¢æ€§\u003c/strong\u003eï¼šè¦†ç›–æ‰€æœ‰ç³»ç»Ÿç»„ä»¶å’Œä¾èµ–\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåŠæ—¶æ€§\u003c/strong\u003eï¼šæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæŒ‡å¯¼æ€§\u003c/strong\u003eï¼šä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æŒ\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"å‹æµ‹åœºæ™¯\"\u003eå‹æµ‹åœºæ™¯\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eç”¨æˆ·è®¿é—® â†’ ç½‘å…³ â†’ åº”ç”¨æœåŠ¡ â†’ ç¼“å­˜ â†’ æ•°æ®åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e                â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e            æ¶ˆæ¯é˜Ÿåˆ— â†’ å¼‚æ­¥æœåŠ¡\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e                â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e            ç¬¬ä¸‰æ–¹æœåŠ¡\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e å…¨é“¾è·¯å‹æµ‹ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯ä¸šåŠ¡é—®é¢˜ã€‚éœ€è¦äº§å“ã€è¿è¥ã€æŠ€æœ¯å›¢é˜Ÿå…±åŒå‚ä¸ï¼Œåˆ¶å®šåˆç†çš„å‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡†ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"å‹æµ‹æ–¹æ¡ˆè®¾è®¡\"\u003eå‹æµ‹æ–¹æ¡ˆè®¾è®¡\u003c/h2\u003e\n\u003ch3 id=\"1-å‹æµ‹ç›®æ ‡è®¾å®š\"\u003e1. å‹æµ‹ç›®æ ‡è®¾å®š\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæ€§èƒ½æŒ‡æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eTPS/QPS\u003c/strong\u003eï¼šæ¯ç§’äº‹åŠ¡æ•°/æŸ¥è¯¢æ•°\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå“åº”æ—¶é—´\u003c/strong\u003eï¼šP50ã€P95ã€P99\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæˆåŠŸç‡\u003c/strong\u003eï¼šè¯·æ±‚æˆåŠŸçš„æ¯”ä¾‹\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eèµ„æºä½¿ç”¨ç‡\u003c/strong\u003eï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡æŒ‡æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eè®¢å•åˆ›å»ºæˆåŠŸç‡\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ”¯ä»˜æˆåŠŸç‡\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåº“å­˜æ‰£å‡å‡†ç¡®æ€§\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eç¤ºä¾‹ç›®æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå¤§ä¿ƒåœºæ™¯ï¼š\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e- å³°å€¼ TPSï¼š10000\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e- P99 å“åº”æ—¶é—´ï¼š\u0026lt; 500ms\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e- æˆåŠŸç‡ï¼š\u0026gt; 99.9%\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e- CPU ä½¿ç”¨ç‡ï¼š\u0026lt; 70%\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"2-å‹æµ‹æµé‡æ¨¡å‹\"\u003e2. å‹æµ‹æµé‡æ¨¡å‹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæµé‡ç‰¹å¾\u003c/strong\u003eï¼š\u003c/p\u003e","title":"å…¨é“¾è·¯å‹æµ‹ï¼šå¦‚ä½•éªŒè¯ç³»ç»Ÿçš„çœŸå®æ‰¿è½½èƒ½åŠ›"},{"content":"Git å·²ç»æˆä¸ºç°ä»£è½¯ä»¶å¼€å‘çš„æ ‡å‡†ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚ç„¶è€Œï¼Œä»…ä»…ä¼šç”¨ Git å‘½ä»¤æ˜¯ä¸å¤Ÿçš„ï¼Œå¦‚ä½•åœ¨å›¢é˜Ÿä¸­å»ºç«‹é«˜æ•ˆçš„ Git å·¥ä½œæµï¼Œæ‰æ˜¯æå‡å¼€å‘æ•ˆç‡çš„å…³é”®ã€‚\næœ¬æ–‡å°†ä»å®é™…å›¢é˜Ÿåä½œå‡ºå‘ï¼Œæ·±å…¥è®²è§£ Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ å’Œå›¢é˜Ÿå»ºç«‹è§„èŒƒã€é«˜æ•ˆçš„å¼€å‘æµç¨‹ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ä¸»æµ Git å·¥ä½œæµæ¨¡å‹ æŒæ¡åˆ†æ”¯ç®¡ç†çš„æœ€ä½³å®è·µ å­¦ä¼šè§„èŒƒçš„æäº¤ä¿¡æ¯ç¼–å†™ äº†è§£ä»£ç å®¡æŸ¥çš„æµç¨‹ä¸æŠ€å·§ æŒæ¡å†²çªè§£å†³ä¸å›æ»šç­–ç•¥ ä¸»æµ Git å·¥ä½œæµæ¨¡å‹ 1. Git Flow æœ€ç»å…¸çš„åˆ†æ”¯æ¨¡å‹ï¼Œé€‚åˆç‰ˆæœ¬å‘å¸ƒå‘¨æœŸè¾ƒé•¿çš„é¡¹ç›®ï¼š\n1master (ç”Ÿäº§ç¯å¢ƒ) 2 â†“ 3develop (å¼€å‘ç¯å¢ƒ) 4 â†“ 5feature/* (åŠŸèƒ½åˆ†æ”¯) 6release/* (å‘å¸ƒåˆ†æ”¯) 7hotfix/* (çƒ­ä¿®å¤åˆ†æ”¯) åˆ†æ”¯è¯´æ˜ï¼š\nmasterï¼šç”Ÿäº§ç¯å¢ƒä»£ç ï¼Œæ¯ä¸ªæäº¤éƒ½æ˜¯ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬ developï¼šå¼€å‘ç¯å¢ƒä»£ç ï¼Œé›†æˆæ‰€æœ‰åŠŸèƒ½ feature/*ï¼šåŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œå®Œæˆååˆå¹¶å› develop release/*ï¼šå‘å¸ƒå‡†å¤‡åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œæµ‹è¯•é€šè¿‡ååˆå¹¶åˆ° master å’Œ develop hotfix/*ï¼šç´§æ€¥ä¿®å¤åˆ†æ”¯ï¼Œä» master åˆ†å‡ºï¼Œä¿®å¤ååˆå¹¶åˆ° master å’Œ develop å·¥ä½œæµç¨‹ï¼š\n1# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ 2git checkout -b feature/user-login develop 3 4# 2. å¼€å‘åŠŸèƒ½ 5git add . 6git commit -m \u0026#34;feat: å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34; 7 8# 3. åˆå¹¶åˆ° develop 9git checkout develop 10git merge --no-ff feature/user-login 11git branch -d feature/user-login 12 13# 4. åˆ›å»ºå‘å¸ƒåˆ†æ”¯ 14git checkout -b release/1.0.0 develop 15 16# 5. å‘å¸ƒåˆ°ç”Ÿäº§ 17git checkout master 18git merge --no-ff release/1.0.0 19git tag -a v1.0.0 -m \u0026#34;Release version 1.0.0\u0026#34; 20 21# 6. åˆå¹¶å› develop 22git checkout develop 23git merge --no-ff release/1.0.0 24git branch -d release/1.0.0 2. GitHub Flow ç®€åŒ–ç‰ˆå·¥ä½œæµï¼Œé€‚åˆæŒç»­éƒ¨ç½²çš„é¡¹ç›®ï¼š\n1master (ç”Ÿäº§ç¯å¢ƒ) 2 â†“ 3feature/* (åŠŸèƒ½åˆ†æ”¯) å·¥ä½œæµç¨‹ï¼š\n1# 1. ä» master åˆ›å»ºåˆ†æ”¯ 2git checkout -b feature/add-payment master 3 4# 2. å¼€å‘å¹¶æäº¤ 5git add . 6git commit -m \u0026#34;feat: æ·»åŠ æ”¯ä»˜åŠŸèƒ½\u0026#34; 7 8# 3. æ¨é€åˆ°è¿œç¨‹ 9git push origin feature/add-payment 10 11# 4. åˆ›å»º Pull Request 12# åœ¨ GitHub ä¸Šåˆ›å»º PRï¼Œè¿›è¡Œä»£ç å®¡æŸ¥ 13 14# 5. åˆå¹¶åˆ° master 15# å®¡æŸ¥é€šè¿‡åï¼Œåœ¨ GitHub ä¸Šåˆå¹¶ PR 16 17# 6. éƒ¨ç½²åˆ°ç”Ÿäº§ 18# CI/CD è‡ªåŠ¨éƒ¨ç½² 3. GitLab Flow ç»“åˆäº† Git Flow å’Œ GitHub Flow çš„ä¼˜ç‚¹ï¼š\n1master (å¼€å‘ç¯å¢ƒ) 2 â†“ 3pre-production (é¢„å‘å¸ƒç¯å¢ƒ) 4 â†“ 5production (ç”Ÿäº§ç¯å¢ƒ) ç‰¹ç‚¹ï¼š\nä»¥ç¯å¢ƒä¸ºå¯¼å‘çš„åˆ†æ”¯ç­–ç•¥ ä»£ç ä»ä¸Šæ¸¸ç¯å¢ƒæµå‘ä¸‹æ¸¸ç¯å¢ƒ é€‚åˆå¤šç¯å¢ƒéƒ¨ç½²çš„é¡¹ç›® å·¥ä½œæµå¯¹æ¯” å·¥ä½œæµ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ ä¼˜ç‚¹ ç¼ºç‚¹ Git Flow é«˜ ç‰ˆæœ¬å‘å¸ƒå‘¨æœŸé•¿ æµç¨‹æ¸…æ™°ï¼Œé€‚åˆå¤§å›¢é˜Ÿ åˆ†æ”¯å¤šï¼Œæ“ä½œå¤æ‚ GitHub Flow ä½ æŒç»­éƒ¨ç½² ç®€å•ï¼Œå¿«é€Ÿè¿­ä»£ ä¸é€‚åˆå¤šç‰ˆæœ¬ç»´æŠ¤ GitLab Flow ä¸­ å¤šç¯å¢ƒéƒ¨ç½² çµæ´»ï¼Œç¯å¢ƒéš”ç¦» éœ€è¦ CI/CD æ”¯æŒ æ¶æ„æ€è€ƒï¼š é€‰æ‹©å·¥ä½œæµæ—¶ï¼Œè¦è€ƒè™‘å›¢é˜Ÿè§„æ¨¡ã€å‘å¸ƒé¢‘ç‡ã€ç¯å¢ƒæ•°é‡ç­‰å› ç´ ã€‚å°å›¢é˜Ÿæˆ–å¿«é€Ÿè¿­ä»£çš„é¡¹ç›®ï¼Œæ¨è GitHub Flowï¼›å¤§å›¢é˜Ÿæˆ–éœ€è¦å¤šç‰ˆæœ¬ç»´æŠ¤çš„é¡¹ç›®ï¼Œæ¨è Git Flowã€‚\nåˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ åˆ†æ”¯å‘½åè§„èŒƒ 1# åŠŸèƒ½åˆ†æ”¯ 2feature/user-authentication 3feature/payment-integration 4 5# ä¿®å¤åˆ†æ”¯ 6bugfix/login-error 7bugfix/payment-timeout 8 9# çƒ­ä¿®å¤åˆ†æ”¯ 10hotfix/critical-security-issue 11 12# å‘å¸ƒåˆ†æ”¯ 13release/v1.2.0 14 15# æ–‡æ¡£åˆ†æ”¯ 16docs/api-documentation åˆ†æ”¯ä¿æŠ¤è§„åˆ™ åœ¨ GitHub/GitLab ä¸­è®¾ç½®åˆ†æ”¯ä¿æŠ¤ï¼š\nç¦æ­¢ç›´æ¥æ¨é€åˆ° master/main è¦æ±‚ Pull Request å®¡æŸ¥ï¼šè‡³å°‘ 1-2 äººå®¡æŸ¥ è¦æ±‚çŠ¶æ€æ£€æŸ¥é€šè¿‡ï¼šCI/CD æ„å»ºæˆåŠŸ è¦æ±‚åˆ†æ”¯æ˜¯æœ€æ–°çš„ï¼šåˆå¹¶å‰å¿…é¡» rebase è¦æ±‚ç­¾åæäº¤ï¼šä½¿ç”¨ GPG ç­¾å åˆ†æ”¯æ¸…ç† 1# æŸ¥çœ‹å·²åˆå¹¶çš„åˆ†æ”¯ 2git branch --merged 3 4# åˆ é™¤å·²åˆå¹¶çš„æœ¬åœ°åˆ†æ”¯ 5git branch -d feature/user-login 6 7# åˆ é™¤è¿œç¨‹åˆ†æ”¯ 8git push origin --delete feature/user-login 9 10# æ‰¹é‡åˆ é™¤å·²åˆå¹¶çš„æœ¬åœ°åˆ†æ”¯ 11git branch --merged | grep -v \u0026#34;\\*\u0026#34; | grep -v \u0026#34;master\u0026#34; | grep -v \u0026#34;develop\u0026#34; | xargs -n 1 git branch -d æäº¤ä¿¡æ¯è§„èŒƒ Conventional Commits éµå¾ªçº¦å®šå¼æäº¤è§„èŒƒï¼š\n1\u0026lt;type\u0026gt;(\u0026lt;scope\u0026gt;): \u0026lt;subject\u0026gt; 2 3\u0026lt;body\u0026gt; 4 5\u0026lt;footer\u0026gt; Type ç±»å‹ï¼š\nfeatï¼šæ–°åŠŸèƒ½ fixï¼šä¿®å¤ Bug docsï¼šæ–‡æ¡£å˜æ›´ styleï¼šä»£ç æ ¼å¼ï¼ˆä¸å½±å“ä»£ç è¿è¡Œï¼‰ refactorï¼šé‡æ„ï¼ˆæ—¢ä¸æ˜¯æ–°åŠŸèƒ½ä¹Ÿä¸æ˜¯ä¿®å¤ï¼‰ perfï¼šæ€§èƒ½ä¼˜åŒ– testï¼šæµ‹è¯•ç›¸å…³ choreï¼šæ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨ ç¤ºä¾‹ï¼š\n1# æ–°åŠŸèƒ½ 2git commit -m \u0026#34;feat(auth): æ·»åŠ  JWT è®¤è¯åŠŸèƒ½\u0026#34; 3 4# ä¿®å¤ Bug 5git commit -m \u0026#34;fix(payment): ä¿®å¤æ”¯ä»˜é‡‘é¢è®¡ç®—é”™è¯¯ 6 7æ”¯ä»˜é‡‘é¢åœ¨è®¡ç®—æŠ˜æ‰£æ—¶å‡ºç°ç²¾åº¦é—®é¢˜ï¼Œå¯¼è‡´å®é™…æ”¯ä»˜é‡‘é¢ä¸æ­£ç¡®ã€‚ 8æœ¬æ¬¡ä¿®å¤ä½¿ç”¨ BigDecimal è¿›è¡Œç²¾ç¡®è®¡ç®—ã€‚ 9 10Closes #123\u0026#34; 11 12# ç ´åæ€§å˜æ›´ 13git commit -m \u0026#34;feat(api): é‡æ„ç”¨æˆ· API æ¥å£ 14 15BREAKING CHANGE: ç”¨æˆ· API æ¥å£è·¯å¾„ä» /api/user æ”¹ä¸º /api/v2/users\u0026#34; æäº¤æœ€ä½³å®è·µ åŸå­æ€§æäº¤ï¼šæ¯æ¬¡æäº¤åªåšä¸€ä»¶äº‹ æœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯ï¼šæ¸…æ¥šæè¿°åšäº†ä»€ä¹ˆå’Œä¸ºä»€ä¹ˆ é¢‘ç¹æäº¤ï¼šå°æ­¥å¿«è·‘ï¼Œä¾¿äºå›æ»š æäº¤å‰æ£€æŸ¥ï¼šä½¿ç”¨ git diff æ£€æŸ¥å˜æ›´ 1# æŸ¥çœ‹æš‚å­˜åŒºçš„å˜æ›´ 2git diff --staged 3 4# äº¤äº’å¼æš‚å­˜ 5git add -p 6 7# ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤ 8git commit --amend 9 10# ä¿®æ”¹æäº¤ä¿¡æ¯ 11git commit --amend -m \u0026#34;æ–°çš„æäº¤ä¿¡æ¯\u0026#34; ä½¿ç”¨ Commitizen è‡ªåŠ¨ç”Ÿæˆè§„èŒƒçš„æäº¤ä¿¡æ¯ï¼š\n1# å®‰è£… 2npm install -g commitizen cz-conventional-changelog 3 4# åˆå§‹åŒ– 5commitizen init cz-conventional-changelog --save-dev --save-exact 6 7# ä½¿ç”¨ 8git cz ä»£ç å®¡æŸ¥æµç¨‹ Pull Request æ¨¡æ¿ åˆ›å»º .github/pull_request_template.mdï¼š\n1## å˜æ›´è¯´æ˜ 2\u0026lt;!-- ç®€è¦æè¿°æœ¬æ¬¡å˜æ›´çš„å†…å®¹ --\u0026gt; 3 4## å˜æ›´ç±»å‹ 5- [ ] æ–°åŠŸèƒ½ 6- [ ] Bug ä¿®å¤ 7- [ ] é‡æ„ 8- [ ] æ–‡æ¡£æ›´æ–° 9- [ ] æ€§èƒ½ä¼˜åŒ– 10 11## ç›¸å…³ Issue 12\u0026lt;!-- å…³è”çš„ Issue ç¼–å·ï¼Œå¦‚ #123 --\u0026gt; 13 14## æµ‹è¯•è¯´æ˜ 15\u0026lt;!-- å¦‚ä½•æµ‹è¯•æœ¬æ¬¡å˜æ›´ --\u0026gt; 16 17## æˆªå›¾ï¼ˆå¦‚æœé€‚ç”¨ï¼‰ 18\u0026lt;!-- æ·»åŠ æˆªå›¾è¯´æ˜å˜æ›´æ•ˆæœ --\u0026gt; 19 20## æ£€æŸ¥æ¸…å• 21- [ ] ä»£ç éµå¾ªé¡¹ç›®è§„èŒƒ 22- [ ] å·²æ·»åŠ å¿…è¦çš„æµ‹è¯• 23- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ 24- [ ] å·²æ›´æ–°ç›¸å…³æ–‡æ¡£ 25- [ ] æ— æ–°å¢çš„ lint è­¦å‘Š ä»£ç å®¡æŸ¥è¦ç‚¹ åŠŸèƒ½æ€§ï¼š\nä»£ç æ˜¯å¦å®ç°äº†é¢„æœŸåŠŸèƒ½ æ˜¯å¦æœ‰é—æ¼çš„è¾¹ç•Œæƒ…å†µ é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„ å¯è¯»æ€§ï¼š\nå‘½åæ˜¯å¦æ¸…æ™° é€»è¾‘æ˜¯å¦æ˜“æ‡‚ æ˜¯å¦æœ‰å¿…è¦çš„æ³¨é‡Š æ€§èƒ½ï¼š\næ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜ æ•°æ®åº“æŸ¥è¯¢æ˜¯å¦ä¼˜åŒ– æ˜¯å¦æœ‰å†…å­˜æ³„æ¼é£é™© å®‰å…¨æ€§ï¼š\næ˜¯å¦æœ‰å®‰å…¨æ¼æ´ è¾“å…¥éªŒè¯æ˜¯å¦å……åˆ† æ•æ„Ÿä¿¡æ¯æ˜¯å¦æ³„éœ² å¯ç»´æŠ¤æ€§ï¼š\nä»£ç æ˜¯å¦ç¬¦åˆ SOLID åŸåˆ™ æ˜¯å¦æœ‰é‡å¤ä»£ç  æ˜¯å¦æ˜“äºæµ‹è¯• å®¡æŸ¥åé¦ˆæŠ€å·§ å¥½çš„åé¦ˆï¼š\n1å»ºè®®ï¼šè¿™é‡Œå¯ä»¥ä½¿ç”¨ Stream API ç®€åŒ–ä»£ç ï¼Œæé«˜å¯è¯»æ€§ã€‚ 2 3Optional\u0026lt;User\u0026gt; user = users.stream() 4 .filter(u -\u0026gt; u.getId().equals(userId)) 5 .findFirst(); ä¸å¥½çš„åé¦ˆï¼š\n1è¿™æ®µä»£ç å†™å¾—å¤ªçƒ‚äº†ï¼Œé‡å†™å§ã€‚ åŸåˆ™ï¼š\nå¯¹äº‹ä¸å¯¹äºº æä¾›å…·ä½“å»ºè®® è§£é‡ŠåŸå›  ä¿æŒå‹å¥½ å†²çªè§£å†³ é¢„é˜²å†²çª é¢‘ç¹åŒæ­¥ï¼šå®šæœŸä»ä¸»åˆ†æ”¯æ‹‰å–æœ€æ–°ä»£ç  å°æ­¥æäº¤ï¼šå‡å°‘å•æ¬¡å˜æ›´çš„èŒƒå›´ æ¨¡å—åŒ–å¼€å‘ï¼šå‡å°‘å¤šäººä¿®æ”¹åŒä¸€æ–‡ä»¶ 1# å®šæœŸåŒæ­¥ä¸»åˆ†æ”¯ 2git checkout feature/my-feature 3git fetch origin 4git rebase origin/develop è§£å†³å†²çª 1# 1. æ‹‰å–æœ€æ–°ä»£ç  2git fetch origin 3 4# 2. Rebase åˆ°æœ€æ–°çš„ develop 5git rebase origin/develop 6 7# 3. å¦‚æœæœ‰å†²çªï¼ŒGit ä¼šæç¤º 8# æ‰‹åŠ¨è§£å†³å†²çªåï¼š 9git add \u0026lt;å†²çªæ–‡ä»¶\u0026gt; 10git rebase --continue 11 12# 4. å¦‚æœæƒ³æ”¾å¼ƒ rebase 13git rebase --abort Merge vs Rebase Mergeï¼š\n1git checkout develop 2git merge feature/my-feature ä¼˜ç‚¹ï¼šä¿ç•™å®Œæ•´çš„å†å²è®°å½• ç¼ºç‚¹ï¼šäº§ç”Ÿé¢å¤–çš„åˆå¹¶æäº¤ï¼Œå†å²è®°å½•å¤æ‚\nRebaseï¼š\n1git checkout feature/my-feature 2git rebase develop ä¼˜ç‚¹ï¼šä¿æŒçº¿æ€§çš„å†å²è®°å½•ï¼Œæ›´æ¸…æ™° ç¼ºç‚¹ï¼šæ”¹å†™å†å²ï¼Œä¸é€‚åˆå·²æ¨é€çš„åˆ†æ”¯\næ¨èç­–ç•¥ï¼š\nåŠŸèƒ½åˆ†æ”¯å¼€å‘æ—¶ä½¿ç”¨ rebase ä¿æŒåŒæ­¥ åˆå¹¶åˆ°ä¸»åˆ†æ”¯æ—¶ä½¿ç”¨ merge ä¿ç•™å†å² é¿å‘æç¤ºï¼š æ°¸è¿œä¸è¦ rebase å·²ç»æ¨é€åˆ°è¿œç¨‹çš„å…¬å…±åˆ†æ”¯ï¼è¿™ä¼šå¯¼è‡´å…¶ä»–äººçš„å†å²è®°å½•æ··ä¹±ã€‚åªåœ¨æœ¬åœ°åˆ†æ”¯æˆ–ä¸ªäººåˆ†æ”¯ä¸Šä½¿ç”¨ rebaseã€‚\nå›æ»šç­–ç•¥ æ’¤é”€æœ¬åœ°ä¿®æ”¹ 1# æ’¤é”€å·¥ä½œåŒºçš„ä¿®æ”¹ 2git checkout -- \u0026lt;file\u0026gt; 3 4# æ’¤é”€æš‚å­˜åŒºçš„ä¿®æ”¹ 5git reset HEAD \u0026lt;file\u0026gt; 6 7# æ’¤é”€æœ€åä¸€æ¬¡æäº¤ï¼ˆä¿ç•™ä¿®æ”¹ï¼‰ 8git reset --soft HEAD^ 9 10# æ’¤é”€æœ€åä¸€æ¬¡æäº¤ï¼ˆä¸¢å¼ƒä¿®æ”¹ï¼‰ 11git reset --hard HEAD^ æ’¤é”€å·²æ¨é€çš„æäº¤ 1# æ–¹æ³• 1ï¼šRevertï¼ˆæ¨èï¼‰ 2# åˆ›å»ºä¸€ä¸ªæ–°æäº¤æ¥æ’¤é”€ä¹‹å‰çš„æäº¤ 3git revert \u0026lt;commit-hash\u0026gt; 4git push origin master 5 6# æ–¹æ³• 2ï¼šReset + Force Pushï¼ˆå±é™©ï¼‰ 7# åªåœ¨ä¸ªäººåˆ†æ”¯æˆ–ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨ 8git reset --hard \u0026lt;commit-hash\u0026gt; 9git push origin master --force æ¢å¤å·²åˆ é™¤çš„åˆ†æ”¯ 1# æŸ¥çœ‹æ‰€æœ‰æ“ä½œè®°å½• 2git reflog 3 4# æ¢å¤åˆ†æ”¯ 5git checkout -b \u0026lt;branch-name\u0026gt; \u0026lt;commit-hash\u0026gt; ç´§æ€¥å›æ»šç”Ÿäº§ç¯å¢ƒ 1# 1. åˆ›å»º hotfix åˆ†æ”¯ 2git checkout -b hotfix/rollback-v1.2.0 master 3 4# 2. å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ 5git revert \u0026lt;bad-commit-hash\u0026gt; 6 7# 3. æ¨é€å¹¶éƒ¨ç½² 8git push origin hotfix/rollback-v1.2.0 9 10# 4. åˆå¹¶åˆ° master 11git checkout master 12git merge hotfix/rollback-v1.2.0 13git tag -a v1.2.1 -m \u0026#34;Rollback to stable version\u0026#34; 14git push origin master --tags Git Hooks è‡ªåŠ¨åŒ– Pre-commit Hook åœ¨æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ä»£ç ï¼š\n1# .git/hooks/pre-commit 2 3#!/bin/sh 4 5# è¿è¡Œ lint æ£€æŸ¥ 6npm run lint 7if [ $? -ne 0 ]; then 8 echo \u0026#34;Lint æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤\u0026#34; 9 exit 1 10fi 11 12# è¿è¡Œå•å…ƒæµ‹è¯• 13npm run test 14if [ $? -ne 0 ]; then 15 echo \u0026#34;å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤\u0026#34; 16 exit 1 17fi 18 19echo \u0026#34;æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸æäº¤\u0026#34; 20exit 0 Commit-msg Hook æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ï¼š\n1# .git/hooks/commit-msg 2 3#!/bin/sh 4 5commit_msg=$(cat $1) 6 7# æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ 8if ! echo \u0026#34;$commit_msg\u0026#34; | grep -qE \u0026#34;^(feat|fix|docs|style|refactor|perf|test|chore)(\\(.+\\))?: .{1,50}\u0026#34;; then 9 echo \u0026#34;é”™è¯¯ï¼šæäº¤ä¿¡æ¯ä¸ç¬¦åˆè§„èŒƒ\u0026#34; 10 echo \u0026#34;æ ¼å¼ï¼š\u0026lt;type\u0026gt;(\u0026lt;scope\u0026gt;): \u0026lt;subject\u0026gt;\u0026#34; 11 echo \u0026#34;ç¤ºä¾‹ï¼šfeat(auth): æ·»åŠ ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34; 12 exit 1 13fi 14 15exit 0 ä½¿ç”¨ Husky æ›´æ–¹ä¾¿åœ°ç®¡ç† Git Hooksï¼š\n1# å®‰è£… 2npm install husky --save-dev 3 4# åˆå§‹åŒ– 5npx husky install 6 7# æ·»åŠ  pre-commit hook 8npx husky add .husky/pre-commit \u0026#34;npm run lint \u0026amp;\u0026amp; npm run test\u0026#34; 9 10# æ·»åŠ  commit-msg hook 11npx husky add .husky/commit-msg \u0026#39;npx --no -- commitlint --edit \u0026#34;$1\u0026#34;\u0026#39; å›¢é˜Ÿåä½œæŠ€å·§ 1. ä»£ç æ‰€æœ‰æƒ ä½¿ç”¨ CODEOWNERS æ–‡ä»¶ï¼š\n1# .github/CODEOWNERS 2 3# é»˜è®¤æ‰€æœ‰è€… 4* @team-lead 5 6# å‰ç«¯ä»£ç  7/frontend/** @frontend-team 8 9# åç«¯ä»£ç  10/backend/** @backend-team 11 12# æ•°æ®åº“è¿ç§» 13/migrations/** @dba-team @backend-lead 14 15# æ–‡æ¡£ 16/docs/** @tech-writer 2. Issue æ¨¡æ¿ åˆ›å»º .github/ISSUE_TEMPLATE/bug_report.mdï¼š\n1--- 2name: Bug æŠ¥å‘Š 3about: åˆ›å»º Bug æŠ¥å‘Šå¸®åŠ©æˆ‘ä»¬æ”¹è¿› 4title: \u0026#39;[BUG] \u0026#39; 5labels: bug 6assignees: \u0026#39;\u0026#39; 7--- 8 9## Bug æè¿° 10\u0026lt;!-- æ¸…æ™°ç®€æ´åœ°æè¿° Bug --\u0026gt; 11 12## å¤ç°æ­¥éª¤ 131. è®¿é—® \u0026#39;...\u0026#39; 142. ç‚¹å‡» \u0026#39;...\u0026#39; 153. æ»šåŠ¨åˆ° \u0026#39;...\u0026#39; 164. çœ‹åˆ°é”™è¯¯ 17 18## é¢„æœŸè¡Œä¸º 19\u0026lt;!-- æè¿°ä½ æœŸæœ›å‘ç”Ÿä»€ä¹ˆ --\u0026gt; 20 21## å®é™…è¡Œä¸º 22\u0026lt;!-- æè¿°å®é™…å‘ç”Ÿäº†ä»€ä¹ˆ --\u0026gt; 23 24## æˆªå›¾ 25\u0026lt;!-- å¦‚æœé€‚ç”¨ï¼Œæ·»åŠ æˆªå›¾ --\u0026gt; 26 27## ç¯å¢ƒä¿¡æ¯ 28- OS: [e.g. macOS 12.0] 29- Browser: [e.g. Chrome 96] 30- Version: [e.g. 1.2.0] 3. å‘å¸ƒæµç¨‹ 1# 1. æ›´æ–°ç‰ˆæœ¬å· 2npm version patch # 1.0.0 -\u0026gt; 1.0.1 3npm version minor # 1.0.0 -\u0026gt; 1.1.0 4npm version major # 1.0.0 -\u0026gt; 2.0.0 5 6# 2. ç”Ÿæˆ CHANGELOG 7npx conventional-changelog -p angular -i CHANGELOG.md -s 8 9# 3. æäº¤å¹¶æ‰“æ ‡ç­¾ 10git add . 11git commit -m \u0026#34;chore(release): v1.2.0\u0026#34; 12git tag -a v1.2.0 -m \u0026#34;Release version 1.2.0\u0026#34; 13 14# 4. æ¨é€ 15git push origin develop --tags æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº† Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œä»å·¥ä½œæµæ¨¡å‹åˆ°å›¢é˜Ÿåä½œï¼š\nå·¥ä½œæµæ¨¡å‹ï¼šGit Flowã€GitHub Flowã€GitLab Flow çš„é€‰æ‹© åˆ†æ”¯ç®¡ç†ï¼šå‘½åè§„èŒƒã€ä¿æŠ¤è§„åˆ™ã€æ¸…ç†ç­–ç•¥ æäº¤è§„èŒƒï¼šConventional Commitsã€åŸå­æ€§æäº¤ ä»£ç å®¡æŸ¥ï¼šPR æ¨¡æ¿ã€å®¡æŸ¥è¦ç‚¹ã€åé¦ˆæŠ€å·§ å†²çªè§£å†³ï¼šé¢„é˜²ç­–ç•¥ã€Merge vs Rebase å›æ»šç­–ç•¥ï¼šæœ¬åœ°æ’¤é”€ã€è¿œç¨‹å›æ»šã€ç´§æ€¥å¤„ç† è‡ªåŠ¨åŒ–ï¼šGit Hooksã€Husky å›¢é˜Ÿåä½œï¼šCODEOWNERSã€Issue æ¨¡æ¿ã€å‘å¸ƒæµç¨‹ åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒGit å·¥ä½œæµä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œéœ€è¦æ ¹æ®å›¢é˜Ÿè§„æ¨¡ã€é¡¹ç›®ç‰¹ç‚¹ã€å‘å¸ƒé¢‘ç‡ç­‰å› ç´ çµæ´»è°ƒæ•´ã€‚å…³é”®æ˜¯å»ºç«‹è§„èŒƒã€ä¿æŒä¸€è‡´ã€æŒç»­æ”¹è¿›ã€‚\nä¸‹æ¬¡å½“ä½ åœ¨å›¢é˜Ÿä¸­æ¨å¹¿ Git æœ€ä½³å®è·µæ—¶ï¼Œä¸å¦¨ä»æœ¬æ–‡çš„å»ºè®®å¼€å§‹ï¼Œé€æ­¥å»ºç«‹é€‚åˆä½ ä»¬å›¢é˜Ÿçš„å·¥ä½œæµã€‚\n","permalink":"http://localhost:1313/posts/2025/07/git-%E5%B7%A5%E4%BD%9C%E6%B5%81%E4%BB%8E%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86%E5%88%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/","summary":"\u003cp\u003eGit å·²ç»æˆä¸ºç°ä»£è½¯ä»¶å¼€å‘çš„æ ‡å‡†ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚ç„¶è€Œï¼Œä»…ä»…ä¼šç”¨ Git å‘½ä»¤æ˜¯ä¸å¤Ÿçš„ï¼Œå¦‚ä½•åœ¨å›¢é˜Ÿä¸­å»ºç«‹é«˜æ•ˆçš„ Git å·¥ä½œæµï¼Œæ‰æ˜¯æå‡å¼€å‘æ•ˆç‡çš„å…³é”®ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…å›¢é˜Ÿåä½œå‡ºå‘ï¼Œæ·±å…¥è®²è§£ Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ å’Œå›¢é˜Ÿå»ºç«‹è§„èŒƒã€é«˜æ•ˆçš„å¼€å‘æµç¨‹ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¸»æµ Git å·¥ä½œæµæ¨¡å‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡åˆ†æ”¯ç®¡ç†çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§„èŒƒçš„æäº¤ä¿¡æ¯ç¼–å†™\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ä»£ç å®¡æŸ¥çš„æµç¨‹ä¸æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å†²çªè§£å†³ä¸å›æ»šç­–ç•¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸»æµ-git-å·¥ä½œæµæ¨¡å‹\"\u003eä¸»æµ Git å·¥ä½œæµæ¨¡å‹\u003c/h2\u003e\n\u003ch3 id=\"1-git-flow\"\u003e1. Git Flow\u003c/h3\u003e\n\u003cp\u003eæœ€ç»å…¸çš„åˆ†æ”¯æ¨¡å‹ï¼Œé€‚åˆç‰ˆæœ¬å‘å¸ƒå‘¨æœŸè¾ƒé•¿çš„é¡¹ç›®ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003emaster (ç”Ÿäº§ç¯å¢ƒ)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003edevelop (å¼€å‘ç¯å¢ƒ)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003efeature/* (åŠŸèƒ½åˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003erelease/* (å‘å¸ƒåˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003ehotfix/* (çƒ­ä¿®å¤åˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ†æ”¯è¯´æ˜\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003emaster\u003c/code\u003eï¼šç”Ÿäº§ç¯å¢ƒä»£ç ï¼Œæ¯ä¸ªæäº¤éƒ½æ˜¯ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edevelop\u003c/code\u003eï¼šå¼€å‘ç¯å¢ƒä»£ç ï¼Œé›†æˆæ‰€æœ‰åŠŸèƒ½\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003efeature/*\u003c/code\u003eï¼šåŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œå®Œæˆååˆå¹¶å› develop\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003erelease/*\u003c/code\u003eï¼šå‘å¸ƒå‡†å¤‡åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œæµ‹è¯•é€šè¿‡ååˆå¹¶åˆ° master å’Œ develop\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ehotfix/*\u003c/code\u003eï¼šç´§æ€¥ä¿®å¤åˆ†æ”¯ï¼Œä» master åˆ†å‡ºï¼Œä¿®å¤ååˆå¹¶åˆ° master å’Œ develop\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå·¥ä½œæµç¨‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout -b feature/user-login develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. å¼€å‘åŠŸèƒ½\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003egit add .\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003egit commit -m \u003cspan class=\"s2\"\u003e\u0026#34;feat: å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 3. åˆå¹¶åˆ° develop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff feature/user-login\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003egit branch -d feature/user-login\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 4. åˆ›å»ºå‘å¸ƒåˆ†æ”¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout -b release/1.0.0 develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 5. å‘å¸ƒåˆ°ç”Ÿäº§\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout master\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003egit tag -a v1.0.0 -m \u003cspan class=\"s2\"\u003e\u0026#34;Release version 1.0.0\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 6. åˆå¹¶å› develop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003egit branch -d release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"2-github-flow\"\u003e2. GitHub Flow\u003c/h3\u003e\n\u003cp\u003eç®€åŒ–ç‰ˆå·¥ä½œæµï¼Œé€‚åˆæŒç»­éƒ¨ç½²çš„é¡¹ç›®ï¼š\u003c/p\u003e","title":"Git å·¥ä½œæµï¼šä»åˆ†æ”¯ç®¡ç†åˆ°ä»£ç å®¡æŸ¥çš„æœ€ä½³å®è·µ"},{"content":"Nginx ä½œä¸ºé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå·²ç»æˆä¸ºäº’è”ç½‘æ¶æ„ä¸­çš„æ ‡é…ç»„ä»¶ã€‚æ— è®ºæ˜¯é™æ€èµ„æºæœåŠ¡ã€åå‘ä»£ç†è¿˜æ˜¯è´Ÿè½½å‡è¡¡ï¼ŒNginx éƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚\næœ¬æ–‡å°†ä»å®é™…åœºæ™¯å‡ºå‘ï¼Œæ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œå¸®åŠ©ä½ æ„å»ºé«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åå‘ä»£ç†ä¸æ­£å‘ä»£ç†çš„åŒºåˆ« æŒæ¡ Nginx è´Ÿè½½å‡è¡¡çš„å¤šç§ç­–ç•¥ å­¦ä¼šé…ç½®å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» äº†è§£ä¼šè¯ä¿æŒçš„å®ç°æ–¹æ¡ˆ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§ åå‘ä»£ç†åŸºç¡€ æ­£å‘ä»£ç† vs åå‘ä»£ç† æ­£å‘ä»£ç†ï¼šå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®\n1å®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨ 2ï¼ˆå®¢æˆ·ç«¯é…ç½®ä»£ç†ï¼‰ åå‘ä»£ç†ï¼šå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å†³å®šè½¬å‘åˆ°å“ªå°æœåŠ¡å™¨\n1å®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨é›†ç¾¤ 2ï¼ˆæœåŠ¡ç«¯é…ç½®ä»£ç†ï¼‰ åå‘ä»£ç†çš„ä¼˜åŠ¿ è´Ÿè½½å‡è¡¡ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨ éšè—çœŸå®æœåŠ¡å™¨ï¼šæé«˜å®‰å…¨æ€§ SSL å¸è½½ï¼šåœ¨ä»£ç†å±‚å¤„ç† HTTPS ç¼“å­˜é™æ€èµ„æºï¼šå‡è½»åç«¯å‹åŠ› ç»Ÿä¸€å…¥å£ï¼šä¾¿äºç®¡ç†å’Œç›‘æ§ æ¶æ„æ€è€ƒï¼š åå‘ä»£ç†ä¸ä»…æ˜¯æµé‡åˆ†å‘å™¨ï¼Œæ›´æ˜¯æ¶æ„ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•ã€æµé‡æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚\nNginx åå‘ä»£ç†é…ç½® åŸºç¡€é…ç½® 1# /etc/nginx/nginx.conf 2 3user nginx; 4worker_processes auto; # è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° 5error_log /var/log/nginx/error.log warn; 6pid /var/run/nginx.pid; 7 8events { 9 worker_connections 1024; # æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° 10 use epoll; # Linux ä¸‹ä½¿ç”¨ epoll 11} 12 13http { 14 include /etc/nginx/mime.types; 15 default_type application/octet-stream; 16 17 # æ—¥å¿—æ ¼å¼ 18 log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; \u0026#39; 19 \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#39; 20 \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34; \u0026#39; 21 \u0026#39;$request_time $upstream_response_time\u0026#39;; 22 23 access_log /var/log/nginx/access.log main; 24 25 sendfile on; 26 tcp_nopush on; 27 tcp_nodelay on; 28 keepalive_timeout 65; 29 types_hash_max_size 2048; 30 31 # åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶ 32 include /etc/nginx/conf.d/*.conf; 33} ç®€å•åå‘ä»£ç† 1# /etc/nginx/conf.d/api.conf 2 3server { 4 listen 80; 5 server_name api.example.com; 6 7 location / { 8 # ä»£ç†åˆ°åç«¯æœåŠ¡å™¨ 9 proxy_pass http://192.168.1.100:8080; 10 11 # è®¾ç½®è¯·æ±‚å¤´ 12 proxy_set_header Host $host; 13 proxy_set_header X-Real-IP $remote_addr; 14 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 15 proxy_set_header X-Forwarded-Proto $scheme; 16 17 # è¶…æ—¶è®¾ç½® 18 proxy_connect_timeout 60s; 19 proxy_send_timeout 60s; 20 proxy_read_timeout 60s; 21 } 22} è·¯å¾„é‡å†™ 1server { 2 listen 80; 3 server_name api.example.com; 4 5 # å°† /api/v1/users ä»£ç†åˆ° http://backend/users 6 location /api/v1/ { 7 proxy_pass http://backend/; # æ³¨æ„æœ«å°¾çš„ / 8 proxy_set_header Host $host; 9 } 10 11 # å°† /old-api é‡å†™ä¸º /new-api 12 location /old-api { 13 rewrite ^/old-api/(.*)$ /new-api/$1 break; 14 proxy_pass http://backend; 15 } 16} è´Ÿè½½å‡è¡¡ç­–ç•¥ 1. è½®è¯¢ï¼ˆRound Robinï¼‰ é»˜è®¤ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†é…è¯·æ±‚ï¼š\n1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5} 6 7server { 8 listen 80; 9 server_name api.example.com; 10 11 location / { 12 proxy_pass http://backend; 13 } 14} 2. åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰ æ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…ä¸åŒæƒé‡ï¼š\n1upstream backend { 2 server 192.168.1.101:8080 weight=3; # æƒé‡ 3 3 server 192.168.1.102:8080 weight=2; # æƒé‡ 2 4 server 192.168.1.103:8080 weight=1; # æƒé‡ 1 5} æƒé‡ä¸º 3:2:1ï¼Œæ„å‘³ç€æ¯ 6 ä¸ªè¯·æ±‚ä¸­ï¼Œ101 æœåŠ¡å™¨å¤„ç† 3 ä¸ªï¼Œ102 å¤„ç† 2 ä¸ªï¼Œ103 å¤„ç† 1 ä¸ªã€‚\n3. IP Hash æ ¹æ®å®¢æˆ·ç«¯ IP è¿›è¡Œå“ˆå¸Œï¼ŒåŒä¸€ IP çš„è¯·æ±‚æ€»æ˜¯åˆ†é…åˆ°åŒä¸€å°æœåŠ¡å™¨ï¼š\n1upstream backend { 2 ip_hash; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šéœ€è¦ä¼šè¯ä¿æŒçš„åº”ç”¨ï¼ˆå¦‚è´­ç‰©è½¦ã€ç™»å½•çŠ¶æ€ï¼‰\nç¼ºç‚¹ï¼š\nè´Ÿè½½å¯èƒ½ä¸å‡è¡¡ï¼ˆIP åˆ†å¸ƒä¸å‡ï¼‰ æ— æ³•åº”å¯¹æœåŠ¡å™¨æ•…éšœï¼ˆIP é‡æ–°å“ˆå¸Œï¼‰ 4. æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰ å°†è¯·æ±‚åˆ†é…ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ï¼š\n1upstream backend { 2 least_conn; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šè¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚è¾ƒå¤§çš„åº”ç”¨\n5. ä¸€è‡´æ€§å“ˆå¸Œï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ 1upstream backend { 2 hash $request_uri consistent; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šç¼“å­˜æœåŠ¡å™¨é›†ç¾¤\nè´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯” ç­–ç•¥ ä¼˜ç‚¹ ç¼ºç‚¹ é€‚ç”¨åœºæ™¯ è½®è¯¢ ç®€å•ã€å‡è¡¡ æ— ä¼šè¯ä¿æŒ æ— çŠ¶æ€æœåŠ¡ åŠ æƒè½®è¯¢ è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½ æ— ä¼šè¯ä¿æŒ æœåŠ¡å™¨æ€§èƒ½ä¸åŒ IP Hash ä¼šè¯ä¿æŒ è´Ÿè½½å¯èƒ½ä¸å‡ æœ‰çŠ¶æ€æœåŠ¡ æœ€å°‘è¿æ¥ åŠ¨æ€å‡è¡¡ è®¡ç®—å¼€é”€å¤§ é•¿è¿æ¥æœåŠ¡ ä¸€è‡´æ€§å“ˆå¸Œ ç¼“å­˜å‘½ä¸­ç‡é«˜ å®ç°å¤æ‚ ç¼“å­˜é›†ç¾¤ å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» è¢«åŠ¨å¥åº·æ£€æŸ¥ Nginx é»˜è®¤çš„å¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œå½“è¯·æ±‚å¤±è´¥æ—¶æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¯ç”¨ï¼š\n1upstream backend { 2 server 192.168.1.101:8080 max_fails=3 fail_timeout=30s; 3 server 192.168.1.102:8080 max_fails=3 fail_timeout=30s; 4 server 192.168.1.103:8080 max_fails=3 fail_timeout=30s; 5} å‚æ•°è¯´æ˜ï¼š\nmax_fails=3ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡åæ ‡è®°ä¸ºä¸å¯ç”¨ fail_timeout=30sï¼šæ ‡è®°ä¸ºä¸å¯ç”¨åï¼Œ30 ç§’å†…ä¸å†åˆ†é…è¯·æ±‚ ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆNginx Plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ ä½¿ç”¨ nginx_upstream_check_module æ¨¡å—ï¼š\n1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5 6 check interval=3000 rise=2 fall=3 timeout=1000 type=http; 7 check_http_send \u0026#34;HEAD /health HTTP/1.0\\r\\n\\r\\n\u0026#34;; 8 check_http_expect_alive http_2xx http_3xx; 9} 10 11server { 12 listen 80; 13 14 location /status { 15 check_status; 16 access_log off; 17 } 18} å‚æ•°è¯´æ˜ï¼š\ninterval=3000ï¼šæ¯ 3 ç§’æ£€æŸ¥ä¸€æ¬¡ rise=2ï¼šè¿ç»­æˆåŠŸ 2 æ¬¡æ ‡è®°ä¸ºå¯ç”¨ fall=3ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡æ ‡è®°ä¸ºä¸å¯ç”¨ timeout=1000ï¼šè¶…æ—¶æ—¶é—´ 1 ç§’ type=httpï¼šä½¿ç”¨ HTTP åè®®æ£€æŸ¥ å¤‡ç”¨æœåŠ¡å™¨ 1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5 server 192.168.1.104:8080 backup; # å¤‡ç”¨æœåŠ¡å™¨ 6} åªæœ‰å½“æ‰€æœ‰ä¸»æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶ï¼Œæ‰ä¼šä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨ã€‚\næ•…éšœè½¬ç§»é…ç½® 1location / { 2 proxy_pass http://backend; 3 proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504; 4 proxy_next_upstream_tries 2; # æœ€å¤šå°è¯• 2 æ¬¡ 5 proxy_next_upstream_timeout 10s; # æ€»è¶…æ—¶æ—¶é—´ 10 ç§’ 6} ä¼šè¯ä¿æŒæ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šIP Hash 1upstream backend { 2 ip_hash; 3 server 192.168.1.101:8080; 4 server 192.168.1.102:8080; 5} ä¼˜ç‚¹ï¼šé…ç½®ç®€å• ç¼ºç‚¹ï¼šè´Ÿè½½å¯èƒ½ä¸å‡è¡¡\næ–¹æ¡ˆäºŒï¼šCookie ç»‘å®š 1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 5 sticky cookie srv_id expires=1h domain=.example.com path=/; 6} Nginx ä¼šåœ¨å“åº”ä¸­è®¾ç½®ä¸€ä¸ª Cookieï¼Œåç»­è¯·æ±‚æ ¹æ® Cookie è·¯ç”±åˆ°åŒä¸€å°æœåŠ¡å™¨ã€‚\næ–¹æ¡ˆä¸‰ï¼šSession å…±äº«ï¼ˆæ¨èï¼‰ ä¸ä¾èµ– Nginxï¼Œåœ¨åº”ç”¨å±‚å®ç° Session å…±äº«ï¼š\nä½¿ç”¨ Redis å­˜å‚¨ Sessionï¼š\n1@Configuration 2@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800) 3public class SessionConfig { 4 5 @Bean 6 public LettuceConnectionFactory connectionFactory() { 7 return new LettuceConnectionFactory(); 8 } 9} ä½¿ç”¨ JWT Tokenï¼š\n1@RestController 2public class AuthController { 3 4 @PostMapping(\u0026#34;/login\u0026#34;) 5 public Result login(@RequestBody LoginRequest request) { 6 // éªŒè¯ç”¨æˆ·åå¯†ç  7 User user = userService.authenticate(request.getUsername(), request.getPassword()); 8 9 // ç”Ÿæˆ JWT Token 10 String token = JwtUtil.generateToken(user.getId()); 11 12 return Result.success(token); 13 } 14} æ¶æ„æ€è€ƒï¼š ä¼šè¯ä¿æŒçš„æœ€ä½³å®è·µæ˜¯åœ¨åº”ç”¨å±‚å®ç°æ— çŠ¶æ€åŒ–ã€‚é€šè¿‡ Redis å…±äº« Session æˆ–ä½¿ç”¨ JWT Tokenï¼Œå¯ä»¥å®ç°çœŸæ­£çš„æ°´å¹³æ‰©å±•ï¼Œè€Œä¸ä¾èµ–äºè´Ÿè½½å‡è¡¡å™¨çš„ç‰¹å®šåŠŸèƒ½ã€‚\nHTTPS é…ç½® SSL è¯ä¹¦é…ç½® 1server { 2 listen 443 ssl http2; 3 server_name api.example.com; 4 5 # SSL è¯ä¹¦ 6 ssl_certificate /etc/nginx/ssl/api.example.com.crt; 7 ssl_certificate_key /etc/nginx/ssl/api.example.com.key; 8 9 # SSL åè®®å’ŒåŠ å¯†å¥—ä»¶ 10 ssl_protocols TLSv1.2 TLSv1.3; 11 ssl_ciphers \u0026#39;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256\u0026#39;; 12 ssl_prefer_server_ciphers on; 13 14 # SSL ä¼šè¯ç¼“å­˜ 15 ssl_session_cache shared:SSL:10m; 16 ssl_session_timeout 10m; 17 18 # HSTS 19 add_header Strict-Transport-Security \u0026#34;max-age=31536000\u0026#34; always; 20 21 location / { 22 proxy_pass http://backend; 23 proxy_set_header Host $host; 24 proxy_set_header X-Real-IP $remote_addr; 25 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 26 proxy_set_header X-Forwarded-Proto $scheme; 27 } 28} 29 30# HTTP é‡å®šå‘åˆ° HTTPS 31server { 32 listen 80; 33 server_name api.example.com; 34 return 301 https://$server_name$request_uri; 35} å…è´¹ SSL è¯ä¹¦ï¼ˆLet\u0026rsquo;s Encryptï¼‰ 1# å®‰è£… Certbot 2sudo yum install certbot python3-certbot-nginx 3 4# è·å–è¯ä¹¦ 5sudo certbot --nginx -d api.example.com 6 7# è‡ªåŠ¨ç»­æœŸ 8sudo certbot renew --dry-run æ€§èƒ½ä¼˜åŒ– 1. è¿æ¥ä¼˜åŒ– 1http { 2 # é•¿è¿æ¥é…ç½® 3 keepalive_timeout 65; 4 keepalive_requests 100; 5 6 # ä¸Šæ¸¸æœåŠ¡å™¨é•¿è¿æ¥ 7 upstream backend { 8 server 192.168.1.101:8080; 9 server 192.168.1.102:8080; 10 11 keepalive 32; # ä¿æŒ 32 ä¸ªç©ºé—²è¿æ¥ 12 } 13 14 server { 15 location / { 16 proxy_pass http://backend; 17 proxy_http_version 1.1; 18 proxy_set_header Connection \u0026#34;\u0026#34;; 19 } 20 } 21} 2. ç¼“å­˜é…ç½® 1# å®šä¹‰ç¼“å­˜è·¯å¾„ 2proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m; 3 4server { 5 location / { 6 proxy_pass http://backend; 7 8 # å¯ç”¨ç¼“å­˜ 9 proxy_cache my_cache; 10 proxy_cache_valid 200 304 10m; 11 proxy_cache_valid 404 1m; 12 proxy_cache_key $scheme$proxy_host$request_uri; 13 14 # ç¼“å­˜å¤´ä¿¡æ¯ 15 add_header X-Cache-Status $upstream_cache_status; 16 } 17 18 # é™æ€èµ„æºç¼“å­˜ 19 location ~* \\.(jpg|jpeg|png|gif|ico|css|js)$ { 20 proxy_pass http://backend; 21 proxy_cache my_cache; 22 proxy_cache_valid 200 30d; 23 expires 30d; 24 } 25} 3. Gzip å‹ç¼© 1http { 2 gzip on; 3 gzip_vary on; 4 gzip_proxied any; 5 gzip_comp_level 6; 6 gzip_types text/plain text/css text/xml text/javascript 7 application/json application/javascript application/xml+rss 8 application/rss+xml font/truetype font/opentype 9 application/vnd.ms-fontobject image/svg+xml; 10 gzip_disable \u0026#34;msie6\u0026#34;; 11} 4. é™æµé…ç½® 1http { 2 # å®šä¹‰é™æµåŒºåŸŸ 3 limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s; 4 limit_conn_zone $binary_remote_addr zone=conn_limit:10m; 5 6 server { 7 location /api/ { 8 # é™åˆ¶è¯·æ±‚é€Ÿç‡ï¼šæ¯ç§’ 10 ä¸ªè¯·æ±‚ï¼Œçªå‘ 20 ä¸ª 9 limit_req zone=api_limit burst=20 nodelay; 10 11 # é™åˆ¶å¹¶å‘è¿æ¥æ•°ï¼šæ¯ä¸ª IP æœ€å¤š 10 ä¸ªè¿æ¥ 12 limit_conn conn_limit 10; 13 14 proxy_pass http://backend; 15 } 16 } 17} 5. Worker è¿›ç¨‹ä¼˜åŒ– 1# è‡ªåŠ¨è®¾ç½® worker è¿›ç¨‹æ•°ä¸º CPU æ ¸å¿ƒæ•° 2worker_processes auto; 3 4# ç»‘å®š worker è¿›ç¨‹åˆ° CPU æ ¸å¿ƒ 5worker_cpu_affinity auto; 6 7# æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•° 8worker_rlimit_nofile 65535; 9 10events { 11 # æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° 12 worker_connections 10240; 13 14 # ä½¿ç”¨ epoll äº‹ä»¶æ¨¡å‹ 15 use epoll; 16 17 # å°½å¯èƒ½å¤šåœ°æ¥å—è¿æ¥ 18 multi_accept on; 19} ç›‘æ§ä¸æ—¥å¿— è®¿é—®æ—¥å¿—åˆ†æ 1# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ 2log_format detailed \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#39; 3 \u0026#39;\u0026#34;$request\u0026#34; $status $body_bytes_sent \u0026#39; 4 \u0026#39;\u0026#34;$http_referer\u0026#34; \u0026#34;$http_user_agent\u0026#34; \u0026#39; 5 \u0026#39;$request_time $upstream_response_time \u0026#39; 6 \u0026#39;$upstream_addr $upstream_status\u0026#39;; 7 8access_log /var/log/nginx/access.log detailed; ä½¿ç”¨ GoAccess åˆ†ææ—¥å¿— 1# å®‰è£… GoAccess 2sudo yum install goaccess 3 4# å®æ—¶åˆ†ææ—¥å¿— 5goaccess /var/log/nginx/access.log -o /var/www/html/report.html --log-format=COMBINED --real-time-html Nginx çŠ¶æ€ç›‘æ§ 1server { 2 listen 8080; 3 server_name localhost; 4 5 location /nginx_status { 6 stub_status on; 7 access_log off; 8 allow 127.0.0.1; 9 deny all; 10 } 11} è®¿é—® http://localhost:8080/nginx_status æŸ¥çœ‹çŠ¶æ€ï¼š\n1Active connections: 291 2server accepts handled requests 3 16630948 16630948 31070465 4Reading: 6 Writing: 179 Waiting: 106 Prometheus ç›‘æ§ ä½¿ç”¨ nginx-prometheus-exporterï¼š\n1# ä¸‹è½½å¹¶è¿è¡Œ exporter 2docker run -p 9113:9113 nginx/nginx-prometheus-exporter:latest \\ 3 -nginx.scrape-uri=http://nginx:8080/nginx_status ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ 1. é…ç½®æ–‡ä»¶ç»„ç»‡ 1/etc/nginx/ 2â”œâ”€â”€ nginx.conf # ä¸»é…ç½®æ–‡ä»¶ 3â”œâ”€â”€ conf.d/ 4â”‚ â”œâ”€â”€ api.conf # API æœåŠ¡é…ç½® 5â”‚ â”œâ”€â”€ web.conf # Web æœåŠ¡é…ç½® 6â”‚ â””â”€â”€ admin.conf # ç®¡ç†åå°é…ç½® 7â”œâ”€â”€ upstream/ 8â”‚ â”œâ”€â”€ api-backend.conf # API åç«¯æœåŠ¡å™¨åˆ—è¡¨ 9â”‚ â””â”€â”€ web-backend.conf # Web åç«¯æœåŠ¡å™¨åˆ—è¡¨ 10â””â”€â”€ ssl/ 11 â”œâ”€â”€ api.example.com.crt 12 â””â”€â”€ api.example.com.key 2. é…ç½®æ£€æŸ¥ä¸é‡è½½ 1# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³• 2sudo nginx -t 3 4# é‡è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰ 5sudo nginx -s reload 6 7# æŸ¥çœ‹ Nginx ç‰ˆæœ¬å’Œç¼–è¯‘å‚æ•° 8nginx -V 3. å®‰å…¨åŠ å›º 1# éšè— Nginx ç‰ˆæœ¬å· 2server_tokens off; 3 4# é™åˆ¶è¯·æ±‚æ–¹æ³• 5if ($request_method !~ ^(GET|POST|PUT|DELETE|HEAD)$) { 6 return 405; 7} 8 9# é˜²æ­¢ç‚¹å‡»åŠ«æŒ 10add_header X-Frame-Options \u0026#34;SAMEORIGIN\u0026#34; always; 11 12# XSS é˜²æŠ¤ 13add_header X-XSS-Protection \u0026#34;1; mode=block\u0026#34; always; 14 15# å†…å®¹ç±»å‹å—…æ¢é˜²æŠ¤ 16add_header X-Content-Type-Options \u0026#34;nosniff\u0026#34; always; 17 18# CSP ç­–ç•¥ 19add_header Content-Security-Policy \u0026#34;default-src \u0026#39;self\u0026#39;\u0026#34; always; 4. æ—¥å¿—è½®è½¬ 1# /etc/logrotate.d/nginx 2 3/var/log/nginx/*.log { 4 daily 5 missingok 6 rotate 14 7 compress 8 delaycompress 9 notifempty 10 create 0640 nginx adm 11 sharedscripts 12 postrotate 13 [ -f /var/run/nginx.pid ] \u0026amp;\u0026amp; kill -USR1 `cat /var/run/nginx.pid` 14 endscript 15} é¿å‘æç¤ºï¼š ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒåŠ¡å¿…åšå¥½ä»¥ä¸‹å‡ ç‚¹ï¼š1) å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶ï¼›2) ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®ï¼›3) é…ç½®å˜æ›´å‰å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼›4) è®¾ç½®ç›‘æ§å‘Šè­¦ï¼›5) å‡†å¤‡å›æ»šæ–¹æ¡ˆã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº† Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§å®è·µï¼š\nåå‘ä»£ç†ï¼šç†è§£åŸç†ï¼ŒæŒæ¡åŸºç¡€é…ç½®å’Œè·¯å¾„é‡å†™ è´Ÿè½½å‡è¡¡ï¼šæŒæ¡å¤šç§ç­–ç•¥ï¼Œæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ å¥åº·æ£€æŸ¥ï¼šå®ç°æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨è½¬ç§» ä¼šè¯ä¿æŒï¼šäº†è§£å¤šç§æ–¹æ¡ˆï¼Œæ¨èåº”ç”¨å±‚æ— çŠ¶æ€åŒ– HTTPS é…ç½®ï¼šSSL è¯ä¹¦é…ç½®å’Œå®‰å…¨åŠ å›º æ€§èƒ½ä¼˜åŒ–ï¼šè¿æ¥ä¼˜åŒ–ã€ç¼“å­˜ã€å‹ç¼©ã€é™æµç­‰ ç›‘æ§æ—¥å¿—ï¼šæ—¥å¿—åˆ†æå’ŒçŠ¶æ€ç›‘æ§ åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒNginx çš„ä½œç”¨è¿œä¸æ­¢äºæ­¤ã€‚é€šè¿‡åˆç†é…ç½®ï¼Œè¿˜å¯ä»¥å®ç°ï¼š\nç°åº¦å‘å¸ƒï¼šæ ¹æ®æ¡ä»¶å°†éƒ¨åˆ†æµé‡å¯¼å‘æ–°ç‰ˆæœ¬ A/B æµ‹è¯•ï¼šå°†ä¸åŒç”¨æˆ·å¯¼å‘ä¸åŒç‰ˆæœ¬ æµé‡æ§åˆ¶ï¼šé™æµã€ç†”æ–­ã€é™çº§ å®‰å…¨é˜²æŠ¤ï¼šWAFã€DDoS é˜²æŠ¤ ä¸‹æ¬¡å½“ä½ éœ€è¦æ­å»ºé«˜å¯ç”¨æœåŠ¡æ¶æ„æ—¶ï¼ŒNginx å°†æ˜¯ä½ çš„å¾—åŠ›åŠ©æ‰‹ã€‚\n","permalink":"http://localhost:1313/posts/2025/06/nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E6%88%98%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E4%BC%98%E5%8C%96/","summary":"\u003cp\u003eNginx ä½œä¸ºé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå·²ç»æˆä¸ºäº’è”ç½‘æ¶æ„ä¸­çš„æ ‡é…ç»„ä»¶ã€‚æ— è®ºæ˜¯é™æ€èµ„æºæœåŠ¡ã€åå‘ä»£ç†è¿˜æ˜¯è´Ÿè½½å‡è¡¡ï¼ŒNginx éƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…åœºæ™¯å‡ºå‘ï¼Œæ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œå¸®åŠ©ä½ æ„å»ºé«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åå‘ä»£ç†ä¸æ­£å‘ä»£ç†çš„åŒºåˆ«\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Nginx è´Ÿè½½å‡è¡¡çš„å¤šç§ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé…ç½®å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ä¼šè¯ä¿æŒçš„å®ç°æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åå‘ä»£ç†åŸºç¡€\"\u003eåå‘ä»£ç†åŸºç¡€\u003c/h2\u003e\n\u003ch3 id=\"æ­£å‘ä»£ç†-vs-åå‘ä»£ç†\"\u003eæ­£å‘ä»£ç† vs åå‘ä»£ç†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæ­£å‘ä»£ç†\u003c/strong\u003eï¼šå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eï¼ˆå®¢æˆ·ç«¯é…ç½®ä»£ç†ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåå‘ä»£ç†\u003c/strong\u003eï¼šå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å†³å®šè½¬å‘åˆ°å“ªå°æœåŠ¡å™¨\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨é›†ç¾¤\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eï¼ˆæœåŠ¡ç«¯é…ç½®ä»£ç†ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"åå‘ä»£ç†çš„ä¼˜åŠ¿\"\u003eåå‘ä»£ç†çš„ä¼˜åŠ¿\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eè´Ÿè½½å‡è¡¡\u003c/strong\u003eï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eéšè—çœŸå®æœåŠ¡å™¨\u003c/strong\u003eï¼šæé«˜å®‰å…¨æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSSL å¸è½½\u003c/strong\u003eï¼šåœ¨ä»£ç†å±‚å¤„ç† HTTPS\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç¼“å­˜é™æ€èµ„æº\u003c/strong\u003eï¼šå‡è½»åç«¯å‹åŠ›\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç»Ÿä¸€å…¥å£\u003c/strong\u003eï¼šä¾¿äºç®¡ç†å’Œç›‘æ§\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e åå‘ä»£ç†ä¸ä»…æ˜¯æµé‡åˆ†å‘å™¨ï¼Œæ›´æ˜¯æ¶æ„ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•ã€æµé‡æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"nginx-åå‘ä»£ç†é…ç½®\"\u003eNginx åå‘ä»£ç†é…ç½®\u003c/h2\u003e\n\u003ch3 id=\"åŸºç¡€é…ç½®\"\u003eåŸºç¡€é…ç½®\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /etc/nginx/nginx.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euser\u003c/span\u003e \u003cspan class=\"s\"\u003enginx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eworker_processes\u003c/span\u003e \u003cspan class=\"s\"\u003eauto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eerror_log\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/nginx/error.log\u003c/span\u003e \u003cspan class=\"s\"\u003ewarn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003epid\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/nginx.pid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eevents\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eworker_connections\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003euse\u003c/span\u003e \u003cspan class=\"s\"\u003eepoll\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# Linux ä¸‹ä½¿ç”¨ epoll\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ehttp\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003einclude\u003c/span\u003e \u003cspan class=\"s\"\u003e/etc/nginx/mime.types\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003edefault_type\u003c/span\u003e \u003cspan class=\"s\"\u003eapplication/octet-stream\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# æ—¥å¿—æ ¼å¼\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elog_format\u003c/span\u003e \u003cspan class=\"s\"\u003emain\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e \u003cspan class=\"s\"\u003e-\u003c/span\u003e \u003cspan class=\"nv\"\u003e$remote_user\u003c/span\u003e \u003cspan class=\"s\"\u003e[\u003c/span\u003e\u003cspan class=\"nv\"\u003e$time_local]\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$request\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$status\u003c/span\u003e \u003cspan class=\"nv\"\u003e$body_bytes_sent\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_referer\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_user_agent\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_x_forwarded_for\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$request_time\u003c/span\u003e \u003cspan class=\"nv\"\u003e$upstream_response_time\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eaccess_log\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/nginx/access.log\u003c/span\u003e \u003cspan class=\"s\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003esendfile\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etcp_nopush\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etcp_nodelay\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003ekeepalive_timeout\u003c/span\u003e \u003cspan class=\"mi\"\u003e65\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etypes_hash_max_size\u003c/span\u003e \u003cspan class=\"mi\"\u003e2048\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003einclude\u003c/span\u003e \u003cspan class=\"s\"\u003e/etc/nginx/conf.d/*.conf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ç®€å•åå‘ä»£ç†\"\u003eç®€å•åå‘ä»£ç†\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /etc/nginx/conf.d/api.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eserver\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elisten\u003c/span\u003e \u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eserver_name\u003c/span\u003e \u003cspan class=\"s\"\u003eapi.example.com\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# ä»£ç†åˆ°åç«¯æœåŠ¡å™¨\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://192.168.1.100:8080\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# è®¾ç½®è¯·æ±‚å¤´\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eHost\u003c/span\u003e \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Real-IP\u003c/span\u003e \u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Forwarded-For\u003c/span\u003e \u003cspan class=\"nv\"\u003e$proxy_add_x_forwarded_for\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Forwarded-Proto\u003c/span\u003e \u003cspan class=\"nv\"\u003e$scheme\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# è¶…æ—¶è®¾ç½®\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_connect_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_send_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_read_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"è·¯å¾„é‡å†™\"\u003eè·¯å¾„é‡å†™\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eserver\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elisten\u003c/span\u003e \u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eserver_name\u003c/span\u003e \u003cspan class=\"s\"\u003eapi.example.com\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# å°† /api/v1/users ä»£ç†åˆ° http://backend/users\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/api/v1/\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://backend/\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# æ³¨æ„æœ«å°¾çš„ /\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eHost\u003c/span\u003e \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# å°† /old-api é‡å†™ä¸º /new-api\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/old-api\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003erewrite\u003c/span\u003e \u003cspan class=\"s\"\u003e^/old-api/(.*)\u003c/span\u003e$ \u003cspan class=\"s\"\u003e/new-api/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e \u003cspan class=\"s\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://backend\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"è´Ÿè½½å‡è¡¡ç­–ç•¥\"\u003eè´Ÿè½½å‡è¡¡ç­–ç•¥\u003c/h2\u003e\n\u003ch3 id=\"1-è½®è¯¢round-robin\"\u003e1. è½®è¯¢ï¼ˆRound Robinï¼‰\u003c/h3\u003e\n\u003cp\u003eé»˜è®¤ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†é…è¯·æ±‚ï¼š\u003c/p\u003e","title":"Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ–"},{"content":"åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¤§æ•°æ®é‡å¯¼å‡ºæ˜¯ä¸€ä¸ªå¸¸è§ä½†æ£˜æ‰‹çš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„ Apache POI åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºï¼Œè€Œé˜¿é‡Œå¼€æºçš„ EasyExcel é€šè¿‡ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œå¯ä»¥è½»æ¾å¤„ç†ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€‚\næœ¬æ–‡å°†ä»å®é™…é—®é¢˜å‡ºå‘ï¼Œæ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°é«˜æ€§èƒ½çš„å¤§æ•°æ®é‡å¯¼å‡ºï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¼˜åŒ–ç»éªŒã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜ æŒæ¡ EasyExcel çš„æ ¸å¿ƒåŸç† å­¦ä¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„æœ€ä½³å®è·µ äº†è§£å¼‚æ­¥å¯¼å‡ºä¸è¿›åº¦åé¦ˆæ–¹æ¡ˆ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§ ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜ é—®é¢˜åœºæ™¯ æŸç”µå•†ç³»ç»Ÿéœ€è¦å¯¼å‡ºè®¢å•æ•°æ®ï¼Œæ•°æ®é‡è¾¾åˆ° 100 ä¸‡æ¡ã€‚ä½¿ç”¨ä¼ ç»Ÿçš„ Apache POI å®ç°ï¼š\n1// ä¼ ç»Ÿ POI å®ç°ï¼ˆæœ‰é—®é¢˜çš„ä»£ç ï¼‰ 2public void exportOrders() { 3 Workbook workbook = new XSSFWorkbook(); 4 Sheet sheet = workbook.createSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;); 5 6 // æŸ¥è¯¢ 100 ä¸‡æ¡æ•°æ® 7 List\u0026lt;Order\u0026gt; orders = orderMapper.selectAll(); 8 9 // å†™å…¥ Excel 10 for (int i = 0; i \u0026lt; orders.size(); i++) { 11 Row row = sheet.createRow(i); 12 Order order = orders.get(i); 13 row.createCell(0).setCellValue(order.getOrderNo()); 14 row.createCell(1).setCellValue(order.getUserName()); 15 // ... æ›´å¤šå­—æ®µ 16 } 17 18 // è¾“å‡ºæ–‡ä»¶ 19 FileOutputStream fos = new FileOutputStream(\u0026#34;orders.xlsx\u0026#34;); 20 workbook.write(fos); 21 fos.close(); 22} å†…å­˜åˆ†æ è¿™æ®µä»£ç å­˜åœ¨ä¸¥é‡çš„å†…å­˜é—®é¢˜ï¼š\nä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®ï¼š100 ä¸‡æ¡æ•°æ®å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ POI å¯¹è±¡å ç”¨å¤§ï¼šæ¯ä¸ª Cellã€Rowã€Sheet éƒ½æ˜¯ Java å¯¹è±¡ å†…å­˜æ— æ³•é‡Šæ”¾ï¼šæ•°æ®å†™å…¥å‰å¿…é¡»å…¨éƒ¨ä¿å­˜åœ¨å†…å­˜ä¸­ å†…å­˜å ç”¨ä¼°ç®—ï¼š\næ¯æ¡è®¢å•æ•°æ®ï¼šçº¦ 1KB 100 ä¸‡æ¡æ•°æ®ï¼šçº¦ 1GB POI å¯¹è±¡å¼€é”€ï¼šçº¦ 3-5 å€ æ€»å†…å­˜å ç”¨ï¼š3-5GB æ¶æ„æ€è€ƒï¼š ä¼ ç»Ÿ POI é‡‡ç”¨ DOM æ¨¡å¼ï¼Œéœ€è¦åœ¨å†…å­˜ä¸­æ„å»ºå®Œæ•´çš„æ–‡æ¡£å¯¹è±¡æ¨¡å‹ã€‚è¿™ç§æ–¹å¼è™½ç„¶çµæ´»ï¼Œä½†åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚EasyExcel é‡‡ç”¨ SAX æ¨¡å¼ï¼Œè¾¹è¯»è¾¹å†™ï¼Œå¤§å¤§é™ä½äº†å†…å­˜å ç”¨ã€‚\nEasyExcel æ ¸å¿ƒåŸç† å†…å­˜ä¼˜åŒ–ç­–ç•¥ EasyExcel é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¼˜åŒ–å†…å­˜ï¼š\næµå¼å†™å…¥ï¼šä¸åœ¨å†…å­˜ä¸­ä¿å­˜å®Œæ•´çš„ Excel å¯¹è±¡ åˆ†æ‰¹å¤„ç†ï¼šæ”¯æŒåˆ†æ‰¹æŸ¥è¯¢å’Œå†™å…¥ ä¸´æ—¶æ–‡ä»¶ï¼šä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ç¼“å­˜æ•°æ® å¯¹è±¡å¤ç”¨ï¼šå¤ç”¨ Java å¯¹è±¡ï¼Œå‡å°‘ GC å‹åŠ› å†…å­˜å ç”¨å¯¹æ¯” æ–¹æ¡ˆ 10ä¸‡æ¡ 50ä¸‡æ¡ 100ä¸‡æ¡ Apache POI 300MB 1.5GB OOM EasyExcel 20MB 50MB 100MB EasyExcel åŸºç¡€ä½¿ç”¨ é¡¹ç›®ä¾èµ– 1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;easyexcel\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;3.3.2\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; å®šä¹‰æ•°æ®æ¨¡å‹ 1@Data 2public class OrderExportDTO { 3 4 @ExcelProperty(value = \u0026#34;è®¢å•å·\u0026#34;, index = 0) 5 private String orderNo; 6 7 @ExcelProperty(value = \u0026#34;ç”¨æˆ·å\u0026#34;, index = 1) 8 private String userName; 9 10 @ExcelProperty(value = \u0026#34;å•†å“åç§°\u0026#34;, index = 2) 11 private String productName; 12 13 @ExcelProperty(value = \u0026#34;è®¢å•é‡‘é¢\u0026#34;, index = 3) 14 @NumberFormat(\u0026#34;#.##\u0026#34;) 15 private BigDecimal amount; 16 17 @ExcelProperty(value = \u0026#34;è®¢å•çŠ¶æ€\u0026#34;, index = 4) 18 @ExcelProperty(converter = OrderStatusConverter.class) 19 private Integer status; 20 21 @ExcelProperty(value = \u0026#34;åˆ›å»ºæ—¶é—´\u0026#34;, index = 5) 22 @DateTimeFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;) 23 private Date createTime; 24} ç®€å•å¯¼å‡ºç¤ºä¾‹ 1@Service 2public class OrderExportService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 /** 8 * ç®€å•å¯¼å‡ºï¼ˆé€‚ç”¨äºå°æ•°æ®é‡ï¼‰ 9 */ 10 public void simpleExport(HttpServletResponse response) throws IOException { 11 // æŸ¥è¯¢æ•°æ® 12 List\u0026lt;OrderExportDTO\u0026gt; data = orderMapper.selectForExport(); 13 14 // è®¾ç½®å“åº”å¤´ 15 response.setContentType(\u0026#34;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\u0026#34;); 16 response.setCharacterEncoding(\u0026#34;utf-8\u0026#34;); 17 String fileName = URLEncoder.encode(\u0026#34;è®¢å•æ•°æ®\u0026#34;, \u0026#34;UTF-8\u0026#34;); 18 response.setHeader(\u0026#34;Content-disposition\u0026#34;, \u0026#34;attachment;filename=\u0026#34; + fileName + \u0026#34;.xlsx\u0026#34;); 19 20 // å†™å…¥ Excel 21 EasyExcel.write(response.getOutputStream(), OrderExportDTO.class) 22 .sheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;) 23 .doWrite(data); 24 } 25} ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºæ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šåˆ†é¡µæŸ¥è¯¢ + æµå¼å†™å…¥ 1@Service 2@Slf4j 3public class LargeDataExportService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 private static final int PAGE_SIZE = 10000; // æ¯é¡µ 1 ä¸‡æ¡ 9 10 /** 11 * åˆ†é¡µå¯¼å‡ºå¤§æ•°æ®é‡ 12 */ 13 public void exportLargeData(HttpServletResponse response) throws IOException { 14 // è®¾ç½®å“åº”å¤´ 15 setResponseHeader(response, \u0026#34;è®¢å•æ•°æ®\u0026#34;); 16 17 // ä½¿ç”¨ EasyExcel çš„æµå¼å†™å…¥ 18 ExcelWriter excelWriter = null; 19 try { 20 excelWriter = EasyExcel.write(response.getOutputStream(), OrderExportDTO.class).build(); 21 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 22 23 // åˆ†é¡µæŸ¥è¯¢å¹¶å†™å…¥ 24 int pageNum = 1; 25 while (true) { 26 log.info(\u0026#34;å¼€å§‹å¯¼å‡ºç¬¬ {} é¡µæ•°æ®\u0026#34;, pageNum); 27 28 // åˆ†é¡µæŸ¥è¯¢ 29 PageHelper.startPage(pageNum, PAGE_SIZE); 30 List\u0026lt;OrderExportDTO\u0026gt; data = orderMapper.selectForExport(); 31 32 if (CollectionUtils.isEmpty(data)) { 33 break; 34 } 35 36 // å†™å…¥å½“å‰é¡µæ•°æ® 37 excelWriter.write(data, writeSheet); 38 39 log.info(\u0026#34;ç¬¬ {} é¡µæ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} æ¡\u0026#34;, pageNum, data.size()); 40 41 // å¦‚æœå½“å‰é¡µæ•°æ®ä¸è¶³ä¸€é¡µï¼Œè¯´æ˜å·²ç»æ˜¯æœ€åä¸€é¡µ 42 if (data.size() \u0026lt; PAGE_SIZE) { 43 break; 44 } 45 46 pageNum++; 47 } 48 49 log.info(\u0026#34;æ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} é¡µ\u0026#34;, pageNum); 50 } finally { 51 if (excelWriter != null) { 52 excelWriter.finish(); 53 } 54 } 55 } 56 57 private void setResponseHeader(HttpServletResponse response, String fileName) throws UnsupportedEncodingException { 58 response.setContentType(\u0026#34;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\u0026#34;); 59 response.setCharacterEncoding(\u0026#34;utf-8\u0026#34;); 60 String encodedFileName = URLEncoder.encode(fileName, \u0026#34;UTF-8\u0026#34;); 61 response.setHeader(\u0026#34;Content-disposition\u0026#34;, \u0026#34;attachment;filename=\u0026#34; + encodedFileName + \u0026#34;.xlsx\u0026#34;); 62 } 63} æ–¹æ¡ˆäºŒï¼šæ¸¸æ ‡æŸ¥è¯¢ + æµå¼å†™å…¥ å¯¹äº MyBatisï¼Œå¯ä»¥ä½¿ç”¨æ¸¸æ ‡ï¼ˆCursorï¼‰è¿›ä¸€æ­¥ä¼˜åŒ–å†…å­˜ï¼š\n1/** 2 * Mapper æ¥å£ 3 */ 4public interface OrderMapper { 5 /** 6 * ä½¿ç”¨æ¸¸æ ‡æŸ¥è¯¢ï¼ˆæµå¼æŸ¥è¯¢ï¼‰ 7 */ 8 @Options(resultSetType = ResultSetType.FORWARD_ONLY, fetchSize = 1000) 9 @Select(\u0026#34;SELECT * FROM t_order WHERE status = #{status}\u0026#34;) 10 Cursor\u0026lt;OrderExportDTO\u0026gt; selectByCursor(@Param(\u0026#34;status\u0026#34;) Integer status); 11} 12 13/** 14 * ä½¿ç”¨æ¸¸æ ‡å¯¼å‡º 15 */ 16public void exportWithCursor(HttpServletResponse response) throws IOException { 17 setResponseHeader(response, \u0026#34;è®¢å•æ•°æ®\u0026#34;); 18 19 ExcelWriter excelWriter = null; 20 Cursor\u0026lt;OrderExportDTO\u0026gt; cursor = null; 21 22 try { 23 excelWriter = EasyExcel.write(response.getOutputStream(), OrderExportDTO.class).build(); 24 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 25 26 // æ‰“å¼€æ¸¸æ ‡ 27 cursor = orderMapper.selectByCursor(1); 28 29 List\u0026lt;OrderExportDTO\u0026gt; batch = new ArrayList\u0026lt;\u0026gt;(PAGE_SIZE); 30 int count = 0; 31 32 // éå†æ¸¸æ ‡ 33 for (OrderExportDTO order : cursor) { 34 batch.add(order); 35 count++; 36 37 // æ¯ 1 ä¸‡æ¡å†™å…¥ä¸€æ¬¡ 38 if (batch.size() \u0026gt;= PAGE_SIZE) { 39 excelWriter.write(batch, writeSheet); 40 log.info(\u0026#34;å·²å¯¼å‡º {} æ¡æ•°æ®\u0026#34;, count); 41 batch.clear(); 42 } 43 } 44 45 // å†™å…¥å‰©ä½™æ•°æ® 46 if (!batch.isEmpty()) { 47 excelWriter.write(batch, writeSheet); 48 log.info(\u0026#34;æ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} æ¡\u0026#34;, count); 49 } 50 51 } finally { 52 if (cursor != null) { 53 cursor.close(); 54 } 55 if (excelWriter != null) { 56 excelWriter.finish(); 57 } 58 } 59} é¿å‘æç¤ºï¼š ä½¿ç”¨æ¸¸æ ‡æŸ¥è¯¢æ—¶ï¼Œéœ€è¦æ³¨æ„ï¼š1) å¿…é¡»åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆï¼›2) ä¸èƒ½ä½¿ç”¨åˆ†é¡µæ’ä»¶ï¼›3) éœ€è¦è®¾ç½® fetchSize æ§åˆ¶æ¯æ¬¡ä»æ•°æ®åº“è·å–çš„è®°å½•æ•°ã€‚\nå¼‚æ­¥å¯¼å‡ºæ–¹æ¡ˆ å¯¹äºè¶…å¤§æ•°æ®é‡ï¼ˆç™¾ä¸‡çº§ä»¥ä¸Šï¼‰ï¼ŒåŒæ­¥å¯¼å‡ºä¼šå¯¼è‡´è¯·æ±‚è¶…æ—¶ã€‚æ¨èä½¿ç”¨å¼‚æ­¥å¯¼å‡ºæ–¹æ¡ˆï¼š\næ•´ä½“æ¶æ„ 1ç”¨æˆ·å‘èµ·å¯¼å‡ºè¯·æ±‚ 2 â†“ 3åˆ›å»ºå¯¼å‡ºä»»åŠ¡ï¼ˆè¿”å›ä»»åŠ¡IDï¼‰ 4 â†“ 5å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå¯¼å‡º 6 â†“ 7å¯¼å‡ºå®Œæˆåä¸Šä¼ åˆ° OSS 8 â†“ 9é€šçŸ¥ç”¨æˆ·ä¸‹è½½ å¯¼å‡ºä»»åŠ¡è¡¨ 1CREATE TABLE export_task ( 2 id BIGINT PRIMARY KEY AUTO_INCREMENT, 3 task_id VARCHAR(64) NOT NULL COMMENT \u0026#39;ä»»åŠ¡ID\u0026#39;, 4 file_name VARCHAR(255) NOT NULL COMMENT \u0026#39;æ–‡ä»¶å\u0026#39;, 5 status TINYINT NOT NULL COMMENT \u0026#39;çŠ¶æ€ï¼š0-å¾…å¤„ç†ï¼Œ1-å¤„ç†ä¸­ï¼Œ2-æˆåŠŸï¼Œ3-å¤±è´¥\u0026#39;, 6 total_count INT COMMENT \u0026#39;æ€»è®°å½•æ•°\u0026#39;, 7 exported_count INT COMMENT \u0026#39;å·²å¯¼å‡ºè®°å½•æ•°\u0026#39;, 8 file_url VARCHAR(512) COMMENT \u0026#39;æ–‡ä»¶ä¸‹è½½åœ°å€\u0026#39;, 9 error_msg VARCHAR(1000) COMMENT \u0026#39;é”™è¯¯ä¿¡æ¯\u0026#39;, 10 create_by VARCHAR(64) COMMENT \u0026#39;åˆ›å»ºäºº\u0026#39;, 11 create_time DATETIME NOT NULL, 12 update_time DATETIME NOT NULL, 13 INDEX idx_task_id (task_id), 14 INDEX idx_create_by (create_by) 15) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;å¯¼å‡ºä»»åŠ¡è¡¨\u0026#39;; å¼‚æ­¥å¯¼å‡ºå®ç° 1@Service 2@Slf4j 3public class AsyncExportService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 @Autowired 9 private ExportTaskMapper exportTaskMapper; 10 11 @Autowired 12 private OssService ossService; 13 14 @Autowired 15 private ThreadPoolExecutor exportExecutor; 16 17 /** 18 * åˆ›å»ºå¯¼å‡ºä»»åŠ¡ 19 */ 20 public String createExportTask(String userId) { 21 // ç”Ÿæˆä»»åŠ¡ ID 22 String taskId = UUID.randomUUID().toString().replace(\u0026#34;-\u0026#34;, \u0026#34;\u0026#34;); 23 24 // åˆ›å»ºä»»åŠ¡è®°å½• 25 ExportTask task = new ExportTask(); 26 task.setTaskId(taskId); 27 task.setFileName(\u0026#34;è®¢å•æ•°æ®_\u0026#34; + DateUtil.format(new Date(), \u0026#34;yyyyMMddHHmmss\u0026#34;) + \u0026#34;.xlsx\u0026#34;); 28 task.setStatus(0); // å¾…å¤„ç† 29 task.setCreateBy(userId); 30 task.setCreateTime(new Date()); 31 task.setUpdateTime(new Date()); 32 exportTaskMapper.insert(task); 33 34 // æäº¤å¼‚æ­¥ä»»åŠ¡ 35 exportExecutor.execute(() -\u0026gt; executeExport(taskId)); 36 37 return taskId; 38 } 39 40 /** 41 * æ‰§è¡Œå¯¼å‡º 42 */ 43 private void executeExport(String taskId) { 44 ExportTask task = exportTaskMapper.selectByTaskId(taskId); 45 46 try { 47 // æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­ 48 task.setStatus(1); 49 exportTaskMapper.updateById(task); 50 51 // åˆ›å»ºä¸´æ—¶æ–‡ä»¶ 52 String tempFilePath = \u0026#34;/tmp/\u0026#34; + task.getFileName(); 53 File tempFile = new File(tempFilePath); 54 55 // å¯¼å‡ºæ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶ 56 exportToFile(tempFile, task); 57 58 // ä¸Šä¼ åˆ° OSS 59 String fileUrl = ossService.upload(tempFile, \u0026#34;export/\u0026#34; + task.getFileName()); 60 61 // æ›´æ–°ä»»åŠ¡çŠ¶æ€ 62 task.setStatus(2); // æˆåŠŸ 63 task.setFileUrl(fileUrl); 64 task.setUpdateTime(new Date()); 65 exportTaskMapper.updateById(task); 66 67 // åˆ é™¤ä¸´æ—¶æ–‡ä»¶ 68 tempFile.delete(); 69 70 // å‘é€é€šçŸ¥ï¼ˆé‚®ä»¶ã€ç«™å†…ä¿¡ç­‰ï¼‰ 71 sendNotification(task); 72 73 log.info(\u0026#34;å¯¼å‡ºä»»åŠ¡ {} å®Œæˆ\u0026#34;, taskId); 74 75 } catch (Exception e) { 76 log.error(\u0026#34;å¯¼å‡ºä»»åŠ¡ {} å¤±è´¥\u0026#34;, taskId, e); 77 78 // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥ 79 task.setStatus(3); 80 task.setErrorMsg(e.getMessage()); 81 task.setUpdateTime(new Date()); 82 exportTaskMapper.updateById(task); 83 } 84 } 85 86 /** 87 * å¯¼å‡ºæ•°æ®åˆ°æ–‡ä»¶ 88 */ 89 private void exportToFile(File file, ExportTask task) throws IOException { 90 ExcelWriter excelWriter = null; 91 Cursor\u0026lt;OrderExportDTO\u0026gt; cursor = null; 92 93 try { 94 excelWriter = EasyExcel.write(file, OrderExportDTO.class).build(); 95 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 96 97 cursor = orderMapper.selectByCursor(1); 98 99 List\u0026lt;OrderExportDTO\u0026gt; batch = new ArrayList\u0026lt;\u0026gt;(10000); 100 int totalCount = 0; 101 int exportedCount = 0; 102 103 for (OrderExportDTO order : cursor) { 104 batch.add(order); 105 totalCount++; 106 107 if (batch.size() \u0026gt;= 10000) { 108 excelWriter.write(batch, writeSheet); 109 exportedCount += batch.size(); 110 batch.clear(); 111 112 // æ›´æ–°è¿›åº¦ 113 task.setTotalCount(totalCount); 114 task.setExportedCount(exportedCount); 115 task.setUpdateTime(new Date()); 116 exportTaskMapper.updateById(task); 117 118 log.info(\u0026#34;ä»»åŠ¡ {} å·²å¯¼å‡º {} æ¡æ•°æ®\u0026#34;, task.getTaskId(), exportedCount); 119 } 120 } 121 122 // å†™å…¥å‰©ä½™æ•°æ® 123 if (!batch.isEmpty()) { 124 excelWriter.write(batch, writeSheet); 125 exportedCount += batch.size(); 126 } 127 128 // æ›´æ–°æœ€ç»ˆè®¡æ•° 129 task.setTotalCount(totalCount); 130 task.setExportedCount(exportedCount); 131 task.setUpdateTime(new Date()); 132 exportTaskMapper.updateById(task); 133 134 } finally { 135 if (cursor != null) { 136 cursor.close(); 137 } 138 if (excelWriter != null) { 139 excelWriter.finish(); 140 } 141 } 142 } 143 144 /** 145 * æŸ¥è¯¢ä»»åŠ¡è¿›åº¦ 146 */ 147 public ExportTask queryProgress(String taskId) { 148 return exportTaskMapper.selectByTaskId(taskId); 149 } 150 151 /** 152 * å‘é€é€šçŸ¥ 153 */ 154 private void sendNotification(ExportTask task) { 155 // å‘é€é‚®ä»¶ã€ç«™å†…ä¿¡ç­‰ 156 log.info(\u0026#34;å‘é€å¯¼å‡ºå®Œæˆé€šçŸ¥ç»™ç”¨æˆ· {}\u0026#34;, task.getCreateBy()); 157 } 158} å‰ç«¯è½®è¯¢è¿›åº¦ 1// åˆ›å»ºå¯¼å‡ºä»»åŠ¡ 2async function createExportTask() { 3 const response = await fetch(\u0026#39;/api/export/create\u0026#39;, { 4 method: \u0026#39;POST\u0026#39; 5 }); 6 const data = await response.json(); 7 const taskId = data.taskId; 8 9 // å¼€å§‹è½®è¯¢è¿›åº¦ 10 pollProgress(taskId); 11} 12 13// è½®è¯¢è¿›åº¦ 14function pollProgress(taskId) { 15 const timer = setInterval(async () =\u0026gt; { 16 const response = await fetch(`/api/export/progress/${taskId}`); 17 const task = await response.json(); 18 19 // æ›´æ–°è¿›åº¦æ¡ 20 const progress = task.totalCount \u0026gt; 0 21 ? (task.exportedCount / task.totalCount * 100).toFixed(2) 22 : 0; 23 updateProgressBar(progress); 24 25 // æ£€æŸ¥çŠ¶æ€ 26 if (task.status === 2) { 27 // å¯¼å‡ºæˆåŠŸ 28 clearInterval(timer); 29 showDownloadLink(task.fileUrl); 30 } else if (task.status === 3) { 31 // å¯¼å‡ºå¤±è´¥ 32 clearInterval(timer); 33 showError(task.errorMsg); 34 } 35 }, 2000); // æ¯ 2 ç§’è½®è¯¢ä¸€æ¬¡ 36} æ€§èƒ½ä¼˜åŒ–æŠ€å·§ 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– 1/** 2 * åªæŸ¥è¯¢éœ€è¦å¯¼å‡ºçš„å­—æ®µ 3 */ 4@Select(\u0026#34;SELECT order_no, user_name, product_name, amount, status, create_time \u0026#34; + 5 \u0026#34;FROM t_order WHERE status = #{status}\u0026#34;) 6List\u0026lt;OrderExportDTO\u0026gt; selectForExport(@Param(\u0026#34;status\u0026#34;) Integer status); 7 8/** 9 * æ·»åŠ ç´¢å¼• 10 */ 11CREATE INDEX idx_status_create_time ON t_order(status, create_time); 2. çº¿ç¨‹æ± é…ç½® 1@Configuration 2public class ThreadPoolConfig { 3 4 @Bean(\u0026#34;exportExecutor\u0026#34;) 5 public ThreadPoolExecutor exportExecutor() { 6 return new ThreadPoolExecutor( 7 2, // æ ¸å¿ƒçº¿ç¨‹æ•° 8 5, // æœ€å¤§çº¿ç¨‹æ•° 9 60L, TimeUnit.SECONDS, 10 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 11 new ThreadFactoryBuilder() 12 .setNameFormat(\u0026#34;export-thread-%d\u0026#34;) 13 .build(), 14 new ThreadPoolExecutor.CallerRunsPolicy() 15 ); 16 } 17} 3. è‡ªå®šä¹‰æ ·å¼ 1/** 2 * è‡ªå®šä¹‰è¡¨å¤´æ ·å¼ 3 */ 4public class CustomCellWriteHandler implements CellWriteHandler { 5 6 @Override 7 public void afterCellDispose(WriteSheetHolder writeSheetHolder, 8 WriteTableHolder writeTableHolder, 9 List\u0026lt;WriteCellData\u0026lt;?\u0026gt;\u0026gt; cellDataList, 10 Cell cell, 11 Head head, 12 Integer relativeRowIndex, 13 Boolean isHead) { 14 if (isHead) { 15 // è®¾ç½®è¡¨å¤´æ ·å¼ 16 CellStyle cellStyle = cell.getSheet().getWorkbook().createCellStyle(); 17 cellStyle.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex()); 18 cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND); 19 20 Font font = cell.getSheet().getWorkbook().createFont(); 21 font.setBold(true); 22 font.setFontHeightInPoints((short) 12); 23 cellStyle.setFont(font); 24 25 cell.setCellStyle(cellStyle); 26 } 27 } 28} 29 30// ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼ 31EasyExcel.write(file, OrderExportDTO.class) 32 .registerWriteHandler(new CustomCellWriteHandler()) 33 .sheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;) 34 .doWrite(data); 4. æ•°æ®è½¬æ¢å™¨ 1/** 2 * è®¢å•çŠ¶æ€è½¬æ¢å™¨ 3 */ 4public class OrderStatusConverter implements Converter\u0026lt;Integer\u0026gt; { 5 6 private static final Map\u0026lt;Integer, String\u0026gt; STATUS_MAP = new HashMap\u0026lt;\u0026gt;(); 7 8 static { 9 STATUS_MAP.put(0, \u0026#34;å¾…æ”¯ä»˜\u0026#34;); 10 STATUS_MAP.put(1, \u0026#34;å·²æ”¯ä»˜\u0026#34;); 11 STATUS_MAP.put(2, \u0026#34;å·²å‘è´§\u0026#34;); 12 STATUS_MAP.put(3, \u0026#34;å·²å®Œæˆ\u0026#34;); 13 STATUS_MAP.put(4, \u0026#34;å·²å–æ¶ˆ\u0026#34;); 14 } 15 16 @Override 17 public Class\u0026lt;Integer\u0026gt; supportJavaTypeKey() { 18 return Integer.class; 19 } 20 21 @Override 22 public CellDataTypeEnum supportExcelTypeKey() { 23 return CellDataTypeEnum.STRING; 24 } 25 26 @Override 27 public WriteCellData\u0026lt;?\u0026gt; convertToExcelData(Integer value, ExcelContentProperty contentProperty, 28 GlobalConfiguration globalConfiguration) { 29 return new WriteCellData\u0026lt;\u0026gt;(STATUS_MAP.getOrDefault(value, \u0026#34;æœªçŸ¥\u0026#34;)); 30 } 31} 5. å†…å­˜ç›‘æ§ 1@Component 2@Slf4j 3public class MemoryMonitor { 4 5 @Scheduled(fixedRate = 5000) 6 public void monitorMemory() { 7 Runtime runtime = Runtime.getRuntime(); 8 long totalMemory = runtime.totalMemory(); 9 long freeMemory = runtime.freeMemory(); 10 long usedMemory = totalMemory - freeMemory; 11 long maxMemory = runtime.maxMemory(); 12 13 double usedPercent = (double) usedMemory / maxMemory * 100; 14 15 if (usedPercent \u0026gt; 80) { 16 log.warn(\u0026#34;å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼š{:.2f}%ï¼Œå·²ä½¿ç”¨ï¼š{}MBï¼Œæœ€å¤§ï¼š{}MB\u0026#34;, 17 usedPercent, 18 usedMemory / 1024 / 1024, 19 maxMemory / 1024 / 1024); 20 } 21 } 22} é¿å‘æç¤ºï¼š åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ï¼š1) é™åˆ¶å•æ¬¡å¯¼å‡ºçš„æœ€å¤§è®°å½•æ•°ï¼ˆå¦‚ 100 ä¸‡æ¡ï¼‰ï¼›2) è®¾ç½®å¯¼å‡ºä»»åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼›3) å®šæœŸæ¸…ç†è¿‡æœŸçš„å¯¼å‡ºæ–‡ä»¶ï¼›4) ç›‘æ§å¯¼å‡ºä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºï¼Œä»å†…å­˜é—®é¢˜åˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œæä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼š\nå†…å­˜ä¼˜åŒ–ï¼šä½¿ç”¨ EasyExcel æ›¿ä»£ä¼ ç»Ÿ POIï¼Œå†…å­˜å ç”¨é™ä½ 90% åˆ†æ‰¹å¤„ç†ï¼šé€šè¿‡åˆ†é¡µæŸ¥è¯¢æˆ–æ¸¸æ ‡æŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ® å¼‚æ­¥å¯¼å‡ºï¼šå¯¹äºè¶…å¤§æ•°æ®é‡ï¼Œä½¿ç”¨å¼‚æ­¥ä»»åŠ¡ + è¿›åº¦åé¦ˆ æ€§èƒ½è°ƒä¼˜ï¼šæ•°æ®åº“ä¼˜åŒ–ã€çº¿ç¨‹æ± é…ç½®ã€æ ·å¼å®šåˆ¶ç­‰ ç”Ÿäº§å®è·µï¼šä»»åŠ¡ç®¡ç†ã€æ–‡ä»¶å­˜å‚¨ã€é€šçŸ¥æœºåˆ¶ç­‰ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦è€ƒè™‘ï¼š\næ•°æ®å®‰å…¨ï¼šå¯¼å‡ºæ–‡ä»¶çš„è®¿é—®æƒé™æ§åˆ¶ å¹¶å‘æ§åˆ¶ï¼šé™åˆ¶åŒæ—¶æ‰§è¡Œçš„å¯¼å‡ºä»»åŠ¡æ•°é‡ èµ„æºéš”ç¦»ï¼šå¯¼å‡ºä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥æ±  ç›‘æ§å‘Šè­¦ï¼šå¯¼å‡ºå¤±è´¥ç‡ã€å¹³å‡è€—æ—¶ç­‰æŒ‡æ ‡ ä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°å¤§æ•°æ®é‡å¯¼å‡ºåŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯• EasyExcel è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ã€‚\n","permalink":"http://localhost:1313/posts/2025/05/easyexcel-%E7%99%BE%E4%B8%87%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E7%9A%84%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¤§æ•°æ®é‡å¯¼å‡ºæ˜¯ä¸€ä¸ªå¸¸è§ä½†æ£˜æ‰‹çš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„ Apache POI åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºï¼Œè€Œé˜¿é‡Œå¼€æºçš„ EasyExcel é€šè¿‡ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œå¯ä»¥è½»æ¾å¤„ç†ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…é—®é¢˜å‡ºå‘ï¼Œæ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°é«˜æ€§èƒ½çš„å¤§æ•°æ®é‡å¯¼å‡ºï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¼˜åŒ–ç»éªŒã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ EasyExcel çš„æ ¸å¿ƒåŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¼‚æ­¥å¯¼å‡ºä¸è¿›åº¦åé¦ˆæ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¼ ç»Ÿ-poi-çš„å†…å­˜é—®é¢˜\"\u003eä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜åœºæ™¯\"\u003eé—®é¢˜åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿéœ€è¦å¯¼å‡ºè®¢å•æ•°æ®ï¼Œæ•°æ®é‡è¾¾åˆ° 100 ä¸‡æ¡ã€‚ä½¿ç”¨ä¼ ç»Ÿçš„ Apache POI å®ç°ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// ä¼ ç»Ÿ POI å®ç°ï¼ˆæœ‰é—®é¢˜çš„ä»£ç ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eexportOrders\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eWorkbook\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eXSSFWorkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eSheet\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003esheet\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateSheet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;è®¢å•æ•°æ®\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æŸ¥è¯¢ 100 ä¸‡æ¡æ•°æ®\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectAll\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å†™å…¥ Excel\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eRow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003esheet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateRow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateCell\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003esetCellValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetOrderNo\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateCell\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003esetCellValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserName\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ... æ›´å¤šå­—æ®µ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è¾“å‡ºæ–‡ä»¶\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eFileOutputStream\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eFileOutputStream\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;orders.xlsx\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"å†…å­˜åˆ†æ\"\u003eå†…å­˜åˆ†æ\u003c/h3\u003e\n\u003cp\u003eè¿™æ®µä»£ç å­˜åœ¨ä¸¥é‡çš„å†…å­˜é—®é¢˜ï¼š\u003c/p\u003e","title":"EasyExcel ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„å†…å­˜ä¼˜åŒ–å®æˆ˜"},{"content":"åœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå®æ—¶æ¶ˆæ¯æ¨é€å·²æˆä¸ºæ ‡é…åŠŸèƒ½ã€‚ä»å³æ—¶é€šè®¯ã€åœ¨çº¿å®¢æœåˆ°å®æ—¶ç›‘æ§å¤§å±ï¼Œéƒ½ç¦»ä¸å¼€é«˜æ€§èƒ½çš„æ¶ˆæ¯æ¨é€èƒ½åŠ›ã€‚ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼å­˜åœ¨å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹ç­‰é—®é¢˜ï¼Œè€Œ WebSocket åè®®çš„å‡ºç°å®Œç¾è§£å†³äº†è¿™äº›ç—›ç‚¹ã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty æ¡†æ¶å®ç°åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜ï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¨é€æœåŠ¡ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ WebSocket åè®®åŸç†ä¸æ¡æ‰‹æµç¨‹ å­¦ä¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨ ç†è§£å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ç®¡ç†ç­–ç•¥ æŒæ¡é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±æ–¹æ¡ˆ äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§ ä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket WebSocket åè®®ä¼˜åŠ¿ ç›¸æ¯”ä¼ ç»Ÿçš„ HTTP è½®è¯¢ï¼ŒWebSocket å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\nç‰¹æ€§ HTTP è½®è¯¢ WebSocket é€šä¿¡æ–¹å¼ åŠåŒå·¥ å…¨åŒå·¥ è¿æ¥å¼€é”€ æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥ ä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥ å®æ—¶æ€§ å–å†³äºè½®è¯¢é—´éš”ï¼ˆç§’çº§ï¼‰ æ¯«ç§’çº§ æœåŠ¡å™¨å‹åŠ› é«˜ï¼ˆé¢‘ç¹çš„ HTTP è¯·æ±‚ï¼‰ ä½ï¼ˆé•¿è¿æ¥ï¼‰ å¸¦å®½æ¶ˆè€— é«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰ HTTP å¤´ï¼‰ ä½ï¼ˆåªä¼ è¾“æ•°æ®å¸§ï¼‰ Netty æ¡†æ¶ä¼˜åŠ¿ Netty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\né«˜æ€§èƒ½ï¼šåŸºäº NIOï¼Œæ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥ æ˜“ç”¨æ€§ï¼šæä¾›äº†ä¸°å¯Œçš„ç¼–è§£ç å™¨å’Œå¤„ç†å™¨ ç¨³å®šæ€§ï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯ æ‰©å±•æ€§ï¼šçµæ´»çš„ Pipeline æœºåˆ¶ æ¶æ„æ€è€ƒï¼š é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œä¸ä»…è¦çœ‹æŠ€æœ¯æœ¬èº«çš„ä¼˜åŠ¿ï¼Œæ›´è¦è€ƒè™‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€è¿ç»´æˆæœ¬å’Œç¤¾åŒºç”Ÿæ€ã€‚Netty åœ¨ Java ç”Ÿæ€ä¸­å·²ç»æˆä¸ºäº‹å®æ ‡å‡†ï¼ŒDubboã€RocketMQã€Elasticsearch ç­‰çŸ¥åé¡¹ç›®éƒ½åœ¨ä½¿ç”¨ã€‚\nWebSocket åè®®åŸç† æ¡æ‰‹æµç¨‹ WebSocket åŸºäº HTTP åè®®è¿›è¡Œæ¡æ‰‹ï¼Œç„¶åå‡çº§ä¸º WebSocket åè®®ï¼š\n1å®¢æˆ·ç«¯è¯·æ±‚ï¼š 2GET /chat HTTP/1.1 3Host: server.example.com 4Upgrade: websocket 5Connection: Upgrade 6Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ== 7Sec-WebSocket-Version: 13 8 9æœåŠ¡ç«¯å“åº”ï¼š 10HTTP/1.1 101 Switching Protocols 11Upgrade: websocket 12Connection: Upgrade 13Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo= æ•°æ®å¸§æ ¼å¼ WebSocket ä½¿ç”¨å¸§ï¼ˆFrameï¼‰æ¥ä¼ è¾“æ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ï¼š\næ–‡æœ¬å¸§ï¼šä¼ è¾“ UTF-8 ç¼–ç çš„æ–‡æœ¬ äºŒè¿›åˆ¶å¸§ï¼šä¼ è¾“äºŒè¿›åˆ¶æ•°æ® æ§åˆ¶å¸§ï¼šPingã€Pongã€Close Netty WebSocket æœåŠ¡å™¨å®ç° é¡¹ç›®ä¾èµ– 1\u0026lt;dependencies\u0026gt; 2 \u0026lt;!-- Netty --\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;io.netty\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;netty-all\u0026lt;/artifactId\u0026gt; 6 \u0026lt;version\u0026gt;4.1.100.Final\u0026lt;/version\u0026gt; 7 \u0026lt;/dependency\u0026gt; 8 9 \u0026lt;!-- JSON å¤„ç† --\u0026gt; 10 \u0026lt;dependency\u0026gt; 11 \u0026lt;groupId\u0026gt;com.alibaba.fastjson2\u0026lt;/groupId\u0026gt; 12 \u0026lt;artifactId\u0026gt;fastjson2\u0026lt;/artifactId\u0026gt; 13 \u0026lt;version\u0026gt;2.0.43\u0026lt;/version\u0026gt; 14 \u0026lt;/dependency\u0026gt; 15\u0026lt;/dependencies\u0026gt; æœåŠ¡å™¨å¯åŠ¨ç±» 1@Slf4j 2@Component 3public class WebSocketServer { 4 5 private final int port = 8888; 6 private EventLoopGroup bossGroup; 7 private EventLoopGroup workerGroup; 8 9 @PostConstruct 10 public void start() throws InterruptedException { 11 bossGroup = new NioEventLoopGroup(1); 12 workerGroup = new NioEventLoopGroup(); 13 14 try { 15 ServerBootstrap bootstrap = new ServerBootstrap(); 16 bootstrap.group(bossGroup, workerGroup) 17 .channel(NioServerSocketChannel.class) 18 .childHandler(new WebSocketChannelInitializer()) 19 .option(ChannelOption.SO_BACKLOG, 128) 20 .childOption(ChannelOption.SO_KEEPALIVE, true); 21 22 ChannelFuture future = bootstrap.bind(port).sync(); 23 log.info(\u0026#34;WebSocket æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç«¯å£ï¼š{}\u0026#34;, port); 24 25 // ç­‰å¾…æœåŠ¡å™¨å…³é—­ 26 future.channel().closeFuture().sync(); 27 } finally { 28 shutdown(); 29 } 30 } 31 32 @PreDestroy 33 public void shutdown() { 34 if (bossGroup != null) { 35 bossGroup.shutdownGracefully(); 36 } 37 if (workerGroup != null) { 38 workerGroup.shutdownGracefully(); 39 } 40 log.info(\u0026#34;WebSocket æœåŠ¡å™¨å·²å…³é—­\u0026#34;); 41 } 42} Channel åˆå§‹åŒ–å™¨ 1public class WebSocketChannelInitializer extends ChannelInitializer\u0026lt;SocketChannel\u0026gt; { 2 3 @Override 4 protected void initChannel(SocketChannel ch) { 5 ChannelPipeline pipeline = ch.pipeline(); 6 7 // HTTP ç¼–è§£ç å™¨ 8 pipeline.addLast(new HttpServerCodec()); 9 // HTTP èšåˆå™¨ï¼ˆå°†å¤šä¸ª HTTP æ¶ˆæ¯èšåˆæˆä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼‰ 10 pipeline.addLast(new HttpObjectAggregator(65536)); 11 // HTTP å‹ç¼© 12 pipeline.addLast(new HttpContentCompressor()); 13 14 // WebSocket åè®®å¤„ç†å™¨ï¼ˆå¤„ç†æ¡æ‰‹ã€Closeã€Pingã€Pongï¼‰ 15 pipeline.addLast(new WebSocketServerProtocolHandler(\u0026#34;/ws\u0026#34;, null, true)); 16 17 // å¿ƒè·³æ£€æµ‹ï¼ˆè¯»ç©ºé—² 60 ç§’ï¼Œå†™ç©ºé—² 0 ç§’ï¼Œè¯»å†™ç©ºé—² 0 ç§’ï¼‰ 18 pipeline.addLast(new IdleStateHandler(60, 0, 0, TimeUnit.SECONDS)); 19 20 // è‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†å™¨ 21 pipeline.addLast(new WebSocketHandler()); 22 } 23} ä¸šåŠ¡å¤„ç†å™¨ 1@Slf4j 2@ChannelHandler.Sharable 3public class WebSocketHandler extends SimpleChannelInboundHandler\u0026lt;TextWebSocketFrame\u0026gt; { 4 5 @Override 6 public void channelActive(ChannelHandlerContext ctx) { 7 // è¿æ¥å»ºç«‹æ—¶ 8 Channel channel = ctx.channel(); 9 log.info(\u0026#34;å®¢æˆ·ç«¯è¿æ¥ï¼š{}\u0026#34;, channel.id().asShortText()); 10 11 // å°† Channel åŠ å…¥ç®¡ç†å™¨ 12 ChannelManager.addChannel(channel); 13 } 14 15 @Override 16 protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) { 17 // æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ 18 String content = msg.text(); 19 log.info(\u0026#34;æ”¶åˆ°æ¶ˆæ¯ï¼š{}\u0026#34;, content); 20 21 // è§£ææ¶ˆæ¯ 22 Message message = JSON.parseObject(content, Message.class); 23 24 // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ 25 switch (message.getType()) { 26 case \u0026#34;auth\u0026#34;: 27 handleAuth(ctx, message); 28 break; 29 case \u0026#34;heartbeat\u0026#34;: 30 handleHeartbeat(ctx); 31 break; 32 case \u0026#34;message\u0026#34;: 33 handleMessage(ctx, message); 34 break; 35 default: 36 log.warn(\u0026#34;æœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼š{}\u0026#34;, message.getType()); 37 } 38 } 39 40 @Override 41 public void channelInactive(ChannelHandlerContext ctx) { 42 // è¿æ¥æ–­å¼€æ—¶ 43 Channel channel = ctx.channel(); 44 log.info(\u0026#34;å®¢æˆ·ç«¯æ–­å¼€ï¼š{}\u0026#34;, channel.id().asShortText()); 45 46 // ä»ç®¡ç†å™¨ä¸­ç§»é™¤ 47 ChannelManager.removeChannel(channel); 48 } 49 50 @Override 51 public void userEventTriggered(ChannelHandlerContext ctx, Object evt) { 52 // å¤„ç†ç©ºé—²äº‹ä»¶ 53 if (evt instanceof IdleStateEvent) { 54 IdleStateEvent event = (IdleStateEvent) evt; 55 if (event.state() == IdleState.READER_IDLE) { 56 log.warn(\u0026#34;å®¢æˆ·ç«¯ {} è¯»ç©ºé—²ï¼Œå…³é—­è¿æ¥\u0026#34;, ctx.channel().id().asShortText()); 57 ctx.close(); 58 } 59 } 60 } 61 62 @Override 63 public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) { 64 log.error(\u0026#34;è¿æ¥å¼‚å¸¸ï¼š{}\u0026#34;, cause.getMessage(), cause); 65 ctx.close(); 66 } 67 68 /** 69 * å¤„ç†è®¤è¯æ¶ˆæ¯ 70 */ 71 private void handleAuth(ChannelHandlerContext ctx, Message message) { 72 String userId = message.getUserId(); 73 Channel channel = ctx.channel(); 74 75 // ç»‘å®šç”¨æˆ· ID å’Œ Channel 76 ChannelManager.bindUser(userId, channel); 77 78 // å‘é€è®¤è¯æˆåŠŸæ¶ˆæ¯ 79 Message response = Message.builder() 80 .type(\u0026#34;auth_response\u0026#34;) 81 .content(\u0026#34;è®¤è¯æˆåŠŸ\u0026#34;) 82 .build(); 83 ctx.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(response))); 84 85 log.info(\u0026#34;ç”¨æˆ· {} è®¤è¯æˆåŠŸ\u0026#34;, userId); 86 } 87 88 /** 89 * å¤„ç†å¿ƒè·³æ¶ˆæ¯ 90 */ 91 private void handleHeartbeat(ChannelHandlerContext ctx) { 92 Message response = Message.builder() 93 .type(\u0026#34;heartbeat_response\u0026#34;) 94 .content(\u0026#34;pong\u0026#34;) 95 .build(); 96 ctx.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(response))); 97 } 98 99 /** 100 * å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ 101 */ 102 private void handleMessage(ChannelHandlerContext ctx, Message message) { 103 // æ ¹æ®ä¸šåŠ¡é€»è¾‘å¤„ç†æ¶ˆæ¯ 104 log.info(\u0026#34;å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ï¼š{}\u0026#34;, message.getContent()); 105 106 // ç¤ºä¾‹ï¼šå¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ· 107 ChannelManager.broadcast(message); 108 } 109} è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯æ¨é€ Channel ç®¡ç†å™¨ 1@Slf4j 2public class ChannelManager { 3 4 // æ‰€æœ‰è¿æ¥çš„ Channel 5 private static final ChannelGroup CHANNELS = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE); 6 7 // ç”¨æˆ· ID ä¸ Channel çš„æ˜ å°„ 8 private static final ConcurrentHashMap\u0026lt;String, Channel\u0026gt; USER_CHANNELS = new ConcurrentHashMap\u0026lt;\u0026gt;(); 9 10 /** 11 * æ·»åŠ  Channel 12 */ 13 public static void addChannel(Channel channel) { 14 CHANNELS.add(channel); 15 log.info(\u0026#34;å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}\u0026#34;, CHANNELS.size()); 16 } 17 18 /** 19 * ç§»é™¤ Channel 20 */ 21 public static void removeChannel(Channel channel) { 22 CHANNELS.remove(channel); 23 24 // ç§»é™¤ç”¨æˆ·ç»‘å®š 25 USER_CHANNELS.entrySet().removeIf(entry -\u0026gt; entry.getValue().equals(channel)); 26 27 log.info(\u0026#34;å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}\u0026#34;, CHANNELS.size()); 28 } 29 30 /** 31 * ç»‘å®šç”¨æˆ·å’Œ Channel 32 */ 33 public static void bindUser(String userId, Channel channel) { 34 USER_CHANNELS.put(userId, channel); 35 log.info(\u0026#34;ç”¨æˆ· {} ç»‘å®šæˆåŠŸï¼Œå½“å‰åœ¨çº¿ç”¨æˆ·æ•°ï¼š{}\u0026#34;, userId, USER_CHANNELS.size()); 36 } 37 38 /** 39 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ· 40 */ 41 public static void pushToUser(String userId, Message message) { 42 Channel channel = USER_CHANNELS.get(userId); 43 if (channel != null \u0026amp;\u0026amp; channel.isActive()) { 44 channel.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(message))); 45 log.info(\u0026#34;æ¨é€æ¶ˆæ¯ç»™ç”¨æˆ· {}ï¼š{}\u0026#34;, userId, message.getContent()); 46 } else { 47 log.warn(\u0026#34;ç”¨æˆ· {} ä¸åœ¨çº¿æˆ–è¿æ¥å·²æ–­å¼€\u0026#34;, userId); 48 } 49 } 50 51 /** 52 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ· 53 */ 54 public static void broadcast(Message message) { 55 TextWebSocketFrame frame = new TextWebSocketFrame(JSON.toJSONString(message)); 56 CHANNELS.writeAndFlush(frame); 57 log.info(\u0026#34;å¹¿æ’­æ¶ˆæ¯ç»™ {} ä¸ªç”¨æˆ·ï¼š{}\u0026#34;, CHANNELS.size(), message.getContent()); 58 } 59 60 /** 61 * è·å–åœ¨çº¿ç”¨æˆ·æ•° 62 */ 63 public static int getOnlineUserCount() { 64 return USER_CHANNELS.size(); 65 } 66} æ¶ˆæ¯æ¨é€æœåŠ¡ 1@Slf4j 2@Service 3public class MessagePushService { 4 5 /** 6 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ· 7 */ 8 public void pushToUser(String userId, String content) { 9 Message message = Message.builder() 10 .type(\u0026#34;push\u0026#34;) 11 .content(content) 12 .timestamp(System.currentTimeMillis()) 13 .build(); 14 15 ChannelManager.pushToUser(userId, message); 16 } 17 18 /** 19 * æ¨é€æ¶ˆæ¯ç»™å¤šä¸ªç”¨æˆ· 20 */ 21 public void pushToUsers(List\u0026lt;String\u0026gt; userIds, String content) { 22 Message message = Message.builder() 23 .type(\u0026#34;push\u0026#34;) 24 .content(content) 25 .timestamp(System.currentTimeMillis()) 26 .build(); 27 28 userIds.forEach(userId -\u0026gt; ChannelManager.pushToUser(userId, message)); 29 } 30 31 /** 32 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ· 33 */ 34 public void broadcast(String content) { 35 Message message = Message.builder() 36 .type(\u0026#34;broadcast\u0026#34;) 37 .content(content) 38 .timestamp(System.currentTimeMillis()) 39 .build(); 40 41 ChannelManager.broadcast(message); 42 } 43} å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ä¿æ´» ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³ åœ¨é•¿è¿æ¥åœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nç½‘ç»œä¸­æ–­æ£€æµ‹ï¼šç½‘ç»œå¼‚å¸¸æ—¶ï¼ŒTCP è¿æ¥ä¸ä¼šç«‹å³æ–­å¼€ NAT è¶…æ—¶ï¼šNAT è®¾å¤‡ä¼šæ¸…ç†é•¿æ—¶é—´æ— æ•°æ®ä¼ è¾“çš„è¿æ¥ è´Ÿè½½å‡è¡¡è¶…æ—¶ï¼šè´Ÿè½½å‡è¡¡å™¨å¯èƒ½ä¼šå…³é—­ç©ºé—²è¿æ¥ å¿ƒè·³å®ç°æ–¹æ¡ˆ æœåŠ¡ç«¯å¿ƒè·³æ£€æµ‹ï¼š\n1// åœ¨ ChannelInitializer ä¸­æ·»åŠ  2pipeline.addLast(new IdleStateHandler(60, 0, 0, TimeUnit.SECONDS)); å®¢æˆ·ç«¯å¿ƒè·³å‘é€ï¼ˆJavaScript ç¤ºä¾‹ï¼‰ï¼š\n1class WebSocketClient { 2 constructor(url) { 3 this.url = url; 4 this.ws = null; 5 this.heartbeatTimer = null; 6 this.reconnectTimer = null; 7 } 8 9 connect() { 10 this.ws = new WebSocket(this.url); 11 12 this.ws.onopen = () =\u0026gt; { 13 console.log(\u0026#39;WebSocket è¿æ¥æˆåŠŸ\u0026#39;); 14 this.startHeartbeat(); 15 16 // å‘é€è®¤è¯æ¶ˆæ¯ 17 this.send({ 18 type: \u0026#39;auth\u0026#39;, 19 userId: \u0026#39;user123\u0026#39;, 20 token: \u0026#39;xxx\u0026#39; 21 }); 22 }; 23 24 this.ws.onmessage = (event) =\u0026gt; { 25 const message = JSON.parse(event.data); 26 console.log(\u0026#39;æ”¶åˆ°æ¶ˆæ¯ï¼š\u0026#39;, message); 27 28 // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ 29 switch (message.type) { 30 case \u0026#39;auth_response\u0026#39;: 31 console.log(\u0026#39;è®¤è¯æˆåŠŸ\u0026#39;); 32 break; 33 case \u0026#39;push\u0026#39;: 34 this.handlePush(message); 35 break; 36 case \u0026#39;heartbeat_response\u0026#39;: 37 // æ”¶åˆ°å¿ƒè·³å“åº” 38 break; 39 } 40 }; 41 42 this.ws.onclose = () =\u0026gt; { 43 console.log(\u0026#39;WebSocket è¿æ¥å…³é—­\u0026#39;); 44 this.stopHeartbeat(); 45 this.reconnect(); 46 }; 47 48 this.ws.onerror = (error) =\u0026gt; { 49 console.error(\u0026#39;WebSocket é”™è¯¯ï¼š\u0026#39;, error); 50 }; 51 } 52 53 send(message) { 54 if (this.ws \u0026amp;\u0026amp; this.ws.readyState === WebSocket.OPEN) { 55 this.ws.send(JSON.stringify(message)); 56 } 57 } 58 59 startHeartbeat() { 60 this.heartbeatTimer = setInterval(() =\u0026gt; { 61 this.send({ 62 type: \u0026#39;heartbeat\u0026#39;, 63 timestamp: Date.now() 64 }); 65 }, 30000); // æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ 66 } 67 68 stopHeartbeat() { 69 if (this.heartbeatTimer) { 70 clearInterval(this.heartbeatTimer); 71 this.heartbeatTimer = null; 72 } 73 } 74 75 reconnect() { 76 if (this.reconnectTimer) { 77 return; 78 } 79 80 this.reconnectTimer = setTimeout(() =\u0026gt; { 81 console.log(\u0026#39;å°è¯•é‡æ–°è¿æ¥...\u0026#39;); 82 this.reconnectTimer = null; 83 this.connect(); 84 }, 5000); // 5 ç§’åé‡è¿ 85 } 86 87 handlePush(message) { 88 // å¤„ç†æ¨é€æ¶ˆæ¯ 89 console.log(\u0026#39;æ”¶åˆ°æ¨é€ï¼š\u0026#39;, message.content); 90 } 91 92 close() { 93 this.stopHeartbeat(); 94 if (this.ws) { 95 this.ws.close(); 96 } 97 } 98} 99 100// ä½¿ç”¨ç¤ºä¾‹ 101const client = new WebSocketClient(\u0026#39;ws://localhost:8888/ws\u0026#39;); 102client.connect(); é¿å‘æç¤ºï¼š å¿ƒè·³é—´éš”çš„è®¾ç½®éœ€è¦æƒè¡¡ï¼šé—´éš”å¤ªçŸ­ä¼šå¢åŠ æœåŠ¡å™¨å‹åŠ›ï¼Œé—´éš”å¤ªé•¿å¯èƒ½æ— æ³•åŠæ—¶å‘ç°è¿æ¥æ–­å¼€ã€‚å»ºè®®å®¢æˆ·ç«¯å¿ƒè·³é—´éš”ä¸º 30 ç§’ï¼ŒæœåŠ¡ç«¯è¶…æ—¶æ—¶é—´ä¸º 60 ç§’ã€‚\né›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”± å•æœºæ¶æ„çš„å±€é™ å•æœº WebSocket æœåŠ¡å™¨å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nè¿æ¥æ•°é™åˆ¶ï¼šå•æœºæœ€å¤šæ”¯æŒå‡ ä¸‡åˆ°åå‡ ä¸‡è¿æ¥ å•ç‚¹æ•…éšœï¼šæœåŠ¡å™¨å®•æœºå¯¼è‡´æ‰€æœ‰è¿æ¥æ–­å¼€ æ¶ˆæ¯è·¯ç”±ï¼šæ— æ³•æ¨é€æ¶ˆæ¯ç»™å…¶ä»–æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ· é›†ç¾¤æ¶æ„æ–¹æ¡ˆ 1 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2 â”‚ Nginx â”‚ 3 â”‚ (è´Ÿè½½å‡è¡¡) â”‚ 4 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ 5 â”‚ 6 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 7 â”‚ â”‚ â”‚ 8 â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” 9 â”‚ WS Serverâ”‚ â”‚ WS Serverâ”‚ â”‚ WS Serverâ”‚ 10 â”‚ Node1 â”‚ â”‚ Node2 â”‚ â”‚ Node3 â”‚ 11 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ 12 â”‚ â”‚ â”‚ 13 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 14 â”‚ 15 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” 16 â”‚ Redis â”‚ 17 â”‚ (æ¶ˆæ¯è·¯ç”±) â”‚ 18 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Nginx é…ç½® 1upstream websocket { 2 # IP Hash ç­–ç•¥ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·è¿æ¥åˆ°åŒä¸€å°æœåŠ¡å™¨ 3 ip_hash; 4 5 server 192.168.1.101:8888; 6 server 192.168.1.102:8888; 7 server 192.168.1.103:8888; 8} 9 10server { 11 listen 80; 12 server_name ws.example.com; 13 14 location /ws { 15 proxy_pass http://websocket; 16 proxy_http_version 1.1; 17 proxy_set_header Upgrade $http_upgrade; 18 proxy_set_header Connection \u0026#34;upgrade\u0026#34;; 19 proxy_set_header Host $host; 20 proxy_set_header X-Real-IP $remote_addr; 21 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 22 23 # è¶…æ—¶è®¾ç½® 24 proxy_connect_timeout 60s; 25 proxy_send_timeout 60s; 26 proxy_read_timeout 60s; 27 } 28} Redis æ¶ˆæ¯è·¯ç”± 1@Slf4j 2@Component 3public class RedisMessageRouter { 4 5 @Autowired 6 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 7 8 private static final String CHANNEL_PREFIX = \u0026#34;ws:message:\u0026#34;; 9 10 @PostConstruct 11 public void init() { 12 // è®¢é˜… Redis é¢‘é“ 13 redisTemplate.getConnectionFactory().getConnection() 14 .subscribe((message, pattern) -\u0026gt; { 15 String msg = new String(message.getBody()); 16 handleMessage(msg); 17 }, (CHANNEL_PREFIX + \u0026#34;*\u0026#34;).getBytes()); 18 } 19 20 /** 21 * å‘å¸ƒæ¶ˆæ¯åˆ° Redis 22 */ 23 public void publish(String userId, Message message) { 24 String channel = CHANNEL_PREFIX + userId; 25 redisTemplate.convertAndSend(channel, JSON.toJSONString(message)); 26 } 27 28 /** 29 * å¤„ç†ä» Redis æ¥æ”¶åˆ°çš„æ¶ˆæ¯ 30 */ 31 private void handleMessage(String msg) { 32 Message message = JSON.parseObject(msg, Message.class); 33 String userId = message.getUserId(); 34 35 // å¦‚æœç”¨æˆ·åœ¨æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥æ¨é€ 36 ChannelManager.pushToUser(userId, message); 37 } 38} æ”¹è¿›çš„æ¨é€æœåŠ¡ 1@Slf4j 2@Service 3public class ClusterMessagePushService { 4 5 @Autowired 6 private RedisMessageRouter redisMessageRouter; 7 8 @Autowired 9 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 10 11 /** 12 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰ 13 */ 14 public void pushToUser(String userId, String content) { 15 Message message = Message.builder() 16 .type(\u0026#34;push\u0026#34;) 17 .userId(userId) 18 .content(content) 19 .timestamp(System.currentTimeMillis()) 20 .build(); 21 22 // å…ˆå°è¯•æœ¬åœ°æ¨é€ 23 Channel channel = ChannelManager.getUserChannel(userId); 24 if (channel != null \u0026amp;\u0026amp; channel.isActive()) { 25 ChannelManager.pushToUser(userId, message); 26 } else { 27 // ç”¨æˆ·ä¸åœ¨æœ¬èŠ‚ç‚¹ï¼Œé€šè¿‡ Redis è·¯ç”± 28 redisMessageRouter.publish(userId, message); 29 } 30 } 31 32 /** 33 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰ 34 */ 35 public void broadcast(String content) { 36 Message message = Message.builder() 37 .type(\u0026#34;broadcast\u0026#34;) 38 .content(content) 39 .timestamp(System.currentTimeMillis()) 40 .build(); 41 42 // å‘å¸ƒåˆ° Redis å¹¿æ’­é¢‘é“ 43 redisTemplate.convertAndSend(\u0026#34;ws:broadcast\u0026#34;, JSON.toJSONString(message)); 44 } 45} æ¶æ„æ€è€ƒï¼š åœ¨é›†ç¾¤æ¶æ„ä¸­ï¼Œæ¶ˆæ¯è·¯ç”±æ˜¯æ ¸å¿ƒé—®é¢˜ã€‚é™¤äº† Redis Pub/Subï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ RocketMQã€Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—ã€‚é€‰æ‹©æ—¶éœ€è¦è€ƒè™‘ï¼š1) æ¶ˆæ¯å¯é æ€§è¦æ±‚ï¼›2) æ¶ˆæ¯é¡ºåºæ€§è¦æ±‚ï¼›3) ç³»ç»Ÿå¤æ‚åº¦ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜ä½†å¯é æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼ŒRedis Pub/Sub æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚\nç”Ÿäº§ç¯å¢ƒä¼˜åŒ– æ€§èƒ½ä¼˜åŒ– 1. çº¿ç¨‹æ± é…ç½®\n1// Boss çº¿ç¨‹ç»„ï¼šå¤„ç†è¿æ¥è¯·æ±‚ 2EventLoopGroup bossGroup = new NioEventLoopGroup(1); 3 4// Worker çº¿ç¨‹ç»„ï¼šå¤„ç† I/O æ“ä½œ 5// é»˜è®¤çº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2 6EventLoopGroup workerGroup = new NioEventLoopGroup(); 7 8// ä¸šåŠ¡çº¿ç¨‹æ± ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ 9ThreadPoolExecutor businessExecutor = new ThreadPoolExecutor( 10 10, 50, 60L, TimeUnit.SECONDS, 11 new LinkedBlockingQueue\u0026lt;\u0026gt;(1000), 12 new ThreadFactoryBuilder().setNameFormat(\u0026#34;business-%d\u0026#34;).build(), 13 new ThreadPoolExecutor.CallerRunsPolicy() 14); 2. å†…å­˜ä¼˜åŒ–\n1// ä½¿ç”¨æ± åŒ–çš„ ByteBuf 2bootstrap.option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); 3bootstrap.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); 4 5// è®¾ç½®æ¥æ”¶ç¼“å†²åŒºå¤§å° 6bootstrap.childOption(ChannelOption.RCVBUF_ALLOCATOR, 7 new AdaptiveRecvByteBufAllocator(64, 1024, 65536)); 3. è¿æ¥æ•°ä¼˜åŒ–\n1// å¢åŠ  TCP è¿æ¥é˜Ÿåˆ—é•¿åº¦ 2bootstrap.option(ChannelOption.SO_BACKLOG, 1024); 3 4// å¯ç”¨ TCP_NODELAYï¼ˆç¦ç”¨ Nagle ç®—æ³•ï¼‰ 5bootstrap.childOption(ChannelOption.TCP_NODELAY, true); 6 7// å¯ç”¨ SO_KEEPALIVE 8bootstrap.childOption(ChannelOption.SO_KEEPALIVE, true); ç›‘æ§æŒ‡æ ‡ 1@Component 2public class WebSocketMetrics { 3 4 private final AtomicLong totalConnections = new AtomicLong(0); 5 private final AtomicLong activeConnections = new AtomicLong(0); 6 private final AtomicLong totalMessages = new AtomicLong(0); 7 8 /** 9 * è®°å½•è¿æ¥å»ºç«‹ 10 */ 11 public void recordConnect() { 12 totalConnections.incrementAndGet(); 13 activeConnections.incrementAndGet(); 14 } 15 16 /** 17 * è®°å½•è¿æ¥æ–­å¼€ 18 */ 19 public void recordDisconnect() { 20 activeConnections.decrementAndGet(); 21 } 22 23 /** 24 * è®°å½•æ¶ˆæ¯å‘é€ 25 */ 26 public void recordMessage() { 27 totalMessages.incrementAndGet(); 28 } 29 30 /** 31 * è·å–ç›‘æ§æ•°æ® 32 */ 33 public Map\u0026lt;String, Object\u0026gt; getMetrics() { 34 Map\u0026lt;String, Object\u0026gt; metrics = new HashMap\u0026lt;\u0026gt;(); 35 metrics.put(\u0026#34;totalConnections\u0026#34;, totalConnections.get()); 36 metrics.put(\u0026#34;activeConnections\u0026#34;, activeConnections.get()); 37 metrics.put(\u0026#34;totalMessages\u0026#34;, totalMessages.get()); 38 metrics.put(\u0026#34;onlineUsers\u0026#34;, ChannelManager.getOnlineUserCount()); 39 return metrics; 40 } 41} å®‰å…¨åŠ å›º 1. è®¤è¯é‰´æƒ\n1private void handleAuth(ChannelHandlerContext ctx, Message message) { 2 String token = message.getToken(); 3 4 // éªŒè¯ Token 5 if (!validateToken(token)) { 6 ctx.writeAndFlush(new TextWebSocketFrame( 7 JSON.toJSONString(Message.builder() 8 .type(\u0026#34;auth_response\u0026#34;) 9 .code(401) 10 .content(\u0026#34;è®¤è¯å¤±è´¥\u0026#34;) 11 .build()) 12 )); 13 ctx.close(); 14 return; 15 } 16 17 // è®¤è¯æˆåŠŸï¼Œç»‘å®šç”¨æˆ· 18 String userId = getUserIdFromToken(token); 19 ChannelManager.bindUser(userId, ctx.channel()); 20} 2. æ¶ˆæ¯é™æµ\n1@Component 2public class MessageRateLimiter { 3 4 private final LoadingCache\u0026lt;String, RateLimiter\u0026gt; limiters = CacheBuilder.newBuilder() 5 .maximumSize(10000) 6 .expireAfterAccess(1, TimeUnit.HOURS) 7 .build(new CacheLoader\u0026lt;String, RateLimiter\u0026gt;() { 8 @Override 9 public RateLimiter load(String key) { 10 // æ¯ç§’æœ€å¤š 10 æ¡æ¶ˆæ¯ 11 return RateLimiter.create(10.0); 12 } 13 }); 14 15 public boolean tryAcquire(String userId) { 16 try { 17 RateLimiter limiter = limiters.get(userId); 18 return limiter.tryAcquire(); 19 } catch (ExecutionException e) { 20 return false; 21 } 22 } 23} 3. XSS é˜²æŠ¤\n1private String sanitizeContent(String content) { 2 // è¿‡æ»¤ HTML æ ‡ç­¾å’Œè„šæœ¬ 3 return content.replaceAll(\u0026#34;\u0026lt;[^\u0026gt;]*\u0026gt;\u0026#34;, \u0026#34;\u0026#34;) 4 .replaceAll(\u0026#34;javascript:\u0026#34;, \u0026#34;\u0026#34;) 5 .replaceAll(\u0026#34;on\\\\w+\\\\s*=\u0026#34;, \u0026#34;\u0026#34;); 6} é¿å‘æç¤ºï¼š ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå®‰å…¨æ€§è‡³å…³é‡è¦ã€‚é™¤äº†ä¸Šè¿°æªæ–½ï¼Œè¿˜éœ€è¦ï¼š1) ä½¿ç”¨ WSSï¼ˆWebSocket over TLSï¼‰åŠ å¯†ä¼ è¾“ï¼›2) è®¾ç½®åˆç†çš„æ¶ˆæ¯å¤§å°é™åˆ¶ï¼›3) å®æ–½ IP é»‘ç™½åå•ï¼›4) è®°å½•å®¡è®¡æ—¥å¿—ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–äº†ä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜çš„å®Œæ•´å†…å®¹ï¼š\nåè®®åŸç†ï¼šç†è§£ WebSocket æ¡æ‰‹æµç¨‹å’Œæ•°æ®å¸§æ ¼å¼ æœåŠ¡å™¨å®ç°ï¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨ è¿æ¥ç®¡ç†ï¼šå®ç° Channel ç®¡ç†å’Œæ¶ˆæ¯æ¨é€ å¿ƒè·³æœºåˆ¶ï¼šä¿è¯è¿æ¥å¯é æ€§å’ŒåŠæ—¶æ£€æµ‹æ–­çº¿ é›†ç¾¤éƒ¨ç½²ï¼šé€šè¿‡ Redis å®ç°è·¨èŠ‚ç‚¹æ¶ˆæ¯è·¯ç”± æ€§èƒ½ä¼˜åŒ–ï¼šçº¿ç¨‹æ± ã€å†…å­˜ã€è¿æ¥æ•°ç­‰å¤šæ–¹é¢ä¼˜åŒ– å®‰å…¨åŠ å›ºï¼šè®¤è¯é‰´æƒã€é™æµã€XSS é˜²æŠ¤ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯è¿›è¡Œè°ƒæ•´ã€‚ä¾‹å¦‚ï¼š\nå³æ—¶é€šè®¯ï¼šéœ€è¦è€ƒè™‘æ¶ˆæ¯å¯é æ€§ã€ç¦»çº¿æ¶ˆæ¯ã€æ¶ˆæ¯é¡ºåº åœ¨çº¿å®¢æœï¼šéœ€è¦è€ƒè™‘ä¼šè¯ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±ã€å®¢æœåˆ†é… å®æ—¶ç›‘æ§ï¼šéœ€è¦è€ƒè™‘æ•°æ®èšåˆã€å‘Šè­¦æ¨é€ã€å¤§å±å±•ç¤º ä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°å®æ—¶æ¶ˆæ¯æ¨é€åŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯• Netty + WebSocket è¿™ä¸ªå¼ºå¤§çš„ç»„åˆã€‚\n","permalink":"http://localhost:1313/posts/2025/04/netty--websocket-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå®æ—¶æ¶ˆæ¯æ¨é€å·²æˆä¸ºæ ‡é…åŠŸèƒ½ã€‚ä»å³æ—¶é€šè®¯ã€åœ¨çº¿å®¢æœåˆ°å®æ—¶ç›‘æ§å¤§å±ï¼Œéƒ½ç¦»ä¸å¼€é«˜æ€§èƒ½çš„æ¶ˆæ¯æ¨é€èƒ½åŠ›ã€‚ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼å­˜åœ¨å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹ç­‰é—®é¢˜ï¼Œè€Œ WebSocket åè®®çš„å‡ºç°å®Œç¾è§£å†³äº†è¿™äº›ç—›ç‚¹ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty æ¡†æ¶å®ç°åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜ï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¨é€æœåŠ¡ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ WebSocket åè®®åŸç†ä¸æ¡æ‰‹æµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ç®¡ç†ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆé€‰æ‹©-netty--websocket\"\u003eä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket\u003c/h2\u003e\n\u003ch3 id=\"websocket-åè®®ä¼˜åŠ¿\"\u003eWebSocket åè®®ä¼˜åŠ¿\u003c/h3\u003e\n\u003cp\u003eç›¸æ¯”ä¼ ç»Ÿçš„ HTTP è½®è¯¢ï¼ŒWebSocket å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eç‰¹æ€§\u003c/th\u003e\n          \u003cth\u003eHTTP è½®è¯¢\u003c/th\u003e\n          \u003cth\u003eWebSocket\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eé€šä¿¡æ–¹å¼\u003c/td\u003e\n          \u003ctd\u003eåŠåŒå·¥\u003c/td\u003e\n          \u003ctd\u003eå…¨åŒå·¥\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eè¿æ¥å¼€é”€\u003c/td\u003e\n          \u003ctd\u003eæ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥\u003c/td\u003e\n          \u003ctd\u003eä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå®æ—¶æ€§\u003c/td\u003e\n          \u003ctd\u003eå–å†³äºè½®è¯¢é—´éš”ï¼ˆç§’çº§ï¼‰\u003c/td\u003e\n          \u003ctd\u003eæ¯«ç§’çº§\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eæœåŠ¡å™¨å‹åŠ›\u003c/td\u003e\n          \u003ctd\u003eé«˜ï¼ˆé¢‘ç¹çš„ HTTP è¯·æ±‚ï¼‰\u003c/td\u003e\n          \u003ctd\u003eä½ï¼ˆé•¿è¿æ¥ï¼‰\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå¸¦å®½æ¶ˆè€—\u003c/td\u003e\n          \u003ctd\u003eé«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰ HTTP å¤´ï¼‰\u003c/td\u003e\n          \u003ctd\u003eä½ï¼ˆåªä¼ è¾“æ•°æ®å¸§ï¼‰\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"netty-æ¡†æ¶ä¼˜åŠ¿\"\u003eNetty æ¡†æ¶ä¼˜åŠ¿\u003c/h3\u003e\n\u003cp\u003eNetty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eé«˜æ€§èƒ½\u003c/strong\u003eï¼šåŸºäº NIOï¼Œæ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ˜“ç”¨æ€§\u003c/strong\u003eï¼šæä¾›äº†ä¸°å¯Œçš„ç¼–è§£ç å™¨å’Œå¤„ç†å™¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç¨³å®šæ€§\u003c/strong\u003eï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ‰©å±•æ€§\u003c/strong\u003eï¼šçµæ´»çš„ Pipeline æœºåˆ¶\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œä¸ä»…è¦çœ‹æŠ€æœ¯æœ¬èº«çš„ä¼˜åŠ¿ï¼Œæ›´è¦è€ƒè™‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€è¿ç»´æˆæœ¬å’Œç¤¾åŒºç”Ÿæ€ã€‚Netty åœ¨ Java ç”Ÿæ€ä¸­å·²ç»æˆä¸ºäº‹å®æ ‡å‡†ï¼ŒDubboã€RocketMQã€Elasticsearch ç­‰çŸ¥åé¡¹ç›®éƒ½åœ¨ä½¿ç”¨ã€‚\u003c/p\u003e","title":"Netty + WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜"},{"content":"åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚ä½†ç¼“å­˜ä½¿ç”¨ä¸å½“ä¼šå¼•å‘ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æè¿™äº›é—®é¢˜çš„åŸç†ï¼Œå¹¶æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„æœ¬è´¨åŒºåˆ« æŒæ¡å¸ƒéš†è¿‡æ»¤å™¨ã€äº’æ–¥é”ç­‰é˜²æŠ¤æ‰‹æ®µ å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„ç¼“å­˜æ¶æ„ äº†è§£ç¼“å­˜é¢„çƒ­ã€é™çº§ç­‰æœ€ä½³å®è·µ ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜ é—®é¢˜å¯¹æ¯” é—®é¢˜ åŸå›  å½±å“ è§£å†³æ–¹æ¡ˆ ç¼“å­˜ç©¿é€ æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® å¤§é‡è¯·æ±‚æ‰“åˆ°DB å¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜ ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹keyè¿‡æœŸ ç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°DB äº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ ç¼“å­˜é›ªå´© å¤§é‡keyåŒæ—¶è¿‡æœŸ DBå‹åŠ›éª¤å¢ è¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜ ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® é—®é¢˜åœºæ™¯ 1// æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID 2for (int i = -1000000; i \u0026lt; 0; i--) { 3 User user = getUser(i); // ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æŸ¥DB 4} æµç¨‹ï¼š\n1è¯·æ±‚ â†’ æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ æŸ¥æ•°æ®åº“ï¼ˆæœªå‘½ä¸­ï¼‰â†’ è¿”å›null æ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\nè§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨ åŸç†ï¼š ç”¨ä½æ•°ç»„åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚\n1@Configuration 2public class BloomFilterConfig { 3 4 @Bean 5 public BloomFilter\u0026lt;Long\u0026gt; userBloomFilter() { 6 // é¢„æœŸå…ƒç´ æ•°é‡ï¼š1000ä¸‡ï¼Œè¯¯åˆ¤ç‡ï¼š0.01% 7 BloomFilter\u0026lt;Long\u0026gt; bloomFilter = BloomFilter.create( 8 Funnels.longFunnel(), 9 10000000, 10 0.0001 11 ); 12 13 // åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ 14 List\u0026lt;Long\u0026gt; userIds = userMapper.selectAllIds(); 15 userIds.forEach(bloomFilter::put); 16 17 return bloomFilter; 18 } 19} 1@Service 2public class UserService { 3 4 @Autowired 5 private BloomFilter\u0026lt;Long\u0026gt; userBloomFilter; 6 7 @Autowired 8 private RedisTemplate\u0026lt;String, User\u0026gt; redisTemplate; 9 10 @Autowired 11 private UserMapper userMapper; 12 13 public User getUser(Long userId) { 14 // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ 15 if (!userBloomFilter.mightContain(userId)) { 16 return null; // ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å› 17 } 18 19 // 2. æŸ¥ç¼“å­˜ 20 String key = \u0026#34;user:\u0026#34; + userId; 21 User user = redisTemplate.opsForValue().get(key); 22 if (user != null) { 23 return user; 24 } 25 26 // 3. æŸ¥æ•°æ®åº“ 27 user = userMapper.selectById(userId); 28 if (user != null) { 29 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 30 } 31 32 return user; 33 } 34} ä¼˜ç‚¹ï¼š\nå†…å­˜å ç”¨å°ï¼ˆ1000ä¸‡æ•°æ®åªéœ€çº¦12MBï¼‰ æŸ¥è¯¢é€Ÿåº¦å¿«ï¼ˆO(k)ï¼Œkä¸ºå“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼‰ ç¼ºç‚¹ï¼š\nå­˜åœ¨è¯¯åˆ¤ï¼ˆå¯èƒ½åˆ¤æ–­å­˜åœ¨ä½†å®é™…ä¸å­˜åœ¨ï¼‰ æ— æ³•åˆ é™¤å…ƒç´  è§£å†³æ–¹æ¡ˆ2ï¼šç¼“å­˜ç©ºå€¼ 1public User getUser(Long userId) { 2 String key = \u0026#34;user:\u0026#34; + userId; 3 4 // 1. æŸ¥ç¼“å­˜ 5 User user = redisTemplate.opsForValue().get(key); 6 if (user != null) { 7 // ç©ºå¯¹è±¡æ ‡è®° 8 if (user.getId() == null) { 9 return null; 10 } 11 return user; 12 } 13 14 // 2. æŸ¥æ•°æ®åº“ 15 user = userMapper.selectById(userId); 16 17 // 3. ç¼“å­˜ç»“æœï¼ˆåŒ…æ‹¬nullï¼‰ 18 if (user == null) { 19 // ç¼“å­˜ç©ºå¯¹è±¡ï¼Œè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ 20 User emptyUser = new User(); 21 redisTemplate.opsForValue().set(key, emptyUser, 5, TimeUnit.MINUTES); 22 } else { 23 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 24 } 25 26 return user; 27} ä¼˜ç‚¹ï¼š\nå®ç°ç®€å• å¯ä»¥é˜²æ­¢åŒä¸€ä¸ªä¸å­˜åœ¨çš„keyåå¤æŸ¥è¯¢ ç¼ºç‚¹ï¼š\nå ç”¨ç¼“å­˜ç©ºé—´ å¯èƒ½ç¼“å­˜å¤§é‡æ— æ•ˆæ•°æ® è§£å†³æ–¹æ¡ˆ3ï¼šå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜ 1public User getUser(Long userId) { 2 // 1. å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­ 3 if (!userBloomFilter.mightContain(userId)) { 4 return null; 5 } 6 7 String key = \u0026#34;user:\u0026#34; + userId; 8 9 // 2. æŸ¥ç¼“å­˜ï¼ˆåŒ…æ‹¬ç©ºå€¼ï¼‰ 10 User user = redisTemplate.opsForValue().get(key); 11 if (user != null) { 12 return user.getId() == null ? null : user; 13 } 14 15 // 3. æŸ¥æ•°æ®åº“ 16 user = userMapper.selectById(userId); 17 18 // 4. ç¼“å­˜ç»“æœ 19 if (user == null) { 20 User emptyUser = new User(); 21 redisTemplate.opsForValue().set(key, emptyUser, 5, TimeUnit.MINUTES); 22 } else { 23 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 24 } 25 26 return user; 27} æ¶æ„æ€è€ƒï¼š å¸ƒéš†è¿‡æ»¤å™¨é€‚åˆè¿‡æ»¤å¤§éƒ¨åˆ†ä¸å­˜åœ¨çš„è¯·æ±‚ï¼Œç©ºå€¼ç¼“å­˜é€‚åˆå¤„ç†å°‘é‡ä¸å­˜åœ¨ä½†è¢«é¢‘ç¹æŸ¥è¯¢çš„keyã€‚ä¸¤è€…ç»“åˆä½¿ç”¨ï¼Œå¯ä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœã€‚\nç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyè¿‡æœŸ é—®é¢˜åœºæ™¯ 1çƒ­ç‚¹å•†å“è¯¦æƒ…é¡µï¼Œç¼“å­˜è¿‡æœŸç¬é—´ï¼Œ1000ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“ æµç¨‹ï¼š\n1æ—¶åˆ»Tï¼šç¼“å­˜è¿‡æœŸ 2æ—¶åˆ»T+1msï¼š1000ä¸ªè¯·æ±‚åŒæ—¶æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ åŒæ—¶æŸ¥æ•°æ®åº“ è§£å†³æ–¹æ¡ˆ1ï¼šäº’æ–¥é” 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // 1. æŸ¥ç¼“å­˜ 5 Product product = redisTemplate.opsForValue().get(key); 6 if (product != null) { 7 return product; 8 } 9 10 // 2. è·å–äº’æ–¥é” 11 String lockKey = \u0026#34;lock:product:\u0026#34; + productId; 12 Boolean locked = redisTemplate.opsForValue() 13 .setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS); 14 15 if (locked) { 16 try { 17 // 3. åŒé‡æ£€æŸ¥ 18 product = redisTemplate.opsForValue().get(key); 19 if (product != null) { 20 return product; 21 } 22 23 // 4. æŸ¥æ•°æ®åº“ 24 product = productMapper.selectById(productId); 25 26 // 5. å†™å…¥ç¼“å­˜ 27 if (product != null) { 28 redisTemplate.opsForValue().set(key, product, 1, TimeUnit.HOURS); 29 } 30 31 return product; 32 } finally { 33 // 6. é‡Šæ”¾é” 34 redisTemplate.delete(lockKey); 35 } 36 } else { 37 // 7. æœªè·å–åˆ°é”ï¼Œç­‰å¾…åé‡è¯• 38 try { 39 Thread.sleep(50); 40 } catch (InterruptedException e) { 41 Thread.currentThread().interrupt(); 42 } 43 return getProduct(productId); // é€’å½’é‡è¯• 44 } 45} ä¼˜ç‚¹ï¼š\nä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®åº“ å®ç°ç®€å• ç¼ºç‚¹ï¼š\nå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾… å¯èƒ½å¯¼è‡´è¯·æ±‚å †ç§¯ è§£å†³æ–¹æ¡ˆ2ï¼šé€»è¾‘è¿‡æœŸ 1@Data 2public class CacheData\u0026lt;T\u0026gt; { 3 private T data; 4 private LocalDateTime expireTime; 5} 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // 1. æŸ¥ç¼“å­˜ï¼ˆæ°¸ä¸è¿‡æœŸï¼‰ 5 CacheData\u0026lt;Product\u0026gt; cacheData = redisTemplate.opsForValue().get(key); 6 7 if (cacheData == null) { 8 // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ 9 return loadAndCache(productId); 10 } 11 12 // 2. åˆ¤æ–­é€»è¾‘è¿‡æœŸ 13 if (cacheData.getExpireTime().isBefore(LocalDateTime.now())) { 14 // 3. å¼‚æ­¥æ›´æ–°ç¼“å­˜ 15 String lockKey = \u0026#34;lock:product:\u0026#34; + productId; 16 Boolean locked = redisTemplate.opsForValue() 17 .setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS); 18 19 if (locked) { 20 CompletableFuture.runAsync(() -\u0026gt; { 21 try { 22 loadAndCache(productId); 23 } finally { 24 redisTemplate.delete(lockKey); 25 } 26 }); 27 } 28 } 29 30 // 4. è¿”å›æ—§æ•°æ® 31 return cacheData.getData(); 32} 33 34private Product loadAndCache(Long productId) { 35 Product product = productMapper.selectById(productId); 36 if (product != null) { 37 CacheData\u0026lt;Product\u0026gt; cacheData = new CacheData\u0026lt;\u0026gt;(); 38 cacheData.setData(product); 39 cacheData.setExpireTime(LocalDateTime.now().plusHours(1)); 40 41 redisTemplate.opsForValue().set(\u0026#34;product:\u0026#34; + productId, cacheData); 42 } 43 return product; 44} ä¼˜ç‚¹ï¼š\nä¸ä¼šé˜»å¡è¯·æ±‚ å§‹ç»ˆè¿”å›æ•°æ®ï¼ˆå³ä½¿æ˜¯æ—§æ•°æ®ï¼‰ ç¼ºç‚¹ï¼š\nå¯èƒ½è¿”å›è¿‡æœŸæ•°æ® å®ç°å¤æ‚ è§£å†³æ–¹æ¡ˆ3ï¼šçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // çƒ­ç‚¹å•†å“æ°¸ä¸è¿‡æœŸ 5 Product product = redisTemplate.opsForValue().get(key); 6 if (product != null) { 7 return product; 8 } 9 10 // æŸ¥æ•°æ®åº“å¹¶ç¼“å­˜ï¼ˆä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰ 11 product = productMapper.selectById(productId); 12 if (product != null) { 13 redisTemplate.opsForValue().set(key, product); 14 } 15 16 return product; 17} 18 19// é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ›´æ–°ç¼“å­˜ 20@RabbitListener(queues = \u0026#34;product.update\u0026#34;) 21public void updateProductCache(Long productId) { 22 Product product = productMapper.selectById(productId); 23 redisTemplate.opsForValue().set(\u0026#34;product:\u0026#34; + productId, product); 24} ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸ é—®é¢˜åœºæ™¯ 1å‡Œæ™¨2ç‚¹ï¼Œç³»ç»Ÿé‡å¯ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶åŠ è½½ï¼Œè®¾ç½®1å°æ—¶è¿‡æœŸ 2å‡Œæ™¨3ç‚¹ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ è§£å†³æ–¹æ¡ˆ1ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ– 1public void setCache(String key, Object value, long baseExpireSeconds) { 2 // åœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¸Šå¢åŠ éšæœºå€¼ 3 long randomSeconds = ThreadLocalRandom.current().nextLong(0, 300); 4 long expireSeconds = baseExpireSeconds + randomSeconds; 5 6 redisTemplate.opsForValue().set(key, value, expireSeconds, TimeUnit.SECONDS); 7} 1// ä½¿ç”¨ç¤ºä¾‹ 2setCache(\u0026#34;user:1\u0026#34;, user, 3600); // 3600 ~ 3900ç§’ 3setCache(\u0026#34;user:2\u0026#34;, user, 3600); // 3600 ~ 3900ç§’ è§£å†³æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜ 1è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â†’ Redis â†’ æ•°æ®åº“ 1@Configuration 2public class CacheConfig { 3 4 @Bean 5 public Cache\u0026lt;String, Object\u0026gt; localCache() { 6 return Caffeine.newBuilder() 7 .maximumSize(10000) 8 .expireAfterWrite(5, TimeUnit.MINUTES) 9 .build(); 10 } 11} 1@Service 2public class UserService { 3 4 @Autowired 5 private Cache\u0026lt;String, Object\u0026gt; localCache; 6 7 @Autowired 8 private RedisTemplate\u0026lt;String, User\u0026gt; redisTemplate; 9 10 @Autowired 11 private UserMapper userMapper; 12 13 public User getUser(Long userId) { 14 String key = \u0026#34;user:\u0026#34; + userId; 15 16 // 1. æŸ¥æœ¬åœ°ç¼“å­˜ 17 User user = (User) localCache.getIfPresent(key); 18 if (user != null) { 19 return user; 20 } 21 22 // 2. æŸ¥Redis 23 user = redisTemplate.opsForValue().get(key); 24 if (user != null) { 25 localCache.put(key, user); 26 return user; 27 } 28 29 // 3. æŸ¥æ•°æ®åº“ 30 user = userMapper.selectById(userId); 31 if (user != null) { 32 // å†™å…¥Rediså’Œæœ¬åœ°ç¼“å­˜ 33 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 34 localCache.put(key, user); 35 } 36 37 return user; 38 } 39} è§£å†³æ–¹æ¡ˆ3ï¼šç¼“å­˜é¢„çƒ­ 1@Component 2public class CacheWarmUp implements ApplicationRunner { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; 6 7 @Autowired 8 private ProductMapper productMapper; 9 10 @Override 11 public void run(ApplicationArguments args) { 12 log.info(\u0026#34;å¼€å§‹ç¼“å­˜é¢„çƒ­...\u0026#34;); 13 14 // åŠ è½½çƒ­ç‚¹å•†å“ 15 List\u0026lt;Product\u0026gt; hotProducts = productMapper.selectHotProducts(100); 16 for (Product product : hotProducts) { 17 String key = \u0026#34;product:\u0026#34; + product.getId(); 18 long expireSeconds = 3600 + ThreadLocalRandom.current().nextLong(0, 300); 19 redisTemplate.opsForValue().set(key, product, expireSeconds, TimeUnit.SECONDS); 20 } 21 22 log.info(\u0026#34;ç¼“å­˜é¢„çƒ­å®Œæˆï¼Œå…±åŠ è½½ {} ä¸ªå•†å“\u0026#34;, hotProducts.size()); 23 } 24} è§£å†³æ–¹æ¡ˆ4ï¼šé™æµé™çº§ 1@Service 2public class ProductService { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Product\u0026gt; redisTemplate; 6 7 @Autowired 8 private ProductMapper productMapper; 9 10 /** 11 * ä½¿ç”¨ Sentinel é™æµ 12 */ 13 @SentinelResource( 14 value = \u0026#34;getProduct\u0026#34;, 15 blockHandler = \u0026#34;getProductBlockHandler\u0026#34;, 16 fallback = \u0026#34;getProductFallback\u0026#34; 17 ) 18 public Product getProduct(Long productId) { 19 String key = \u0026#34;product:\u0026#34; + productId; 20 21 // æŸ¥ç¼“å­˜ 22 Product product = redisTemplate.opsForValue().get(key); 23 if (product != null) { 24 return product; 25 } 26 27 // æŸ¥æ•°æ®åº“ 28 product = productMapper.selectById(productId); 29 if (product != null) { 30 redisTemplate.opsForValue().set(key, product, 1, TimeUnit.HOURS); 31 } 32 33 return product; 34 } 35 36 /** 37 * é™æµé™çº§å¤„ç† 38 */ 39 public Product getProductBlockHandler(Long productId, BlockException ex) { 40 log.warn(\u0026#34;è§¦å‘é™æµ: productId={}\u0026#34;, productId); 41 // è¿”å›é»˜è®¤å•†å“æˆ–æç¤ºä¿¡æ¯ 42 return getDefaultProduct(); 43 } 44 45 /** 46 * å¼‚å¸¸é™çº§å¤„ç† 47 */ 48 public Product getProductFallback(Long productId, Throwable ex) { 49 log.error(\u0026#34;æŸ¥è¯¢å¼‚å¸¸: productId={}\u0026#34;, productId, ex); 50 // è¿”å›é»˜è®¤å•†å“ 51 return getDefaultProduct(); 52 } 53} ç¼“å­˜æ›´æ–°ç­–ç•¥ ç­–ç•¥å¯¹æ¯” ç­–ç•¥ ä¸€è‡´æ€§ å®ç°å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ Cache Aside å¼±ä¸€è‡´æ€§ ç®€å• è¯»å¤šå†™å°‘ Read/Write Through å¼ºä¸€è‡´æ€§ å¤æ‚ è¯»å†™å‡è¡¡ Write Behind æœ€ç»ˆä¸€è‡´æ€§ å¤æ‚ å†™å¤šè¯»å°‘ Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰ 1// è¯»æ“ä½œ 2public User getUser(Long userId) { 3 String key = \u0026#34;user:\u0026#34; + userId; 4 5 // 1. æŸ¥ç¼“å­˜ 6 User user = redisTemplate.opsForValue().get(key); 7 if (user != null) { 8 return user; 9 } 10 11 // 2. æŸ¥æ•°æ®åº“ 12 user = userMapper.selectById(userId); 13 14 // 3. å†™å…¥ç¼“å­˜ 15 if (user != null) { 16 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 17 } 18 19 return user; 20} 21 22// å†™æ“ä½œ 23public void updateUser(User user) { 24 // 1. æ›´æ–°æ•°æ®åº“ 25 userMapper.updateById(user); 26 27 // 2. åˆ é™¤ç¼“å­˜ 28 String key = \u0026#34;user:\u0026#34; + user.getId(); 29 redisTemplate.delete(key); 30} ä¸ºä»€ä¹ˆæ˜¯åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ\næ›´æ–°ç¼“å­˜å¯èƒ½æµªè´¹ï¼ˆæ›´æ–°åå¯èƒ½æ²¡äººæŸ¥è¯¢ï¼‰ å¹¶å‘æ›´æ–°å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ å»¶è¿ŸåŒåˆ  1public void updateUser(User user) { 2 String key = \u0026#34;user:\u0026#34; + user.getId(); 3 4 // 1. åˆ é™¤ç¼“å­˜ 5 redisTemplate.delete(key); 6 7 // 2. æ›´æ–°æ•°æ®åº“ 8 userMapper.updateById(user); 9 10 // 3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜ 11 CompletableFuture.runAsync(() -\u0026gt; { 12 try { 13 Thread.sleep(500); // å»¶è¿Ÿ500ms 14 redisTemplate.delete(key); 15 } catch (InterruptedException e) { 16 Thread.currentThread().interrupt(); 17 } 18 }); 19} ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿ŸåŒåˆ ï¼Ÿ\né˜²æ­¢ä»¥ä¸‹åœºæ™¯çš„æ•°æ®ä¸ä¸€è‡´ï¼š\n1æ—¶åˆ»1ï¼šçº¿ç¨‹Aåˆ é™¤ç¼“å­˜ 2æ—¶åˆ»2ï¼šçº¿ç¨‹BæŸ¥è¯¢ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰ 3æ—¶åˆ»3ï¼šçº¿ç¨‹BæŸ¥è¯¢æ•°æ®åº“ï¼ˆæ—§æ•°æ®ï¼‰ 4æ—¶åˆ»4ï¼šçº¿ç¨‹Aæ›´æ–°æ•°æ®åº“ 5æ—¶åˆ»5ï¼šçº¿ç¨‹Bå†™å…¥ç¼“å­˜ï¼ˆæ—§æ•°æ®ï¼‰ å»¶è¿ŸåŒåˆ å¯ä»¥åˆ é™¤çº¿ç¨‹Bå†™å…¥çš„æ—§æ•°æ®ã€‚\nç¼“å­˜ç›‘æ§ å…³é”®æŒ‡æ ‡ 1@Component 2public class CacheMonitor { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; 6 7 @Scheduled(fixedDelay = 60000) 8 public void monitor() { 9 RedisConnection connection = redisTemplate.getConnectionFactory().getConnection(); 10 Properties info = connection.info(); 11 12 // 1. å†…å­˜ä½¿ç”¨ 13 long usedMemory = Long.parseLong(info.getProperty(\u0026#34;used_memory\u0026#34;)); 14 long maxMemory = Long.parseLong(info.getProperty(\u0026#34;maxmemory\u0026#34;)); 15 double memoryUsageRate = (double) usedMemory / maxMemory * 100; 16 17 // 2. å‘½ä¸­ç‡ 18 long hits = Long.parseLong(info.getProperty(\u0026#34;keyspace_hits\u0026#34;)); 19 long misses = Long.parseLong(info.getProperty(\u0026#34;keyspace_misses\u0026#34;)); 20 double hitRate = (double) hits / (hits + misses) * 100; 21 22 // 3. è¿æ¥æ•° 23 int connectedClients = Integer.parseInt(info.getProperty(\u0026#34;connected_clients\u0026#34;)); 24 25 log.info(\u0026#34;Redisç›‘æ§ - å†…å­˜ä½¿ç”¨ç‡: {}%, å‘½ä¸­ç‡: {}%, è¿æ¥æ•°: {}\u0026#34;, 26 memoryUsageRate, hitRate, connectedClients); 27 28 // 4. å‘Šè­¦ 29 if (memoryUsageRate \u0026gt; 80) { 30 log.warn(\u0026#34;Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, memoryUsageRate); 31 } 32 if (hitRate \u0026lt; 80) { 33 log.warn(\u0026#34;Rediså‘½ä¸­ç‡è¿‡ä½: {}%\u0026#34;, hitRate); 34 } 35 } 36} æœ€ä½³å®è·µ 1. åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´\nçƒ­ç‚¹æ•°æ®ï¼š1-2å°æ—¶ æ™®é€šæ•°æ®ï¼š30åˆ†é’Ÿ-1å°æ—¶ å†·æ•°æ®ï¼š5-10åˆ†é’Ÿ 2. ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„\nStringï¼šç®€å•key-value Hashï¼šå¯¹è±¡å­˜å‚¨ Listï¼šåˆ—è¡¨ã€é˜Ÿåˆ— Setï¼šå»é‡ã€äº¤é›† ZSetï¼šæ’è¡Œæ¦œ 3. é¿å…å¤§key\nå•ä¸ªkeyä¸è¶…è¿‡10KB é›†åˆå…ƒç´ ä¸è¶…è¿‡5000ä¸ª ä½¿ç”¨SCANä»£æ›¿KEYS 4. è®¾ç½®å†…å­˜æ·˜æ±°ç­–ç•¥\n1# redis.conf 2maxmemory 2gb 3maxmemory-policy allkeys-lru 5. ç›‘æ§å‘Šè­¦\nå†…å­˜ä½¿ç”¨ç‡ \u0026gt; 80% å‘½ä¸­ç‡ \u0026lt; 80% æ…¢æŸ¥è¯¢ \u0026gt; 10ms é¿å‘æç¤ºï¼š ç¼“å­˜ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¸è¦ä¸ºäº†ç¼“å­˜è€Œç¼“å­˜ã€‚åªæœ‰é«˜é¢‘è®¿é—®ã€å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®æ‰é€‚åˆç¼“å­˜ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜çš„æ•°æ®ï¼Œç›´æ¥æŸ¥æ•°æ®åº“å¯èƒ½æ›´åˆé€‚ã€‚\næ€»ç»“ä¸æ€è€ƒ Redis ç¼“å­˜æ¶æ„çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€ ä½¿ç”¨äº’æ–¥é”æˆ–é€»è¾‘è¿‡æœŸé˜²æ­¢ç¼“å­˜å‡»ç©¿ ä½¿ç”¨è¿‡æœŸæ—¶é—´éšæœºåŒ–å’Œå¤šçº§ç¼“å­˜é˜²æ­¢ç¼“å­˜é›ªå´© ä½¿ç”¨ Cache Aside æ¨¡å¼æ›´æ–°ç¼“å­˜ ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œå†…å­˜ä½¿ç”¨ç‡ ç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„åˆ©å™¨ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¤æ‚åº¦ã€‚åœ¨è®¾è®¡ç¼“å­˜æ¶æ„æ—¶è¦æƒè¡¡ï¼š\næ˜¯å¦çœŸçš„éœ€è¦ç¼“å­˜ï¼Ÿ ç¼“å­˜ä»€ä¹ˆæ•°æ®ï¼Ÿ å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ å¦‚ä½•åº”å¯¹ç¼“å­˜å¤±æ•ˆï¼Ÿ ä¸‹æ¬¡å½“ä½ çš„ç³»ç»Ÿé¢ä¸´é«˜å¹¶å‘æŒ‘æˆ˜æ—¶ï¼Œä¸å¦¨è¯•è¯•æœ¬æ–‡ä»‹ç»çš„ç¼“å­˜æ¶æ„æ–¹æ¡ˆï¼Œè®©ç³»ç»Ÿæ€§èƒ½æ›´ä¸Šä¸€å±‚æ¥¼ã€‚\n","permalink":"http://localhost:1313/posts/2025/03/redis-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E4%BB%8E%E7%A9%BF%E9%80%8F%E5%88%B0%E9%9B%AA%E5%B4%A9%E7%9A%84%E5%85%A8%E9%93%BE%E8%B7%AF%E9%98%B2%E6%8A%A4/","summary":"\u003cp\u003eåœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚ä½†ç¼“å­˜ä½¿ç”¨ä¸å½“ä¼šå¼•å‘ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æè¿™äº›é—®é¢˜çš„åŸç†ï¼Œå¹¶æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„æœ¬è´¨åŒºåˆ«\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å¸ƒéš†è¿‡æ»¤å™¨ã€äº’æ–¥é”ç­‰é˜²æŠ¤æ‰‹æ®µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„ç¼“å­˜æ¶æ„\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç¼“å­˜é¢„çƒ­ã€é™çº§ç­‰æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜\"\u003eç¼“å­˜çš„ä¸‰å¤§é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜å¯¹æ¯”\"\u003eé—®é¢˜å¯¹æ¯”\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eé—®é¢˜\u003c/th\u003e\n          \u003cth\u003eåŸå› \u003c/th\u003e\n          \u003cth\u003eå½±å“\u003c/th\u003e\n          \u003cth\u003eè§£å†³æ–¹æ¡ˆ\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜ç©¿é€\u003c/td\u003e\n          \u003ctd\u003eæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\u003c/td\u003e\n          \u003ctd\u003eå¤§é‡è¯·æ±‚æ‰“åˆ°DB\u003c/td\u003e\n          \u003ctd\u003eå¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜å‡»ç©¿\u003c/td\u003e\n          \u003ctd\u003eçƒ­ç‚¹keyè¿‡æœŸ\u003c/td\u003e\n          \u003ctd\u003eç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°DB\u003c/td\u003e\n          \u003ctd\u003eäº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜é›ªå´©\u003c/td\u003e\n          \u003ctd\u003eå¤§é‡keyåŒæ—¶è¿‡æœŸ\u003c/td\u003e\n          \u003ctd\u003eDBå‹åŠ›éª¤å¢\u003c/td\u003e\n          \u003ctd\u003eè¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¼“å­˜ç©¿é€æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\"\u003eç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜åœºæ™¯\"\u003eé—®é¢˜åœºæ™¯\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003e1000000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æŸ¥DB\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæµç¨‹ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eè¯·æ±‚ â†’ æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ æŸ¥æ•°æ®åº“ï¼ˆæœªå‘½ä¸­ï¼‰â†’ è¿”å›null\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\u003c/p\u003e\n\u003ch3 id=\"è§£å†³æ–¹æ¡ˆ1å¸ƒéš†è¿‡æ»¤å™¨\"\u003eè§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eåŸç†ï¼š\u003c/strong\u003e ç”¨ä½æ•°ç»„åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBloomFilterConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// é¢„æœŸå…ƒç´ æ•°é‡ï¼š1000ä¸‡ï¼Œè¯¯åˆ¤ç‡ï¼š0.01%\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eFunnels\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003elongFunnel\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10000000\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003e0001\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserIds\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectAllIds\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003euserIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eforEach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eput\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRedisTemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserMapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emightContain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æŸ¥ç¼“å­˜\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;user:\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. æŸ¥æ•°æ®åº“\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eHOURS\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eä¼˜ç‚¹ï¼š\u003c/strong\u003e\u003c/p\u003e","title":"Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤"},{"content":"å½“å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§åˆ«æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆã€‚æœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ ShardingSphere å®ç°åˆ†åº“åˆ†è¡¨ï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒçš„å®æˆ˜ç»éªŒã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒæ¦‚å¿µå’Œåº”ç”¨åœºæ™¯ æŒæ¡ ShardingSphere çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³• å­¦ä¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡ç­–ç•¥ äº†è§£åˆ†åº“åˆ†è¡¨çš„æœ€ä½³å®è·µå’Œå¸¸è§é—®é¢˜ ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ åœºæ™¯ï¼šè®¢å•è¡¨æ•°æ®çˆ†ç‚¸\nç”µå•†ç³»ç»Ÿçš„è®¢å•è¡¨ï¼Œæ¯å¤©æ–°å¢10ä¸‡æ¡æ•°æ®ï¼Œä¸€å¹´å°±æ˜¯3600ä¸‡æ¡ã€‚éšç€æ•°æ®é‡å¢é•¿ï¼š\næŸ¥è¯¢å˜æ…¢ï¼šå•è¡¨æŸ¥è¯¢ä»æ¯«ç§’çº§å˜æˆç§’çº§ ç´¢å¼•å¤±æ•ˆï¼šB+æ ‘å±‚çº§å¢åŠ ï¼Œç´¢å¼•æ•ˆç‡ä¸‹é™ é”ç«äº‰ï¼šå¤§è¡¨çš„é”ç²’åº¦å¤§ï¼Œå¹¶å‘æ€§èƒ½å·® å¤‡ä»½å›°éš¾ï¼šå•è¡¨å¤‡ä»½æ—¶é—´è¿‡é•¿ ä¼ ç»Ÿä¼˜åŒ–æ–¹æ¡ˆçš„å±€é™\n1-- ä¼˜åŒ–ç´¢å¼• 2CREATE INDEX idx_user_id_create_time ON orders(user_id, create_time); 3 4-- åˆ†åŒºè¡¨ 5ALTER TABLE orders PARTITION BY RANGE (YEAR(create_time)) ( 6 PARTITION p2023 VALUES LESS THAN (2024), 7 PARTITION p2024 VALUES LESS THAN (2025) 8); è¿™äº›æ–¹æ¡ˆåªèƒ½ç¼“è§£é—®é¢˜ï¼Œæ— æ³•æ ¹æœ¬è§£å†³ã€‚å½“æ•°æ®é‡è¾¾åˆ°äº¿çº§æ—¶ï¼Œåˆ†åº“åˆ†è¡¨æ˜¯å¿…ç„¶é€‰æ‹©ã€‚\nåˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ å‚ç›´æ‹†åˆ† vs æ°´å¹³æ‹†åˆ† å‚ç›´æ‹†åˆ†ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†\n1åŸå§‹æ•°æ®åº“ 2â”œâ”€â”€ ç”¨æˆ·è¡¨ 3â”œâ”€â”€ è®¢å•è¡¨ 4â”œâ”€â”€ å•†å“è¡¨ 5â””â”€â”€ æ”¯ä»˜è¡¨ 6 7æ‹†åˆ†å 8â”œâ”€â”€ ç”¨æˆ·åº“ 9â”‚ â””â”€â”€ ç”¨æˆ·è¡¨ 10â”œâ”€â”€ è®¢å•åº“ 11â”‚ â””â”€â”€ è®¢å•è¡¨ 12â”œâ”€â”€ å•†å“åº“ 13â”‚ â””â”€â”€ å•†å“è¡¨ 14â””â”€â”€ æ”¯ä»˜åº“ 15 â””â”€â”€ æ”¯ä»˜è¡¨ æ°´å¹³æ‹†åˆ†ï¼šæŒ‰æ•°æ®è¡Œæ‹†åˆ†\n1è®¢å•è¡¨ï¼ˆ1äº¿æ¡æ•°æ®ï¼‰ 2 3æ‹†åˆ†å 4â”œâ”€â”€ orders_0ï¼ˆ2500ä¸‡æ¡ï¼‰ 5â”œâ”€â”€ orders_1ï¼ˆ2500ä¸‡æ¡ï¼‰ 6â”œâ”€â”€ orders_2ï¼ˆ2500ä¸‡æ¡ï¼‰ 7â””â”€â”€ orders_3ï¼ˆ2500ä¸‡æ¡ï¼‰ åˆ†ç‰‡é”®çš„é€‰æ‹© åˆ†ç‰‡é”®å†³å®šäº†æ•°æ®å¦‚ä½•åˆ†å¸ƒï¼Œé€‰æ‹©ä¸å½“ä¼šå¯¼è‡´æ•°æ®å€¾æ–œã€‚\nå¸¸è§åˆ†ç‰‡é”®ï¼š\nç”¨æˆ·IDï¼šé€‚åˆç”¨æˆ·ç»´åº¦æŸ¥è¯¢ è®¢å•IDï¼šé€‚åˆè®¢å•ç»´åº¦æŸ¥è¯¢ æ—¶é—´ï¼šé€‚åˆæ—¶é—´èŒƒå›´æŸ¥è¯¢ é€‰æ‹©åŸåˆ™ï¼š\né«˜é¢‘æŸ¥è¯¢å­—æ®µ æ•°æ®åˆ†å¸ƒå‡åŒ€ é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ ShardingSphere å¿«é€Ÿå…¥é—¨ å¼•å…¥ä¾èµ– 1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;org.apache.shardingsphere\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;shardingsphere-jdbc-core-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;5.3.2\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; åŸºç¡€é…ç½® 1spring: 2 shardingsphere: 3 # æ•°æ®æºé…ç½® 4 datasource: 5 names: ds0,ds1 6 ds0: 7 type: com.zaxxer.hikari.HikariDataSource 8 driver-class-name: com.mysql.cj.jdbc.Driver 9 jdbc-url: jdbc:mysql://localhost:3306/order_db_0 10 username: root 11 password: root 12 ds1: 13 type: com.zaxxer.hikari.HikariDataSource 14 driver-class-name: com.mysql.cj.jdbc.Driver 15 jdbc-url: jdbc:mysql://localhost:3306/order_db_1 16 username: root 17 password: root 18 19 # åˆ†ç‰‡è§„åˆ™ 20 rules: 21 sharding: 22 tables: 23 orders: 24 # å®é™…èŠ‚ç‚¹ 25 actual-data-nodes: ds$-\u0026gt;{0..1}.orders_$-\u0026gt;{0..3} 26 # åˆ†åº“ç­–ç•¥ 27 database-strategy: 28 standard: 29 sharding-column: user_id 30 sharding-algorithm-name: database-inline 31 # åˆ†è¡¨ç­–ç•¥ 32 table-strategy: 33 standard: 34 sharding-column: order_id 35 sharding-algorithm-name: table-inline 36 37 # åˆ†ç‰‡ç®—æ³• 38 sharding-algorithms: 39 database-inline: 40 type: INLINE 41 props: 42 algorithm-expression: ds$-\u0026gt;{user_id % 2} 43 table-inline: 44 type: INLINE 45 props: 46 algorithm-expression: orders_$-\u0026gt;{order_id % 4} 47 48 # å±æ€§é…ç½® 49 props: 50 sql-show: true å®ä½“ç±» 1@Data 2@TableName(\u0026#34;orders\u0026#34;) 3public class Order { 4 private Long orderId; 5 private Long userId; 6 private BigDecimal amount; 7 private Integer status; 8 private LocalDateTime createTime; 9} ä½¿ç”¨ç¤ºä¾‹ 1@Service 2public class OrderService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 /** 8 * æ’å…¥è®¢å• 9 * ShardingSphere ä¼šæ ¹æ® user_id å’Œ order_id è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”çš„åº“è¡¨ 10 */ 11 public void createOrder(Order order) { 12 orderMapper.insert(order); 13 } 14 15 /** 16 * æ ¹æ®è®¢å•IDæŸ¥è¯¢ 17 * å•åˆ†ç‰‡æŸ¥è¯¢ï¼Œæ€§èƒ½æœ€ä¼˜ 18 */ 19 public Order getById(Long orderId) { 20 return orderMapper.selectById(orderId); 21 } 22 23 /** 24 * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è®¢å•åˆ—è¡¨ 25 * å•åº“å¤šè¡¨æŸ¥è¯¢ï¼Œéœ€è¦åˆå¹¶ç»“æœ 26 */ 27 public List\u0026lt;Order\u0026gt; listByUserId(Long userId) { 28 return orderMapper.selectList( 29 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 30 .eq(Order::getUserId, userId) 31 .orderByDesc(Order::getCreateTime) 32 ); 33 } 34} åˆ†ç‰‡ç­–ç•¥è¯¦è§£ 1. æ ‡å‡†åˆ†ç‰‡ç­–ç•¥ï¼ˆStandardï¼‰ é€‚ç”¨äºå•ä¸€åˆ†ç‰‡é”®çš„åœºæ™¯ã€‚\n1database-strategy: 2 standard: 3 sharding-column: user_id 4 sharding-algorithm-name: database-mod å–æ¨¡ç®—æ³•\n1sharding-algorithms: 2 database-mod: 3 type: MOD 4 props: 5 sharding-count: 2 å“ˆå¸Œå–æ¨¡ç®—æ³•\n1sharding-algorithms: 2 database-hash-mod: 3 type: HASH_MOD 4 props: 5 sharding-count: 2 2. å¤åˆåˆ†ç‰‡ç­–ç•¥ï¼ˆComplexï¼‰ é€‚ç”¨äºå¤šä¸ªåˆ†ç‰‡é”®çš„åœºæ™¯ã€‚\n1database-strategy: 2 complex: 3 sharding-columns: user_id,order_id 4 sharding-algorithm-name: complex-inline 1sharding-algorithms: 2 complex-inline: 3 type: CLASS_BASED 4 props: 5 strategy: COMPLEX 6 algorithm-class-name: com.example.ComplexShardingAlgorithm è‡ªå®šä¹‰å¤åˆç®—æ³•\n1public class ComplexShardingAlgorithm implements ComplexKeysShardingAlgorithm\u0026lt;Long\u0026gt; { 2 3 @Override 4 public Collection\u0026lt;String\u0026gt; doSharding( 5 Collection\u0026lt;String\u0026gt; availableTargetNames, 6 ComplexKeysShardingValue\u0026lt;Long\u0026gt; shardingValue) { 7 8 // è·å–åˆ†ç‰‡é”®å€¼ 9 Map\u0026lt;String, Collection\u0026lt;Long\u0026gt;\u0026gt; columnNameAndShardingValuesMap = 10 shardingValue.getColumnNameAndShardingValuesMap(); 11 12 Collection\u0026lt;Long\u0026gt; userIds = columnNameAndShardingValuesMap.get(\u0026#34;user_id\u0026#34;); 13 Collection\u0026lt;Long\u0026gt; orderIds = columnNameAndShardingValuesMap.get(\u0026#34;order_id\u0026#34;); 14 15 // è‡ªå®šä¹‰åˆ†ç‰‡é€»è¾‘ 16 Set\u0026lt;String\u0026gt; result = new HashSet\u0026lt;\u0026gt;(); 17 for (Long userId : userIds) { 18 for (Long orderId : orderIds) { 19 String suffix = String.valueOf((userId + orderId) % 4); 20 result.addAll(availableTargetNames.stream() 21 .filter(name -\u0026gt; name.endsWith(suffix)) 22 .collect(Collectors.toList())); 23 } 24 } 25 return result; 26 } 27} 3. èŒƒå›´åˆ†ç‰‡ç­–ç•¥ï¼ˆRangeï¼‰ é€‚ç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢ã€‚\n1table-strategy: 2 standard: 3 sharding-column: create_time 4 sharding-algorithm-name: table-range 1sharding-algorithms: 2 table-range: 3 type: CLASS_BASED 4 props: 5 strategy: STANDARD 6 algorithm-class-name: com.example.RangeShardingAlgorithm æŒ‰æœˆåˆ†ç‰‡\n1public class RangeShardingAlgorithm implements StandardShardingAlgorithm\u0026lt;LocalDateTime\u0026gt; { 2 3 @Override 4 public String doSharding( 5 Collection\u0026lt;String\u0026gt; availableTargetNames, 6 PreciseShardingValue\u0026lt;LocalDateTime\u0026gt; shardingValue) { 7 8 LocalDateTime createTime = shardingValue.getValue(); 9 int month = createTime.getMonthValue(); 10 String suffix = String.format(\u0026#34;%02d\u0026#34;, month); 11 12 return availableTargetNames.stream() 13 .filter(name -\u0026gt; name.endsWith(suffix)) 14 .findFirst() 15 .orElseThrow(() -\u0026gt; new IllegalArgumentException(\u0026#34;æ‰¾ä¸åˆ°å¯¹åº”çš„åˆ†ç‰‡è¡¨\u0026#34;)); 16 } 17 18 @Override 19 public Collection\u0026lt;String\u0026gt; doSharding( 20 Collection\u0026lt;String\u0026gt; availableTargetNames, 21 RangeShardingValue\u0026lt;LocalDateTime\u0026gt; shardingValue) { 22 23 Range\u0026lt;LocalDateTime\u0026gt; range = shardingValue.getValueRange(); 24 LocalDateTime start = range.lowerEndpoint(); 25 LocalDateTime end = range.upperEndpoint(); 26 27 Set\u0026lt;String\u0026gt; result = new HashSet\u0026lt;\u0026gt;(); 28 for (int month = start.getMonthValue(); month \u0026lt;= end.getMonthValue(); month++) { 29 String suffix = String.format(\u0026#34;%02d\u0026#34;, month); 30 result.addAll(availableTargetNames.stream() 31 .filter(name -\u0026gt; name.endsWith(suffix)) 32 .collect(Collectors.toList())); 33 } 34 return result; 35 } 36} åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆ åˆ†åº“åˆ†è¡¨åï¼Œè‡ªå¢ä¸»é”®ä¼šå†²çªï¼Œéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®ã€‚\nSnowflake ç®—æ³• 1rules: 2 sharding: 3 tables: 4 orders: 5 key-generate-strategy: 6 column: order_id 7 key-generator-name: snowflake 8 9 key-generators: 10 snowflake: 11 type: SNOWFLAKE 12 props: 13 worker-id: 1 è‡ªå®šä¹‰ä¸»é”®ç”Ÿæˆå™¨ 1public class CustomKeyGenerator implements KeyGenerateAlgorithm { 2 3 @Override 4 public Comparable\u0026lt;?\u0026gt; generateKey() { 5 // æ—¶é—´æˆ³ï¼ˆ41ä½ï¼‰+ æœºå™¨IDï¼ˆ10ä½ï¼‰+ åºåˆ—å·ï¼ˆ12ä½ï¼‰ 6 long timestamp = System.currentTimeMillis(); 7 long workerId = getWorkerId(); 8 long sequence = getSequence(); 9 10 return (timestamp \u0026lt;\u0026lt; 22) | (workerId \u0026lt;\u0026lt; 12) | sequence; 11 } 12} è¯»å†™åˆ†ç¦» ShardingSphere æ”¯æŒä¸»ä»è¯»å†™åˆ†ç¦»ã€‚\n1rules: 2 readwrite-splitting: 3 data-sources: 4 ds0: 5 type: Static 6 props: 7 write-data-source-name: ds0-master 8 read-data-source-names: ds0-slave0,ds0-slave1 9 load-balancer-name: round-robin 10 ds1: 11 type: Static 12 props: 13 write-data-source-name: ds1-master 14 read-data-source-names: ds1-slave0,ds1-slave1 15 load-balancer-name: round-robin 16 17 load-balancers: 18 round-robin: 19 type: ROUND_ROBIN å¼ºåˆ¶ä¸»åº“æŸ¥è¯¢\n1// ä½¿ç”¨ HintManager å¼ºåˆ¶è·¯ç”±åˆ°ä¸»åº“ 2HintManager hintManager = HintManager.getInstance(); 3hintManager.setWriteRouteOnly(); 4try { 5 Order order = orderMapper.selectById(orderId); 6} finally { 7 hintManager.close(); 8} è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ï¼šå…¨è¡¨æ‰«æ 1// ä¸å¸¦åˆ†ç‰‡é”®çš„æŸ¥è¯¢ï¼Œä¼šæ‰«ææ‰€æœ‰åˆ†ç‰‡ 2List\u0026lt;Order\u0026gt; orders = orderMapper.selectList( 3 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 4 .eq(Order::getStatus, 1) 5); è§£å†³æ–¹æ¡ˆ1ï¼šå†—ä½™åˆ†ç‰‡é”® 1// åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­æ·»åŠ åˆ†ç‰‡é”® 2List\u0026lt;Order\u0026gt; orders = orderMapper.selectList( 3 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 4 .eq(Order::getUserId, userId) // åˆ†ç‰‡é”® 5 .eq(Order::getStatus, 1) 6); è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨ Hint 1// æ‰‹åŠ¨æŒ‡å®šåˆ†ç‰‡ 2HintManager hintManager = HintManager.getInstance(); 3hintManager.addDatabaseShardingValue(\u0026#34;orders\u0026#34;, \u0026#34;user_id\u0026#34;, userId); 4hintManager.addTableShardingValue(\u0026#34;orders\u0026#34;, \u0026#34;order_id\u0026#34;, orderId); 5try { 6 Order order = orderMapper.selectById(orderId); 7} finally { 8 hintManager.close(); 9} è§£å†³æ–¹æ¡ˆ3ï¼šå»ºç«‹æ˜ å°„è¡¨ 1-- è®¢å•çŠ¶æ€æ˜ å°„è¡¨ï¼ˆä¸åˆ†ç‰‡ï¼‰ 2CREATE TABLE order_status_mapping ( 3 order_id BIGINT PRIMARY KEY, 4 user_id BIGINT, 5 status INT, 6 INDEX idx_status (status) 7); 1// å…ˆæŸ¥æ˜ å°„è¡¨è·å–åˆ†ç‰‡é”® 2List\u0026lt;Long\u0026gt; orderIds = mappingMapper.selectOrderIdsByStatus(status); 3 4// å†æ ¹æ®åˆ†ç‰‡é”®æŸ¥è¯¢è¯¦æƒ… 5List\u0026lt;Order\u0026gt; orders = orderIds.stream() 6 .map(orderMapper::selectById) 7 .collect(Collectors.toList()); åˆ†å¸ƒå¼äº‹åŠ¡ ShardingSphere æ”¯æŒ XA å’Œ Saga ä¸¤ç§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nXA äº‹åŠ¡ 1rules: 2 transaction: 3 default-type: XA 4 provider-type: Atomikos 1@Transactional 2public void createOrderWithXA(Order order, OrderItem item) { 3 // è·¨åˆ†ç‰‡çš„äº‹åŠ¡æ“ä½œ 4 orderMapper.insert(order); 5 orderItemMapper.insert(item); 6} Saga äº‹åŠ¡ 1rules: 2 transaction: 3 default-type: BASE 4 provider-type: Seata æ¶æ„æ€è€ƒï¼š XA äº‹åŠ¡ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½è¾ƒå·®ï¼›Saga äº‹åŠ¡ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½æ›´å¥½ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Sagaï¼Œé€šè¿‡è¡¥å¿æœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚\næ•°æ®è¿ç§»æ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šåŒå†™ + æ•°æ®æ ¡éªŒ 1@Service 2public class OrderMigrationService { 3 4 @Autowired 5 private OrderMapper oldOrderMapper; // æ—§è¡¨ 6 7 @Autowired 8 private OrderMapper newOrderMapper; // æ–°è¡¨ï¼ˆåˆ†ç‰‡ï¼‰ 9 10 /** 11 * åŒå†™é˜¶æ®µï¼šåŒæ—¶å†™å…¥æ—§è¡¨å’Œæ–°è¡¨ 12 */ 13 public void createOrder(Order order) { 14 // å†™å…¥æ—§è¡¨ 15 oldOrderMapper.insert(order); 16 17 // å¼‚æ­¥å†™å…¥æ–°è¡¨ 18 CompletableFuture.runAsync(() -\u0026gt; { 19 try { 20 newOrderMapper.insert(order); 21 } catch (Exception e) { 22 log.error(\u0026#34;æ–°è¡¨å†™å…¥å¤±è´¥\u0026#34;, e); 23 // è®°å½•å¤±è´¥æ—¥å¿—ï¼Œåç»­è¡¥å¿ 24 } 25 }); 26 } 27 28 /** 29 * æ•°æ®æ ¡éªŒï¼šå¯¹æ¯”æ–°æ—§è¡¨æ•°æ® 30 */ 31 public void verifyData(Long orderId) { 32 Order oldOrder = oldOrderMapper.selectById(orderId); 33 Order newOrder = newOrderMapper.selectById(orderId); 34 35 if (!Objects.equals(oldOrder, newOrder)) { 36 log.error(\u0026#34;æ•°æ®ä¸ä¸€è‡´: orderId={}\u0026#34;, orderId); 37 // è§¦å‘å‘Šè­¦ 38 } 39 } 40} æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Canal åŒæ­¥ 1# Canal é…ç½® 2canal: 3 server: 127.0.0.1:11111 4 destination: example 5 username: canal 6 password: canal 7 filter: order_db\\\\.orders 1@Component 2public class CanalDataSyncListener { 3 4 @Autowired 5 private OrderMapper shardingOrderMapper; 6 7 @CanalEventListener 8 public void onEvent(CanalEntry.Entry entry) { 9 if (entry.getEntryType() == CanalEntry.EntryType.ROWDATA) { 10 RowChange rowChange = RowChange.parseFrom(entry.getStoreValue()); 11 12 for (CanalEntry.RowData rowData : rowChange.getRowDatasList()) { 13 if (rowChange.getEventType() == CanalEntry.EventType.INSERT) { 14 Order order = parseOrder(rowData.getAfterColumnsList()); 15 shardingOrderMapper.insert(order); 16 } 17 } 18 } 19 } 20} æ€§èƒ½å¯¹æ¯” æµ‹è¯•ç¯å¢ƒ æ•°æ®é‡ï¼š5000ä¸‡æ¡ åˆ†ç‰‡é…ç½®ï¼š2åº“ Ã— 4è¡¨ = 8ä¸ªåˆ†ç‰‡ æ¯ä¸ªåˆ†ç‰‡ï¼š625ä¸‡æ¡æ•°æ® æŸ¥è¯¢æ€§èƒ½å¯¹æ¯” åœºæ™¯ å•è¡¨ åˆ†åº“åˆ†è¡¨ æå‡ ä¸»é”®æŸ¥è¯¢ 150ms 15ms 10å€ ç´¢å¼•æŸ¥è¯¢ 800ms 80ms 10å€ èŒƒå›´æŸ¥è¯¢ 2000ms 250ms 8å€ èšåˆæŸ¥è¯¢ 5000ms 800ms 6å€ å†™å…¥æ€§èƒ½å¯¹æ¯” åœºæ™¯ å•è¡¨ åˆ†åº“åˆ†è¡¨ æå‡ å•æ¡æ’å…¥ 5ms 6ms æŒå¹³ æ‰¹é‡æ’å…¥ï¼ˆ1000æ¡ï¼‰ 800ms 200ms 4å€ æœ€ä½³å®è·µ 1. åˆ†ç‰‡é”®é€‰æ‹©\nä¼˜å…ˆé€‰æ‹©é«˜é¢‘æŸ¥è¯¢å­—æ®µ ç¡®ä¿æ•°æ®åˆ†å¸ƒå‡åŒ€ é¿å…çƒ­ç‚¹æ•°æ® 2. é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢\nåœ¨æŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«åˆ†ç‰‡é”® ä½¿ç”¨æ˜ å°„è¡¨è¾…åŠ©æŸ¥è¯¢ åˆç†è®¾è®¡æ•°æ®æ¨¡å‹ 3. åˆ†ç‰‡æ•°é‡è§„åˆ’\nå•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨500ä¸‡ä»¥å†… é¢„ç•™æ‰©å±•ç©ºé—´ï¼ˆ2-3å€ï¼‰ åˆ†ç‰‡æ•°é‡å»ºè®®ä¸º2çš„å¹‚æ¬¡æ–¹ 4. ç›‘æ§å‘Šè­¦\nç›‘æ§å„åˆ†ç‰‡æ•°æ®é‡ ç›‘æ§æ…¢æŸ¥è¯¢ ç›‘æ§è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹ 5. ç°åº¦å‘å¸ƒ\nå…ˆè¿ç§»å†å²æ•°æ® å†å¼€å¯åŒå†™ æœ€ååˆ‡æ¢è¯»æµé‡ é¿å‘æç¤ºï¼š åˆ†åº“åˆ†è¡¨ä¸æ˜¯é“¶å¼¹ï¼Œä¼šå¢åŠ ç³»ç»Ÿå¤æ‚åº¦ã€‚åœ¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§ä¹‹å‰ï¼Œä¼˜å…ˆè€ƒè™‘ç´¢å¼•ä¼˜åŒ–ã€ç¼“å­˜ã€è¯»å†™åˆ†ç¦»ç­‰æ–¹æ¡ˆã€‚åªæœ‰åœ¨è¿™äº›æ–¹æ¡ˆéƒ½æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå†è€ƒè™‘åˆ†åº“åˆ†è¡¨ã€‚\næ€»ç»“ä¸æ€è€ƒ ShardingSphere åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒè¦ç‚¹ï¼š\né€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®ï¼Œé¿å…æ•°æ®å€¾æ–œ ä½¿ç”¨æ ‡å‡†åˆ†ç‰‡ç­–ç•¥ï¼Œç®€åŒ–é…ç½® é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½ ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®ï¼Œé¿å…IDå†²çª ç°åº¦è¿ç§»æ•°æ®ï¼Œé™ä½é£é™© åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¤æ‚åº¦ã€‚åœ¨å®æ–½å‰è¦å……åˆ†è¯„ä¼°ï¼š\næ˜¯å¦çœŸçš„éœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ åˆ†ç‰‡é”®å¦‚ä½•é€‰æ‹©ï¼Ÿ å¦‚ä½•å¤„ç†è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼Ÿ å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ ä¸‹æ¬¡å½“ä½ çš„å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§æ—¶ï¼Œä¸å¦¨è¯•è¯• ShardingSphereï¼Œè®©æ•°æ®åº“æ€§èƒ½é‡å›å·…å³°ã€‚\n","permalink":"http://localhost:1313/posts/2025/02/shardingsphere-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9A%84%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eå½“å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§åˆ«æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆã€‚æœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ ShardingSphere å®ç°åˆ†åº“åˆ†è¡¨ï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒçš„å®æˆ˜ç»éªŒã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒæ¦‚å¿µå’Œåº”ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ ShardingSphere çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†åº“åˆ†è¡¨çš„æœ€ä½³å®è·µå’Œå¸¸è§é—®é¢˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨\"\u003eä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼šè®¢å•è¡¨æ•°æ®çˆ†ç‚¸\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç”µå•†ç³»ç»Ÿçš„è®¢å•è¡¨ï¼Œæ¯å¤©æ–°å¢10ä¸‡æ¡æ•°æ®ï¼Œä¸€å¹´å°±æ˜¯3600ä¸‡æ¡ã€‚éšç€æ•°æ®é‡å¢é•¿ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæŸ¥è¯¢å˜æ…¢\u003c/strong\u003eï¼šå•è¡¨æŸ¥è¯¢ä»æ¯«ç§’çº§å˜æˆç§’çº§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç´¢å¼•å¤±æ•ˆ\u003c/strong\u003eï¼šB+æ ‘å±‚çº§å¢åŠ ï¼Œç´¢å¼•æ•ˆç‡ä¸‹é™\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eé”ç«äº‰\u003c/strong\u003eï¼šå¤§è¡¨çš„é”ç²’åº¦å¤§ï¼Œå¹¶å‘æ€§èƒ½å·®\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå¤‡ä»½å›°éš¾\u003c/strong\u003eï¼šå•è¡¨å¤‡ä»½æ—¶é—´è¿‡é•¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿä¼˜åŒ–æ–¹æ¡ˆçš„å±€é™\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e-- ä¼˜åŒ–ç´¢å¼•\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCREATE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eINDEX\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eidx_user_id_create_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eON\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser_id\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e-- åˆ†åŒºè¡¨\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eALTER\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eBY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRANGE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eYEAR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ep2023\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eLESS\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTHAN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2024\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ep2024\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eLESS\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTHAN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2025\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™äº›æ–¹æ¡ˆåªèƒ½ç¼“è§£é—®é¢˜ï¼Œæ— æ³•æ ¹æœ¬è§£å†³ã€‚å½“æ•°æ®é‡è¾¾åˆ°äº¿çº§æ—¶ï¼Œåˆ†åº“åˆ†è¡¨æ˜¯å¿…ç„¶é€‰æ‹©ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ\"\u003eåˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003ch3 id=\"å‚ç›´æ‹†åˆ†-vs-æ°´å¹³æ‹†åˆ†\"\u003eå‚ç›´æ‹†åˆ† vs æ°´å¹³æ‹†åˆ†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eå‚ç›´æ‹†åˆ†\u003c/strong\u003eï¼šæŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003eåŸå§‹æ•°æ®åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ ç”¨æˆ·è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ è®¢å•è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ å•†å“è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ æ”¯ä»˜è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003eæ‹†åˆ†å\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ ç”¨æˆ·åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ ç”¨æˆ·è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ è®¢å•åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ è®¢å•è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ å•†å“åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ å•†å“è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ æ”¯ä»˜åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    â””â”€â”€ æ”¯ä»˜è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ°´å¹³æ‹†åˆ†\u003c/strong\u003eï¼šæŒ‰æ•°æ®è¡Œæ‹†åˆ†\u003c/p\u003e","title":"ShardingSphere åˆ†åº“åˆ†è¡¨çš„ç”Ÿäº§å®æˆ˜"},{"content":"åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°çš„é…ç½®å¾€å¾€éœ€è¦æ ¹æ®å®é™…è´Ÿè½½åŠ¨æ€è°ƒæ•´ã€‚ç¡¬ç¼–ç çš„å‚æ•°é…ç½®ç¼ºä¹çµæ´»æ€§ï¼Œé‡å¯æœåŠ¡åˆä¼šå½±å“ä¸šåŠ¡ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•è®¾è®¡ä¸€ä¸ªçº¿ç¨‹æ± ç®¡ç†åå°ï¼Œå®ç°å‚æ•°çš„åŠ¨æ€é…ç½®å’Œå®æ—¶ç›‘æ§ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£çº¿ç¨‹æ± å‚æ•°åŠ¨æ€è°ƒæ•´çš„åŸç†ä¸å®ç° æŒæ¡çº¿ç¨‹æ± ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†ä¸å±•ç¤º å­¦ä¼šè®¾è®¡ç”Ÿäº§çº§çš„çº¿ç¨‹æ± ç®¡ç†å¹³å° äº†è§£çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜çš„æœ€ä½³å®è·µ ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®ï¼Ÿ åœºæ™¯ä¸€ï¼šæµé‡çªå¢\nåŒåä¸€æœŸé—´ï¼Œè®¢å•å¤„ç†çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º 10ï¼Œæœ€å¤§çº¿ç¨‹æ•° 20ã€‚çªç„¶æµé‡æš´å¢ï¼Œé˜Ÿåˆ—å †ç§¯ä¸¥é‡ï¼Œå¯¼è‡´è®¢å•å¤„ç†å»¶è¿Ÿã€‚\nå¦‚æœèƒ½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼Œå°†æ ¸å¿ƒçº¿ç¨‹æ•°è°ƒæ•´ä¸º 50ï¼Œæœ€å¤§çº¿ç¨‹æ•°è°ƒæ•´ä¸º 100ï¼Œå°±èƒ½å¿«é€Ÿåº”å¯¹æµé‡é«˜å³°ã€‚\nåœºæ™¯äºŒï¼šèµ„æºæµªè´¹\nå‡Œæ™¨æ—¶æ®µæµé‡å¾ˆä½ï¼Œä½†çº¿ç¨‹æ± ä»ç„¶ä¿æŒé«˜å³°æœŸçš„é…ç½®ï¼Œæµªè´¹äº†å¤§é‡ç³»ç»Ÿèµ„æºã€‚\nä¼ ç»Ÿåšæ³•çš„é—®é¢˜\n1@Configuration 2public class ThreadPoolConfig { 3 @Bean(\u0026#34;orderThreadPool\u0026#34;) 4 public ThreadPoolExecutor orderThreadPool() { 5 return new ThreadPoolExecutor( 6 10, // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç  7 20, // æœ€å¤§çº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç  8 60, TimeUnit.SECONDS, 9 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 10 new ThreadFactoryBuilder().setNameFormat(\u0026#34;order-pool-%d\u0026#34;).build(), 11 new ThreadPoolExecutor.CallerRunsPolicy() 12 ); 13 } 14} é—®é¢˜ï¼š\nå‚æ•°ç¡¬ç¼–ç ï¼Œæ— æ³•åŠ¨æ€è°ƒæ•´ è°ƒæ•´å‚æ•°éœ€è¦é‡å¯æœåŠ¡ ç¼ºä¹ç›‘æ§ï¼Œæ— æ³•äº†è§£çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ ç³»ç»Ÿæ¶æ„è®¾è®¡ æ•´ä½“æ¶æ„ 1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ Admin ç®¡ç†åå° â”‚ 3â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 4â”‚ â”‚ çº¿ç¨‹æ± åˆ—è¡¨ â”‚ â”‚ å®æ—¶ç›‘æ§ â”‚ â”‚ å‚æ•°è°ƒæ•´ â”‚ â”‚ 5â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 6â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 7 â†“ HTTP API 8â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 9â”‚ Spring Boot åº”ç”¨ â”‚ 10â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 11â”‚ â”‚ ThreadPoolRegistry â”‚ â”‚ 12â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ 13â”‚ â”‚ â”‚ è®¢å•çº¿ç¨‹æ± â”‚ â”‚ æ”¯ä»˜çº¿ç¨‹æ± â”‚ â”‚ é€šçŸ¥çº¿ç¨‹æ± â”‚ â”‚ â”‚ 14â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ 15â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 16â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 17â”‚ â”‚ ThreadPoolMonitor â”‚ â”‚ 18â”‚ â”‚ (å®šæ—¶é‡‡é›†æŒ‡æ ‡ï¼Œä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ) â”‚ â”‚ 19â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 20â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒç»„ä»¶ ThreadPoolRegistryï¼šçº¿ç¨‹æ± æ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†æ‰€æœ‰çº¿ç¨‹æ± å®ä¾‹ ThreadPoolMonitorï¼šç›‘æ§ç»„ä»¶ï¼Œå®šæ—¶é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ ThreadPoolControllerï¼šREST APIï¼Œæä¾›æŸ¥è¯¢å’Œè°ƒæ•´æ¥å£ Admin ç®¡ç†åå°ï¼šå‰ç«¯é¡µé¢ï¼Œå±•ç¤ºç›‘æ§æ•°æ®å’Œå‚æ•°è°ƒæ•´ç•Œé¢ ç¬¬ä¸€æ­¥ï¼šçº¿ç¨‹æ± æ³¨å†Œä¸­å¿ƒ ThreadPoolRegistry\n1@Component 2public class ThreadPoolRegistry { 3 4 private final Map\u0026lt;String, ThreadPoolExecutor\u0026gt; executors = new ConcurrentHashMap\u0026lt;\u0026gt;(); 5 6 /** 7 * æ³¨å†Œçº¿ç¨‹æ±  8 */ 9 public void register(String name, ThreadPoolExecutor executor) { 10 executors.put(name, executor); 11 log.info(\u0026#34;æ³¨å†Œçº¿ç¨‹æ± : {}, æ ¸å¿ƒçº¿ç¨‹æ•°: {}, æœ€å¤§çº¿ç¨‹æ•°: {}\u0026#34;, 12 name, executor.getCorePoolSize(), executor.getMaximumPoolSize()); 13 } 14 15 /** 16 * è·å–æ‰€æœ‰çº¿ç¨‹æ±  17 */ 18 public Map\u0026lt;String, ThreadPoolExecutor\u0026gt; getAll() { 19 return Collections.unmodifiableMap(executors); 20 } 21 22 /** 23 * æ ¹æ®åç§°è·å–çº¿ç¨‹æ±  24 */ 25 public ThreadPoolExecutor get(String name) { 26 return executors.get(name); 27 } 28 29 /** 30 * åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 31 */ 32 public void adjust(String name, int corePoolSize, int maximumPoolSize) { 33 ThreadPoolExecutor executor = executors.get(name); 34 if (executor == null) { 35 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + name); 36 } 37 38 // å‚æ•°æ ¡éªŒ 39 if (corePoolSize \u0026lt;= 0 || maximumPoolSize \u0026lt;= 0) { 40 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± å‚æ•°å¿…é¡»å¤§äº 0\u0026#34;); 41 } 42 if (corePoolSize \u0026gt; maximumPoolSize) { 43 throw new IllegalArgumentException(\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å¤§äºæœ€å¤§çº¿ç¨‹æ•°\u0026#34;); 44 } 45 46 // è°ƒæ•´å‚æ•° 47 executor.setCorePoolSize(corePoolSize); 48 executor.setMaximumPoolSize(maximumPoolSize); 49 50 log.info(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°: {}, æ ¸å¿ƒçº¿ç¨‹æ•°: {} -\u0026gt; {}, æœ€å¤§çº¿ç¨‹æ•°: {} -\u0026gt; {}\u0026#34;, 51 name, executor.getCorePoolSize(), corePoolSize, 52 executor.getMaximumPoolSize(), maximumPoolSize); 53 } 54} è‡ªåŠ¨æ³¨å†Œçº¿ç¨‹æ± \nä½¿ç”¨ BeanPostProcessor è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰ ThreadPoolExecutorï¼š\n1@Component 2public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Override 8 public Object postProcessAfterInitialization(Object bean, String beanName) { 9 if (bean instanceof ThreadPoolExecutor) { 10 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 11 registry.register(beanName, executor); 12 } 13 return bean; 14 } 15} è¿™æ ·ï¼Œæ‰€æœ‰é€šè¿‡ Spring ç®¡ç†çš„ ThreadPoolExecutor éƒ½ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° Registry ä¸­ã€‚\nç¬¬äºŒæ­¥ï¼šç›‘æ§æŒ‡æ ‡é‡‡é›† ThreadPoolMetrics\n1@Data 2@Builder 3public class ThreadPoolMetrics { 4 private String name; // çº¿ç¨‹æ± åç§° 5 private int corePoolSize; // æ ¸å¿ƒçº¿ç¨‹æ•° 6 private int maximumPoolSize; // æœ€å¤§çº¿ç¨‹æ•° 7 private int activeCount; // æ´»è·ƒçº¿ç¨‹æ•° 8 private int poolSize; // å½“å‰çº¿ç¨‹æ•° 9 private int queueSize; // é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•° 10 private int queueRemainingCapacity; // é˜Ÿåˆ—å‰©ä½™å®¹é‡ 11 private long completedTaskCount; // å·²å®Œæˆä»»åŠ¡æ•° 12 private long taskCount; // æ€»ä»»åŠ¡æ•° 13 private String rejectedExecutionHandler; // æ‹’ç»ç­–ç•¥ 14 private long timestamp; // é‡‡é›†æ—¶é—´æˆ³ 15 16 /** 17 * è®¡ç®—çº¿ç¨‹æ± ä½¿ç”¨ç‡ 18 */ 19 public double getPoolUsageRate() { 20 return maximumPoolSize == 0 ? 0 : (double) poolSize / maximumPoolSize * 100; 21 } 22 23 /** 24 * è®¡ç®—é˜Ÿåˆ—ä½¿ç”¨ç‡ 25 */ 26 public double getQueueUsageRate() { 27 int capacity = queueSize + queueRemainingCapacity; 28 return capacity == 0 ? 0 : (double) queueSize / capacity * 100; 29 } 30} ThreadPoolMonitor\n1@Component 2@Slf4j 3public class ThreadPoolMonitor { 4 5 @Autowired 6 private ThreadPoolRegistry registry; 7 8 /** 9 * å®šæ—¶é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ 10 */ 11 @Scheduled(fixedDelay = 30000) // æ¯ 30 ç§’é‡‡é›†ä¸€æ¬¡ 12 public void collect() { 13 registry.getAll().forEach((name, executor) -\u0026gt; { 14 ThreadPoolMetrics metrics = collectMetrics(name, executor); 15 16 // æ‰“å°æ—¥å¿— 17 log.info(\u0026#34;çº¿ç¨‹æ± æŒ‡æ ‡: {}\u0026#34;, metrics); 18 19 // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€InfluxDB ç­‰ï¼‰ 20 reportToMonitor(metrics); 21 22 // æ£€æŸ¥å‘Šè­¦æ¡ä»¶ 23 checkAlert(metrics); 24 }); 25 } 26 27 /** 28 * é‡‡é›†å•ä¸ªçº¿ç¨‹æ± çš„æŒ‡æ ‡ 29 */ 30 private ThreadPoolMetrics collectMetrics(String name, ThreadPoolExecutor executor) { 31 return ThreadPoolMetrics.builder() 32 .name(name) 33 .corePoolSize(executor.getCorePoolSize()) 34 .maximumPoolSize(executor.getMaximumPoolSize()) 35 .activeCount(executor.getActiveCount()) 36 .poolSize(executor.getPoolSize()) 37 .queueSize(executor.getQueue().size()) 38 .queueRemainingCapacity(executor.getQueue().remainingCapacity()) 39 .completedTaskCount(executor.getCompletedTaskCount()) 40 .taskCount(executor.getTaskCount()) 41 .rejectedExecutionHandler(executor.getRejectedExecutionHandler().getClass().getSimpleName()) 42 .timestamp(System.currentTimeMillis()) 43 .build(); 44 } 45 46 /** 47 * ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ 48 */ 49 private void reportToMonitor(ThreadPoolMetrics metrics) { 50 // é›†æˆ Prometheusã€InfluxDB ç­‰ç›‘æ§ç³»ç»Ÿ 51 // è¿™é‡Œçœç•¥å…·ä½“å®ç° 52 } 53 54 /** 55 * æ£€æŸ¥å‘Šè­¦æ¡ä»¶ 56 */ 57 private void checkAlert(ThreadPoolMetrics metrics) { 58 // é˜Ÿåˆ—ä½¿ç”¨ç‡è¶…è¿‡ 80% 59 if (metrics.getQueueUsageRate() \u0026gt; 80) { 60 log.warn(\u0026#34;çº¿ç¨‹æ±  {} é˜Ÿåˆ—ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, 61 metrics.getName(), metrics.getQueueUsageRate()); 62 // å‘é€å‘Šè­¦ï¼ˆé’‰é’‰ã€é‚®ä»¶ç­‰ï¼‰ 63 } 64 65 // çº¿ç¨‹æ± ä½¿ç”¨ç‡è¶…è¿‡ 90% 66 if (metrics.getPoolUsageRate() \u0026gt; 90) { 67 log.warn(\u0026#34;çº¿ç¨‹æ±  {} ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, 68 metrics.getName(), metrics.getPoolUsageRate()); 69 } 70 } 71} æ¶æ„æ€è€ƒï¼š ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†é¢‘ç‡éœ€è¦æƒè¡¡ã€‚é¢‘ç‡å¤ªé«˜ä¼šå¢åŠ ç³»ç»Ÿå¼€é”€ï¼Œé¢‘ç‡å¤ªä½åˆæ— æ³•åŠæ—¶å‘ç°é—®é¢˜ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®® 30-60 ç§’é‡‡é›†ä¸€æ¬¡ï¼Œå‘Šè­¦é˜ˆå€¼å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚\nç¬¬ä¸‰æ­¥ï¼šREST API æ¥å£ ThreadPoolController\n1@RestController 2@RequestMapping(\u0026#34;/api/threadpool\u0026#34;) 3@Slf4j 4public class ThreadPoolController { 5 6 @Autowired 7 private ThreadPoolRegistry registry; 8 9 /** 10 * æŸ¥è¯¢æ‰€æœ‰çº¿ç¨‹æ±  11 */ 12 @GetMapping(\u0026#34;/list\u0026#34;) 13 public Result\u0026lt;List\u0026lt;ThreadPoolInfo\u0026gt;\u0026gt; list() { 14 List\u0026lt;ThreadPoolInfo\u0026gt; list = registry.getAll().entrySet().stream() 15 .map(entry -\u0026gt; ThreadPoolInfo.from(entry.getKey(), entry.getValue())) 16 .collect(Collectors.toList()); 17 return Result.success(list); 18 } 19 20 /** 21 * æŸ¥è¯¢å•ä¸ªçº¿ç¨‹æ± è¯¦æƒ… 22 */ 23 @GetMapping(\u0026#34;/detail/{name}\u0026#34;) 24 public Result\u0026lt;ThreadPoolInfo\u0026gt; detail(@PathVariable String name) { 25 ThreadPoolExecutor executor = registry.get(name); 26 if (executor == null) { 27 return Result.error(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + name); 28 } 29 return Result.success(ThreadPoolInfo.from(name, executor)); 30 } 31 32 /** 33 * åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 34 */ 35 @PostMapping(\u0026#34;/adjust\u0026#34;) 36 public Result\u0026lt;Void\u0026gt; adjust(@RequestBody ThreadPoolAdjustRequest request) { 37 try { 38 registry.adjust( 39 request.getName(), 40 request.getCorePoolSize(), 41 request.getMaximumPoolSize() 42 ); 43 return Result.success(); 44 } catch (Exception e) { 45 log.error(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°å¤±è´¥\u0026#34;, e); 46 return Result.error(e.getMessage()); 47 } 48 } 49} ThreadPoolInfo\n1@Data 2@Builder 3public class ThreadPoolInfo { 4 private String name; 5 private int corePoolSize; 6 private int maximumPoolSize; 7 private int activeCount; 8 private int poolSize; 9 private int queueSize; 10 private int queueCapacity; 11 private long completedTaskCount; 12 private long taskCount; 13 private String rejectedExecutionHandler; 14 private double poolUsageRate; 15 private double queueUsageRate; 16 17 public static ThreadPoolInfo from(String name, ThreadPoolExecutor executor) { 18 int queueSize = executor.getQueue().size(); 19 int queueCapacity = queueSize + executor.getQueue().remainingCapacity(); 20 21 return ThreadPoolInfo.builder() 22 .name(name) 23 .corePoolSize(executor.getCorePoolSize()) 24 .maximumPoolSize(executor.getMaximumPoolSize()) 25 .activeCount(executor.getActiveCount()) 26 .poolSize(executor.getPoolSize()) 27 .queueSize(queueSize) 28 .queueCapacity(queueCapacity) 29 .completedTaskCount(executor.getCompletedTaskCount()) 30 .taskCount(executor.getTaskCount()) 31 .rejectedExecutionHandler(executor.getRejectedExecutionHandler().getClass().getSimpleName()) 32 .poolUsageRate((double) executor.getPoolSize() / executor.getMaximumPoolSize() * 100) 33 .queueUsageRate(queueCapacity == 0 ? 0 : (double) queueSize / queueCapacity * 100) 34 .build(); 35 } 36} ThreadPoolAdjustRequest\n1@Data 2public class ThreadPoolAdjustRequest { 3 @NotBlank(message = \u0026#34;çº¿ç¨‹æ± åç§°ä¸èƒ½ä¸ºç©º\u0026#34;) 4 private String name; 5 6 @Min(value = 1, message = \u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°å¿…é¡»å¤§äº 0\u0026#34;) 7 private int corePoolSize; 8 9 @Min(value = 1, message = \u0026#34;æœ€å¤§çº¿ç¨‹æ•°å¿…é¡»å¤§äº 0\u0026#34;) 10 private int maximumPoolSize; 11} ç¬¬å››æ­¥ï¼šAdmin ç®¡ç†åå° å‰ç«¯æŠ€æœ¯æ ˆ\nVue 3 + Element Plus EChartsï¼ˆå›¾è¡¨å±•ç¤ºï¼‰ Axiosï¼ˆHTTP è¯·æ±‚ï¼‰ çº¿ç¨‹æ± åˆ—è¡¨é¡µé¢\n1\u0026lt;template\u0026gt; 2 \u0026lt;div class=\u0026#34;threadpool-list\u0026#34;\u0026gt; 3 \u0026lt;el-table :data=\u0026#34;threadPoolList\u0026#34; border\u0026gt; 4 \u0026lt;el-table-column prop=\u0026#34;name\u0026#34; label=\u0026#34;çº¿ç¨‹æ± åç§°\u0026#34; width=\u0026#34;200\u0026#34; /\u0026gt; 5 \u0026lt;el-table-column prop=\u0026#34;corePoolSize\u0026#34; label=\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 6 \u0026lt;el-table-column prop=\u0026#34;maximumPoolSize\u0026#34; label=\u0026#34;æœ€å¤§çº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 7 \u0026lt;el-table-column prop=\u0026#34;activeCount\u0026#34; label=\u0026#34;æ´»è·ƒçº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 8 \u0026lt;el-table-column prop=\u0026#34;poolSize\u0026#34; label=\u0026#34;å½“å‰çº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 9 \u0026lt;el-table-column prop=\u0026#34;queueSize\u0026#34; label=\u0026#34;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 10 \u0026lt;el-table-column label=\u0026#34;çº¿ç¨‹æ± ä½¿ç”¨ç‡\u0026#34; width=\u0026#34;150\u0026#34;\u0026gt; 11 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 12 \u0026lt;el-progress 13 :percentage=\u0026#34;row.poolUsageRate\u0026#34; 14 :color=\u0026#34;getProgressColor(row.poolUsageRate)\u0026#34; 15 /\u0026gt; 16 \u0026lt;/template\u0026gt; 17 \u0026lt;/el-table-column\u0026gt; 18 \u0026lt;el-table-column label=\u0026#34;é˜Ÿåˆ—ä½¿ç”¨ç‡\u0026#34; width=\u0026#34;150\u0026#34;\u0026gt; 19 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 20 \u0026lt;el-progress 21 :percentage=\u0026#34;row.queueUsageRate\u0026#34; 22 :color=\u0026#34;getProgressColor(row.queueUsageRate)\u0026#34; 23 /\u0026gt; 24 \u0026lt;/template\u0026gt; 25 \u0026lt;/el-table-column\u0026gt; 26 \u0026lt;el-table-column label=\u0026#34;æ“ä½œ\u0026#34; width=\u0026#34;200\u0026#34;\u0026gt; 27 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 28 \u0026lt;el-button size=\u0026#34;small\u0026#34; @click=\u0026#34;showAdjustDialog(row)\u0026#34;\u0026gt; 29 è°ƒæ•´å‚æ•° 30 \u0026lt;/el-button\u0026gt; 31 \u0026lt;el-button size=\u0026#34;small\u0026#34; @click=\u0026#34;showMonitorDialog(row)\u0026#34;\u0026gt; 32 æŸ¥çœ‹ç›‘æ§ 33 \u0026lt;/el-button\u0026gt; 34 \u0026lt;/template\u0026gt; 35 \u0026lt;/el-table-column\u0026gt; 36 \u0026lt;/el-table\u0026gt; 37 38 \u0026lt;!-- å‚æ•°è°ƒæ•´å¯¹è¯æ¡† --\u0026gt; 39 \u0026lt;el-dialog v-model=\u0026#34;adjustDialogVisible\u0026#34; title=\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°\u0026#34;\u0026gt; 40 \u0026lt;el-form :model=\u0026#34;adjustForm\u0026#34; label-width=\u0026#34;120px\u0026#34;\u0026gt; 41 \u0026lt;el-form-item label=\u0026#34;çº¿ç¨‹æ± åç§°\u0026#34;\u0026gt; 42 \u0026lt;el-input v-model=\u0026#34;adjustForm.name\u0026#34; disabled /\u0026gt; 43 \u0026lt;/el-form-item\u0026gt; 44 \u0026lt;el-form-item label=\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#34;\u0026gt; 45 \u0026lt;el-input-number v-model=\u0026#34;adjustForm.corePoolSize\u0026#34; :min=\u0026#34;1\u0026#34; /\u0026gt; 46 \u0026lt;/el-form-item\u0026gt; 47 \u0026lt;el-form-item label=\u0026#34;æœ€å¤§çº¿ç¨‹æ•°\u0026#34;\u0026gt; 48 \u0026lt;el-input-number v-model=\u0026#34;adjustForm.maximumPoolSize\u0026#34; :min=\u0026#34;1\u0026#34; /\u0026gt; 49 \u0026lt;/el-form-item\u0026gt; 50 \u0026lt;/el-form\u0026gt; 51 \u0026lt;template #footer\u0026gt; 52 \u0026lt;el-button @click=\u0026#34;adjustDialogVisible = false\u0026#34;\u0026gt;å–æ¶ˆ\u0026lt;/el-button\u0026gt; 53 \u0026lt;el-button type=\u0026#34;primary\u0026#34; @click=\u0026#34;adjustThreadPool\u0026#34;\u0026gt;ç¡®å®š\u0026lt;/el-button\u0026gt; 54 \u0026lt;/template\u0026gt; 55 \u0026lt;/el-dialog\u0026gt; 56 \u0026lt;/div\u0026gt; 57\u0026lt;/template\u0026gt; 58 59\u0026lt;script setup\u0026gt; 60import { ref, onMounted } from \u0026#39;vue\u0026#39;; 61import { ElMessage } from \u0026#39;element-plus\u0026#39;; 62import axios from \u0026#39;axios\u0026#39;; 63 64const threadPoolList = ref([]); 65const adjustDialogVisible = ref(false); 66const adjustForm = ref({ 67 name: \u0026#39;\u0026#39;, 68 corePoolSize: 0, 69 maximumPoolSize: 0 70}); 71 72// åŠ è½½çº¿ç¨‹æ± åˆ—è¡¨ 73const loadThreadPoolList = async () =\u0026gt; { 74 const { data } = await axios.get(\u0026#39;/api/threadpool/list\u0026#39;); 75 threadPoolList.value = data.data; 76}; 77 78// æ˜¾ç¤ºè°ƒæ•´å¯¹è¯æ¡† 79const showAdjustDialog = (row) =\u0026gt; { 80 adjustForm.value = { 81 name: row.name, 82 corePoolSize: row.corePoolSize, 83 maximumPoolSize: row.maximumPoolSize 84 }; 85 adjustDialogVisible.value = true; 86}; 87 88// è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 89const adjustThreadPool = async () =\u0026gt; { 90 try { 91 await axios.post(\u0026#39;/api/threadpool/adjust\u0026#39;, adjustForm.value); 92 ElMessage.success(\u0026#39;è°ƒæ•´æˆåŠŸ\u0026#39;); 93 adjustDialogVisible.value = false; 94 loadThreadPoolList(); 95 } catch (error) { 96 ElMessage.error(\u0026#39;è°ƒæ•´å¤±è´¥: \u0026#39; + error.message); 97 } 98}; 99 100// è¿›åº¦æ¡é¢œè‰² 101const getProgressColor = (percentage) =\u0026gt; { 102 if (percentage \u0026lt; 60) return \u0026#39;#67C23A\u0026#39;; 103 if (percentage \u0026lt; 80) return \u0026#39;#E6A23C\u0026#39;; 104 return \u0026#39;#F56C6C\u0026#39;; 105}; 106 107onMounted(() =\u0026gt; { 108 loadThreadPoolList(); 109 // æ¯ 30 ç§’åˆ·æ–°ä¸€æ¬¡ 110 setInterval(loadThreadPoolList, 30000); 111}); 112\u0026lt;/script\u0026gt; å®æ—¶ç›‘æ§é¡µé¢\nä½¿ç”¨ ECharts å±•ç¤ºçº¿ç¨‹æ± æŒ‡æ ‡çš„æ—¶é—´åºåˆ—å›¾ï¼š\n1// çº¿ç¨‹æ± ç›‘æ§å›¾è¡¨ 2const initChart = () =\u0026gt; { 3 const chart = echarts.init(document.getElementById(\u0026#39;chart\u0026#39;)); 4 5 const option = { 6 title: { text: \u0026#39;çº¿ç¨‹æ± ç›‘æ§\u0026#39; }, 7 tooltip: { trigger: \u0026#39;axis\u0026#39; }, 8 legend: { 9 data: [\u0026#39;æ´»è·ƒçº¿ç¨‹æ•°\u0026#39;, \u0026#39;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#39;, \u0026#39;å®Œæˆä»»åŠ¡æ•°\u0026#39;] 10 }, 11 xAxis: { 12 type: \u0026#39;category\u0026#39;, 13 data: timeLabels.value 14 }, 15 yAxis: { type: \u0026#39;value\u0026#39; }, 16 series: [ 17 { 18 name: \u0026#39;æ´»è·ƒçº¿ç¨‹æ•°\u0026#39;, 19 type: \u0026#39;line\u0026#39;, 20 data: activeCountData.value 21 }, 22 { 23 name: \u0026#39;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#39;, 24 type: \u0026#39;line\u0026#39;, 25 data: queueSizeData.value 26 }, 27 { 28 name: \u0026#39;å®Œæˆä»»åŠ¡æ•°\u0026#39;, 29 type: \u0026#39;line\u0026#39;, 30 data: completedTaskCountData.value 31 } 32 ] 33 }; 34 35 chart.setOption(option); 36}; ç¬¬äº”æ­¥ï¼šæŒä¹…åŒ–é…ç½® å°†è°ƒæ•´åçš„å‚æ•°æŒä¹…åŒ–åˆ°æ•°æ®åº“æˆ–é…ç½®ä¸­å¿ƒï¼Œé‡å¯åè‡ªåŠ¨åŠ è½½ã€‚\næ•°æ®åº“è¡¨è®¾è®¡\n1CREATE TABLE threadpool_config ( 2 id BIGINT PRIMARY KEY AUTO_INCREMENT, 3 name VARCHAR(100) NOT NULL UNIQUE COMMENT \u0026#39;çº¿ç¨‹æ± åç§°\u0026#39;, 4 core_pool_size INT NOT NULL COMMENT \u0026#39;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#39;, 5 maximum_pool_size INT NOT NULL COMMENT \u0026#39;æœ€å¤§çº¿ç¨‹æ•°\u0026#39;, 6 keep_alive_time BIGINT NOT NULL COMMENT \u0026#39;ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰\u0026#39;, 7 queue_capacity INT NOT NULL COMMENT \u0026#39;é˜Ÿåˆ—å®¹é‡\u0026#39;, 8 rejected_execution_handler VARCHAR(100) COMMENT \u0026#39;æ‹’ç»ç­–ç•¥\u0026#39;, 9 created_time DATETIME NOT NULL, 10 updated_time DATETIME NOT NULL, 11 INDEX idx_name (name) 12) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;çº¿ç¨‹æ± é…ç½®è¡¨\u0026#39;; é…ç½®åŠ è½½\n1@Component 2public class ThreadPoolConfigLoader implements ApplicationRunner { 3 4 @Autowired 5 private ThreadPoolConfigMapper configMapper; 6 7 @Autowired 8 private ThreadPoolRegistry registry; 9 10 @Override 11 public void run(ApplicationArguments args) { 12 // ä»æ•°æ®åº“åŠ è½½é…ç½® 13 List\u0026lt;ThreadPoolConfig\u0026gt; configs = configMapper.selectAll(); 14 15 for (ThreadPoolConfig config : configs) { 16 ThreadPoolExecutor executor = registry.get(config.getName()); 17 if (executor != null) { 18 // åº”ç”¨é…ç½® 19 executor.setCorePoolSize(config.getCorePoolSize()); 20 executor.setMaximumPoolSize(config.getMaximumPoolSize()); 21 22 log.info(\u0026#34;åŠ è½½çº¿ç¨‹æ± é…ç½®: {}\u0026#34;, config); 23 } 24 } 25 } 26} é…ç½®ä¿å­˜\n1@Service 2public class ThreadPoolConfigService { 3 4 @Autowired 5 private ThreadPoolConfigMapper configMapper; 6 7 @Transactional 8 public void saveConfig(String name, int corePoolSize, int maximumPoolSize) { 9 ThreadPoolConfig config = configMapper.selectByName(name); 10 11 if (config == null) { 12 config = new ThreadPoolConfig(); 13 config.setName(name); 14 config.setCreatedTime(LocalDateTime.now()); 15 } 16 17 config.setCorePoolSize(corePoolSize); 18 config.setMaximumPoolSize(maximumPoolSize); 19 config.setUpdatedTime(LocalDateTime.now()); 20 21 configMapper.insertOrUpdate(config); 22 } 23} é¿å‘æç¤ºï¼š åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°æ—¶ï¼Œè¦æ³¨æ„å‚æ•°çš„åˆæ³•æ€§æ ¡éªŒã€‚æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å¤§äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¦åˆ™ä¼šæŠ›å‡º IllegalArgumentExceptionã€‚è°ƒæ•´å‚æ•°åï¼Œå»ºè®®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œé¿å…é‡å¯åé…ç½®ä¸¢å¤±ã€‚\nå‚æ•°è°ƒä¼˜æœ€ä½³å®è·µ 1. æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®\nCPU å¯†é›†å‹ä»»åŠ¡ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° + 1 IO å¯†é›†å‹ä»»åŠ¡ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2 2. æœ€å¤§çº¿ç¨‹æ•°è®¾ç½®\næœ€å¤§çº¿ç¨‹æ•° = æ ¸å¿ƒçº¿ç¨‹æ•° * 1.5 ~ 2\n3. é˜Ÿåˆ—å®¹é‡è®¾ç½®\næœ‰ç•Œé˜Ÿåˆ—ï¼šå»ºè®® 100-1000ï¼Œé¿å…å†…å­˜æº¢å‡º æ— ç•Œé˜Ÿåˆ—ï¼šæ…ç”¨ï¼Œå¯èƒ½å¯¼è‡´ OOM 4. æ‹’ç»ç­–ç•¥é€‰æ‹©\nç­–ç•¥ è¯´æ˜ é€‚ç”¨åœºæ™¯ AbortPolicy æŠ›å‡ºå¼‚å¸¸ éœ€è¦æ„ŸçŸ¥ä»»åŠ¡è¢«æ‹’ç» CallerRunsPolicy è°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ ä»»åŠ¡ä¸èƒ½ä¸¢å¤± DiscardPolicy é™é»˜ä¸¢å¼ƒ ä»»åŠ¡å¯ä»¥ä¸¢å¤± DiscardOldestPolicy ä¸¢å¼ƒæœ€è€çš„ä»»åŠ¡ ä¼˜å…ˆæ‰§è¡Œæ–°ä»»åŠ¡ 5. ç›‘æ§å‘Šè­¦\né˜Ÿåˆ—ä½¿ç”¨ç‡ \u0026gt; 80%ï¼šå‘Šè­¦ çº¿ç¨‹æ± ä½¿ç”¨ç‡ \u0026gt; 90%ï¼šå‘Šè­¦ ä»»åŠ¡æ‹’ç»æ¬¡æ•° \u0026gt; 0ï¼šå‘Šè­¦ æ€»ç»“ä¸æ€è€ƒ çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ ThreadPoolRegistry ç»Ÿä¸€ç®¡ç†æ‰€æœ‰çº¿ç¨‹æ±  é€šè¿‡ BeanPostProcessor è‡ªåŠ¨æ³¨å†Œçº¿ç¨‹æ±  å®šæ—¶é‡‡é›†ç›‘æ§æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ æä¾› REST API å’Œç®¡ç†åå°ï¼Œæ–¹ä¾¿è¿ç»´äººå‘˜è°ƒæ•´å‚æ•° å°†é…ç½®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œé‡å¯åè‡ªåŠ¨åŠ è½½ çº¿ç¨‹æ± å‚æ•°çš„è°ƒä¼˜æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®å®é™…è´Ÿè½½ä¸æ–­è°ƒæ•´ã€‚é€šè¿‡ç›‘æ§æ•°æ®åˆ†æï¼Œæ‰¾åˆ°æœ€ä¼˜çš„å‚æ•°é…ç½®ã€‚\nä¸‹æ¬¡å½“ä½ çš„çº¿ç¨‹æ± å‡ºç°æ€§èƒ½é—®é¢˜æ—¶ï¼Œä¸å¦¨è¯•è¯•æœ¬æ–‡ä»‹ç»çš„åŠ¨æ€é…ç½®æ–¹æ¡ˆï¼Œè®©çº¿ç¨‹æ± å‚æ•°è°ƒæ•´å˜å¾—æ›´åŠ çµæ´»å’Œé«˜æ•ˆã€‚\n","permalink":"http://localhost:1313/posts/2025/01/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8F%82%E6%95%B0%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AEadmin-%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1/","summary":"\u003cp\u003eåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°çš„é…ç½®å¾€å¾€éœ€è¦æ ¹æ®å®é™…è´Ÿè½½åŠ¨æ€è°ƒæ•´ã€‚ç¡¬ç¼–ç çš„å‚æ•°é…ç½®ç¼ºä¹çµæ´»æ€§ï¼Œé‡å¯æœåŠ¡åˆä¼šå½±å“ä¸šåŠ¡ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•è®¾è®¡ä¸€ä¸ªçº¿ç¨‹æ± ç®¡ç†åå°ï¼Œå®ç°å‚æ•°çš„åŠ¨æ€é…ç½®å’Œå®æ—¶ç›‘æ§ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£çº¿ç¨‹æ± å‚æ•°åŠ¨æ€è°ƒæ•´çš„åŸç†ä¸å®ç°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡çº¿ç¨‹æ± ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†ä¸å±•ç¤º\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡ç”Ÿäº§çº§çš„çº¿ç¨‹æ± ç®¡ç†å¹³å°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®\"\u003eä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šæµé‡çªå¢\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåŒåä¸€æœŸé—´ï¼Œè®¢å•å¤„ç†çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º 10ï¼Œæœ€å¤§çº¿ç¨‹æ•° 20ã€‚çªç„¶æµé‡æš´å¢ï¼Œé˜Ÿåˆ—å †ç§¯ä¸¥é‡ï¼Œå¯¼è‡´è®¢å•å¤„ç†å»¶è¿Ÿã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœèƒ½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼Œå°†æ ¸å¿ƒçº¿ç¨‹æ•°è°ƒæ•´ä¸º 50ï¼Œæœ€å¤§çº¿ç¨‹æ•°è°ƒæ•´ä¸º 100ï¼Œå°±èƒ½å¿«é€Ÿåº”å¯¹æµé‡é«˜å³°ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šèµ„æºæµªè´¹\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå‡Œæ™¨æ—¶æ®µæµé‡å¾ˆä½ï¼Œä½†çº¿ç¨‹æ± ä»ç„¶ä¿æŒé«˜å³°æœŸçš„é…ç½®ï¼Œæµªè´¹äº†å¤§é‡ç³»ç»Ÿèµ„æºã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿåšæ³•çš„é—®é¢˜\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eThreadPoolConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;orderThreadPool\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eorderThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æœ€å¤§çº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e60\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLinkedBlockingQueue\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadFactoryBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003esetNameFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;order-pool-%d\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003ebuild\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eCallerRunsPolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e","title":"çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®ï¼šAdmin ç®¡ç†åå°è®¾è®¡"},{"content":"ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚æœ¬æ–‡é€šè¿‡çœŸå®çš„ç”Ÿäº§æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Œè®©ä½ æŒæ¡ SQL æ€§èƒ½è°ƒä¼˜çš„å®Œæ•´æ–¹æ³•è®ºã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„åˆ†ææ–¹æ³• å­¦ä¼šä½¿ç”¨ Explain å®šä½æ€§èƒ½ç“¶é¢ˆ äº†è§£å¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§ ç†è§£æ•°æ®åº“å±‚é¢çš„æ€§èƒ½ä¼˜åŒ– æ¡ˆä¾‹èƒŒæ™¯ æŸç”µå•†ç³»ç»Ÿçš„è®¢å•åˆ—è¡¨æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´è¾¾åˆ° 5 ç§’ï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚\nåŸå§‹ SQL\n1SELECT o.*, u.username, u.phone 2FROM `order` o 3LEFT JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; æ•°æ®é‡ï¼š\norder è¡¨ï¼š100 ä¸‡æ¡ user è¡¨ï¼š50 ä¸‡æ¡ ç¬¬ä¸€æ­¥ï¼šå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— é…ç½® MySQL\n1[mysqld] 2slow_query_log = 1 3slow_query_log_file = /var/log/mysql/slow.log 4long_query_time = 1 5log_queries_not_using_indexes = 1 åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—\n1# ä½¿ç”¨ mysqldumpslow åˆ†æ 2mysqldumpslow -s t -t 10 /var/log/mysql/slow.log è¾“å‡ºï¼š\n1Count: 1000 Time=5.23s (5230s) Lock=0.00s (0s) Rows=20.0 (20000) 2SELECT o.*, u.username, u.phone FROM order o LEFT JOIN user u ... ç¬¬äºŒæ­¥ï¼šExplain åˆ†ææ‰§è¡Œè®¡åˆ’ 1EXPLAIN SELECT o.*, u.username, u.phone 2FROM `order` o 3LEFT JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; æ‰§è¡Œè®¡åˆ’åˆ†æ\nid table type key rows Extra 1 o ALL NULL 1000000 Using where; Using filesort 1 u eq_ref PRIMARY 1 Using where é—®é¢˜ï¼š\norder è¡¨å…¨è¡¨æ‰«æï¼ˆtype = ALLï¼‰ æ‰«æäº† 100 ä¸‡è¡Œæ•°æ® éœ€è¦é¢å¤–çš„æ’åºæ“ä½œï¼ˆUsing filesortï¼‰ ç¬¬ä¸‰æ­¥ï¼šä¼˜åŒ–ç´¢å¼• åˆ†ææŸ¥è¯¢æ¡ä»¶\nWHEREï¼šstatusã€create_time JOINï¼šuser_id ORDER BYï¼šcreate_time åˆ›å»ºè”åˆç´¢å¼•\n1CREATE INDEX idx_status_time ON `order`(status, create_time); å†æ¬¡ Explain\nid table type key rows Extra 1 o range idx_status_time 50000 Using index condition 1 u eq_ref PRIMARY 1 Using where æ”¹è¿›ï¼š\ntype ä» ALL å˜æˆ range rows ä» 100 ä¸‡é™ä½åˆ° 5 ä¸‡ å»æ‰äº† Using filesort æ‰§è¡Œæ—¶é—´ï¼šä» 5 ç§’é™ä½åˆ° 800ms\nç¬¬å››æ­¥ï¼šä¼˜åŒ– JOIN é—®é¢˜åˆ†æ\nLEFT JOIN ä¼šå…ˆæŸ¥è¯¢ order è¡¨çš„æ‰€æœ‰æ•°æ®ï¼Œç„¶åå†å…³è” user è¡¨ã€‚ä½†å®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦ city = \u0026lsquo;Beijing\u0026rsquo; çš„ç”¨æˆ·ã€‚\nä¼˜åŒ–æ–¹æ¡ˆï¼šæ”¹ä¸º INNER JOIN\n1SELECT o.*, u.username, u.phone 2FROM `order` o 3INNER JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; ä¸º user è¡¨åˆ›å»ºç´¢å¼•\n1CREATE INDEX idx_city ON user(city); å†æ¬¡ Explain\nid table type key rows Extra 1 u ref idx_city 10000 Using where 1 o ref idx_user_status_time 100 Using where æ‰§è¡Œæ—¶é—´ï¼šä» 800ms é™ä½åˆ° 200ms\nç¬¬äº”æ­¥ï¼šé¿å… SELECT * é—®é¢˜\nSELECT * ä¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬ä¸éœ€è¦çš„å¤§å­—æ®µï¼ˆå¦‚è®¢å•è¯¦æƒ… JSONï¼‰ã€‚\nä¼˜åŒ–\n1SELECT o.id, o.order_no, o.amount, o.status, o.create_time, 2 u.username, u.phone 3FROM `order` o 4INNER JOIN user u ON o.user_id = u.id 5WHERE o.status IN (1, 2, 3) 6 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 7 AND u.city = \u0026#39;Beijing\u0026#39; 8ORDER BY o.create_time DESC 9LIMIT 20; æ‰§è¡Œæ—¶é—´ï¼šä» 200ms é™ä½åˆ° 120ms\nç¬¬å…­æ­¥ï¼šä½¿ç”¨è¦†ç›–ç´¢å¼• åˆ›å»ºè¦†ç›–ç´¢å¼•\n1CREATE INDEX idx_status_time_user ON `order`(status, create_time, user_id); ä¼˜åŒ–åçš„ Explain\nid table type key rows Extra 1 u ref idx_city 10000 Using index 1 o ref idx_status_time_user 100 Using index Extra å˜æˆäº† Using indexï¼Œè¯´æ˜ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ã€‚\næ‰§è¡Œæ—¶é—´ï¼šä» 120ms é™ä½åˆ° 50ms\nä¼˜åŒ–æ€»ç»“ ä¼˜åŒ–æ­¥éª¤ æ‰§è¡Œæ—¶é—´ ä¼˜åŒ–æ•ˆæœ åŸå§‹ SQL 5000ms - åˆ›å»ºç´¢å¼• 800ms æå‡ 6.25 å€ ä¼˜åŒ– JOIN 200ms æå‡ 4 å€ é¿å… SELECT * 120ms æå‡ 1.67 å€ ä½¿ç”¨è¦†ç›–ç´¢å¼• 50ms æå‡ 2.4 å€ æ€»ä½“æå‡ï¼š100 å€\nå¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§ 1. é¿å…åœ¨ WHERE ä¸­ä½¿ç”¨å‡½æ•°\n1-- ä¸å¥½ 2SELECT * FROM `order` WHERE DATE(create_time) = \u0026#39;2024-01-01\u0026#39;; 3 4-- å¥½ 5SELECT * FROM `order` WHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2024-01-02\u0026#39;; 2. ä½¿ç”¨ UNION ALL ä»£æ›¿ UNION\nUNION ä¼šå»é‡ï¼Œéœ€è¦é¢å¤–çš„æ’åºæ“ä½œã€‚å¦‚æœç¡®å®šæ²¡æœ‰é‡å¤æ•°æ®ï¼Œä½¿ç”¨ UNION ALLã€‚\n1-- ä¸å¥½ 2SELECT * FROM order WHERE status = 1 3UNION 4SELECT * FROM order WHERE status = 2; 5 6-- å¥½ 7SELECT * FROM order WHERE status = 1 8UNION ALL 9SELECT * FROM order WHERE status = 2; 3. ä½¿ç”¨ EXISTS ä»£æ›¿ IN\nå½“å­æŸ¥è¯¢ç»“æœé›†å¾ˆå¤§æ—¶ï¼ŒEXISTS æ€§èƒ½æ›´å¥½ã€‚\n1-- ä¸å¥½ 2SELECT * FROM user WHERE id IN (SELECT user_id FROM order); 3 4-- å¥½ 5SELECT * FROM user u WHERE EXISTS (SELECT 1 FROM order o WHERE o.user_id = u.id); 4. é¿å…ä½¿ç”¨å­æŸ¥è¯¢\nå­æŸ¥è¯¢ä¼šåˆ›å»ºä¸´æ—¶è¡¨ï¼Œæ€§èƒ½è¾ƒå·®ã€‚å¯ä»¥æ”¹ä¸º JOINã€‚\n1-- ä¸å¥½ 2SELECT * FROM user WHERE id IN (SELECT user_id FROM order WHERE status = 1); 3 4-- å¥½ 5SELECT DISTINCT u.* FROM user u 6INNER JOIN order o ON u.id = o.user_id 7WHERE o.status = 1; 5. åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é‡\n1-- ä¸å¥½ï¼šä¸€æ¬¡æ›´æ–° 100 ä¸‡æ¡æ•°æ® 2UPDATE order SET status = 2 WHERE status = 1; 3 4-- å¥½ï¼šåˆ†æ‰¹æ›´æ–° 5UPDATE order SET status = 2 WHERE status = 1 LIMIT 1000; 6. ä½¿ç”¨ LIMIT é™åˆ¶è¿”å›æ•°æ®é‡\n1-- ä¸å¥½ 2SELECT * FROM order WHERE status = 1; 3 4-- å¥½ 5SELECT * FROM order WHERE status = 1 LIMIT 100; æ•°æ®åº“å±‚é¢çš„ä¼˜åŒ– 1. è°ƒæ•´ InnoDB ç¼“å†²æ± å¤§å°\n1[mysqld] 2innodb_buffer_pool_size = 8G # è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 70-80% 2. å¼€å¯æŸ¥è¯¢ç¼“å­˜ï¼ˆMySQL 5.7 åŠä»¥ä¸‹ï¼‰\n1[mysqld] 2query_cache_type = 1 3query_cache_size = 256M æ³¨æ„ï¼šMySQL 8.0 å·²ç§»é™¤æŸ¥è¯¢ç¼“å­˜ã€‚\n3. è°ƒæ•´è¿æ¥æ•°\n1[mysqld] 2max_connections = 1000 4. å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\n1[mysqld] 2slow_query_log = 1 3long_query_time = 1 5. å®šæœŸåˆ†æè¡¨\n1ANALYZE TABLE order; æ›´æ–°è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¸®åŠ©ä¼˜åŒ–å™¨é€‰æ‹©æ›´å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚\nç›‘æ§ä¸é¢„è­¦ 1. ä½¿ç”¨ Prometheus + Grafana ç›‘æ§\nç›‘æ§æŒ‡æ ‡ï¼š\nQPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰ æ…¢æŸ¥è¯¢æ•°é‡ è¿æ¥æ•° ç¼“å†²æ± å‘½ä¸­ç‡ 2. è®¾ç½®æ…¢æŸ¥è¯¢å‘Šè­¦\nå½“æ…¢æŸ¥è¯¢æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œå‘é€å‘Šè­¦é€šçŸ¥ã€‚\n3. å®šæœŸå®¡æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—\næ¯å‘¨åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæ‰¾å‡ºéœ€è¦ä¼˜åŒ–çš„ SQLã€‚\næ€»ç»“ä¸æ€è€ƒ SQL æ€§èƒ½ä¼˜åŒ–çš„æ–¹æ³•è®ºï¼š\nå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå®šä½é—®é¢˜ SQL ä½¿ç”¨ Explain åˆ†ææ‰§è¡Œè®¡åˆ’ åˆ›å»ºåˆé€‚çš„ç´¢å¼• ä¼˜åŒ– SQL è¯­å¥ï¼ˆé¿å… SELECT *ã€ä¼˜åŒ– JOINï¼‰ æ•°æ®åº“å±‚é¢ä¼˜åŒ–ï¼ˆè°ƒæ•´å‚æ•°ã€ç›‘æ§ï¼‰ æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡å˜åŒ–ä¸æ–­è°ƒæ•´ã€‚\nè®°ä½ï¼šè¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚å…ˆä¿è¯åŠŸèƒ½æ­£ç¡®ï¼Œå†æ ¹æ®ç›‘æ§æ•°æ®ä¼˜åŒ–æ€§èƒ½ã€‚\nä¸‹æ¬¡å½“ä½ çš„ SQL æŸ¥è¯¢å¾ˆæ…¢æ—¶ï¼ŒæŒ‰ç…§è¿™ä¸ªæ–¹æ³•è®ºä¸€æ­¥æ­¥æ’æŸ¥ï¼Œä¸€å®šèƒ½æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚\n","permalink":"http://localhost:1313/posts/2024/12/mysql-%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/","summary":"\u003cp\u003eä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚æœ¬æ–‡é€šè¿‡çœŸå®çš„ç”Ÿäº§æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Œè®©ä½ æŒæ¡ SQL æ€§èƒ½è°ƒä¼˜çš„å®Œæ•´æ–¹æ³•è®ºã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ Explain å®šä½æ€§èƒ½ç“¶é¢ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£æ•°æ®åº“å±‚é¢çš„æ€§èƒ½ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¡ˆä¾‹èƒŒæ™¯\"\u003eæ¡ˆä¾‹èƒŒæ™¯\u003c/h2\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿçš„è®¢å•åˆ—è¡¨æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´è¾¾åˆ° 5 ç§’ï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåŸå§‹ SQL\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eusername\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ephone\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e`\u003c/span\u003e\u003cspan class=\"k\"\u003eorder\u003c/span\u003e\u003cspan class=\"o\"\u003e`\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eLEFT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eJOIN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eON\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003euser_id\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eWHERE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eIN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003eAND\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;2024-01-01\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003eAND\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecity\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Beijing\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eORDER\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eBY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eDESC\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eLIMIT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ•°æ®é‡ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eorder è¡¨ï¼š100 ä¸‡æ¡\u003c/li\u003e\n\u003cli\u003euser è¡¨ï¼š50 ä¸‡æ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\"\u003eç¬¬ä¸€æ­¥ï¼šå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eé…ç½® MySQL\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[mysqld]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eslow_query_log\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eslow_query_log_file\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/mysql/slow.log\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elong_query_time\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elog_queries_not_using_indexes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—\u003c/strong\u003e\u003c/p\u003e","title":"MySQL æ…¢æŸ¥è¯¢ä¼˜åŒ–å®æˆ˜æ¡ˆä¾‹"},{"content":"åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŸMySQL é€šè¿‡äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œ MVCC æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡æ·±å…¥å‰–æ MySQL çš„å¹¶å‘æ§åˆ¶åŸç†ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯ æŒæ¡ MVCC çš„ ReadView æœºåˆ¶ å­¦ä¼šè§£å†³å¹»è¯»é—®é¢˜çš„æ–¹æ³• äº†è§£é”æœºåˆ¶ä¸ MVCC çš„é…åˆ äº‹åŠ¡çš„å¹¶å‘é—®é¢˜ è„è¯»ï¼ˆDirty Readï¼‰\näº‹åŠ¡ A è¯»å–äº†äº‹åŠ¡ B æœªæäº¤çš„æ•°æ®ï¼Œäº‹åŠ¡ B å›æ»šåï¼Œäº‹åŠ¡ A è¯»åˆ°çš„æ•°æ®æ˜¯æ— æ•ˆçš„ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ 3T2: äº‹åŠ¡ B å¼€å§‹ï¼Œå°† balance ä» 100 æ”¹ä¸º 200 4T3: äº‹åŠ¡ A è¯»å– balance = 200ï¼ˆè„è¯»ï¼‰ 5T4: äº‹åŠ¡ B å›æ»šï¼Œbalance æ¢å¤ä¸º 100 6T5: äº‹åŠ¡ A æäº¤ ä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readï¼‰\näº‹åŠ¡ A ä¸¤æ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸ä¸€è‡´ï¼ˆå› ä¸ºäº‹åŠ¡ B ä¿®æ”¹å¹¶æäº¤äº†æ•°æ®ï¼‰ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A è¯»å– balance = 100 3T2: äº‹åŠ¡ B å°† balance æ”¹ä¸º 200 å¹¶æäº¤ 4T3: äº‹åŠ¡ A å†æ¬¡è¯»å– balance = 200ï¼ˆä¸å¯é‡å¤è¯»ï¼‰ å¹»è¯»ï¼ˆPhantom Readï¼‰\näº‹åŠ¡ A ä¸¤æ¬¡æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢å¤šå‡ºäº†æ–°çš„è¡Œï¼ˆå› ä¸ºäº‹åŠ¡ B æ’å…¥äº†æ–°æ•°æ®ï¼‰ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A æŸ¥è¯¢ age \u0026gt; 20 çš„ç”¨æˆ·ï¼Œç»“æœ 2 æ¡ 3T2: äº‹åŠ¡ B æ’å…¥ä¸€æ¡ age = 25 çš„ç”¨æˆ·å¹¶æäº¤ 4T3: äº‹åŠ¡ A å†æ¬¡æŸ¥è¯¢ age \u0026gt; 20 çš„ç”¨æˆ·ï¼Œç»“æœ 3 æ¡ï¼ˆå¹»è¯»ï¼‰ å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ« éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» READ UNCOMMITTED å¯èƒ½ å¯èƒ½ å¯èƒ½ READ COMMITTED ä¸å¯èƒ½ å¯èƒ½ å¯èƒ½ REPEATABLE READï¼ˆé»˜è®¤ï¼‰ ä¸å¯èƒ½ ä¸å¯èƒ½ å¯èƒ½ SERIALIZABLE ä¸å¯èƒ½ ä¸å¯èƒ½ ä¸å¯èƒ½ æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«\n1SELECT @@transaction_isolation; è®¾ç½®éš”ç¦»çº§åˆ«\n1-- ä¼šè¯çº§åˆ« 2SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; 3 4-- å…¨å±€çº§åˆ« 5SET GLOBAL TRANSACTION ISOLATION LEVEL REPEATABLE READ; READ UNCOMMITTEDï¼šè¯»æœªæäº¤ ç‰¹ç‚¹ï¼š äº‹åŠ¡å¯ä»¥è¯»å–å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚\né—®é¢˜ï¼š ä¼šå‡ºç°è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€‚\né€‚ç”¨åœºæ™¯ï¼š å‡ ä¹ä¸ä½¿ç”¨ï¼Œæ•°æ®ä¸€è‡´æ€§æ— æ³•ä¿è¯ã€‚\næ¼”ç¤ºè„è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9 10-- äº‹åŠ¡ A 11SELECT balance FROM account WHERE id = 1; -- 200ï¼ˆè„è¯»ï¼‰ 12 13-- äº‹åŠ¡ B 14ROLLBACK; 15 16-- äº‹åŠ¡ A 17SELECT balance FROM account WHERE id = 1; -- 100 18COMMIT; READ COMMITTEDï¼šè¯»å·²æäº¤ ç‰¹ç‚¹ï¼š äº‹åŠ¡åªèƒ½è¯»å–å…¶ä»–äº‹åŠ¡å·²æäº¤çš„æ•°æ®ã€‚\né—®é¢˜ï¼š ä¼šå‡ºç°ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€‚\né€‚ç”¨åœºæ™¯ï¼š Oracleã€PostgreSQL çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚\næ¼”ç¤ºä¸å¯é‡å¤è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9COMMIT; 10 11-- äº‹åŠ¡ A 12SELECT balance FROM account WHERE id = 1; -- 200ï¼ˆä¸å¯é‡å¤è¯»ï¼‰ 13COMMIT; REPEATABLE READï¼šå¯é‡å¤è¯» ç‰¹ç‚¹ï¼š äº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸€è‡´ã€‚\né—®é¢˜ï¼š ç†è®ºä¸Šä¼šå‡ºç°å¹»è¯»ï¼Œä½† MySQL é€šè¿‡ MVCC + Next-Key Lock è§£å†³äº†å¤§éƒ¨åˆ†å¹»è¯»é—®é¢˜ã€‚\né€‚ç”¨åœºæ™¯ï¼š MySQL çš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ã€‚\næ¼”ç¤ºå¯é‡å¤è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9COMMIT; 10 11-- äº‹åŠ¡ A 12SELECT balance FROM account WHERE id = 1; -- 100ï¼ˆå¯é‡å¤è¯»ï¼‰ 13COMMIT; SERIALIZABLEï¼šä¸²è¡ŒåŒ– ç‰¹ç‚¹ï¼š äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œå®Œå…¨é¿å…å¹¶å‘é—®é¢˜ã€‚\né—®é¢˜ï¼š æ€§èƒ½æœ€å·®ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚\né€‚ç”¨åœºæ™¯ï¼š å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼ˆå¦‚é‡‘èç³»ç»Ÿï¼‰ã€‚\nå®ç°æ–¹å¼ï¼š å¯¹è¯»å–çš„æ¯ä¸€è¡Œæ•°æ®éƒ½åŠ é”ã€‚\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE; 3START TRANSACTION; 4SELECT * FROM account WHERE id = 1; -- åŠ å…±äº«é” 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; -- ç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é” MVCCï¼šå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ æ ¸å¿ƒæ€æƒ³ï¼š ä¸ºæ¯ä¸ªäº‹åŠ¡æä¾›æ•°æ®çš„å¿«ç…§ï¼Œä¸åŒäº‹åŠ¡çœ‹åˆ°ä¸åŒç‰ˆæœ¬çš„æ•°æ®ã€‚\nä¼˜åŠ¿ï¼š\nè¯»ä¸åŠ é”ï¼Œå†™ä¸é˜»å¡è¯» æå‡å¹¶å‘æ€§èƒ½ å®ç°æœºåˆ¶ï¼š\néšè—å­—æ®µï¼šDB_TRX_IDã€DB_ROLL_PTRã€DB_ROW_ID Undo Logï¼šè®°å½•æ•°æ®çš„å†å²ç‰ˆæœ¬ ReadViewï¼šåˆ¤æ–­æ•°æ®ç‰ˆæœ¬çš„å¯è§æ€§ éšè—å­—æ®µ InnoDB ä¸ºæ¯ä¸€è¡Œæ•°æ®æ·»åŠ äº†ä¸‰ä¸ªéšè—å­—æ®µï¼š\nå­—æ®µ è¯´æ˜ DB_TRX_ID æœ€åä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡ ID DB_ROLL_PTR æŒ‡å‘ Undo Log çš„æŒ‡é’ˆ DB_ROW_ID è¡Œ IDï¼ˆå¦‚æœæ²¡æœ‰ä¸»é”®ï¼‰ ç¤ºä¾‹\n1åŸå§‹æ•°æ®ï¼š 2id | name | age | DB_TRX_ID | DB_ROLL_PTR 31 | Alice | 20 | 100 | NULL 4 5äº‹åŠ¡ 101 ä¿®æ”¹ï¼š 6id | name | age | DB_TRX_ID | DB_ROLL_PTR 71 | Alice | 25 | 101 | â†’ Undo Log (age=20, TRX_ID=100) 8 9äº‹åŠ¡ 102 ä¿®æ”¹ï¼š 10id | name | age | DB_TRX_ID | DB_ROLL_PTR 111 | Alice | 30 | 102 | â†’ Undo Log (age=25, TRX_ID=101) é€šè¿‡ Undo Logï¼Œå¯ä»¥æ„å»ºç‰ˆæœ¬é“¾ï¼Œå›æº¯åˆ°ä»»æ„å†å²ç‰ˆæœ¬ã€‚\nReadViewï¼šå¯è§æ€§åˆ¤æ–­ ReadView æ˜¯äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºçš„å¿«ç…§ï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š\nå­—æ®µ è¯´æ˜ m_ids å½“å‰æ´»è·ƒçš„äº‹åŠ¡ ID åˆ—è¡¨ min_trx_id æœ€å°çš„æ´»è·ƒäº‹åŠ¡ ID max_trx_id ä¸‹ä¸€ä¸ªè¦åˆ†é…çš„äº‹åŠ¡ ID creator_trx_id åˆ›å»º ReadView çš„äº‹åŠ¡ ID å¯è§æ€§è§„åˆ™\nå¯¹äºæ•°æ®è¡Œçš„ DB_TRX_IDï¼š\nå¦‚æœ DB_TRX_ID \u0026lt; min_trx_idï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬åœ¨ ReadView åˆ›å»ºå‰å·²æäº¤ï¼Œå¯è§ å¦‚æœ DB_TRX_ID \u0026gt;= max_trx_idï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬åœ¨ ReadView åˆ›å»ºåæ‰å¼€å§‹ï¼Œä¸å¯è§ å¦‚æœ min_trx_id \u0026lt;= DB_TRX_ID \u0026lt; max_trx_idï¼š å¦‚æœ DB_TRX_ID åœ¨ m_ids ä¸­ï¼Œè¯´æ˜è¯¥äº‹åŠ¡è¿˜æœªæäº¤ï¼Œä¸å¯è§ å¦‚æœ DB_TRX_ID ä¸åœ¨ m_ids ä¸­ï¼Œè¯´æ˜è¯¥äº‹åŠ¡å·²æäº¤ï¼Œå¯è§ å¦‚æœ DB_TRX_ID == creator_trx_idï¼Œè¯´æ˜æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ä¿®æ”¹çš„ï¼Œå¯è§ å¦‚æœå½“å‰ç‰ˆæœ¬ä¸å¯è§ï¼Œé€šè¿‡ DB_ROLL_PTR æ‰¾åˆ° Undo Log ä¸­çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œç»§ç»­åˆ¤æ–­ã€‚\nREAD COMMITTED ä¸ REPEATABLE READ çš„åŒºåˆ« READ COMMITTED\næ¯æ¬¡ SELECT éƒ½åˆ›å»ºæ–°çš„ ReadViewã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ï¼ˆTRX_ID=100ï¼‰ 3T2: äº‹åŠ¡ A ç¬¬ä¸€æ¬¡ SELECTï¼Œåˆ›å»º ReadView1ï¼ˆm_ids=[100]ï¼‰ 4T3: äº‹åŠ¡ Bï¼ˆTRX_ID=101ï¼‰ä¿®æ”¹æ•°æ®å¹¶æäº¤ 5T4: äº‹åŠ¡ A ç¬¬äºŒæ¬¡ SELECTï¼Œåˆ›å»º ReadView2ï¼ˆm_ids=[100]ï¼‰ 6 æ­¤æ—¶äº‹åŠ¡ 101 å·²æäº¤ï¼Œä¸åœ¨ m_ids ä¸­ï¼Œå¯è§ ç»“æœï¼šä¸¤æ¬¡ SELECT ç»“æœä¸åŒï¼ˆä¸å¯é‡å¤è¯»ï¼‰ã€‚\nREPEATABLE READ\näº‹åŠ¡å¼€å§‹æ—¶åˆ›å»º ReadViewï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´å¤ç”¨ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ï¼ˆTRX_ID=100ï¼‰ï¼Œåˆ›å»º ReadViewï¼ˆm_ids=[100]ï¼‰ 3T2: äº‹åŠ¡ A ç¬¬ä¸€æ¬¡ SELECT 4T3: äº‹åŠ¡ Bï¼ˆTRX_ID=101ï¼‰ä¿®æ”¹æ•°æ®å¹¶æäº¤ 5T4: äº‹åŠ¡ A ç¬¬äºŒæ¬¡ SELECTï¼Œå¤ç”¨ ReadViewï¼ˆm_ids=[100]ï¼‰ 6 äº‹åŠ¡ 101 åœ¨ ReadView åˆ›å»ºåæ‰æäº¤ï¼Œä¸å¯è§ ç»“æœï¼šä¸¤æ¬¡ SELECT ç»“æœç›¸åŒï¼ˆå¯é‡å¤è¯»ï¼‰ã€‚\næ¶æ„æ€è€ƒï¼š MVCC çš„è®¾è®¡ä½“ç°äº†\u0026quot;ç©ºé—´æ¢æ—¶é—´\u0026quot;çš„æ€æƒ³ã€‚é€šè¿‡ Undo Log ä¿å­˜å†å²ç‰ˆæœ¬ï¼Œç‰ºç‰²äº†å­˜å‚¨ç©ºé—´ï¼Œæ¢å–äº†è¯»å†™å¹¶å‘çš„æ€§èƒ½æå‡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ Git çš„ç‰ˆæœ¬æ§åˆ¶ã€Redis çš„ RDB å¿«ç…§ã€‚\nå¹»è¯»é—®é¢˜ ä»€ä¹ˆæ˜¯å¹»è¯»ï¼Ÿ\näº‹åŠ¡ A ä¸¤æ¬¡æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢å¤šå‡ºäº†æ–°çš„è¡Œã€‚\nMVCC èƒ½è§£å†³å¹»è¯»å—ï¼Ÿ\néƒ¨åˆ†è§£å†³ã€‚å¯¹äºå¿«ç…§è¯»ï¼ˆæ™®é€š SELECTï¼‰ï¼ŒMVCC å¯ä»¥è§£å†³å¹»è¯»ã€‚ä½†å¯¹äºå½“å‰è¯»ï¼ˆSELECT FOR UPDATEã€UPDATEã€DELETEï¼‰ï¼ŒMVCC æ— æ³•è§£å†³å¹»è¯»ã€‚\næ¼”ç¤ºå¹»è¯»\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3SELECT * FROM user WHERE age \u0026gt; 20; -- 2 æ¡è®°å½• 4 5-- äº‹åŠ¡ B 6START TRANSACTION; 7INSERT INTO user (name, age) VALUES (\u0026#39;Charlie\u0026#39;, 25); 8COMMIT; 9 10-- äº‹åŠ¡ A 11SELECT * FROM user WHERE age \u0026gt; 20; -- ä»ç„¶ 2 æ¡ï¼ˆMVCC è§£å†³äº†å¿«ç…§è¯»çš„å¹»è¯»ï¼‰ 12 13-- ä½†æ˜¯ 14SELECT * FROM user WHERE age \u0026gt; 20 FOR UPDATE; -- 3 æ¡ï¼ˆå½“å‰è¯»å‡ºç°å¹»è¯»ï¼‰ è§£å†³æ–¹æ¡ˆï¼šNext-Key Lock\nNext-Key Lock = Record Lockï¼ˆè¡Œé”ï¼‰ + Gap Lockï¼ˆé—´éš™é”ï¼‰\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3SELECT * FROM user WHERE age \u0026gt; 20 FOR UPDATE; -- é”å®š age \u0026gt; 20 çš„æ‰€æœ‰è¡Œå’Œé—´éš™ 4 5-- äº‹åŠ¡ B 6INSERT INTO user (name, age) VALUES (\u0026#39;Charlie\u0026#39;, 25); -- ç­‰å¾…ï¼ˆè¢«é—´éš™é”é˜»å¡ï¼‰ é—´éš™é”é”å®šçš„æ˜¯ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥æ•°æ®ã€‚\né”æœºåˆ¶ å…±äº«é”ï¼ˆS Lockï¼‰\nè¯»é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ã€‚\n1SELECT * FROM user WHERE id = 1 LOCK IN SHARE MODE; æ’ä»–é”ï¼ˆX Lockï¼‰\nå†™é”ï¼Œåªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥æŒæœ‰ã€‚\n1SELECT * FROM user WHERE id = 1 FOR UPDATE; 2UPDATE user SET age = 25 WHERE id = 1; 3DELETE FROM user WHERE id = 1; è¡Œé”ï¼ˆRecord Lockï¼‰\né”å®šå•ä¸ªç´¢å¼•è®°å½•ã€‚\né—´éš™é”ï¼ˆGap Lockï¼‰\né”å®šç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ï¼Œé˜²æ­¢æ’å…¥ã€‚\nNext-Key Lock\nè¡Œé” + é—´éš™é”ï¼Œé”å®šç´¢å¼•è®°å½•åŠå…¶å‰é¢çš„é—´éš™ã€‚\né”çš„å…¼å®¹æ€§\nS Lock X Lock S Lock å…¼å®¹ å†²çª X Lock å†²çª å†²çª æ­»é” åœºæ™¯\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3UPDATE user SET age = 25 WHERE id = 1; -- é”å®š id=1 4 5-- äº‹åŠ¡ B 6START TRANSACTION; 7UPDATE user SET age = 30 WHERE id = 2; -- é”å®š id=2 8 9-- äº‹åŠ¡ A 10UPDATE user SET age = 26 WHERE id = 2; -- ç­‰å¾…äº‹åŠ¡ B é‡Šæ”¾é” 11 12-- äº‹åŠ¡ B 13UPDATE user SET age = 31 WHERE id = 1; -- ç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é”ï¼ˆæ­»é”ï¼‰ æ£€æµ‹ä¸è§£å†³\nMySQL ä¼šè‡ªåŠ¨æ£€æµ‹æ­»é”ï¼Œå¹¶å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡ã€‚\né¿å…æ­»é”\næŒ‰ç›¸åŒé¡ºåºè®¿é—®èµ„æº ç¼©çŸ­äº‹åŠ¡æ—¶é—´ é™ä½éš”ç¦»çº§åˆ« ä½¿ç”¨ä¹è§‚é” å®æˆ˜æ¡ˆä¾‹ï¼šç§’æ€ç³»ç»Ÿçš„åº“å­˜æ‰£å‡ æ–¹æ¡ˆä¸€ï¼šæ‚²è§‚é”\n1START TRANSACTION; 2SELECT stock FROM product WHERE id = 1 FOR UPDATE; -- åŠ æ’ä»–é” 3UPDATE product SET stock = stock - 1 WHERE id = 1; 4COMMIT; ä¼˜ç‚¹ï¼šæ•°æ®ä¸€è‡´æ€§å¼º ç¼ºç‚¹ï¼šå¹¶å‘æ€§èƒ½å·®\næ–¹æ¡ˆäºŒï¼šä¹è§‚é”\n1-- æŸ¥è¯¢åº“å­˜å’Œç‰ˆæœ¬å· 2SELECT stock, version FROM product WHERE id = 1; 3 4-- æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å· 5UPDATE product SET stock = stock - 1, version = version + 1 6WHERE id = 1 AND version = #{oldVersion}; ä¼˜ç‚¹ï¼šå¹¶å‘æ€§èƒ½å¥½ ç¼ºç‚¹ï¼šé«˜å¹¶å‘ä¸‹æ›´æ–°å¤±è´¥ç‡é«˜\næ–¹æ¡ˆä¸‰ï¼šRedis + æ•°æ®åº“\n1// 1. Redis é¢„æ‰£å‡ 2Long stock = redisTemplate.opsForValue().decrement(\u0026#34;stock:1\u0026#34;); 3if (stock \u0026lt; 0) { 4 redisTemplate.opsForValue().increment(\u0026#34;stock:1\u0026#34;); 5 return \u0026#34;åº“å­˜ä¸è¶³\u0026#34;; 6} 7 8// 2. å¼‚æ­¥æ›´æ–°æ•°æ®åº“ 9rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, orderId); ä¼˜ç‚¹ï¼šæ€§èƒ½æœ€å¥½ ç¼ºç‚¹ï¼šå®ç°å¤æ‚ï¼Œéœ€è¦ä¿è¯æœ€ç»ˆä¸€è‡´æ€§\næ€»ç»“ä¸æ€è€ƒ MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ MVCC çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nå››ç§éš”ç¦»çº§åˆ«è§£å†³ä¸åŒçš„å¹¶å‘é—®é¢˜ MVCC é€šè¿‡ ReadView å’Œ Undo Log å®ç°å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ READ COMMITTED æ¯æ¬¡ SELECT åˆ›å»ºæ–° ReadView REPEATABLE READ äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»º ReadView å¹¶å¤ç”¨ Next-Key Lock è§£å†³å½“å‰è¯»çš„å¹»è¯»é—®é¢˜ ç†è§£è¿™äº›æœºåˆ¶ï¼Œæ‰èƒ½åœ¨å®é™…å¼€å‘ä¸­é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«å’Œé”ç­–ç•¥ã€‚\nä¸‹æ¬¡å½“ä½ é‡åˆ°å¹¶å‘é—®é¢˜æ—¶ï¼Œä¸å¦¨æƒ³æƒ³ï¼šè¿™æ˜¯è„è¯»ã€ä¸å¯é‡å¤è¯»è¿˜æ˜¯å¹»è¯»ï¼Ÿåº”è¯¥ç”¨ä»€ä¹ˆéš”ç¦»çº§åˆ«å’Œé”æœºåˆ¶ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/11/mysql-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8E-mvcc-%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŸMySQL é€šè¿‡äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œ MVCC æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡æ·±å…¥å‰–æ MySQL çš„å¹¶å‘æ§åˆ¶åŸç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ MVCC çš„ ReadView æœºåˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§£å†³å¹»è¯»é—®é¢˜çš„æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£é”æœºåˆ¶ä¸ MVCC çš„é…åˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"äº‹åŠ¡çš„å¹¶å‘é—®é¢˜\"\u003eäº‹åŠ¡çš„å¹¶å‘é—®é¢˜\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eè„è¯»ï¼ˆDirty Readï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eäº‹åŠ¡ A è¯»å–äº†äº‹åŠ¡ B æœªæäº¤çš„æ•°æ®ï¼Œäº‹åŠ¡ B å›æ»šåï¼Œäº‹åŠ¡ A è¯»åˆ°çš„æ•°æ®æ˜¯æ— æ•ˆçš„ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eæ—¶é—´çº¿ï¼š\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eT1: äº‹åŠ¡ A å¼€å§‹\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003eT2: äº‹åŠ¡ B å¼€å§‹ï¼Œå°† balance ä» 100 æ”¹ä¸º 200\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003eT3: äº‹åŠ¡ A è¯»å– balance = 200ï¼ˆè„è¯»ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003eT4: äº‹åŠ¡ B å›æ»šï¼Œbalance æ¢å¤ä¸º 100\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003eT5: äº‹åŠ¡ A æäº¤\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eäº‹åŠ¡ A ä¸¤æ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸ä¸€è‡´ï¼ˆå› ä¸ºäº‹åŠ¡ B ä¿®æ”¹å¹¶æäº¤äº†æ•°æ®ï¼‰ã€‚\u003c/p\u003e","title":"MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ MVCC æœºåˆ¶æ·±åº¦è§£æ"},{"content":"SQL æ€§èƒ½ä¼˜åŒ–æ˜¯åç«¯å¼€å‘çš„å¿…å¤‡æŠ€èƒ½ã€‚ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿï¼Œè€Œåˆç†çš„ç´¢å¼•è®¾è®¡èƒ½è®©æŸ¥è¯¢é€Ÿåº¦æå‡ç™¾å€ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ–¹æ³•è®ºã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ B+ æ ‘ç´¢å¼•çš„åº•å±‚åŸç† æŒæ¡ Explain æ‰§è¡Œè®¡åˆ’çš„åˆ†ææ–¹æ³• å­¦ä¼šè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é…è§„åˆ™ äº†è§£è¦†ç›–ç´¢å¼•ä¸ç´¢å¼•ä¸‹æ¨ä¼˜åŒ– B+ æ ‘ç´¢å¼•åŸç† ä¸ºä»€ä¹ˆé€‰æ‹© B+ æ ‘ï¼Ÿ\nå¸¸è§çš„æ•°æ®ç»“æ„å¯¹æ¯”ï¼š\næ•°æ®ç»“æ„ æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ é—®é¢˜ æ•°ç»„ O(n) æŸ¥è¯¢æ…¢ äºŒå‰æœç´¢æ ‘ O(log n) å¯èƒ½é€€åŒ–ä¸ºé“¾è¡¨ å¹³è¡¡äºŒå‰æ ‘ O(log n) æ ‘é«˜å¤ªé«˜ï¼ŒIO æ¬¡æ•°å¤š B æ ‘ O(log n) éå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œæµªè´¹ç©ºé—´ B+ æ ‘ O(log n) å¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜ç´¢å¼• B+ æ ‘çš„ç‰¹ç‚¹\næ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ å¶å­èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢ éå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šçš„é”®å€¼ æ ‘çš„é«˜åº¦ä½ï¼ŒIO æ¬¡æ•°å°‘ InnoDB çš„èšç°‡ç´¢å¼•\nInnoDB çš„ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨å®Œæ•´çš„è¡Œæ•°æ®ã€‚\n1ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰ 2 10 3 / \\ 4 5 15 5 / \\ / \\ 6 1 7 12 18 7 | | | | 8 [å®Œæ•´è¡Œæ•°æ®] äºŒçº§ç´¢å¼•ï¼ˆéä¸»é”®ç´¢å¼•ï¼‰çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼Œéœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\n1äºŒçº§ç´¢å¼•ï¼ˆname ç´¢å¼•ï¼‰ 2 \u0026#34;Bob\u0026#34; 3 / \\ 4 \u0026#34;Alice\u0026#34; \u0026#34;Charlie\u0026#34; 5 | | 6 [ä¸»é”®1] [ä¸»é”®3] 7 â†“ â†“ 8 å›è¡¨æŸ¥è¯¢å®Œæ•´æ•°æ® æ¶æ„æ€è€ƒï¼š èšç°‡ç´¢å¼•çš„è®¾è®¡ä½“ç°äº†\u0026quot;å±€éƒ¨æ€§åŸç†\u0026quot;ã€‚ç›¸é‚»çš„ä¸»é”®å€¼å­˜å‚¨åœ¨ç›¸é‚»çš„ç£ç›˜ä½ç½®ï¼ŒèŒƒå›´æŸ¥è¯¢æ—¶å¯ä»¥é¡ºåºè¯»å–ï¼Œå‡å°‘éšæœº IOã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨è‡ªå¢ä¸»é”®çš„åŸå› ã€‚\nExplain æ‰§è¡Œè®¡åˆ’åˆ†æ åŸºæœ¬ç”¨æ³•\n1EXPLAIN SELECT * FROM user WHERE age = 25; å…³é”®å­—æ®µè§£æ\n1. typeï¼ˆè®¿é—®ç±»å‹ï¼‰\næ€§èƒ½ä»å¥½åˆ°åï¼š\nsystemï¼šè¡¨åªæœ‰ä¸€è¡Œæ•°æ®ï¼ˆç³»ç»Ÿè¡¨ï¼‰ constï¼šé€šè¿‡ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æŸ¥è¯¢ï¼Œæœ€å¤šè¿”å›ä¸€è¡Œ eq_refï¼šå”¯ä¸€ç´¢å¼•æ‰«æï¼Œå¯¹äºæ¯ä¸ªç´¢å¼•é”®ï¼Œè¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•åŒ¹é… refï¼šéå”¯ä¸€ç´¢å¼•æ‰«æï¼Œè¿”å›åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„æ‰€æœ‰è¡Œ rangeï¼šç´¢å¼•èŒƒå›´æ‰«æï¼ˆBETWEENã€\u0026gt;ã€\u0026lt;ï¼‰ indexï¼šå…¨ç´¢å¼•æ‰«æ ALLï¼šå…¨è¡¨æ‰«æï¼ˆæœ€å·®ï¼‰ 1-- const 2EXPLAIN SELECT * FROM user WHERE id = 1; 3 4-- ref 5EXPLAIN SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6 7-- range 8EXPLAIN SELECT * FROM user WHERE age BETWEEN 20 AND 30; 9 10-- ALL 11EXPLAIN SELECT * FROM user WHERE email LIKE \u0026#39;%@gmail.com\u0026#39;; 2. keyï¼ˆå®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼‰\nå¦‚æœä¸º NULLï¼Œè¯´æ˜æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚\n3. rowsï¼ˆæ‰«æçš„è¡Œæ•°ï¼‰\né¢„ä¼°éœ€è¦æ‰«æçš„è¡Œæ•°ï¼Œè¶Šå°‘è¶Šå¥½ã€‚\n4. Extraï¼ˆé¢å¤–ä¿¡æ¯ï¼‰\nUsing indexï¼šä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ Using whereï¼šä½¿ç”¨äº† WHERE è¿‡æ»¤ Using filesortï¼šéœ€è¦é¢å¤–çš„æ’åºæ“ä½œï¼ˆæ€§èƒ½å·®ï¼‰ Using temporaryï¼šéœ€è¦åˆ›å»ºä¸´æ—¶è¡¨ï¼ˆæ€§èƒ½å·®ï¼‰ ç´¢å¼•å¤±æ•ˆçš„ 10 ç§åœºæ™¯ 1. ä½¿ç”¨å‡½æ•°æˆ–è¡¨è¾¾å¼\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE YEAR(create_time) = 2024; 3 4-- ä¼˜åŒ– 5SELECT * FROM user WHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2025-01-01\u0026#39;; 2. éšå¼ç±»å‹è½¬æ¢\n1-- phone æ˜¯ VARCHAR ç±»å‹ï¼Œç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE phone = 13800138000; 3 4-- ä¼˜åŒ– 5SELECT * FROM user WHERE phone = \u0026#39;13800138000\u0026#39;; 3. ä½¿ç”¨ OR è¿æ¥\n1-- å¦‚æœ age æ²¡æœ‰ç´¢å¼•ï¼Œæ•´ä¸ªæŸ¥è¯¢ä¸èµ°ç´¢å¼• 2SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; OR age = 25; 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨ UNION 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; 6UNION 7SELECT * FROM user WHERE age = 25; 4. LIKE ä»¥ % å¼€å¤´\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE name LIKE \u0026#39;%Alice\u0026#39;; 3 4-- ä¼˜åŒ–ï¼š% æ”¾åœ¨åé¢ 5SELECT * FROM user WHERE name LIKE \u0026#39;Alice%\u0026#39;; 5. ä¸ç­‰äºï¼ˆ!= æˆ– \u0026lt;\u0026gt;ï¼‰\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE age != 25; 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨èŒƒå›´æŸ¥è¯¢ 5SELECT * FROM user WHERE age \u0026lt; 25 OR age \u0026gt; 25; 6. IS NULL æˆ– IS NOT NULL\n1-- å¯èƒ½ç´¢å¼•å¤±æ•ˆï¼ˆå–å†³äº NULL å€¼çš„æ¯”ä¾‹ï¼‰ 2SELECT * FROM user WHERE age IS NULL; 3 4-- ä¼˜åŒ–ï¼šé¿å…å­—æ®µä¸º NULLï¼Œä½¿ç”¨é»˜è®¤å€¼ 7. NOT IN å’Œ NOT EXISTS\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE id NOT IN (1, 2, 3); 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨ LEFT JOIN 5SELECT u.* FROM user u 6LEFT JOIN (SELECT 1 AS id UNION SELECT 2 UNION SELECT 3) t ON u.id = t.id 7WHERE t.id IS NULL; 8. è”åˆç´¢å¼•ä¸æ»¡è¶³æœ€å·¦å‰ç¼€\n1-- è”åˆç´¢å¼• (name, age, city) 2 3-- èµ°ç´¢å¼• 4SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25; 6 7-- ä¸èµ°ç´¢å¼• 8SELECT * FROM user WHERE age = 25; 9SELECT * FROM user WHERE city = \u0026#39;Beijing\u0026#39;; 9. èŒƒå›´æŸ¥è¯¢åçš„å­—æ®µä¸èµ°ç´¢å¼•\n1-- è”åˆç´¢å¼• (name, age, city) 2 3-- age èµ°ç´¢å¼•ï¼Œcity ä¸èµ°ç´¢å¼• 4SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age \u0026gt; 20 AND city = \u0026#39;Beijing\u0026#39;; 10. æ•°æ®é‡å¤ªå°\nå¦‚æœè¡¨çš„æ•°æ®é‡å¾ˆå°ï¼ˆå‡ ç™¾è¡Œï¼‰ï¼ŒMySQL å¯èƒ½é€‰æ‹©å…¨è¡¨æ‰«æè€Œä¸æ˜¯ç´¢å¼•ã€‚\nè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é… è§„åˆ™\nè”åˆç´¢å¼• (a, b, c) ç›¸å½“äºåˆ›å»ºäº†ä¸‰ä¸ªç´¢å¼•ï¼š\n(a) (a, b) (a, b, c) æ¡ˆä¾‹åˆ†æ\n1-- åˆ›å»ºè”åˆç´¢å¼• 2CREATE INDEX idx_name_age_city ON user(name, age, city); 3 4-- èµ°ç´¢å¼• 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25; 7SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25 AND city = \u0026#39;Beijing\u0026#39;; 8SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND city = \u0026#39;Beijing\u0026#39;; -- name èµ°ç´¢å¼•ï¼Œcity ä¸èµ° 9 10-- ä¸èµ°ç´¢å¼• 11SELECT * FROM user WHERE age = 25; 12SELECT * FROM user WHERE city = \u0026#39;Beijing\u0026#39;; 13SELECT * FROM user WHERE age = 25 AND city = \u0026#39;Beijing\u0026#39;; ç´¢å¼•é¡ºåºçš„é€‰æ‹©\nåŒºåˆ†åº¦é«˜çš„å­—æ®µæ”¾åœ¨å‰é¢ã€‚\n1-- å‡è®¾ name æœ‰ 1000 ä¸ªä¸åŒå€¼ï¼Œage æœ‰ 50 ä¸ªä¸åŒå€¼ï¼Œcity æœ‰ 10 ä¸ªä¸åŒå€¼ 2-- åº”è¯¥åˆ›å»º (name, age, city)ï¼Œè€Œä¸æ˜¯ (city, age, name) è¦†ç›–ç´¢å¼• è¦†ç›–ç´¢å¼•æ˜¯æŒ‡æŸ¥è¯¢çš„å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­ï¼Œä¸éœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\næ¡ˆä¾‹\n1-- åˆ›å»ºç´¢å¼• 2CREATE INDEX idx_name_age ON user(name, age); 3 4-- è¦†ç›–ç´¢å¼•ï¼ˆä¸éœ€è¦å›è¡¨ï¼‰ 5SELECT name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6 7-- éœ€è¦å›è¡¨ 8SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; ä¼˜åŒ–å»ºè®®\nå¦‚æœæŸ¥è¯¢åªéœ€è¦å°‘æ•°å‡ ä¸ªå­—æ®µï¼Œå¯ä»¥åˆ›å»ºè”åˆç´¢å¼•è¦†ç›–è¿™äº›å­—æ®µã€‚\n1-- ä¼˜åŒ–å‰ 2SELECT id, name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; 3 4-- åˆ›å»ºè¦†ç›–ç´¢å¼• 5CREATE INDEX idx_name_age ON user(name, age); 6 7-- ä¼˜åŒ–åï¼ˆä¸éœ€è¦å›è¡¨ï¼‰ 8SELECT id, name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; ç´¢å¼•ä¸‹æ¨ï¼ˆICPï¼‰ MySQL 5.6 å¼•å…¥çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œå°†éƒ¨åˆ† WHERE æ¡ä»¶ä¸‹æ¨åˆ°å­˜å‚¨å¼•æ“å±‚è¿‡æ»¤ã€‚\næ¡ˆä¾‹\n1-- è”åˆç´¢å¼• (name, age) 2SELECT * FROM user WHERE name LIKE \u0026#39;A%\u0026#39; AND age = 25; æ²¡æœ‰ç´¢å¼•ä¸‹æ¨\nå­˜å‚¨å¼•æ“æ ¹æ® name LIKE \u0026lsquo;A%\u0026rsquo; æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„è®°å½• è¿”å›ç»™ Server å±‚ Server å±‚è¿‡æ»¤ age = 25 æœ‰ç´¢å¼•ä¸‹æ¨\nå­˜å‚¨å¼•æ“æ ¹æ® name LIKE \u0026lsquo;A%\u0026rsquo; æ‰¾åˆ°åŒ¹é…çš„è®°å½• åœ¨å­˜å‚¨å¼•æ“å±‚ç›´æ¥è¿‡æ»¤ age = 25 åªè¿”å›ç¬¦åˆæ¡ä»¶çš„è®°å½•ç»™ Server å±‚ å‡å°‘äº†å›è¡¨æ¬¡æ•°ï¼Œæå‡äº†æ€§èƒ½ã€‚\nåˆ†é¡µæŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ï¼šæ·±åº¦åˆ†é¡µ\n1-- æŸ¥è¯¢ç¬¬ 100 ä¸‡æ¡æ•°æ® 2SELECT * FROM user ORDER BY id LIMIT 1000000, 10; MySQL éœ€è¦æ‰«æ 100 ä¸‡ + 10 æ¡æ•°æ®ï¼Œç„¶åä¸¢å¼ƒå‰ 100 ä¸‡æ¡ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\nä¼˜åŒ–æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨å­æŸ¥è¯¢\n1SELECT * FROM user 2WHERE id \u0026gt;= (SELECT id FROM user ORDER BY id LIMIT 1000000, 1) 3LIMIT 10; å­æŸ¥è¯¢ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œåªè¿”å› idï¼Œç„¶åé€šè¿‡ id æŸ¥è¯¢å®Œæ•´æ•°æ®ã€‚\nä¼˜åŒ–æ–¹æ¡ˆäºŒï¼šè®°å½•ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§ ID\n1-- ç¬¬ä¸€æ¬¡æŸ¥è¯¢ 2SELECT * FROM user ORDER BY id LIMIT 10; 3 4-- ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ˆå‡è®¾ä¸Šæ¬¡æœ€å¤§ ID æ˜¯ 10ï¼‰ 5SELECT * FROM user WHERE id \u0026gt; 10 ORDER BY id LIMIT 10; è¿™ç§æ–¹å¼åªé€‚ç”¨äº ID è¿ç»­çš„åœºæ™¯ã€‚\nç´¢å¼•è®¾è®¡çš„æœ€ä½³å®è·µ 1. é€‰æ‹©åˆé€‚çš„å­—æ®µåˆ›å»ºç´¢å¼•\nWHEREã€ORDER BYã€GROUP BYã€JOIN çš„å­—æ®µ åŒºåˆ†åº¦é«˜çš„å­—æ®µï¼ˆä¸è¦ç»™æ€§åˆ«åˆ›å»ºç´¢å¼•ï¼‰ å­—æ®µé•¿åº¦å°çš„å­—æ®µ 2. ä½¿ç”¨å‰ç¼€ç´¢å¼•\nå¯¹äºé•¿å­—ç¬¦ä¸²å­—æ®µï¼Œå¯ä»¥åªç´¢å¼•å‰å‡ ä¸ªå­—ç¬¦ã€‚\n1CREATE INDEX idx_email ON user(email(10)); 3. é¿å…å†—ä½™ç´¢å¼•\nå¦‚æœå·²ç»æœ‰è”åˆç´¢å¼• (name, age)ï¼Œå°±ä¸éœ€è¦å•ç‹¬åˆ›å»º (name) ç´¢å¼•ã€‚\n4. å®šæœŸåˆ†æå’Œä¼˜åŒ–ç´¢å¼•\n1-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ 2SHOW INDEX FROM user; 3 4-- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼• 5DROP INDEX idx_unused ON user; 5. ä½¿ç”¨è‡ªå¢ä¸»é”®\né¿å…é¡µåˆ†è£‚ï¼Œæå‡æ’å…¥æ€§èƒ½ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šæ…¢æŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ SQL\n1SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; æ‰§è¡Œæ—¶é—´ï¼š3 ç§’\nåˆ†æ\n1EXPLAIN SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; ç»“æœï¼štype = ALLï¼Œrows = 1000000ï¼ŒExtra = Using filesort\nä¼˜åŒ–æ­¥éª¤\nåˆ›å»ºè”åˆç´¢å¼• 1CREATE INDEX idx_user_status_time ON order(user_id, status, create_time); å†æ¬¡åˆ†æ 1EXPLAIN SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; ç»“æœï¼štype = rangeï¼Œrows = 100ï¼ŒExtra = Using index condition\næ‰§è¡Œæ—¶é—´ï¼š50ms\næ€§èƒ½æå‡ï¼š60 å€\næ€»ç»“ä¸æ€è€ƒ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nç†è§£ B+ æ ‘çš„åŸç†ï¼ŒçŸ¥é“ä¸ºä»€ä¹ˆç´¢å¼•èƒ½æå‡æ€§èƒ½ æŒæ¡ Explain çš„ä½¿ç”¨ï¼Œèƒ½å¤Ÿåˆ†ææ‰§è¡Œè®¡åˆ’ é¿å…ç´¢å¼•å¤±æ•ˆçš„ 10 ç§åœºæ™¯ åˆç†è®¾è®¡è”åˆç´¢å¼•ï¼Œåˆ©ç”¨æœ€å·¦å‰ç¼€åŒ¹é… ä½¿ç”¨è¦†ç›–ç´¢å¼•å’Œç´¢å¼•ä¸‹æ¨ä¼˜åŒ–æŸ¥è¯¢ ç´¢å¼•ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œæ¯ä¸ªç´¢å¼•éƒ½ä¼šå ç”¨å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”å½±å“å†™å…¥æ€§èƒ½ã€‚è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯åˆç†è®¾è®¡ç´¢å¼•ã€‚\nä¸‹æ¬¡å½“ä½ çš„ SQL æŸ¥è¯¢å¾ˆæ…¢æ—¶ï¼Œä¸å¦¨ç”¨ Explain åˆ†æä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦èµ°äº†ç´¢å¼•ã€‚\n","permalink":"http://localhost:1313/posts/2024/11/mysql-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E4%BB%8E-explain-%E5%88%B0%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/","summary":"\u003cp\u003eSQL æ€§èƒ½ä¼˜åŒ–æ˜¯åç«¯å¼€å‘çš„å¿…å¤‡æŠ€èƒ½ã€‚ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿï¼Œè€Œåˆç†çš„ç´¢å¼•è®¾è®¡èƒ½è®©æŸ¥è¯¢é€Ÿåº¦æå‡ç™¾å€ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ–¹æ³•è®ºã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ B+ æ ‘ç´¢å¼•çš„åº•å±‚åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Explain æ‰§è¡Œè®¡åˆ’çš„åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é…è§„åˆ™\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£è¦†ç›–ç´¢å¼•ä¸ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"b-æ ‘ç´¢å¼•åŸç†\"\u003eB+ æ ‘ç´¢å¼•åŸç†\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eä¸ºä»€ä¹ˆé€‰æ‹© B+ æ ‘ï¼Ÿ\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¸¸è§çš„æ•°æ®ç»“æ„å¯¹æ¯”ï¼š\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eæ•°æ®ç»“æ„\u003c/th\u003e\n          \u003cth\u003eæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦\u003c/th\u003e\n          \u003cth\u003eé—®é¢˜\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eæ•°ç»„\u003c/td\u003e\n          \u003ctd\u003eO(n)\u003c/td\u003e\n          \u003ctd\u003eæŸ¥è¯¢æ…¢\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eäºŒå‰æœç´¢æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eå¯èƒ½é€€åŒ–ä¸ºé“¾è¡¨\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå¹³è¡¡äºŒå‰æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eæ ‘é«˜å¤ªé«˜ï¼ŒIO æ¬¡æ•°å¤š\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eB æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eéå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œæµªè´¹ç©ºé—´\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eB+ æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜ç´¢å¼•\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003eB+ æ ‘çš„ç‰¹ç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹\u003c/li\u003e\n\u003cli\u003eå¶å­èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢\u003c/li\u003e\n\u003cli\u003eéå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šçš„é”®å€¼\u003c/li\u003e\n\u003cli\u003eæ ‘çš„é«˜åº¦ä½ï¼ŒIO æ¬¡æ•°å°‘\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eInnoDB çš„èšç°‡ç´¢å¼•\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eInnoDB çš„ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨å®Œæ•´çš„è¡Œæ•°æ®ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e       10\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e      /  \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e     5    15\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    / \\   / \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e   1  7  12 18\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e   |  |  |  |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  [å®Œæ•´è¡Œæ•°æ®]\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eäºŒçº§ç´¢å¼•ï¼ˆéä¸»é”®ç´¢å¼•ï¼‰çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼Œéœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\u003c/p\u003e","title":"MySQL ç´¢å¼•ä¼˜åŒ–ï¼šä» Explain åˆ°æ‰§è¡Œè®¡åˆ’"},{"content":"ç”Ÿäº§ç¯å¢ƒçš„ OOMï¼ˆOut Of Memoryï¼‰æ˜¯åç«¯å¼€å‘æœ€å¤´ç–¼çš„é—®é¢˜ä¹‹ä¸€ã€‚æœ¬æ–‡é€šè¿‡çœŸå®æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œè§£å†³ JVM å†…å­˜é—®é¢˜ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ JVM å†…å­˜æ¨¡å‹ä¸ GC æœºåˆ¶ æŒæ¡ Heap Dump çš„ç”Ÿæˆä¸åˆ†ææ–¹æ³• å­¦ä¼šä½¿ç”¨ MAT å·¥å…·å®šä½å†…å­˜æ³„æ¼ äº†è§£å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ JVM å†…å­˜æ¨¡å‹ å †å†…å­˜ï¼ˆHeapï¼‰\nå¹´è½»ä»£ï¼ˆYoung Generationï¼‰ Eden åŒºï¼šæ–°å¯¹è±¡åˆ†é…çš„åŒºåŸŸ Survivor åŒºï¼šS0 å’Œ S1ï¼Œå­˜æ”¾ç»è¿‡ä¸€æ¬¡ GC åå­˜æ´»çš„å¯¹è±¡ è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡ éå †å†…å­˜\næ–¹æ³•åŒºï¼ˆMetaspaceï¼‰ï¼šå­˜æ”¾ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ æ ˆï¼ˆStackï¼‰ï¼šå­˜æ”¾å±€éƒ¨å˜é‡ã€æ–¹æ³•è°ƒç”¨ ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ï¼šNIO ä½¿ç”¨çš„å †å¤–å†…å­˜ GC æœºåˆ¶\nMinor GCï¼šæ¸…ç†å¹´è½»ä»£ Major GCï¼šæ¸…ç†è€å¹´ä»£ Full GCï¼šæ¸…ç†æ•´ä¸ªå †å†…å­˜ å¯¹è±¡æ™‹å‡\næ–°å¯¹è±¡åœ¨ Eden åŒºåˆ†é… Eden åŒºæ»¡äº†ï¼Œè§¦å‘ Minor GC å­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ° Survivor åŒº ç»è¿‡å¤šæ¬¡ GC åï¼Œå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ æ¶æ„æ€è€ƒï¼š JVM çš„åˆ†ä»£æ”¶é›†ä½“ç°äº†\u0026quot;å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•æ­»\u0026quot;çš„ç‰¹ç‚¹ã€‚å¹´è½»ä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¿«é€Ÿå›æ”¶çŸ­å‘½å¯¹è±¡ï¼›è€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå¤„ç†é•¿æœŸå­˜æ´»çš„å¯¹è±¡ã€‚è¿™ç§è®¾è®¡åœ¨æ€§èƒ½å’Œå†…å­˜åˆ©ç”¨ç‡ä¹‹é—´æ‰¾åˆ°äº†å¹³è¡¡ã€‚\nOOM çš„å¸¸è§ç±»å‹ 1. java.lang.OutOfMemoryError: Java heap space\nå †å†…å­˜ä¸è¶³ï¼Œæœ€å¸¸è§çš„ OOMã€‚\nåŸå› ï¼š\nå†…å­˜æ³„æ¼ï¼šå¯¹è±¡æ— æ³•è¢« GC å›æ”¶ å†…å­˜æº¢å‡ºï¼šå¯¹è±¡å¤ªå¤šï¼Œè¶…è¿‡å †å†…å­˜å¤§å° 2. java.lang.OutOfMemoryError: GC overhead limit exceeded\nGC å ç”¨äº† 98% çš„æ—¶é—´ï¼Œä½†åªå›æ”¶äº†ä¸åˆ° 2% çš„å†…å­˜ã€‚\n3. java.lang.OutOfMemoryError: Metaspace\næ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰å†…å­˜ä¸è¶³ã€‚\nåŸå› ï¼š\nåŠ è½½äº†å¤ªå¤šçš„ç±» åŠ¨æ€ç”Ÿæˆç±»ï¼ˆå¦‚ CGLIB ä»£ç†ï¼‰ 4. java.lang.OutOfMemoryError: Direct buffer memory\nç›´æ¥å†…å­˜ä¸è¶³ï¼Œé€šå¸¸æ˜¯ NIO ä½¿ç”¨ä¸å½“ã€‚\næ¡ˆä¾‹ä¸€ï¼šThreadLocal å¯¼è‡´çš„å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOMã€‚\næ’æŸ¥æ­¥éª¤\n1. ç”Ÿæˆ Heap Dump\n1# æ–¹å¼ä¸€ï¼šOOM æ—¶è‡ªåŠ¨ç”Ÿæˆ 2java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/heapdump.hprof -jar app.jar 3 4# æ–¹å¼äºŒï¼šæ‰‹åŠ¨ç”Ÿæˆ 5jmap -dump:format=b,file=/tmp/heapdump.hprof \u0026lt;pid\u0026gt; 2. ä½¿ç”¨ MAT åˆ†æ\nä¸‹è½½ Eclipse Memory Analyzerï¼ˆMATï¼‰å·¥å…·ï¼Œæ‰“å¼€ Heap Dump æ–‡ä»¶ã€‚\n3. æŸ¥çœ‹ Dominator Tree\nDominator Tree æ˜¾ç¤ºå ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡ã€‚\nå‘ç°ï¼šThread å¯¹è±¡å ç”¨äº† 2GB å†…å­˜ã€‚\n4. æŸ¥çœ‹ Thread å¯¹è±¡çš„å¼•ç”¨é“¾\nå±•å¼€ Thread å¯¹è±¡ï¼Œå‘ç° threadLocals å­—æ®µä¸­æœ‰å¤§é‡ Entry å¯¹è±¡ã€‚\n5. æŸ¥çœ‹ Entry çš„ value\nå‘ç° value æ˜¯ä¸šåŠ¡å¯¹è±¡ï¼ˆUser Listï¼‰ï¼ŒåŒ…å« 10 ä¸‡æ¡æ•°æ®ã€‚\næ ¹å› \nä»£ç ä¸­ä½¿ç”¨äº† ThreadLocalï¼Œä½†æ²¡æœ‰è°ƒç”¨ remove()ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 8 cache.set(users); 9 10 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 11 doSomething(users); 12 13 // å¿˜è®°è°ƒç”¨ remove() 14 } 15} è§£å†³æ–¹æ¡ˆ\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 try { 8 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 9 cache.set(users); 10 doSomething(users); 11 } finally { 12 cache.remove(); // å¿…é¡»åœ¨ finally ä¸­æ¸…ç† 13 } 14 } 15} æ¡ˆä¾‹äºŒï¼šå¤§å¯¹è±¡å¯¼è‡´çš„ OOM é—®é¢˜ç°è±¡\nå¯¼å‡º Excel æ—¶ï¼Œåº”ç”¨ OOMã€‚\næ’æŸ¥æ­¥éª¤\n1. æŸ¥çœ‹ GC æ—¥å¿—\n1java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/tmp/gc.log -jar app.jar GC æ—¥å¿—æ˜¾ç¤ºï¼šFull GC é¢‘ç¹ï¼Œä½†å›æ”¶æ•ˆæœä¸æ˜æ˜¾ã€‚\n2. åˆ†æ Heap Dump\nå‘ç°å¤§é‡çš„ ArrayList å¯¹è±¡ï¼Œæ¯ä¸ªåŒ…å« 10 ä¸‡æ¡æ•°æ®ã€‚\næ ¹å› \nä½¿ç”¨ä¼ ç»Ÿçš„ POI å¯¼å‡º Excelï¼Œä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ã€‚\n1public void exportExcel() { 2 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); // æŸ¥è¯¢ 10 ä¸‡æ¡æ•°æ® 3 4 Workbook workbook = new XSSFWorkbook(); 5 Sheet sheet = workbook.createSheet(); 6 7 for (int i = 0; i \u0026lt; users.size(); i++) { 8 Row row = sheet.createRow(i); 9 // å¡«å……æ•°æ® 10 } 11 12 workbook.write(outputStream); 13} è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ EasyExcel æµå¼å†™å…¥\n1public void exportExcel() { 2 EasyExcel.write(outputStream, User.class) 3 .registerWriteHandler(new LongestMatchColumnWidthStyleStrategy()) 4 .sheet(\u0026#34;ç”¨æˆ·åˆ—è¡¨\u0026#34;) 5 .doWrite(() -\u0026gt; { 6 // åˆ†æ‰¹æŸ¥è¯¢ 7 int pageSize = 1000; 8 int pageNum = 1; 9 List\u0026lt;User\u0026gt; users; 10 List\u0026lt;User\u0026gt; allUsers = new ArrayList\u0026lt;\u0026gt;(); 11 12 do { 13 users = userMapper.selectPage(pageNum, pageSize); 14 allUsers.addAll(users); 15 pageNum++; 16 } while (users.size() == pageSize); 17 18 return allUsers; 19 }); 20} æ›´å¥½çš„æ–¹æ¡ˆï¼šä½¿ç”¨ EasyExcel çš„åˆ†æ‰¹å†™å…¥\n1public void exportExcel() { 2 ExcelWriter excelWriter = EasyExcel.write(outputStream, User.class).build(); 3 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;ç”¨æˆ·åˆ—è¡¨\u0026#34;).build(); 4 5 int pageSize = 1000; 6 int pageNum = 1; 7 List\u0026lt;User\u0026gt; users; 8 9 do { 10 users = userMapper.selectPage(pageNum, pageSize); 11 excelWriter.write(users, writeSheet); 12 pageNum++; 13 } while (users.size() == pageSize); 14 15 excelWriter.finish(); 16} æ¡ˆä¾‹ä¸‰ï¼šé™æ€é›†åˆå¯¼è‡´çš„å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nåº”ç”¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå†…å­˜æŒç»­å¢é•¿ã€‚\næ ¹å› \nä½¿ç”¨é™æ€é›†åˆç¼“å­˜æ•°æ®ï¼Œä½†æ²¡æœ‰æ¸…ç†æœºåˆ¶ã€‚\n1public class CacheManager { 2 3 private static final Map\u0026lt;String, Object\u0026gt; cache = new HashMap\u0026lt;\u0026gt;(); 4 5 public static void put(String key, Object value) { 6 cache.put(key, value); 7 } 8 9 public static Object get(String key) { 10 return cache.get(key); 11 } 12} è§£å†³æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ WeakHashMap\n1private static final Map\u0026lt;String, Object\u0026gt; cache = new WeakHashMap\u0026lt;\u0026gt;(); WeakHashMap çš„ key æ˜¯å¼±å¼•ç”¨ï¼Œå½“ key æ²¡æœ‰å¼ºå¼•ç”¨æ—¶ï¼Œä¼šè¢« GC å›æ”¶ã€‚\nè§£å†³æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Guava Cache\n1private static final Cache\u0026lt;String, Object\u0026gt; cache = CacheBuilder.newBuilder() 2 .maximumSize(10000) // æœ€å¤§ç¼“å­˜æ•°é‡ 3 .expireAfterWrite(10, TimeUnit.MINUTES) // å†™å…¥å 10 åˆ†é’Ÿè¿‡æœŸ 4 .build(); è§£å†³æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨ Redis\nå°†ç¼“å­˜æ”¾åˆ° Redisï¼Œé¿å…å ç”¨ JVM å†…å­˜ã€‚\nå¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ 1. ThreadLocal æœªæ¸…ç†\nåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹ï¼ŒThreadLocal å¿…é¡»è°ƒç”¨ remove()ã€‚\n2. é™æ€é›†åˆ\né™æ€é›†åˆçš„ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç›¸åŒï¼Œå®¹æ˜“å¯¼è‡´å†…å­˜æ³„æ¼ã€‚\n3. ç›‘å¬å™¨æœªæ³¨é”€\n1// æ³¨å†Œç›‘å¬å™¨ 2eventBus.register(listener); 3 4// å¿˜è®°æ³¨é”€ 5// eventBus.unregister(listener); 4. æ•°æ®åº“è¿æ¥æœªå…³é—­\n1Connection conn = DriverManager.getConnection(url); 2// å¿˜è®°å…³é—­ 3// conn.close(); 5. IO æµæœªå…³é—­\n1FileInputStream fis = new FileInputStream(file); 2// å¿˜è®°å…³é—­ 3// fis.close(); ä½¿ç”¨ try-with-resources è‡ªåŠ¨å…³é—­èµ„æºï¼š\n1try (FileInputStream fis = new FileInputStream(file)) { 2 // ä½¿ç”¨æµ 3} JVM å‚æ•°è°ƒä¼˜ å †å†…å­˜è®¾ç½®\n1-Xms4g # åˆå§‹å †å†…å­˜ 2-Xmx4g # æœ€å¤§å †å†…å­˜ï¼ˆå»ºè®®ä¸ Xms ç›¸åŒï¼Œé¿å…åŠ¨æ€æ‰©å®¹ï¼‰ å¹´è½»ä»£è®¾ç½®\n1-Xmn2g # å¹´è½»ä»£å¤§å°ï¼ˆå»ºè®®ä¸ºå †å†…å­˜çš„ 1/3 åˆ° 1/2ï¼‰ å…ƒç©ºé—´è®¾ç½®\n1-XX:MetaspaceSize=256m # åˆå§‹å…ƒç©ºé—´å¤§å° 2-XX:MaxMetaspaceSize=512m # æœ€å¤§å…ƒç©ºé—´å¤§å° GC æ—¥å¿—\n1-XX:+PrintGCDetails # æ‰“å° GC è¯¦ç»†ä¿¡æ¯ 2-XX:+PrintGCDateStamps # æ‰“å° GC æ—¶é—´æˆ³ 3-Xloggc:/tmp/gc.log # GC æ—¥å¿—æ–‡ä»¶ OOM æ—¶ç”Ÿæˆ Heap Dump\n1-XX:+HeapDumpOnOutOfMemoryError 2-XX:HeapDumpPath=/tmp/heapdump.hprof GC æ”¶é›†å™¨é€‰æ‹©\n1# G1 æ”¶é›†å™¨ï¼ˆæ¨èï¼‰ 2-XX:+UseG1GC 3-XX:MaxGCPauseMillis=200 # æœ€å¤§ GC åœé¡¿æ—¶é—´ 4 5# ZGCï¼ˆJDK 11+ï¼‰ 6-XX:+UseZGC ç›‘æ§ä¸é¢„è­¦ 1. ä½¿ç”¨ JVM ç›‘æ§å·¥å…·\nJConsoleï¼šJDK è‡ªå¸¦çš„ç›‘æ§å·¥å…· VisualVMï¼šå¯è§†åŒ–ç›‘æ§å·¥å…· Arthasï¼šé˜¿é‡Œå¼€æºçš„è¯Šæ–­å·¥å…· 2. ä½¿ç”¨ APM å·¥å…·\nSkyWalkingï¼šåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ Prometheus + Grafanaï¼šç›‘æ§ä¸å¯è§†åŒ– 3. è®¾ç½®å†…å­˜å‘Šè­¦\nå½“å †å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 80% æ—¶ï¼Œå‘é€å‘Šè­¦é€šçŸ¥ã€‚\næ€»ç»“ä¸æ€è€ƒ JVM OOM æ’æŸ¥çš„æ–¹æ³•è®ºï¼š\nç”Ÿæˆ Heap Dump ä½¿ç”¨ MAT åˆ†æå†…å­˜å ç”¨ æŸ¥çœ‹ Dominator Treeï¼Œæ‰¾åˆ°å ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡ åˆ†æå¼•ç”¨é“¾ï¼Œæ‰¾åˆ°æ ¹å›  ä¿®å¤ä»£ç ï¼Œé¿å…å†…å­˜æ³„æ¼ å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ï¼š\nThreadLocal æœªæ¸…ç† é™æ€é›†åˆæ— é™å¢é•¿ ç›‘å¬å™¨æœªæ³¨é”€ èµ„æºæœªå…³é—­ é¢„é˜²æªæ–½ï¼š\nCode Review é‡ç‚¹å…³æ³¨èµ„æºç®¡ç† ä½¿ç”¨ try-with-resources è‡ªåŠ¨å…³é—­èµ„æº å®šæœŸåˆ†æ Heap Dumpï¼Œæå‰å‘ç°é—®é¢˜ è®¾ç½®åˆç†çš„ JVM å‚æ•°å’Œç›‘æ§å‘Šè­¦ ä¸‹æ¬¡å½“ä½ çš„åº”ç”¨ OOM æ—¶ï¼ŒæŒ‰ç…§è¿™ä¸ªæ–¹æ³•è®ºä¸€æ­¥æ­¥æ’æŸ¥ï¼Œä¸€å®šèƒ½æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚\n","permalink":"http://localhost:1313/posts/2024/10/jvm-oom-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98%E4%BB%8E-heap-dump-%E5%88%B0%E6%A0%B9%E5%9B%A0%E5%88%86%E6%9E%90/","summary":"\u003cp\u003eç”Ÿäº§ç¯å¢ƒçš„ OOMï¼ˆOut Of Memoryï¼‰æ˜¯åç«¯å¼€å‘æœ€å¤´ç–¼çš„é—®é¢˜ä¹‹ä¸€ã€‚æœ¬æ–‡é€šè¿‡çœŸå®æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œè§£å†³ JVM å†…å­˜é—®é¢˜ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ JVM å†…å­˜æ¨¡å‹ä¸ GC æœºåˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Heap Dump çš„ç”Ÿæˆä¸åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ MAT å·¥å…·å®šä½å†…å­˜æ³„æ¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"jvm-å†…å­˜æ¨¡å‹\"\u003eJVM å†…å­˜æ¨¡å‹\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå †å†…å­˜ï¼ˆHeapï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¹´è½»ä»£ï¼ˆYoung Generationï¼‰\n\u003cul\u003e\n\u003cli\u003eEden åŒºï¼šæ–°å¯¹è±¡åˆ†é…çš„åŒºåŸŸ\u003c/li\u003e\n\u003cli\u003eSurvivor åŒºï¼šS0 å’Œ S1ï¼Œå­˜æ”¾ç»è¿‡ä¸€æ¬¡ GC åå­˜æ´»çš„å¯¹è±¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eè€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eéå †å†…å­˜\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ–¹æ³•åŒºï¼ˆMetaspaceï¼‰ï¼šå­˜æ”¾ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡\u003c/li\u003e\n\u003cli\u003eæ ˆï¼ˆStackï¼‰ï¼šå­˜æ”¾å±€éƒ¨å˜é‡ã€æ–¹æ³•è°ƒç”¨\u003c/li\u003e\n\u003cli\u003eç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ï¼šNIO ä½¿ç”¨çš„å †å¤–å†…å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eGC æœºåˆ¶\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMinor GCï¼šæ¸…ç†å¹´è½»ä»£\u003c/li\u003e\n\u003cli\u003eMajor GCï¼šæ¸…ç†è€å¹´ä»£\u003c/li\u003e\n\u003cli\u003eFull GCï¼šæ¸…ç†æ•´ä¸ªå †å†…å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå¯¹è±¡æ™‹å‡\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ–°å¯¹è±¡åœ¨ Eden åŒºåˆ†é…\u003c/li\u003e\n\u003cli\u003eEden åŒºæ»¡äº†ï¼Œè§¦å‘ Minor GC\u003c/li\u003e\n\u003cli\u003eå­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ° Survivor åŒº\u003c/li\u003e\n\u003cli\u003eç»è¿‡å¤šæ¬¡ GC åï¼Œå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e JVM çš„åˆ†ä»£æ”¶é›†ä½“ç°äº†\u0026quot;å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•æ­»\u0026quot;çš„ç‰¹ç‚¹ã€‚å¹´è½»ä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¿«é€Ÿå›æ”¶çŸ­å‘½å¯¹è±¡ï¼›è€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå¤„ç†é•¿æœŸå­˜æ´»çš„å¯¹è±¡ã€‚è¿™ç§è®¾è®¡åœ¨æ€§èƒ½å’Œå†…å­˜åˆ©ç”¨ç‡ä¹‹é—´æ‰¾åˆ°äº†å¹³è¡¡ã€‚\u003c/p\u003e","title":"JVM OOM é—®é¢˜æ’æŸ¥å®æˆ˜ï¼šä» Heap Dump åˆ°æ ¹å› åˆ†æ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´çš„åŒæ­¥è°ƒç”¨ä¼šå¯¼è‡´å¼ºè€¦åˆå’Œæ€§èƒ½ç“¶é¢ˆã€‚æ¶ˆæ¯é˜Ÿåˆ—é€šè¿‡å¼‚æ­¥è§£è€¦ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚æœ¬æ–‡è®²è§£ RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å®æˆ˜åº”ç”¨ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒä»·å€¼ä¸é€‰å‹æ ‡å‡† æŒæ¡ RabbitMQ çš„æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæ¨¡å¼ å­¦ä¼šä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆ äº†è§£æ¶ˆæ¯å¹‚ç­‰æ€§ä¸é¡ºåºæ€§çš„å¤„ç† ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ åœºæ™¯ï¼šè®¢å•åˆ›å»ºæµç¨‹\nåŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private InventoryService inventoryService; 6 7 @Autowired 8 private PaymentService paymentService; 9 10 @Autowired 11 private NotificationService notificationService; 12 13 public void createOrder(Order order) { 14 // 1. ä¿å­˜è®¢å• 15 orderMapper.insert(order); 16 17 // 2. æ‰£å‡åº“å­˜ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 18 inventoryService.deduct(order.getProductId(), order.getQuantity()); 19 20 // 3. åˆ›å»ºæ”¯ä»˜å•ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 21 paymentService.createPayment(order.getId()); 22 23 // 4. å‘é€é€šçŸ¥ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 24 notificationService.sendOrderCreatedNotification(order.getUserId()); 25 } 26} é—®é¢˜ï¼š\nå“åº”æ—¶é—´é•¿ï¼šæ€»è€—æ—¶ = ä¿å­˜è®¢å• + æ‰£å‡åº“å­˜ + åˆ›å»ºæ”¯ä»˜å• + å‘é€é€šçŸ¥ å¼ºè€¦åˆï¼šä»»ä½•ä¸€ä¸ªæœåŠ¡ä¸å¯ç”¨ï¼Œæ•´ä¸ªæµç¨‹å¤±è´¥ æ€§èƒ½ç“¶é¢ˆï¼šä¸‹æ¸¸æœåŠ¡çš„æ€§èƒ½å½±å“ä¸Šæ¸¸æœåŠ¡ å¼‚æ­¥è§£è€¦çš„æ–¹æ¡ˆ\n1@Service 2public class OrderService { 3 4 @Autowired 5 private RabbitTemplate rabbitTemplate; 6 7 public void createOrder(Order order) { 8 // 1. ä¿å­˜è®¢å• 9 orderMapper.insert(order); 10 11 // 2. å‘é€æ¶ˆæ¯åˆ° MQ 12 OrderCreatedEvent event = new OrderCreatedEvent(order.getId(), order.getUserId()); 13 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, event); 14 } 15} 16 17// åº“å­˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ 18@Component 19public class InventoryListener { 20 21 @RabbitListener(queues = \u0026#34;inventory.queue\u0026#34;) 22 public void handleOrderCreated(OrderCreatedEvent event) { 23 inventoryService.deduct(event.getOrderId()); 24 } 25} å¥½å¤„ï¼š\nå“åº”æ—¶é—´çŸ­ï¼šåªéœ€è¦ä¿å­˜è®¢å• + å‘é€æ¶ˆæ¯ æ¾è€¦åˆï¼šä¸‹æ¸¸æœåŠ¡ä¸å¯ç”¨ä¸å½±å“è®¢å•åˆ›å»º å‰Šå³°å¡«è°·ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²æµé‡é«˜å³° æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹ï¼šRabbitMQ vs Kafka ç‰¹æ€§ RabbitMQ Kafka æ¶ˆæ¯æ¨¡å‹ æ¨æ¨¡å¼ï¼ˆPushï¼‰ æ‹‰æ¨¡å¼ï¼ˆPullï¼‰ ååé‡ ä¸‡çº§ ç™¾ä¸‡çº§ å»¶è¿Ÿ å¾®ç§’çº§ æ¯«ç§’çº§ æ¶ˆæ¯é¡ºåº é˜Ÿåˆ—çº§åˆ« åˆ†åŒºçº§åˆ« æ¶ˆæ¯æŒä¹…åŒ– æ”¯æŒ æ”¯æŒ é€‚ç”¨åœºæ™¯ ä¸šåŠ¡è§£è€¦ã€ä»»åŠ¡é˜Ÿåˆ— æ—¥å¿—æ”¶é›†ã€æµå¤„ç† é€‰æ‹© RabbitMQ çš„ç†ç”±\nä¸šåŠ¡åœºæ™¯éœ€è¦å¤æ‚çš„è·¯ç”±è§„åˆ™ï¼ˆExchange + Routing Keyï¼‰ éœ€è¦æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆACKï¼‰ æ¶ˆæ¯é‡ä¸å¤§ï¼Œæ›´å…³æ³¨å¯é æ€§ é€‰æ‹© Kafka çš„ç†ç”±\næµ·é‡æ—¥å¿—æ”¶é›† å®æ—¶æµå¤„ç† éœ€è¦æ¶ˆæ¯å›æº¯ RabbitMQ æ ¸å¿ƒæ¦‚å¿µ æ¶æ„å›¾\n1Producer â†’ Exchange â†’ Queue â†’ Consumer Exchangeï¼ˆäº¤æ¢æœºï¼‰\næ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œæ ¹æ®è·¯ç”±è§„åˆ™åˆ†å‘åˆ°é˜Ÿåˆ—ã€‚\nå››ç§ç±»å‹ï¼š\nDirectï¼šç²¾ç¡®åŒ¹é… Routing Key Topicï¼šæ¨¡ç³ŠåŒ¹é… Routing Keyï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰ Fanoutï¼šå¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ— Headersï¼šæ ¹æ®æ¶ˆæ¯å¤´åŒ¹é… Queueï¼ˆé˜Ÿåˆ—ï¼‰\nå­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚\nBindingï¼ˆç»‘å®šï¼‰\nExchange å’Œ Queue ä¹‹é—´çš„è·¯ç”±è§„åˆ™ã€‚\nå·¥ä½œæ¨¡å¼ 1. Simple æ¨¡å¼ï¼ˆç®€å•é˜Ÿåˆ—ï¼‰\nä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ã€‚\n1// ç”Ÿäº§è€… 2rabbitTemplate.convertAndSend(\u0026#34;simple.queue\u0026#34;, \u0026#34;Hello\u0026#34;); 3 4// æ¶ˆè´¹è€… 5@RabbitListener(queues = \u0026#34;simple.queue\u0026#34;) 6public void receive(String message) { 7 System.out.println(\u0026#34;æ”¶åˆ°æ¶ˆæ¯: \u0026#34; + message); 8} 2. Work æ¨¡å¼ï¼ˆå·¥ä½œé˜Ÿåˆ—ï¼‰\nä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯è½®è¯¢åˆ†å‘ã€‚\n1@RabbitListener(queues = \u0026#34;work.queue\u0026#34;) 2public void worker1(String message) { 3 System.out.println(\u0026#34;Worker1: \u0026#34; + message); 4} 5 6@RabbitListener(queues = \u0026#34;work.queue\u0026#34;) 7public void worker2(String message) { 8 System.out.println(\u0026#34;Worker2: \u0026#34; + message); 9} 3. Publish/Subscribe æ¨¡å¼ï¼ˆå‘å¸ƒè®¢é˜…ï¼‰\nä½¿ç”¨ Fanout Exchangeï¼Œæ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰é˜Ÿåˆ—ã€‚\n1// é…ç½® 2@Bean 3public FanoutExchange fanoutExchange() { 4 return new FanoutExchange(\u0026#34;fanout.exchange\u0026#34;); 5} 6 7@Bean 8public Queue queue1() { 9 return new Queue(\u0026#34;queue1\u0026#34;); 10} 11 12@Bean 13public Binding binding1(FanoutExchange fanoutExchange, Queue queue1) { 14 return BindingBuilder.bind(queue1).to(fanoutExchange); 15} 16 17// ç”Ÿäº§è€… 18rabbitTemplate.convertAndSend(\u0026#34;fanout.exchange\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;Hello\u0026#34;); 4. Routing æ¨¡å¼ï¼ˆè·¯ç”±ï¼‰\nä½¿ç”¨ Direct Exchangeï¼Œæ ¹æ® Routing Key ç²¾ç¡®åŒ¹é…ã€‚\n1// é…ç½® 2@Bean 3public DirectExchange directExchange() { 4 return new DirectExchange(\u0026#34;direct.exchange\u0026#34;); 5} 6 7@Bean 8public Binding bindingError(Queue errorQueue, DirectExchange directExchange) { 9 return BindingBuilder.bind(errorQueue).to(directExchange).with(\u0026#34;error\u0026#34;); 10} 11 12// ç”Ÿäº§è€… 13rabbitTemplate.convertAndSend(\u0026#34;direct.exchange\u0026#34;, \u0026#34;error\u0026#34;, \u0026#34;Error message\u0026#34;); 5. Topic æ¨¡å¼ï¼ˆä¸»é¢˜ï¼‰\nä½¿ç”¨ Topic Exchangeï¼Œæ”¯æŒé€šé…ç¬¦åŒ¹é…ã€‚\n*ï¼šåŒ¹é…ä¸€ä¸ªå•è¯ #ï¼šåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå•è¯ 1// é…ç½® 2@Bean 3public TopicExchange topicExchange() { 4 return new TopicExchange(\u0026#34;topic.exchange\u0026#34;); 5} 6 7@Bean 8public Binding bindingOrder(Queue orderQueue, TopicExchange topicExchange) { 9 return BindingBuilder.bind(orderQueue).to(topicExchange).with(\u0026#34;order.*\u0026#34;); 10} 11 12// ç”Ÿäº§è€… 13rabbitTemplate.convertAndSend(\u0026#34;topic.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, \u0026#34;Order created\u0026#34;); 14rabbitTemplate.convertAndSend(\u0026#34;topic.exchange\u0026#34;, \u0026#34;order.paid\u0026#34;, \u0026#34;Order paid\u0026#34;); æ¶æ„æ€è€ƒï¼š RabbitMQ çš„ Exchange æœºåˆ¶ä½“ç°äº†\u0026quot;ç­–ç•¥æ¨¡å¼\u0026quot;çš„æ€æƒ³ã€‚ä¸åŒç±»å‹çš„ Exchange å®ç°ä¸åŒçš„è·¯ç”±ç­–ç•¥ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸éœ€è¦å…³å¿ƒè·¯ç”±ç»†èŠ‚ã€‚è¿™ç§è®¾è®¡è®©ç³»ç»Ÿæ›´åŠ çµæ´»ï¼Œæ˜“äºæ‰©å±•ã€‚\næ¶ˆæ¯å¯é æ€§ä¿éšœ é—®é¢˜ä¸€ï¼šç”Ÿäº§è€…æ¶ˆæ¯ä¸¢å¤±\nç”Ÿäº§è€…å‘é€æ¶ˆæ¯åï¼ŒRabbitMQ å®•æœºï¼Œæ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼ˆPublisher Confirmï¼‰\n1spring: 2 rabbitmq: 3 publisher-confirm-type: correlated 4 publisher-returns: true 1@Configuration 2public class RabbitConfig { 3 4 @Bean 5 public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) { 6 RabbitTemplate template = new RabbitTemplate(connectionFactory); 7 8 // æ¶ˆæ¯å‘é€åˆ° Exchange çš„ç¡®è®¤ 9 template.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { 10 if (ack) { 11 log.info(\u0026#34;æ¶ˆæ¯å‘é€æˆåŠŸ\u0026#34;); 12 } else { 13 log.error(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥: {}\u0026#34;, cause); 14 // é‡è¯•æˆ–è®°å½•åˆ°æ•°æ®åº“ 15 } 16 }); 17 18 // æ¶ˆæ¯ä» Exchange è·¯ç”±åˆ° Queue çš„ç¡®è®¤ 19 template.setReturnsCallback(returned -\u0026gt; { 20 log.error(\u0026#34;æ¶ˆæ¯è·¯ç”±å¤±è´¥: {}\u0026#34;, returned.getMessage()); 21 }); 22 23 return template; 24 } 25} é—®é¢˜äºŒï¼šæ¶ˆæ¯åœ¨ RabbitMQ ä¸­ä¸¢å¤±\nRabbitMQ å®•æœºï¼Œå†…å­˜ä¸­çš„æ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ¶ˆæ¯æŒä¹…åŒ–\n1// 1. Exchange æŒä¹…åŒ– 2@Bean 3public DirectExchange directExchange() { 4 return new DirectExchange(\u0026#34;direct.exchange\u0026#34;, true, false); 5} 6 7// 2. Queue æŒä¹…åŒ– 8@Bean 9public Queue queue() { 10 return new Queue(\u0026#34;my.queue\u0026#34;, true); 11} 12 13// 3. æ¶ˆæ¯æŒä¹…åŒ– 14rabbitTemplate.convertAndSend(\u0026#34;direct.exchange\u0026#34;, \u0026#34;routing.key\u0026#34;, message, msg -\u0026gt; { 15 msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); 16 return msg; 17}); é—®é¢˜ä¸‰ï¼šæ¶ˆè´¹è€…æ¶ˆæ¯ä¸¢å¤±\næ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯åï¼Œè¿˜æ²¡å¤„ç†å®Œå°±å®•æœºï¼Œæ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨ ACK\n1spring: 2 rabbitmq: 3 listener: 4 simple: 5 acknowledge-mode: manual 1@RabbitListener(queues = \u0026#34;my.queue\u0026#34;) 2public void receive(String message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag) { 3 try { 4 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 5 processMessage(message); 6 7 // æ‰‹åŠ¨ç¡®è®¤ 8 channel.basicAck(tag, false); 9 } catch (Exception e) { 10 log.error(\u0026#34;æ¶ˆæ¯å¤„ç†å¤±è´¥\u0026#34;, e); 11 12 // æ‹’ç»æ¶ˆæ¯ï¼Œé‡æ–°å…¥é˜Ÿ 13 channel.basicNack(tag, false, true); 14 } 15} é¿å‘æç¤ºï¼š æ‰‹åŠ¨ ACK æ—¶ï¼Œå¦‚æœå¿˜è®°è°ƒç”¨ basicAck æˆ– basicNackï¼Œæ¶ˆæ¯ä¼šä¸€ç›´å¤„äº Unacked çŠ¶æ€ï¼Œå ç”¨å†…å­˜ã€‚å»ºè®®åœ¨ finally å—ä¸­ç¡®ä¿æ¶ˆæ¯è¢«ç¡®è®¤ã€‚\næ¶ˆæ¯å¹‚ç­‰æ€§ æ¶ˆæ¯å¯èƒ½è¢«é‡å¤æ¶ˆè´¹ï¼ˆç½‘ç»œæŠ–åŠ¨ã€æ¶ˆè´¹è€…é‡å¯ï¼‰ï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§ã€‚\næ–¹æ¡ˆä¸€ï¼šå”¯ä¸€ ID + æ•°æ®åº“å»é‡\n1@RabbitListener(queues = \u0026#34;order.queue\u0026#34;) 2public void handleOrder(OrderMessage message) { 3 String messageId = message.getMessageId(); 4 5 // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç† 6 if (messageLogMapper.exists(messageId)) { 7 log.info(\u0026#34;æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: {}\u0026#34;, messageId); 8 return; 9 } 10 11 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 12 processOrder(message); 13 14 // è®°å½•æ¶ˆæ¯ ID 15 messageLogMapper.insert(new MessageLog(messageId)); 16} æ–¹æ¡ˆäºŒï¼šRedis å»é‡\n1@RabbitListener(queues = \u0026#34;order.queue\u0026#34;) 2public void handleOrder(OrderMessage message) { 3 String messageId = message.getMessageId(); 4 String key = \u0026#34;message:processed:\u0026#34; + messageId; 5 6 // ä½¿ç”¨ SETNX ä¿è¯åŸå­æ€§ 7 Boolean success = redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;, 1, TimeUnit.HOURS); 8 if (!success) { 9 log.info(\u0026#34;æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: {}\u0026#34;, messageId); 10 return; 11 } 12 13 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 14 processOrder(message); 15} æ¶ˆæ¯é¡ºåºæ€§ RabbitMQ ä¸ä¿è¯å…¨å±€é¡ºåºï¼Œåªä¿è¯å•ä¸ªé˜Ÿåˆ—çš„é¡ºåºã€‚\næ–¹æ¡ˆï¼šæŒ‰ä¸šåŠ¡ ID è·¯ç”±åˆ°åŒä¸€é˜Ÿåˆ—\n1// ç”Ÿäº§è€…ï¼šæ ¹æ®è®¢å• ID è®¡ç®— Routing Key 2public void sendMessage(OrderMessage message) { 3 String routingKey = \u0026#34;order.\u0026#34; + (message.getOrderId() % 10); 4 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, routingKey, message); 5} 6 7// æ¶ˆè´¹è€…ï¼šæ¯ä¸ªé˜Ÿåˆ—åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€… 8@RabbitListener(queues = \u0026#34;order.queue.0\u0026#34;, concurrency = \u0026#34;1\u0026#34;) 9public void handleOrder0(OrderMessage message) { 10 processOrder(message); 11} æ­»ä¿¡é˜Ÿåˆ— æ¶ˆæ¯å¤„ç†å¤±è´¥åï¼Œå¯ä»¥å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Œé¿å…é˜»å¡æ­£å¸¸æ¶ˆæ¯ã€‚\né…ç½®æ­»ä¿¡é˜Ÿåˆ—\n1@Bean 2public Queue normalQueue() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-dead-letter-exchange\u0026#34;, \u0026#34;dlx.exchange\u0026#34;); 5 args.put(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;dlx.routing.key\u0026#34;); 6 return new Queue(\u0026#34;normal.queue\u0026#34;, true, false, false, args); 7} 8 9@Bean 10public Queue deadLetterQueue() { 11 return new Queue(\u0026#34;dead.letter.queue\u0026#34;); 12} 13 14@Bean 15public DirectExchange dlxExchange() { 16 return new DirectExchange(\u0026#34;dlx.exchange\u0026#34;); 17} 18 19@Bean 20public Binding dlxBinding() { 21 return BindingBuilder.bind(deadLetterQueue()).to(dlxExchange()).with(\u0026#34;dlx.routing.key\u0026#34;); 22} æ¶ˆè´¹è€…æ‹’ç»æ¶ˆæ¯\n1@RabbitListener(queues = \u0026#34;normal.queue\u0026#34;) 2public void receive(String message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag) { 3 try { 4 processMessage(message); 5 channel.basicAck(tag, false); 6 } catch (Exception e) { 7 // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ— 8 channel.basicNack(tag, false, false); 9 } 10} å»¶è¿Ÿé˜Ÿåˆ— å®ç°å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆã€‚\næ–¹æ¡ˆä¸€ï¼šTTL + æ­»ä¿¡é˜Ÿåˆ—\n1@Bean 2public Queue delayQueue() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-message-ttl\u0026#34;, 30000); // 30 ç§’åè¿‡æœŸ 5 args.put(\u0026#34;x-dead-letter-exchange\u0026#34;, \u0026#34;order.exchange\u0026#34;); 6 args.put(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;order.timeout\u0026#34;); 7 return new Queue(\u0026#34;delay.queue\u0026#34;, true, false, false, args); 8} æ–¹æ¡ˆäºŒï¼šRabbitMQ å»¶è¿Ÿæ’ä»¶\n1rabbitmq-plugins enable rabbitmq_delayed_message_exchange 1@Bean 2public CustomExchange delayExchange() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-delayed-type\u0026#34;, \u0026#34;direct\u0026#34;); 5 return new CustomExchange(\u0026#34;delay.exchange\u0026#34;, \u0026#34;x-delayed-message\u0026#34;, true, false, args); 6} 7 8// å‘é€å»¶è¿Ÿæ¶ˆæ¯ 9rabbitTemplate.convertAndSend(\u0026#34;delay.exchange\u0026#34;, \u0026#34;routing.key\u0026#34;, message, msg -\u0026gt; { 10 msg.getMessageProperties().setDelay(30000); // å»¶è¿Ÿ 30 ç§’ 11 return msg; 12}); æ€»ç»“ä¸æ€è€ƒ RabbitMQ çš„æ ¸å¿ƒä»·å€¼æ˜¯å¼‚æ­¥è§£è€¦ï¼Œæå‡ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚\nä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆï¼š\nç”Ÿäº§è€…ç¡®è®¤ï¼šPublisher Confirm æ¶ˆæ¯æŒä¹…åŒ–ï¼šExchangeã€Queueã€Message éƒ½æŒä¹…åŒ– æ¶ˆè´¹è€…ç¡®è®¤ï¼šæ‰‹åŠ¨ ACK å¹‚ç­‰æ€§ï¼šå”¯ä¸€ ID + å»é‡ æ­»ä¿¡é˜Ÿåˆ—ï¼šå¤„ç†å¤±è´¥æ¶ˆæ¯ ä¸‹æ¬¡å½“ä½ çš„ç³»ç»Ÿéœ€è¦å¼‚æ­¥è§£è€¦æ—¶ï¼Œä¸å¦¨è¯•è¯• RabbitMQï¼Œä½“éªŒæ¶ˆæ¯é˜Ÿåˆ—çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/10/rabbitmq-%E5%9C%A8%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E8%A7%A3%E8%80%A6%E5%AE%9E%E8%B7%B5/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´çš„åŒæ­¥è°ƒç”¨ä¼šå¯¼è‡´å¼ºè€¦åˆå’Œæ€§èƒ½ç“¶é¢ˆã€‚æ¶ˆæ¯é˜Ÿåˆ—é€šè¿‡å¼‚æ­¥è§£è€¦ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚æœ¬æ–‡è®²è§£ RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å®æˆ˜åº”ç”¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒä»·å€¼ä¸é€‰å‹æ ‡å‡†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ RabbitMQ çš„æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæ¨¡å¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£æ¶ˆæ¯å¹‚ç­‰æ€§ä¸é¡ºåºæ€§çš„å¤„ç†\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—\"\u003eä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼šè®¢å•åˆ›å»ºæµç¨‹\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrderService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eInventoryService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einventoryService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epaymentService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eNotificationService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enotificationService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecreateOrder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. ä¿å­˜è®¢å•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einsert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æ‰£å‡åº“å­˜ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003einventoryService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ededuct\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductId\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆ›å»ºæ”¯ä»˜å•ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003epaymentService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreatePayment\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. å‘é€é€šçŸ¥ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003enotificationService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esendOrderCreatedNotification\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e","title":"RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å¼‚æ­¥è§£è€¦å®è·µ"},{"content":"DDDï¼ˆDomain-Driven Designï¼‰æ˜¯ä¸€å¥—å¤æ‚ä¸šåŠ¡ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•è®ºã€‚ä½†å¾ˆå¤šäººå­¦äº† DDD çš„æ¦‚å¿µï¼Œå´ä¸çŸ¥é“å¦‚ä½•è½åœ°ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªç”µå•†è®¢å•ç³»ç»Ÿçš„æ¡ˆä¾‹ï¼Œè®²è§£ DDD çš„å®æˆ˜åº”ç”¨ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ DDD çš„æ ¸å¿ƒæ¦‚å¿µï¼šå®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡ æŒæ¡é™ç•Œä¸Šä¸‹æ–‡çš„åˆ’åˆ†æ–¹æ³• å­¦ä¼šç”¨é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦ äº†è§£ DDD åˆ†å±‚æ¶æ„çš„ä»£ç ç»„ç»‡ ä¸ºä»€ä¹ˆéœ€è¦ DDDï¼Ÿ ä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨ç®€å•ä¸šåŠ¡åœºæ™¯ä¸‹å¤Ÿç”¨ï¼Œä½†å½“ä¸šåŠ¡å¤æ‚åº¦å¢åŠ æ—¶ï¼Œä¼šå‡ºç°å‡ ä¸ªé—®é¢˜ï¼š\nService å±‚é€»è¾‘è‡ƒè‚¿\næ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å †åœ¨ Service å±‚ï¼Œä¸€ä¸ª OrderService å¯èƒ½æœ‰å‡ åƒè¡Œä»£ç ã€‚\nä¸šåŠ¡è§„åˆ™æ•£è½å„å¤„\nè®¢å•çš„çŠ¶æ€æµè½¬è§„åˆ™å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ª Service æ–¹æ³•ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚\né¢†åŸŸçŸ¥è¯†æµå¤±\nä»£ç ä¸­å……æ–¥ç€ updateStatus(orderId, 3)ï¼Œæ²¡äººçŸ¥é“ 3 ä»£è¡¨ä»€ä¹ˆçŠ¶æ€ã€‚\nDDD é€šè¿‡é¢†åŸŸå»ºæ¨¡ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ï¼Œæå‡å¯ç»´æŠ¤æ€§ã€‚\nDDD æ ¸å¿ƒæ¦‚å¿µ å®ä½“ï¼ˆEntityï¼‰\næœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå†…æ ‡è¯†ä¸å˜ã€‚æ¯”å¦‚è®¢å•ã€ç”¨æˆ·ã€‚\n1public class Order { 2 private OrderId id; // å”¯ä¸€æ ‡è¯† 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 // ä¸šåŠ¡æ–¹æ³• 8 public void pay() { 9 if (this.status != OrderStatus.PENDING_PAYMENT) { 10 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 11 } 12 this.status = OrderStatus.PAID; 13 } 14} å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰\næ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œé€šè¿‡å±æ€§å€¼åˆ¤æ–­ç›¸ç­‰æ€§ã€‚æ¯”å¦‚åœ°å€ã€é‡‘é¢ã€‚\n1public class Money { 2 private final BigDecimal amount; 3 private final Currency currency; 4 5 public Money(BigDecimal amount, Currency currency) { 6 if (amount.compareTo(BigDecimal.ZERO) \u0026lt; 0) { 7 throw new IllegalArgumentException(\u0026#34;é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°\u0026#34;); 8 } 9 this.amount = amount; 10 this.currency = currency; 11 } 12 13 public Money add(Money other) { 14 if (!this.currency.equals(other.currency)) { 15 throw new IllegalArgumentException(\u0026#34;è´§å¸ç±»å‹ä¸ä¸€è‡´\u0026#34;); 16 } 17 return new Money(this.amount.add(other.amount), this.currency); 18 } 19} å€¼å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€æœ‰æ“ä½œéƒ½è¿”å›æ–°å¯¹è±¡ã€‚\nèšåˆæ ¹ï¼ˆAggregate Rootï¼‰\nèšåˆæ˜¯ä¸€ç»„ç›¸å…³å¯¹è±¡çš„é›†åˆï¼Œèšåˆæ ¹æ˜¯èšåˆçš„å…¥å£ã€‚å¤–éƒ¨åªèƒ½é€šè¿‡èšåˆæ ¹è®¿é—®èšåˆå†…çš„å¯¹è±¡ã€‚\n1public class Order { // èšåˆæ ¹ 2 private OrderId id; 3 private List\u0026lt;OrderItem\u0026gt; items; // èšåˆå†…çš„å®ä½“ 4 5 // å¤–éƒ¨ä¸èƒ½ç›´æ¥ä¿®æ”¹ itemsï¼Œå¿…é¡»é€šè¿‡èšåˆæ ¹çš„æ–¹æ³• 6 public void addItem(Product product, int quantity) { 7 OrderItem item = new OrderItem(product, quantity); 8 this.items.add(item); 9 } 10} èšåˆæ ¹çš„ä½œç”¨æ˜¯ä¿æŠ¤èšåˆçš„ä¸å˜æ€§ï¼ˆInvariantï¼‰ã€‚\né¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰\nä¸å±äºä»»ä½•å®ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ”¾åœ¨é¢†åŸŸæœåŠ¡ä¸­ã€‚\n1public class PricingService { 2 3 public Money calculateTotalPrice(Order order) { 4 Money total = Money.zero(); 5 for (OrderItem item : order.getItems()) { 6 Money itemPrice = item.getProduct().getPrice().multiply(item.getQuantity()); 7 total = total.add(itemPrice); 8 } 9 return total; 10 } 11} æ¶æ„æ€è€ƒï¼š å®ä½“å’Œå€¼å¯¹è±¡çš„åŒºåˆ«åœ¨äºæ˜¯å¦æœ‰å”¯ä¸€æ ‡è¯†ã€‚è®¢å•æœ‰è®¢å•å·ï¼Œæ˜¯å®ä½“ï¼›é‡‘é¢æ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œæ˜¯å€¼å¯¹è±¡ã€‚åˆ¤æ–­æ ‡å‡†æ˜¯ï¼šå¦‚æœä¸¤ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§éƒ½ç›¸åŒï¼Œå®ƒä»¬æ˜¯å¦åº”è¯¥è¢«è§†ä¸ºåŒä¸€ä¸ªå¯¹è±¡ï¼Ÿ\né™ç•Œä¸Šä¸‹æ–‡ï¼šåˆ’åˆ†é¢†åŸŸè¾¹ç•Œ ä¸€ä¸ªå¤æ‚ç³»ç»ŸåŒ…å«å¤šä¸ªå­åŸŸï¼Œæ¯ä¸ªå­åŸŸæœ‰è‡ªå·±çš„é¢†åŸŸæ¨¡å‹ã€‚é™ç•Œä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰å®šä¹‰äº†é¢†åŸŸæ¨¡å‹çš„è¾¹ç•Œã€‚\næ¡ˆä¾‹ï¼šç”µå•†ç³»ç»Ÿçš„é™ç•Œä¸Šä¸‹æ–‡\nè®¢å•ä¸Šä¸‹æ–‡ï¼š è®¢å•ã€è®¢å•é¡¹ã€è®¢å•çŠ¶æ€ åº“å­˜ä¸Šä¸‹æ–‡ï¼š å•†å“ã€åº“å­˜ã€åº“å­˜æ‰£å‡ æ”¯ä»˜ä¸Šä¸‹æ–‡ï¼š æ”¯ä»˜å•ã€æ”¯ä»˜æ–¹å¼ã€æ”¯ä»˜çŠ¶æ€ ç‰©æµä¸Šä¸‹æ–‡ï¼š ç‰©æµå•ã€ç‰©æµçŠ¶æ€ã€ç‰©æµå…¬å¸ æ¯ä¸ªä¸Šä¸‹æ–‡æœ‰è‡ªå·±çš„é¢†åŸŸæ¨¡å‹ã€‚æ¯”å¦‚\u0026quot;å•†å“\u0026quot;åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„å«ä¹‰ä¸åŒï¼š\nè®¢å•ä¸Šä¸‹æ–‡ï¼šå•†å“æ˜¯è®¢å•é¡¹çš„ä¸€éƒ¨åˆ†ï¼Œå…³æ³¨å•†å“åç§°ã€ä»·æ ¼ åº“å­˜ä¸Šä¸‹æ–‡ï¼šå•†å“æ˜¯åº“å­˜ç®¡ç†çš„å¯¹è±¡ï¼Œå…³æ³¨åº“å­˜æ•°é‡ã€ä»“åº“ä½ç½® ä¸Šä¸‹æ–‡æ˜ å°„ï¼ˆContext Mappingï¼‰\nä¸åŒä¸Šä¸‹æ–‡ä¹‹é—´éœ€è¦åä½œï¼Œé€šè¿‡ä¸Šä¸‹æ–‡æ˜ å°„å®šä¹‰åä½œæ–¹å¼ï¼š\nå…±äº«å†…æ ¸ï¼ˆShared Kernelï¼‰ï¼š ä¸¤ä¸ªä¸Šä¸‹æ–‡å…±äº«éƒ¨åˆ†é¢†åŸŸæ¨¡å‹ å®¢æˆ·-ä¾›åº”å•†ï¼ˆCustomer-Supplierï¼‰ï¼š ä¸€ä¸ªä¸Šä¸‹æ–‡ä¾èµ–å¦ä¸€ä¸ªä¸Šä¸‹æ–‡ é˜²è…å±‚ï¼ˆAnti-Corruption Layerï¼‰ï¼š é€šè¿‡é€‚é…å™¨éš”ç¦»å¤–éƒ¨ç³»ç»Ÿ æ¡ˆä¾‹ï¼šè®¢å•ä¸Šä¸‹æ–‡ä¾èµ–åº“å­˜ä¸Šä¸‹æ–‡\n1// è®¢å•ä¸Šä¸‹æ–‡ä¸­çš„é˜²è…å±‚ 2public class InventoryAdapter { 3 4 @Autowired 5 private InventoryClient inventoryClient; 6 7 public boolean checkStock(ProductId productId, int quantity) { 8 // è°ƒç”¨åº“å­˜ä¸Šä¸‹æ–‡çš„æ¥å£ 9 InventoryDTO inventory = inventoryClient.getInventory(productId.getValue()); 10 return inventory.getStock() \u0026gt;= quantity; 11 } 12} é˜²è…å±‚çš„ä½œç”¨æ˜¯ï¼šéš”ç¦»å¤–éƒ¨ç³»ç»Ÿçš„å˜åŒ–ï¼Œä¿æŠ¤æœ¬ä¸Šä¸‹æ–‡çš„é¢†åŸŸæ¨¡å‹ã€‚\né¢†åŸŸäº‹ä»¶ï¼šå®ç°æœåŠ¡è§£è€¦ é¢†åŸŸäº‹ä»¶æ˜¯é¢†åŸŸä¸­å‘ç”Ÿçš„é‡è¦äº‹æƒ…ï¼Œæ¯”å¦‚\u0026quot;è®¢å•å·²åˆ›å»º\u0026quot;ã€\u0026ldquo;è®¢å•å·²æ”¯ä»˜\u0026rdquo;ã€‚\nå‘å¸ƒé¢†åŸŸäº‹ä»¶\n1public class Order { 2 3 public void pay() { 4 if (this.status != OrderStatus.PENDING_PAYMENT) { 5 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 6 } 7 this.status = OrderStatus.PAID; 8 9 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ 10 DomainEventPublisher.publish(new OrderPaidEvent(this.id, this.userId)); 11 } 12} ç›‘å¬é¢†åŸŸäº‹ä»¶\n1@Component 2public class OrderEventListener { 3 4 @Autowired 5 private InventoryService inventoryService; 6 7 @EventListener 8 public void handleOrderPaid(OrderPaidEvent event) { 9 // è®¢å•æ”¯ä»˜åï¼Œæ‰£å‡åº“å­˜ 10 inventoryService.deduct(event.getOrderId()); 11 } 12} é¢†åŸŸäº‹ä»¶çš„å¥½å¤„ï¼š\nè§£è€¦ï¼šè®¢å•ä¸Šä¸‹æ–‡ä¸éœ€è¦çŸ¥é“åº“å­˜ä¸Šä¸‹æ–‡çš„å­˜åœ¨ æ‰©å±•æ€§ï¼šæ–°å¢ç›‘å¬å™¨ä¸éœ€è¦ä¿®æ”¹è®¢å•ä»£ç  å®¡è®¡ï¼šäº‹ä»¶æµè®°å½•äº†ç³»ç»Ÿçš„æ‰€æœ‰å˜åŒ– æ¶æ„æ€è€ƒï¼š é¢†åŸŸäº‹ä»¶æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEDAï¼‰çš„åŸºç¡€ã€‚å®ƒè®©ç³»ç»Ÿä»\u0026quot;è°ƒç”¨é©±åŠ¨\u0026quot;å˜æˆ\u0026quot;äº‹ä»¶é©±åŠ¨\u0026quot;ï¼Œæå‡äº†ç³»ç»Ÿçš„æ¾è€¦åˆæ€§ã€‚ç±»ä¼¼çš„æ€æƒ³è¿˜æœ‰ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€å‘å¸ƒè®¢é˜…æ¨¡å¼ã€CQRSã€‚\nDDD åˆ†å±‚æ¶æ„ DDD æ¨èçš„åˆ†å±‚æ¶æ„ï¼š\n1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ ç”¨æˆ·æ¥å£å±‚ï¼ˆUser Interfaceï¼‰ â”‚ Controllerã€DTO 3â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 4â”‚ åº”ç”¨å±‚ï¼ˆApplicationï¼‰ â”‚ ApplicationServiceã€äº‹ä»¶å‘å¸ƒ 5â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 6â”‚ é¢†åŸŸå±‚ï¼ˆDomainï¼‰ â”‚ Entityã€ValueObjectã€DomainService 7â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 8â”‚ åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰ â”‚ Repositoryã€MQã€ç¼“å­˜ 9â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ç”¨æˆ·æ¥å£å±‚\nå¤„ç† HTTP è¯·æ±‚ï¼Œè°ƒç”¨åº”ç”¨å±‚æœåŠ¡ã€‚\n1@RestController 2@RequestMapping(\u0026#34;/orders\u0026#34;) 3public class OrderController { 4 5 @Autowired 6 private OrderApplicationService orderApplicationService; 7 8 @PostMapping 9 public OrderDTO createOrder(@RequestBody CreateOrderRequest request) { 10 OrderId orderId = orderApplicationService.createOrder(request); 11 return orderApplicationService.getOrder(orderId); 12 } 13} åº”ç”¨å±‚\nç¼–æ’é¢†åŸŸå¯¹è±¡ï¼Œå¤„ç†äº‹åŠ¡å’Œäº‹ä»¶å‘å¸ƒã€‚\n1@Service 2public class OrderApplicationService { 3 4 @Autowired 5 private OrderRepository orderRepository; 6 7 @Autowired 8 private DomainEventPublisher eventPublisher; 9 10 @Transactional 11 public OrderId createOrder(CreateOrderRequest request) { 12 // åˆ›å»ºè®¢å•èšåˆ 13 Order order = Order.create(request.getUserId(), request.getItems()); 14 15 // ä¿å­˜è®¢å• 16 orderRepository.save(order); 17 18 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ 19 eventPublisher.publish(new OrderCreatedEvent(order.getId())); 20 21 return order.getId(); 22 } 23} é¢†åŸŸå±‚\næ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨æ¡†æ¶ã€‚\n1public class Order { 2 private OrderId id; 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 public static Order create(UserId userId, List\u0026lt;OrderItem\u0026gt; items) { 8 if (items.isEmpty()) { 9 throw new IllegalArgumentException(\u0026#34;è®¢å•é¡¹ä¸èƒ½ä¸ºç©º\u0026#34;); 10 } 11 Order order = new Order(); 12 order.id = OrderId.generate(); 13 order.userId = userId; 14 order.status = OrderStatus.PENDING_PAYMENT; 15 order.items = items; 16 return order; 17 } 18 19 public void pay() { 20 if (this.status != OrderStatus.PENDING_PAYMENT) { 21 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 22 } 23 this.status = OrderStatus.PAID; 24 } 25} åŸºç¡€è®¾æ–½å±‚\nå®ç°é¢†åŸŸå±‚å®šä¹‰çš„æ¥å£ï¼Œå¤„ç†æŒä¹…åŒ–ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ã€‚\n1@Repository 2public class OrderRepositoryImpl implements OrderRepository { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 @Override 8 public void save(Order order) { 9 OrderPO po = OrderConverter.toPO(order); 10 orderMapper.insert(po); 11 } 12 13 @Override 14 public Order findById(OrderId id) { 15 OrderPO po = orderMapper.selectById(id.getValue()); 16 return OrderConverter.toDomain(po); 17 } 18} é¿å‘æç¤ºï¼š é¢†åŸŸå±‚ä¸åº”è¯¥ä¾èµ–åŸºç¡€è®¾æ–½å±‚ã€‚Repository æ¥å£å®šä¹‰åœ¨é¢†åŸŸå±‚ï¼Œå®ç°åœ¨åŸºç¡€è®¾æ–½å±‚ã€‚è¿™æ˜¯ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰çš„ä½“ç°ã€‚\nDDD çš„é€‚ç”¨åœºæ™¯ DDD ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒé€‚åˆå¤æ‚ä¸šåŠ¡ç³»ç»Ÿï¼Œä¸é€‚åˆç®€å•çš„ CRUD åº”ç”¨ã€‚\né€‚åˆ DDD çš„åœºæ™¯ï¼š\nä¸šåŠ¡è§„åˆ™å¤æ‚ï¼Œéœ€è¦é¢‘ç¹å˜æ›´ å¤šä¸ªå›¢é˜Ÿåä½œå¼€å‘ ç³»ç»Ÿéœ€è¦é•¿æœŸæ¼”è¿› ä¸é€‚åˆ DDD çš„åœºæ™¯ï¼š\nç®€å•çš„å¢åˆ æ”¹æŸ¥ ä¸šåŠ¡é€»è¾‘å¾ˆå°‘ é¡¹ç›®å‘¨æœŸçŸ­ï¼Œä¸éœ€è¦é•¿æœŸç»´æŠ¤ æ€»ç»“ä¸æ€è€ƒ DDD çš„æ ¸å¿ƒæ˜¯ï¼šç”¨ä»£ç è¡¨è¾¾ä¸šåŠ¡è¯­è¨€ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ã€‚\né€šè¿‡å®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹å»ºæ¨¡é¢†åŸŸå¯¹è±¡ é€šè¿‡é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†é¢†åŸŸè¾¹ç•Œ é€šè¿‡é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦ é€šè¿‡åˆ†å±‚æ¶æ„éš”ç¦»ä¸šåŠ¡é€»è¾‘å’ŒæŠ€æœ¯å®ç° DDD ä¸æ˜¯æŠ€æœ¯ï¼Œè€Œæ˜¯æ€ç»´æ–¹å¼ã€‚å®ƒè¦æ±‚å¼€å‘è€…æ·±å…¥ç†è§£ä¸šåŠ¡ï¼Œä¸ä¸šåŠ¡ä¸“å®¶å…±åŒå»ºæ¨¡ã€‚è¿™æ˜¯ä¸€ä¸ªæŒç»­è¿­ä»£çš„è¿‡ç¨‹ã€‚\nä¸‹æ¬¡å½“ä½ çš„ Service å±‚ä»£ç è¶…è¿‡ 500 è¡Œæ—¶ï¼Œä¸å¦¨è¯•è¯• DDDï¼Œé‡æ–°å®¡è§†ä½ çš„é¢†åŸŸæ¨¡å‹ã€‚\n","permalink":"http://localhost:1313/posts/2024/09/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1ddd%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E4%BB%A3%E7%A0%81/","summary":"\u003cp\u003eDDDï¼ˆDomain-Driven Designï¼‰æ˜¯ä¸€å¥—å¤æ‚ä¸šåŠ¡ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•è®ºã€‚ä½†å¾ˆå¤šäººå­¦äº† DDD çš„æ¦‚å¿µï¼Œå´ä¸çŸ¥é“å¦‚ä½•è½åœ°ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªç”µå•†è®¢å•ç³»ç»Ÿçš„æ¡ˆä¾‹ï¼Œè®²è§£ DDD çš„å®æˆ˜åº”ç”¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ DDD çš„æ ¸å¿ƒæ¦‚å¿µï¼šå®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é™ç•Œä¸Šä¸‹æ–‡çš„åˆ’åˆ†æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç”¨é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ DDD åˆ†å±‚æ¶æ„çš„ä»£ç ç»„ç»‡\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦-ddd\"\u003eä¸ºä»€ä¹ˆéœ€è¦ DDDï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨ç®€å•ä¸šåŠ¡åœºæ™¯ä¸‹å¤Ÿç”¨ï¼Œä½†å½“ä¸šåŠ¡å¤æ‚åº¦å¢åŠ æ—¶ï¼Œä¼šå‡ºç°å‡ ä¸ªé—®é¢˜ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eService å±‚é€»è¾‘è‡ƒè‚¿\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å †åœ¨ Service å±‚ï¼Œä¸€ä¸ª OrderService å¯èƒ½æœ‰å‡ åƒè¡Œä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡è§„åˆ™æ•£è½å„å¤„\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eè®¢å•çš„çŠ¶æ€æµè½¬è§„åˆ™å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ª Service æ–¹æ³•ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé¢†åŸŸçŸ¥è¯†æµå¤±\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eä»£ç ä¸­å……æ–¥ç€ \u003ccode\u003eupdateStatus(orderId, 3)\u003c/code\u003eï¼Œæ²¡äººçŸ¥é“ 3 ä»£è¡¨ä»€ä¹ˆçŠ¶æ€ã€‚\u003c/p\u003e\n\u003cp\u003eDDD é€šè¿‡é¢†åŸŸå»ºæ¨¡ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ï¼Œæå‡å¯ç»´æŠ¤æ€§ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"ddd-æ ¸å¿ƒæ¦‚å¿µ\"\u003eDDD æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå®ä½“ï¼ˆEntityï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå†…æ ‡è¯†ä¸å˜ã€‚æ¯”å¦‚è®¢å•ã€ç”¨æˆ·ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å”¯ä¸€æ ‡è¯†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸šåŠ¡æ–¹æ³•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epay\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePENDING_PAYMENT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ethrow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eIllegalStateException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePAID\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eå€¼å¯¹è±¡ï¼ˆValue Objectï¼‰\u003c/strong\u003e\u003c/p\u003e","title":"é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰è½åœ°å®è·µï¼šä»ç†è®ºåˆ°ä»£ç "},{"content":"å®¹å™¨åŒ–å·²ç»æˆä¸ºç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†æ–¹å¼ã€‚Docker è®©åº”ç”¨éƒ¨ç½²å˜å¾—ç®€å•ã€å¯é ã€å¯ç§»æ¤ã€‚æœ¬æ–‡è®²è§£ Docker åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ Dockerfile çš„ç¼–å†™æŠ€å·§ä¸ä¼˜åŒ–æ–¹æ³• ç†è§£ Docker é•œåƒçš„åˆ†å±‚æ„å»ºåŸç† å­¦ä¼šä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒä½“ç§¯ äº†è§£ Docker Compose ç¼–æ’å¤šæœåŠ¡ç¯å¢ƒ ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–ï¼Ÿ ä¼ ç»Ÿéƒ¨ç½²çš„ç—›ç‚¹\nç¯å¢ƒä¸ä¸€è‡´ï¼š\u0026ldquo;åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘\u0026rdquo; ä¾èµ–ç®¡ç†å¤æ‚ï¼šJDKã€Tomcatã€MySQL ç‰ˆæœ¬ä¸ä¸€è‡´ éƒ¨ç½²æµç¨‹ç¹çï¼šæ‰‹åŠ¨ä¸Šä¼ ã€è§£å‹ã€é…ç½®ã€å¯åŠ¨ èµ„æºåˆ©ç”¨ç‡ä½ï¼šä¸€å°æœåŠ¡å™¨åªè·‘ä¸€ä¸ªåº”ç”¨ å®¹å™¨åŒ–çš„ä¼˜åŠ¿\nç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´ å¿«é€Ÿéƒ¨ç½²ï¼šç§’çº§å¯åŠ¨ï¼Œä¸€é”®éƒ¨ç½² èµ„æºéš”ç¦»ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“ æ˜“äºæ‰©å±•ï¼šæ°´å¹³æ‰©å±•åªéœ€å¯åŠ¨æ›´å¤šå®¹å™¨ Dockerfile åŸºç¡€ æœ€ç®€å•çš„ Dockerfile\n1FROM openjdk:11-jre-slim 2COPY app.jar /app.jar 3ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] æ„å»ºé•œåƒ\n1docker build -t myapp:1.0 . è¿è¡Œå®¹å™¨\n1docker run -d -p 8080:8080 myapp:1.0 Dockerfile æœ€ä½³å®è·µ 1. é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ ä¸å¥½çš„åšæ³•\n1FROM ubuntu:20.04 2RUN apt-get update \u0026amp;\u0026amp; apt-get install -y openjdk-11-jdk é•œåƒå¤§å°ï¼š600MB+\nå¥½çš„åšæ³•\n1FROM openjdk:11-jre-slim é•œåƒå¤§å°ï¼š200MB\næ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨ Alpine\n1FROM openjdk:11-jre-alpine é•œåƒå¤§å°ï¼š150MB\né€‰æ‹©åŸåˆ™ï¼š ä¼˜å…ˆä½¿ç”¨å®˜æ–¹é•œåƒï¼Œé€‰æ‹©æœ€å°çš„æ»¡è¶³éœ€æ±‚çš„ç‰ˆæœ¬ï¼ˆslim \u0026gt; alpineï¼‰\n2. åˆ©ç”¨æ„å»ºç¼“å­˜ Docker æ„å»ºé•œåƒæ—¶ï¼Œä¼šç¼“å­˜æ¯ä¸€å±‚ã€‚å¦‚æœæŸä¸€å±‚æ²¡æœ‰å˜åŒ–ï¼Œä¼šç›´æ¥ä½¿ç”¨ç¼“å­˜ã€‚\nä¸å¥½çš„åšæ³•\n1FROM openjdk:11-jre-slim 2COPY . /app 3RUN cd /app \u0026amp;\u0026amp; ./mvnw clean package æ¯æ¬¡ä»£ç å˜åŒ–ï¼Œéƒ½è¦é‡æ–°ä¸‹è½½ä¾èµ–ã€‚\nå¥½çš„åšæ³•ï¼šåˆ†ç¦»ä¾èµ–å’Œä»£ç \n1FROM openjdk:11-jre-slim 2 3# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ 4COPY pom.xml /app/ 5COPY mvnw /app/ 6COPY .mvn /app/.mvn 7WORKDIR /app 8RUN ./mvnw dependency:go-offline 9 10# å†å¤åˆ¶ä»£ç  11COPY src /app/src 12RUN ./mvnw clean package -DskipTests 13 14ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app/target/app.jar\u0026#34;] è¿™æ ·ï¼Œåªæœ‰ pom.xml å˜åŒ–æ—¶æ‰ä¼šé‡æ–°ä¸‹è½½ä¾èµ–ã€‚\n3. å¤šé˜¶æ®µæ„å»º é—®é¢˜ï¼š æ„å»ºå·¥å…·ï¼ˆMavenã€Gradleï¼‰ä¼šå¢åŠ é•œåƒä½“ç§¯ã€‚\nè§£å†³æ–¹æ¡ˆï¼š ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œåªä¿ç•™è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶ã€‚\n1# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º 2FROM maven:3.8-openjdk-11 AS builder 3WORKDIR /app 4COPY pom.xml . 5RUN mvn dependency:go-offline 6COPY src ./src 7RUN mvn clean package -DskipTests 8 9# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ 10FROM openjdk:11-jre-slim 11WORKDIR /app 12COPY --from=builder /app/target/app.jar . 13EXPOSE 8080 14ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;app.jar\u0026#34;] æ•ˆæœï¼š\næ„å»ºé˜¶æ®µé•œåƒï¼š800MB æœ€ç»ˆé•œåƒï¼š200MB 4. å‡å°‘é•œåƒå±‚æ•° ä¸å¥½çš„åšæ³•\n1RUN apt-get update 2RUN apt-get install -y curl 3RUN apt-get install -y vim 4RUN apt-get clean æ¯ä¸ª RUN éƒ½ä¼šåˆ›å»ºä¸€å±‚ï¼Œå¢åŠ é•œåƒä½“ç§¯ã€‚\nå¥½çš„åšæ³•ï¼šåˆå¹¶å‘½ä»¤\n1RUN apt-get update \u0026amp;\u0026amp; \\ 2 apt-get install -y curl vim \u0026amp;\u0026amp; \\ 3 apt-get clean \u0026amp;\u0026amp; \\ 4 rm -rf /var/lib/apt/lists/* 5. ä½¿ç”¨ .dockerignore ç±»ä¼¼ .gitignoreï¼Œé¿å…å°†ä¸å¿…è¦çš„æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­ã€‚\n1# .dockerignore 2target/ 3*.log 4.git/ 5.idea/ 6*.md 6. ä¸è¦åœ¨å®¹å™¨ä¸­å­˜å‚¨æ•°æ® å®¹å™¨æ˜¯ä¸´æ—¶çš„ï¼Œæ•°æ®åº”è¯¥å­˜å‚¨åœ¨å¤–éƒ¨ã€‚\nä½¿ç”¨ Volume æŒ‚è½½æ•°æ®\n1docker run -d -v /data/mysql:/var/lib/mysql mysql:8.0 ä½¿ç”¨å‘½åå·\n1docker volume create mysql-data 2docker run -d -v mysql-data:/var/lib/mysql mysql:8.0 7. å¥åº·æ£€æŸ¥ 1FROM openjdk:11-jre-slim 2COPY app.jar /app.jar 3 4HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \\ 5 CMD curl -f http://localhost:8080/actuator/health || exit 1 6 7ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] Docker ä¼šå®šæœŸæ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€ï¼Œä¸å¥åº·çš„å®¹å™¨ä¼šè¢«é‡å¯ã€‚\n8. ä½¿ç”¨é root ç”¨æˆ· å®‰å…¨é£é™©ï¼š é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨å†…çš„è¿›ç¨‹ä»¥ root ç”¨æˆ·è¿è¡Œã€‚\nè§£å†³æ–¹æ¡ˆï¼š åˆ›å»ºæ™®é€šç”¨æˆ·\n1FROM openjdk:11-jre-slim 2 3# åˆ›å»ºç”¨æˆ· 4RUN groupadd -r appuser \u0026amp;\u0026amp; useradd -r -g appuser appuser 5 6# å¤åˆ¶æ–‡ä»¶ 7COPY app.jar /app.jar 8RUN chown appuser:appuser /app.jar 9 10# åˆ‡æ¢ç”¨æˆ· 11USER appuser 12 13ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] ä¼˜åŒ– Spring Boot åº”ç”¨çš„ Dockerfile å®Œæ•´ç¤ºä¾‹\n1# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º 2FROM maven:3.8-openjdk-11-slim AS builder 3WORKDIR /build 4 5# å¤åˆ¶ä¾èµ–æ–‡ä»¶ 6COPY pom.xml . 7COPY .mvn .mvn 8COPY mvnw . 9RUN ./mvnw dependency:go-offline -B 10 11# å¤åˆ¶æºç å¹¶æ„å»º 12COPY src src 13RUN ./mvnw package -DskipTests -B 14 15# è§£å‹ jar åŒ…ï¼ˆåˆ©ç”¨ Spring Boot çš„åˆ†å±‚ç‰¹æ€§ï¼‰ 16RUN mkdir -p target/dependency \u0026amp;\u0026amp; \\ 17 cd target/dependency \u0026amp;\u0026amp; \\ 18 jar -xf ../*.jar 19 20# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ 21FROM openjdk:11-jre-slim 22WORKDIR /app 23 24# åˆ›å»ºé root ç”¨æˆ· 25RUN groupadd -r spring \u0026amp;\u0026amp; useradd -r -g spring spring 26 27# åˆ†å±‚å¤åˆ¶ï¼ˆåˆ©ç”¨ Docker ç¼“å­˜ï¼‰ 28COPY --from=builder /build/target/dependency/BOOT-INF/lib /app/lib 29COPY --from=builder /build/target/dependency/META-INF /app/META-INF 30COPY --from=builder /build/target/dependency/BOOT-INF/classes /app 31 32# ä¿®æ”¹æ‰€æœ‰è€… 33RUN chown -R spring:spring /app 34 35# åˆ‡æ¢ç”¨æˆ· 36USER spring 37 38# å¥åº·æ£€æŸ¥ 39HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \\ 40 CMD curl -f http://localhost:8080/actuator/health || exit 1 41 42# å¯åŠ¨åº”ç”¨ 43ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-cp\u0026#34;, \u0026#34;/app:/app/lib/*\u0026#34;, \u0026#34;com.example.Application\u0026#34;] ä¼˜åŒ–æ•ˆæœï¼š\nåˆ©ç”¨åˆ†å±‚ç¼“å­˜ï¼Œä¾èµ–å˜åŒ–æ—¶ä¸éœ€è¦é‡æ–°æ„å»ºæ•´ä¸ªåº”ç”¨ ä½¿ç”¨é root ç”¨æˆ·ï¼Œæå‡å®‰å…¨æ€§ æ·»åŠ å¥åº·æ£€æŸ¥ï¼Œæå‡å¯é æ€§ Docker Composeï¼šç¼–æ’å¤šæœåŠ¡ åœºæ™¯ï¼š åº”ç”¨éœ€è¦ MySQLã€Redisã€Nginx\ndocker-compose.yml\n1version: \u0026#39;3.8\u0026#39; 2 3services: 4 # MySQL æ•°æ®åº“ 5 mysql: 6 image: mysql:8.0 7 container_name: mysql 8 environment: 9 MYSQL_ROOT_PASSWORD: root123 10 MYSQL_DATABASE: myapp 11 volumes: 12 - mysql-data:/var/lib/mysql 13 ports: 14 - \u0026#34;3306:3306\u0026#34; 15 networks: 16 - app-network 17 healthcheck: 18 test: [\u0026#34;CMD\u0026#34;, \u0026#34;mysqladmin\u0026#34;, \u0026#34;ping\u0026#34;, \u0026#34;-h\u0026#34;, \u0026#34;localhost\u0026#34;] 19 interval: 10s 20 timeout: 5s 21 retries: 5 22 23 # Redis ç¼“å­˜ 24 redis: 25 image: redis:7-alpine 26 container_name: redis 27 ports: 28 - \u0026#34;6379:6379\u0026#34; 29 networks: 30 - app-network 31 healthcheck: 32 test: [\u0026#34;CMD\u0026#34;, \u0026#34;redis-cli\u0026#34;, \u0026#34;ping\u0026#34;] 33 interval: 10s 34 timeout: 3s 35 retries: 5 36 37 # Spring Boot åº”ç”¨ 38 app: 39 build: 40 context: . 41 dockerfile: Dockerfile 42 container_name: myapp 43 environment: 44 SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/myapp 45 SPRING_REDIS_HOST: redis 46 ports: 47 - \u0026#34;8080:8080\u0026#34; 48 depends_on: 49 mysql: 50 condition: service_healthy 51 redis: 52 condition: service_healthy 53 networks: 54 - app-network 55 restart: unless-stopped 56 57 # Nginx åå‘ä»£ç† 58 nginx: 59 image: nginx:alpine 60 container_name: nginx 61 volumes: 62 - ./nginx.conf:/etc/nginx/nginx.conf:ro 63 ports: 64 - \u0026#34;80:80\u0026#34; 65 depends_on: 66 - app 67 networks: 68 - app-network 69 70volumes: 71 mysql-data: 72 73networks: 74 app-network: 75 driver: bridge å¯åŠ¨æ‰€æœ‰æœåŠ¡\n1docker-compose up -d æŸ¥çœ‹æ—¥å¿—\n1docker-compose logs -f app åœæ­¢æ‰€æœ‰æœåŠ¡\n1docker-compose down ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² 1. ä½¿ç”¨ç¯å¢ƒå˜é‡ ä¸è¦åœ¨é•œåƒä¸­ç¡¬ç¼–ç é…ç½®\n1# ä¸å¥½ 2ENV SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/myapp ä½¿ç”¨ç¯å¢ƒå˜é‡\n1docker run -d \\ 2 -e SPRING_DATASOURCE_URL=jdbc:mysql://prod-mysql:3306/myapp \\ 3 -e SPRING_DATASOURCE_PASSWORD=prod_password \\ 4 myapp:1.0 2. èµ„æºé™åˆ¶ 1docker run -d \\ 2 --memory=\u0026#34;512m\u0026#34; \\ 3 --cpus=\u0026#34;1.0\u0026#34; \\ 4 myapp:1.0 3. æ—¥å¿—ç®¡ç† ä½¿ç”¨æ—¥å¿—é©±åŠ¨\n1docker run -d \\ 2 --log-driver=json-file \\ 3 --log-opt max-size=10m \\ 4 --log-opt max-file=3 \\ 5 myapp:1.0 4. è‡ªåŠ¨é‡å¯ 1docker run -d --restart=unless-stopped myapp:1.0 é‡å¯ç­–ç•¥ï¼š\nnoï¼šä¸è‡ªåŠ¨é‡å¯ï¼ˆé»˜è®¤ï¼‰ on-failureï¼šå¤±è´¥æ—¶é‡å¯ alwaysï¼šæ€»æ˜¯é‡å¯ unless-stoppedï¼šé™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™æ€»æ˜¯é‡å¯ CI/CD é›†æˆ GitLab CI ç¤ºä¾‹\n1# .gitlab-ci.yml 2stages: 3 - build 4 - deploy 5 6build: 7 stage: build 8 script: 9 - docker build -t myapp:$CI_COMMIT_SHA . 10 - docker tag myapp:$CI_COMMIT_SHA myapp:latest 11 - docker push myapp:$CI_COMMIT_SHA 12 - docker push myapp:latest 13 14deploy: 15 stage: deploy 16 script: 17 - docker pull myapp:$CI_COMMIT_SHA 18 - docker stop myapp || true 19 - docker rm myapp || true 20 - docker run -d --name myapp -p 8080:8080 myapp:$CI_COMMIT_SHA 21 only: 22 - main å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ 1. å®¹å™¨æ—¶åŒºé—®é¢˜ 1FROM openjdk:11-jre-slim 2ENV TZ=Asia/Shanghai 3RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \u0026amp;\u0026amp; echo $TZ \u0026gt; /etc/timezone 2. å®¹å™¨å†…æ— æ³•è®¿é—®å®¿ä¸»æœºæœåŠ¡ ä½¿ç”¨ host.docker.internalï¼ˆMac/Windowsï¼‰æˆ– 172.17.0.1ï¼ˆLinuxï¼‰\n1environment: 2 SPRING_DATASOURCE_URL: jdbc:mysql://host.docker.internal:3306/myapp 3. é•œåƒæ„å»ºæ…¢ ä½¿ç”¨å›½å†…é•œåƒæº åˆ©ç”¨æ„å»ºç¼“å­˜ ä½¿ç”¨å¤šé˜¶æ®µæ„å»º 4. å®¹å™¨å†…å­˜æº¢å‡º è®¾ç½® JVM å‚æ•°ï¼š\n1ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-Xmx512m\u0026#34;, \u0026#34;-Xms512m\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] æ€»ç»“ä¸æ€è€ƒ Docker å®¹å™¨åŒ–çš„æ ¸å¿ƒè¦ç‚¹ï¼š\né€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒï¼Œå‡å°‘é•œåƒä½“ç§¯ åˆ©ç”¨æ„å»ºç¼“å­˜å’Œå¤šé˜¶æ®µæ„å»ºï¼Œæå‡æ„å»ºé€Ÿåº¦ ä½¿ç”¨é root ç”¨æˆ·ï¼Œæå‡å®‰å…¨æ€§ ä½¿ç”¨ Docker Compose ç¼–æ’å¤šæœåŠ¡ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾ç½®èµ„æºé™åˆ¶å’Œå¥åº·æ£€æŸ¥ å®¹å™¨åŒ–ä¸ä»…ä»…æ˜¯æŠ€æœ¯ï¼Œæ›´æ˜¯ä¸€ç§æ€ç»´æ–¹å¼ã€‚å®ƒè®©æˆ‘ä»¬é‡æ–°æ€è€ƒåº”ç”¨çš„éƒ¨ç½²å’Œè¿ç»´æ–¹å¼ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦éƒ¨ç½²åº”ç”¨æ—¶ï¼Œä¸å¦¨è¯•è¯• Dockerï¼Œä½“éªŒå®¹å™¨åŒ–å¸¦æ¥çš„ä¾¿åˆ©ã€‚\n","permalink":"http://localhost:1313/posts/2024/09/docker-%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%BB%8E-dockerfile-%E5%88%B0%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83/","summary":"\u003cp\u003eå®¹å™¨åŒ–å·²ç»æˆä¸ºç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†æ–¹å¼ã€‚Docker è®©åº”ç”¨éƒ¨ç½²å˜å¾—ç®€å•ã€å¯é ã€å¯ç§»æ¤ã€‚æœ¬æ–‡è®²è§£ Docker åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Dockerfile çš„ç¼–å†™æŠ€å·§ä¸ä¼˜åŒ–æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Docker é•œåƒçš„åˆ†å±‚æ„å»ºåŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒä½“ç§¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ Docker Compose ç¼–æ’å¤šæœåŠ¡ç¯å¢ƒ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–\"\u003eä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿéƒ¨ç½²çš„ç—›ç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eç¯å¢ƒä¸ä¸€è‡´ï¼š\u0026ldquo;åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘\u0026rdquo;\u003c/li\u003e\n\u003cli\u003eä¾èµ–ç®¡ç†å¤æ‚ï¼šJDKã€Tomcatã€MySQL ç‰ˆæœ¬ä¸ä¸€è‡´\u003c/li\u003e\n\u003cli\u003eéƒ¨ç½²æµç¨‹ç¹çï¼šæ‰‹åŠ¨ä¸Šä¼ ã€è§£å‹ã€é…ç½®ã€å¯åŠ¨\u003c/li\u003e\n\u003cli\u003eèµ„æºåˆ©ç”¨ç‡ä½ï¼šä¸€å°æœåŠ¡å™¨åªè·‘ä¸€ä¸ªåº”ç”¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eå®¹å™¨åŒ–çš„ä¼˜åŠ¿\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´\u003c/li\u003e\n\u003cli\u003eå¿«é€Ÿéƒ¨ç½²ï¼šç§’çº§å¯åŠ¨ï¼Œä¸€é”®éƒ¨ç½²\u003c/li\u003e\n\u003cli\u003eèµ„æºéš”ç¦»ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“\u003c/li\u003e\n\u003cli\u003eæ˜“äºæ‰©å±•ï¼šæ°´å¹³æ‰©å±•åªéœ€å¯åŠ¨æ›´å¤šå®¹å™¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"dockerfile-åŸºç¡€\"\u003eDockerfile åŸºç¡€\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eæœ€ç®€å•çš„ Dockerfile\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dockerfile\" data-lang=\"dockerfile\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eopenjdk:11-jre-slim\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCOPY\u003c/span\u003e app.jar /app.jar\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eENTRYPOINT\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;java\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;-jar\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/app.jar\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ„å»ºé•œåƒ\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003edocker build -t myapp:1.0 .\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eè¿è¡Œå®¹å™¨\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003edocker run -d -p 8080:8080 myapp:1.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"dockerfile-æœ€ä½³å®è·µ\"\u003eDockerfile æœ€ä½³å®è·µ\u003c/h2\u003e\n\u003ch3 id=\"1-é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ\"\u003e1. é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¸å¥½çš„åšæ³•\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dockerfile\" data-lang=\"dockerfile\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eubuntu:20.04\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eRUN\u003c/span\u003e apt-get update \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e apt-get install -y openjdk-11-jdk\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé•œåƒå¤§å°ï¼š600MB+\u003c/p\u003e","title":"Docker å®¹å™¨åŒ–éƒ¨ç½²æœ€ä½³å®è·µï¼šä» Dockerfile åˆ°ç”Ÿäº§ç¯å¢ƒ"},{"content":"åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å®ä¾‹å¯èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œéœ€è¦åˆ†å¸ƒå¼é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚Redis æ˜¯å®ç°åˆ†å¸ƒå¼é”çš„å¸¸ç”¨æ–¹æ¡ˆï¼Œä½†å¾ˆå¤šäººåªä¼šç”¨ SETNXï¼Œä¸çŸ¥é“å…¶ä¸­çš„å‘ã€‚æœ¬æ–‡æ·±å…¥å‰–æ Redis åˆ†å¸ƒå¼é”çš„å®ç°ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Redis åˆ†å¸ƒå¼é”çš„å®ç°åŸç†ä¸å¸¸è§é—®é¢˜ æŒæ¡ Redisson çœ‹é—¨ç‹—æœºåˆ¶çš„è®¾è®¡æ€æƒ³ å­¦ä¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„é”ä¼˜åŒ–æ–¹æ¡ˆ äº†è§£åˆ†å¸ƒå¼é”çš„æœ€ä½³å®è·µ ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ åœºæ™¯ä¸€ï¼šåº“å­˜æ‰£å‡\n1// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰åŠ é” 2public void deductStock(Long productId, int quantity) { 3 Stock stock = stockMapper.selectById(productId); 4 if (stock.getQuantity() \u0026gt;= quantity) { 5 stock.setQuantity(stock.getQuantity() - quantity); 6 stockMapper.updateById(stock); 7 } 8} åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–åº“å­˜ï¼Œå¯èƒ½å¯¼è‡´è¶…å–ã€‚\nåœºæ™¯äºŒï¼šå®šæ—¶ä»»åŠ¡å»é‡\nå¤šä¸ªæœåŠ¡å®ä¾‹éƒ¨ç½²æ—¶ï¼Œå®šæ—¶ä»»åŠ¡ä¼šé‡å¤æ‰§è¡Œï¼Œéœ€è¦åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œã€‚\nåŸºç¡€å®ç°ï¼šSETNX + EXPIRE ç‰ˆæœ¬ä¸€ï¼šæœ€ç®€å•çš„å®ç°\n1public boolean tryLock(String key) { 2 return redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;); 3} 4 5public void unlock(String key) { 6 redisTemplate.delete(key); 7} é—®é¢˜ï¼šå¦‚æœè·å–é”åï¼ŒæœåŠ¡å®•æœºï¼Œé”æ°¸è¿œä¸ä¼šé‡Šæ”¾ï¼Œå¯¼è‡´æ­»é”ã€‚\nç‰ˆæœ¬äºŒï¼šåŠ ä¸Šè¿‡æœŸæ—¶é—´\n1public boolean tryLock(String key, long expireTime) { 2 Boolean result = redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;); 3 if (result) { 4 redisTemplate.expire(key, expireTime, TimeUnit.SECONDS); 5 } 6 return result; 7} é—®é¢˜ï¼šSETNX å’Œ EXPIRE ä¸æ˜¯åŸå­æ“ä½œï¼Œå¦‚æœåœ¨ä¸¤è€…ä¹‹é—´å®•æœºï¼Œä»ç„¶ä¼šæ­»é”ã€‚\nç‰ˆæœ¬ä¸‰ï¼šåŸå­æ“ä½œ\n1public boolean tryLock(String key, long expireTime) { 2 return redisTemplate.opsForValue() 3 .setIfAbsent(key, \u0026#34;1\u0026#34;, expireTime, TimeUnit.SECONDS); 4} Redis 2.6.12 ä¹‹åï¼ŒSET å‘½ä»¤æ”¯æŒ NX å’Œ EX å‚æ•°ï¼Œä¿è¯åŸå­æ€§ã€‚\n1SET lock_key unique_value NX EX 30 NXï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶è®¾ç½® EXï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ è¿›é˜¶é—®é¢˜ï¼šé”è¯¯åˆ  é—®é¢˜åœºæ™¯\n11. çº¿ç¨‹ A è·å–é”ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ 30 ç§’ 22. çº¿ç¨‹ A æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œè€—æ—¶ 35 ç§’ 33. 30 ç§’åï¼Œé”è‡ªåŠ¨è¿‡æœŸï¼Œçº¿ç¨‹ B è·å–é” 44. çº¿ç¨‹ A æ‰§è¡Œå®Œæ¯•ï¼Œåˆ é™¤é”ï¼ˆè¯¯åˆ äº†çº¿ç¨‹ B çš„é”ï¼‰ è§£å†³æ–¹æ¡ˆï¼šé”çš„å”¯ä¸€æ ‡è¯†\n1public boolean tryLock(String key, String requestId, long expireTime) { 2 return redisTemplate.opsForValue() 3 .setIfAbsent(key, requestId, expireTime, TimeUnit.SECONDS); 4} 5 6public void unlock(String key, String requestId) { 7 String value = redisTemplate.opsForValue().get(key); 8 if (requestId.equals(value)) { 9 redisTemplate.delete(key); 10 } 11} æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å”¯ä¸€çš„ requestIdï¼ˆå¦‚ UUIDï¼‰ï¼Œé‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„é”ã€‚\nä½†è¿™é‡Œä»æœ‰é—®é¢˜ï¼šGET å’Œ DELETE ä¸æ˜¯åŸå­æ“ä½œã€‚\nLua è„šæœ¬ä¿è¯åŸå­æ€§\n1public void unlock(String key, String requestId) { 2 String script = 3 \u0026#34;if redis.call(\u0026#39;get\u0026#39;, KEYS[1]) == ARGV[1] then \u0026#34; + 4 \u0026#34; return redis.call(\u0026#39;del\u0026#39;, KEYS[1]) \u0026#34; + 5 \u0026#34;else \u0026#34; + 6 \u0026#34; return 0 \u0026#34; + 7 \u0026#34;end\u0026#34;; 8 9 redisTemplate.execute( 10 new DefaultRedisScript\u0026lt;\u0026gt;(script, Long.class), 11 Collections.singletonList(key), 12 requestId 13 ); 14} Lua è„šæœ¬åœ¨ Redis ä¸­æ˜¯åŸå­æ‰§è¡Œçš„ï¼Œä¿è¯äº†åˆ¤æ–­å’Œåˆ é™¤çš„åŸå­æ€§ã€‚\næ¶æ„æ€è€ƒï¼š åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒé—®é¢˜æ˜¯\u0026quot;åŸå­æ€§\u0026quot;ã€‚SETNX + EXPIRE ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦ç”¨ SET NX EXï¼›GET + DELETE ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦ç”¨ Lua è„šæœ¬ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šåœºæ™¯éƒ½é€‚ç”¨ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚\nRedissonï¼šç”Ÿäº§çº§çš„åˆ†å¸ƒå¼é” Redisson æ˜¯ Redis å®˜æ–¹æ¨èçš„ Java å®¢æˆ·ç«¯ï¼Œæä¾›äº†å¼€ç®±å³ç”¨çš„åˆ†å¸ƒå¼é”ã€‚\nåŸºæœ¬ä½¿ç”¨\n1@Autowired 2private RedissonClient redissonClient; 3 4public void doSomething() { 5 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 6 try { 7 // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾… 10 ç§’ï¼Œé”è‡ªåŠ¨è¿‡æœŸæ—¶é—´ 30 ç§’ 8 boolean isLocked = lock.tryLock(10, 30, TimeUnit.SECONDS); 9 if (isLocked) { 10 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 11 } 12 } catch (InterruptedException e) { 13 Thread.currentThread().interrupt(); 14 } finally { 15 lock.unlock(); 16 } 17} çœ‹é—¨ç‹—æœºåˆ¶ï¼ˆWatchdogï¼‰\nå¦‚æœä¸æŒ‡å®šé”çš„è¿‡æœŸæ—¶é—´ï¼ŒRedisson ä¼šå¯åŠ¨çœ‹é—¨ç‹—æœºåˆ¶ï¼š\n1lock.lock(); // é»˜è®¤è¿‡æœŸæ—¶é—´ 30 ç§’ çœ‹é—¨ç‹—ä¼šæ¯éš” 10 ç§’ï¼ˆè¿‡æœŸæ—¶é—´çš„ 1/3ï¼‰æ£€æŸ¥é”æ˜¯å¦è¿˜è¢«æŒæœ‰ï¼Œå¦‚æœæ˜¯ï¼Œè‡ªåŠ¨ç»­æœŸ 30 ç§’ã€‚\nçœ‹é—¨ç‹—çš„å®ç°åŸç†\n1private void scheduleExpirationRenewal(long threadId) { 2 ExpirationEntry entry = new ExpirationEntry(); 3 ExpirationEntry oldEntry = EXPIRATION_RENEWAL_MAP.putIfAbsent(getEntryName(), entry); 4 5 if (oldEntry != null) { 6 oldEntry.addThreadId(threadId); 7 } else { 8 entry.addThreadId(threadId); 9 renewExpiration(); 10 } 11} 12 13private void renewExpiration() { 14 ExpirationEntry ee = EXPIRATION_RENEWAL_MAP.get(getEntryName()); 15 if (ee == null) { 16 return; 17 } 18 19 Timeout task = commandExecutor.getConnectionManager().newTimeout(timeout -\u0026gt; { 20 // ç»­æœŸé” 21 RFuture\u0026lt;Boolean\u0026gt; future = renewExpirationAsync(threadId); 22 future.onComplete((res, e) -\u0026gt; { 23 if (e != null) { 24 return; 25 } 26 if (res) { 27 // ç»­æœŸæˆåŠŸï¼Œç»§ç»­è°ƒåº¦ä¸‹ä¸€æ¬¡ç»­æœŸ 28 renewExpiration(); 29 } 30 }); 31 }, internalLockLeaseTime / 3, TimeUnit.MILLISECONDS); 32 33 ee.setTimeout(task); 34} çœ‹é—¨ç‹—çš„å¥½å¤„ï¼š\né¿å…ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”è¿‡æœŸ é¿å…æ‰‹åŠ¨è®¾ç½®è¿‡æœŸæ—¶é—´ä¸å‡†ç¡® é¿å‘æç¤ºï¼š çœ‹é—¨ç‹—åªåœ¨æœªæŒ‡å®šè¿‡æœŸæ—¶é—´æ—¶ç”Ÿæ•ˆã€‚å¦‚æœä½ è°ƒç”¨ lock.tryLock(10, 30, TimeUnit.SECONDS)ï¼Œçœ‹é—¨ç‹—ä¸ä¼šå¯åŠ¨ï¼Œé”ä¼šåœ¨ 30 ç§’åè‡ªåŠ¨è¿‡æœŸã€‚\nå¯é‡å…¥é” Redisson çš„é”æ˜¯å¯é‡å…¥çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”ã€‚\n1public void methodA() { 2 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 3 lock.lock(); 4 try { 5 methodB(); // å¯ä»¥å†æ¬¡è·å–é” 6 } finally { 7 lock.unlock(); 8 } 9} 10 11public void methodB() { 12 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 13 lock.lock(); 14 try { 15 // ä¸šåŠ¡é€»è¾‘ 16 } finally { 17 lock.unlock(); 18 } 19} å®ç°åŸç†ï¼šHash ç»“æ„\n1HSET myLock thread-1 1 # ç¬¬ä¸€æ¬¡åŠ é” 2HINCRBY myLock thread-1 1 # ç¬¬äºŒæ¬¡åŠ é”ï¼Œè®¡æ•°å™¨ +1 é‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°å™¨ -1ï¼Œåªæœ‰è®¡æ•°å™¨ä¸º 0 æ—¶æ‰çœŸæ­£é‡Šæ”¾é”ã€‚\né«˜å¹¶å‘ä¼˜åŒ–ï¼šåˆ†æ®µé” åœ¨ç§’æ€åœºæ™¯ä¸‹ï¼Œæ‰€æœ‰è¯·æ±‚ç«äº‰åŒä¸€æŠŠé”ï¼Œæ€§èƒ½å¾ˆå·®ã€‚å¯ä»¥ä½¿ç”¨åˆ†æ®µé”ä¼˜åŒ–ã€‚\nåœºæ™¯ï¼šåº“å­˜æ‰£å‡\n1public void deductStock(Long productId, int quantity) { 2 // æ ¹æ®å•†å“ ID åˆ†æ®µ 3 int segment = (int) (productId % 10); 4 String lockKey = \u0026#34;stock_lock:\u0026#34; + productId + \u0026#34;:\u0026#34; + segment; 5 6 RLock lock = redissonClient.getLock(lockKey); 7 lock.lock(); 8 try { 9 // æ‰£å‡åº“å­˜ 10 Stock stock = stockMapper.selectById(productId); 11 if (stock.getQuantity() \u0026gt;= quantity) { 12 stock.setQuantity(stock.getQuantity() - quantity); 13 stockMapper.updateById(stock); 14 } 15 } finally { 16 lock.unlock(); 17 } 18} å°†åº“å­˜åˆ†æˆ 10 æ®µï¼Œæ¯æ®µç‹¬ç«‹åŠ é”ï¼Œæå‡å¹¶å‘åº¦ã€‚\nè¯»å†™é”\nå¦‚æœè¯»å¤šå†™å°‘ï¼Œå¯ä»¥ä½¿ç”¨è¯»å†™é”ï¼š\n1RReadWriteLock rwLock = redissonClient.getReadWriteLock(\u0026#34;myLock\u0026#34;); 2 3// è¯»é”ï¼ˆå…±äº«é”ï¼‰ 4RLock readLock = rwLock.readLock(); 5readLock.lock(); 6try { 7 // è¯»æ“ä½œ 8} finally { 9 readLock.unlock(); 10} 11 12// å†™é”ï¼ˆæ’ä»–é”ï¼‰ 13RLock writeLock = rwLock.writeLock(); 14writeLock.lock(); 15try { 16 // å†™æ“ä½œ 17} finally { 18 writeLock.unlock(); 19} å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰è¯»é”ï¼Œä½†å†™é”æ˜¯æ’ä»–çš„ã€‚\nçº¢é”ï¼ˆRedLockï¼‰ï¼šå¤šèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é” å•èŠ‚ç‚¹ Redis å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ï¼ŒRedLock é€šè¿‡å¤šä¸ªç‹¬ç«‹çš„ Redis èŠ‚ç‚¹å®ç°é«˜å¯ç”¨ã€‚\nRedLock ç®—æ³•\nè·å–å½“å‰æ—¶é—´æˆ³ ä¾æ¬¡å‘ N ä¸ª Redis èŠ‚ç‚¹è¯·æ±‚åŠ é” å¦‚æœè¶…è¿‡åŠæ•°èŠ‚ç‚¹åŠ é”æˆåŠŸï¼Œä¸”æ€»è€—æ—¶å°äºé”çš„è¿‡æœŸæ—¶é—´ï¼Œåˆ™è®¤ä¸ºåŠ é”æˆåŠŸ å¦‚æœåŠ é”å¤±è´¥ï¼Œå‘æ‰€æœ‰èŠ‚ç‚¹é‡Šæ”¾é” Redisson å®ç°\n1RLock lock1 = redissonClient1.getLock(\u0026#34;myLock\u0026#34;); 2RLock lock2 = redissonClient2.getLock(\u0026#34;myLock\u0026#34;); 3RLock lock3 = redissonClient3.getLock(\u0026#34;myLock\u0026#34;); 4 5RedissonRedLock redLock = new RedissonRedLock(lock1, lock2, lock3); 6redLock.lock(); 7try { 8 // ä¸šåŠ¡é€»è¾‘ 9} finally { 10 redLock.unlock(); 11} RedLock çš„äº‰è®®ï¼š\nMartin Kleppmann è®¤ä¸º RedLock ä¸å®‰å…¨ï¼ˆæ—¶é’Ÿæ¼‚ç§»é—®é¢˜ï¼‰ Redis ä½œè€… Antirez è®¤ä¸º RedLock åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹å¤Ÿç”¨ å®é™…ç”Ÿäº§ä¸­ï¼Œå•èŠ‚ç‚¹ + ä¸»ä»å¤åˆ¶ + å“¨å…µæ¨¡å¼å·²ç»è¶³å¤Ÿã€‚\næœ€ä½³å®è·µ 1. è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´\nè¿‡æœŸæ—¶é—´å¤ªçŸ­ï¼Œä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œé”å°±è¿‡æœŸäº†ï¼›è¿‡æœŸæ—¶é—´å¤ªé•¿ï¼Œå®•æœºåé”é•¿æ—¶é—´ä¸é‡Šæ”¾ã€‚\nå»ºè®®ï¼šæ ¹æ®ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è®¾ç½®ï¼Œæˆ–ä½¿ç”¨ Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶ã€‚\n2. ä½¿ç”¨ try-finally é‡Šæ”¾é”\n1lock.lock(); 2try { 3 // ä¸šåŠ¡é€»è¾‘ 4} finally { 5 lock.unlock(); 6} 3. é¿å…é•¿æ—¶é—´æŒæœ‰é”\né”çš„ç²’åº¦è¦å°½é‡å°ï¼Œåªé”å¿…è¦çš„ä»£ç å—ã€‚\n1// ä¸å¥½ï¼šé”çš„ç²’åº¦å¤ªå¤§ 2lock.lock(); 3try { 4 queryDatabase(); // è€—æ—¶æ“ä½œ 5 updateCache(); 6 sendMessage(); 7} finally { 8 lock.unlock(); 9} 10 11// å¥½ï¼šåªé”å¿…è¦çš„ä»£ç  12queryDatabase(); 13lock.lock(); 14try { 15 updateCache(); 16} finally { 17 lock.unlock(); 18} 19sendMessage(); 4. é”é™çº§\nå¦‚æœ Redis ä¸å¯ç”¨ï¼Œå¯ä»¥é™çº§ä¸ºæœ¬åœ°é”æˆ–ç›´æ¥æ”¾è¡Œã€‚\n1RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 2try { 3 boolean isLocked = lock.tryLock(1, 30, TimeUnit.SECONDS); 4 if (!isLocked) { 5 // é™çº§å¤„ç† 6 log.warn(\u0026#34;è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼Œé™çº§ä¸ºæœ¬åœ°é”\u0026#34;); 7 synchronized (this) { 8 // ä¸šåŠ¡é€»è¾‘ 9 } 10 } 11} catch (Exception e) { 12 log.error(\u0026#34;åˆ†å¸ƒå¼é”å¼‚å¸¸\u0026#34;, e); 13 // é™çº§å¤„ç† 14} æ€»ç»“ä¸æ€è€ƒ Redis åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ SET NX EX ä¿è¯åŠ é”çš„åŸå­æ€§ ä½¿ç”¨ Lua è„šæœ¬ä¿è¯è§£é”çš„åŸå­æ€§ ä½¿ç”¨å”¯ä¸€æ ‡è¯†é¿å…é”è¯¯åˆ  ä½¿ç”¨ Redisson ç®€åŒ–å®ç°ï¼Œåˆ©ç”¨çœ‹é—¨ç‹—æœºåˆ¶è‡ªåŠ¨ç»­æœŸ åˆ†å¸ƒå¼é”ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚åœ¨è®¾è®¡æ—¶è¦æƒè¡¡ï¼š\næ˜¯å¦çœŸçš„éœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿèƒ½å¦é€šè¿‡æ•°æ®åº“çš„ä¹è§‚é”è§£å†³ï¼Ÿ é”çš„ç²’åº¦æ˜¯å¦åˆç†ï¼Ÿèƒ½å¦é€šè¿‡åˆ†æ®µé”æå‡å¹¶å‘åº¦ï¼Ÿ æ˜¯å¦éœ€è¦é«˜å¯ç”¨ï¼Ÿå•èŠ‚ç‚¹æ˜¯å¦å¤Ÿç”¨ï¼Ÿ ä¸‹æ¬¡å½“ä½ éœ€è¦åˆ†å¸ƒå¼é”æ—¶ï¼Œä¸å¦¨å…ˆé—®é—®è‡ªå·±ï¼šè¿™ä¸ªåœºæ™¯çœŸçš„éœ€è¦å¼ºä¸€è‡´æ€§å—ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/08/redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E7%94%9F%E4%BA%A7%E7%BA%A7%E5%AE%9E%E8%B7%B5%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0-redisson/","summary":"\u003cp\u003eåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å®ä¾‹å¯èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œéœ€è¦åˆ†å¸ƒå¼é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚Redis æ˜¯å®ç°åˆ†å¸ƒå¼é”çš„å¸¸ç”¨æ–¹æ¡ˆï¼Œä½†å¾ˆå¤šäººåªä¼šç”¨ SETNXï¼Œä¸çŸ¥é“å…¶ä¸­çš„å‘ã€‚æœ¬æ–‡æ·±å…¥å‰–æ Redis åˆ†å¸ƒå¼é”çš„å®ç°ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Redis åˆ†å¸ƒå¼é”çš„å®ç°åŸç†ä¸å¸¸è§é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Redisson çœ‹é—¨ç‹—æœºåˆ¶çš„è®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„é”ä¼˜åŒ–æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†å¸ƒå¼é”çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”\"\u003eä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šåº“å­˜æ‰£å‡\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰åŠ é”\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003edeductStock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eStock\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estockMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eproductId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003estockMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eupdateById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–åº“å­˜ï¼Œå¯èƒ½å¯¼è‡´è¶…å–ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šå®šæ—¶ä»»åŠ¡å»é‡\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¤šä¸ªæœåŠ¡å®ä¾‹éƒ¨ç½²æ—¶ï¼Œå®šæ—¶ä»»åŠ¡ä¼šé‡å¤æ‰§è¡Œï¼Œéœ€è¦åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"åŸºç¡€å®ç°setnx--expire\"\u003eåŸºç¡€å®ç°ï¼šSETNX + EXPIRE\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eç‰ˆæœ¬ä¸€ï¼šæœ€ç®€å•çš„å®ç°\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003etryLock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003esetIfAbsent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eunlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edelete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼šå¦‚æœè·å–é”åï¼ŒæœåŠ¡å®•æœºï¼Œé”æ°¸è¿œä¸ä¼šé‡Šæ”¾ï¼Œå¯¼è‡´æ­»é”ã€‚\u003c/p\u003e","title":"Redis åˆ†å¸ƒå¼é”çš„ç”Ÿäº§çº§å®è·µï¼šä»åŸç†åˆ° Redisson"},{"content":"Spring Boot çš„æ ¸å¿ƒé­…åŠ›åœ¨äº\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;ï¼Œè€Œ Starter æœºåˆ¶æ˜¯å®ç°è¿™ä¸€ç†å¿µçš„å…³é”®ã€‚æœ¬æ–‡é€šè¿‡å®æˆ˜æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å¼€å‘ä¸€ä¸ªç”Ÿäº§çº§çš„è‡ªå®šä¹‰ Starterã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Spring Boot è‡ªåŠ¨è£…é…çš„åº•å±‚åŸç† æŒæ¡ BeanPostProcessor çš„ä½¿ç”¨åœºæ™¯ å­¦ä¼šè®¾è®¡é›¶ä¾µå…¥å¼çš„åŸºç¡€ç»„ä»¶ äº†è§£ Starter çš„æœ€ä½³å®è·µä¸è§„èŒƒ ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ Starterï¼Ÿ åœºæ™¯ï¼š å…¬å¸æœ‰å¤šä¸ª Spring Boot é¡¹ç›®ï¼Œéƒ½éœ€è¦é›†æˆçº¿ç¨‹æ± ç›‘æ§åŠŸèƒ½ã€‚\nä¼ ç»Ÿåšæ³•ï¼š æ¯ä¸ªé¡¹ç›®éƒ½å¤åˆ¶ä¸€éé…ç½®ä»£ç ã€‚\né—®é¢˜ï¼š\nä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜ é…ç½®ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“å‡ºé”™ å‡çº§å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æ‰€æœ‰é¡¹ç›® Starter çš„ä¼˜åŠ¿ï¼š\nä¸€æ¬¡å¼€å‘ï¼Œå¤šå¤„å¤ç”¨ é›¶ä¾µå…¥ï¼Œå¼•å…¥ä¾èµ–å³å¯ä½¿ç”¨ ç»Ÿä¸€ç®¡ç†ï¼Œå‡çº§æ–¹ä¾¿ æ¡ˆä¾‹ï¼šå¼€å‘çº¿ç¨‹æ± ç›‘æ§ Starter åŠŸèƒ½éœ€æ±‚ï¼š\nè‡ªåŠ¨æ‰«æé¡¹ç›®ä¸­çš„ ThreadPoolExecutor å®šæ—¶ä¸ŠæŠ¥çº¿ç¨‹æ± æŒ‡æ ‡ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰ æä¾›ç®¡ç†åå°æŸ¥çœ‹å’Œè°ƒæ•´çº¿ç¨‹æ± å‚æ•° ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Starter é¡¹ç›® é¡¹ç›®ç»“æ„\n1threadpool-spring-boot-starter 2â”œâ”€â”€ src/main/java 3â”‚ â””â”€â”€ com/example/threadpool 4â”‚ â”œâ”€â”€ autoconfigure 5â”‚ â”‚ â”œâ”€â”€ ThreadPoolAutoConfiguration.java 6â”‚ â”‚ â””â”€â”€ ThreadPoolProperties.java 7â”‚ â”œâ”€â”€ core 8â”‚ â”‚ â”œâ”€â”€ ThreadPoolMonitor.java 9â”‚ â”‚ â””â”€â”€ ThreadPoolRegistry.java 10â”‚ â””â”€â”€ processor 11â”‚ â””â”€â”€ ThreadPoolBeanPostProcessor.java 12â”œâ”€â”€ src/main/resources 13â”‚ â””â”€â”€ META-INF 14â”‚ â””â”€â”€ spring.factories 15â””â”€â”€ pom.xml pom.xml\n1\u0026lt;dependencies\u0026gt; 2 \u0026lt;!-- Spring Boot è‡ªåŠ¨é…ç½® --\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;spring-boot-autoconfigure\u0026lt;/artifactId\u0026gt; 6 \u0026lt;/dependency\u0026gt; 7 8 \u0026lt;!-- é…ç½®æç¤º --\u0026gt; 9 \u0026lt;dependency\u0026gt; 10 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 11 \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; 12 \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; 13 \u0026lt;/dependency\u0026gt; 14\u0026lt;/dependencies\u0026gt; ç¬¬äºŒæ­¥ï¼šå®šä¹‰é…ç½®å±æ€§ 1@ConfigurationProperties(prefix = \u0026#34;threadpool.monitor\u0026#34;) 2public class ThreadPoolProperties { 3 4 /** 5 * æ˜¯å¦å¯ç”¨çº¿ç¨‹æ± ç›‘æ§ 6 */ 7 private boolean enabled = true; 8 9 /** 10 * ä¸ŠæŠ¥é—´éš”ï¼ˆç§’ï¼‰ 11 */ 12 private int reportInterval = 60; 13 14 /** 15 * æ˜¯å¦å¯ç”¨åŠ¨æ€è°ƒæ•´ 16 */ 17 private boolean dynamicAdjust = false; 18 19 // getter/setter 20} é…ç½®æç¤º\nåˆ›å»º src/main/resources/META-INF/spring-configuration-metadata.jsonï¼š\n1{ 2 \u0026#34;properties\u0026#34;: [ 3 { 4 \u0026#34;name\u0026#34;: \u0026#34;threadpool.monitor.enabled\u0026#34;, 5 \u0026#34;type\u0026#34;: \u0026#34;java.lang.Boolean\u0026#34;, 6 \u0026#34;description\u0026#34;: \u0026#34;æ˜¯å¦å¯ç”¨çº¿ç¨‹æ± ç›‘æ§\u0026#34;, 7 \u0026#34;defaultValue\u0026#34;: true 8 }, 9 { 10 \u0026#34;name\u0026#34;: \u0026#34;threadpool.monitor.report-interval\u0026#34;, 11 \u0026#34;type\u0026#34;: \u0026#34;java.lang.Integer\u0026#34;, 12 \u0026#34;description\u0026#34;: \u0026#34;ä¸ŠæŠ¥é—´éš”ï¼ˆç§’ï¼‰\u0026#34;, 13 \u0026#34;defaultValue\u0026#34;: 60 14 } 15 ] 16} è¿™æ ·åœ¨ application.yml ä¸­é…ç½®æ—¶ï¼ŒIDE ä¼šæœ‰æ™ºèƒ½æç¤ºã€‚\nç¬¬ä¸‰æ­¥ï¼šå®ç° BeanPostProcessor æ ¸å¿ƒæ€æƒ³ï¼š åœ¨ Bean åˆå§‹åŒ–åï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ ThreadPoolExecutorï¼Œå¦‚æœæ˜¯ï¼Œæ³¨å†Œåˆ°ç›‘æ§ä¸­å¿ƒã€‚\n1@Component 2public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Override 8 public Object postProcessAfterInitialization(Object bean, String beanName) { 9 if (bean instanceof ThreadPoolExecutor) { 10 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 11 registry.register(beanName, executor); 12 log.info(\u0026#34;æ³¨å†Œçº¿ç¨‹æ± : {}\u0026#34;, beanName); 13 } 14 return bean; 15 } 16} ThreadPoolRegistry\n1@Component 2public class ThreadPoolRegistry { 3 4 private final Map\u0026lt;String, ThreadPoolExecutor\u0026gt; executors = new ConcurrentHashMap\u0026lt;\u0026gt;(); 5 6 public void register(String name, ThreadPoolExecutor executor) { 7 executors.put(name, executor); 8 } 9 10 public Map\u0026lt;String, ThreadPoolExecutor\u0026gt; getAll() { 11 return Collections.unmodifiableMap(executors); 12 } 13 14 public ThreadPoolExecutor get(String name) { 15 return executors.get(name); 16 } 17} ç¬¬å››æ­¥ï¼šå®ç°ç›‘æ§é€»è¾‘ 1@Component 2public class ThreadPoolMonitor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Autowired 8 private ThreadPoolProperties properties; 9 10 @Scheduled(fixedDelayString = \u0026#34;${threadpool.monitor.report-interval:60}000\u0026#34;) 11 public void report() { 12 if (!properties.isEnabled()) { 13 return; 14 } 15 16 registry.getAll().forEach((name, executor) -\u0026gt; { 17 ThreadPoolMetrics metrics = collectMetrics(name, executor); 18 log.info(\u0026#34;çº¿ç¨‹æ± æŒ‡æ ‡: {}\u0026#34;, metrics); 19 20 // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€InfluxDB ç­‰ï¼‰ 21 reportToMonitor(metrics); 22 }); 23 } 24 25 private ThreadPoolMetrics collectMetrics(String name, ThreadPoolExecutor executor) { 26 return ThreadPoolMetrics.builder() 27 .name(name) 28 .corePoolSize(executor.getCorePoolSize()) 29 .maximumPoolSize(executor.getMaximumPoolSize()) 30 .activeCount(executor.getActiveCount()) 31 .poolSize(executor.getPoolSize()) 32 .queueSize(executor.getQueue().size()) 33 .queueRemainingCapacity(executor.getQueue().remainingCapacity()) 34 .completedTaskCount(executor.getCompletedTaskCount()) 35 .taskCount(executor.getTaskCount()) 36 .build(); 37 } 38 39 private void reportToMonitor(ThreadPoolMetrics metrics) { 40 // å®ç°ä¸ŠæŠ¥é€»è¾‘ 41 } 42} ç¬¬äº”æ­¥ï¼šè‡ªåŠ¨é…ç½®ç±» 1@Configuration 2@EnableConfigurationProperties(ThreadPoolProperties.class) 3@ConditionalOnProperty(prefix = \u0026#34;threadpool.monitor\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;, matchIfMissing = true) 4@EnableScheduling 5public class ThreadPoolAutoConfiguration { 6 7 @Bean 8 public ThreadPoolRegistry threadPoolRegistry() { 9 return new ThreadPoolRegistry(); 10 } 11 12 @Bean 13 public ThreadPoolBeanPostProcessor threadPoolBeanPostProcessor() { 14 return new ThreadPoolBeanPostProcessor(); 15 } 16 17 @Bean 18 public ThreadPoolMonitor threadPoolMonitor() { 19 return new ThreadPoolMonitor(); 20 } 21} æ³¨è§£è¯´æ˜ï¼š\n@EnableConfigurationPropertiesï¼šå¯ç”¨é…ç½®å±æ€§ @ConditionalOnPropertyï¼šæ¡ä»¶è£…é…ï¼Œåªæœ‰é…ç½®å¯ç”¨æ—¶æ‰ç”Ÿæ•ˆ @EnableSchedulingï¼šå¯ç”¨å®šæ—¶ä»»åŠ¡ ç¬¬å…­æ­¥ï¼šæ³¨å†Œè‡ªåŠ¨é…ç½® åˆ›å»º src/main/resources/META-INF/spring.factoriesï¼š\n1org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 2com.example.threadpool.autoconfigure.ThreadPoolAutoConfiguration Spring Boot å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½è¿™ä¸ªé…ç½®ç±»ã€‚\nç¬¬ä¸ƒæ­¥ï¼šä½¿ç”¨ Starter 1. å¼•å…¥ä¾èµ–\n1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;threadpool-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; 2. é…ç½®ï¼ˆå¯é€‰ï¼‰\n1threadpool: 2 monitor: 3 enabled: true 4 report-interval: 30 3. å®šä¹‰çº¿ç¨‹æ± \n1@Configuration 2public class ThreadPoolConfig { 3 4 @Bean(\u0026#34;orderThreadPool\u0026#34;) 5 public ThreadPoolExecutor orderThreadPool() { 6 return new ThreadPoolExecutor( 7 10, 20, 60, TimeUnit.SECONDS, 8 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 9 new ThreadFactoryBuilder().setNameFormat(\u0026#34;order-pool-%d\u0026#34;).build(), 10 new ThreadPoolExecutor.CallerRunsPolicy() 11 ); 12 } 13} 4. è‡ªåŠ¨ç›‘æ§\næ— éœ€ä»»ä½•é¢å¤–ä»£ç ï¼ŒStarter ä¼šè‡ªåŠ¨æ‰«æå¹¶ç›‘æ§æ‰€æœ‰ ThreadPoolExecutorã€‚\nè¿›é˜¶ï¼šåŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° æä¾› REST API\n1@RestController 2@RequestMapping(\u0026#34;/threadpool\u0026#34;) 3public class ThreadPoolController { 4 5 @Autowired 6 private ThreadPoolRegistry registry; 7 8 @GetMapping(\u0026#34;/list\u0026#34;) 9 public List\u0026lt;ThreadPoolInfo\u0026gt; list() { 10 return registry.getAll().entrySet().stream() 11 .map(entry -\u0026gt; ThreadPoolInfo.from(entry.getKey(), entry.getValue())) 12 .collect(Collectors.toList()); 13 } 14 15 @PostMapping(\u0026#34;/adjust\u0026#34;) 16 public void adjust(@RequestBody ThreadPoolAdjustRequest request) { 17 ThreadPoolExecutor executor = registry.get(request.getName()); 18 if (executor == null) { 19 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + request.getName()); 20 } 21 22 executor.setCorePoolSize(request.getCorePoolSize()); 23 executor.setMaximumPoolSize(request.getMaximumPoolSize()); 24 25 log.info(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°: {}\u0026#34;, request); 26 } 27} è‡ªåŠ¨è£…é…åŸç† @SpringBootApplication æ³¨è§£\n1@SpringBootConfiguration 2@EnableAutoConfiguration // å…³é”®æ³¨è§£ 3@ComponentScan 4public @interface SpringBootApplication { 5} @EnableAutoConfiguration æ³¨è§£\n1@Import(AutoConfigurationImportSelector.class) 2public @interface EnableAutoConfiguration { 3} AutoConfigurationImportSelector\n1public class AutoConfigurationImportSelector { 2 3 protected List\u0026lt;String\u0026gt; getCandidateConfigurations() { 4 // è¯»å– META-INF/spring.factories 5 return SpringFactoriesLoader.loadFactoryNames( 6 EnableAutoConfiguration.class, 7 getBeanClassLoader() 8 ); 9 } 10} æµç¨‹ï¼š\nSpring Boot å¯åŠ¨æ—¶ï¼Œæ‰«ææ‰€æœ‰ jar åŒ…çš„ META-INF/spring.factories åŠ è½½ EnableAutoConfiguration å¯¹åº”çš„é…ç½®ç±» æ ¹æ® @Conditional æ³¨è§£åˆ¤æ–­æ˜¯å¦ç”Ÿæ•ˆ æ³¨å†Œ Bean åˆ° Spring å®¹å™¨ æ¶æ„æ€è€ƒï¼š Spring Boot çš„è‡ªåŠ¨è£…é…ä½“ç°äº†\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;çš„æ€æƒ³ã€‚é€šè¿‡ SPI æœºåˆ¶ï¼ˆspring.factoriesï¼‰å’Œæ¡ä»¶è£…é…ï¼ˆ@Conditionalï¼‰ï¼Œå®ç°äº†çµæ´»çš„æ¨¡å—åŒ–è®¾è®¡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šæ¡†æ¶ä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ Dubbo çš„ SPIã€Java çš„ ServiceLoaderã€‚\nStarter å¼€å‘è§„èŒƒ 1. å‘½åè§„èŒƒ\nå®˜æ–¹ Starterï¼šspring-boot-starter-{name} ç¬¬ä¸‰æ–¹ Starterï¼š{name}-spring-boot-starter 2. æ¨¡å—æ‹†åˆ†\n1{name}-spring-boot-starter # ä¾èµ–ç®¡ç†ï¼Œä¸åŒ…å«ä»£ç  2â””â”€â”€ {name}-spring-boot-autoconfigure # è‡ªåŠ¨é…ç½®ä»£ç  3. é…ç½®å‰ç¼€\nä½¿ç”¨ç»Ÿä¸€çš„é…ç½®å‰ç¼€ï¼Œé¿å…å†²çªã€‚\n1mycompany: 2 threadpool: 3 enabled: true 4. æ¡ä»¶è£…é…\nä½¿ç”¨ @ConditionalOnClassã€@ConditionalOnProperty ç­‰æ³¨è§£ï¼Œé¿å…å¼ºä¾èµ–ã€‚\n1@ConditionalOnClass(RedisTemplate.class) 2@ConditionalOnProperty(prefix = \u0026#34;redis.cache\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) 5. æä¾›é»˜è®¤é…ç½®\n1@ConfigurationProperties(prefix = \u0026#34;threadpool.monitor\u0026#34;) 2public class ThreadPoolProperties { 3 private boolean enabled = true; // é»˜è®¤å¯ç”¨ 4 private int reportInterval = 60; // é»˜è®¤ 60 ç§’ 5} 6. æ–‡æ¡£å®Œå–„\næä¾› README.mdï¼Œè¯´æ˜ï¼š\nåŠŸèƒ½ä»‹ç» å¿«é€Ÿå¼€å§‹ é…ç½®è¯´æ˜ ç¤ºä¾‹ä»£ç  æ€»ç»“ä¸æ€è€ƒ è‡ªå®šä¹‰ Starter çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼æ‰«æ é€šè¿‡ @ConfigurationProperties æä¾›çµæ´»çš„é…ç½® ä½¿ç”¨ @Conditional æ³¨è§£å®ç°æ¡ä»¶è£…é… åœ¨ spring.factories ä¸­æ³¨å†Œè‡ªåŠ¨é…ç½®ç±» Starter ä¸ä»…ä»…æ˜¯ä»£ç å¤ç”¨ï¼Œæ›´æ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ã€‚å®ƒè®©æˆ‘ä»¬é‡æ–°æ€è€ƒå¦‚ä½•è®¾è®¡å¯å¤ç”¨çš„åŸºç¡€ç»„ä»¶ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åœ¨å¤šä¸ªé¡¹ç›®ä¸­å¤ç”¨åŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯•å¼€å‘ä¸€ä¸ª Starterï¼Œä½“éªŒ\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/08/spring-boot-starter-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%80%E5%8F%91%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eSpring Boot çš„æ ¸å¿ƒé­…åŠ›åœ¨äº\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;ï¼Œè€Œ Starter æœºåˆ¶æ˜¯å®ç°è¿™ä¸€ç†å¿µçš„å…³é”®ã€‚æœ¬æ–‡é€šè¿‡å®æˆ˜æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å¼€å‘ä¸€ä¸ªç”Ÿäº§çº§çš„è‡ªå®šä¹‰ Starterã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Spring Boot è‡ªåŠ¨è£…é…çš„åº•å±‚åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ BeanPostProcessor çš„ä½¿ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡é›¶ä¾µå…¥å¼çš„åŸºç¡€ç»„ä»¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ Starter çš„æœ€ä½³å®è·µä¸è§„èŒƒ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰-starter\"\u003eä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ Starterï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼š\u003c/strong\u003e å…¬å¸æœ‰å¤šä¸ª Spring Boot é¡¹ç›®ï¼Œéƒ½éœ€è¦é›†æˆçº¿ç¨‹æ± ç›‘æ§åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿåšæ³•ï¼š\u003c/strong\u003e æ¯ä¸ªé¡¹ç›®éƒ½å¤åˆ¶ä¸€éé…ç½®ä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé—®é¢˜ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜\u003c/li\u003e\n\u003cli\u003eé…ç½®ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“å‡ºé”™\u003c/li\u003e\n\u003cli\u003eå‡çº§å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æ‰€æœ‰é¡¹ç›®\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eStarter çš„ä¼˜åŠ¿ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eä¸€æ¬¡å¼€å‘ï¼Œå¤šå¤„å¤ç”¨\u003c/li\u003e\n\u003cli\u003eé›¶ä¾µå…¥ï¼Œå¼•å…¥ä¾èµ–å³å¯ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eç»Ÿä¸€ç®¡ç†ï¼Œå‡çº§æ–¹ä¾¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¡ˆä¾‹å¼€å‘çº¿ç¨‹æ± ç›‘æ§-starter\"\u003eæ¡ˆä¾‹ï¼šå¼€å‘çº¿ç¨‹æ± ç›‘æ§ Starter\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåŠŸèƒ½éœ€æ±‚ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eè‡ªåŠ¨æ‰«æé¡¹ç›®ä¸­çš„ ThreadPoolExecutor\u003c/li\u003e\n\u003cli\u003eå®šæ—¶ä¸ŠæŠ¥çº¿ç¨‹æ± æŒ‡æ ‡ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰\u003c/li\u003e\n\u003cli\u003eæä¾›ç®¡ç†åå°æŸ¥çœ‹å’Œè°ƒæ•´çº¿ç¨‹æ± å‚æ•°\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥åˆ›å»º-starter-é¡¹ç›®\"\u003eç¬¬ä¸€æ­¥ï¼šåˆ›å»º Starter é¡¹ç›®\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eé¡¹ç›®ç»“æ„\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003ethreadpool-spring-boot-starter\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ src/main/java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ com/example/threadpool\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”œâ”€â”€ autoconfigure\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â”œâ”€â”€ ThreadPoolAutoConfiguration.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â””â”€â”€ ThreadPoolProperties.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”œâ”€â”€ core\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â”œâ”€â”€ ThreadPoolMonitor.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â””â”€â”€ ThreadPoolRegistry.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â””â”€â”€ processor\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚           â””â”€â”€ ThreadPoolBeanPostProcessor.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ src/main/resources\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ META-INF\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â””â”€â”€ spring.factories\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ pom.xml\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003epom.xml\u003c/strong\u003e\u003c/p\u003e","title":"Spring Boot Starter è‡ªå®šä¹‰å¼€å‘ï¼šä»åŸç†åˆ°å®æˆ˜"},{"content":"åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”Ÿæˆå…¨å±€å”¯ä¸€ ID æ˜¯ä¸€ä¸ªåŸºç¡€éœ€æ±‚ã€‚æ•°æ®åº“è‡ªå¢ ID åœ¨åˆ†åº“åˆ†è¡¨åæ— æ³•ä½¿ç”¨ï¼ŒUUID è™½ç„¶ç®€å•ä½†ä¸é€‚åˆä½œä¸ºä¸»é”®ã€‚æœ¬æ–‡å¯¹æ¯”ä¸»æµçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚ æŒæ¡é›ªèŠ±ç®—æ³•çš„å®ç°ä¸æ—¶é’Ÿå›æ‹¨é—®é¢˜ äº†è§£ç¾å›¢ Leaf æ–¹æ¡ˆçš„è®¾è®¡æ€æƒ³ å­¦ä¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚ å…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½é‡å¤ è¶‹åŠ¿é€’å¢ï¼šæ–¹ä¾¿æ’åºå’Œç´¢å¼• é«˜æ€§èƒ½ï¼šç”Ÿæˆé€Ÿåº¦å¿« é«˜å¯ç”¨ï¼šæœåŠ¡ä¸èƒ½æŒ‚ ä¿¡æ¯å®‰å…¨ï¼šä¸èƒ½æ³„éœ²ä¸šåŠ¡ä¿¡æ¯ æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“è‡ªå¢ ID 1CREATE TABLE id_generator ( 2 id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY, 3 stub CHAR(1) NOT NULL DEFAULT \u0026#39;\u0026#39;, 4 UNIQUE KEY stub (stub) 5); 6 7INSERT INTO id_generator (stub) VALUES (\u0026#39;a\u0026#39;); 8SELECT LAST_INSERT_ID(); ä¼˜ç‚¹ï¼šç®€å•ï¼Œè¶‹åŠ¿é€’å¢\nç¼ºç‚¹ï¼š\næ€§èƒ½ç“¶é¢ˆï¼šæ•°æ®åº“å‹åŠ›å¤§ å•ç‚¹æ•…éšœï¼šæ•°æ®åº“æŒ‚äº†å°±æ— æ³•ç”Ÿæˆ ID æ‰©å±•æ€§å·®ï¼šåˆ†åº“åˆ†è¡¨åéœ€è¦è®¾ç½®ä¸åŒçš„æ­¥é•¿ æ–¹æ¡ˆäºŒï¼šUUID 1String id = UUID.randomUUID().toString(); ä¼˜ç‚¹ï¼šç®€å•ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ€§èƒ½é«˜\nç¼ºç‚¹ï¼š\næ— åºï¼šä¸åˆ©äºæ•°æ®åº“ç´¢å¼• é•¿åº¦é•¿ï¼š36 ä¸ªå­—ç¬¦ï¼Œå ç”¨ç©ºé—´å¤§ ä¸é€‚åˆä½œä¸ºä¸»é”®ï¼šB+ æ ‘ç´¢å¼•æ€§èƒ½å·® æ–¹æ¡ˆä¸‰ï¼šé›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰ Twitter å¼€æºçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆç®—æ³•ï¼Œç”Ÿæˆ 64 ä½ long å‹ IDã€‚\nID ç»“æ„\n10 - 41ä½æ—¶é—´æˆ³ - 10ä½æœºå™¨ID - 12ä½åºåˆ—å· 1 ä½ï¼šç¬¦å·ä½ï¼Œå›ºå®šä¸º 0 41 ä½ï¼šæ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼Œå¯ç”¨ 69 å¹´ 10 ä½ï¼šæœºå™¨ IDï¼ˆ5 ä½æ•°æ®ä¸­å¿ƒ ID + 5 ä½æœºå™¨ IDï¼‰ï¼Œæ”¯æŒ 1024 å°æœºå™¨ 12 ä½ï¼šåºåˆ—å·ï¼ŒåŒä¸€æ¯«ç§’å†…å¯ç”Ÿæˆ 4096 ä¸ª ID å®ç°ä»£ç \n1public class SnowflakeIdGenerator { 2 3 private final long twepoch = 1288834974657L; // èµ·å§‹æ—¶é—´æˆ³ 4 private final long workerIdBits = 5L; 5 private final long datacenterIdBits = 5L; 6 private final long sequenceBits = 12L; 7 8 private final long workerIdShift = sequenceBits; 9 private final long datacenterIdShift = sequenceBits + workerIdBits; 10 private final long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits; 11 private final long sequenceMask = -1L ^ (-1L \u0026lt;\u0026lt; sequenceBits); 12 13 private long workerId; 14 private long datacenterId; 15 private long sequence = 0L; 16 private long lastTimestamp = -1L; 17 18 public synchronized long nextId() { 19 long timestamp = System.currentTimeMillis(); 20 21 // æ—¶é’Ÿå›æ‹¨æ£€æµ‹ 22 if (timestamp \u0026lt; lastTimestamp) { 23 throw new RuntimeException(\u0026#34;Clock moved backwards\u0026#34;); 24 } 25 26 // åŒä¸€æ¯«ç§’å†…ï¼Œåºåˆ—å·è‡ªå¢ 27 if (lastTimestamp == timestamp) { 28 sequence = (sequence + 1) \u0026amp; sequenceMask; 29 if (sequence == 0) { 30 // åºåˆ—å·ç”¨å®Œï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’ 31 timestamp = tilNextMillis(lastTimestamp); 32 } 33 } else { 34 sequence = 0L; 35 } 36 37 lastTimestamp = timestamp; 38 39 // ç»„è£… ID 40 return ((timestamp - twepoch) \u0026lt;\u0026lt; timestampLeftShift) 41 | (datacenterId \u0026lt;\u0026lt; datacenterIdShift) 42 | (workerId \u0026lt;\u0026lt; workerIdShift) 43 | sequence; 44 } 45 46 private long tilNextMillis(long lastTimestamp) { 47 long timestamp = System.currentTimeMillis(); 48 while (timestamp \u0026lt;= lastTimestamp) { 49 timestamp = System.currentTimeMillis(); 50 } 51 return timestamp; 52 } 53} æ—¶é’Ÿå›æ‹¨é—®é¢˜\nå¦‚æœç³»ç»Ÿæ—¶é—´è¢«å›æ‹¨ï¼Œä¼šå¯¼è‡´ ID é‡å¤ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\næ‹’ç»ç”Ÿæˆ IDï¼ŒæŠ›å‡ºå¼‚å¸¸ ç­‰å¾…æ—¶é’Ÿè¿½ä¸Š ä½¿ç”¨æ‰©å±•ä½è®°å½•æ—¶é’Ÿå›æ‹¨æ¬¡æ•° æ–¹æ¡ˆå››ï¼šç¾å›¢ Leaf ç¾å›¢å¼€æºçš„åˆ†å¸ƒå¼ ID ç”ŸæˆæœåŠ¡ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š\nLeaf-segmentï¼šå·æ®µæ¨¡å¼\nä»æ•°æ®åº“æ‰¹é‡è·å– ID å·æ®µï¼Œç¼“å­˜åœ¨å†…å­˜ä¸­åˆ†é…ã€‚\n1CREATE TABLE leaf_alloc ( 2 biz_tag VARCHAR(128) NOT NULL, 3 max_id BIGINT NOT NULL, 4 step INT NOT NULL, 5 PRIMARY KEY (biz_tag) 6); æµç¨‹ï¼š\næœåŠ¡å¯åŠ¨æ—¶ï¼Œä»æ•°æ®åº“è·å–å·æ®µï¼ˆå¦‚ 1-1000ï¼‰ åœ¨å†…å­˜ä¸­åˆ†é… ID å·æ®µç”¨å®Œåï¼Œå†æ¬¡ä»æ•°æ®åº“è·å–ä¸‹ä¸€ä¸ªå·æ®µ ä¼˜ç‚¹ï¼š\nå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•° æ”¯æŒåŠ¨æ€è°ƒæ•´æ­¥é•¿ Leaf-snowflakeï¼šé›ªèŠ±æ¨¡å¼\nåŸºäº Zookeeper ç”Ÿæˆæœºå™¨ IDï¼Œè§£å†³äº†é›ªèŠ±ç®—æ³•çš„æœºå™¨ ID åˆ†é…é—®é¢˜ã€‚\næ–¹æ¡ˆå¯¹æ¯” æ–¹æ¡ˆ æ€§èƒ½ å¯ç”¨æ€§ è¶‹åŠ¿é€’å¢ å¤æ‚åº¦ æ•°æ®åº“è‡ªå¢ ä½ ä½ æ˜¯ ä½ UUID é«˜ é«˜ å¦ ä½ é›ªèŠ±ç®—æ³• é«˜ é«˜ æ˜¯ ä¸­ Leaf-segment ä¸­ ä¸­ æ˜¯ ä¸­ Leaf-snowflake é«˜ é«˜ æ˜¯ é«˜ é€‰å‹å»ºè®® å°å‹é¡¹ç›®ï¼šæ•°æ®åº“è‡ªå¢ ID å¯¹é¡ºåºæ— è¦æ±‚ï¼šUUID é«˜æ€§èƒ½è¦æ±‚ï¼šé›ªèŠ±ç®—æ³• éœ€è¦é›†ä¸­ç®¡ç†ï¼šLeaf æ€»ç»“ä¸æ€è€ƒ åˆ†å¸ƒå¼ ID ç”Ÿæˆæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€é—®é¢˜ï¼Œä¸åŒæ–¹æ¡ˆé€‚ç”¨äºä¸åŒåœºæ™¯ã€‚\né›ªèŠ±ç®—æ³•æ€§èƒ½é«˜ï¼Œä½†éœ€è¦è§£å†³æ—¶é’Ÿå›æ‹¨å’Œæœºå™¨ ID åˆ†é…é—®é¢˜ Leaf æä¾›äº†æ›´å®Œå–„çš„è§£å†³æ–¹æ¡ˆï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ ä¸‹æ¬¡å½“ä½ éœ€è¦ç”Ÿæˆåˆ†å¸ƒå¼ ID æ—¶ï¼Œæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\n","permalink":"http://localhost:1313/posts/2024/07/%E5%88%86%E5%B8%83%E5%BC%8F-id-%E7%94%9F%E6%88%90%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94%E4%B8%8E%E9%80%89%E5%9E%8B%E6%8C%87%E5%8D%97/","summary":"\u003cp\u003eåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”Ÿæˆå…¨å±€å”¯ä¸€ ID æ˜¯ä¸€ä¸ªåŸºç¡€éœ€æ±‚ã€‚æ•°æ®åº“è‡ªå¢ ID åœ¨åˆ†åº“åˆ†è¡¨åæ— æ³•ä½¿ç”¨ï¼ŒUUID è™½ç„¶ç®€å•ä½†ä¸é€‚åˆä½œä¸ºä¸»é”®ã€‚æœ¬æ–‡å¯¹æ¯”ä¸»æµçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é›ªèŠ±ç®—æ³•çš„å®ç°ä¸æ—¶é’Ÿå›æ‹¨é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç¾å›¢ Leaf æ–¹æ¡ˆçš„è®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†å¸ƒå¼-id-çš„æ ¸å¿ƒè¦æ±‚\"\u003eåˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eå…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½é‡å¤\u003c/li\u003e\n\u003cli\u003eè¶‹åŠ¿é€’å¢ï¼šæ–¹ä¾¿æ’åºå’Œç´¢å¼•\u003c/li\u003e\n\u003cli\u003eé«˜æ€§èƒ½ï¼šç”Ÿæˆé€Ÿåº¦å¿«\u003c/li\u003e\n\u003cli\u003eé«˜å¯ç”¨ï¼šæœåŠ¡ä¸èƒ½æŒ‚\u003c/li\u003e\n\u003cli\u003eä¿¡æ¯å®‰å…¨ï¼šä¸èƒ½æ³„éœ²ä¸šåŠ¡ä¿¡æ¯\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ–¹æ¡ˆä¸€æ•°æ®åº“è‡ªå¢-id\"\u003eæ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“è‡ªå¢ ID\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCREATE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid_generator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003eBIGINT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTO_INCREMENT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ePRIMARY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003eCHAR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eDEFAULT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eUNIQUE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eINSERT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eINTO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid_generator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;a\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLAST_INSERT_ID\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¼˜ç‚¹ï¼šç®€å•ï¼Œè¶‹åŠ¿é€’å¢\u003c/p\u003e\n\u003cp\u003eç¼ºç‚¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ€§èƒ½ç“¶é¢ˆï¼šæ•°æ®åº“å‹åŠ›å¤§\u003c/li\u003e\n\u003cli\u003eå•ç‚¹æ•…éšœï¼šæ•°æ®åº“æŒ‚äº†å°±æ— æ³•ç”Ÿæˆ ID\u003c/li\u003e\n\u003cli\u003eæ‰©å±•æ€§å·®ï¼šåˆ†åº“åˆ†è¡¨åéœ€è¦è®¾ç½®ä¸åŒçš„æ­¥é•¿\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ–¹æ¡ˆäºŒuuid\"\u003eæ–¹æ¡ˆäºŒï¼šUUID\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUUID\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erandomUUID\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003etoString\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¼˜ç‚¹ï¼šç®€å•ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ€§èƒ½é«˜\u003c/p\u003e","title":"åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹æŒ‡å—"},{"content":"ç†è§£ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯æŒæ¡ Spring æ¡†æ¶çš„å…³é”®ã€‚æœ¬æ–‡ä»æºç å±‚é¢å‰–æ Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ Spring çš„æ ¸å¿ƒæœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ Bean ç”Ÿå‘½å‘¨æœŸçš„å®Œæ•´æµç¨‹ ç†è§£ BeanPostProcessor çš„æ‰§è¡Œæ—¶æœº å­¦ä¼šè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ äº†è§£ InitializingBean vs @PostConstruct çš„åŒºåˆ« Bean ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ 1å®ä¾‹åŒ– â†’ å±æ€§å¡«å…… â†’ åˆå§‹åŒ–å‰ â†’ åˆå§‹åŒ– â†’ åˆå§‹åŒ–å â†’ ä½¿ç”¨ â†’ é”€æ¯ è¯¦ç»†æµç¨‹ï¼š\nå®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ï¼šé€šè¿‡åå°„åˆ›å»º Bean å®ä¾‹ å±æ€§å¡«å……ï¼ˆPopulateï¼‰ï¼šæ³¨å…¥ä¾èµ–çš„ Bean Aware æ¥å£å›è°ƒï¼šBeanNameAwareã€BeanFactoryAware ç­‰ BeanPostProcessor.postProcessBeforeInitialization InitializingBean.afterPropertiesSet è‡ªå®šä¹‰ init-method BeanPostProcessor.postProcessAfterInitialization Bean å¯ä»¥ä½¿ç”¨ DisposableBean.destroy è‡ªå®šä¹‰ destroy-method å®ä¾‹åŒ–ï¼šåå°„åˆ›å»ºå¯¹è±¡ 1protected Object doCreateBean(String beanName, RootBeanDefinition mbd, Object[] args) { 2 // 1. å®ä¾‹åŒ– Bean 3 BeanWrapper instanceWrapper = createBeanInstance(beanName, mbd, args); 4 Object bean = instanceWrapper.getWrappedInstance(); 5 6 // 2. å±æ€§å¡«å…… 7 populateBean(beanName, mbd, instanceWrapper); 8 9 // 3. åˆå§‹åŒ– 10 Object exposedObject = initializeBean(beanName, bean, mbd); 11 12 return exposedObject; 13} å±æ€§å¡«å……ï¼šä¾èµ–æ³¨å…¥ 1protected void populateBean(String beanName, RootBeanDefinition mbd, BeanWrapper bw) { 2 // è·å–å±æ€§å€¼ 3 PropertyValues pvs = mbd.getPropertyValues(); 4 5 // è‡ªåŠ¨è£…é…ï¼ˆbyNameã€byTypeï¼‰ 6 if (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_NAME) { 7 autowireByName(beanName, mbd, bw, newPvs); 8 } 9 if (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_TYPE) { 10 autowireByType(beanName, mbd, bw, newPvs); 11 } 12 13 // åº”ç”¨å±æ€§å€¼ 14 applyPropertyValues(beanName, mbd, bw, pvs); 15} åˆå§‹åŒ–ï¼šå›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘ 1protected Object initializeBean(String beanName, Object bean, RootBeanDefinition mbd) { 2 // 1. Aware æ¥å£å›è°ƒ 3 invokeAwareMethods(beanName, bean); 4 5 // 2. BeanPostProcessor å‰ç½®å¤„ç† 6 Object wrappedBean = applyBeanPostProcessorsBeforeInitialization(bean, beanName); 7 8 // 3. åˆå§‹åŒ–æ–¹æ³• 9 invokeInitMethods(beanName, wrappedBean, mbd); 10 11 // 4. BeanPostProcessor åç½®å¤„ç† 12 wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); 13 14 return wrappedBean; 15} BeanPostProcessorï¼šæ‰©å±•ç‚¹ 1public interface BeanPostProcessor { 2 3 // åˆå§‹åŒ–å‰å›è°ƒ 4 default Object postProcessBeforeInitialization(Object bean, String beanName) { 5 return bean; 6 } 7 8 // åˆå§‹åŒ–åå›è°ƒ 9 default Object postProcessAfterInitialization(Object bean, String beanName) { 10 return bean; 11 } 12} åº”ç”¨åœºæ™¯ï¼š\n@Autowired æ³¨è§£çš„å¤„ç†ï¼ˆAutowiredAnnotationBeanPostProcessorï¼‰ AOP ä»£ç†çš„åˆ›å»ºï¼ˆAbstractAutoProxyCreatorï¼‰ @PostConstruct æ³¨è§£çš„å¤„ç†ï¼ˆCommonAnnotationBeanPostProcessorï¼‰ å¾ªç¯ä¾èµ–ï¼šä¸‰çº§ç¼“å­˜ 1@Service 2public class A { 3 @Autowired 4 private B b; 5} 6 7@Service 8public class B { 9 @Autowired 10 private A a; 11} Spring é€šè¿‡ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼š\n1// ä¸€çº§ç¼“å­˜ï¼šå®Œæ•´çš„ Bean 2private final Map\u0026lt;String, Object\u0026gt; singletonObjects = new ConcurrentHashMap\u0026lt;\u0026gt;(); 3 4// äºŒçº§ç¼“å­˜ï¼šæ—©æœŸçš„ Beanï¼ˆå·²å®ä¾‹åŒ–ï¼Œæœªåˆå§‹åŒ–ï¼‰ 5private final Map\u0026lt;String, Object\u0026gt; earlySingletonObjects = new HashMap\u0026lt;\u0026gt;(); 6 7// ä¸‰çº§ç¼“å­˜ï¼šBean å·¥å‚ 8private final Map\u0026lt;String, ObjectFactory\u0026lt;?\u0026gt;\u0026gt; singletonFactories = new HashMap\u0026lt;\u0026gt;(); è§£å†³æµç¨‹ï¼š\nåˆ›å»º Aï¼Œå®ä¾‹åŒ–åæ”¾å…¥ä¸‰çº§ç¼“å­˜ å¡«å…… A çš„å±æ€§ï¼Œå‘ç°ä¾èµ– B åˆ›å»º Bï¼Œå®ä¾‹åŒ–åæ”¾å…¥ä¸‰çº§ç¼“å­˜ å¡«å…… B çš„å±æ€§ï¼Œå‘ç°ä¾èµ– A ä»ä¸‰çº§ç¼“å­˜è·å– A çš„æ—©æœŸå¼•ç”¨ï¼Œæ³¨å…¥åˆ° B B åˆå§‹åŒ–å®Œæˆï¼Œæ³¨å…¥åˆ° A A åˆå§‹åŒ–å®Œæˆ é¿å‘æç¤ºï¼š æ„é€ å™¨æ³¨å…¥æ— æ³•è§£å†³å¾ªç¯ä¾èµ–ï¼Œå› ä¸ºå®ä¾‹åŒ–æ—¶å°±éœ€è¦ä¾èµ–å¯¹è±¡ã€‚åªæœ‰ setter æ³¨å…¥å’Œå­—æ®µæ³¨å…¥å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–ã€‚\nInitializingBean vs @PostConstruct ä¸‰ç§åˆå§‹åŒ–æ–¹å¼çš„æ‰§è¡Œé¡ºåºï¼š\n1@Component 2public class MyBean implements InitializingBean { 3 4 @PostConstruct 5 public void postConstruct() { 6 System.out.println(\u0026#34;1. @PostConstruct\u0026#34;); 7 } 8 9 @Override 10 public void afterPropertiesSet() { 11 System.out.println(\u0026#34;2. InitializingBean.afterPropertiesSet\u0026#34;); 12 } 13 14 public void initMethod() { 15 System.out.println(\u0026#34;3. init-method\u0026#34;); 16 } 17} æ¨èä½¿ç”¨ @PostConstructï¼Œå› ä¸ºå®ƒæ˜¯ JSR-250 æ ‡å‡†ï¼Œä¸ä¾èµ– Springã€‚\næ€»ç»“ä¸æ€è€ƒ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸä½“ç°äº†\u0026quot;æ¨¡æ¿æ–¹æ³•æ¨¡å¼\u0026quot;å’Œ\u0026quot;è´£ä»»é“¾æ¨¡å¼\u0026quot;çš„è®¾è®¡æ€æƒ³ã€‚\næ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰äº† Bean åˆ›å»ºçš„éª¨æ¶æµç¨‹ è´£ä»»é“¾ï¼šBeanPostProcessor å½¢æˆå¤„ç†é“¾ ç†è§£ Bean ç”Ÿå‘½å‘¨æœŸï¼Œæ‰èƒ½æ›´å¥½åœ°æ‰©å±• Spring æ¡†æ¶ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åœ¨ Bean åˆå§‹åŒ–æ—¶æ‰§è¡Œé€»è¾‘ï¼Œä¸å¦¨è¯•è¯• @PostConstruct æˆ– BeanPostProcessorã€‚\n","permalink":"http://localhost:1313/posts/2024/06/spring-bean-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eç†è§£ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯æŒæ¡ Spring æ¡†æ¶çš„å…³é”®ã€‚æœ¬æ–‡ä»æºç å±‚é¢å‰–æ Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ Spring çš„æ ¸å¿ƒæœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Bean ç”Ÿå‘½å‘¨æœŸçš„å®Œæ•´æµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ BeanPostProcessor çš„æ‰§è¡Œæ—¶æœº\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ InitializingBean vs @PostConstruct çš„åŒºåˆ«\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"bean-ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ\"\u003eBean ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®ä¾‹åŒ– â†’ å±æ€§å¡«å…… â†’ åˆå§‹åŒ–å‰ â†’ åˆå§‹åŒ– â†’ åˆå§‹åŒ–å â†’ ä½¿ç”¨ â†’ é”€æ¯\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¯¦ç»†æµç¨‹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ï¼šé€šè¿‡åå°„åˆ›å»º Bean å®ä¾‹\u003c/li\u003e\n\u003cli\u003eå±æ€§å¡«å……ï¼ˆPopulateï¼‰ï¼šæ³¨å…¥ä¾èµ–çš„ Bean\u003c/li\u003e\n\u003cli\u003eAware æ¥å£å›è°ƒï¼šBeanNameAwareã€BeanFactoryAware ç­‰\u003c/li\u003e\n\u003cli\u003eBeanPostProcessor.postProcessBeforeInitialization\u003c/li\u003e\n\u003cli\u003eInitializingBean.afterPropertiesSet\u003c/li\u003e\n\u003cli\u003eè‡ªå®šä¹‰ init-method\u003c/li\u003e\n\u003cli\u003eBeanPostProcessor.postProcessAfterInitialization\u003c/li\u003e\n\u003cli\u003eBean å¯ä»¥ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eDisposableBean.destroy\u003c/li\u003e\n\u003cli\u003eè‡ªå®šä¹‰ destroy-method\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"å®ä¾‹åŒ–åå°„åˆ›å»ºå¯¹è±¡\"\u003eå®ä¾‹åŒ–ï¼šåå°„åˆ›å»ºå¯¹è±¡\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003edoCreateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. å®ä¾‹åŒ– Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eBeanWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecreateBeanInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetWrappedInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. å±æ€§å¡«å……\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003epopulateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆå§‹åŒ–\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexposedObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einitializeBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexposedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"å±æ€§å¡«å……ä¾èµ–æ³¨å…¥\"\u003eå±æ€§å¡«å……ï¼šä¾èµ–æ³¨å…¥\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epopulateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBeanWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è·å–å±æ€§å€¼\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePropertyValues\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epvs\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetPropertyValues\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è‡ªåŠ¨è£…é…ï¼ˆbyNameã€byTypeï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetResolvedAutowireMode\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTOWIRE_BY_NAME\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eautowireByName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enewPvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetResolvedAutowireMode\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTOWIRE_BY_TYPE\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eautowireByType\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enewPvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åº”ç”¨å±æ€§å€¼\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyPropertyValues\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"åˆå§‹åŒ–å›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘\"\u003eåˆå§‹åŒ–ï¼šå›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003einitializeBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. Aware æ¥å£å›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003einvokeAwareMethods\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. BeanPostProcessor å‰ç½®å¤„ç†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyBeanPostProcessorsBeforeInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆå§‹åŒ–æ–¹æ³•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003einvokeInitMethods\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. BeanPostProcessor åç½®å¤„ç†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyBeanPostProcessorsAfterInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"beanpostprocessoræ‰©å±•ç‚¹\"\u003eBeanPostProcessorï¼šæ‰©å±•ç‚¹\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eBeanPostProcessor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–å‰å›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epostProcessBeforeInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–åå›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epostProcessAfterInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåº”ç”¨åœºæ™¯ï¼š\u003c/p\u003e","title":"Spring Bean ç”Ÿå‘½å‘¨æœŸå®Œå…¨è§£æ"},{"content":"Spring äº‹åŠ¡ç®¡ç†æ˜¯åç«¯å¼€å‘çš„åŸºç¡€æŠ€èƒ½ï¼Œä½†å¾ˆå¤šäººåªä¼šåœ¨æ–¹æ³•ä¸ŠåŠ  @Transactionalï¼Œå´ä¸çŸ¥é“äº‹åŠ¡ä¼ æ’­æœºåˆ¶å’Œå¤±æ•ˆåœºæ™¯ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ Spring äº‹åŠ¡çš„æ ¸å¿ƒåŸç†ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯ æŒæ¡äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§å¸¸è§åœºæ™¯ å­¦ä¼šç¼–ç¨‹å¼äº‹åŠ¡çš„ä½¿ç”¨æ–¹æ³• äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ äº‹åŠ¡çš„ ACID ç‰¹æ€§ Atomicityï¼ˆåŸå­æ€§ï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€ Isolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¹¶å‘äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰° Durabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º REQUIREDï¼ˆé»˜è®¤ï¼‰\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°äº‹åŠ¡ã€‚\n1@Transactional(propagation = Propagation.REQUIRED) 2public void methodA() { 3 // æ“ä½œ 1 4 methodB(); // åŠ å…¥ methodA çš„äº‹åŠ¡ 5} 6 7@Transactional(propagation = Propagation.REQUIRED) 8public void methodB() { 9 // æ“ä½œ 2 10} å¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼ŒmethodA å’Œ methodB çš„æ“ä½œéƒ½ä¼šå›æ»šã€‚\nREQUIRES_NEW\næ— è®ºå½“å‰æ˜¯å¦å­˜åœ¨äº‹åŠ¡ï¼Œéƒ½åˆ›å»ºæ–°äº‹åŠ¡ã€‚å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚\n1@Transactional 2public void methodA() { 3 // æ“ä½œ 1 4 methodB(); // åˆ›å»ºæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ· methodA çš„äº‹åŠ¡ 5 // æ“ä½œ 3 6} 7 8@Transactional(propagation = Propagation.REQUIRES_NEW) 9public void methodB() { 10 // æ“ä½œ 2 11} å¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼Œåªå›æ»šæ“ä½œ 2ï¼Œæ“ä½œ 1 å’Œæ“ä½œ 3 ä¸å—å½±å“ã€‚\nNESTED\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ›å»ºåµŒå¥—äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œç­‰åŒäº REQUIREDã€‚\n1@Transactional 2public void methodA() { 3 // æ“ä½œ 1 4 try { 5 methodB(); // åˆ›å»ºåµŒå¥—äº‹åŠ¡ï¼ˆä¿å­˜ç‚¹ï¼‰ 6 } catch (Exception e) { 7 // methodB å›æ»šï¼Œä½† methodA å¯ä»¥ç»§ç»­ 8 } 9 // æ“ä½œ 3 10} 11 12@Transactional(propagation = Propagation.NESTED) 13public void methodB() { 14 // æ“ä½œ 2 15} åµŒå¥—äº‹åŠ¡åŸºäºæ•°æ®åº“çš„ Savepoint æœºåˆ¶å®ç°ã€‚\nSUPPORTS\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚\né€‚ç”¨äºæŸ¥è¯¢æ–¹æ³•ã€‚\nNOT_SUPPORTED\nä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚\nMANDATORY\nå¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦‚æœå½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\nNEVER\nå¿…é¡»åœ¨éäº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\næ¶æ„æ€è€ƒï¼š äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„è®¾è®¡ä½“ç°äº†\u0026quot;çµæ´»æ€§ä¸å®‰å…¨æ€§çš„å¹³è¡¡\u0026quot;ã€‚REQUIRED ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§ï¼ŒREQUIRES_NEW æä¾›äº†äº‹åŠ¡éš”ç¦»ï¼ŒNESTED æ”¯æŒéƒ¨åˆ†å›æ»šã€‚ä¸åŒçš„ä¸šåŠ¡åœºæ™¯éœ€è¦ä¸åŒçš„ä¼ æ’­è¡Œä¸ºã€‚\näº‹åŠ¡å¤±æ•ˆçš„ 5 ç§åœºæ™¯ åœºæ™¯ä¸€ï¼šæ–¹æ³•ä¸æ˜¯ public\n@Transactional åªå¯¹ public æ–¹æ³•ç”Ÿæ•ˆã€‚\n1@Service 2public class UserService { 3 4 @Transactional 5 private void addUser(User user) { // äº‹åŠ¡å¤±æ•ˆ 6 userMapper.insert(user); 7 } 8} åŸå› ï¼šSpring AOP åŸºäºä»£ç†ï¼Œåªèƒ½ä»£ç† public æ–¹æ³•ã€‚\nåœºæ™¯äºŒï¼šæ–¹æ³•å†…éƒ¨è°ƒç”¨\nåŒä¸€ä¸ªç±»ä¸­ï¼Œæ–¹æ³• A è°ƒç”¨æ–¹æ³• Bï¼Œæ–¹æ³• B çš„äº‹åŠ¡å¤±æ•ˆã€‚\n1@Service 2public class UserService { 3 4 public void methodA() { 5 methodB(); // ç›´æ¥è°ƒç”¨ï¼Œä¸èµ°ä»£ç† 6 } 7 8 @Transactional 9 public void methodB() { // äº‹åŠ¡å¤±æ•ˆ 10 userMapper.insert(user); 11 } 12} åŸå› ï¼šå†…éƒ¨è°ƒç”¨ä¸èµ°ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ this.methodB()ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\n1@Service 2public class UserService { 3 4 @Autowired 5 private UserService self; // æ³¨å…¥è‡ªå·± 6 7 public void methodA() { 8 self.methodB(); // é€šè¿‡ä»£ç†è°ƒç”¨ 9 } 10 11 @Transactional 12 public void methodB() { 13 userMapper.insert(user); 14 } 15} åœºæ™¯ä¸‰ï¼šå¼‚å¸¸è¢«æ•è·\n1@Transactional 2public void addUser(User user) { 3 try { 4 userMapper.insert(user); 5 int i = 1 / 0; // æŠ›å‡ºå¼‚å¸¸ 6 } catch (Exception e) { 7 log.error(\u0026#34;å¼‚å¸¸\u0026#34;, e); // å¼‚å¸¸è¢«æ•è·ï¼Œäº‹åŠ¡ä¸å›æ»š 8 } 9} è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨å›æ»š\n1@Transactional 2public void addUser(User user) { 3 try { 4 userMapper.insert(user); 5 int i = 1 / 0; 6 } catch (Exception e) { 7 log.error(\u0026#34;å¼‚å¸¸\u0026#34;, e); 8 TransactionAspectSupport.currentTransactionStatus().setRollbackOnly(); 9 } 10} åœºæ™¯å››ï¼šå¼‚å¸¸ç±»å‹ä¸åŒ¹é…\n@Transactional é»˜è®¤åªå›æ»š RuntimeException å’Œ Errorã€‚\n1@Transactional 2public void addUser(User user) throws Exception { 3 userMapper.insert(user); 4 throw new Exception(\u0026#34;checked exception\u0026#34;); // äº‹åŠ¡ä¸å›æ»š 5} è§£å†³æ–¹æ¡ˆï¼šæŒ‡å®šå›æ»šçš„å¼‚å¸¸ç±»å‹\n1@Transactional(rollbackFor = Exception.class) 2public void addUser(User user) throws Exception { 3 userMapper.insert(user); 4 throw new Exception(\u0026#34;checked exception\u0026#34;); 5} åœºæ™¯äº”ï¼šæ•°æ®åº“ä¸æ”¯æŒäº‹åŠ¡\nMyISAM å¼•æ“ä¸æ”¯æŒäº‹åŠ¡ï¼Œåªæœ‰ InnoDB æ”¯æŒã€‚\nç¼–ç¨‹å¼äº‹åŠ¡ å£°æ˜å¼äº‹åŠ¡ï¼ˆ@Transactionalï¼‰ç®€å•æ˜“ç”¨ï¼Œä½†ä¸å¤Ÿçµæ´»ã€‚ç¼–ç¨‹å¼äº‹åŠ¡æä¾›äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚\n1@Service 2public class UserService { 3 4 @Autowired 5 private TransactionTemplate transactionTemplate; 6 7 public void addUser(User user) { 8 transactionTemplate.execute(status -\u0026gt; { 9 try { 10 userMapper.insert(user); 11 // å…¶ä»–æ“ä½œ 12 return true; 13 } catch (Exception e) { 14 status.setRollbackOnly(); 15 return false; 16 } 17 }); 18 } 19} åˆ†å¸ƒå¼äº‹åŠ¡ å•ä½“åº”ç”¨çš„äº‹åŠ¡ç”±æ•°æ®åº“ä¿è¯ï¼Œä½†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡å¯èƒ½æ¶‰åŠå¤šä¸ªæœåŠ¡å’Œæ•°æ®åº“ï¼Œéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nè§£å†³æ–¹æ¡ˆä¸€ï¼šä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰\nåè°ƒè€…å…ˆè¯¢é—®æ‰€æœ‰å‚ä¸è€…æ˜¯å¦å¯ä»¥æäº¤ï¼Œå¦‚æœéƒ½åŒæ„ï¼Œå†é€šçŸ¥æäº¤ã€‚\nç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œå­˜åœ¨å•ç‚¹æ•…éšœã€‚\nè§£å†³æ–¹æ¡ˆäºŒï¼šTCC\nTry-Confirm-Cancelï¼Œä¸šåŠ¡å±‚é¢çš„ä¸¤é˜¶æ®µæäº¤ã€‚\nTryï¼šé¢„ç•™èµ„æº Confirmï¼šç¡®è®¤æäº¤ Cancelï¼šå–æ¶ˆå›æ»š è§£å†³æ–¹æ¡ˆä¸‰ï¼šSeata AT æ¨¡å¼\nè‡ªåŠ¨è®°å½• SQL çš„å‰åé•œåƒï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›æ»šã€‚\nè§£å†³æ–¹æ¡ˆå››ï¼šæœ€ç»ˆä¸€è‡´æ€§\né€šè¿‡æ¶ˆæ¯é˜Ÿåˆ— + è¡¥å¿æœºåˆ¶å®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚\næ€»ç»“ä¸æ€è€ƒ Spring äº‹åŠ¡çš„æ ¸å¿ƒæ˜¯ AOP ä»£ç†ï¼Œç†è§£ä»£ç†æœºåˆ¶æ‰èƒ½é¿å…äº‹åŠ¡å¤±æ•ˆã€‚\n7 ç§ä¼ æ’­è¡Œä¸ºé€‚ç”¨äºä¸åŒåœºæ™¯ äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§åœºæ™¯è¦ç‰¢è®° åˆ†å¸ƒå¼äº‹åŠ¡è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©æ–¹æ¡ˆ ä¸‹æ¬¡å½“ä½ çš„äº‹åŠ¡ä¸ç”Ÿæ•ˆæ—¶ï¼Œæ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯è¸©äº†è¿™äº›å‘ã€‚\n","permalink":"http://localhost:1313/posts/2024/05/spring-%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eSpring äº‹åŠ¡ç®¡ç†æ˜¯åç«¯å¼€å‘çš„åŸºç¡€æŠ€èƒ½ï¼Œä½†å¾ˆå¤šäººåªä¼šåœ¨æ–¹æ³•ä¸ŠåŠ  @Transactionalï¼Œå´ä¸çŸ¥é“äº‹åŠ¡ä¼ æ’­æœºåˆ¶å’Œå¤±æ•ˆåœºæ™¯ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ Spring äº‹åŠ¡çš„æ ¸å¿ƒåŸç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§å¸¸è§åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç¼–ç¨‹å¼äº‹åŠ¡çš„ä½¿ç”¨æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"äº‹åŠ¡çš„-acid-ç‰¹æ€§\"\u003eäº‹åŠ¡çš„ ACID ç‰¹æ€§\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eAtomicityï¼ˆåŸå­æ€§ï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥\u003c/li\u003e\n\u003cli\u003eConsistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€\u003c/li\u003e\n\u003cli\u003eIsolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¹¶å‘äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°\u003c/li\u003e\n\u003cli\u003eDurabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"7-ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º\"\u003e7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eREQUIREDï¼ˆé»˜è®¤ï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°äº‹åŠ¡ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Transactional\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epropagation\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePropagation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eREQUIRED\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003emethodA\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ“ä½œ 1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003emethodB\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åŠ å…¥ methodA çš„äº‹åŠ¡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Transactional\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epropagation\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePropagation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eREQUIRED\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003emethodB\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ“ä½œ 2\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼ŒmethodA å’Œ methodB çš„æ“ä½œéƒ½ä¼šå›æ»šã€‚\u003c/p\u003e","title":"Spring äº‹åŠ¡ä¼ æ’­æœºåˆ¶ä¸å¤±æ•ˆåœºæ™¯å®Œå…¨è§£æ"},{"content":"åœ¨ä¼ ç»Ÿ Java åº”ç”¨ä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°ä¸€æ—¦åœ¨ä»£ç ä¸­å†™æ­»ï¼Œå°±åªèƒ½é€šè¿‡é‡å¯åº”ç”¨æ¥è°ƒæ•´ã€‚å½“çº¿ä¸Šæµé‡çªå¢å¯¼è‡´çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯æ—¶ï¼Œå¼€å‘è€…åªèƒ½çœ¼çççœ‹ç€ç³»ç»Ÿå´©æºƒã€‚æœ¬é¡¹ç›®é€šè¿‡è‡ªå®šä¹‰ Spring Boot Starterï¼Œå®ç°äº†çº¿ç¨‹æ± å‚æ•°çš„åŠ¨æ€è°ƒæ•´ã€å®æ—¶ç›‘æ§å’Œå¯è§†åŒ–ç®¡ç†ã€‚\né¡¹ç›®äº®ç‚¹ æ·±å…¥ç ”ç©¶ Spring Boot Starter åŸç†ï¼Œåˆ©ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼ SDK åŸºäº Redisson Pub/Sub æœºåˆ¶å®ç°é…ç½®å®æ—¶æ¨é€ï¼Œæ— éœ€é‡å¯åº”ç”¨ è®¾è®¡ ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ä¸ŠæŠ¥ Redis å¼€å‘ Admin ç®¡ç†åå°ï¼Œæä¾›å¯è§†åŒ–çš„å‚æ•°é…ç½®å’Œç›‘æ§ç•Œé¢ é—®é¢˜èƒŒæ™¯ï¼šçº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹ åœ¨ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œçº¿ç¨‹æ± çš„åˆ›å»ºæ–¹å¼é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š\n1@Configuration 2public class ThreadPoolConfig { 3 @Bean 4 public ThreadPoolExecutor bizThreadPool() { 5 return new ThreadPoolExecutor( 6 10, // æ ¸å¿ƒçº¿ç¨‹æ•° 7 20, // æœ€å¤§çº¿ç¨‹æ•° 8 60, TimeUnit.SECONDS, 9 new LinkedBlockingQueue\u0026lt;\u0026gt;(100) 10 ); 11 } 12} è¿™ç§ç¡¬ç¼–ç æ–¹å¼æœ‰ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\nå‚æ•°è°ƒæ•´éœ€è¦é‡å¯ï¼š å½“å‘ç°çº¿ç¨‹æ± é…ç½®ä¸åˆç†æ—¶ï¼Œå¿…é¡»ä¿®æ”¹ä»£ç ã€é‡æ–°æ‰“åŒ…ã€é‡å¯åº”ç”¨ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé‡å¯æ„å‘³ç€æœåŠ¡ä¸­æ–­ã€‚\nç¼ºä¹ç›‘æ§æ‰‹æ®µï¼š æ— æ³•å®æ—¶æŸ¥çœ‹çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰ï¼Œåªèƒ½ç­‰åˆ°å‡ºé—®é¢˜åé€šè¿‡æ—¥å¿—æ’æŸ¥ã€‚\né…ç½®åˆ†æ•£ç®¡ç†ï¼š ä¸åŒæœåŠ¡çš„çº¿ç¨‹æ± é…ç½®æ•£è½åœ¨å„è‡ªçš„ä»£ç ä¸­ï¼Œç¼ºä¹ç»Ÿä¸€çš„ç®¡ç†å¹³å°ã€‚\nè¿™äº›ç—›ç‚¹å€’é€¼æˆ‘ä»¬å¿…é¡»è®¾è®¡ä¸€å¥—åŠ¨æ€çº¿ç¨‹æ± ç®¡ç†æ–¹æ¡ˆã€‚\næ¶æ„è®¾è®¡ï¼šé›¶ä¾µå…¥å¼ SDK æ ¸å¿ƒè®¾è®¡æ€è·¯æ˜¯ï¼šé€šè¿‡ Spring Boot Starter æœºåˆ¶ï¼Œè®©ä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥åœ°æ¥å…¥åŠ¨æ€çº¿ç¨‹æ± èƒ½åŠ›ã€‚å¼€å‘è€…åªéœ€è¦å¼•å…¥ä¾èµ–ï¼Œçº¿ç¨‹æ± å°±è‡ªåŠ¨å…·å¤‡äº†åŠ¨æ€è°ƒæ•´å’Œç›‘æ§èƒ½åŠ›ã€‚\næŠ€æœ¯é€‰å‹ï¼š\nBeanPostProcessorï¼š æ‹¦æˆª Spring å®¹å™¨ä¸­çš„ ThreadPoolExecutor Beanï¼Œæ›¿æ¢ä¸ºå¯åŠ¨æ€è°ƒæ•´çš„ä»£ç†å¯¹è±¡ Redisson Pub/Subï¼š å®ç°é…ç½®ä¸­å¿ƒåˆ°åº”ç”¨å®ä¾‹çš„å®æ—¶æ¨é€ å®šæ—¶ä»»åŠ¡ï¼š æ¯ 20 ç§’é‡‡é›†ä¸€æ¬¡çº¿ç¨‹æ± æŒ‡æ ‡ï¼Œä¸ŠæŠ¥åˆ° Redis Admin åå°ï¼š æä¾› Web ç•Œé¢ï¼Œç®¡ç†æ‰€æœ‰æœåŠ¡çš„çº¿ç¨‹æ± é…ç½® æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š\n1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” é…ç½®å˜æ›´ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ Admin åå° â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\u0026gt; â”‚ Redis â”‚ 3â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 4 â”‚ 5 â”‚ Pub/Sub æ¨é€ 6 â†“ 7 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 8 â”‚ åº”ç”¨å®ä¾‹ A/B/C â”‚ 9 â”‚ (SDK è‡ªåŠ¨æ¥å…¥) â”‚ 10 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 11 â”‚ 12 â”‚ å®šæ—¶ä¸ŠæŠ¥æŒ‡æ ‡ 13 â†“ 14 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 15 â”‚ Redis â”‚ 16 â”‚ (ç›‘æ§æ•°æ®å­˜å‚¨) â”‚ 17 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒå®ç°ï¼šBeanPostProcessor æ‹¦æˆªä¸æ›¿æ¢ Spring Boot Starter çš„æ ¸å¿ƒæ˜¯è‡ªåŠ¨è£…é…æœºåˆ¶ã€‚æˆ‘ä»¬é€šè¿‡ spring.factories æ–‡ä»¶å£°æ˜è‡ªåŠ¨é…ç½®ç±»ï¼š\n1# META-INF/spring.factories 2org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 3com.example.threadpool.autoconfigure.ThreadPoolAutoConfiguration åœ¨è‡ªåŠ¨é…ç½®ç±»ä¸­ï¼Œæ³¨å†Œ BeanPostProcessorï¼š\n1@Configuration 2public class ThreadPoolAutoConfiguration { 3 4 @Bean 5 public ThreadPoolBeanPostProcessor threadPoolBeanPostProcessor() { 6 return new ThreadPoolBeanPostProcessor(); 7 } 8} BeanPostProcessor ä¼šåœ¨ Spring å®¹å™¨åˆå§‹åŒ–æ¯ä¸ª Bean åæ‰§è¡Œå›è°ƒï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ‹¦æˆª ThreadPoolExecutorï¼š\n1public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 2 3 @Override 4 public Object postProcessAfterInitialization(Object bean, String beanName) { 5 if (bean instanceof ThreadPoolExecutor) { 6 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 7 // å°†åŸå§‹çº¿ç¨‹æ± åŒ…è£…ä¸ºåŠ¨æ€çº¿ç¨‹æ±  8 return new DynamicThreadPoolExecutor(executor, beanName); 9 } 10 return bean; 11 } 12} DynamicThreadPoolExecutor æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„çº¿ç¨‹æ± åŒ…è£…ç±»ï¼Œå®ƒæŒæœ‰åŸå§‹ ThreadPoolExecutor çš„å¼•ç”¨ï¼Œå¹¶æä¾›åŠ¨æ€è°ƒæ•´èƒ½åŠ›ï¼š\n1public class DynamicThreadPoolExecutor extends ThreadPoolExecutor { 2 3 private final String poolName; 4 5 public void updateConfig(ThreadPoolConfig config) { 6 // åŠ¨æ€è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•° 7 this.setCorePoolSize(config.getCorePoolSize()); 8 // åŠ¨æ€è°ƒæ•´æœ€å¤§çº¿ç¨‹æ•° 9 this.setMaximumPoolSize(config.getMaxPoolSize()); 10 // åŠ¨æ€è°ƒæ•´é˜Ÿåˆ—å®¹é‡ï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰ 11 this.setQueue(new ResizableLinkedBlockingQueue\u0026lt;\u0026gt;(config.getQueueCapacity())); 12 } 13} æ¶æ„æ€è€ƒï¼š BeanPostProcessor æ˜¯ Spring æ¡†æ¶çš„æ‰©å±•ç‚¹ä¹‹ä¸€ï¼Œå¾ˆå¤šä¸­é—´ä»¶ï¼ˆå¦‚ MyBatisã€Dubboï¼‰éƒ½é€šè¿‡å®ƒå®ç°é›¶ä¾µå…¥å¼æ¥å…¥ã€‚ç†è§£è¿™ä¸ªæœºåˆ¶ï¼Œå°±èƒ½è®¾è®¡å‡ºå¯¹ä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥çš„åŸºç¡€ç»„ä»¶ã€‚\nåŠ¨æ€å‚æ•°è°ƒæ•´ï¼šRedisson Pub/Sub å®æ—¶æ¨é€ å½“ç®¡ç†å‘˜åœ¨ Admin åå°ä¿®æ”¹çº¿ç¨‹æ± é…ç½®åï¼Œå¦‚ä½•å®æ—¶é€šçŸ¥åˆ°æ‰€æœ‰åº”ç”¨å®ä¾‹ï¼Ÿæˆ‘ä»¬ä½¿ç”¨ Redisson çš„ Pub/Sub æœºåˆ¶ã€‚\nå‘å¸ƒç«¯ï¼ˆAdmin åå°ï¼‰ï¼š\n1@Service 2public class ThreadPoolConfigService { 3 4 @Autowired 5 private RedissonClient redisson; 6 7 public void updateConfig(String appName, String poolName, ThreadPoolConfig config) { 8 // ä¿å­˜é…ç½®åˆ° Redis 9 String key = \u0026#34;threadpool:config:\u0026#34; + appName + \u0026#34;:\u0026#34; + poolName; 10 redisson.getBucket(key).set(config); 11 12 // å‘å¸ƒé…ç½®å˜æ›´æ¶ˆæ¯ 13 RTopic topic = redisson.getTopic(\u0026#34;threadpool:config:update\u0026#34;); 14 topic.publish(new ConfigUpdateMessage(appName, poolName, config)); 15 } 16} è®¢é˜…ç«¯ï¼ˆåº”ç”¨å®ä¾‹ï¼‰ï¼š\n1@Component 2public class ThreadPoolConfigListener implements ApplicationListener\u0026lt;ContextRefreshedEvent\u0026gt; { 3 4 @Autowired 5 private RedissonClient redisson; 6 7 @Autowired 8 private Map\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; threadPoolMap; 9 10 @Override 11 public void onApplicationEvent(ContextRefreshedEvent event) { 12 // è®¢é˜…é…ç½®å˜æ›´æ¶ˆæ¯ 13 RTopic topic = redisson.getTopic(\u0026#34;threadpool:config:update\u0026#34;); 14 topic.addListener(ConfigUpdateMessage.class, (channel, msg) -\u0026gt; { 15 // åªå¤„ç†æœ¬åº”ç”¨çš„é…ç½® 16 if (!msg.getAppName().equals(appName)) { 17 return; 18 } 19 // åŠ¨æ€æ›´æ–°çº¿ç¨‹æ± é…ç½® 20 DynamicThreadPoolExecutor executor = threadPoolMap.get(msg.getPoolName()); 21 if (executor != null) { 22 executor.updateConfig(msg.getConfig()); 23 log.info(\u0026#34;çº¿ç¨‹æ±  {} é…ç½®å·²æ›´æ–°: {}\u0026#34;, msg.getPoolName(), msg.getConfig()); 24 } 25 }); 26 } 27} è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šé…ç½®å˜æ›´å¯ä»¥åœ¨ç§’çº§å†…æ¨é€åˆ°æ‰€æœ‰å®ä¾‹ï¼Œæ— éœ€é‡å¯åº”ç”¨ã€‚å³ä½¿æœ‰ä¸Šç™¾ä¸ªå®ä¾‹ï¼Œä¹Ÿèƒ½ä¿è¯é…ç½®çš„ä¸€è‡´æ€§ã€‚\né¿å‘æç¤ºï¼š Redisson çš„ Pub/Sub æ˜¯åŸºäº Redis çš„å‘å¸ƒè®¢é˜…æœºåˆ¶ï¼Œæ¶ˆæ¯ä¸ä¼šæŒä¹…åŒ–ã€‚å¦‚æœåº”ç”¨å®ä¾‹åœ¨é…ç½®å˜æ›´æ—¶å¤„äºç¦»çº¿çŠ¶æ€ï¼Œé‡æ–°ä¸Šçº¿åéœ€è¦ä¸»åŠ¨ä» Redis æ‹‰å–æœ€æ–°é…ç½®ã€‚\nç›‘æ§æŒ‡æ ‡é‡‡é›†ï¼šå®šæ—¶ä»»åŠ¡ä¸ŠæŠ¥ åŠ¨æ€è°ƒæ•´åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œæ›´é‡è¦çš„æ˜¯å®æ—¶ç›‘æ§çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ã€‚æˆ‘ä»¬è®¾è®¡äº† ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œæ¯ 20 ç§’é‡‡é›†ä¸€æ¬¡æŒ‡æ ‡ï¼š\n1@Component 2public class ThreadPoolDataReportJob { 3 4 @Autowired 5 private Map\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; threadPoolMap; 6 7 @Autowired 8 private RedissonClient redisson; 9 10 @Scheduled(fixedRate = 20000) 11 public void reportMetrics() { 12 for (Map.Entry\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; entry : threadPoolMap.entrySet()) { 13 String poolName = entry.getKey(); 14 ThreadPoolExecutor executor = entry.getValue(); 15 16 // é‡‡é›†æŒ‡æ ‡ 17 ThreadPoolMetrics metrics = ThreadPoolMetrics.builder() 18 .poolName(poolName) 19 .corePoolSize(executor.getCorePoolSize()) 20 .maximumPoolSize(executor.getMaximumPoolSize()) 21 .activeCount(executor.getActiveCount()) // æ´»è·ƒçº¿ç¨‹æ•° 22 .queueSize(executor.getQueue().size()) // é˜Ÿåˆ—é•¿åº¦ 23 .completedTaskCount(executor.getCompletedTaskCount()) 24 .rejectedCount(getRejectedCount(executor)) // æ‹’ç»æ¬¡æ•° 25 .timestamp(System.currentTimeMillis()) 26 .build(); 27 28 // ä¸ŠæŠ¥åˆ° Redisï¼ˆä½¿ç”¨ List ç»“æ„ï¼Œä¿ç•™æœ€è¿‘ 100 æ¡è®°å½•ï¼‰ 29 String key = \u0026#34;threadpool:metrics:\u0026#34; + appName + \u0026#34;:\u0026#34; + poolName; 30 RList\u0026lt;ThreadPoolMetrics\u0026gt; list = redisson.getList(key); 31 list.add(metrics); 32 if (list.size() \u0026gt; 100) { 33 list.remove(0); // ç§»é™¤æœ€æ—§çš„è®°å½• 34 } 35 } 36 } 37} ä¸ºäº†ç»Ÿè®¡æ‹’ç»æ¬¡æ•°ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ RejectedExecutionHandlerï¼š\n1public class MonitorableRejectedHandler implements RejectedExecutionHandler { 2 3 private final AtomicLong rejectedCount = new AtomicLong(0); 4 5 @Override 6 public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) { 7 rejectedCount.incrementAndGet(); 8 // é™çº§ç­–ç•¥ï¼šè°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ 9 new ThreadPoolExecutor.CallerRunsPolicy().rejectedExecution(r, executor); 10 } 11 12 public long getRejectedCount() { 13 return rejectedCount.get(); 14 } 15} å¯è§†åŒ–ç®¡ç†ï¼šAdmin åå°è®¾è®¡ Admin åå°æä¾›ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š\n1. é…ç½®ç®¡ç†ç•Œé¢\nå±•ç¤ºæ‰€æœ‰åº”ç”¨çš„çº¿ç¨‹æ± åˆ—è¡¨ï¼Œæ”¯æŒåœ¨çº¿ä¿®æ”¹å‚æ•°ï¼š\n1@RestController 2@RequestMapping(\u0026#34;/api/threadpool\u0026#34;) 3public class ThreadPoolController { 4 5 @GetMapping(\u0026#34;/list\u0026#34;) 6 public List\u0026lt;ThreadPoolInfo\u0026gt; listThreadPools(@RequestParam String appName) { 7 // ä» Redis æŸ¥è¯¢æ‰€æœ‰çº¿ç¨‹æ± é…ç½® 8 String pattern = \u0026#34;threadpool:config:\u0026#34; + appName + \u0026#34;:*\u0026#34;; 9 return redisson.getKeys().getKeysByPattern(pattern).stream() 10 .map(key -\u0026gt; redisson.getBucket(key).get()) 11 .collect(Collectors.toList()); 12 } 13 14 @PostMapping(\u0026#34;/update\u0026#34;) 15 public void updateConfig(@RequestBody ThreadPoolUpdateRequest request) { 16 threadPoolConfigService.updateConfig( 17 request.getAppName(), 18 request.getPoolName(), 19 request.getConfig() 20 ); 21 } 22} 2. ç›‘æ§å¤§ç›˜\nå®æ—¶å±•ç¤ºçº¿ç¨‹æ± çš„è¿è¡ŒæŒ‡æ ‡ï¼Œæ”¯æŒå›¾è¡¨å¯è§†åŒ–ï¼š\næ´»è·ƒçº¿ç¨‹æ•°è¶‹åŠ¿å›¾ é˜Ÿåˆ—é•¿åº¦å˜åŒ–æ›²çº¿ ä»»åŠ¡æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ ä»»åŠ¡å®Œæˆé€Ÿç‡ å‰ç«¯ä½¿ç”¨ ECharts æ¸²æŸ“å›¾è¡¨ï¼Œæ¯ 5 ç§’è½®è¯¢ä¸€æ¬¡åç«¯æ¥å£è·å–æœ€æ–°æ•°æ®ã€‚\næ¶æ„æ€è€ƒï¼š ç›‘æ§æ•°æ®çš„å­˜å‚¨æ–¹å¼æœ‰å¤šç§é€‰æ‹©ï¼šRedisã€InfluxDBã€Prometheusã€‚æˆ‘ä»¬é€‰æ‹© Redis æ˜¯å› ä¸ºå®ƒéƒ¨ç½²ç®€å•ï¼Œä¸”æˆ‘ä»¬çš„ç›‘æ§æ•°æ®é‡ä¸å¤§ï¼ˆæ¯ä¸ªçº¿ç¨‹æ± æ¯ 20 ç§’ä¸€æ¡è®°å½•ï¼‰ã€‚å¦‚æœéœ€è¦é•¿æœŸå­˜å‚¨å’Œå¤æ‚æŸ¥è¯¢ï¼Œå»ºè®®ä½¿ç”¨æ—¶åºæ•°æ®åº“ã€‚\né¡¹ç›®æˆæœä¸åæ€ è¿™ä¸ª SDK åœ¨å…¬å¸å†…éƒ¨æ¨å¹¿åï¼Œæ¥å…¥äº† 20+ ä¸ªæœåŠ¡ï¼Œç´¯è®¡ç®¡ç† 50+ ä¸ªçº¿ç¨‹æ± ã€‚æ ¸å¿ƒæ”¶ç›Šï¼š\nçº¿ä¸Šé—®é¢˜å“åº”æ—¶é—´ä»\u0026quot;å°æ—¶çº§\u0026quot;é™ä½åˆ°\u0026quot;åˆ†é’Ÿçº§\u0026quot;ï¼ˆæ— éœ€é‡å¯è°ƒæ•´å‚æ•°ï¼‰ é€šè¿‡ç›‘æ§å¤§ç›˜æå‰å‘ç° 3 æ¬¡æ½œåœ¨çš„çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯é—®é¢˜ ç»Ÿä¸€çš„é…ç½®ç®¡ç†é™ä½äº†è¿ç»´æˆæœ¬ å¦‚æœé‡æ–°è®¾è®¡ï¼Œæˆ‘ä¼šè€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–ï¼š\næ”¯æŒæ›´å¤šçº¿ç¨‹æ± ç±»å‹ï¼š ç›®å‰åªæ”¯æŒ ThreadPoolExecutorï¼Œæœªæ¥å¯ä»¥æ‰©å±•åˆ° ScheduledThreadPoolExecutorã€ForkJoinPool ç­‰ã€‚\nå‘Šè­¦æœºåˆ¶ï¼š å½“é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼æˆ–æ‹’ç»æ¬¡æ•°æ¿€å¢æ—¶ï¼Œè‡ªåŠ¨å‘é€é’‰é’‰/é‚®ä»¶å‘Šè­¦ã€‚\nå†å²é…ç½®å›æ»šï¼š è®°å½•æ¯æ¬¡é…ç½®å˜æ›´çš„å†å²ï¼Œæ”¯æŒä¸€é”®å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚\nè¿™ä¸ªé¡¹ç›®æœ€å¤§çš„æ”¶è·æ˜¯ï¼šç†è§£äº† Spring Boot Starter çš„è®¾è®¡å“²å­¦â€”â€”é€šè¿‡çº¦å®šå’Œè‡ªåŠ¨åŒ–ï¼Œè®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯åŸºç¡€è®¾æ–½çš„æ­å»ºã€‚è¿™ç§\u0026quot;é›¶ä¾µå…¥å¼\u0026quot;çš„è®¾è®¡æ€æƒ³ï¼Œå€¼å¾—åœ¨å…¶ä»–åŸºç¡€ç»„ä»¶ä¸­æ¨å¹¿ã€‚\n","permalink":"http://localhost:1313/projects/thread-pool-sdk/","summary":"\u003cp\u003eåœ¨ä¼ ç»Ÿ Java åº”ç”¨ä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°ä¸€æ—¦åœ¨ä»£ç ä¸­å†™æ­»ï¼Œå°±åªèƒ½é€šè¿‡é‡å¯åº”ç”¨æ¥è°ƒæ•´ã€‚å½“çº¿ä¸Šæµé‡çªå¢å¯¼è‡´çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯æ—¶ï¼Œå¼€å‘è€…åªèƒ½çœ¼çççœ‹ç€ç³»ç»Ÿå´©æºƒã€‚æœ¬é¡¹ç›®é€šè¿‡è‡ªå®šä¹‰ Spring Boot Starterï¼Œå®ç°äº†çº¿ç¨‹æ± å‚æ•°çš„åŠ¨æ€è°ƒæ•´ã€å®æ—¶ç›‘æ§å’Œå¯è§†åŒ–ç®¡ç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"é¡¹ç›®äº®ç‚¹\"\u003eé¡¹ç›®äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æ·±å…¥ç ”ç©¶ Spring Boot Starter åŸç†ï¼Œåˆ©ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼ SDK\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e åŸºäº Redisson Pub/Sub æœºåˆ¶å®ç°é…ç½®å®æ—¶æ¨é€ï¼Œæ— éœ€é‡å¯åº”ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è®¾è®¡ ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ä¸ŠæŠ¥ Redis\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å¼€å‘ Admin ç®¡ç†åå°ï¼Œæä¾›å¯è§†åŒ–çš„å‚æ•°é…ç½®å’Œç›‘æ§ç•Œé¢\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"é—®é¢˜èƒŒæ™¯çº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹\"\u003eé—®é¢˜èƒŒæ™¯ï¼šçº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹\u003c/h2\u003e\n\u003cp\u003eåœ¨ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œçº¿ç¨‹æ± çš„åˆ›å»ºæ–¹å¼é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eThreadPoolConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ebizThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ ¸å¿ƒçº¿ç¨‹æ•°\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æœ€å¤§çº¿ç¨‹æ•°\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e60\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLinkedBlockingQueue\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™ç§ç¡¬ç¼–ç æ–¹å¼æœ‰ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\u003c/p\u003e","title":"åŠ¨æ€çº¿ç¨‹æ±  SDKï¼šä»é›¶å®ç° Spring Boot Starter"},{"content":"AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡ AOPï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰ä»ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ä½† AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæœ¬æ–‡æ·±å…¥å‰–æ Spring AOP çš„åº•å±‚æœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ AOP çš„æ ¸å¿ƒæ¦‚å¿µï¼šåˆ‡é¢ã€åˆ‡ç‚¹ã€é€šçŸ¥ã€è¿æ¥ç‚¹ æŒæ¡ JDK åŠ¨æ€ä»£ç†ä¸ CGLIB ä»£ç†çš„å®ç°åŸç† å­¦ä¼š ProxyFactory çš„åˆ›å»ºæµç¨‹ äº†è§£åˆ‡é¢æ‰§è¡Œé¡ºåºä¸è´£ä»»é“¾æ¨¡å¼ AOP æ ¸å¿ƒæ¦‚å¿µ åˆ‡é¢ï¼ˆAspectï¼‰\næ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–ï¼Œæ¯”å¦‚æ—¥å¿—åˆ‡é¢ã€äº‹åŠ¡åˆ‡é¢ã€‚\n1@Aspect 2@Component 3public class LogAspect { 4 5 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 6 public void logBefore(JoinPoint joinPoint) { 7 log.info(\u0026#34;æ–¹æ³•æ‰§è¡Œå‰: {}\u0026#34;, joinPoint.getSignature().getName()); 8 } 9} åˆ‡ç‚¹ï¼ˆPointcutï¼‰\nå®šä¹‰åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨é€šçŸ¥ï¼Œé€šè¿‡è¡¨è¾¾å¼åŒ¹é…ã€‚\n1@Pointcut(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 2public void serviceLayer() {} é€šçŸ¥ï¼ˆAdviceï¼‰\nåœ¨åˆ‡ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼Œåˆ†ä¸ºäº”ç§ç±»å‹ï¼š\n@Beforeï¼šå‰ç½®é€šçŸ¥ @Afterï¼šåç½®é€šçŸ¥ @AfterReturningï¼šè¿”å›é€šçŸ¥ @AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥ @Aroundï¼šç¯ç»•é€šçŸ¥ è¿æ¥ç‚¹ï¼ˆJoinPointï¼‰\nç¨‹åºæ‰§è¡Œçš„æŸä¸ªç‚¹ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºã€‚\nJDK åŠ¨æ€ä»£ç† vs CGLIB ä»£ç† Spring AOP ä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼š\nJDK åŠ¨æ€ä»£ç†\nåŸºäºæ¥å£çš„ä»£ç†ï¼Œè¦æ±‚ç›®æ ‡ç±»å®ç°æ¥å£ã€‚\n1public interface UserService { 2 void addUser(User user); 3} 4 5@Service 6public class UserServiceImpl implements UserService { 7 @Override 8 public void addUser(User user) { 9 // ä¸šåŠ¡é€»è¾‘ 10 } 11} JDK åŠ¨æ€ä»£ç†çš„å®ç°ï¼š\n1public class JdkProxyFactory implements InvocationHandler { 2 3 private Object target; 4 5 public Object createProxy(Object target) { 6 this.target = target; 7 return Proxy.newProxyInstance( 8 target.getClass().getClassLoader(), 9 target.getClass().getInterfaces(), 10 this 11 ); 12 } 13 14 @Override 15 public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { 16 System.out.println(\u0026#34;Before method\u0026#34;); 17 Object result = method.invoke(target, args); 18 System.out.println(\u0026#34;After method\u0026#34;); 19 return result; 20 } 21} CGLIB ä»£ç†\nåŸºäºç»§æ‰¿çš„ä»£ç†ï¼Œé€šè¿‡ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»å®ç°ã€‚\n1@Service 2public class UserService { // æ²¡æœ‰å®ç°æ¥å£ 3 public void addUser(User user) { 4 // ä¸šåŠ¡é€»è¾‘ 5 } 6} CGLIB ä»£ç†çš„å®ç°ï¼š\n1public class CglibProxyFactory implements MethodInterceptor { 2 3 public Object createProxy(Object target) { 4 Enhancer enhancer = new Enhancer(); 5 enhancer.setSuperclass(target.getClass()); 6 enhancer.setCallback(this); 7 return enhancer.create(); 8 } 9 10 @Override 11 public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable { 12 System.out.println(\u0026#34;Before method\u0026#34;); 13 Object result = proxy.invokeSuper(obj, args); 14 System.out.println(\u0026#34;After method\u0026#34;); 15 return result; 16 } 17} é€‰æ‹©è§„åˆ™\nå¦‚æœç›®æ ‡ç±»å®ç°äº†æ¥å£ï¼Œé»˜è®¤ä½¿ç”¨ JDK åŠ¨æ€ä»£ç† å¦‚æœç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œä½¿ç”¨ CGLIB ä»£ç† å¯ä»¥é€šè¿‡é…ç½®å¼ºåˆ¶ä½¿ç”¨ CGLIBï¼š@EnableAspectJAutoProxy(proxyTargetClass = true) æ¶æ„æ€è€ƒï¼š JDK åŠ¨æ€ä»£ç†å’Œ CGLIB ä»£ç†ä½“ç°äº†\u0026quot;ç­–ç•¥æ¨¡å¼\u0026quot;çš„æ€æƒ³ã€‚Spring æ ¹æ®ç›®æ ‡ç±»çš„ç‰¹å¾ï¼Œé€‰æ‹©åˆé€‚çš„ä»£ç†ç­–ç•¥ã€‚è¿™ç§è®¾è®¡è®©æ¡†æ¶æ›´åŠ çµæ´»ï¼Œèƒ½å¤Ÿé€‚åº”ä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚\nProxyFactory åˆ›å»ºæµç¨‹ Spring AOP é€šè¿‡ ProxyFactory åˆ›å»ºä»£ç†å¯¹è±¡ï¼š\n1@Component 2public class AopProxyCreator { 3 4 public Object createProxy(Object target) { 5 ProxyFactory proxyFactory = new ProxyFactory(); 6 proxyFactory.setTarget(target); 7 8 // æ·»åŠ é€šçŸ¥ 9 proxyFactory.addAdvice(new MethodBeforeAdvice() { 10 @Override 11 public void before(Method method, Object[] args, Object target) { 12 System.out.println(\u0026#34;Before: \u0026#34; + method.getName()); 13 } 14 }); 15 16 return proxyFactory.getProxy(); 17 } 18} ProxyFactory çš„åˆ›å»ºæµç¨‹ï¼š\nåˆ›å»º AopProxyFactoryï¼ˆé»˜è®¤æ˜¯ DefaultAopProxyFactoryï¼‰ æ ¹æ®ç›®æ ‡ç±»é€‰æ‹©ä»£ç†æ–¹å¼ï¼ˆJDK æˆ– CGLIBï¼‰ åˆ›å»º AopProxy å¯¹è±¡ï¼ˆJdkDynamicAopProxy æˆ– CglibAopProxyï¼‰ ç”Ÿæˆä»£ç†å¯¹è±¡ åˆ‡é¢æ‰§è¡Œé¡ºåº å½“æœ‰å¤šä¸ªåˆ‡é¢æ—¶ï¼Œæ‰§è¡Œé¡ºåºç”± @Order æ³¨è§£æ§åˆ¶ï¼š\n1@Aspect 2@Component 3@Order(1) 4public class LogAspect { 5 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 6 public void logBefore() { 7 System.out.println(\u0026#34;Log Before\u0026#34;); 8 } 9} 10 11@Aspect 12@Component 13@Order(2) 14public class TransactionAspect { 15 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 16 public void transactionBefore() { 17 System.out.println(\u0026#34;Transaction Before\u0026#34;); 18 } 19} æ‰§è¡Œé¡ºåºï¼š\n1Log Before 2Transaction Before 3ç›®æ ‡æ–¹æ³•æ‰§è¡Œ 4Transaction After 5Log After è¿™æ˜¯è´£ä»»é“¾æ¨¡å¼çš„å…¸å‹åº”ç”¨ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šè‡ªå®šä¹‰æ³¨è§£å®ç°æƒé™æ ¡éªŒ 1@Target(ElementType.METHOD) 2@Retention(RetentionPolicy.RUNTIME) 3public @interface RequirePermission { 4 String value(); 5} 6 7@Aspect 8@Component 9public class PermissionAspect { 10 11 @Around(\u0026#34;@annotation(requirePermission)\u0026#34;) 12 public Object checkPermission(ProceedingJoinPoint joinPoint, RequirePermission requirePermission) throws Throwable { 13 String permission = requirePermission.value(); 14 User user = UserContext.getUser(); 15 16 if (!user.hasPermission(permission)) { 17 throw new PermissionDeniedException(\u0026#34;æ— æƒé™è®¿é—®\u0026#34;); 18 } 19 20 return joinPoint.proceed(); 21 } 22} 23 24// ä½¿ç”¨ 25@Service 26public class UserService { 27 28 @RequirePermission(\u0026#34;user:delete\u0026#34;) 29 public void deleteUser(Long userId) { 30 // ä¸šåŠ¡é€»è¾‘ 31 } 32} æ€»ç»“ä¸æ€è€ƒ Spring AOP çš„æ ¸å¿ƒæ˜¯åŠ¨æ€ä»£ç†ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡åœ¨ç›®æ ‡æ–¹æ³•å‰åæ’å…¥æ¨ªåˆ‡é€»è¾‘ã€‚\nJDK åŠ¨æ€ä»£ç†åŸºäºæ¥å£ï¼ŒCGLIB ä»£ç†åŸºäºç»§æ‰¿ ProxyFactory è´Ÿè´£åˆ›å»ºä»£ç†å¯¹è±¡ å¤šä¸ªåˆ‡é¢é€šè¿‡è´£ä»»é“¾æ¨¡å¼ä¸²è”æ‰§è¡Œ ç†è§£ AOP çš„å®ç°åŸç†ï¼Œæ‰èƒ½æ›´å¥½åœ°ä½¿ç”¨å®ƒï¼Œé¿å…è¸©å‘ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹æ—¶ï¼Œä¸å¦¨è¯•è¯• AOPï¼Œè®©ä»£ç æ›´åŠ ä¼˜é›…ã€‚\n","permalink":"http://localhost:1313/posts/2024/04/spring-aop-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eAOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡ AOPï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰ä»ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ä½† AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæœ¬æ–‡æ·±å…¥å‰–æ Spring AOP çš„åº•å±‚æœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ AOP çš„æ ¸å¿ƒæ¦‚å¿µï¼šåˆ‡é¢ã€åˆ‡ç‚¹ã€é€šçŸ¥ã€è¿æ¥ç‚¹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ JDK åŠ¨æ€ä»£ç†ä¸ CGLIB ä»£ç†çš„å®ç°åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼š ProxyFactory çš„åˆ›å»ºæµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ‡é¢æ‰§è¡Œé¡ºåºä¸è´£ä»»é“¾æ¨¡å¼\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"aop-æ ¸å¿ƒæ¦‚å¿µ\"\u003eAOP æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ‡é¢ï¼ˆAspectï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–ï¼Œæ¯”å¦‚æ—¥å¿—åˆ‡é¢ã€äº‹åŠ¡åˆ‡é¢ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Aspect\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Component\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eLogAspect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Before\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003elogBefore\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eJoinPoint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ejoinPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æ–¹æ³•æ‰§è¡Œå‰: {}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ejoinPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetSignature\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003egetName\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ‡ç‚¹ï¼ˆPointcutï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå®šä¹‰åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨é€šçŸ¥ï¼Œé€šè¿‡è¡¨è¾¾å¼åŒ¹é…ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Pointcut\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eserviceLayer\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eé€šçŸ¥ï¼ˆAdviceï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨åˆ‡ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼Œåˆ†ä¸ºäº”ç§ç±»å‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e@Beforeï¼šå‰ç½®é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@Afterï¼šåç½®é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@AfterReturningï¼šè¿”å›é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@Aroundï¼šç¯ç»•é€šçŸ¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eè¿æ¥ç‚¹ï¼ˆJoinPointï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç¨‹åºæ‰§è¡Œçš„æŸä¸ªç‚¹ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"jdk-åŠ¨æ€ä»£ç†-vs-cglib-ä»£ç†\"\u003eJDK åŠ¨æ€ä»£ç† vs CGLIB ä»£ç†\u003c/h2\u003e\n\u003cp\u003eSpring AOP ä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼š\u003c/p\u003e","title":"Spring AOP åŸç†ä¸åŠ¨æ€ä»£ç†å®ç°æ·±åº¦è§£æ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªæ¥å£å¾€å¾€éœ€è¦è°ƒç”¨å¤šä¸ªä¸‹æ¸¸æœåŠ¡ã€‚å¦‚æœä¸²è¡Œè°ƒç”¨ï¼Œå“åº”æ—¶é—´ä¼šç´¯åŠ ï¼›å¦‚æœç”¨ä¼ ç»Ÿçš„ Futureï¼Œä»£ç ä¼šå˜å¾—å¤æ‚éš¾ç»´æŠ¤ã€‚CompletableFuture æä¾›äº†ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ CompletableFuture çš„é“¾å¼è°ƒç”¨ä¸ç»„åˆæ“ä½œ å­¦ä¼šå¼‚å¸¸å¤„ç†ä¸è¶…æ—¶æ§åˆ¶ ç†è§£ä¸çº¿ç¨‹æ± çš„é…åˆä½¿ç”¨ äº†è§£å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ ä¼ ç»Ÿ Future çš„ç—›ç‚¹ JDK 1.5 å¼•å…¥çš„ Future æ¥å£åªèƒ½é€šè¿‡ get() æ–¹æ³•é˜»å¡ç­‰å¾…ç»“æœï¼š\n1ExecutorService executor = Executors.newFixedThreadPool(10); 2 3Future\u0026lt;String\u0026gt; future = executor.submit(() -\u0026gt; { 4 Thread.sleep(1000); 5 return \u0026#34;Hello\u0026#34;; 6}); 7 8// é˜»å¡ç­‰å¾…ç»“æœ 9String result = future.get(); é—®é¢˜ï¼š\nget() ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ— æ³•å¼‚æ­¥å¤„ç†ç»“æœ æ— æ³•ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ å¼‚å¸¸å¤„ç†ä¸æ–¹ä¾¿ CompletableFuture è§£å†³äº†è¿™äº›é—®é¢˜ã€‚\nCompletableFuture åŸºç¡€ç”¨æ³• åˆ›å»º CompletableFuture\n1// æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨å®Œæˆ 2CompletableFuture\u0026lt;String\u0026gt; future = new CompletableFuture\u0026lt;\u0026gt;(); 3future.complete(\u0026#34;Hello\u0026#34;); 4 5// æ–¹å¼äºŒï¼šå¼‚æ­¥æ‰§è¡Œ 6CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 7 return \u0026#34;Hello\u0026#34;; 8}); 9 10// æ–¹å¼ä¸‰ï¼šæ— è¿”å›å€¼çš„å¼‚æ­¥æ‰§è¡Œ 11CompletableFuture\u0026lt;Void\u0026gt; future = CompletableFuture.runAsync(() -\u0026gt; { 12 System.out.println(\u0026#34;Hello\u0026#34;); 13}); è·å–ç»“æœ\n1// é˜»å¡ç­‰å¾…ï¼ˆä¸æ¨èï¼‰ 2String result = future.get(); 3 4// é˜»å¡ç­‰å¾…ï¼Œå¸¦è¶…æ—¶ 5String result = future.get(1, TimeUnit.SECONDS); 6 7// éé˜»å¡è·å–ï¼Œå¦‚æœæœªå®Œæˆè¿”å›é»˜è®¤å€¼ 8String result = future.getNow(\u0026#34;default\u0026#34;); 9 10// é˜»å¡ç­‰å¾…ï¼Œä¸æŠ›å‡ºå—æ£€å¼‚å¸¸ 11String result = future.join(); é“¾å¼è°ƒç”¨ï¼šä¼˜é›…çš„å¼‚æ­¥æµæ°´çº¿ thenApplyï¼šè½¬æ¢ç»“æœ\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenApply(s -\u0026gt; { 4 return s + \u0026#34; World\u0026#34;; 5}).thenApply(s -\u0026gt; { 6 return s.toUpperCase(); 7}); 8 9System.out.println(future.join()); // HELLO WORLD thenAcceptï¼šæ¶ˆè´¹ç»“æœ\n1CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenAccept(s -\u0026gt; { 4 System.out.println(s); // ä¸è¿”å›ç»“æœ 5}); thenRunï¼šæ‰§è¡Œåç»­æ“ä½œ\n1CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenRun(() -\u0026gt; { 4 System.out.println(\u0026#34;Done\u0026#34;); // ä¸å…³å¿ƒå‰é¢çš„ç»“æœ 5}); thenComposeï¼šæ‰å¹³åŒ–åµŒå¥—çš„ CompletableFuture\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;user123\u0026#34;; 3}).thenCompose(userId -\u0026gt; { 4 // æ ¹æ® userId æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆè¿”å› CompletableFutureï¼‰ 5 return getUserInfo(userId); 6}); 7 8CompletableFuture\u0026lt;User\u0026gt; getUserInfo(String userId) { 9 return CompletableFuture.supplyAsync(() -\u0026gt; { 10 return userMapper.selectById(userId); 11 }); 12} æ¶æ„æ€è€ƒï¼š thenApply å’Œ thenCompose çš„åŒºåˆ«ç±»ä¼¼äº Stream çš„ map å’Œ flatMapã€‚thenApply ç”¨äºç®€å•çš„è½¬æ¢ï¼ŒthenCompose ç”¨äºæ‰å¹³åŒ–åµŒå¥—çš„å¼‚æ­¥æ“ä½œã€‚\nç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ thenCombineï¼šåˆå¹¶ä¸¤ä¸ªä»»åŠ¡çš„ç»“æœ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}); 4 5CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; { 6 return \u0026#34;World\u0026#34;; 7}); 8 9CompletableFuture\u0026lt;String\u0026gt; result = future1.thenCombine(future2, (s1, s2) -\u0026gt; { 10 return s1 + \u0026#34; \u0026#34; + s2; 11}); 12 13System.out.println(result.join()); // Hello World allOfï¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task1\u0026#34;); 2CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task2\u0026#34;); 3CompletableFuture\u0026lt;String\u0026gt; future3 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task3\u0026#34;); 4 5CompletableFuture\u0026lt;Void\u0026gt; allFutures = CompletableFuture.allOf(future1, future2, future3); 6 7// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ 8allFutures.join(); 9 10// è·å–æ‰€æœ‰ç»“æœ 11List\u0026lt;String\u0026gt; results = Stream.of(future1, future2, future3) 12 .map(CompletableFuture::join) 13 .collect(Collectors.toList()); anyOfï¼šç­‰å¾…ä»»æ„ä¸€ä¸ªä»»åŠ¡å®Œæˆ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(1000); 3 return \u0026#34;Task1\u0026#34;; 4}); 5 6CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; { 7 Thread.sleep(500); 8 return \u0026#34;Task2\u0026#34;; 9}); 10 11CompletableFuture\u0026lt;Object\u0026gt; anyFuture = CompletableFuture.anyOf(future1, future2); 12 13System.out.println(anyFuture.join()); // Task2ï¼ˆå…ˆå®Œæˆçš„ï¼‰ å®æˆ˜æ¡ˆä¾‹ï¼šå¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡ å‡è®¾ä¸€ä¸ªå•†å“è¯¦æƒ…é¡µéœ€è¦è°ƒç”¨ä¸‰ä¸ªæœåŠ¡ï¼š\nå•†å“æœåŠ¡ï¼šæŸ¥è¯¢å•†å“ä¿¡æ¯ åº“å­˜æœåŠ¡ï¼šæŸ¥è¯¢åº“å­˜ è¯„è®ºæœåŠ¡ï¼šæŸ¥è¯¢è¯„è®º ä¸²è¡Œè°ƒç”¨ï¼ˆæ…¢ï¼‰\n1public ProductDetailDTO getProductDetail(Long productId) { 2 Product product = productService.getProduct(productId); // 100ms 3 Stock stock = stockService.getStock(productId); // 100ms 4 List\u0026lt;Comment\u0026gt; comments = commentService.getComments(productId); // 100ms 5 6 return ProductDetailDTO.builder() 7 .product(product) 8 .stock(stock) 9 .comments(comments) 10 .build(); 11} 12// æ€»è€—æ—¶ï¼š300ms å¹¶è¡Œè°ƒç”¨ï¼ˆå¿«ï¼‰\n1public ProductDetailDTO getProductDetail(Long productId) { 2 CompletableFuture\u0026lt;Product\u0026gt; productFuture = CompletableFuture.supplyAsync(() -\u0026gt; 3 productService.getProduct(productId) 4 ); 5 6 CompletableFuture\u0026lt;Stock\u0026gt; stockFuture = CompletableFuture.supplyAsync(() -\u0026gt; 7 stockService.getStock(productId) 8 ); 9 10 CompletableFuture\u0026lt;List\u0026lt;Comment\u0026gt;\u0026gt; commentsFuture = CompletableFuture.supplyAsync(() -\u0026gt; 11 commentService.getComments(productId) 12 ); 13 14 // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ 15 CompletableFuture.allOf(productFuture, stockFuture, commentsFuture).join(); 16 17 return ProductDetailDTO.builder() 18 .product(productFuture.join()) 19 .stock(stockFuture.join()) 20 .comments(commentsFuture.join()) 21 .build(); 22} 23// æ€»è€—æ—¶ï¼š100msï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰ æ€§èƒ½æå‡ï¼šä» 300ms é™ä½åˆ° 100msã€‚\nå¼‚å¸¸å¤„ç† exceptionallyï¼šæ•è·å¼‚å¸¸å¹¶è¿”å›é»˜è®¤å€¼\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 if (Math.random() \u0026gt; 0.5) { 3 throw new RuntimeException(\u0026#34;Error\u0026#34;); 4 } 5 return \u0026#34;Success\u0026#34;; 6}).exceptionally(ex -\u0026gt; { 7 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 8 return \u0026#34;Default\u0026#34;; 9}); handleï¼šåŒæ—¶å¤„ç†æ­£å¸¸ç»“æœå’Œå¼‚å¸¸\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 if (Math.random() \u0026gt; 0.5) { 3 throw new RuntimeException(\u0026#34;Error\u0026#34;); 4 } 5 return \u0026#34;Success\u0026#34;; 6}).handle((result, ex) -\u0026gt; { 7 if (ex != null) { 8 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 9 return \u0026#34;Default\u0026#34;; 10 } 11 return result; 12}); whenCompleteï¼šä¸æ”¹å˜ç»“æœï¼Œåªåšå‰¯ä½œç”¨æ“ä½œ\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Success\u0026#34;; 3}).whenComplete((result, ex) -\u0026gt; { 4 if (ex != null) { 5 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 6 } else { 7 log.info(\u0026#34;ç»“æœ: {}\u0026#34;, result); 8 } 9}); é¿å‘æç¤ºï¼š exceptionally å’Œ handle ä¼šæ”¹å˜ CompletableFuture çš„ç»“æœï¼Œè€Œ whenComplete ä¸ä¼šã€‚é€‰æ‹©å“ªä¸ªå–å†³äºä½ æ˜¯å¦éœ€è¦æ”¹å˜ç»“æœã€‚\nè¶…æ—¶æ§åˆ¶ JDK 9 å¼•å…¥äº†è¶…æ—¶æ§åˆ¶æ–¹æ³•ï¼š\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(2000); 3 return \u0026#34;Success\u0026#34;; 4}).orTimeout(1, TimeUnit.SECONDS) // è¶…æ—¶æŠ›å‡º TimeoutException 5 .exceptionally(ex -\u0026gt; { 6 return \u0026#34;Timeout\u0026#34;; 7 }); JDK 8 å¯ä»¥é€šè¿‡ CompletableFuture.anyOf å®ç°ï¼š\n1CompletableFuture\u0026lt;String\u0026gt; taskFuture = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(2000); 3 return \u0026#34;Success\u0026#34;; 4}); 5 6CompletableFuture\u0026lt;String\u0026gt; timeoutFuture = new CompletableFuture\u0026lt;\u0026gt;(); 7scheduler.schedule(() -\u0026gt; { 8 timeoutFuture.completeExceptionally(new TimeoutException()); 9}, 1, TimeUnit.SECONDS); 10 11CompletableFuture\u0026lt;String\u0026gt; result = (CompletableFuture\u0026lt;String\u0026gt;) CompletableFuture.anyOf( 12 taskFuture, timeoutFuture 13); ä¸çº¿ç¨‹æ± çš„é…åˆ é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompletableFuture ä½¿ç”¨ ForkJoinPool.commonPool()ï¼Œçº¿ç¨‹æ•°ç­‰äº CPU æ ¸å¿ƒæ•°ã€‚\nå¯¹äº IO å¯†é›†å‹ä»»åŠ¡ï¼Œåº”è¯¥ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š\n1ExecutorService executor = Executors.newFixedThreadPool(20); 2 3CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 4 // IO å¯†é›†å‹ä»»åŠ¡ 5 return httpClient.get(url); 6}, executor); æ³¨æ„äº‹é¡¹\nä¸åŒç±»å‹çš„ä»»åŠ¡ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼ˆCPU å¯†é›†å‹ vs IO å¯†é›†å‹ï¼‰ çº¿ç¨‹æ± è¦åˆç†é…ç½®å¤§å°ï¼Œé¿å…èµ„æºè€—å°½ åº”ç”¨å…³é—­æ—¶è¦ä¼˜é›…åœ°å…³é—­çº¿ç¨‹æ±  1@PreDestroy 2public void shutdown() { 3 executor.shutdown(); 4 try { 5 if (!executor.awaitTermination(60, TimeUnit.SECONDS)) { 6 executor.shutdownNow(); 7 } 8 } catch (InterruptedException e) { 9 executor.shutdownNow(); 10 } 11} æœ€ä½³å®è·µ 1. é¿å…é˜»å¡æ“ä½œ\nä¸è¦åœ¨ CompletableFuture çš„å›è°ƒä¸­æ‰§è¡Œé˜»å¡æ“ä½œï¼Œä¼šå ç”¨çº¿ç¨‹æ± èµ„æºã€‚\n1// ä¸å¥½ï¼šé˜»å¡æ“ä½œ 2CompletableFuture.supplyAsync(() -\u0026gt; { 3 Thread.sleep(1000); // é˜»å¡çº¿ç¨‹ 4 return \u0026#34;Result\u0026#34;; 5}); 6 7// å¥½ï¼šä½¿ç”¨å¼‚æ­¥ API 8CompletableFuture.supplyAsync(() -\u0026gt; { 9 return asyncHttpClient.get(url).join(); 10}); 2. åˆç†è®¾ç½®è¶…æ—¶\né¿å…ä»»åŠ¡æ— é™ç­‰å¾…ï¼Œå¯¼è‡´èµ„æºæ³„æ¼ã€‚\n3. å¼‚å¸¸å¤„ç†è¦å®Œå–„\nç¡®ä¿æ¯ä¸ª CompletableFuture éƒ½æœ‰å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œé¿å…å¼‚å¸¸è¢«åæ‰ã€‚\n4. é¿å…è¿‡åº¦å¹¶è¡Œ\nå¹¶è¡Œä»»åŠ¡æ•°ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè¦æ ¹æ®ç³»ç»Ÿèµ„æºå’Œä¸‹æ¸¸æœåŠ¡çš„æ‰¿è½½èƒ½åŠ›è°ƒæ•´ã€‚\næ€»ç»“ä¸æ€è€ƒ CompletableFuture æ˜¯ Java å¼‚æ­¥ç¼–ç¨‹çš„åˆ©å™¨ï¼Œå®ƒæä¾›äº†ï¼š\né“¾å¼è°ƒç”¨ï¼šä¼˜é›…çš„å¼‚æ­¥æµæ°´çº¿ ç»„åˆæ“ä½œï¼šçµæ´»çš„ä»»åŠ¡ç¼–æ’ å¼‚å¸¸å¤„ç†ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ çº¿ç¨‹æ± é›†æˆï¼šé«˜æ•ˆçš„èµ„æºåˆ©ç”¨ æŒæ¡ CompletableFutureï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å’Œä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡æ—¶ï¼Œä¸å¦¨è¯•è¯• CompletableFutureï¼Œä½“éªŒå¼‚æ­¥ç¼–ç¨‹çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/03/completablefuture-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªæ¥å£å¾€å¾€éœ€è¦è°ƒç”¨å¤šä¸ªä¸‹æ¸¸æœåŠ¡ã€‚å¦‚æœä¸²è¡Œè°ƒç”¨ï¼Œå“åº”æ—¶é—´ä¼šç´¯åŠ ï¼›å¦‚æœç”¨ä¼ ç»Ÿçš„ Futureï¼Œä»£ç ä¼šå˜å¾—å¤æ‚éš¾ç»´æŠ¤ã€‚CompletableFuture æä¾›äº†ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ CompletableFuture çš„é“¾å¼è°ƒç”¨ä¸ç»„åˆæ“ä½œ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šå¼‚å¸¸å¤„ç†ä¸è¶…æ—¶æ§åˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¸çº¿ç¨‹æ± çš„é…åˆä½¿ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¼ ç»Ÿ-future-çš„ç—›ç‚¹\"\u003eä¼ ç»Ÿ Future çš„ç—›ç‚¹\u003c/h2\u003e\n\u003cp\u003eJDK 1.5 å¼•å…¥çš„ Future æ¥å£åªèƒ½é€šè¿‡ get() æ–¹æ³•é˜»å¡ç­‰å¾…ç»“æœï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eExecutorService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eExecutors\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003enewFixedThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esubmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// é˜»å¡ç­‰å¾…ç»“æœ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eget() ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ— æ³•å¼‚æ­¥å¤„ç†ç»“æœ\u003c/li\u003e\n\u003cli\u003eæ— æ³•ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡\u003c/li\u003e\n\u003cli\u003eå¼‚å¸¸å¤„ç†ä¸æ–¹ä¾¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eCompletableFuture è§£å†³äº†è¿™äº›é—®é¢˜ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"completablefuture-åŸºç¡€ç”¨æ³•\"\u003eCompletableFuture åŸºç¡€ç”¨æ³•\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ›å»º CompletableFuture\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨å®Œæˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecomplete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼äºŒï¼šå¼‚æ­¥æ‰§è¡Œ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esupplyAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼ä¸‰ï¼šæ— è¿”å›å€¼çš„å¼‚æ­¥æ‰§è¡Œ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eVoid\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erunAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eè·å–ç»“æœ\u003c/strong\u003e\u003c/p\u003e","title":"CompletableFuture å¼‚æ­¥ç¼–ç¨‹å®æˆ˜æŒ‡å—"},{"content":"åœ¨ç”µå•†ä¸šåŠ¡é«˜é€Ÿå‘å±•çš„èƒŒæ™¯ä¸‹ï¼Œæ‹¼å›¢æ¨¡å¼å› å…¶ç¤¾äº¤è£‚å˜å±æ€§æˆä¸ºæµé‡å¢é•¿çš„åˆ©å™¨ã€‚ä½†çœ‹ä¼¼ç®€å•çš„\u0026quot;å‡‘å¤Ÿ N äººæˆå›¢\u0026quot;èƒŒåï¼Œéšè—ç€åº“å­˜è¶…å–ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€æµ·é‡æ•°æ®å­˜å‚¨ç­‰ä¸€ç³»åˆ—æŠ€æœ¯æŒ‘æˆ˜ã€‚æœ¬æ–‡å¤ç›˜æˆ‘åœ¨æ‹¼å›¢äº¤æ˜“å¹³å°é¡¹ç›®ä¸­çš„æ¶æ„è®¾è®¡ä¸æŠ€æœ¯é€‰å‹æ€è€ƒã€‚\né¡¹ç›®äº®ç‚¹ åŸºäº DDD æ€æƒ³çš„é¢†åŸŸæ¨¡å‹è®¾è®¡ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦ Redis åˆ†å¸ƒå¼é” + åˆ†åº“åˆ†è¡¨è§£å†³é«˜å¹¶å‘åº“å­˜æ‰£å‡é—®é¢˜ RabbitMQ å¼‚æ­¥è§£è€¦å®ç°å•æ­¥æµæ°´çº¿ï¼Œæå‡ç³»ç»Ÿååé‡ ShardingSphere åˆ†åº“åˆ†è¡¨æ”¯æ’‘æµ·é‡è®¢å•æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢ ä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜ æ‹¼å›¢äº¤æ˜“çš„æ ¸å¿ƒæµç¨‹çœ‹ä¼¼ç®€å•ï¼šç”¨æˆ·å‘èµ·æ‹¼å›¢ â†’ å…¶ä»–ç”¨æˆ·å‚å›¢ â†’ è¾¾åˆ°äººæ•°åæˆå›¢ â†’ æ‰£å‡åº“å­˜ â†’ é€šçŸ¥æ”¯ä»˜ã€‚ä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªæµç¨‹ä¼šé‡åˆ°ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\nåº“å­˜è¶…å–ï¼š 100 ä»¶å•†å“ï¼Œ1000 äººåŒæ—¶ä¸‹å•ï¼Œå¦‚ä½•ä¿è¯ä¸ä¼šè¶…å–ï¼Ÿä¼ ç»Ÿçš„æ•°æ®åº“è¡Œé”åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤±æ•ˆã€‚\nåˆ†å¸ƒå¼äº‹åŠ¡ï¼š è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡ã€æ”¯ä»˜é€šçŸ¥åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\næµ·é‡æ•°æ®ï¼š è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚ä½•ä¿è¯æŸ¥è¯¢æ€§èƒ½ä¸éšæ•°æ®é‡å¢é•¿è€ŒåŠ£åŒ–ï¼Ÿ\nè¿™äº›é—®é¢˜å€’é€¼æˆ‘ä»¬å¿…é¡»ä»æ¶æ„å±‚é¢é‡æ–°æ€è€ƒç³»ç»Ÿè®¾è®¡ã€‚\næ¶æ„è®¾è®¡ï¼šDDD æ€æƒ³çš„è½åœ°å®è·µ ä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹ä¼šå¯¼è‡´ Service å±‚é€»è¾‘è‡ƒè‚¿ï¼Œä¸šåŠ¡è§„åˆ™æ•£è½åœ¨å„å¤„ã€‚æˆ‘ä»¬é‡‡ç”¨ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ€æƒ³ï¼Œå°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒé¢†åŸŸï¼š\nè®¢å•åŸŸï¼ˆOrderï¼‰ï¼š è´Ÿè´£æ‹¼å›¢è®¢å•çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€çŠ¶æ€æµè½¬ã€è¶…æ—¶å–æ¶ˆç­‰ã€‚\nåº“å­˜åŸŸï¼ˆInventoryï¼‰ï¼š è´Ÿè´£å•†å“åº“å­˜çš„æ‰£å‡ã€å›æ»šã€é¢„å ç­‰æ“ä½œï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒç“¶é¢ˆã€‚\næ”¯ä»˜åŸŸï¼ˆPaymentï¼‰ï¼š è´Ÿè´£æ”¯ä»˜æµç¨‹çš„ç¼–æ’ï¼ŒåŒ…æ‹¬æ”¯ä»˜é€šçŸ¥ã€é€€æ¬¾å¤„ç†ç­‰ã€‚\næ¯ä¸ªé¢†åŸŸéƒ½æœ‰è‡ªå·±çš„èšåˆæ ¹ï¼ˆAggregate Rootï¼‰å’Œé¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰ã€‚æ¯”å¦‚è®¢å•åŸŸçš„èšåˆæ ¹æ˜¯ Orderï¼Œå®ƒå°è£…äº†è®¢å•çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™ï¼š\n1public class Order { 2 private OrderId id; 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 // ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰å¾…æ”¯ä»˜çŠ¶æ€æ‰èƒ½å–æ¶ˆ 8 public void cancel() { 9 if (this.status != OrderStatus.PENDING_PAYMENT) { 10 throw new OrderCannotCancelException(); 11 } 12 this.status = OrderStatus.CANCELLED; 13 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼šè®¢å•å·²å–æ¶ˆ 14 DomainEventPublisher.publish(new OrderCancelledEvent(this.id)); 15 } 16} è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šä¸šåŠ¡è§„åˆ™å†…èšåœ¨é¢†åŸŸå¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨ Service å±‚çš„å„ç§ if-else é‡Œã€‚å½“äº§å“ç»ç†è¯´\u0026quot;å¢åŠ ä¸€ä¸ªæ‹¼å›¢å¤±è´¥è‡ªåŠ¨é€€æ¬¾çš„é€»è¾‘\u0026quot;æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç›‘å¬ OrderCancelledEvent äº‹ä»¶ï¼Œè€Œä¸éœ€è¦æ”¹åŠ¨è®¢å•å–æ¶ˆçš„æ ¸å¿ƒé€»è¾‘ã€‚\næ¶æ„æ€è€ƒï¼š DDD çš„æœ¬è´¨æ˜¯\u0026quot;ç”¨ä»£ç è¡¨è¾¾ä¸šåŠ¡è¯­è¨€\u0026quot;ã€‚å½“ä½ çš„ä»£ç ä¸­å‡ºç° Order.cancel() è€Œä¸æ˜¯ orderService.updateStatus(orderId, 3)ï¼Œä¸šåŠ¡äººå‘˜ä¹Ÿèƒ½çœ‹æ‡‚ä»£ç åœ¨åšä»€ä¹ˆã€‚è¿™ç§\u0026quot;é€šç”¨è¯­è¨€\u0026quot;ï¼ˆUbiquitous Languageï¼‰æ˜¯ DDD æœ€å¤§çš„ä»·å€¼ã€‚\næ ¸å¿ƒéš¾ç‚¹ï¼šåˆ†å¸ƒå¼é”è§£å†³åº“å­˜è¶…å– åº“å­˜æ‰£å‡æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚æœ€ç®€å•çš„æ–¹æ¡ˆæ˜¯åœ¨æ•°æ®åº“å±‚é¢åŠ è¡Œé”ï¼š\n1UPDATE inventory SET stock = stock - 1 WHERE product_id = ? AND stock \u0026gt; 0 ä½†è¿™ç§æ–¹æ¡ˆåœ¨é«˜å¹¶å‘ä¸‹ä¼šå¯¼è‡´å¤§é‡çº¿ç¨‹é˜»å¡åœ¨æ•°æ®åº“é”ä¸Šï¼ŒTPS ä¸Šä¸å»ã€‚æˆ‘ä»¬çš„ä¼˜åŒ–æ€è·¯æ˜¯ï¼šç”¨ Redis åˆ†å¸ƒå¼é” + é¢„æ‰£å‡æœºåˆ¶ã€‚\nç¬¬ä¸€æ­¥ï¼šRedis é¢„æ‰£å‡\nç”¨æˆ·ä¸‹å•æ—¶ï¼Œå…ˆåœ¨ Redis ä¸­æ‰£å‡åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰ï¼š\n1public boolean preDeductStock(String productId, int quantity) { 2 String key = \u0026#34;stock:\u0026#34; + productId; 3 Long remaining = redisTemplate.opsForValue().decrement(key, quantity); 4 return remaining != null \u0026amp;\u0026amp; remaining \u0026gt;= 0; 5} å¦‚æœ Redis æ‰£å‡æˆåŠŸï¼Œè¯´æ˜æœ‰åº“å­˜ï¼Œå…è®¸åˆ›å»ºè®¢å•ã€‚å¦‚æœå¤±è´¥ï¼Œç›´æ¥è¿”å›\u0026quot;åº“å­˜ä¸è¶³\u0026quot;ï¼Œä¸éœ€è¦è®¿é—®æ•°æ®åº“ã€‚\nç¬¬äºŒæ­¥ï¼šå¼‚æ­¥åŒæ­¥åˆ°æ•°æ®åº“\né€šè¿‡ RabbitMQ å‘é€æ¶ˆæ¯ï¼Œå¼‚æ­¥å°†åº“å­˜å˜æ›´åŒæ­¥åˆ° MySQLï¼š\n1rabbitTemplate.convertAndSend(\u0026#34;inventory.exchange\u0026#34;, \u0026#34;stock.deduct\u0026#34;, 2 new StockDeductMessage(productId, quantity, orderId)); æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯ï¼Œæ›´æ–°æ•°æ®åº“åº“å­˜ï¼š\n1@RabbitListener(queues = \u0026#34;stock.deduct.queue\u0026#34;) 2public void handleStockDeduct(StockDeductMessage msg) { 3 inventoryMapper.deductStock(msg.getProductId(), msg.getQuantity()); 4} ç¬¬ä¸‰æ­¥ï¼šRedisson çœ‹é—¨ç‹—æœºåˆ¶\nä¸ºäº†é˜²æ­¢ Redis å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬ç”¨ Redisson çš„åˆ†å¸ƒå¼é”ä¿æŠ¤æ•´ä¸ªæ‰£å‡æµç¨‹ï¼š\n1RLock lock = redisson.getLock(\u0026#34;lock:stock:\u0026#34; + productId); 2try { 3 lock.lock(10, TimeUnit.SECONDS); 4 // æ‰§è¡Œæ‰£å‡é€»è¾‘ 5} finally { 6 lock.unlock(); 7} Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶ä¼šè‡ªåŠ¨ç»­æœŸé”ï¼Œé¿å…ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”æå‰é‡Šæ”¾ã€‚\né¿å‘æç¤ºï¼š Redis é¢„æ‰£å‡æ–¹æ¡ˆæœ‰ä¸ªéšæ‚£ï¼šå¦‚æœè®¢å•è¶…æ—¶æœªæ”¯ä»˜ï¼Œéœ€è¦å›æ»šåº“å­˜ã€‚è¿™æ—¶å¿…é¡»ä¿è¯ Redis å’Œæ•°æ®åº“çš„åº“å­˜æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚æˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šå®šæ—¶ä»»åŠ¡æ‰«æè¶…æ—¶è®¢å•ï¼ŒåŒæ—¶å›æ»š Redis å’Œæ•°æ®åº“åº“å­˜ã€‚\nå¼‚æ­¥è§£è€¦ï¼šRabbitMQ å•æ­¥æµæ°´çº¿è®¾è®¡ ä¼ ç»Ÿçš„åŒæ­¥è°ƒç”¨é“¾è·¯æ˜¯ï¼šåˆ›å»ºè®¢å• â†’ æ‰£å‡åº“å­˜ â†’ å‘é€æ”¯ä»˜é€šçŸ¥ã€‚å¦‚æœæ¯ä¸€æ­¥éƒ½åŒæ­¥ç­‰å¾…ï¼Œæ•´ä¸ªæ¥å£çš„ RTï¼ˆå“åº”æ—¶é—´ï¼‰ä¼šç´¯åŠ ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå·®ã€‚\næˆ‘ä»¬ç”¨ RabbitMQ å®ç°å¼‚æ­¥è§£è€¦ï¼š\nç”¨æˆ·ä¸‹å•åï¼Œç«‹å³è¿”å›\u0026quot;è®¢å•åˆ›å»ºæˆåŠŸ\u0026quot; å‘é€æ¶ˆæ¯åˆ° order.created é˜Ÿåˆ— åº“å­˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ï¼Œæ‰£å‡åº“å­˜åå‘é€ stock.deducted æ¶ˆæ¯ æ”¯ä»˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ï¼Œå‘é€æ”¯ä»˜é€šçŸ¥ è¿™ç§å•æ­¥æµæ°´çº¿è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šæ¯ä¸ªæœåŠ¡åªå…³å¿ƒè‡ªå·±çš„èŒè´£ï¼Œé€šè¿‡æ¶ˆæ¯é©±åŠ¨å®ç°æ¾è€¦åˆã€‚å¦‚æœåº“å­˜æœåŠ¡æŒ‚äº†ï¼Œæ¶ˆæ¯ä¼šå †ç§¯åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ¢å¤åè‡ªåŠ¨æ¶ˆè´¹ï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ã€‚\n1// è®¢å•æœåŠ¡ï¼šå‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶ 2@Transactional 3public void createOrder(OrderDTO dto) { 4 Order order = orderMapper.insert(dto); 5 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, 6 new OrderCreatedEvent(order.getId())); 7} 8 9// åº“å­˜æœåŠ¡ï¼šç›‘å¬è®¢å•åˆ›å»ºäº‹ä»¶ 10@RabbitListener(queues = \u0026#34;order.created.queue\u0026#34;) 11public void handleOrderCreated(OrderCreatedEvent event) { 12 inventoryService.deductStock(event.getOrderId()); 13 rabbitTemplate.convertAndSend(\u0026#34;inventory.exchange\u0026#34;, \u0026#34;stock.deducted\u0026#34;, 14 new StockDeductedEvent(event.getOrderId())); 15} æ¶æ„æ€è€ƒï¼š å¼‚æ­¥åŒ–çš„ä»£ä»·æ˜¯è°ƒè¯•å¤æ‚åº¦å¢åŠ ã€‚å½“è®¢å•åˆ›å»ºæˆåŠŸä½†åº“å­˜æ‰£å‡å¤±è´¥æ—¶ï¼Œå¦‚ä½•æ’æŸ¥é—®é¢˜ï¼Ÿæˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šæ¯æ¡æ¶ˆæ¯éƒ½å¸¦ä¸Š traceIdï¼Œé€šè¿‡æ—¥å¿—ç³»ç»Ÿä¸²è”æ•´ä¸ªè°ƒç”¨é“¾è·¯ã€‚\næµ·é‡æ•°æ®ï¼šShardingSphere åˆ†åº“åˆ†è¡¨å®æˆ˜ è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚æœä¸åšåˆ†åº“åˆ†è¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šéšç€æ•°æ®é‡å¢é•¿è€Œæ€¥å‰§ä¸‹é™ã€‚æˆ‘ä»¬ç”¨ ShardingSphere å®ç°æ°´å¹³åˆ†è¡¨ï¼š\nåˆ†ç‰‡ç­–ç•¥ï¼š æŒ‰ user_id å–æ¨¡åˆ† 16 å¼ è¡¨ï¼ˆt_order_0 ~ t_order_15ï¼‰\n1shardingRule: 2 tables: 3 t_order: 4 actualDataNodes: ds0.t_order_${0..15} 5 tableStrategy: 6 standard: 7 shardingColumn: user_id 8 shardingAlgorithmName: order_mod 9 shardingAlgorithms: 10 order_mod: 11 type: MOD 12 props: 13 sharding-count: 16 ä¸ºä»€ä¹ˆé€‰æ‹© user_id è€Œä¸æ˜¯ order_idï¼Ÿ\nå› ä¸ºå¤§éƒ¨åˆ†æŸ¥è¯¢åœºæ™¯æ˜¯\u0026quot;æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„è®¢å•åˆ—è¡¨\u0026quot;ï¼ŒæŒ‰ user_id åˆ†ç‰‡å¯ä»¥ä¿è¯å•ä¸ªç”¨æˆ·çš„è®¢å•éƒ½åœ¨åŒä¸€å¼ è¡¨ï¼Œé¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ã€‚\nè·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–ï¼š\nå¦‚æœéœ€è¦æŒ‰ order_id æŸ¥è¯¢ï¼ˆæ¯”å¦‚è®¢å•è¯¦æƒ…é¡µï¼‰ï¼Œä¼šè§¦å‘å…¨è¡¨æ‰«æã€‚æˆ‘ä»¬çš„ä¼˜åŒ–æ–¹æ¡ˆæ˜¯ï¼šåœ¨ Redis ä¸­ç»´æŠ¤ order_id -\u0026gt; user_id çš„æ˜ å°„å…³ç³»ï¼Œå…ˆæŸ¥ Redis è·å– user_idï¼Œå†ç²¾å‡†è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡ã€‚\n1public Order getOrderById(String orderId) { 2 // å…ˆä» Redis è·å– user_id 3 String userId = redisTemplate.opsForValue().get(\u0026#34;order:user:\u0026#34; + orderId); 4 if (userId != null) { 5 // ç²¾å‡†è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡ 6 return orderMapper.selectByOrderIdAndUserId(orderId, userId); 7 } 8 // é™çº§æ–¹æ¡ˆï¼šå…¨è¡¨æ‰«æ 9 return orderMapper.selectByOrderId(orderId); 10} é¿å‘æç¤ºï¼š åˆ†åº“åˆ†è¡¨åï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¼šå˜å¾—æ›´å¤æ‚ã€‚æˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šå°½é‡é¿å…è·¨åˆ†ç‰‡äº‹åŠ¡ï¼Œé€šè¿‡ä¸šåŠ¡è®¾è®¡ä¿è¯å•ä¸ªäº‹åŠ¡åªæ“ä½œä¸€ä¸ªåˆ†ç‰‡ã€‚å¦‚æœå®åœ¨éœ€è¦è·¨åˆ†ç‰‡ï¼Œä½¿ç”¨ Seata çš„ AT æ¨¡å¼ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚\né¡¹ç›®æˆæœä¸æ€è€ƒ ç»è¿‡ä¸‰ä¸ªæœˆçš„è¿­ä»£ï¼Œæ‹¼å›¢äº¤æ˜“å¹³å°æˆåŠŸä¸Šçº¿ï¼Œæ ¸å¿ƒæŒ‡æ ‡å¦‚ä¸‹ï¼š\nè®¢å•åˆ›å»ºæ¥å£ RT ä» 800ms é™ä½åˆ° 120ms åº“å­˜æ‰£å‡ TPS ä» 500 æå‡åˆ° 3000+ æ”¯æŒå•æ—¥ç™¾ä¸‡çº§è®¢å•æ•°æ®å†™å…¥ï¼ŒæŸ¥è¯¢æ€§èƒ½ç¨³å®šåœ¨ 50ms ä»¥å†… è¿™ä¸ªé¡¹ç›®æœ€å¤§çš„æ”¶è·ä¸æ˜¯æŠ€æœ¯æ ˆçš„å †ç Œï¼Œè€Œæ˜¯å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„æ·±åº¦ç†è§£ï¼š\næ²¡æœ‰é“¶å¼¹ï¼š Redis åˆ†å¸ƒå¼é”ã€RabbitMQ å¼‚æ­¥ã€ShardingSphere åˆ†åº“åˆ†è¡¨ï¼Œæ¯ä¸ªæŠ€æœ¯æ–¹æ¡ˆéƒ½æœ‰é€‚ç”¨åœºæ™¯å’Œä»£ä»·ã€‚é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆçš„æœ¬è´¨æ˜¯åœ¨æ€§èƒ½ã€ä¸€è‡´æ€§ã€å¤æ‚åº¦ä¹‹é—´åšæƒè¡¡ã€‚\næ¶æ„æ¼”è¿›ï¼š ç³»ç»Ÿä¸æ˜¯ä¸€å¼€å§‹å°±è®¾è®¡æˆåˆ†å¸ƒå¼çš„ã€‚æˆ‘ä»¬æœ€åˆæ˜¯å•ä½“åº”ç”¨ + MySQL ä¸»ä»ï¼Œå½“ TPS åˆ°è¾¾ç“¶é¢ˆåæ‰å¼•å…¥ Redis å’Œ RabbitMQã€‚è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚\nå¯è§‚æµ‹æ€§ï¼š åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤§çš„æŒ‘æˆ˜æ˜¯æ’æŸ¥é—®é¢˜ã€‚æˆ‘ä»¬åœ¨æ¯ä¸ªå…³é”®èŠ‚ç‚¹éƒ½åŸ‹ç‚¹ä¸ŠæŠ¥ç›‘æ§æ•°æ®ï¼ˆè®¢å•åˆ›å»ºæ•°ã€åº“å­˜æ‰£å‡æ•°ã€æ¶ˆæ¯å †ç§¯æ•°ï¼‰ï¼Œé€šè¿‡ Grafana å®æ—¶ç›‘æ§ç³»ç»Ÿå¥åº·åº¦ã€‚\nå¦‚æœè®©æˆ‘é‡æ–°è®¾è®¡è¿™ä¸ªç³»ç»Ÿï¼Œæˆ‘ä¼šåœ¨é¡¹ç›®åˆæœŸå°±å¼•å…¥å…¨é“¾è·¯å‹æµ‹ï¼Œæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆï¼Œè€Œä¸æ˜¯ç­‰åˆ°ä¸Šçº¿åæ‰å‘ç°é—®é¢˜ã€‚\n","permalink":"http://localhost:1313/projects/pindan-trading-platform/","summary":"\u003cp\u003eåœ¨ç”µå•†ä¸šåŠ¡é«˜é€Ÿå‘å±•çš„èƒŒæ™¯ä¸‹ï¼Œæ‹¼å›¢æ¨¡å¼å› å…¶ç¤¾äº¤è£‚å˜å±æ€§æˆä¸ºæµé‡å¢é•¿çš„åˆ©å™¨ã€‚ä½†çœ‹ä¼¼ç®€å•çš„\u0026quot;å‡‘å¤Ÿ N äººæˆå›¢\u0026quot;èƒŒåï¼Œéšè—ç€åº“å­˜è¶…å–ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€æµ·é‡æ•°æ®å­˜å‚¨ç­‰ä¸€ç³»åˆ—æŠ€æœ¯æŒ‘æˆ˜ã€‚æœ¬æ–‡å¤ç›˜æˆ‘åœ¨æ‹¼å›¢äº¤æ˜“å¹³å°é¡¹ç›®ä¸­çš„æ¶æ„è®¾è®¡ä¸æŠ€æœ¯é€‰å‹æ€è€ƒã€‚\u003c/p\u003e\n\u003ch3 id=\"é¡¹ç›®äº®ç‚¹\"\u003eé¡¹ç›®äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e åŸºäº DDD æ€æƒ³çš„é¢†åŸŸæ¨¡å‹è®¾è®¡ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e Redis åˆ†å¸ƒå¼é” + åˆ†åº“åˆ†è¡¨è§£å†³é«˜å¹¶å‘åº“å­˜æ‰£å‡é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e RabbitMQ å¼‚æ­¥è§£è€¦å®ç°å•æ­¥æµæ°´çº¿ï¼Œæå‡ç³»ç»Ÿååé‡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ShardingSphere åˆ†åº“åˆ†è¡¨æ”¯æ’‘æµ·é‡è®¢å•æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜\"\u003eä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜\u003c/h2\u003e\n\u003cp\u003eæ‹¼å›¢äº¤æ˜“çš„æ ¸å¿ƒæµç¨‹çœ‹ä¼¼ç®€å•ï¼šç”¨æˆ·å‘èµ·æ‹¼å›¢ â†’ å…¶ä»–ç”¨æˆ·å‚å›¢ â†’ è¾¾åˆ°äººæ•°åæˆå›¢ â†’ æ‰£å‡åº“å­˜ â†’ é€šçŸ¥æ”¯ä»˜ã€‚ä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªæµç¨‹ä¼šé‡åˆ°ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåº“å­˜è¶…å–ï¼š\u003c/strong\u003e 100 ä»¶å•†å“ï¼Œ1000 äººåŒæ—¶ä¸‹å•ï¼Œå¦‚ä½•ä¿è¯ä¸ä¼šè¶…å–ï¼Ÿä¼ ç»Ÿçš„æ•°æ®åº“è¡Œé”åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤±æ•ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ†å¸ƒå¼äº‹åŠ¡ï¼š\u003c/strong\u003e è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡ã€æ”¯ä»˜é€šçŸ¥åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæµ·é‡æ•°æ®ï¼š\u003c/strong\u003e è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚ä½•ä¿è¯æŸ¥è¯¢æ€§èƒ½ä¸éšæ•°æ®é‡å¢é•¿è€ŒåŠ£åŒ–ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eè¿™äº›é—®é¢˜å€’é€¼æˆ‘ä»¬å¿…é¡»ä»æ¶æ„å±‚é¢é‡æ–°æ€è€ƒç³»ç»Ÿè®¾è®¡ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¶æ„è®¾è®¡ddd-æ€æƒ³çš„è½åœ°å®è·µ\"\u003eæ¶æ„è®¾è®¡ï¼šDDD æ€æƒ³çš„è½åœ°å®è·µ\u003c/h2\u003e\n\u003cp\u003eä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹ä¼šå¯¼è‡´ Service å±‚é€»è¾‘è‡ƒè‚¿ï¼Œä¸šåŠ¡è§„åˆ™æ•£è½åœ¨å„å¤„ã€‚æˆ‘ä»¬é‡‡ç”¨ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ€æƒ³ï¼Œå°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒé¢†åŸŸï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè®¢å•åŸŸï¼ˆOrderï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£æ‹¼å›¢è®¢å•çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€çŠ¶æ€æµè½¬ã€è¶…æ—¶å–æ¶ˆç­‰ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåº“å­˜åŸŸï¼ˆInventoryï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£å•†å“åº“å­˜çš„æ‰£å‡ã€å›æ»šã€é¢„å ç­‰æ“ä½œï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒç“¶é¢ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ”¯ä»˜åŸŸï¼ˆPaymentï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£æ”¯ä»˜æµç¨‹çš„ç¼–æ’ï¼ŒåŒ…æ‹¬æ”¯ä»˜é€šçŸ¥ã€é€€æ¬¾å¤„ç†ç­‰ã€‚\u003c/p\u003e\n\u003cp\u003eæ¯ä¸ªé¢†åŸŸéƒ½æœ‰è‡ªå·±çš„èšåˆæ ¹ï¼ˆAggregate Rootï¼‰å’Œé¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰ã€‚æ¯”å¦‚è®¢å•åŸŸçš„èšåˆæ ¹æ˜¯ \u003ccode\u003eOrder\u003c/code\u003eï¼Œå®ƒå°è£…äº†è®¢å•çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰å¾…æ”¯ä»˜çŠ¶æ€æ‰èƒ½å–æ¶ˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecancel\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePENDING_PAYMENT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ethrow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderCannotCancelException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eCANCELLED\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼šè®¢å•å·²å–æ¶ˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eDomainEventPublisher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003epublish\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderCancelledEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šä¸šåŠ¡è§„åˆ™å†…èšåœ¨é¢†åŸŸå¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨ Service å±‚çš„å„ç§ if-else é‡Œã€‚å½“äº§å“ç»ç†è¯´\u0026quot;å¢åŠ ä¸€ä¸ªæ‹¼å›¢å¤±è´¥è‡ªåŠ¨é€€æ¬¾çš„é€»è¾‘\u0026quot;æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç›‘å¬ \u003ccode\u003eOrderCancelledEvent\u003c/code\u003e äº‹ä»¶ï¼Œè€Œä¸éœ€è¦æ”¹åŠ¨è®¢å•å–æ¶ˆçš„æ ¸å¿ƒé€»è¾‘ã€‚\u003c/p\u003e","title":"æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿï¼šDDD æ¶æ„ä¸‹çš„åˆ†å¸ƒå¼å®æˆ˜"},{"content":"ThreadLocal æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦å·¥å…·ï¼Œå®ƒä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚ä½†å¾ˆå¤šäººåªçŸ¥é“æ€ä¹ˆç”¨ï¼Œä¸çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œæ›´ä¸çŸ¥é“å®ƒå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚æœ¬æ–‡æ·±å…¥å‰–æ ThreadLocal çš„åº•å±‚æœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ ThreadLocal çš„å®ç°åŸç†ä¸ ThreadLocalMap ç»“æ„ æŒæ¡å¼±å¼•ç”¨çš„è®¾è®¡æ„å›¾ä¸å†…å­˜æ³„æ¼çš„æ ¹å›  å­¦ä¼šåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹æ­£ç¡®ä½¿ç”¨ ThreadLocal äº†è§£ InheritableThreadLocal çš„ä½¿ç”¨åœºæ™¯ ThreadLocal çš„ä½¿ç”¨åœºæ™¯ ThreadLocal å¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\nåœºæ™¯ä¸€ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’\n1public class UserContext { 2 private static final ThreadLocal\u0026lt;User\u0026gt; context = new ThreadLocal\u0026lt;\u0026gt;(); 3 4 public static void setUser(User user) { 5 context.set(user); 6 } 7 8 public static User getUser() { 9 return context.get(); 10 } 11 12 public static void remove() { 13 context.remove(); 14 } 15} 16 17// åœ¨ Controller ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯ 18@RestController 19public class UserController { 20 21 @GetMapping(\u0026#34;/user/info\u0026#34;) 22 public UserDTO getUserInfo() { 23 User user = UserContext.getUser(); 24 return UserDTO.from(user); 25 } 26} åœºæ™¯äºŒï¼šæ•°æ®åº“è¿æ¥ç®¡ç†\n1public class ConnectionManager { 2 private static final ThreadLocal\u0026lt;Connection\u0026gt; connectionHolder = new ThreadLocal\u0026lt;\u0026gt;(); 3 4 public static Connection getConnection() { 5 Connection conn = connectionHolder.get(); 6 if (conn == null) { 7 conn = DriverManager.getConnection(url, user, password); 8 connectionHolder.set(conn); 9 } 10 return conn; 11 } 12 13 public static void closeConnection() { 14 Connection conn = connectionHolder.get(); 15 if (conn != null) { 16 conn.close(); 17 connectionHolder.remove(); 18 } 19 } 20} åœºæ™¯ä¸‰ï¼šSimpleDateFormat çº¿ç¨‹å®‰å…¨\nSimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥ç”¨ ThreadLocal ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºç‹¬ç«‹å®ä¾‹ï¼š\n1public class DateUtil { 2 private static final ThreadLocal\u0026lt;SimpleDateFormat\u0026gt; formatter = 3 ThreadLocal.withInitial(() -\u0026gt; new SimpleDateFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;)); 4 5 public static String format(Date date) { 6 return formatter.get().format(date); 7 } 8} ThreadLocal çš„å®ç°åŸç† ThreadLocalMapï¼šçœŸæ­£çš„å­˜å‚¨ç»“æ„\nThreadLocal æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œæ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡çš„ threadLocals å­—æ®µä¸­ï¼š\n1public class Thread { 2 ThreadLocal.ThreadLocalMap threadLocals = null; 3} ThreadLocalMap æ˜¯ ThreadLocal çš„é™æ€å†…éƒ¨ç±»ï¼Œç±»ä¼¼äº HashMapï¼Œä½†å®ç°æ›´ç®€å•ï¼š\n1static class ThreadLocalMap { 2 3 static class Entry extends WeakReference\u0026lt;ThreadLocal\u0026lt;?\u0026gt;\u0026gt; { 4 Object value; 5 6 Entry(ThreadLocal\u0026lt;?\u0026gt; k, Object v) { 7 super(k); // key æ˜¯å¼±å¼•ç”¨ 8 value = v; 9 } 10 } 11 12 private Entry[] table; 13 private int size = 0; 14 private int threshold; 15} å…³é”®ç‚¹ï¼šEntry çš„ key æ˜¯ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ã€‚\nset æ–¹æ³•çš„å®ç°\n1public void set(T value) { 2 Thread t = Thread.currentThread(); 3 ThreadLocalMap map = getMap(t); 4 if (map != null) { 5 map.set(this, value); 6 } else { 7 createMap(t, value); 8 } 9} 10 11ThreadLocalMap getMap(Thread t) { 12 return t.threadLocals; 13} 14 15void createMap(Thread t, T firstValue) { 16 t.threadLocals = new ThreadLocalMap(this, firstValue); 17} æµç¨‹ï¼š\nè·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¦‚æœ map ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ map å°† ThreadLocal ä½œä¸º keyï¼Œvalue ä½œä¸ºå€¼å­˜å…¥ map get æ–¹æ³•çš„å®ç°\n1public T get() { 2 Thread t = Thread.currentThread(); 3 ThreadLocalMap map = getMap(t); 4 if (map != null) { 5 ThreadLocalMap.Entry e = map.getEntry(this); 6 if (e != null) { 7 return (T) e.value; 8 } 9 } 10 return setInitialValue(); 11} 12 13private T setInitialValue() { 14 T value = initialValue(); // é»˜è®¤è¿”å› null 15 Thread t = Thread.currentThread(); 16 ThreadLocalMap map = getMap(t); 17 if (map != null) { 18 map.set(this, value); 19 } else { 20 createMap(t, value); 21 } 22 return value; 23} æ¶æ„æ€è€ƒï¼š ThreadLocal çš„è®¾è®¡å·§å¦™ä¹‹å¤„åœ¨äºï¼šæ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯ ThreadLocal å¯¹è±¡ä¸­ã€‚è¿™æ ·ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®è‡ªå·±çš„æ•°æ®æ—¶ï¼Œä¸éœ€è¦åŠ é”ï¼Œé¿å…äº†çº¿ç¨‹ç«äº‰ã€‚\nå¼±å¼•ç”¨ï¼šä¸ºä»€ä¹ˆ key æ˜¯å¼±å¼•ç”¨ï¼Ÿ å››ç§å¼•ç”¨ç±»å‹\nå¼ºå¼•ç”¨ï¼šæ™®é€šçš„å¯¹è±¡å¼•ç”¨ï¼Œåªè¦å¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶ è½¯å¼•ç”¨ï¼šå†…å­˜ä¸è¶³æ—¶ä¼šè¢«å›æ”¶ å¼±å¼•ç”¨ï¼šä¸‹æ¬¡ GC æ—¶ä¸€å®šä¼šè¢«å›æ”¶ è™šå¼•ç”¨ï¼šæ— æ³•é€šè¿‡å¼•ç”¨è·å–å¯¹è±¡ï¼Œåªç”¨äºè·Ÿè¸ªå¯¹è±¡è¢«å›æ”¶çš„çŠ¶æ€ ä¸ºä»€ä¹ˆ key æ˜¯å¼±å¼•ç”¨ï¼Ÿ\nå‡è®¾ key æ˜¯å¼ºå¼•ç”¨ï¼š\n1ThreadLocal\u0026lt;User\u0026gt; userThreadLocal = new ThreadLocal\u0026lt;\u0026gt;(); 2userThreadLocal.set(new User()); 3 4// ä¸šåŠ¡ä»£ç ä¸å†ä½¿ç”¨ userThreadLocal 5userThreadLocal = null; æ­¤æ—¶ï¼Œè™½ç„¶ userThreadLocal å˜é‡è¢«ç½®ä¸º nullï¼Œä½† ThreadLocalMap ä¸­çš„ Entry ä»ç„¶æŒæœ‰ ThreadLocal çš„å¼ºå¼•ç”¨ï¼Œå¯¼è‡´ ThreadLocal å¯¹è±¡æ— æ³•è¢«å›æ”¶ã€‚\nå¦‚æœ key æ˜¯å¼±å¼•ç”¨ï¼š\n1userThreadLocal = null; 2// ä¸‹æ¬¡ GC æ—¶ï¼ŒThreadLocal å¯¹è±¡ä¼šè¢«å›æ”¶ 3// ThreadLocalMap ä¸­çš„ Entry çš„ key å˜æˆ null è¿™æ ·ï¼ŒThreadLocal å¯¹è±¡å¯ä»¥è¢«åŠæ—¶å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚\nä½†æ˜¯ï¼Œvalue ä»ç„¶æ˜¯å¼ºå¼•ç”¨ï¼\nå³ä½¿ key è¢«å›æ”¶ï¼Œvalue ä»ç„¶å­˜åœ¨ï¼Œè¿™å°±æ˜¯å†…å­˜æ³„æ¼çš„æ ¹æºã€‚\nå†…å­˜æ³„æ¼ï¼šçº¿ç¨‹æ± ç¯å¢ƒä¸‹çš„é™·é˜± é—®é¢˜åœºæ™¯\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); // å‡è®¾æœ‰ 10 ä¸‡æ¡æ•°æ® 8 cache.set(users); 9 10 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 11 doSomething(users); 12 13 // å¿˜è®°è°ƒç”¨ remove() 14 } 15} åœ¨ Tomcat çº¿ç¨‹æ± ç¯å¢ƒä¸‹ï¼š\nè¯·æ±‚åˆ°è¾¾ï¼Œçº¿ç¨‹æ± åˆ†é…çº¿ç¨‹ A å¤„ç†è¯·æ±‚ çº¿ç¨‹ A æ‰§è¡Œ processUsers()ï¼Œå°† 10 ä¸‡æ¡æ•°æ®å­˜å…¥ ThreadLocal è¯·æ±‚ç»“æŸï¼Œçº¿ç¨‹ A è¿”å›çº¿ç¨‹æ± ï¼Œä½† ThreadLocal ä¸­çš„æ•°æ®æ²¡æœ‰æ¸…ç† ä¸‹æ¬¡è¯·æ±‚å¤ç”¨çº¿ç¨‹ A æ—¶ï¼ŒThreadLocal ä¸­ä»ç„¶ä¿å­˜ç€ä¸Šæ¬¡çš„æ•°æ® éšç€è¯·æ±‚å¢å¤šï¼Œæ¯ä¸ªçº¿ç¨‹çš„ ThreadLocal éƒ½ä¼šç§¯ç´¯å¤§é‡æ•°æ®ï¼Œæœ€ç»ˆå¯¼è‡´ OOMã€‚\nå†…å­˜æ³„æ¼çš„æ ¹å› \n1Thread (å¼ºå¼•ç”¨) 2 â†“ 3ThreadLocalMap (å¼ºå¼•ç”¨) 4 â†“ 5Entry[] (å¼ºå¼•ç”¨) 6 â†“ 7Entry.key (å¼±å¼•ç”¨) â†’ ThreadLocal (å¯èƒ½è¢«å›æ”¶) 8Entry.value (å¼ºå¼•ç”¨) â†’ User List (æ— æ³•è¢«å›æ”¶) å³ä½¿ ThreadLocal å¯¹è±¡è¢«å›æ”¶ï¼Œvalue ä»ç„¶è¢« Entry å¼ºå¼•ç”¨ï¼Œæ— æ³•è¢« GC å›æ”¶ã€‚\næ­£ç¡®çš„ä½¿ç”¨æ–¹å¼\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 try { 8 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 9 cache.set(users); 10 doSomething(users); 11 } finally { 12 cache.remove(); // å¿…é¡»åœ¨ finally ä¸­æ¸…ç† 13 } 14 } 15} ThreadLocal çš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶\nThreadLocalMap åœ¨ setã€getã€remove æ—¶ä¼šè§¦å‘æ¸…ç†ï¼š\n1private int expungeStaleEntry(int staleSlot) { 2 Entry[] tab = table; 3 int len = tab.length; 4 5 // æ¸…ç† key ä¸º null çš„ Entry 6 tab[staleSlot].value = null; 7 tab[staleSlot] = null; 8 size--; 9 10 // ç»§ç»­æ‰«æåç»­çš„ Entry 11 Entry e; 12 int i; 13 for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) { 14 ThreadLocal\u0026lt;?\u0026gt; k = e.get(); 15 if (k == null) { 16 e.value = null; 17 tab[i] = null; 18 size--; 19 } 20 } 21 return i; 22} ä½†è¿™ç§æ¸…ç†æ˜¯è¢«åŠ¨çš„ï¼Œä¸èƒ½å®Œå…¨ä¾èµ–ã€‚æœ€ä½³å®è·µæ˜¯æ‰‹åŠ¨è°ƒç”¨ remove()ã€‚\né¿å‘æç¤ºï¼š åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„ç¯å¢ƒä¸‹ï¼ŒThreadLocal å¿…é¡»åœ¨ finally å—ä¸­è°ƒç”¨ remove()ã€‚å¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼å’Œæ•°æ®æ··ä¹±ï¼ˆä¸‹ä¸€ä¸ªè¯·æ±‚å¯èƒ½è¯»åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚çš„æ•°æ®ï¼‰ã€‚\nInheritableThreadLocalï¼šçˆ¶å­çº¿ç¨‹ä¼ é€’ ThreadLocal çš„æ•°æ®æ— æ³•åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä¼ é€’ï¼š\n1ThreadLocal\u0026lt;String\u0026gt; threadLocal = new ThreadLocal\u0026lt;\u0026gt;(); 2threadLocal.set(\u0026#34;parent\u0026#34;); 3 4new Thread(() -\u0026gt; { 5 System.out.println(threadLocal.get()); // è¾“å‡º null 6}).start(); InheritableThreadLocal è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼š\n1InheritableThreadLocal\u0026lt;String\u0026gt; inheritableThreadLocal = new InheritableThreadLocal\u0026lt;\u0026gt;(); 2inheritableThreadLocal.set(\u0026#34;parent\u0026#34;); 3 4new Thread(() -\u0026gt; { 5 System.out.println(inheritableThreadLocal.get()); // è¾“å‡º parent 6}).start(); å®ç°åŸç†\nThread ç±»æœ‰ä¸¤ä¸ª ThreadLocalMap å­—æ®µï¼š\n1public class Thread { 2 ThreadLocal.ThreadLocalMap threadLocals = null; 3 ThreadLocal.ThreadLocalMap inheritableThreadLocals = null; 4} åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œä¼šå¤åˆ¶çˆ¶çº¿ç¨‹çš„ inheritableThreadLocalsï¼š\n1private void init(ThreadGroup g, Runnable target, String name, long stackSize) { 2 Thread parent = currentThread(); 3 4 if (parent.inheritableThreadLocals != null) { 5 this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); 6 } 7} æ³¨æ„äº‹é¡¹\nInheritableThreadLocal åªåœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶å¤åˆ¶æ•°æ®ï¼Œå¦‚æœä½¿ç”¨çº¿ç¨‹æ± ï¼Œå­çº¿ç¨‹ä¼šè¢«å¤ç”¨ï¼Œæ•°æ®ä¸ä¼šæ›´æ–°ã€‚\nè§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨é˜¿é‡Œå¼€æºçš„ TransmittableThreadLocalï¼ˆTTLï¼‰ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šæ’æŸ¥ ThreadLocal å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOMã€‚é€šè¿‡ MAT åˆ†æ Heap Dumpï¼Œå‘ç°å¤§é‡ ThreadLocalMap.Entry å¯¹è±¡ã€‚\næ’æŸ¥æ­¥éª¤\næŸ¥çœ‹ Dominator Treeï¼Œå‘ç° Thread å¯¹è±¡å ç”¨äº†å¤§é‡å†…å­˜ å±•å¼€ Thread å¯¹è±¡ï¼Œå‘ç° threadLocals å­—æ®µä¸­æœ‰å¤§é‡ Entry æŸ¥çœ‹ Entry çš„ valueï¼Œå‘ç°æ˜¯ä¸šåŠ¡å¯¹è±¡ï¼ˆUser Listï¼‰ é€šè¿‡å¼•ç”¨é“¾æ‰¾åˆ°åˆ›å»º ThreadLocal çš„ä»£ç ä½ç½® ä¿®å¤æ–¹æ¡ˆ\nåœ¨æ‰€æœ‰ä½¿ç”¨ ThreadLocal çš„åœ°æ–¹ï¼Œæ·»åŠ  finally å—è°ƒç”¨ remove()ï¼š\n1try { 2 threadLocal.set(value); 3 // ä¸šåŠ¡é€»è¾‘ 4} finally { 5 threadLocal.remove(); 6} é¢„é˜²æªæ–½\nCode Review é‡ç‚¹å…³æ³¨ ThreadLocal çš„ä½¿ç”¨ ä½¿ç”¨ Alibaba Java Coding Guidelines æ’ä»¶ï¼Œè‡ªåŠ¨æ£€æµ‹ ThreadLocal æœªè°ƒç”¨ remove() åœ¨å•å…ƒæµ‹è¯•ä¸­æ¨¡æ‹Ÿçº¿ç¨‹æ± ç¯å¢ƒï¼Œæ£€æµ‹å†…å­˜æ³„æ¼ æ€»ç»“ä¸æ€è€ƒ ThreadLocal çš„æ ¸å¿ƒåŸç†ï¼š\næ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡çš„ ThreadLocalMap ä¸­ key æ˜¯ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ å¼±å¼•ç”¨è®¾è®¡é¿å…äº† ThreadLocal å¯¹è±¡çš„å†…å­˜æ³„æ¼ï¼Œä½† value ä»å¯èƒ½æ³„æ¼ ä½¿ç”¨ ThreadLocal çš„æœ€ä½³å®è·µï¼š\nåœ¨ finally å—ä¸­è°ƒç”¨ remove() é¿å…å­˜å‚¨å¤§å¯¹è±¡ ä½¿ç”¨ try-with-resources æ¨¡å¼å°è£… ThreadLocal ä¸‹æ¬¡å½“ä½ ä½¿ç”¨ ThreadLocal æ—¶ï¼Œè®°å¾—é—®è‡ªå·±ï¼šæˆ‘åœ¨ finally ä¸­è°ƒç”¨ remove() äº†å—ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/02/threadlocal-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eThreadLocal æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦å·¥å…·ï¼Œå®ƒä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚ä½†å¾ˆå¤šäººåªçŸ¥é“æ€ä¹ˆç”¨ï¼Œä¸çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œæ›´ä¸çŸ¥é“å®ƒå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚æœ¬æ–‡æ·±å…¥å‰–æ ThreadLocal çš„åº•å±‚æœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ ThreadLocal çš„å®ç°åŸç†ä¸ ThreadLocalMap ç»“æ„\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å¼±å¼•ç”¨çš„è®¾è®¡æ„å›¾ä¸å†…å­˜æ³„æ¼çš„æ ¹å› \u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹æ­£ç¡®ä½¿ç”¨ ThreadLocal\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ InheritableThreadLocal çš„ä½¿ç”¨åœºæ™¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"threadlocal-çš„ä½¿ç”¨åœºæ™¯\"\u003eThreadLocal çš„ä½¿ç”¨åœºæ™¯\u003c/h2\u003e\n\u003cp\u003eThreadLocal å¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserContext\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efinal\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadLocal\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadLocal\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003esetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// åœ¨ Controller ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@RestController\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserController\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@GetMapping\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/user/info\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserDTO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUserInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserDTO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šæ•°æ®åº“è¿æ¥ç®¡ç†\u003c/strong\u003e\u003c/p\u003e","title":"ThreadLocal åŸç†ä¸å†…å­˜æ³„æ¼æ’æŸ¥å®æˆ˜"},{"content":"åœ¨ Java å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ ¸å¿ƒæœºåˆ¶ã€‚ä»æœ€æ—©çš„ synchronized åˆ° JDK 1.5 å¼•å…¥çš„ AQS æ¡†æ¶ï¼ŒJava çš„é”æœºåˆ¶ç»å†äº†å·¨å¤§çš„æ¼”è¿›ã€‚ç†è§£è¿™ä¸ªæ¼”è¿›è¿‡ç¨‹ï¼Œæ˜¯æŒæ¡ Java å¹¶å‘ç¼–ç¨‹çš„å…³é”®ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ synchronized çš„é”å‡çº§è¿‡ç¨‹ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼‰ æŒæ¡ AQS çš„æ ¸å¿ƒåŸç†ä¸åº”ç”¨åœºæ™¯ å­¦ä¼šé€‰æ‹© ReentrantLock è¿˜æ˜¯ synchronized äº†è§£ CAS æ“ä½œä¸è‡ªæ—‹é”çš„å®ç° synchronizedï¼šä»é‡é‡çº§åˆ°è½»é‡çº§ åœ¨ JDK 1.6 ä¹‹å‰ï¼Œsynchronized æ˜¯é‡é‡çº§é”ï¼Œæ¯æ¬¡åŠ é”éƒ½éœ€è¦æ“ä½œç³»ç»Ÿçš„ mutex äº’æ–¥é‡ï¼Œæ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\nJDK 1.6 å¯¹ synchronized è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œå¼•å…¥äº†é”å‡çº§æœºåˆ¶ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”ã€‚\nå¯¹è±¡å¤´ï¼šé”ä¿¡æ¯çš„å­˜å‚¨ä½ç½®\nJava å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……ã€‚é”ä¿¡æ¯å­˜å‚¨åœ¨å¯¹è±¡å¤´çš„ Mark Word ä¸­ã€‚\nMark Word çš„ç»“æ„ï¼ˆ64 ä½ JVMï¼‰ï¼š\n1|--------------------------------------------------------------| 2| é”çŠ¶æ€ | 25bit | 31bit | 1bit | 4bit | 1bitåå‘é” | 2bité”æ ‡å¿— | 3|--------------------------------------------------------------| 4| æ— é” | unused | hashcode | unused | age | 0 | 01 | 5| åå‘é” | ThreadID | Epoch | unused | age | 1 | 01 | 6| è½»é‡çº§é” | æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ | 00 | 7| é‡é‡çº§é” | æŒ‡å‘äº’æ–¥é‡çš„æŒ‡é’ˆ | 10 | åå‘é”ï¼šå•çº¿ç¨‹åœºæ™¯çš„ä¼˜åŒ–\nå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–ã€‚åå‘é”çš„æ€æƒ³æ˜¯ï¼šç¬¬ä¸€æ¬¡è·å–é”æ—¶ï¼Œåœ¨å¯¹è±¡å¤´ä¸­è®°å½•çº¿ç¨‹ IDï¼Œåç»­è¯¥çº¿ç¨‹å†æ¬¡è·å–é”æ—¶ï¼Œåªéœ€è¦åˆ¤æ–­ Mark Word ä¸­çš„çº¿ç¨‹ ID æ˜¯å¦æ˜¯è‡ªå·±ï¼Œæ— éœ€ CAS æ“ä½œã€‚\n1public class BiasedLockDemo { 2 private static Object lock = new Object(); 3 4 public static void main(String[] args) { 5 // ç¬¬ä¸€æ¬¡åŠ é”ï¼šå‡çº§ä¸ºåå‘é” 6 synchronized (lock) { 7 System.out.println(\u0026#34;ç¬¬ä¸€æ¬¡åŠ é”\u0026#34;); 8 } 9 10 // ç¬¬äºŒæ¬¡åŠ é”ï¼šç›´æ¥è·å–åå‘é”ï¼Œæ— éœ€ CAS 11 synchronized (lock) { 12 System.out.println(\u0026#34;ç¬¬äºŒæ¬¡åŠ é”\u0026#34;); 13 } 14 } 15} åå‘é”çš„æ’¤é”€ï¼šå½“å…¶ä»–çº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œåå‘é”ä¼šæ’¤é”€ï¼Œå‡çº§ä¸ºè½»é‡çº§é”ã€‚\nè½»é‡çº§é”ï¼šå¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡Œçš„ä¼˜åŒ–\nå½“æœ‰ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿è·å–é”ï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä½¿ç”¨è½»é‡çº§é”ã€‚è½»é‡çº§é”é€šè¿‡ CAS æ“ä½œå°† Mark Word æ›¿æ¢ä¸ºæŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆã€‚\n1// çº¿ç¨‹ A 2synchronized (lock) { 3 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 4} 5 6// çº¿ç¨‹ Bï¼ˆåœ¨ A é‡Šæ”¾é”åæ‰è·å–ï¼‰ 7synchronized (lock) { 8 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 9} è½»é‡çº§é”çš„åŠ é”æµç¨‹ï¼š\nåœ¨æ ˆå¸§ä¸­åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰ å°†å¯¹è±¡å¤´çš„ Mark Word å¤åˆ¶åˆ°é”è®°å½•ä¸­ é€šè¿‡ CAS å°†å¯¹è±¡å¤´çš„ Mark Word æ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆ å¦‚æœ CAS æˆåŠŸï¼Œè·å–é”ï¼›å¦‚æœå¤±è´¥ï¼Œè‡ªæ—‹é‡è¯• é‡é‡çº§é”ï¼šå¤šçº¿ç¨‹ç«äº‰çš„æœ€ç»ˆæ–¹æ¡ˆ\nå½“è‡ªæ—‹æ¬¡æ•°è¿‡å¤šï¼ˆé»˜è®¤ 10 æ¬¡ï¼‰ï¼Œæˆ–è€…æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰é”ï¼Œè½»é‡çº§é”ä¼šå‡çº§ä¸ºé‡é‡çº§é”ã€‚é‡é‡çº§é”ä¼šé˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œé€šè¿‡æ“ä½œç³»ç»Ÿçš„ mutex å®ç°ã€‚\n1// å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰ 2for (int i = 0; i \u0026lt; 10; i++) { 3 new Thread(() -\u0026gt; { 4 synchronized (lock) { 5 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 6 } 7 }).start(); 8} æ¶æ„æ€è€ƒï¼š synchronized çš„é”å‡çº§ä½“ç°äº†\u0026quot;é€‚åº”æ€§ä¼˜åŒ–\u0026quot;çš„æ€æƒ³ã€‚åœ¨ä¸åŒçš„ç«äº‰åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ä¸åŒçš„é”å®ç°ï¼Œåœ¨æ€§èƒ½å’Œæ­£ç¡®æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ MySQL çš„è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ã€JVM çš„åˆ†å±‚ç¼–è¯‘ã€‚\nAQSï¼šå¹¶å‘å·¥å…·çš„åŸºçŸ³ AQSï¼ˆAbstractQueuedSynchronizerï¼‰æ˜¯ JDK 1.5 å¼•å…¥çš„å¹¶å‘æ¡†æ¶ï¼ŒReentrantLockã€Semaphoreã€CountDownLatch ç­‰å·¥å…·éƒ½åŸºäº AQS å®ç°ã€‚\nAQS çš„æ ¸å¿ƒæ€æƒ³\nAQS ç»´æŠ¤äº†ä¸€ä¸ª volatile int state å˜é‡å’Œä¸€ä¸ª FIFO é˜Ÿåˆ—ã€‚\nstateï¼šè¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼ˆ0 è¡¨ç¤ºæœªé”å®šï¼Œ1 è¡¨ç¤ºå·²é”å®šï¼‰ FIFO é˜Ÿåˆ—ï¼šå­˜å‚¨ç­‰å¾…è·å–é”çš„çº¿ç¨‹ ç‹¬å æ¨¡å¼ï¼šReentrantLock çš„å®ç°\nReentrantLock çš„åŠ é”æµç¨‹ï¼š\n1public class ReentrantLock { 2 3 private final Sync sync; 4 5 public void lock() { 6 sync.acquire(1); 7 } 8 9 abstract static class Sync extends AbstractQueuedSynchronizer { 10 11 final boolean tryAcquire(int acquires) { 12 final Thread current = Thread.currentThread(); 13 int c = getState(); 14 15 // å¦‚æœ state == 0ï¼Œè¯´æ˜é”æœªè¢«å ç”¨ 16 if (c == 0) { 17 if (compareAndSetState(0, acquires)) { 18 setExclusiveOwnerThread(current); 19 return true; 20 } 21 } 22 // å¦‚æœæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é”ï¼Œæ”¯æŒé‡å…¥ 23 else if (current == getExclusiveOwnerThread()) { 24 int nextc = c + acquires; 25 setState(nextc); 26 return true; 27 } 28 return false; 29 } 30 } 31} å¦‚æœ tryAcquire å¤±è´¥ï¼Œçº¿ç¨‹ä¼šè¢«åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼š\n1private Node addWaiter(Node mode) { 2 Node node = new Node(Thread.currentThread(), mode); 3 Node pred = tail; 4 5 // å¿«é€Ÿå°è¯•åœ¨é˜Ÿå°¾æ·»åŠ  6 if (pred != null) { 7 node.prev = pred; 8 if (compareAndSetTail(pred, node)) { 9 pred.next = node; 10 return node; 11 } 12 } 13 14 // å¦‚æœå¤±è´¥ï¼Œé€šè¿‡è‡ªæ—‹æ·»åŠ  15 enq(node); 16 return node; 17} ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å«çº¿ç¨‹å¼•ç”¨å’Œç­‰å¾…çŠ¶æ€ã€‚\nå…±äº«æ¨¡å¼ï¼šSemaphore çš„å®ç°\nSemaphore å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®èµ„æºï¼Œé€šè¿‡ state è¡¨ç¤ºå¯ç”¨è®¸å¯æ•°ã€‚\n1public class Semaphore { 2 3 private final Sync sync; 4 5 public void acquire() throws InterruptedException { 6 sync.acquireSharedInterruptibly(1); 7 } 8 9 abstract static class Sync extends AbstractQueuedSynchronizer { 10 11 final int tryAcquireShared(int acquires) { 12 for (;;) { 13 int available = getState(); 14 int remaining = available - acquires; 15 16 // å¦‚æœè®¸å¯ä¸è¶³ï¼Œè¿”å›è´Ÿæ•° 17 if (remaining \u0026lt; 0) { 18 return remaining; 19 } 20 21 // é€šè¿‡ CAS æ‰£å‡è®¸å¯ 22 if (compareAndSetState(available, remaining)) { 23 return remaining; 24 } 25 } 26 } 27 } 28} å…±äº«æ¨¡å¼ä¸‹ï¼Œé‡Šæ”¾é”æ—¶ä¼šå”¤é†’é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚\né¿å‘æç¤ºï¼š AQS çš„ state æ˜¯ volatile çš„ï¼Œä¿è¯äº†å¯è§æ€§ï¼Œä½†ä¸ä¿è¯åŸå­æ€§ã€‚æ‰€ä»¥ä¿®æ”¹ state æ—¶å¿…é¡»ä½¿ç”¨ CAS æ“ä½œã€‚\nReentrantLock vs synchronized åŠŸèƒ½å¯¹æ¯”\nç‰¹æ€§ synchronized ReentrantLock é”çš„å®ç° JVM å±‚é¢ JDK å±‚é¢ å¯é‡å…¥æ€§ æ”¯æŒ æ”¯æŒ å…¬å¹³é” ä¸æ”¯æŒ æ”¯æŒ å¯ä¸­æ–­ ä¸æ”¯æŒ æ”¯æŒ è¶…æ—¶è·å– ä¸æ”¯æŒ æ”¯æŒ æ¡ä»¶å˜é‡ å•ä¸ªï¼ˆwait/notifyï¼‰ å¤šä¸ªï¼ˆConditionï¼‰ æ€§èƒ½å¯¹æ¯”\nåœ¨ JDK 1.6 ä¹‹åï¼Œsynchronized ç»è¿‡ä¼˜åŒ–ï¼Œæ€§èƒ½å·²ç»å’Œ ReentrantLock ç›¸å½“ã€‚åœ¨ä½ç«äº‰åœºæ™¯ä¸‹ï¼Œsynchronized ç”šè‡³æ›´å¿«ï¼ˆå› ä¸ºæœ‰é”æ¶ˆé™¤å’Œé”ç²—åŒ–ä¼˜åŒ–ï¼‰ã€‚\nä½¿ç”¨å»ºè®®\nä¼˜å…ˆä½¿ç”¨ synchronizedï¼šä»£ç ç®€æ´ï¼ŒJVM ä¼šè‡ªåŠ¨ä¼˜åŒ– éœ€è¦é«˜çº§ç‰¹æ€§æ—¶ä½¿ç”¨ ReentrantLockï¼šå…¬å¹³é”ã€å¯ä¸­æ–­ã€è¶…æ—¶è·å– å®æˆ˜æ¡ˆä¾‹ï¼šå¯ä¸­æ–­é”\n1public class InterruptibleLockDemo { 2 3 private final ReentrantLock lock = new ReentrantLock(); 4 5 public void doWork() throws InterruptedException { 6 // å¯ä¸­æ–­åœ°è·å–é” 7 lock.lockInterruptibly(); 8 try { 9 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 10 Thread.sleep(10000); 11 } finally { 12 lock.unlock(); 13 } 14 } 15 16 public static void main(String[] args) throws InterruptedException { 17 InterruptibleLockDemo demo = new InterruptibleLockDemo(); 18 19 Thread t1 = new Thread(() -\u0026gt; { 20 try { 21 demo.doWork(); 22 } catch (InterruptedException e) { 23 System.out.println(\u0026#34;çº¿ç¨‹è¢«ä¸­æ–­\u0026#34;); 24 } 25 }); 26 27 t1.start(); 28 Thread.sleep(1000); 29 t1.interrupt(); // ä¸­æ–­çº¿ç¨‹ 30 } 31} å¦‚æœä½¿ç”¨ synchronizedï¼Œçº¿ç¨‹æ— æ³•è¢«ä¸­æ–­ï¼Œåªèƒ½ç­‰å¾…é”é‡Šæ”¾ã€‚\nCAS ä¸è‡ªæ—‹é” CASï¼ˆCompare And Swapï¼‰æ˜¯å®ç°æ— é”å¹¶å‘çš„åŸºç¡€ã€‚\nCAS çš„åŸç†\nCAS åŒ…å«ä¸‰ä¸ªæ“ä½œæ•°ï¼šå†…å­˜ä½ç½® Vã€é¢„æœŸå€¼ Aã€æ–°å€¼ Bã€‚åªæœ‰å½“ V çš„å€¼ç­‰äº A æ—¶ï¼Œæ‰ä¼šå°† V æ›´æ–°ä¸º Bã€‚\n1public class AtomicInteger { 2 3 private volatile int value; 4 5 public final boolean compareAndSet(int expect, int update) { 6 return unsafe.compareAndSwapInt(this, valueOffset, expect, update); 7 } 8 9 public final int incrementAndGet() { 10 for (;;) { 11 int current = get(); 12 int next = current + 1; 13 if (compareAndSet(current, next)) { 14 return next; 15 } 16 } 17 } 18} CAS çš„ä¼˜åŠ¿ï¼šæ— éœ€åŠ é”ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\nCAS çš„é—®é¢˜ï¼š\nABA é—®é¢˜ï¼šå€¼ä» A å˜æˆ Bï¼Œå†å˜å› Aï¼ŒCAS æ— æ³•æ„ŸçŸ¥ è‡ªæ—‹å¼€é”€ï¼šå¦‚æœé•¿æ—¶é—´ CAS å¤±è´¥ï¼Œä¼šæµªè´¹ CPU åªèƒ½ä¿è¯å•ä¸ªå˜é‡çš„åŸå­æ€§ è‡ªæ—‹é”çš„å®ç°\n1public class SpinLock { 2 3 private AtomicReference\u0026lt;Thread\u0026gt; owner = new AtomicReference\u0026lt;\u0026gt;(); 4 5 public void lock() { 6 Thread current = Thread.currentThread(); 7 // è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ° CAS æˆåŠŸ 8 while (!owner.compareAndSet(null, current)) { 9 } 10 } 11 12 public void unlock() { 13 Thread current = Thread.currentThread(); 14 owner.compareAndSet(current, null); 15 } 16} è‡ªæ—‹é”é€‚åˆé”æŒæœ‰æ—¶é—´å¾ˆçŸ­çš„åœºæ™¯ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡çš„å¼€é”€ã€‚\næ€»ç»“ä¸æ€è€ƒ Java é”æœºåˆ¶çš„æ¼”è¿›ä½“ç°äº†æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€æƒ³ï¼šåœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ã€‚\nsynchronizedï¼šä»é‡é‡çº§é”ä¼˜åŒ–ä¸ºé”å‡çº§æœºåˆ¶ï¼Œé€‚åº”ä¸åŒç«äº‰åœºæ™¯ AQSï¼šæä¾›äº†çµæ´»çš„å¹¶å‘å·¥å…·æ¡†æ¶ï¼Œæ”¯æŒç‹¬å å’Œå…±äº«æ¨¡å¼ CASï¼šæ— é”å¹¶å‘çš„åŸºç¡€ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡ ç†è§£è¿™äº›æœºåˆ¶ï¼Œæ‰èƒ½åœ¨å®é™…å¼€å‘ä¸­é€‰æ‹©åˆé€‚çš„å¹¶å‘å·¥å…·ï¼Œå†™å‡ºé«˜æ€§èƒ½çš„å¹¶å‘ä»£ç ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åŠ é”æ—¶ï¼Œä¸å¦¨æƒ³æƒ³ï¼šè¿™ä¸ªåœºæ™¯é€‚åˆ synchronized è¿˜æ˜¯ ReentrantLockï¼Ÿæ˜¯å¦å¯ä»¥ç”¨ CAS å®ç°æ— é”å¹¶å‘ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/01/java-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%BB%8E-synchronized-%E5%88%B0-aqs-%E7%9A%84%E6%BC%94%E8%BF%9B/","summary":"\u003cp\u003eåœ¨ Java å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ ¸å¿ƒæœºåˆ¶ã€‚ä»æœ€æ—©çš„ synchronized åˆ° JDK 1.5 å¼•å…¥çš„ AQS æ¡†æ¶ï¼ŒJava çš„é”æœºåˆ¶ç»å†äº†å·¨å¤§çš„æ¼”è¿›ã€‚ç†è§£è¿™ä¸ªæ¼”è¿›è¿‡ç¨‹ï¼Œæ˜¯æŒæ¡ Java å¹¶å‘ç¼–ç¨‹çš„å…³é”®ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ synchronized çš„é”å‡çº§è¿‡ç¨‹ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼‰\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ AQS çš„æ ¸å¿ƒåŸç†ä¸åº”ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé€‰æ‹© ReentrantLock è¿˜æ˜¯ synchronized\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ CAS æ“ä½œä¸è‡ªæ—‹é”çš„å®ç°\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"synchronizedä»é‡é‡çº§åˆ°è½»é‡çº§\"\u003esynchronizedï¼šä»é‡é‡çº§åˆ°è½»é‡çº§\u003c/h2\u003e\n\u003cp\u003eåœ¨ JDK 1.6 ä¹‹å‰ï¼Œsynchronized æ˜¯é‡é‡çº§é”ï¼Œæ¯æ¬¡åŠ é”éƒ½éœ€è¦æ“ä½œç³»ç»Ÿçš„ mutex äº’æ–¥é‡ï¼Œæ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\u003c/p\u003e\n\u003cp\u003eJDK 1.6 å¯¹ synchronized è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œå¼•å…¥äº†é”å‡çº§æœºåˆ¶ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå¯¹è±¡å¤´ï¼šé”ä¿¡æ¯çš„å­˜å‚¨ä½ç½®\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eJava å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……ã€‚é”ä¿¡æ¯å­˜å‚¨åœ¨å¯¹è±¡å¤´çš„ Mark Word ä¸­ã€‚\u003c/p\u003e\n\u003cp\u003eMark Word çš„ç»“æ„ï¼ˆ64 ä½ JVMï¼‰ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e|--------------------------------------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e| é”çŠ¶æ€   | 25bit | 31bit | 1bit | 4bit | 1bitåå‘é” | 2bité”æ ‡å¿— |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e|--------------------------------------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e| æ— é”     | unused | hashcode | unused | age | 0 | 01 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e| åå‘é”   | ThreadID | Epoch | unused | age | 1 | 01 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e| è½»é‡çº§é” | æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ | 00 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e| é‡é‡çº§é” | æŒ‡å‘äº’æ–¥é‡çš„æŒ‡é’ˆ | 10 |\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåå‘é”ï¼šå•çº¿ç¨‹åœºæ™¯çš„ä¼˜åŒ–\u003c/strong\u003e\u003c/p\u003e","title":"Java å¹¶å‘ç¼–ç¨‹ï¼šä» synchronized åˆ° AQS çš„æ¼”è¿›"},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"ä½ å¥½ï¼Œæˆ‘æ˜¯ wawayu ä¸€åä¸“æ³¨äºåˆ†å¸ƒå¼ç³»ç»Ÿå’Œé«˜å¹¶å‘æ¶æ„çš„ Java åç«¯å¼€å‘å·¥ç¨‹å¸ˆã€‚æˆ‘çƒ­è¡·äºç”¨æŠ€æœ¯è§£å†³å®é™…ä¸šåŠ¡é—®é¢˜ï¼Œæ“…é•¿ä» 0 åˆ° 1 è®¾è®¡å’Œå®ç°å¤æ‚ç³»ç»Ÿã€‚\nç›®å‰åœ¨æŸæ˜•ç½‘ç»œç§‘æŠ€å…¬å¸æ‹…ä»» Java å¼€å‘å®ä¹ ç”Ÿï¼Œè´Ÿè´£å¿«é€Ÿè¿­ä»£ä¸äº¤ä»˜ 20+ ä¸ªå®šåˆ¶åŒ–é¡¹ç›®ï¼Œç§¯ç´¯äº†ä¸°å¯Œçš„ä¸šåŠ¡å¼€å‘å’Œç³»ç»Ÿä¼˜åŒ–ç»éªŒã€‚\næˆ‘çš„æŠ€æœ¯ç†å¿µ ä»£ç æ˜¯å†™ç»™äººçœ‹çš„ï¼Œé¡ºä¾¿è®©æœºå™¨æ‰§è¡Œ æ¶æ„è®¾è®¡è¦é€‚é…ä¸šåŠ¡å¤æ‚åº¦ï¼Œé¿å…è¿‡åº¦è®¾è®¡ æ€§èƒ½ä¼˜åŒ–è¦åŸºäºæ•°æ®é©±åŠ¨ï¼Œè€Œä¸æ˜¯å‡­æ„Ÿè§‰ æŠ€æœ¯çš„æœ¬è´¨æ˜¯è§£å†³é—®é¢˜ï¼Œè€Œä¸æ˜¯ç‚«æŠ€ æ•™è‚²èƒŒæ™¯ å¤ªåŸç†å·¥å¤§å­¦ - è½¯ä»¶å·¥ç¨‹ï¼ˆåŒä¸€æµï¼‰ - æœ¬ç§‘ (2022.09 - 2026.06) å·¥ä½œç»å† æŸæ˜•ç½‘ç»œç§‘æŠ€å…¬å¸ - Java å¼€å‘å®ä¹ ç”Ÿ (2024.06 - 2024.12)\nè´Ÿè´£å¿«é€Ÿå¼€å‘ä¸äº¤ä»˜ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¸»åŠ¨æ•´ç†é€šç”¨ä»£ç æ¨¡ç‰ˆï¼Œå‡å°‘äº†é‡å¤ CRUD å·¥ä½œï¼Œé…åˆå›¢é˜Ÿé«˜æ•ˆäº¤ä»˜äº† 20+ ä¸ªå®šåˆ¶åŒ–é¡¹ç›®ã€‚\næ ¸å¿ƒæˆæœï¼š\nè®¾è®¡å¹¶å®ç°åŠ¨æ€çº¿ç¨‹æ±  SDKï¼Œæ”¯æŒå‚æ•°å®æ—¶è°ƒæ•´å’Œå¯è§†åŒ–ç›‘æ§ å‚ä¸æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿå¼€å‘ï¼Œè´Ÿè´£ DDD æ¶æ„è®¾è®¡å’Œåˆ†å¸ƒå¼é”ä¼˜åŒ– ä¼˜åŒ–æ ¸å¿ƒæ¥å£æ€§èƒ½ï¼ŒRT ä» 800ms é™ä½åˆ° 120ms æŠ€æœ¯ä¸“é•¿ è¯¦è§ æŠ€èƒ½æ ˆ\né¡¹ç›®ä½œå“ è¯¦è§ é¡¹ç›®å±•ç¤º\nå¼€æºè´¡çŒ® æ­£åœ¨ç­¹å¤‡ä¸­ï¼Œè®¡åˆ’å¼€æºåŠ¨æ€çº¿ç¨‹æ±  SDK å’Œä¸€äº›å®ç”¨å·¥å…·åº“ã€‚\nè”ç³»æ–¹å¼ Email: your-email@example.com GitHub: github.com/wawayu-dev åšå®¢: ä½ æ­£åœ¨æµè§ˆçš„è¿™ä¸ªç«™ç‚¹ å…³äºè¿™ä¸ªåšå®¢ è¿™ä¸ªåšå®¢æ˜¯æˆ‘çš„æŠ€æœ¯ç¬”è®°å’Œæ€è€ƒæ²‰æ·€çš„åœ°æ–¹ã€‚æˆ‘ä¼šåœ¨è¿™é‡Œåˆ†äº«ï¼š\né¡¹ç›®å®æˆ˜ç»éªŒå’Œè¸©å‘è®°å½• æŠ€æœ¯åŸç†çš„æ·±åº¦å‰–æ æ¶æ„è®¾è®¡çš„æ€è€ƒä¸å®è·µ å­¦ä¹ æ–¹æ³•å’Œæˆé•¿å¿ƒå¾— å¦‚æœä½ å¯¹æŸä¸ªè¯é¢˜æ„Ÿå…´è¶£ï¼Œæˆ–è€…å‘ç°æ–‡ç« ä¸­çš„é—®é¢˜ï¼Œæ¬¢è¿é€šè¿‡é‚®ä»¶æˆ– GitHub ä¸æˆ‘äº¤æµã€‚\nè¿™ä¸ªç½‘ç«™ä½¿ç”¨ Hugo + PaperMod æ­å»ºï¼Œæ‰˜ç®¡åœ¨ GitHub Pages\n","permalink":"http://localhost:1313/about/","summary":"Java åç«¯å¼€å‘å·¥ç¨‹å¸ˆ | åˆ†å¸ƒå¼ç³»ç»Ÿå®è·µè€…","title":"å…³äºæˆ‘"},{"content":"ç¼–ç¨‹è¯­è¨€ è¯­è¨€ ç†Ÿç»ƒåº¦ ä¸»è¦ç”¨é€” Java â­â­â­â­â­ åç«¯å¼€å‘ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€å¾®æœåŠ¡æ¶æ„ SQL â­â­â­â­ æ•°æ®åº“è®¾è®¡ã€æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•è°ƒä¼˜ JavaScript â­â­â­ å‰ç«¯å¼€å‘ã€Vue 3 åº”ç”¨ æ ¸å¿ƒæŠ€æœ¯æ ˆ åç«¯æ¡†æ¶ä¸ä¸­é—´ä»¶ Spring ç”Ÿæ€\nSpring Bootï¼šç†Ÿæ‚‰è‡ªåŠ¨è£…é…åŸç†ï¼Œèƒ½å¤Ÿè‡ªå®šä¹‰ Starter Spring AOP/IOCï¼šç†è§£æ ¸å¿ƒæ€æƒ³ï¼Œç†Ÿæ‚‰ Bean ç”Ÿå‘½å‘¨æœŸ MyBatis-Plusï¼šå¿«é€Ÿå¼€å‘ CRUDï¼Œç†Ÿæ‚‰ä»£ç ç”Ÿæˆå’Œé€šç”¨ Mapper åˆ†å¸ƒå¼ä¸é«˜å¹¶å‘\nRedisï¼šåˆ†å¸ƒå¼é”ï¼ˆRedissonï¼‰ã€ç¼“å­˜æ¶æ„è®¾è®¡ã€Pub/Sub æœºåˆ¶ RabbitMQï¼šæ¶ˆæ¯å¯é æ€§ä¿éšœã€å¼‚æ­¥è§£è€¦ã€æ­»ä¿¡é˜Ÿåˆ— Netty + WebSocketï¼šå®æ—¶æ¶ˆæ¯æ¨é€ã€é•¿è¿æ¥ç®¡ç† æ•°æ®åº“\nMySQLï¼šç´¢å¼•ä¼˜åŒ–ã€äº‹åŠ¡éš”ç¦»çº§åˆ«ã€MVCC æœºåˆ¶ã€B+ æ ‘ç´¢å¼•å¼•æ“ ShardingSphereï¼šåˆ†åº“åˆ†è¡¨å®æˆ˜ã€åˆ†ç‰‡ç­–ç•¥è®¾è®¡ æ¶æ„è®¾è®¡ è®¾è®¡æ¨¡å¼ä¸æ¶æ„æ€æƒ³\nDDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰ï¼šèšåˆæ ¹ã€é™ç•Œä¸Šä¸‹æ–‡ã€é¢†åŸŸäº‹ä»¶ è®¾è®¡æ¨¡å¼ï¼šç†Ÿæ‚‰ç­–ç•¥ã€æ¨¡æ¿æ–¹æ³•ã€è´£ä»»é“¾ç­‰å¸¸ç”¨æ¨¡å¼ è§„åˆ™å¼•æ“ï¼šç†è§£å¦‚ä½•é€šè¿‡è§„åˆ™å¼•æ“åˆ¤æ–­å¤æ‚ä¸šåŠ¡é€»è¾‘ æ€§èƒ½ä¼˜åŒ–\nJVM è°ƒä¼˜ï¼šç†è§£ GC æœºåˆ¶ã€å†…å­˜æ¨¡å‹ã€OOM æ’æŸ¥ æ¥å£ä¼˜åŒ–ï¼šä» 800ms ä¼˜åŒ–åˆ° 120ms çš„å®æˆ˜ç»éªŒ æ•°æ®åº“ä¼˜åŒ–ï¼šSQL è°ƒä¼˜ã€ç´¢å¼•è®¾è®¡ã€åˆ†åº“åˆ†è¡¨ å‰ç«¯æŠ€æœ¯ Vue 3ï¼šComposition APIã€å‰åç«¯åˆ†ç¦»å¼€å‘ EasyExcelï¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€å†…å­˜ä¼˜åŒ– å·¥å…·ä¸è¿ç»´ å¼€å‘å·¥å…·\nGitï¼šåˆ†æ”¯ç®¡ç†ã€ä»£ç å®¡æŸ¥ã€å›¢é˜Ÿåä½œ Mavenï¼šä¾èµ–ç®¡ç†ã€å¤šæ¨¡å—é¡¹ç›®æ„å»º Dockerï¼šå®¹å™¨åŒ–éƒ¨ç½²ã€å¤šé˜¶æ®µæ„å»ºã€Docker Compose è¿ç»´ä¸éƒ¨ç½²\nNginxï¼šåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€é™æ€èµ„æºç¼“å­˜ Linuxï¼šå¸¸ç”¨å‘½ä»¤ã€Shell è„šæœ¬ã€æœåŠ¡å™¨è¿ç»´ ä¸­é—´ä»¶ä¸å·¥å…·\nZookeeperï¼šåˆ†å¸ƒå¼åè°ƒã€æœåŠ¡æ³¨å†Œå‘ç° Dubboï¼šRPC æ¡†æ¶ã€æœåŠ¡æ²»ç† æŠ€æœ¯æ·±åº¦ æºç é˜…è¯»èƒ½åŠ› Spring Boot Starter è‡ªåŠ¨è£…é…æœºåˆ¶ Redisson çœ‹é—¨ç‹—ç»­æœŸåŸç† MyBatis åŠ¨æ€ SQL ç”Ÿæˆæµç¨‹ é—®é¢˜æ’æŸ¥èƒ½åŠ› çº¿ä¸Š OOM é—®é¢˜å®šä½ï¼ˆjmapã€MAT å·¥å…·ï¼‰ æ¥å£æ€§èƒ½ç“¶é¢ˆåˆ†æï¼ˆArthasã€JProfilerï¼‰ åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜æ’æŸ¥ æ¶æ„è®¾è®¡èƒ½åŠ› ä» 0 åˆ° 1 è®¾è®¡æ‹¼å›¢äº¤æ˜“å¹³å°ï¼ˆDDD æ¶æ„ï¼‰ è®¾è®¡åŠ¨æ€çº¿ç¨‹æ±  SDKï¼ˆé›¶ä¾µå…¥å¼ï¼‰ åˆ†å¸ƒå¼é”æ–¹æ¡ˆè®¾è®¡ï¼ˆRedis + Redissonï¼‰ å­¦ä¹ æ–¹æ³• æˆ‘ç›¸ä¿¡\u0026quot;æºç æ˜¯æœ€å¥½çš„è€å¸ˆ\u0026quot;ã€‚åœ¨å­¦ä¹ æ–°æŠ€æœ¯æ—¶ï¼Œæˆ‘ä¼šï¼š\nå…ˆç†è§£æ ¸å¿ƒæ¦‚å¿µå’Œä½¿ç”¨åœºæ™¯ é€šè¿‡å®æˆ˜é¡¹ç›®åŠ æ·±ç†è§£ é˜…è¯»æºç ç†è§£åº•å±‚å®ç° æ€»ç»“æˆåšå®¢æ–‡ç« æ²‰æ·€çŸ¥è¯† æ­£åœ¨å­¦ä¹  Kubernetesï¼šå®¹å™¨ç¼–æ’ã€æœåŠ¡ç½‘æ ¼ Elasticsearchï¼šå…¨æ–‡æœç´¢ã€æ—¥å¿—åˆ†æ Go è¯­è¨€ï¼šé«˜å¹¶å‘ç¼–ç¨‹ã€å¾®æœåŠ¡å¼€å‘ æŠ€èƒ½è®¤è¯ ç†Ÿæ‚‰ JUC å¹¶å‘å·¥å…·ã€ç†è§£ AQSã€CAS åŠé”å‡çº§è¿‡ç¨‹ ç†Ÿæ‚‰çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜å’Œç›‘æ§ ç†è§£ volatileã€synchronized çš„å†…å­˜è¯­ä¹‰ä¸å¯è§æ€§ ä»¥ä¸ŠæŠ€èƒ½å‡æ¥è‡ªå®é™…é¡¹ç›®ç»éªŒå’Œæ·±åº¦å­¦ä¹ ï¼ŒæŒç»­æ›´æ–°ä¸­\n","permalink":"http://localhost:1313/skills/","summary":"æŠ€æœ¯èƒ½åŠ›æ€»è§ˆ - ä¸“æ³¨åç«¯å¼€å‘ä¸åˆ†å¸ƒå¼ç³»ç»Ÿ","title":"æŠ€èƒ½æ ˆ"},{"content":"é¡¹ç›®ç®€ä»‹ [ç”¨ 2-3 å¥è¯è¯´æ¸…æ¥šï¼šåšäº†ä»€ä¹ˆã€è§£å†³ä»€ä¹ˆé—®é¢˜]\næºç ï¼šGitHub\næ¼”ç¤ºï¼šåœ¨çº¿åœ°å€ï¼ˆå¯é€‰ï¼‰\næŠ€æœ¯æ ˆ åç«¯ï¼š å‰ç«¯ï¼š æ•°æ®åº“ï¼š éƒ¨ç½²ï¼š æ ¸å¿ƒåŠŸèƒ½ æŠ€æœ¯äº®ç‚¹ [äº®ç‚¹1ï¼šæ¯”å¦‚æ€§èƒ½ä¼˜åŒ–] [ç®€è¿°é—®é¢˜ + è§£å†³æ–¹æ¡ˆ]\n1// å…³é”®ä»£ç ç‰‡æ®µï¼ˆå¯é€‰ï¼‰ [äº®ç‚¹2ï¼šæ¯”å¦‚æ¶æ„è®¾è®¡] [ç®€è¿°æ€è·¯]\né¡¹ç›®æˆæœ æ•°æ®æŒ‡æ ‡ï¼ˆå¦‚æœ‰ï¼‰ å­¦åˆ°äº†ä»€ä¹ˆ ğŸ’¡ å¤åˆ¶è¿™ä¸ªæ¨¡æ¿ï¼Œå¡«å…¥ä½ çš„çœŸå®é¡¹ç›®\n","permalink":"http://localhost:1313/projects/example-project/","summary":"\u003ch2 id=\"é¡¹ç›®ç®€ä»‹\"\u003eé¡¹ç›®ç®€ä»‹\u003c/h2\u003e\n\u003cp\u003e[ç”¨ 2-3 å¥è¯è¯´æ¸…æ¥šï¼šåšäº†ä»€ä¹ˆã€è§£å†³ä»€ä¹ˆé—®é¢˜]\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæºç \u003c/strong\u003eï¼š\u003ca href=\"https://github.com/%E4%BD%A0%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D/%E9%A1%B9%E7%9B%AE%E5%90%8D\"\u003eGitHub\u003c/a\u003e\u003cbr\u003e\n\u003cstrong\u003eæ¼”ç¤º\u003c/strong\u003eï¼š\u003ca href=\"#\"\u003eåœ¨çº¿åœ°å€\u003c/a\u003eï¼ˆå¯é€‰ï¼‰\u003c/p\u003e\n\u003ch2 id=\"æŠ€æœ¯æ ˆ\"\u003eæŠ€æœ¯æ ˆ\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eåç«¯ï¼š\u003c/li\u003e\n\u003cli\u003eå‰ç«¯ï¼š\u003c/li\u003e\n\u003cli\u003eæ•°æ®åº“ï¼š\u003c/li\u003e\n\u003cli\u003eéƒ¨ç½²ï¼š\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"æ ¸å¿ƒåŠŸèƒ½\"\u003eæ ¸å¿ƒåŠŸèƒ½\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"æŠ€æœ¯äº®ç‚¹\"\u003eæŠ€æœ¯äº®ç‚¹\u003c/h2\u003e\n\u003ch3 id=\"äº®ç‚¹1æ¯”å¦‚æ€§èƒ½ä¼˜åŒ–\"\u003e[äº®ç‚¹1ï¼šæ¯”å¦‚æ€§èƒ½ä¼˜åŒ–]\u003c/h3\u003e\n\u003cp\u003e[ç®€è¿°é—®é¢˜ + è§£å†³æ–¹æ¡ˆ]\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e// å…³é”®ä»£ç ç‰‡æ®µï¼ˆå¯é€‰ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"äº®ç‚¹2æ¯”å¦‚æ¶æ„è®¾è®¡\"\u003e[äº®ç‚¹2ï¼šæ¯”å¦‚æ¶æ„è®¾è®¡]\u003c/h3\u003e\n\u003cp\u003e[ç®€è¿°æ€è·¯]\u003c/p\u003e\n\u003ch2 id=\"é¡¹ç›®æˆæœ\"\u003eé¡¹ç›®æˆæœ\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eæ•°æ®æŒ‡æ ‡ï¼ˆå¦‚æœ‰ï¼‰\u003c/li\u003e\n\u003cli\u003eå­¦åˆ°äº†ä»€ä¹ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cblockquote\u003e\n\u003cp\u003eğŸ’¡ å¤åˆ¶è¿™ä¸ªæ¨¡æ¿ï¼Œå¡«å…¥ä½ çš„çœŸå®é¡¹ç›®\u003c/p\u003e\n\u003c/blockquote\u003e","title":"[é¡¹ç›®åç§°]"},{"content":"åœ¨ç¢ç‰‡åŒ–ä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œæ‹¥æœ‰ä¸€å¥—å®Œå…¨å—è‡ªå·±æŒæ§çš„æŠ€æœ¯ä¸“æ ï¼Œæ˜¯æ¯ä½å¼€å‘è€…æ²‰æ·€æ€è€ƒã€æ‰“é€ ä¸ªäººå“ç‰Œçš„æ ¸å¿ƒèµ„äº§ã€‚ç›¸æ¯”äºè¢«å¹³å°ç®—æ³•ç»‘æ¶çš„å…¬ä¼—å·ï¼Œæˆ–æ˜¯å……æ–¥å¹¿å‘Šçš„ç¬¬ä¸‰æ–¹åšå®¢ï¼ŒHugo è¿™ç±»é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ç»™äº†æˆ‘ä»¬çœŸæ­£çš„è‡ªç”±ï¼šæ¯«ç§’çº§æ„å»ºã€Markdown åŸç”Ÿæ”¯æŒã€å®Œå…¨çš„æ ·å¼æ§åˆ¶æƒã€‚\nä½†å¾ˆå¤šäººåœ¨æ­å»º Hugo åšå®¢æ—¶ï¼Œå¾€å¾€é™·å…¥\u0026quot;ç…§ç€æ–‡æ¡£æ•²å‘½ä»¤\u0026quot;çš„æœºæ¢°é‡å¤ã€‚æœ¬æ–‡ä¸æ˜¯åˆä¸€ç¯‡å®‰è£…æ•™ç¨‹ï¼Œè€Œæ˜¯ä»ç³»ç»Ÿæ¶æ„çš„è§’åº¦ï¼Œå¸¦ä½ ç†è§£ Hugo + PaperMod è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡é€»è¾‘ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Hugo Extended ä¸ PaperMod çš„ä¾èµ–å…³ç³» æŒæ¡ Git Submodule çš„ä¸»é¢˜ç®¡ç†æ–¹æ¡ˆ è®¾è®¡åŸºäº GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿ å»ºç«‹å·¥ç¨‹åŒ–æ€ç»´è€Œé\u0026quot;è·Ÿç€åš\u0026quot;çš„æ“ä½œæ€ç»´ 01. åŸºç¡€è®¾æ–½ï¼šä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ Hugo Extendedï¼Ÿ å¾ˆå¤šäººç¬¬ä¸€æ¬¡æ­å»º Hugo åšå®¢æ—¶ï¼Œä¼šé‡åˆ°ä¸€ä¸ªè¯¡å¼‚çš„æŠ¥é”™ï¼šTOCSS: failed to transform \u0026quot;css/main.css\u0026quot;ã€‚æ˜æ˜æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è£…äº† Hugoï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºé”™ï¼Ÿ\né—®é¢˜å‡ºåœ¨ç‰ˆæœ¬é€‰æ‹©ä¸Šã€‚Hugo åˆ†ä¸ºæ™®é€šç‰ˆå’Œ Extended ç‰ˆï¼Œåè€…å†…ç½®äº† LibSass ç¼–è¯‘å™¨ã€‚è€Œ PaperMod è¿™ç±»ç°ä»£ä¸»é¢˜å¤§é‡ä½¿ç”¨ SCSS/SASS æ¥å®ç°ä¸»é¢˜å˜é‡ã€æš—é»‘æ¨¡å¼åˆ‡æ¢ç­‰ç‰¹æ€§ã€‚å¦‚æœä½ ç”¨æ™®é€šç‰ˆ Hugoï¼Œç¼–è¯‘æµç¨‹ä¼šåœ¨ CSS è½¬æ¢ç¯èŠ‚ç›´æ¥å´©æºƒã€‚\nåœ¨ Windows ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ç”¨ Winget æ¥å®‰è£…ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ä¸‹è½½ zip åŒ…ï¼š\n1# ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œç¡®ä¿ç‰ˆæœ¬å¯è¿½æº¯ 2winget install Hugo.Hugo.Extended 3 4# éªŒè¯å®‰è£…ï¼šå¿…é¡»çœ‹åˆ° +extended æ ‡è¯† 5hugo version 6# é¢„æœŸè¾“å‡º: hugo v0.12x.x+extended windows/amd64 ä¸ºä»€ä¹ˆåšæŒç”¨åŒ…ç®¡ç†å™¨ï¼Ÿå› ä¸ºè¿™æ˜¯\u0026quot;å¯å¤ç°ç¯å¢ƒ\u0026quot;çš„ç¬¬ä¸€æ­¥ã€‚å½“ä½ çš„åšå®¢éœ€è¦å›¢é˜Ÿåä½œï¼Œæˆ–è€…æ¢äº†å°ç”µè„‘é‡æ–°éƒ¨ç½²æ—¶ï¼Œä¸€æ¡å‘½ä»¤å°±èƒ½æ¢å¤å®Œå…¨ä¸€è‡´çš„ç¯å¢ƒï¼Œè€Œä¸æ˜¯åœ¨\u0026quot;æˆ‘ç”µè„‘ä¸Šèƒ½è·‘\u0026quot;çš„æ³¥æ½­é‡ŒæŒ£æ‰ã€‚\næ¥ä¸‹æ¥åˆå§‹åŒ–ç«™ç‚¹éª¨æ¶ï¼š\n1hugo new site myblog 2cd myblog 3git init è¿™ä¸‰è¡Œå‘½ä»¤çœ‹ä¼¼ç®€å•ï¼Œä½†èƒŒåæ˜¯ Hugo çš„\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;å“²å­¦ï¼šcontent/ å­˜æ”¾å†…å®¹æºæ–‡ä»¶ï¼Œthemes/ ç®¡ç†è§†è§‰å±‚ï¼Œpublic/ ä½œä¸ºç¼–è¯‘äº§ç‰©è¾“å‡ºã€‚è¿™ç§æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œè®©æˆ‘ä»¬å¯ä»¥ç‹¬ç«‹ç®¡ç†å†…å®¹ã€ä¸»é¢˜å’Œæ„å»ºæµç¨‹ã€‚\næ¶æ„æ€è€ƒï¼š Hugo çš„ç›®å½•ç»“æ„æœ¬è´¨ä¸Šæ˜¯ä¸€ç§\u0026quot;å…³æ³¨ç‚¹åˆ†ç¦»\u0026quot;çš„è®¾è®¡æ¨¡å¼ã€‚å†…å®¹åˆ›ä½œè€…åªéœ€è¦å…³å¿ƒ content/ ä¸‹çš„ Markdownï¼Œä¸»é¢˜å¼€å‘è€…ä¸“æ³¨äº themes/ çš„æ¨¡æ¿é€»è¾‘ï¼Œè€Œ CI/CD æµæ°´çº¿åªéœ€è¦å¤„ç† public/ çš„éƒ¨ç½²ã€‚è¿™ç§è§£è€¦è®¾è®¡ï¼Œæ˜¯å¤§è§„æ¨¡å†…å®¹ç”Ÿäº§çš„åŸºç¡€ã€‚\n02. ä¸»é¢˜ä¾èµ–ï¼šä¸ºä»€ä¹ˆé€‰æ‹© Git Submoduleï¼Ÿ å¼•å…¥ PaperMod ä¸»é¢˜æœ‰ä¸¤ç§æ–¹å¼ï¼šç›´æ¥ä¸‹è½½ zip åŒ…è§£å‹åˆ° themes/ ç›®å½•ï¼Œæˆ–è€…ç”¨ Git Submoduleã€‚å¾ˆå¤šæ•™ç¨‹ä¼šæ¨èå‰è€…ï¼Œå› ä¸º\u0026quot;ç®€å•\u0026quot;ã€‚ä½†è¿™ç§ç®€å•æ˜¯æœ‰ä»£ä»·çš„ã€‚\næƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šPaperMod å®˜æ–¹ä¿®å¤äº†ä¸€ä¸ªæš—é»‘æ¨¡å¼çš„ Bugï¼Œæˆ–è€…æ–°å¢äº†æœç´¢åŠŸèƒ½ã€‚å¦‚æœä½ æ˜¯ç›´æ¥ä¸‹è½½çš„ä¸»é¢˜ï¼Œæ›´æ–°æµç¨‹ä¼šå˜æˆï¼šå» GitHub ä¸‹è½½æ–°ç‰ˆ â†’ åˆ é™¤æ—§æ–‡ä»¶ â†’ è§£å‹è¦†ç›– â†’ ç¥ˆç¥·æ²¡æœ‰å†²çªã€‚è€Œå¦‚æœç”¨ Submoduleï¼Œåªéœ€è¦ä¸€æ¡å‘½ä»¤ï¼š\n1# å»ºç«‹ä¸»é¢˜å­æ¨¡å—ä¾èµ– 2git submodule add --depth=1 https://github.com/adityatelange/hugo-PaperMod.git themes/PaperMod 3 4# æœªæ¥æ›´æ–°ä¸»é¢˜åªéœ€è¦ 5git submodule update --remote --merge Submodule çš„æœ¬è´¨æ˜¯\u0026quot;ä¾èµ–å¤–éƒ¨åŒ–\u0026quot;ã€‚ä¸»é¢˜ä»£ç ä¸ä¼šæ±¡æŸ“ä½ çš„ä¸»ä»“åº“æäº¤å†å²ï¼ŒåŒæ—¶åˆèƒ½é€šè¿‡ .gitmodules æ–‡ä»¶ç²¾ç¡®é”å®šä¾èµ–ç‰ˆæœ¬ã€‚è¿™ç§è®¾è®¡åœ¨å¤§å‹å¼€æºé¡¹ç›®ä¸­æä¸ºå¸¸è§ï¼ˆæ¯”å¦‚ Linux å†…æ ¸çš„é©±åŠ¨æ¨¡å—ç®¡ç†ï¼‰ã€‚\nç„¶ååœ¨ hugo.toml ä¸­æ¿€æ´»ä¸»é¢˜ï¼š\n1theme = \u0026#34;PaperMod\u0026#34; è¿™ä¸€è¡Œé…ç½®æ˜¯æ•´ä¸ªç«™ç‚¹çš„\u0026quot;æ§åˆ¶æ¢çº½\u0026quot;ï¼Œå®ƒå‘Šè¯‰ Hugo åœ¨ç¼–è¯‘æ—¶å» themes/PaperMod/ ç›®å½•å¯»æ‰¾æ¨¡æ¿æ–‡ä»¶ã€‚\né¿å‘æç¤ºï¼š å¦‚æœä½ å…‹éš†äº†åˆ«äººçš„ Hugo é¡¹ç›®ï¼Œè®°å¾—æ‰§è¡Œ git submodule update --init --recursiveï¼Œå¦åˆ™ themes/ ç›®å½•ä¼šæ˜¯ç©ºçš„ï¼Œå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚\n03. å†…å®¹ç”Ÿäº§ï¼šä»æ¨¡æ¿åˆ°å®æ—¶é¢„è§ˆ åˆ›å»ºç¬¬ä¸€ç¯‡æ–‡ç« ï¼š\n1hugo new posts/my-first-post.md è¿™æ¡å‘½ä»¤ä¼šæ ¹æ® archetypes/default.md æ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆæ–‡ç« éª¨æ¶ï¼ŒåŒ…æ‹¬ Front Matterï¼ˆæ ‡é¢˜ã€æ—¥æœŸã€æ ‡ç­¾ç­‰å…ƒæ•°æ®ï¼‰ã€‚è¿™ä¿è¯äº†å…¨ç«™æ–‡ç« æ ¼å¼çš„ä¸€è‡´æ€§ï¼Œé¿å…äº†æ‰‹åŠ¨ç¼–å†™ YAML æ—¶çš„ä½çº§é”™è¯¯ã€‚\né»˜è®¤ç”Ÿæˆçš„æ–‡ç« åŒ…å« draft: true å­—æ®µï¼Œè¿™æ˜¯ Hugo çš„\u0026quot;è‰ç¨¿æ€\u0026quot;æœºåˆ¶ã€‚åœ¨æ­£å¼æ„å»ºæ—¶ï¼Œè‰ç¨¿ä¸ä¼šè¢«ç¼–è¯‘ã€‚è¿™ä¸ªè®¾è®¡å¾ˆè´´å¿ƒï¼šä½ å¯ä»¥åœ¨æœ¬åœ°éšæ„å†™åŠæˆå“æ–‡ç« ï¼Œä¸ç”¨æ‹…å¿ƒå®ƒä»¬è¢«æ„å¤–å‘å¸ƒã€‚\nå¯åŠ¨æœ¬åœ°é¢„è§ˆæœåŠ¡å™¨ï¼š\n1hugo server -D 2# è®¿é—® http://localhost:1313 -D å‚æ•°è¡¨ç¤ºé¢„è§ˆè‰ç¨¿ã€‚Hugo çš„å®æ—¶é¢„è§ˆèƒ½åŠ›æºäºå…¶\u0026quot;å¢é‡ç¼–è¯‘\u0026quot;è®¾è®¡ï¼šå®ƒä¸ä¼šåœ¨æ¯æ¬¡æ–‡ä»¶å˜æ›´æ—¶é‡æ–°æ„å»ºæ•´ä¸ªç«™ç‚¹ï¼Œè€Œæ˜¯é€šè¿‡ä¾èµ–å›¾åˆ†æï¼Œåªé‡æ–°ç¼–è¯‘å—å½±å“çš„é¡µé¢ã€‚å³ä½¿ä½ çš„åšå®¢æœ‰ä¸Šåƒç¯‡æ–‡ç« ï¼Œé¢„è§ˆå»¶è¿Ÿä¹Ÿèƒ½æ§åˆ¶åœ¨ 100ms ä»¥å†…ã€‚\nè¿™ç§æ¯«ç§’çº§çš„åé¦ˆå¾ªç¯ï¼Œè®©å†™ä½œå˜æˆäº†ä¸€ç§\u0026quot;æ‰€è§å³æ‰€å¾—\u0026quot;çš„æµç•…ä½“éªŒã€‚ä½ æ”¹ä¸€ä¸ªæ ‡ç‚¹ï¼Œæµè§ˆå™¨ç«‹åˆ»åˆ·æ–°ï¼›ä½ è°ƒæ•´ä¸€ä¸ªæ ·å¼ï¼Œæ•ˆæœç¬é—´å‘ˆç°ã€‚è¿™ç§å³æ—¶åé¦ˆï¼Œæ˜¯ä¿æŒåˆ›ä½œå¿ƒæµçš„å…³é”®ã€‚\n04. è‡ªåŠ¨åŒ–æµæ°´çº¿ï¼šæäº¤å³å‘å¸ƒçš„é­”æ³• æ‰‹åŠ¨æ„å»ºã€æ‰‹åŠ¨ä¸Šä¼ çš„æ—¶ä»£æ—©è¯¥ç»“æŸäº†ã€‚æˆ‘ä»¬è¦çš„æ˜¯\u0026quot;git push ä¹‹åå–æ¯å’–å•¡ï¼Œå›æ¥åšå®¢å°±æ›´æ–°äº†\u0026quot;çš„ä¸æ»‘ä½“éªŒã€‚\nGitHub Actions æ˜¯å®ç°è¿™ä¸ªç›®æ ‡çš„æœ€ä½³å·¥å…·ã€‚å®ƒçš„å·¥ä½œæµç¨‹æ˜¯ï¼šä½ æ¨é€ä»£ç åˆ° GitHub â†’ Actions è‡ªåŠ¨æ‹‰å–ä»£ç  â†’ è°ƒç”¨ Hugo ç¼–è¯‘ â†’ å°†ç”Ÿæˆçš„é™æ€æ–‡ä»¶éƒ¨ç½²åˆ° GitHub Pagesã€‚\nåœ¨ .github/workflows/hugo.yml ä¸­åˆ›å»ºå·¥ä½œæµé…ç½®ï¼š\n1name: Deploy Hugo site to Pages 2 3on: 4 push: 5 branches: [\u0026#34;main\u0026#34;] 6 7permissions: 8 contents: read 9 pages: write 10 id-token: write 11 12jobs: 13 build: 14 runs-on: ubuntu-latest 15 steps: 16 - name: Checkout 17 uses: actions/checkout@v4 18 with: 19 submodules: recursive # å…³é”®ï¼šé€’å½’æ‹‰å–ä¸»é¢˜å­æ¨¡å— 20 fetch-depth: 0 21 22 - name: Setup Hugo 23 uses: peaceiris/actions-hugo@v3 24 with: 25 hugo-version: \u0026#39;latest\u0026#39; 26 extended: true # å¿…é¡»å¼€å¯ Extended æ”¯æŒ 27 28 - name: Build 29 run: hugo --minify # å‹ç¼© HTML/CSS/JS 30 31 - name: Upload artifact 32 uses: actions/upload-pages-artifact@v3 33 with: 34 path: ./public 35 36 deploy: 37 environment: 38 name: github-pages 39 runs-on: ubuntu-latest 40 needs: build 41 steps: 42 - id: deployment 43 uses: actions/deploy-pages@v4 è¿™ä¸ªé…ç½®æ–‡ä»¶çš„æ ¸å¿ƒæ˜¯ submodules: recursiveã€‚å¦‚æœæ¼æ‰è¿™ä¸€è¡Œï¼ŒActions æ‹‰å–ä»£ç æ—¶ä¸ä¼šä¸‹è½½ PaperMod ä¸»é¢˜ï¼Œå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚è¿™æ˜¯å¾ˆå¤šäººç¬¬ä¸€æ¬¡é…ç½® CI/CD æ—¶è¸©çš„å‘ã€‚\nhugo --minify ä¼šå‹ç¼©ç”Ÿæˆçš„ HTMLã€CSSã€JS æ–‡ä»¶ï¼Œå‡å°‘ä¼ è¾“ä½“ç§¯ã€‚å¯¹äºä¸€ä¸ªä¸­ç­‰è§„æ¨¡çš„åšå®¢ï¼Œè¿™èƒ½èŠ‚çœ 30-40% çš„å¸¦å®½ã€‚\næ¶æ„æ€è€ƒï¼š è¿™å¥— CI/CD æµæ°´çº¿çš„æœ¬è´¨æ˜¯\u0026quot;åŸºç¡€è®¾æ–½å³ä»£ç \u0026quot;ï¼ˆInfrastructure as Codeï¼‰ã€‚éƒ¨ç½²æµç¨‹ä¸å†æ˜¯å£å£ç›¸ä¼ çš„æ“ä½œæ‰‹å†Œï¼Œè€Œæ˜¯ç‰ˆæœ¬æ§åˆ¶çš„ YAML æ–‡ä»¶ã€‚ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°éƒ¨ç½²é€»è¾‘ï¼Œä»»ä½•ä¿®æ”¹éƒ½æœ‰å®¡è®¡è®°å½•ã€‚è¿™ç§é€æ˜æ€§å’Œå¯å¤ç°æ€§ï¼Œæ˜¯ç°ä»£ DevOps çš„æ ¸å¿ƒç†å¿µã€‚\n05. æ€»ç»“ä¸æ€è€ƒ æˆ‘ä»¬ä» Hugo Extended çš„ç‰ˆæœ¬é€‰æ‹©ï¼Œåˆ° Git Submodule çš„ä¾èµ–ç®¡ç†ï¼Œå†åˆ° GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œæ„å»ºäº†ä¸€å¥—å®Œæ•´çš„åšå®¢å·¥ç¨‹åŒ–æ–¹æ¡ˆã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸ºäº†\u0026quot;æ­ä¸ªåšå®¢\u0026quot;ï¼Œæ›´æ˜¯ä¸€æ¬¡å¯¹é™æ€ç«™ç‚¹ç¼–è¯‘æµç¨‹ã€ä¾èµ–ç®¡ç†æ€æƒ³ã€CI/CD å®è·µçš„æ·±åº¦ç†è§£ã€‚\nå¦‚æœä½ çš„åšå®¢æœªæ¥éœ€è¦æ”¯æŒå¤šè¯­è¨€ç‰ˆæœ¬ï¼Œæˆ–è€…éœ€è¦é’ˆå¯¹ä¸åŒç»ˆç«¯æä¾›å·®å¼‚åŒ–çš„æœç´¢ä½“éªŒï¼Œä½ ä¼šå¦‚ä½•ä» hugo.toml çš„é…ç½®å±‚çº§è¿›è¡Œè§£è€¦è®¾è®¡ï¼Ÿæç¤ºï¼šå¯ä»¥ç ”ç©¶ Hugo çš„ languages é…ç½®å’Œ outputFormats æœºåˆ¶ã€‚\næŠ€æœ¯çš„æœ¬è´¨ä¸æ˜¯å·¥å…·çš„å †ç Œï¼Œè€Œæ˜¯å¯¹é—®é¢˜çš„æ·±åº¦ç†è§£ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ è·³å‡º\u0026quot;ç…§ç€åš\u0026quot;çš„æ€ç»´å®šå¼ï¼ŒçœŸæ­£ç†è§£ Hugo è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡å“²å­¦ã€‚\n","permalink":"http://localhost:1313/posts/2026/02/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%9E%84%E5%BB%BA-hugo--papermod-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/","summary":"\u003cp\u003eåœ¨ç¢ç‰‡åŒ–ä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œæ‹¥æœ‰ä¸€å¥—å®Œå…¨å—è‡ªå·±æŒæ§çš„æŠ€æœ¯ä¸“æ ï¼Œæ˜¯æ¯ä½å¼€å‘è€…æ²‰æ·€æ€è€ƒã€æ‰“é€ ä¸ªäººå“ç‰Œçš„æ ¸å¿ƒèµ„äº§ã€‚ç›¸æ¯”äºè¢«å¹³å°ç®—æ³•ç»‘æ¶çš„å…¬ä¼—å·ï¼Œæˆ–æ˜¯å……æ–¥å¹¿å‘Šçš„ç¬¬ä¸‰æ–¹åšå®¢ï¼ŒHugo è¿™ç±»é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ç»™äº†æˆ‘ä»¬çœŸæ­£çš„è‡ªç”±ï¼šæ¯«ç§’çº§æ„å»ºã€Markdown åŸç”Ÿæ”¯æŒã€å®Œå…¨çš„æ ·å¼æ§åˆ¶æƒã€‚\u003c/p\u003e\n\u003cp\u003eä½†å¾ˆå¤šäººåœ¨æ­å»º Hugo åšå®¢æ—¶ï¼Œå¾€å¾€é™·å…¥\u0026quot;ç…§ç€æ–‡æ¡£æ•²å‘½ä»¤\u0026quot;çš„æœºæ¢°é‡å¤ã€‚æœ¬æ–‡ä¸æ˜¯åˆä¸€ç¯‡å®‰è£…æ•™ç¨‹ï¼Œè€Œæ˜¯ä»ç³»ç»Ÿæ¶æ„çš„è§’åº¦ï¼Œå¸¦ä½ ç†è§£ Hugo + PaperMod è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡é€»è¾‘ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Hugo Extended ä¸ PaperMod çš„ä¾èµ–å…³ç³»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Git Submodule çš„ä¸»é¢˜ç®¡ç†æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è®¾è®¡åŸºäº GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹å·¥ç¨‹åŒ–æ€ç»´è€Œé\u0026quot;è·Ÿç€åš\u0026quot;çš„æ“ä½œæ€ç»´\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"01-åŸºç¡€è®¾æ–½ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯-hugo-extended\"\u003e01. åŸºç¡€è®¾æ–½ï¼šä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ Hugo Extendedï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eå¾ˆå¤šäººç¬¬ä¸€æ¬¡æ­å»º Hugo åšå®¢æ—¶ï¼Œä¼šé‡åˆ°ä¸€ä¸ªè¯¡å¼‚çš„æŠ¥é”™ï¼š\u003ccode\u003eTOCSS: failed to transform \u0026quot;css/main.css\u0026quot;\u003c/code\u003eã€‚æ˜æ˜æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è£…äº† Hugoï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºé”™ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eé—®é¢˜å‡ºåœ¨ç‰ˆæœ¬é€‰æ‹©ä¸Šã€‚Hugo åˆ†ä¸ºæ™®é€šç‰ˆå’Œ Extended ç‰ˆï¼Œåè€…å†…ç½®äº† LibSass ç¼–è¯‘å™¨ã€‚è€Œ PaperMod è¿™ç±»ç°ä»£ä¸»é¢˜å¤§é‡ä½¿ç”¨ SCSS/SASS æ¥å®ç°ä¸»é¢˜å˜é‡ã€æš—é»‘æ¨¡å¼åˆ‡æ¢ç­‰ç‰¹æ€§ã€‚å¦‚æœä½ ç”¨æ™®é€šç‰ˆ Hugoï¼Œç¼–è¯‘æµç¨‹ä¼šåœ¨ CSS è½¬æ¢ç¯èŠ‚ç›´æ¥å´©æºƒã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ Windows ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ç”¨ Winget æ¥å®‰è£…ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ä¸‹è½½ zip åŒ…ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-powershell\" data-lang=\"powershell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œç¡®ä¿ç‰ˆæœ¬å¯è¿½æº¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ewinget\u003c/span\u003e \u003cspan class=\"n\"\u003einstall\u003c/span\u003e \u003cspan class=\"n\"\u003eHugo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"py\"\u003eHugo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"py\"\u003eExtended\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# éªŒè¯å®‰è£…ï¼šå¿…é¡»çœ‹åˆ° +extended æ ‡è¯†\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ehugo\u003c/span\u003e \u003cspan class=\"n\"\u003eversion\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# é¢„æœŸè¾“å‡º: hugo v0.12x.x+extended windows/amd64\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¸ºä»€ä¹ˆåšæŒç”¨åŒ…ç®¡ç†å™¨ï¼Ÿå› ä¸ºè¿™æ˜¯\u0026quot;å¯å¤ç°ç¯å¢ƒ\u0026quot;çš„ç¬¬ä¸€æ­¥ã€‚å½“ä½ çš„åšå®¢éœ€è¦å›¢é˜Ÿåä½œï¼Œæˆ–è€…æ¢äº†å°ç”µè„‘é‡æ–°éƒ¨ç½²æ—¶ï¼Œä¸€æ¡å‘½ä»¤å°±èƒ½æ¢å¤å®Œå…¨ä¸€è‡´çš„ç¯å¢ƒï¼Œè€Œä¸æ˜¯åœ¨\u0026quot;æˆ‘ç”µè„‘ä¸Šèƒ½è·‘\u0026quot;çš„æ³¥æ½­é‡ŒæŒ£æ‰ã€‚\u003c/p\u003e","title":"ä»é›¶åˆ°ä¸€ï¼šæ„å»º Hugo + PaperMod è‡ªåŠ¨åŒ–åšå®¢ç³»ç»Ÿ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œå¾€å¾€éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯è¿™äº›æ“ä½œçš„ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªç»å…¸éš¾é¢˜ã€‚æœ¬æ–‡å°†ç³»ç»Ÿè®²è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒé—®é¢˜ æŒæ¡2PCã€3PCã€TCCã€Sagaç­‰æ–¹æ¡ˆ å­¦ä¼šä½¿ç”¨Seataæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ äº†è§£å„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ ä¸šåŠ¡åœºæ™¯ ç”µå•†ä¸‹å•åœºæ™¯ï¼Œæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼š\n1ç”¨æˆ·ä¸‹å• 2 â†“ 3è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å• 4 â†“ 5åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜ 6 â†“ 7è´¦æˆ·æœåŠ¡ï¼šæ‰£å‡ä½™é¢ 8 â†“ 9ç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ† é—®é¢˜ï¼šå¦‚æœæŸä¸ªæœåŠ¡å¤±è´¥ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\nCAPç†è®º åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸‰ä¸ªç‰¹æ€§ï¼š\nC (Consistency)ï¼šä¸€è‡´æ€§ A (Availability)ï¼šå¯ç”¨æ€§ P (Partition Tolerance)ï¼šåˆ†åŒºå®¹é”™æ€§ CAPå®šç†ï¼šä¸‰è€…æœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤ä¸ª\nå®é™…é€‰æ‹©ï¼š\nCPï¼šç‰ºç‰²å¯ç”¨æ€§ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ˆå¦‚ZooKeeperï¼‰ APï¼šç‰ºç‰²ä¸€è‡´æ€§ï¼Œä¿è¯å¯ç”¨æ€§ï¼ˆå¦‚Eurekaï¼‰ BASEç†è®º BA (Basically Available)ï¼šåŸºæœ¬å¯ç”¨ S (Soft State)ï¼šè½¯çŠ¶æ€ E (Eventually Consistent)ï¼šæœ€ç»ˆä¸€è‡´æ€§ æ¶æ„æ€è€ƒï¼š åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¼ºä¸€è‡´æ€§å¾€å¾€éš¾ä»¥å®ç°ä¸”ä»£ä»·é«˜æ˜‚ã€‚å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼Œè¿™ä¹Ÿæ˜¯ç°ä»£åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆçš„åŸºç¡€ã€‚\n2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ åŸç† ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰\nåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€Prepareè¯·æ±‚ å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤ å‚ä¸è€…è¿”å›Yesæˆ–No ç¬¬äºŒé˜¶æ®µï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰\nå¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›Yesï¼Œåè°ƒè€…å‘é€Commitè¯·æ±‚ å¦‚æœæœ‰å‚ä¸è€…è¿”å›Noï¼Œåè°ƒè€…å‘é€Rollbackè¯·æ±‚ æµç¨‹å›¾ 1åè°ƒè€… å‚ä¸è€…1 å‚ä¸è€…2 2 | | | 3 |---Prepare----------\u0026gt;| | 4 |---Prepare----------------------------\u0026gt;| 5 | | | 6 |\u0026lt;--Yes/No------------| | 7 |\u0026lt;--Yes/No-------------------------------| 8 | | | 9 |---Commit/Rollback--\u0026gt;| | 10 |---Commit/Rollback----------------------\u0026gt;| ä»£ç ç¤ºä¾‹ 1public class TwoPhaseCommitCoordinator { 2 3 private List\u0026lt;Participant\u0026gt; participants; 4 5 public boolean executeTransaction() { 6 // ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡ 7 boolean canCommit = prepare(); 8 9 // ç¬¬äºŒé˜¶æ®µï¼šæäº¤æˆ–å›æ»š 10 if (canCommit) { 11 commit(); 12 return true; 13 } else { 14 rollback(); 15 return false; 16 } 17 } 18 19 private boolean prepare() { 20 for (Participant participant : participants) { 21 if (!participant.prepare()) { 22 return false; 23 } 24 } 25 return true; 26 } 27 28 private void commit() { 29 for (Participant participant : participants) { 30 participant.commit(); 31 } 32 } 33 34 private void rollback() { 35 for (Participant participant : participants) { 36 participant.rollback(); 37 } 38 } 39} 40 41interface Participant { 42 boolean prepare(); 43 void commit(); 44 void rollback(); 45} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nå¼ºä¸€è‡´æ€§ å®ç°ç›¸å¯¹ç®€å• ç¼ºç‚¹ï¼š\nåŒæ­¥é˜»å¡ï¼šå‚ä¸è€…åœ¨ç­‰å¾…åè°ƒè€…æŒ‡ä»¤æ—¶ä¼šé˜»å¡ å•ç‚¹æ•…éšœï¼šåè°ƒè€…æ•…éšœä¼šå¯¼è‡´å‚ä¸è€…ä¸€ç›´é˜»å¡ æ•°æ®ä¸ä¸€è‡´ï¼šç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´éƒ¨åˆ†å‚ä¸è€…æäº¤ï¼Œéƒ¨åˆ†å›æ»š 3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰ åŸç† åœ¨2PCåŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶æœºåˆ¶å’ŒCanCommité˜¶æ®µï¼š\nç¬¬ä¸€é˜¶æ®µï¼šCanCommit\nåè°ƒè€…è¯¢é—®å‚ä¸è€…æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡ ç¬¬äºŒé˜¶æ®µï¼šPreCommit\nå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤ ç¬¬ä¸‰é˜¶æ®µï¼šDoCommit\nå‚ä¸è€…æäº¤æˆ–å›æ»šäº‹åŠ¡ æ”¹è¿› è¶…æ—¶æœºåˆ¶ï¼šå‚ä¸è€…ç­‰å¾…è¶…æ—¶åè‡ªåŠ¨æäº¤ å‡å°‘é˜»å¡ï¼šCanCommité˜¶æ®µä¸å ç”¨èµ„æº ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\né™ä½äº†é˜»å¡èŒƒå›´ å¢åŠ äº†è¶…æ—¶æœºåˆ¶ ç¼ºç‚¹ï¼š\nä»ç„¶å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„é£é™© å®ç°æ›´å¤æ‚ æ€§èƒ½å¼€é”€æ›´å¤§ TCCï¼ˆTry-Confirm-Cancelï¼‰ åŸç† å°†äº‹åŠ¡åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š\nTryé˜¶æ®µï¼š\nå°è¯•æ‰§è¡Œä¸šåŠ¡ å®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ é¢„ç•™å¿…é¡»çš„ä¸šåŠ¡èµ„æº Confirmé˜¶æ®µï¼š\nç¡®è®¤æ‰§è¡Œä¸šåŠ¡ ä¸åšä»»ä½•ä¸šåŠ¡æ£€æŸ¥ åªä½¿ç”¨Tryé˜¶æ®µé¢„ç•™çš„èµ„æº Cancelé˜¶æ®µï¼š\nå–æ¶ˆæ‰§è¡Œä¸šåŠ¡ é‡Šæ”¾Tryé˜¶æ®µé¢„ç•™çš„èµ„æº ä»£ç ç¤ºä¾‹ 1// è®¢å•æœåŠ¡ 2@Service 3public class OrderService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 /** 9 * Tryï¼šåˆ›å»ºè®¢å•ï¼ŒçŠ¶æ€ä¸ºINIT 10 */ 11 @Transactional 12 public Long tryCreateOrder(OrderDTO orderDTO) { 13 Order order = new Order(); 14 order.setUserId(orderDTO.getUserId()); 15 order.setAmount(orderDTO.getAmount()); 16 order.setStatus(OrderStatus.INIT); // åˆå§‹çŠ¶æ€ 17 orderMapper.insert(order); 18 return order.getId(); 19 } 20 21 /** 22 * Confirmï¼šç¡®è®¤è®¢å•ï¼ŒçŠ¶æ€æ”¹ä¸ºSUCCESS 23 */ 24 @Transactional 25 public void confirmOrder(Long orderId) { 26 Order order = orderMapper.selectById(orderId); 27 order.setStatus(OrderStatus.SUCCESS); 28 orderMapper.updateById(order); 29 } 30 31 /** 32 * Cancelï¼šå–æ¶ˆè®¢å•ï¼ŒçŠ¶æ€æ”¹ä¸ºCANCEL 33 */ 34 @Transactional 35 public void cancelOrder(Long orderId) { 36 Order order = orderMapper.selectById(orderId); 37 order.setStatus(OrderStatus.CANCEL); 38 orderMapper.updateById(order); 39 } 40} 41 42// åº“å­˜æœåŠ¡ 43@Service 44public class InventoryService { 45 46 @Autowired 47 private InventoryMapper inventoryMapper; 48 49 /** 50 * Tryï¼šå†»ç»“åº“å­˜ 51 */ 52 @Transactional 53 public void tryDeductInventory(Long productId, Integer quantity) { 54 Inventory inventory = inventoryMapper.selectByProductId(productId); 55 56 // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³ 57 if (inventory.getAvailable() \u0026lt; quantity) { 58 throw new BusinessException(\u0026#34;åº“å­˜ä¸è¶³\u0026#34;); 59 } 60 61 // å†»ç»“åº“å­˜ 62 inventory.setAvailable(inventory.getAvailable() - quantity); 63 inventory.setFrozen(inventory.getFrozen() + quantity); 64 inventoryMapper.updateById(inventory); 65 } 66 67 /** 68 * Confirmï¼šæ‰£å‡å†»ç»“åº“å­˜ 69 */ 70 @Transactional 71 public void confirmDeductInventory(Long productId, Integer quantity) { 72 Inventory inventory = inventoryMapper.selectByProductId(productId); 73 inventory.setFrozen(inventory.getFrozen() - quantity); 74 inventoryMapper.updateById(inventory); 75 } 76 77 /** 78 * Cancelï¼šé‡Šæ”¾å†»ç»“åº“å­˜ 79 */ 80 @Transactional 81 public void cancelDeductInventory(Long productId, Integer quantity) { 82 Inventory inventory = inventoryMapper.selectByProductId(productId); 83 inventory.setAvailable(inventory.getAvailable() + quantity); 84 inventory.setFrozen(inventory.getFrozen() - quantity); 85 inventoryMapper.updateById(inventory); 86 } 87} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nä¸ä¾èµ–èµ„æºç®¡ç†å™¨çš„äº‹åŠ¡æ”¯æŒ æ€§èƒ½è¾ƒå¥½ï¼Œä¸ä¼šé•¿æ—¶é—´é”å®šèµ„æº å¯ä»¥è·¨æ•°æ®åº“ã€è·¨åº”ç”¨ ç¼ºç‚¹ï¼š\nä¸šåŠ¡ä¾µå…¥æ€§å¼ºï¼Œéœ€è¦å®ç°Tryã€Confirmã€Cancelä¸‰ä¸ªæ–¹æ³• å®ç°å¤æ‚ï¼Œéœ€è¦è€ƒè™‘å¹‚ç­‰æ€§ã€ç©ºå›æ»šã€æ‚¬æŒ‚ç­‰é—®é¢˜ Sagaæ¨¡å¼ åŸç† å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°çŸ­äº‹åŠ¡ï¼Œæ¯ä¸ªçŸ­äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿äº‹åŠ¡ã€‚\næ­£å‘æµç¨‹ï¼šT1 â†’ T2 â†’ T3 â†’ \u0026hellip; â†’ Tn\nè¡¥å¿æµç¨‹ï¼šC1 â† C2 â† C3 â† \u0026hellip; â† Cn\nå®ç°æ–¹å¼ 1. äº‹ä»¶é©±åŠ¨ï¼ˆChoreographyï¼‰ï¼š\næ¯ä¸ªæœåŠ¡å®Œæˆåå‘å¸ƒäº‹ä»¶ ä¸‹ä¸€ä¸ªæœåŠ¡ç›‘å¬äº‹ä»¶å¹¶æ‰§è¡Œ 2. å‘½ä»¤åè°ƒï¼ˆOrchestrationï¼‰ï¼š\nä¸­å¤®åè°ƒå™¨æ§åˆ¶æ•´ä¸ªæµç¨‹ åè°ƒå™¨è°ƒç”¨å„ä¸ªæœåŠ¡ ä»£ç ç¤ºä¾‹ 1// Sagaåè°ƒå™¨ 2@Service 3public class OrderSagaOrchestrator { 4 5 @Autowired 6 private OrderService orderService; 7 8 @Autowired 9 private InventoryService inventoryService; 10 11 @Autowired 12 private AccountService accountService; 13 14 public void createOrder(OrderDTO orderDTO) { 15 Long orderId = null; 16 try { 17 // 1. åˆ›å»ºè®¢å• 18 orderId = orderService.createOrder(orderDTO); 19 20 // 2. æ‰£å‡åº“å­˜ 21 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 22 23 // 3. æ‰£å‡ä½™é¢ 24 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 25 26 // 4. å®Œæˆè®¢å• 27 orderService.completeOrder(orderId); 28 29 } catch (Exception e) { 30 // è¡¥å¿æµç¨‹ 31 if (orderId != null) { 32 accountService.refundBalance(orderDTO.getUserId(), orderDTO.getAmount()); 33 inventoryService.restoreInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 34 orderService.cancelOrder(orderId); 35 } 36 throw e; 37 } 38 } 39} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nä¸€é˜¶æ®µæäº¤ï¼Œæ€§èƒ½å¥½ å‚ä¸è€…å¯ä»¥å¼‚æ­¥æ‰§è¡Œ è¡¥å¿æœºåˆ¶çµæ´» ç¼ºç‚¹ï¼š\nä¸ä¿è¯éš”ç¦»æ€§ éœ€è¦è®¾è®¡è¡¥å¿é€»è¾‘ å®ç°å¤æ‚åº¦é«˜ Seataæ¡†æ¶ æ¶æ„ 1åº”ç”¨å±‚ 2 â†“ 3Seata Client (RM + TM) 4 â†“ 5Seata Server (TC) 6 â†“ 7æ•°æ®åº“ ä¸‰ä¸ªè§’è‰²ï¼š\nTC (Transaction Coordinator)ï¼šäº‹åŠ¡åè°ƒå™¨ï¼Œç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ TM (Transaction Manager)ï¼šäº‹åŠ¡ç®¡ç†å™¨ï¼Œå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ RM (Resource Manager)ï¼šèµ„æºç®¡ç†å™¨ï¼Œç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æº ATæ¨¡å¼ Seataçš„é»˜è®¤æ¨¡å¼ï¼ŒåŸºäºæ”¯æŒæœ¬åœ°ACIDäº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“ã€‚\nåŸç†ï¼š\nä¸€é˜¶æ®µï¼šä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—è®°å½•åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æäº¤ äºŒé˜¶æ®µï¼š æäº¤ï¼šå¼‚æ­¥åŒ–ï¼Œå¿«é€Ÿå®Œæˆ å›æ»šï¼šé€šè¿‡å›æ»šæ—¥å¿—è¿›è¡Œåå‘è¡¥å¿ å¿«é€Ÿå¼€å§‹ 1. æ·»åŠ ä¾èµ–ï¼š\n1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;io.seata\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;seata-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;1.7.1\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; 2. é…ç½®Seataï¼š\n1seata: 2 enabled: true 3 application-id: order-service 4 tx-service-group: my_test_tx_group 5 service: 6 vgroup-mapping: 7 my_test_tx_group: default 8 grouplist: 9 default: 127.0.0.1:8091 10 registry: 11 type: nacos 12 nacos: 13 server-addr: 127.0.0.1:8848 14 namespace: public 15 group: SEATA_GROUP 3. åˆ›å»ºundo_logè¡¨ï¼š\n1CREATE TABLE `undo_log` ( 2 `id` bigint(20) NOT NULL AUTO_INCREMENT, 3 `branch_id` bigint(20) NOT NULL, 4 `xid` varchar(100) NOT NULL, 5 `context` varchar(128) NOT NULL, 6 `rollback_info` longblob NOT NULL, 7 `log_status` int(11) NOT NULL, 8 `log_created` datetime NOT NULL, 9 `log_modified` datetime NOT NULL, 10 PRIMARY KEY (`id`), 11 UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`) 12) ENGINE=InnoDB DEFAULT CHARSET=utf8; 4. ä½¿ç”¨@GlobalTransactionalï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 @Autowired 8 private InventoryServiceClient inventoryService; 9 10 @Autowired 11 private AccountServiceClient accountService; 12 13 @GlobalTransactional(name = \u0026#34;create-order\u0026#34;, rollbackFor = Exception.class) 14 public void createOrder(OrderDTO orderDTO) { 15 // 1. åˆ›å»ºè®¢å• 16 Order order = new Order(); 17 order.setUserId(orderDTO.getUserId()); 18 order.setAmount(orderDTO.getAmount()); 19 orderMapper.insert(order); 20 21 // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰ 22 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 23 24 // 3. æ‰£å‡ä½™é¢ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰ 25 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 26 } 27} TCCæ¨¡å¼ Seataä¹Ÿæ”¯æŒTCCæ¨¡å¼ï¼Œéœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š\n1@LocalTCC 2public interface InventoryTccAction { 3 4 @TwoPhaseBusinessAction(name = \u0026#34;deductInventory\u0026#34;, commitMethod = \u0026#34;commit\u0026#34;, rollbackMethod = \u0026#34;rollback\u0026#34;) 5 boolean prepare(BusinessActionContext context, 6 @BusinessActionContextParameter(paramName = \u0026#34;productId\u0026#34;) Long productId, 7 @BusinessActionContextParameter(paramName = \u0026#34;quantity\u0026#34;) Integer quantity); 8 9 boolean commit(BusinessActionContext context); 10 11 boolean rollback(BusinessActionContext context); 12} 13 14@Service 15public class InventoryTccActionImpl implements InventoryTccAction { 16 17 @Override 18 @Transactional 19 public boolean prepare(BusinessActionContext context, Long productId, Integer quantity) { 20 // Tryï¼šå†»ç»“åº“å­˜ 21 inventoryMapper.freezeInventory(productId, quantity); 22 return true; 23 } 24 25 @Override 26 @Transactional 27 public boolean commit(BusinessActionContext context) { 28 // Confirmï¼šæ‰£å‡å†»ç»“åº“å­˜ 29 Long productId = (Long) context.getActionContext(\u0026#34;productId\u0026#34;); 30 Integer quantity = (Integer) context.getActionContext(\u0026#34;quantity\u0026#34;); 31 inventoryMapper.deductFrozenInventory(productId, quantity); 32 return true; 33 } 34 35 @Override 36 @Transactional 37 public boolean rollback(BusinessActionContext context) { 38 // Cancelï¼šé‡Šæ”¾å†»ç»“åº“å­˜ 39 Long productId = (Long) context.getActionContext(\u0026#34;productId\u0026#34;); 40 Integer quantity = (Integer) context.getActionContext(\u0026#34;quantity\u0026#34;); 41 inventoryMapper.releaseFrozenInventory(productId, quantity); 42 return true; 43 } 44} Sagaæ¨¡å¼ Seataçš„Sagaæ¨¡å¼åŸºäºçŠ¶æ€æœºå¼•æ“ï¼š\n1{ 2 \u0026#34;Name\u0026#34;: \u0026#34;CreateOrderSaga\u0026#34;, 3 \u0026#34;Comment\u0026#34;: \u0026#34;åˆ›å»ºè®¢å•Saga\u0026#34;, 4 \u0026#34;StartState\u0026#34;: \u0026#34;CreateOrder\u0026#34;, 5 \u0026#34;States\u0026#34;: { 6 \u0026#34;CreateOrder\u0026#34;: { 7 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 8 \u0026#34;ServiceName\u0026#34;: \u0026#34;orderService\u0026#34;, 9 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;createOrder\u0026#34;, 10 \u0026#34;CompensateState\u0026#34;: \u0026#34;CancelOrder\u0026#34;, 11 \u0026#34;Next\u0026#34;: \u0026#34;DeductInventory\u0026#34; 12 }, 13 \u0026#34;DeductInventory\u0026#34;: { 14 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 15 \u0026#34;ServiceName\u0026#34;: \u0026#34;inventoryService\u0026#34;, 16 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;deductInventory\u0026#34;, 17 \u0026#34;CompensateState\u0026#34;: \u0026#34;RestoreInventory\u0026#34;, 18 \u0026#34;Next\u0026#34;: \u0026#34;DeductBalance\u0026#34; 19 }, 20 \u0026#34;DeductBalance\u0026#34;: { 21 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 22 \u0026#34;ServiceName\u0026#34;: \u0026#34;accountService\u0026#34;, 23 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;deductBalance\u0026#34;, 24 \u0026#34;CompensateState\u0026#34;: \u0026#34;RefundBalance\u0026#34;, 25 \u0026#34;IsEnd\u0026#34;: true 26 }, 27 \u0026#34;CancelOrder\u0026#34;: { 28 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 29 \u0026#34;ServiceName\u0026#34;: \u0026#34;orderService\u0026#34;, 30 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;cancelOrder\u0026#34;, 31 \u0026#34;IsEnd\u0026#34;: true 32 }, 33 \u0026#34;RestoreInventory\u0026#34;: { 34 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 35 \u0026#34;ServiceName\u0026#34;: \u0026#34;inventoryService\u0026#34;, 36 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;restoreInventory\u0026#34;, 37 \u0026#34;Next\u0026#34;: \u0026#34;CancelOrder\u0026#34; 38 }, 39 \u0026#34;RefundBalance\u0026#34;: { 40 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 41 \u0026#34;ServiceName\u0026#34;: \u0026#34;accountService\u0026#34;, 42 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;refundBalance\u0026#34;, 43 \u0026#34;Next\u0026#34;: \u0026#34;RestoreInventory\u0026#34; 44 } 45 } 46} XAæ¨¡å¼ Seataçš„XAæ¨¡å¼æ˜¯å¯¹ä¼ ç»ŸXAåè®®çš„å°è£…ï¼š\n1@GlobalTransactional 2public void createOrderXA(OrderDTO orderDTO) { 3 // XAæ¨¡å¼ä¸‹ï¼ŒSeataä¼šè‡ªåŠ¨ç®¡ç†XAäº‹åŠ¡ 4 // ä¸šåŠ¡ä»£ç ä¸ATæ¨¡å¼ç›¸åŒ 5 orderService.createOrder(orderDTO); 6 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 7 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 8} XA vs ATï¼š\nXAï¼šå¼ºä¸€è‡´æ€§ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œéœ€è¦æ•°æ®åº“æ”¯æŒXAåè®® ATï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½è¾ƒå¥½ï¼ŒåŸºäºæœ¬åœ°äº‹åŠ¡ æ–¹æ¡ˆå¯¹æ¯” æ–¹æ¡ˆ ä¸€è‡´æ€§ æ€§èƒ½ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ 2PC/3PC å¼ºä¸€è‡´ ä½ ä¸­ çŸ­äº‹åŠ¡ï¼Œå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜ TCC æœ€ç»ˆä¸€è‡´ é«˜ é«˜ å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œå¯æ¥å—æœ€ç»ˆä¸€è‡´ Saga æœ€ç»ˆä¸€è‡´ é«˜ ä¸­ é•¿äº‹åŠ¡ï¼Œä¸šåŠ¡æµç¨‹å¤æ‚ Seata AT æœ€ç»ˆä¸€è‡´ ä¸­ ä½ ä¸šåŠ¡ä¾µå…¥å°ï¼Œå¿«é€Ÿæ¥å…¥ Seata TCC æœ€ç»ˆä¸€è‡´ é«˜ é«˜ å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶ Seata XA å¼ºä¸€è‡´ ä½ ä½ éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œæ•°æ®åº“æ”¯æŒXA ç”Ÿäº§å®è·µ 1. å¹‚ç­‰æ€§è®¾è®¡ 1@Service 2public class OrderService { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 6 7 @GlobalTransactional 8 public void createOrder(OrderDTO orderDTO) { 9 String idempotentKey = \u0026#34;order:create:\u0026#34; + orderDTO.getRequestId(); 10 11 // æ£€æŸ¥å¹‚ç­‰æ€§ 12 Boolean success = redisTemplate.opsForValue().setIfAbsent( 13 idempotentKey, \u0026#34;1\u0026#34;, 10, TimeUnit.MINUTES 14 ); 15 16 if (!success) { 17 throw new BusinessException(\u0026#34;é‡å¤è¯·æ±‚\u0026#34;); 18 } 19 20 try { 21 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 22 doCreateOrder(orderDTO); 23 } catch (Exception e) { 24 // åˆ é™¤å¹‚ç­‰é”®ï¼Œå…è®¸é‡è¯• 25 redisTemplate.delete(idempotentKey); 26 throw e; 27 } 28 } 29} 2. è¶…æ—¶æ§åˆ¶ 1@GlobalTransactional( 2 name = \u0026#34;create-order\u0026#34;, 3 timeoutMills = 30000, // 30ç§’è¶…æ—¶ 4 rollbackFor = Exception.class 5) 6public void createOrder(OrderDTO orderDTO) { 7 // ä¸šåŠ¡é€»è¾‘ 8} 3. å¼‚å¸¸å¤„ç† 1@Service 2public class OrderService { 3 4 @GlobalTransactional(rollbackFor = Exception.class) 5 public void createOrder(OrderDTO orderDTO) { 6 try { 7 // ä¸šåŠ¡é€»è¾‘ 8 doCreateOrder(orderDTO); 9 } catch (BusinessException e) { 10 // ä¸šåŠ¡å¼‚å¸¸ï¼Œå›æ»š 11 log.error(\u0026#34;åˆ›å»ºè®¢å•å¤±è´¥ï¼š{}\u0026#34;, e.getMessage()); 12 throw e; 13 } catch (Exception e) { 14 // ç³»ç»Ÿå¼‚å¸¸ï¼Œå›æ»š 15 log.error(\u0026#34;ç³»ç»Ÿå¼‚å¸¸\u0026#34;, e); 16 throw new SystemException(\u0026#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); 17 } 18 } 19} 4. ç›‘æ§å‘Šè­¦ 1@Aspect 2@Component 3public class SeataMonitorAspect { 4 5 @Around(\u0026#34;@annotation(globalTransactional)\u0026#34;) 6 public Object monitor(ProceedingJoinPoint pjp, GlobalTransactional globalTransactional) throws Throwable { 7 String txName = globalTransactional.name(); 8 long startTime = System.currentTimeMillis(); 9 10 try { 11 Object result = pjp.proceed(); 12 long duration = System.currentTimeMillis() - startTime; 13 14 // è®°å½•æˆåŠŸæŒ‡æ ‡ 15 Metrics.counter(\u0026#34;seata.transaction.success\u0026#34;, \u0026#34;name\u0026#34;, txName).increment(); 16 Metrics.timer(\u0026#34;seata.transaction.duration\u0026#34;, \u0026#34;name\u0026#34;, txName).record(duration, TimeUnit.MILLISECONDS); 17 18 return result; 19 } catch (Exception e) { 20 // è®°å½•å¤±è´¥æŒ‡æ ‡ 21 Metrics.counter(\u0026#34;seata.transaction.failure\u0026#34;, \u0026#34;name\u0026#34;, txName).increment(); 22 throw e; 23 } 24 } 25} é¿å‘æç¤ºï¼š åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼ŒåŠ¡å¿…æ³¨æ„ï¼š1) è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼›2) å®ç°å¹‚ç­‰æ€§ï¼›3) åšå¥½ç›‘æ§å‘Šè­¦ï¼›4) å‡†å¤‡é™çº§æ–¹æ¡ˆï¼›5) å®šæœŸæ¸…ç†undo_logè¡¨ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼š\n2PC/3PCï¼šå¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½å·®ï¼Œé€‚åˆçŸ­äº‹åŠ¡ TCCï¼šæ€§èƒ½å¥½ï¼Œä½†å®ç°å¤æ‚ï¼Œé€‚åˆå¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ Sagaï¼šé€‚åˆé•¿äº‹åŠ¡ï¼Œè¡¥å¿æœºåˆ¶çµæ´» Seata ATï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸šåŠ¡ä¾µå…¥å°ï¼Œé€‚åˆå¿«é€Ÿæ¥å…¥ Seata TCCï¼šæ€§èƒ½å¥½ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶ Seata XAï¼šå¼ºä¸€è‡´æ€§ï¼Œå®ç°ç®€å•ï¼Œä½†æ€§èƒ½è¾ƒå·® é€‰æ‹©åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆæ—¶ï¼Œéœ€è¦è€ƒè™‘ï¼š\nä¸€è‡´æ€§è¦æ±‚ï¼šå¼ºä¸€è‡´è¿˜æ˜¯æœ€ç»ˆä¸€è‡´ æ€§èƒ½è¦æ±‚ï¼šèƒ½å¦æ¥å—é˜»å¡å’Œé”å®š ä¸šåŠ¡å¤æ‚åº¦ï¼šäº‹åŠ¡é“¾è·¯é•¿åº¦å’Œå¤æ‚åº¦ å¼€å‘æˆæœ¬ï¼šå®ç°å’Œç»´æŠ¤çš„å¤æ‚åº¦ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå»ºè®®ï¼š\nä¼˜å…ˆè€ƒè™‘ä¸šåŠ¡è®¾è®¡ï¼Œé¿å…åˆ†å¸ƒå¼äº‹åŠ¡ èƒ½ç”¨æœ€ç»ˆä¸€è‡´æ€§å°±ä¸ç”¨å¼ºä¸€è‡´æ€§ Seata ATæ¨¡å¼é€‚åˆå¿«é€Ÿæ¥å…¥ å¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ä½¿ç”¨TCCæˆ–Saga éœ€è¦å¼ºä¸€è‡´æ€§ä¸”æ•°æ®åº“æ”¯æŒXAæ—¶ä½¿ç”¨XAæ¨¡å¼ ä¸‹æ¬¡å½“ä½ éœ€è¦å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œä¸å¦¨æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\n","permalink":"http://localhost:1313/posts/2025/12/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%BB%8E-2pc-%E5%88%B0-seata-%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B8%8E%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œå¾€å¾€éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯è¿™äº›æ“ä½œçš„ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªç»å…¸éš¾é¢˜ã€‚æœ¬æ–‡å°†ç³»ç»Ÿè®²è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒé—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡2PCã€3PCã€TCCã€Sagaç­‰æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨Seataæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜\"\u003eåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"ä¸šåŠ¡åœºæ™¯\"\u003eä¸šåŠ¡åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eç”µå•†ä¸‹å•åœºæ™¯ï¼Œæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eç”¨æˆ·ä¸‹å•\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003eè®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003eåº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003eè´¦æˆ·æœåŠ¡ï¼šæ‰£å‡ä½™é¢\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003eç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ†\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eé—®é¢˜\u003c/strong\u003eï¼šå¦‚æœæŸä¸ªæœåŠ¡å¤±è´¥ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\u003c/p\u003e\n\u003ch3 id=\"capç†è®º\"\u003eCAPç†è®º\u003c/h3\u003e\n\u003cp\u003eåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸‰ä¸ªç‰¹æ€§ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eC (Consistency)\u003c/strong\u003eï¼šä¸€è‡´æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eA (Availability)\u003c/strong\u003eï¼šå¯ç”¨æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eP (Partition Tolerance)\u003c/strong\u003eï¼šåˆ†åŒºå®¹é”™æ€§\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eCAPå®šç†\u003c/strong\u003eï¼šä¸‰è€…æœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤ä¸ª\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå®é™…é€‰æ‹©\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCPï¼šç‰ºç‰²å¯ç”¨æ€§ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ˆå¦‚ZooKeeperï¼‰\u003c/li\u003e\n\u003cli\u003eAPï¼šç‰ºç‰²ä¸€è‡´æ€§ï¼Œä¿è¯å¯ç”¨æ€§ï¼ˆå¦‚Eurekaï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"baseç†è®º\"\u003eBASEç†è®º\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eBA (Basically Available)\u003c/strong\u003eï¼šåŸºæœ¬å¯ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eS (Soft State)\u003c/strong\u003eï¼šè½¯çŠ¶æ€\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eE (Eventually Consistent)\u003c/strong\u003eï¼šæœ€ç»ˆä¸€è‡´æ€§\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¼ºä¸€è‡´æ€§å¾€å¾€éš¾ä»¥å®ç°ä¸”ä»£ä»·é«˜æ˜‚ã€‚å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼Œè¿™ä¹Ÿæ˜¯ç°ä»£åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆçš„åŸºç¡€ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"2pcä¸¤é˜¶æ®µæäº¤\"\u003e2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰\u003c/h2\u003e\n\u003ch3 id=\"åŸç†\"\u003eåŸç†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€Prepareè¯·æ±‚\u003c/li\u003e\n\u003cli\u003eå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤\u003c/li\u003e\n\u003cli\u003eå‚ä¸è€…è¿”å›Yesæˆ–No\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eç¬¬äºŒé˜¶æ®µï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›Yesï¼Œåè°ƒè€…å‘é€Commitè¯·æ±‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœæœ‰å‚ä¸è€…è¿”å›Noï¼Œåè°ƒè€…å‘é€Rollbackè¯·æ±‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"æµç¨‹å›¾\"\u003eæµç¨‹å›¾\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003eåè°ƒè€…                å‚ä¸è€…1              å‚ä¸è€…2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Prepare----------\u0026gt;|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Prepare----------------------------\u0026gt;|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |\u0026lt;--Yes/No------------|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |\u0026lt;--Yes/No-------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Commit/Rollback--\u0026gt;|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Commit/Rollback----------------------\u0026gt;|\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ä»£ç ç¤ºä¾‹\"\u003eä»£ç ç¤ºä¾‹\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eTwoPhaseCommitCoordinator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eexecuteTransaction\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecanCommit\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¬¬äºŒé˜¶æ®µï¼šæäº¤æˆ–å›æ»š\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecanCommit\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e                \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e35\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e36\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e37\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e38\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e39\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e40\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e41\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e42\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e43\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e44\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e45\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ä¼˜ç¼ºç‚¹\"\u003eä¼˜ç¼ºç‚¹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¼˜ç‚¹\u003c/strong\u003eï¼š\u003c/p\u003e","title":"åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼šä» 2PC åˆ° Seata çš„æ¼”è¿›ä¸å®æˆ˜"},{"content":"é˜…è¯»ä¼˜ç§€çš„å¼€æºé¡¹ç›®æºç æ˜¯æå‡æŠ€æœ¯èƒ½åŠ›çš„æœ€ä½³é€”å¾„ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œé¢å¯¹åŠ¨è¾„å‡ åä¸‡è¡Œçš„ä»£ç ï¼Œå¾ˆå¤šäººä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹ã€‚æœ¬æ–‡å°†ä»¥Spring Bootä¸ºä¾‹ï¼Œç³»ç»Ÿè®²è§£å¦‚ä½•é«˜æ•ˆåœ°é˜…è¯»å’Œå­¦ä¹ å¼€æºé¡¹ç›®æºç ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æºç é˜…è¯»çš„ç³»ç»Ÿæ–¹æ³•è®º å­¦ä¼šä½¿ç”¨å·¥å…·è¾…åŠ©æºç é˜…è¯» ç†è§£Spring Bootçš„æ ¸å¿ƒè®¾è®¡æ€æƒ³ æŒæ¡ä»å®è§‚åˆ°å¾®è§‚çš„é˜…è¯»ç­–ç•¥ å»ºç«‹æºç å­¦ä¹ çš„é•¿æ•ˆæœºåˆ¶ ä¸ºä»€ä¹ˆè¦è¯»æºç  æºç é˜…è¯»çš„ä»·å€¼ æ·±å…¥ç†è§£åŸç†ï¼šçŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶ å­¦ä¹ è®¾è®¡æ¨¡å¼ï¼šçœ‹å¤§å¸ˆå¦‚ä½•è®¾è®¡æ¶æ„ æå‡ç¼–ç èƒ½åŠ›ï¼šå­¦ä¹ ä¼˜ç§€çš„ä»£ç é£æ ¼ è§£å†³ç–‘éš¾é—®é¢˜ï¼šé‡åˆ°é—®é¢˜èƒ½å¿«é€Ÿå®šä½ å‚ä¸å¼€æºè´¡çŒ®ï¼šä¸ºå¼€æºç¤¾åŒºåšè´¡çŒ® å¸¸è§è¯¯åŒº âŒ ä»ç¬¬ä¸€è¡Œå¼€å§‹è¯»ï¼šå®¹æ˜“è¿·å¤±åœ¨ç»†èŠ‚ä¸­ âŒ è¿½æ±‚å®Œå…¨ç†è§£ï¼šè¯•å›¾ç†è§£æ¯ä¸€è¡Œä»£ç  âŒ æ²¡æœ‰ç›®æ ‡ï¼šæ¼«æ— ç›®çš„åœ°æµè§ˆä»£ç  âŒ åªçœ‹ä¸ç»ƒï¼šåªçœ‹ä¸å†™ï¼Œæ— æ³•çœŸæ­£æŒæ¡\nâœ… å¸¦ç€é—®é¢˜è¯»ï¼šå›´ç»•å…·ä½“é—®é¢˜å±•å¼€ âœ… æŠ“ä½ä¸»çº¿ï¼šç†è§£æ ¸å¿ƒæµç¨‹å’Œè®¾è®¡æ€æƒ³ âœ… å¾ªåºæ¸è¿›ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥ âœ… è¾¹è¯»è¾¹å†™ï¼šé€šè¿‡å®è·µåŠ æ·±ç†è§£\næ¶æ„æ€è€ƒï¼š é˜…è¯»æºç ä¸æ˜¯ä¸ºäº†è®°ä½æ¯ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯ç†è§£è®¾è®¡æ€æƒ³å’Œæ¶æ„æ¨¡å¼ã€‚è¦å­¦ä¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œä»æ•´ä½“åˆ°ç»†èŠ‚çš„é˜…è¯»æ–¹æ³•ã€‚\næºç é˜…è¯»æ–¹æ³•è®º 1. å‡†å¤‡é˜¶æ®µ é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼š\né€‰æ‹©ç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚Spring Boot 2.7.xï¼‰ é¿å…é€‰æ‹©æœ€æ–°çš„å¼€å‘ç‰ˆæœ¬ æŸ¥çœ‹ç‰ˆæœ¬çš„Release Notes æ­å»ºè°ƒè¯•ç¯å¢ƒï¼š\n1# 1. å…‹éš†æºç  2git clone https://github.com/spring-projects/spring-boot.git 3cd spring-boot 4 5# 2. åˆ‡æ¢åˆ°ç¨³å®šç‰ˆæœ¬ 6git checkout v2.7.18 7 8# 3. å¯¼å…¥IDEï¼ˆIDEAï¼‰ 9# File -\u0026gt; Open -\u0026gt; é€‰æ‹©spring-bootç›®å½• å‡†å¤‡ç¤ºä¾‹é¡¹ç›®ï¼š\n1\u0026lt;!-- pom.xml --\u0026gt; 2\u0026lt;parent\u0026gt; 3 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 4 \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; 5 \u0026lt;version\u0026gt;2.7.18\u0026lt;/version\u0026gt; 6\u0026lt;/parent\u0026gt; 7 8\u0026lt;dependencies\u0026gt; 9 \u0026lt;dependency\u0026gt; 10 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 11 \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; 12 \u0026lt;/dependency\u0026gt; 13\u0026lt;/dependencies\u0026gt; 2. å®è§‚é˜¶æ®µ äº†è§£é¡¹ç›®ç»“æ„ï¼š\n1spring-boot/ 2â”œâ”€â”€ spring-boot-project/ 3â”‚ â”œâ”€â”€ spring-boot/ # æ ¸å¿ƒæ¨¡å— 4â”‚ â”œâ”€â”€ spring-boot-autoconfigure/ # è‡ªåŠ¨é…ç½® 5â”‚ â”œâ”€â”€ spring-boot-starters/ # Starterä¾èµ– 6â”‚ â”œâ”€â”€ spring-boot-actuator/ # ç›‘æ§ç«¯ç‚¹ 7â”‚ â””â”€â”€ spring-boot-test/ # æµ‹è¯•æ”¯æŒ 8â”œâ”€â”€ spring-boot-samples/ # ç¤ºä¾‹é¡¹ç›® 9â””â”€â”€ spring-boot-tests/ # é›†æˆæµ‹è¯• é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼š\nSpring Boot Reference Documentation äº†è§£æ ¸å¿ƒç‰¹æ€§å’Œä½¿ç”¨æ–¹å¼ ç†è§£è®¾è®¡ç†å¿µå’Œæ¶æ„æ€æƒ³ ç»˜åˆ¶æ¶æ„å›¾ï¼š\n1åº”ç”¨å¯åŠ¨ 2 â†“ 3@SpringBootApplication 4 â†“ 5SpringApplication.run() 6 â†“ 7åˆ›å»ºApplicationContext 8 â†“ 9è‡ªåŠ¨é…ç½®ï¼ˆAutoConfigurationï¼‰ 10 â†“ 11å¯åŠ¨å†…åµŒWebæœåŠ¡å™¨ 12 â†“ 13åº”ç”¨å°±ç»ª 3. å¾®è§‚é˜¶æ®µ é€‰æ‹©åˆ‡å…¥ç‚¹ï¼š\nä»æœ€å¸¸ç”¨çš„åŠŸèƒ½å¼€å§‹ï¼ˆå¦‚å¯åŠ¨æµç¨‹ï¼‰ ä»é‡åˆ°çš„é—®é¢˜å¼€å§‹ï¼ˆå¦‚è‡ªåŠ¨é…ç½®åŸç†ï¼‰ ä»æ„Ÿå…´è¶£çš„ç‰¹æ€§å¼€å§‹ï¼ˆå¦‚æ¡ä»¶æ³¨è§£ï¼‰ ä½¿ç”¨è°ƒè¯•å·¥å…·ï¼š\næ–­ç‚¹è°ƒè¯•ï¼šè§‚å¯Ÿæ‰§è¡Œæµç¨‹ è°ƒç”¨æ ˆï¼šç†è§£æ–¹æ³•è°ƒç”¨å…³ç³» å˜é‡ç›‘è§†ï¼šæŸ¥çœ‹å¯¹è±¡çŠ¶æ€ Spring Boot å¯åŠ¨æµç¨‹åˆ†æ å…¥å£ï¼š@SpringBootApplication 1@SpringBootApplication 2public class DemoApplication { 3 public static void main(String[] args) { 4 SpringApplication.run(DemoApplication.class, args); 5 } 6} @SpringBootApplication æ³¨è§£ï¼š\n1@Target(ElementType.TYPE) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4@Inherited 5@SpringBootConfiguration // 1. é…ç½®ç±» 6@EnableAutoConfiguration // 2. è‡ªåŠ¨é…ç½® 7@ComponentScan // 3. ç»„ä»¶æ‰«æ 8public @interface SpringBootApplication { 9 // ... 10} ä¸‰ä¸ªæ ¸å¿ƒæ³¨è§£ï¼š\n@SpringBootConfigurationï¼šæ ‡è®°ä¸ºé…ç½®ç±» @EnableAutoConfigurationï¼šå¯ç”¨è‡ªåŠ¨é…ç½® @ComponentScanï¼šæ‰«æç»„ä»¶ SpringApplication.run() æµç¨‹ 1public class SpringApplication { 2 3 public static ConfigurableApplicationContext run(Class\u0026lt;?\u0026gt; primarySource, String... args) { 4 return run(new Class\u0026lt;?\u0026gt;[] { primarySource }, args); 5 } 6 7 public static ConfigurableApplicationContext run(Class\u0026lt;?\u0026gt;[] primarySources, String[] args) { 8 // åˆ›å»ºSpringApplicationå®ä¾‹å¹¶è¿è¡Œ 9 return new SpringApplication(primarySources).run(args); 10 } 11 12 public ConfigurableApplicationContext run(String... args) { 13 // 1. åˆ›å»ºStopWatchï¼Œè®°å½•å¯åŠ¨æ—¶é—´ 14 StopWatch stopWatch = new StopWatch(); 15 stopWatch.start(); 16 17 // 2. åˆ›å»ºBootstrapä¸Šä¸‹æ–‡ 18 DefaultBootstrapContext bootstrapContext = createBootstrapContext(); 19 ConfigurableApplicationContext context = null; 20 21 // 3. é…ç½®Headlesså±æ€§ 22 configureHeadlessProperty(); 23 24 // 4. è·å–SpringApplicationRunListeners 25 SpringApplicationRunListeners listeners = getRunListeners(args); 26 listeners.starting(bootstrapContext, this.mainApplicationClass); 27 28 try { 29 // 5. å‡†å¤‡ç¯å¢ƒ 30 ApplicationArguments applicationArguments = new DefaultApplicationArguments(args); 31 ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments); 32 33 // 6. æ‰“å°Banner 34 Banner printedBanner = printBanner(environment); 35 36 // 7. åˆ›å»ºApplicationContext 37 context = createApplicationContext(); 38 context.setApplicationStartup(this.applicationStartup); 39 40 // 8. å‡†å¤‡Context 41 prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner); 42 43 // 9. åˆ·æ–°Contextï¼ˆæ ¸å¿ƒï¼‰ 44 refreshContext(context); 45 46 // 10. åˆ·æ–°åå¤„ç† 47 afterRefresh(context, applicationArguments); 48 49 stopWatch.stop(); 50 51 // 11. å‘å¸ƒå¯åŠ¨å®Œæˆäº‹ä»¶ 52 listeners.started(context); 53 54 // 12. è°ƒç”¨Runners 55 callRunners(context, applicationArguments); 56 } 57 catch (Throwable ex) { 58 handleRunFailure(context, ex, listeners); 59 throw new IllegalStateException(ex); 60 } 61 62 try { 63 listeners.running(context); 64 } 65 catch (Throwable ex) { 66 handleRunFailure(context, ex, null); 67 throw new IllegalStateException(ex); 68 } 69 70 return context; 71 } 72} å¯åŠ¨æµç¨‹å›¾ï¼š\n11. åˆ›å»ºStopWatch 2 â†“ 32. åˆ›å»ºBootstrapä¸Šä¸‹æ–‡ 4 â†“ 53. è·å–RunListeners 6 â†“ 74. å‡†å¤‡Environment 8 â†“ 95. æ‰“å°Banner 10 â†“ 116. åˆ›å»ºApplicationContext 12 â†“ 137. å‡†å¤‡Context 14 â†“ 158. åˆ·æ–°Contextï¼ˆåŠ è½½Beanï¼‰ 16 â†“ 179. è°ƒç”¨Runners 18 â†“ 1910. å‘å¸ƒå¯åŠ¨å®Œæˆäº‹ä»¶ è‡ªåŠ¨é…ç½®åŸç† @EnableAutoConfiguration 1@Target(ElementType.TYPE) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4@Inherited 5@AutoConfigurationPackage 6@Import(AutoConfigurationImportSelector.class) // æ ¸å¿ƒ 7public @interface EnableAutoConfiguration { 8 // ... 9} AutoConfigurationImportSelector 1public class AutoConfigurationImportSelector implements DeferredImportSelector { 2 3 @Override 4 public String[] selectImports(AnnotationMetadata annotationMetadata) { 5 if (!isEnabled(annotationMetadata)) { 6 return NO_IMPORTS; 7 } 8 9 // 1. è·å–è‡ªåŠ¨é…ç½®ç±» 10 AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(annotationMetadata); 11 return StringUtils.toStringArray(autoConfigurationEntry.getConfigurations()); 12 } 13 14 protected AutoConfigurationEntry getAutoConfigurationEntry(AnnotationMetadata annotationMetadata) { 15 if (!isEnabled(annotationMetadata)) { 16 return EMPTY_ENTRY; 17 } 18 19 AnnotationAttributes attributes = getAttributes(annotationMetadata); 20 21 // 2. åŠ è½½å€™é€‰é…ç½®ç±» 22 List\u0026lt;String\u0026gt; configurations = getCandidateConfigurations(annotationMetadata, attributes); 23 24 // 3. å»é‡ 25 configurations = removeDuplicates(configurations); 26 27 // 4. æ’é™¤æŒ‡å®šçš„é…ç½®ç±» 28 Set\u0026lt;String\u0026gt; exclusions = getExclusions(annotationMetadata, attributes); 29 checkExcludedClasses(configurations, exclusions); 30 configurations.removeAll(exclusions); 31 32 // 5. è¿‡æ»¤ï¼ˆæ ¹æ®æ¡ä»¶æ³¨è§£ï¼‰ 33 configurations = getConfigurationClassFilter().filter(configurations); 34 35 // 6. è§¦å‘è‡ªåŠ¨é…ç½®å¯¼å…¥äº‹ä»¶ 36 fireAutoConfigurationImportEvents(configurations, exclusions); 37 38 return new AutoConfigurationEntry(configurations, exclusions); 39 } 40 41 protected List\u0026lt;String\u0026gt; getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) { 42 // ä»META-INF/spring.factoriesåŠ è½½é…ç½®ç±» 43 List\u0026lt;String\u0026gt; configurations = SpringFactoriesLoader.loadFactoryNames( 44 getSpringFactoriesLoaderFactoryClass(), 45 getBeanClassLoader() 46 ); 47 return configurations; 48 } 49} spring.factories 1# spring-boot-autoconfigure/META-INF/spring.factories 2 3org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 4org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\\ 5org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\\ 6org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\\ 7org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\\ 8org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration,\\ 9... è‡ªåŠ¨é…ç½®ç¤ºä¾‹ 1@Configuration(proxyBeanMethods = false) 2@ConditionalOnClass({ DataSource.class, EmbeddedDatabaseType.class }) 3@ConditionalOnMissingBean(type = \u0026#34;io.r2dbc.spi.ConnectionFactory\u0026#34;) 4@EnableConfigurationProperties(DataSourceProperties.class) 5@Import({ DataSourcePoolMetadataProvidersConfiguration.class }) 6public class DataSourceAutoConfiguration { 7 8 @Configuration(proxyBeanMethods = false) 9 @Conditional(EmbeddedDatabaseCondition.class) 10 @ConditionalOnMissingBean({ DataSource.class, XADataSource.class }) 11 @Import(EmbeddedDataSourceConfiguration.class) 12 protected static class EmbeddedDatabaseConfiguration { 13 } 14 15 @Configuration(proxyBeanMethods = false) 16 @Conditional(PooledDataSourceCondition.class) 17 @ConditionalOnMissingBean({ DataSource.class, XADataSource.class }) 18 @Import({ DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class, 19 DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.OracleUcp.class, 20 DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class }) 21 protected static class PooledDataSourceConfiguration { 22 } 23} æ¡ä»¶æ³¨è§£ï¼š\n@ConditionalOnClassï¼šç±»è·¯å¾„å­˜åœ¨æŒ‡å®šç±» @ConditionalOnMissingBeanï¼šå®¹å™¨ä¸­ä¸å­˜åœ¨æŒ‡å®šBean @ConditionalOnPropertyï¼šé…ç½®æ–‡ä»¶å­˜åœ¨æŒ‡å®šå±æ€§ æ¡ä»¶æ³¨è§£åŸç† @Conditional 1@Target({ ElementType.TYPE, ElementType.METHOD }) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4public @interface Conditional { 5 Class\u0026lt;? extends Condition\u0026gt;[] value(); 6} Conditionæ¥å£ 1@FunctionalInterface 2public interface Condition { 3 boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata); 4} OnClassConditionå®ç° 1@Order(Ordered.HIGHEST_PRECEDENCE) 2class OnClassCondition extends FilteringSpringBootCondition { 3 4 @Override 5 public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) { 6 ClassLoader classLoader = context.getClassLoader(); 7 ConditionMessage matchMessage = ConditionMessage.empty(); 8 9 // è·å–@ConditionalOnClassæ³¨è§£çš„value 10 List\u0026lt;String\u0026gt; onClasses = getCandidates(metadata, ConditionalOnClass.class); 11 if (onClasses != null) { 12 // æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨ 13 List\u0026lt;String\u0026gt; missing = filter(onClasses, ClassNameFilter.MISSING, classLoader); 14 if (!missing.isEmpty()) { 15 return ConditionOutcome.noMatch( 16 ConditionMessage.forCondition(ConditionalOnClass.class) 17 .didNotFind(\u0026#34;required class\u0026#34;, \u0026#34;required classes\u0026#34;) 18 .items(Style.QUOTE, missing) 19 ); 20 } 21 matchMessage = matchMessage.andCondition(ConditionalOnClass.class) 22 .found(\u0026#34;required class\u0026#34;, \u0026#34;required classes\u0026#34;) 23 .items(Style.QUOTE, filter(onClasses, ClassNameFilter.PRESENT, classLoader)); 24 } 25 26 // è·å–@ConditionalOnMissingClassæ³¨è§£çš„value 27 List\u0026lt;String\u0026gt; onMissingClasses = getCandidates(metadata, ConditionalOnMissingClass.class); 28 if (onMissingClasses != null) { 29 // æ£€æŸ¥ç±»æ˜¯å¦ä¸å­˜åœ¨ 30 List\u0026lt;String\u0026gt; present = filter(onMissingClasses, ClassNameFilter.PRESENT, classLoader); 31 if (!present.isEmpty()) { 32 return ConditionOutcome.noMatch( 33 ConditionMessage.forCondition(ConditionalOnMissingClass.class) 34 .found(\u0026#34;unwanted class\u0026#34;, \u0026#34;unwanted classes\u0026#34;) 35 .items(Style.QUOTE, present) 36 ); 37 } 38 matchMessage = matchMessage.andCondition(ConditionalOnMissingClass.class) 39 .didNotFind(\u0026#34;unwanted class\u0026#34;, \u0026#34;unwanted classes\u0026#34;) 40 .items(Style.QUOTE, filter(onMissingClasses, ClassNameFilter.MISSING, classLoader)); 41 } 42 43 return ConditionOutcome.match(matchMessage); 44 } 45} æºç é˜…è¯»æŠ€å·§ 1. ä½¿ç”¨IDEAè°ƒè¯• è®¾ç½®æ–­ç‚¹ï¼š\n1// åœ¨å…³é”®æ–¹æ³•è®¾ç½®æ–­ç‚¹ 2public ConfigurableApplicationContext run(String... args) { 3 // æ–­ç‚¹1ï¼šå¯åŠ¨å…¥å£ 4 StopWatch stopWatch = new StopWatch(); 5 stopWatch.start(); 6 7 // æ–­ç‚¹2ï¼šåˆ›å»ºContext 8 context = createApplicationContext(); 9 10 // æ–­ç‚¹3ï¼šåˆ·æ–°Context 11 refreshContext(context); 12 13 return context; 14} æŸ¥çœ‹è°ƒç”¨æ ˆï¼š\nä½¿ç”¨Ctrl+Alt+HæŸ¥çœ‹æ–¹æ³•è°ƒç”¨å±‚æ¬¡ ä½¿ç”¨Alt+F7æŸ¥æ‰¾æ–¹æ³•ä½¿ç”¨ä½ç½® æ¡ä»¶æ–­ç‚¹ï¼š\n1// åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è§¦å‘æ–­ç‚¹ 2if (beanName.equals(\u0026#34;dataSource\u0026#34;)) { 3 // æ–­ç‚¹ï¼šåªåœ¨åˆ›å»ºdataSourceæ—¶è§¦å‘ 4} 2. ç»˜åˆ¶æµç¨‹å›¾ ä½¿ç”¨å·¥å…·ç»˜åˆ¶å…³é”®æµç¨‹ï¼š\nDraw.io PlantUML Mermaid 1sequenceDiagram 2 participant Main 3 participant SpringApplication 4 participant Context 5 participant AutoConfig 6 7 Main-\u0026gt;\u0026gt;SpringApplication: run() 8 SpringApplication-\u0026gt;\u0026gt;Context: createApplicationContext() 9 SpringApplication-\u0026gt;\u0026gt;AutoConfig: loadAutoConfiguration() 10 AutoConfig-\u0026gt;\u0026gt;Context: registerBeans() 11 SpringApplication-\u0026gt;\u0026gt;Context: refresh() 12 Context--\u0026gt;\u0026gt;Main: ApplicationContext 3. åšç¬”è®° è®°å½•å…³é”®ç‚¹ï¼š\næ ¸å¿ƒç±»å’Œæ¥å£ è®¾è®¡æ¨¡å¼çš„åº”ç”¨ å·§å¦™çš„å®ç°æŠ€å·§ ç–‘é—®å’Œå¾…ç ”ç©¶çš„é—®é¢˜ ç¤ºä¾‹ç¬”è®°ï¼š\n1## SpringApplicationå¯åŠ¨æµç¨‹ 2 3### æ ¸å¿ƒæ–¹æ³• 4- `run(String... args)`: å¯åŠ¨å…¥å£ 5- `prepareEnvironment()`: å‡†å¤‡ç¯å¢ƒ 6- `createApplicationContext()`: åˆ›å»ºä¸Šä¸‹æ–‡ 7- `refreshContext()`: åˆ·æ–°ä¸Šä¸‹æ–‡ 8 9### è®¾è®¡æ¨¡å¼ 10- æ¨¡æ¿æ–¹æ³•ï¼šrun()æ–¹æ³•å®šä¹‰æµç¨‹ï¼Œå­ç±»å¯æ‰©å±• 11- ç­–ç•¥æ¨¡å¼ï¼šApplicationContextFactoryåˆ›å»ºä¸åŒç±»å‹çš„Context 12- è§‚å¯Ÿè€…æ¨¡å¼ï¼šSpringApplicationRunListenersç›‘å¬å¯åŠ¨äº‹ä»¶ 13 14### ç–‘é—® 15- [ ] Environmentæ˜¯å¦‚ä½•åŠ è½½é…ç½®æ–‡ä»¶çš„ï¼Ÿ 16- [ ] Beançš„å¾ªç¯ä¾èµ–æ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ 4. å†™æµ‹è¯•ä»£ç  éªŒè¯ç†è§£ï¼š\n1@Test 2public void testAutoConfiguration() { 3 // 1. åˆ›å»ºAnnotationConfigApplicationContext 4 AnnotationConfigApplicationContext context = 5 new AnnotationConfigApplicationContext(); 6 7 // 2. æ³¨å†Œé…ç½®ç±» 8 context.register(DataSourceAutoConfiguration.class); 9 10 // 3. åˆ·æ–°å®¹å™¨ 11 context.refresh(); 12 13 // 4. éªŒè¯Beanæ˜¯å¦åˆ›å»º 14 DataSource dataSource = context.getBean(DataSource.class); 15 assertNotNull(dataSource); 16} æ¨¡ä»¿å®ç°ï¼š\n1// æ¨¡ä»¿Spring Bootçš„æ¡ä»¶æ³¨è§£ 2@Target({ ElementType.TYPE, ElementType.METHOD }) 3@Retention(RetentionPolicy.RUNTIME) 4@Conditional(OnMyClassCondition.class) 5public @interface ConditionalOnMyClass { 6 String value(); 7} 8 9public class OnMyClassCondition implements Condition { 10 @Override 11 public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) { 12 Map\u0026lt;String, Object\u0026gt; attributes = metadata.getAnnotationAttributes( 13 ConditionalOnMyClass.class.getName() 14 ); 15 String className = (String) attributes.get(\u0026#34;value\u0026#34;); 16 17 try { 18 Class.forName(className); 19 return true; 20 } catch (ClassNotFoundException e) { 21 return false; 22 } 23 } 24} å­¦ä¹ è·¯å¾„å»ºè®® åˆçº§é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰ ç›®æ ‡ï¼šç†è§£Spring Bootçš„åŸºæœ¬ä½¿ç”¨å’Œæ ¸å¿ƒæ¦‚å¿µ\né˜…è¯»å®˜æ–¹æ–‡æ¡£ è¿è¡Œç¤ºä¾‹é¡¹ç›® ç†è§£@SpringBootApplicationæ³¨è§£ äº†è§£è‡ªåŠ¨é…ç½®çš„åŸºæœ¬åŸç† æ¨èé˜…è¯»ï¼š\nSpringApplication.java @SpringBootApplicationç›¸å…³æ³¨è§£ ç®€å•çš„AutoConfigurationç±» ä¸­çº§é˜¶æ®µï¼ˆ2-4å‘¨ï¼‰ ç›®æ ‡ï¼šæ·±å…¥ç†è§£å¯åŠ¨æµç¨‹å’Œè‡ªåŠ¨é…ç½®æœºåˆ¶\nè°ƒè¯•å¯åŠ¨æµç¨‹ åˆ†æAutoConfigurationImportSelector ç ”ç©¶æ¡ä»¶æ³¨è§£çš„å®ç° å­¦ä¹ å¸¸ç”¨çš„AutoConfiguration æ¨èé˜…è¯»ï¼š\nSpringApplication.run()å®Œæ•´æµç¨‹ AutoConfigurationImportSelector.java OnClassCondition.java DataSourceAutoConfiguration.java WebMvcAutoConfiguration.java é«˜çº§é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ ç›®æ ‡ï¼šæŒæ¡Spring Bootçš„è®¾è®¡æ€æƒ³å’Œæ‰©å±•æœºåˆ¶\nç ”ç©¶SPIæœºåˆ¶ï¼ˆSpringFactoriesLoaderï¼‰ åˆ†æApplicationContextçš„åˆ›å»ºå’Œåˆ·æ–° å­¦ä¹ Actuatorçš„å®ç° ç ”ç©¶Spring Bootçš„æµ‹è¯•æ”¯æŒ æ¨èé˜…è¯»ï¼š\nSpringFactoriesLoader.java ConfigurableApplicationContextç›¸å…³ç±» spring-boot-actuatoræ¨¡å— spring-boot-testæ¨¡å— ä¸“å®¶é˜¶æ®µï¼ˆæŒç»­å­¦ä¹ ï¼‰ ç›®æ ‡ï¼šå‚ä¸å¼€æºè´¡çŒ®ï¼Œæ·±åº¦å®šåˆ¶Spring Boot\né˜…è¯»Issueå’ŒPR å‚ä¸ç¤¾åŒºè®¨è®º æäº¤Bugä¿®å¤æˆ–æ–°ç‰¹æ€§ å¼€å‘è‡ªå®šä¹‰Starter å®æˆ˜ï¼šå¼€å‘è‡ªå®šä¹‰Starter 1. åˆ›å»ºStarteré¡¹ç›® 1\u0026lt;!-- my-spring-boot-starter/pom.xml --\u0026gt; 2\u0026lt;dependencies\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;spring-boot-autoconfigure\u0026lt;/artifactId\u0026gt; 6 \u0026lt;/dependency\u0026gt; 7 \u0026lt;dependency\u0026gt; 8 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 9 \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; 10 \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; 11 \u0026lt;/dependency\u0026gt; 12\u0026lt;/dependencies\u0026gt; 2. å®šä¹‰é…ç½®å±æ€§ 1@ConfigurationProperties(prefix = \u0026#34;my.service\u0026#34;) 2public class MyServiceProperties { 3 4 private String name = \u0026#34;default\u0026#34;; 5 private int timeout = 3000; 6 7 // getters and setters 8} 3. åˆ›å»ºè‡ªåŠ¨é…ç½®ç±» 1@Configuration 2@ConditionalOnClass(MyService.class) 3@EnableConfigurationProperties(MyServiceProperties.class) 4public class MyServiceAutoConfiguration { 5 6 @Bean 7 @ConditionalOnMissingBean 8 public MyService myService(MyServiceProperties properties) { 9 return new MyService(properties.getName(), properties.getTimeout()); 10 } 11} 4. æ³¨å†Œè‡ªåŠ¨é…ç½® 1# META-INF/spring.factories 2org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 3com.example.MyServiceAutoConfiguration 5. ä½¿ç”¨Starter 1\u0026lt;!-- åº”ç”¨é¡¹ç›®çš„pom.xml --\u0026gt; 2\u0026lt;dependency\u0026gt; 3 \u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt; 4 \u0026lt;artifactId\u0026gt;my-spring-boot-starter\u0026lt;/artifactId\u0026gt; 5 \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; 6\u0026lt;/dependency\u0026gt; 1# application.yml 2my: 3 service: 4 name: my-service 5 timeout: 5000 1@SpringBootApplication 2public class Application { 3 4 @Autowired 5 private MyService myService; // è‡ªåŠ¨æ³¨å…¥ 6 7 public static void main(String[] args) { 8 SpringApplication.run(Application.class, args); 9 } 10} æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡ç³»ç»Ÿè®²è§£äº†å¦‚ä½•é˜…è¯»å¼€æºé¡¹ç›®æºç ï¼Œä»¥Spring Bootä¸ºä¾‹ï¼š\næ–¹æ³•è®ºï¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œå¸¦ç€é—®é¢˜è¯»æºç  å¯åŠ¨æµç¨‹ï¼šç†è§£SpringApplication.run()çš„å®Œæ•´æµç¨‹ è‡ªåŠ¨é…ç½®ï¼šæŒæ¡@EnableAutoConfigurationçš„å®ç°åŸç† æ¡ä»¶æ³¨è§£ï¼šå­¦ä¹ @Conditionalçš„è®¾è®¡å’Œå®ç° å­¦ä¹ è·¯å¾„ï¼šä»åˆçº§åˆ°ä¸“å®¶çš„è¿›é˜¶è·¯çº¿ å®æˆ˜ç»ƒä¹ ï¼šå¼€å‘è‡ªå®šä¹‰Starterå·©å›ºç†è§£ é˜…è¯»æºç çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nç›®æ ‡æ˜ç¡®ï¼šå¸¦ç€é—®é¢˜å’Œç›®æ ‡å»è¯» å¾ªåºæ¸è¿›ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥ åŠ¨æ‰‹å®è·µï¼šé€šè¿‡è°ƒè¯•å’Œç¼–ç åŠ æ·±ç†è§£ æŒç»­å­¦ä¹ ï¼šæºç é˜…è¯»æ˜¯ä¸€ä¸ªé•¿æœŸè¿‡ç¨‹ æ¨èçš„å­¦ä¹ èµ„æºï¼š\nSpring Bootå®˜æ–¹æ–‡æ¡£ Spring Bootæºç  Spring Frameworkæºç  ä¸‹æ¬¡å½“ä½ æƒ³æ·±å…¥å­¦ä¹ ä¸€ä¸ªå¼€æºé¡¹ç›®æ—¶ï¼Œä¸å¦¨æŒ‰ç…§æœ¬æ–‡çš„æ–¹æ³•ï¼Œç³»ç»Ÿæ€§åœ°é˜…è¯»å’Œå­¦ä¹ ã€‚è®°ä½ï¼Œæºç é˜…è¯»ä¸æ˜¯ç›®çš„ï¼Œç†è§£è®¾è®¡æ€æƒ³å’Œæå‡ç¼–ç èƒ½åŠ›æ‰æ˜¯æœ€ç»ˆç›®æ ‡ã€‚\n","permalink":"http://localhost:1313/posts/2025/11/%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E4%BB%A5-spring-boot-%E4%B8%BA%E4%BE%8B/","summary":"\u003cp\u003eé˜…è¯»ä¼˜ç§€çš„å¼€æºé¡¹ç›®æºç æ˜¯æå‡æŠ€æœ¯èƒ½åŠ›çš„æœ€ä½³é€”å¾„ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œé¢å¯¹åŠ¨è¾„å‡ åä¸‡è¡Œçš„ä»£ç ï¼Œå¾ˆå¤šäººä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹ã€‚æœ¬æ–‡å°†ä»¥Spring Bootä¸ºä¾‹ï¼Œç³»ç»Ÿè®²è§£å¦‚ä½•é«˜æ•ˆåœ°é˜…è¯»å’Œå­¦ä¹ å¼€æºé¡¹ç›®æºç ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æºç é˜…è¯»çš„ç³»ç»Ÿæ–¹æ³•è®º\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å·¥å…·è¾…åŠ©æºç é˜…è¯»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£Spring Bootçš„æ ¸å¿ƒè®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ä»å®è§‚åˆ°å¾®è§‚çš„é˜…è¯»ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹æºç å­¦ä¹ çš„é•¿æ•ˆæœºåˆ¶\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆè¦è¯»æºç \"\u003eä¸ºä»€ä¹ˆè¦è¯»æºç \u003c/h2\u003e\n\u003ch3 id=\"æºç é˜…è¯»çš„ä»·å€¼\"\u003eæºç é˜…è¯»çš„ä»·å€¼\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæ·±å…¥ç†è§£åŸç†\u003c/strong\u003eï¼šçŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå­¦ä¹ è®¾è®¡æ¨¡å¼\u003c/strong\u003eï¼šçœ‹å¤§å¸ˆå¦‚ä½•è®¾è®¡æ¶æ„\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæå‡ç¼–ç èƒ½åŠ›\u003c/strong\u003eï¼šå­¦ä¹ ä¼˜ç§€çš„ä»£ç é£æ ¼\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè§£å†³ç–‘éš¾é—®é¢˜\u003c/strong\u003eï¼šé‡åˆ°é—®é¢˜èƒ½å¿«é€Ÿå®šä½\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå‚ä¸å¼€æºè´¡çŒ®\u003c/strong\u003eï¼šä¸ºå¼€æºç¤¾åŒºåšè´¡çŒ®\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"å¸¸è§è¯¯åŒº\"\u003eå¸¸è§è¯¯åŒº\u003c/h3\u003e\n\u003cp\u003eâŒ \u003cstrong\u003eä»ç¬¬ä¸€è¡Œå¼€å§‹è¯»\u003c/strong\u003eï¼šå®¹æ˜“è¿·å¤±åœ¨ç»†èŠ‚ä¸­\nâŒ \u003cstrong\u003eè¿½æ±‚å®Œå…¨ç†è§£\u003c/strong\u003eï¼šè¯•å›¾ç†è§£æ¯ä¸€è¡Œä»£ç \nâŒ \u003cstrong\u003eæ²¡æœ‰ç›®æ ‡\u003c/strong\u003eï¼šæ¼«æ— ç›®çš„åœ°æµè§ˆä»£ç \nâŒ \u003cstrong\u003eåªçœ‹ä¸ç»ƒ\u003c/strong\u003eï¼šåªçœ‹ä¸å†™ï¼Œæ— æ³•çœŸæ­£æŒæ¡\u003c/p\u003e\n\u003cp\u003eâœ… \u003cstrong\u003eå¸¦ç€é—®é¢˜è¯»\u003c/strong\u003eï¼šå›´ç»•å…·ä½“é—®é¢˜å±•å¼€\nâœ… \u003cstrong\u003eæŠ“ä½ä¸»çº¿\u003c/strong\u003eï¼šç†è§£æ ¸å¿ƒæµç¨‹å’Œè®¾è®¡æ€æƒ³\nâœ… \u003cstrong\u003eå¾ªåºæ¸è¿›\u003c/strong\u003eï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥\nâœ… \u003cstrong\u003eè¾¹è¯»è¾¹å†™\u003c/strong\u003eï¼šé€šè¿‡å®è·µåŠ æ·±ç†è§£\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e é˜…è¯»æºç ä¸æ˜¯ä¸ºäº†è®°ä½æ¯ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯ç†è§£è®¾è®¡æ€æƒ³å’Œæ¶æ„æ¨¡å¼ã€‚è¦å­¦ä¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œä»æ•´ä½“åˆ°ç»†èŠ‚çš„é˜…è¯»æ–¹æ³•ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"æºç é˜…è¯»æ–¹æ³•è®º\"\u003eæºç é˜…è¯»æ–¹æ³•è®º\u003c/h2\u003e\n\u003ch3 id=\"1-å‡†å¤‡é˜¶æ®µ\"\u003e1. å‡†å¤‡é˜¶æ®µ\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eé€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé€‰æ‹©ç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚Spring Boot 2.7.xï¼‰\u003c/li\u003e\n\u003cli\u003eé¿å…é€‰æ‹©æœ€æ–°çš„å¼€å‘ç‰ˆæœ¬\u003c/li\u003e\n\u003cli\u003eæŸ¥çœ‹ç‰ˆæœ¬çš„Release Notes\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eæ­å»ºè°ƒè¯•ç¯å¢ƒ\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. å…‹éš†æºç \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/spring-projects/spring-boot.git\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e spring-boot\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. åˆ‡æ¢åˆ°ç¨³å®šç‰ˆæœ¬\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout v2.7.18\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 3. å¯¼å…¥IDEï¼ˆIDEAï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# File -\u0026gt; Open -\u0026gt; é€‰æ‹©spring-bootç›®å½•\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eå‡†å¤‡ç¤ºä¾‹é¡¹ç›®\u003c/strong\u003eï¼š\u003c/p\u003e","title":"å¦‚ä½•é˜…è¯»å¼€æºé¡¹ç›®æºç ï¼šä»¥ Spring Boot ä¸ºä¾‹"},{"content":"\u0026ldquo;è¿™ä¸ªæ¥å£æ€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿ\u0026ldquo;è¿™æ˜¯æ¯ä¸ªåç«¯å¼€å‘éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å½“ç”¨æˆ·æŠ±æ€¨ç³»ç»Ÿå¡é¡¿ï¼Œå½“ç›‘æ§å‘Šè­¦é¢‘ç¹è§¦å‘ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç³»ç»Ÿæ€§åœ°å®šä½å’Œè§£å†³æ€§èƒ½é—®é¢˜ï¼Ÿ\næœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå¸¦ä½ ç»å†ä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ï¼Œä»é—®é¢˜å‘ç°åˆ°æœ€ç»ˆä¼˜åŒ–ï¼Œå°†æ¥å£å“åº”æ—¶é—´ä»3ç§’é™ä½åˆ°300msã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æ€§èƒ½é—®é¢˜çš„ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³• å­¦ä¼šä½¿ç”¨å„ç§æ€§èƒ½åˆ†æå·¥å…· ç†è§£å¸¸è§çš„æ€§èƒ½ç“¶é¢ˆåŠè§£å†³æ–¹æ¡ˆ äº†è§£æ•°æ®åº“ã€ç¼“å­˜ã€ä»£ç å±‚é¢çš„ä¼˜åŒ–æŠ€å·§ å»ºç«‹å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹ é—®é¢˜èƒŒæ™¯ ä¸šåŠ¡åœºæ™¯ æŸç”µå•†ç³»ç»Ÿçš„è®¢å•è¯¦æƒ…æ¥å£ï¼Œç”¨æˆ·åé¦ˆé¡µé¢åŠ è½½ç¼“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚\næ¥å£å®šä¹‰ï¼š\n1@GetMapping(\u0026#34;/api/orders/{orderId}\u0026#34;) 2public Result\u0026lt;OrderDetailVO\u0026gt; getOrderDetail(@PathVariable Long orderId) { 3 return Result.success(orderService.getOrderDetail(orderId)); 4} ç›‘æ§æ•°æ®ï¼š\nå¹³å‡å“åº”æ—¶é—´ï¼š2.8ç§’ P95å“åº”æ—¶é—´ï¼š3.5ç§’ P99å“åº”æ—¶é—´ï¼š5ç§’ QPSï¼š100 ä¸šåŠ¡è¦æ±‚ï¼š\nå“åº”æ—¶é—´ \u0026lt; 500ms P99 \u0026lt; 1ç§’ æ¶æ„æ€è€ƒï¼š æ€§èƒ½ä¼˜åŒ–ä¸æ˜¯ç›²ç›®åœ°ä¼˜åŒ–ï¼Œè€Œæ˜¯è¦åŸºäºæ•°æ®å’Œç›®æ ‡ã€‚é¦–å…ˆè¦æ˜ç¡®æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŒ–ç›®æ ‡ï¼Œç„¶åç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚\nç¬¬ä¸€æ­¥ï¼šé—®é¢˜å®šä½ 1. æ·»åŠ ç›‘æ§åŸ‹ç‚¹ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ—¶é—´éƒ½èŠ±åœ¨å“ªé‡Œäº†ï¼š\n1@Service 2@Slf4j 3public class OrderService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 @Autowired 9 private UserService userService; 10 11 @Autowired 12 private ProductService productService; 13 14 @Autowired 15 private LogisticsService logisticsService; 16 17 public OrderDetailVO getOrderDetail(Long orderId) { 18 long startTime = System.currentTimeMillis(); 19 20 // 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯ 21 long step1Start = System.currentTimeMillis(); 22 Order order = orderMapper.selectById(orderId); 23 log.info(\u0026#34;æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step1Start); 24 25 // 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ 26 long step2Start = System.currentTimeMillis(); 27 User user = userService.getUserById(order.getUserId()); 28 log.info(\u0026#34;æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step2Start); 29 30 // 3. æŸ¥è¯¢å•†å“ä¿¡æ¯ 31 long step3Start = System.currentTimeMillis(); 32 List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 33 List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 34 for (OrderItem item : items) { 35 Product product = productService.getProductById(item.getProductId()); 36 products.add(product); 37 } 38 log.info(\u0026#34;æŸ¥è¯¢å•†å“è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step3Start); 39 40 // 4. æŸ¥è¯¢ç‰©æµä¿¡æ¯ 41 long step4Start = System.currentTimeMillis(); 42 Logistics logistics = logisticsService.getLogisticsByOrderId(orderId); 43 log.info(\u0026#34;æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step4Start); 44 45 // 5. ç»„è£…è¿”å›æ•°æ® 46 OrderDetailVO vo = buildOrderDetailVO(order, user, products, logistics); 47 48 log.info(\u0026#34;æ€»è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - startTime); 49 return vo; 50 } 51} æ—¥å¿—è¾“å‡ºï¼š\n1æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š50ms 2æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š100ms 3æŸ¥è¯¢å•†å“è€—æ—¶ï¼š2500ms â† ç“¶é¢ˆï¼ 4æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š150ms 5æ€»è€—æ—¶ï¼š2800ms 2. åˆ†æç“¶é¢ˆ é€šè¿‡æ—¥å¿—å‘ç°ï¼ŒæŸ¥è¯¢å•†å“ä¿¡æ¯è€—æ—¶æœ€é•¿ï¼Œå æ€»è€—æ—¶çš„89%ã€‚è¿›ä¸€æ­¥åˆ†æä»£ç ï¼š\n1// é—®é¢˜ä»£ç ï¼šN+1æŸ¥è¯¢ 2List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); // 1æ¬¡æŸ¥è¯¢ 3List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 4for (OrderItem item : items) { 5 Product product = productService.getProductById(item.getProductId()); // Næ¬¡æŸ¥è¯¢ 6 products.add(product); 7} é—®é¢˜åˆ†æï¼š\nè®¢å•æœ‰10ä¸ªå•†å“ æ¯ä¸ªå•†å“æŸ¥è¯¢è€—æ—¶250ms æ€»è€—æ—¶ï¼š10 Ã— 250ms = 2500ms ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“ä¼˜åŒ– ä¼˜åŒ–1ï¼šæ‰¹é‡æŸ¥è¯¢ å°†N+1æŸ¥è¯¢æ”¹ä¸ºæ‰¹é‡æŸ¥è¯¢ï¼š\n1// ä¼˜åŒ–åçš„ä»£ç  2List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 3 4// æ”¶é›†æ‰€æœ‰å•†å“ID 5List\u0026lt;Long\u0026gt; productIds = items.stream() 6 .map(OrderItem::getProductId) 7 .collect(Collectors.toList()); 8 9// æ‰¹é‡æŸ¥è¯¢å•†å“ 10List\u0026lt;Product\u0026gt; products = productService.getProductsByIds(productIds); Mapperå®ç°ï¼š\n1@Mapper 2public interface ProductMapper { 3 4 /** 5 * æ‰¹é‡æŸ¥è¯¢å•†å“ 6 */ 7 @Select(\u0026#34;\u0026lt;script\u0026gt;\u0026#34; + 8 \u0026#34;SELECT * FROM t_product WHERE id IN \u0026#34; + 9 \u0026#34;\u0026lt;foreach collection=\u0026#39;ids\u0026#39; item=\u0026#39;id\u0026#39; open=\u0026#39;(\u0026#39; separator=\u0026#39;,\u0026#39; close=\u0026#39;)\u0026#39;\u0026gt;\u0026#34; + 10 \u0026#34;#{id}\u0026#34; + 11 \u0026#34;\u0026lt;/foreach\u0026gt;\u0026#34; + 12 \u0026#34;\u0026lt;/script\u0026gt;\u0026#34;) 13 List\u0026lt;Product\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); 14} ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢å•†å“è€—æ—¶ï¼š2500ms â†’ 300ms æ€»è€—æ—¶ï¼š2800ms â†’ 600ms ä¼˜åŒ–2ï¼šç´¢å¼•ä¼˜åŒ– åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå‘ç°è®¢å•é¡¹æŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼š\n1-- æ…¢æŸ¥è¯¢SQL 2SELECT * FROM t_order_item WHERE order_id = 123456; 3 4-- æ‰§è¡Œè®¡åˆ’ 5EXPLAIN SELECT * FROM t_order_item WHERE order_id = 123456; 6-- type: ALLï¼ˆå…¨è¡¨æ‰«æï¼‰ æ·»åŠ ç´¢å¼•ï¼š\n1CREATE INDEX idx_order_id ON t_order_item(order_id); ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢è®¢å•é¡¹è€—æ—¶ï¼š50ms â†’ 5ms æ€»è€—æ—¶ï¼š600ms â†’ 555ms ä¼˜åŒ–3ï¼šæŸ¥è¯¢å­—æ®µä¼˜åŒ– åŸæŸ¥è¯¢ä½¿ç”¨äº†SELECT *ï¼Œä½†å®é™…åªéœ€è¦éƒ¨åˆ†å­—æ®µï¼š\n1// ä¼˜åŒ–å‰ 2@Select(\u0026#34;SELECT * FROM t_product WHERE id IN (...)\u0026#34;) 3List\u0026lt;Product\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); 4 5// ä¼˜åŒ–åï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ 6@Select(\u0026#34;SELECT id, name, price, image_url FROM t_product WHERE id IN (...)\u0026#34;) 7List\u0026lt;ProductDTO\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢å•†å“è€—æ—¶ï¼š300ms â†’ 200ms æ€»è€—æ—¶ï¼š555ms â†’ 455ms ç¬¬ä¸‰æ­¥ï¼šç¼“å­˜ä¼˜åŒ– ä¼˜åŒ–4ï¼šæ·»åŠ Redisç¼“å­˜ å•†å“ä¿¡æ¯å˜åŒ–ä¸é¢‘ç¹ï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼š\n1@Service 2@Slf4j 3public class ProductService { 4 5 @Autowired 6 private ProductMapper productMapper; 7 8 @Autowired 9 private RedisTemplate\u0026lt;String, Product\u0026gt; redisTemplate; 10 11 private static final String PRODUCT_CACHE_KEY = \u0026#34;product:\u0026#34;; 12 private static final long CACHE_EXPIRE_TIME = 30; // 30åˆ†é’Ÿ 13 14 public List\u0026lt;Product\u0026gt; getProductsByIds(List\u0026lt;Long\u0026gt; productIds) { 15 List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 16 List\u0026lt;Long\u0026gt; missIds = new ArrayList\u0026lt;\u0026gt;(); 17 18 // 1. æ‰¹é‡ä»ç¼“å­˜è·å– 19 List\u0026lt;String\u0026gt; keys = productIds.stream() 20 .map(id -\u0026gt; PRODUCT_CACHE_KEY + id) 21 .collect(Collectors.toList()); 22 23 List\u0026lt;Product\u0026gt; cachedProducts = redisTemplate.opsForValue().multiGet(keys); 24 25 // 2. æ‰¾å‡ºç¼“å­˜æœªå‘½ä¸­çš„ID 26 for (int i = 0; i \u0026lt; productIds.size(); i++) { 27 Product product = cachedProducts.get(i); 28 if (product != null) { 29 products.add(product); 30 } else { 31 missIds.add(productIds.get(i)); 32 } 33 } 34 35 // 3. æŸ¥è¯¢æ•°æ®åº“ 36 if (!missIds.isEmpty()) { 37 List\u0026lt;Product\u0026gt; dbProducts = productMapper.selectByIds(missIds); 38 products.addAll(dbProducts); 39 40 // 4. å†™å…¥ç¼“å­˜ 41 for (Product product : dbProducts) { 42 redisTemplate.opsForValue().set( 43 PRODUCT_CACHE_KEY + product.getId(), 44 product, 45 CACHE_EXPIRE_TIME, 46 TimeUnit.MINUTES 47 ); 48 } 49 } 50 51 return products; 52 } 53} ä¼˜åŒ–æ•ˆæœï¼š\nç¼“å­˜å‘½ä¸­ç‡ï¼š80% æŸ¥è¯¢å•†å“è€—æ—¶ï¼š200ms â†’ 50msï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰ æ€»è€—æ—¶ï¼š455ms â†’ 305ms ä¼˜åŒ–5ï¼šæœ¬åœ°ç¼“å­˜ å¯¹äºçƒ­ç‚¹å•†å“ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š\n1@Service 2public class ProductService { 3 4 // ä½¿ç”¨Caffeineæœ¬åœ°ç¼“å­˜ 5 private final LoadingCache\u0026lt;Long, Product\u0026gt; localCache = Caffeine.newBuilder() 6 .maximumSize(1000) 7 .expireAfterWrite(5, TimeUnit.MINUTES) 8 .build(this::loadProduct); 9 10 private Product loadProduct(Long productId) { 11 // å…ˆæŸ¥Redisï¼Œå†æŸ¥æ•°æ®åº“ 12 String key = PRODUCT_CACHE_KEY + productId; 13 Product product = redisTemplate.opsForValue().get(key); 14 15 if (product == null) { 16 product = productMapper.selectById(productId); 17 if (product != null) { 18 redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES); 19 } 20 } 21 22 return product; 23 } 24 25 public Product getProductById(Long productId) { 26 return localCache.get(productId); 27 } 28} ç¼“å­˜å±‚çº§ï¼š\n1è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â†’ Redis â†’ æ•°æ®åº“ ä¼˜åŒ–æ•ˆæœï¼š\næœ¬åœ°ç¼“å­˜å‘½ä¸­ç‡ï¼š50% æŸ¥è¯¢å•†å“è€—æ—¶ï¼š50ms â†’ 20msï¼ˆæœ¬åœ°ç¼“å­˜å‘½ä¸­æ—¶ï¼‰ æ€»è€—æ—¶ï¼š305ms â†’ 275ms ç¬¬å››æ­¥ï¼šå¹¶å‘ä¼˜åŒ– ä¼˜åŒ–6ï¼šå¹¶è¡ŒæŸ¥è¯¢ ç”¨æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€ç‰©æµä¿¡æ¯ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯ä»¥å¹¶è¡ŒæŸ¥è¯¢ï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private ThreadPoolExecutor executor; 6 7 public OrderDetailVO getOrderDetail(Long orderId) { 8 // 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯ 9 Order order = orderMapper.selectById(orderId); 10 11 // 2. å¹¶è¡ŒæŸ¥è¯¢ç”¨æˆ·ã€å•†å“ã€ç‰©æµä¿¡æ¯ 12 CompletableFuture\u0026lt;User\u0026gt; userFuture = CompletableFuture.supplyAsync( 13 () -\u0026gt; userService.getUserById(order.getUserId()), 14 executor 15 ); 16 17 CompletableFuture\u0026lt;List\u0026lt;Product\u0026gt;\u0026gt; productsFuture = CompletableFuture.supplyAsync(() -\u0026gt; { 18 List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 19 List\u0026lt;Long\u0026gt; productIds = items.stream() 20 .map(OrderItem::getProductId) 21 .collect(Collectors.toList()); 22 return productService.getProductsByIds(productIds); 23 }, executor); 24 25 CompletableFuture\u0026lt;Logistics\u0026gt; logisticsFuture = CompletableFuture.supplyAsync( 26 () -\u0026gt; logisticsService.getLogisticsByOrderId(orderId), 27 executor 28 ); 29 30 // 3. ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ 31 CompletableFuture.allOf(userFuture, productsFuture, logisticsFuture).join(); 32 33 // 4. ç»„è£…è¿”å›æ•°æ® 34 User user = userFuture.join(); 35 List\u0026lt;Product\u0026gt; products = productsFuture.join(); 36 Logistics logistics = logisticsFuture.join(); 37 38 return buildOrderDetailVO(order, user, products, logistics); 39 } 40} ä¼˜åŒ–æ•ˆæœï¼š\nåŸä¸²è¡Œè€—æ—¶ï¼š50msï¼ˆè®¢å•ï¼‰+ 100msï¼ˆç”¨æˆ·ï¼‰+ 20msï¼ˆå•†å“ï¼‰+ 150msï¼ˆç‰©æµï¼‰= 320ms å¹¶è¡Œè€—æ—¶ï¼š50msï¼ˆè®¢å•ï¼‰+ max(100ms, 20ms, 150ms) = 200ms æ€»è€—æ—¶ï¼š275ms â†’ 200ms ç¬¬äº”æ­¥ï¼šä»£ç ä¼˜åŒ– ä¼˜åŒ–7ï¼šå‡å°‘å¯¹è±¡åˆ›å»º 1// ä¼˜åŒ–å‰ï¼šé¢‘ç¹åˆ›å»ºå¯¹è±¡ 2public OrderDetailVO buildOrderDetailVO(Order order, User user, 3 List\u0026lt;Product\u0026gt; products, Logistics logistics) { 4 OrderDetailVO vo = new OrderDetailVO(); 5 vo.setOrderId(order.getId()); 6 vo.setOrderNo(order.getOrderNo()); 7 // ... è®¾ç½®æ›´å¤šå­—æ®µ 8 9 UserVO userVO = new UserVO(); 10 userVO.setUserId(user.getId()); 11 userVO.setUserName(user.getName()); 12 vo.setUser(userVO); 13 14 List\u0026lt;ProductVO\u0026gt; productVOs = new ArrayList\u0026lt;\u0026gt;(); 15 for (Product product : products) { 16 ProductVO productVO = new ProductVO(); 17 productVO.setProductId(product.getId()); 18 productVO.setProductName(product.getName()); 19 productVOs.add(productVO); 20 } 21 vo.setProducts(productVOs); 22 23 return vo; 24} 25 26// ä¼˜åŒ–åï¼šä½¿ç”¨å¯¹è±¡æ˜ å°„å·¥å…· 27@Autowired 28private ModelMapper modelMapper; 29 30public OrderDetailVO buildOrderDetailVO(Order order, User user, 31 List\u0026lt;Product\u0026gt; products, Logistics logistics) { 32 OrderDetailVO vo = modelMapper.map(order, OrderDetailVO.class); 33 vo.setUser(modelMapper.map(user, UserVO.class)); 34 vo.setProducts(products.stream() 35 .map(p -\u0026gt; modelMapper.map(p, ProductVO.class)) 36 .collect(Collectors.toList())); 37 vo.setLogistics(modelMapper.map(logistics, LogisticsVO.class)); 38 return vo; 39} ä¼˜åŒ–8ï¼šé¿å…ä¸å¿…è¦çš„è®¡ç®— 1// ä¼˜åŒ–å‰ï¼šæ¯æ¬¡éƒ½è®¡ç®— 2public BigDecimal calculateTotalAmount(List\u0026lt;OrderItem\u0026gt; items) { 3 BigDecimal total = BigDecimal.ZERO; 4 for (OrderItem item : items) { 5 BigDecimal itemAmount = item.getPrice().multiply(new BigDecimal(item.getQuantity())); 6 total = total.add(itemAmount); 7 } 8 return total; 9} 10 11// ä¼˜åŒ–åï¼šä½¿ç”¨æ•°æ®åº“è®¡ç®—å¥½çš„å­—æ®µ 12public BigDecimal getTotalAmount(Order order) { 13 return order.getTotalAmount(); // ä¸‹å•æ—¶å·²è®¡ç®—å¹¶å­˜å‚¨ 14} ç¬¬å…­æ­¥ï¼šç›‘æ§ä¸éªŒè¯ æ€§èƒ½æµ‹è¯• ä½¿ç”¨JMeterè¿›è¡Œå‹æµ‹ï¼š\n1# å‹æµ‹é…ç½® 2çº¿ç¨‹æ•°ï¼š100 3æŒç»­æ—¶é—´ï¼š5åˆ†é’Ÿ ä¼˜åŒ–å‰åå¯¹æ¯”ï¼š\næŒ‡æ ‡ ä¼˜åŒ–å‰ ä¼˜åŒ–å æå‡ å¹³å‡å“åº”æ—¶é—´ 2800ms 280ms 90% P95å“åº”æ—¶é—´ 3500ms 350ms 90% P99å“åº”æ—¶é—´ 5000ms 450ms 91% QPS 100 500 400% CPUä½¿ç”¨ç‡ 80% 40% 50% ç›‘æ§å‘Šè­¦ é…ç½®Prometheuså‘Šè­¦è§„åˆ™ï¼š\n1groups: 2 - name: api_performance 3 rules: 4 - alert: HighResponseTime 5 expr: http_request_duration_seconds{quantile=\u0026#34;0.99\u0026#34;} \u0026gt; 1 6 for: 5m 7 labels: 8 severity: warning 9 annotations: 10 summary: \u0026#34;APIå“åº”æ—¶é—´è¿‡é«˜\u0026#34; 11 description: \u0026#34;{{ $labels.api }} P99å“åº”æ—¶é—´è¶…è¿‡1ç§’\u0026#34; ä¼˜åŒ–æ€»ç»“ ä¼˜åŒ–è·¯å¾„ 1åŸå§‹æ€§èƒ½ï¼š2800ms 2 â†“ æ‰¹é‡æŸ¥è¯¢ï¼ˆN+1é—®é¢˜ï¼‰ 31. 600msï¼ˆä¼˜åŒ–78%ï¼‰ 4 â†“ æ·»åŠ ç´¢å¼• 52. 555msï¼ˆä¼˜åŒ–7%ï¼‰ 6 â†“ æŸ¥è¯¢å­—æ®µä¼˜åŒ– 73. 455msï¼ˆä¼˜åŒ–18%ï¼‰ 8 â†“ Redisç¼“å­˜ 94. 305msï¼ˆä¼˜åŒ–33%ï¼‰ 10 â†“ æœ¬åœ°ç¼“å­˜ 115. 275msï¼ˆä¼˜åŒ–10%ï¼‰ 12 â†“ å¹¶è¡ŒæŸ¥è¯¢ 136. 200msï¼ˆä¼˜åŒ–27%ï¼‰ 14 â†“ ä»£ç ä¼˜åŒ– 15æœ€ç»ˆï¼š280msï¼ˆæ€»ä¼˜åŒ–90%ï¼‰ ä¼˜åŒ–åŸåˆ™ å…ˆå®šä½ï¼Œåä¼˜åŒ–ï¼šé€šè¿‡ç›‘æ§æ‰¾åˆ°çœŸæ­£çš„ç“¶é¢ˆ æŠ“å¤§æ”¾å°ï¼šä¼˜å…ˆä¼˜åŒ–å æ¯”æœ€å¤§çš„éƒ¨åˆ† åˆ†å±‚ä¼˜åŒ–ï¼šæ•°æ®åº“ â†’ ç¼“å­˜ â†’ ä»£ç  â†’ æ¶æ„ é‡åŒ–è¯„ä¼°ï¼šæ¯æ¬¡ä¼˜åŒ–éƒ½è¦æœ‰æ•°æ®æ”¯æ’‘ æŒç»­ç›‘æ§ï¼šä¼˜åŒ–åè¦æŒç»­è§‚å¯Ÿæ•ˆæœ å¸¸è§æ€§èƒ½ç“¶é¢ˆ ç“¶é¢ˆç±»å‹ å…¸å‹è¡¨ç° è§£å†³æ–¹æ¡ˆ æ•°æ®åº“æ…¢æŸ¥è¯¢ å“åº”æ—¶é—´é•¿ï¼Œæ•°æ®åº“CPUé«˜ ç´¢å¼•ä¼˜åŒ–ã€SQLä¼˜åŒ–ã€åˆ†åº“åˆ†è¡¨ N+1æŸ¥è¯¢ å¤§é‡é‡å¤æŸ¥è¯¢ æ‰¹é‡æŸ¥è¯¢ã€JOINæŸ¥è¯¢ ç¼“å­˜æœªå‘½ä¸­ æ•°æ®åº“å‹åŠ›å¤§ æ·»åŠ ç¼“å­˜ã€é¢„çƒ­ç¼“å­˜ ä¸²è¡Œè°ƒç”¨ å“åº”æ—¶é—´=å„æ­¥éª¤ä¹‹å’Œ å¹¶è¡Œè°ƒç”¨ã€å¼‚æ­¥å¤„ç† å¯¹è±¡åˆ›å»º GCé¢‘ç¹ å¯¹è±¡å¤ç”¨ã€æ± åŒ–æŠ€æœ¯ é”ç«äº‰ å¹¶å‘æ€§èƒ½å·® å‡å°é”ç²’åº¦ã€æ— é”åŒ– æ€§èƒ½ä¼˜åŒ–å·¥å…·ç®± 1. ç›‘æ§å·¥å…· APMå·¥å…·ï¼š\nSkyWalkingï¼šåˆ†å¸ƒå¼è¿½è¸ª Prometheus + Grafanaï¼šæŒ‡æ ‡ç›‘æ§ ELKï¼šæ—¥å¿—åˆ†æ æ•°æ®åº“ç›‘æ§ï¼š\nMySQLæ…¢æŸ¥è¯¢æ—¥å¿— Explainæ‰§è¡Œè®¡åˆ’ Performance Schema 2. åˆ†æå·¥å…· JVMåˆ†æï¼š\n1# æŸ¥çœ‹GCæƒ…å†µ 2jstat -gcutil \u0026lt;pid\u0026gt; 1000 3 4# ç”Ÿæˆå †è½¬å‚¨ 5jmap -dump:format=b,file=heap.hprof \u0026lt;pid\u0026gt; 6 7# çº¿ç¨‹åˆ†æ 8jstack \u0026lt;pid\u0026gt; \u0026gt; thread.txt ç«ç„°å›¾ï¼š\n1# ä½¿ç”¨async-profiler 2./profiler.sh -d 60 -f flamegraph.html \u0026lt;pid\u0026gt; 3. å‹æµ‹å·¥å…· JMeterï¼š\n1jmeter -n -t test-plan.jmx -l result.jtl -e -o report Gatlingï¼š\n1setUp( 2 scn.inject(rampUsersPerSec(10) to 1000 during (5 minutes)) 3).protocols(httpProtocol) æœ€ä½³å®è·µ 1. æ€§èƒ½ä¼˜åŒ–checklist æ·»åŠ ç›‘æ§åŸ‹ç‚¹ï¼Œé‡åŒ–æ€§èƒ½æŒ‡æ ‡ åˆ†ææ…¢æŸ¥è¯¢ï¼Œä¼˜åŒ–SQLå’Œç´¢å¼• è¯†åˆ«N+1æŸ¥è¯¢ï¼Œæ”¹ä¸ºæ‰¹é‡æŸ¥è¯¢ æ·»åŠ ç¼“å­˜ï¼Œæé«˜è¯»æ€§èƒ½ å¹¶è¡ŒåŒ–ç‹¬ç«‹æ“ä½œï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ ä¼˜åŒ–ä»£ç é€»è¾‘ï¼Œå‡å°‘ä¸å¿…è¦çš„è®¡ç®— å‹æµ‹éªŒè¯ï¼Œç¡®ä¿ä¼˜åŒ–æ•ˆæœ æŒç»­ç›‘æ§ï¼Œé˜²æ­¢æ€§èƒ½é€€åŒ– 2. æ€§èƒ½ä¼˜åŒ–è¯¯åŒº âŒ è¿‡æ—©ä¼˜åŒ–ï¼šåœ¨æ²¡æœ‰æ€§èƒ½é—®é¢˜æ—¶å°±å¼€å§‹ä¼˜åŒ– âœ… åŸºäºæ•°æ®ä¼˜åŒ–ï¼šå…ˆæµ‹é‡ï¼Œå†ä¼˜åŒ–\nâŒ ç›²ç›®ä¼˜åŒ–ï¼šä¸çŸ¥é“ç“¶é¢ˆåœ¨å“ªå°±å¼€å§‹ä¼˜åŒ– âœ… å®šä½ç“¶é¢ˆï¼šæ‰¾åˆ°çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆ\nâŒ å±€éƒ¨ä¼˜åŒ–ï¼šåªä¼˜åŒ–æŸä¸ªç‚¹ âœ… ç³»ç»Ÿä¼˜åŒ–ï¼šä»æ•´ä½“è§’åº¦ä¼˜åŒ–\nâŒ å¿½ç•¥ç›‘æ§ï¼šä¼˜åŒ–åä¸ç›‘æ§æ•ˆæœ âœ… æŒç»­ç›‘æ§ï¼šä¼˜åŒ–åæŒç»­è§‚å¯Ÿ\n3. æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹ 1å‘ç°é—®é¢˜ 2 â†“ 3æ·»åŠ ç›‘æ§ï¼ˆé‡åŒ–é—®é¢˜ï¼‰ 4 â†“ 5å®šä½ç“¶é¢ˆï¼ˆæ‰¾åˆ°æ ¹å› ï¼‰ 6 â†“ 7åˆ¶å®šæ–¹æ¡ˆï¼ˆè¯„ä¼°æ”¶ç›Šï¼‰ 8 â†“ 9å®æ–½ä¼˜åŒ–ï¼ˆå°æ­¥å¿«è·‘ï¼‰ 10 â†“ 11éªŒè¯æ•ˆæœï¼ˆå‹æµ‹éªŒè¯ï¼‰ 12 â†“ 13æŒç»­ç›‘æ§ï¼ˆé˜²æ­¢é€€åŒ–ï¼‰ é¿å‘æç¤ºï¼š æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§çš„å·¥ä½œã€‚è¦å»ºç«‹æ€§èƒ½ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³æ€§èƒ½é—®é¢˜ã€‚åŒæ—¶è¦æ³¨æ„ï¼Œè¿‡åº¦ä¼˜åŒ–å¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿå¤æ‚åº¦ï¼Œè¦åœ¨æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå±•ç¤ºäº†å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ï¼š\né—®é¢˜å®šä½ï¼šé€šè¿‡ç›‘æ§åŸ‹ç‚¹æ‰¾åˆ°ç“¶é¢ˆ æ•°æ®åº“ä¼˜åŒ–ï¼šæ‰¹é‡æŸ¥è¯¢ã€ç´¢å¼•ä¼˜åŒ–ã€å­—æ®µä¼˜åŒ– ç¼“å­˜ä¼˜åŒ–ï¼šRedisç¼“å­˜ã€æœ¬åœ°ç¼“å­˜ å¹¶å‘ä¼˜åŒ–ï¼šå¹¶è¡ŒæŸ¥è¯¢ã€å¼‚æ­¥å¤„ç† ä»£ç ä¼˜åŒ–ï¼šå‡å°‘å¯¹è±¡åˆ›å»ºã€é¿å…é‡å¤è®¡ç®— ç›‘æ§éªŒè¯ï¼šå‹æµ‹éªŒè¯ã€æŒç»­ç›‘æ§ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯ï¼š\né‡åŒ–é—®é¢˜ï¼šç”¨æ•°æ®è¯´è¯ å®šä½ç“¶é¢ˆï¼šæ‰¾åˆ°çœŸæ­£çš„é—®é¢˜ ç³»ç»Ÿä¼˜åŒ–ï¼šä»æ•´ä½“è§’åº¦æ€è€ƒ æŒç»­æ”¹è¿›ï¼šå»ºç«‹é•¿æ•ˆæœºåˆ¶ ä¸‹æ¬¡å½“ä½ é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶ï¼Œä¸å¦¨æŒ‰ç…§æœ¬æ–‡çš„æ€è·¯ï¼Œç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚è®°ä½ï¼Œæ€§èƒ½ä¼˜åŒ–ä¸æ˜¯é“¶å¼¹ï¼Œè€Œæ˜¯ä¸€ä¸ªæŒç»­æ”¹è¿›çš„è¿‡ç¨‹ã€‚\n","permalink":"http://localhost:1313/posts/2025/10/%E6%8E%A5%E5%8F%A3%E5%93%8D%E5%BA%94%E6%85%A2%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8B%E6%97%85/","summary":"\u003cp\u003e\u0026ldquo;è¿™ä¸ªæ¥å£æ€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿ\u0026ldquo;è¿™æ˜¯æ¯ä¸ªåç«¯å¼€å‘éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å½“ç”¨æˆ·æŠ±æ€¨ç³»ç»Ÿå¡é¡¿ï¼Œå½“ç›‘æ§å‘Šè­¦é¢‘ç¹è§¦å‘ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç³»ç»Ÿæ€§åœ°å®šä½å’Œè§£å†³æ€§èƒ½é—®é¢˜ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå¸¦ä½ ç»å†ä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ï¼Œä»é—®é¢˜å‘ç°åˆ°æœ€ç»ˆä¼˜åŒ–ï¼Œå°†æ¥å£å“åº”æ—¶é—´ä»3ç§’é™ä½åˆ°300msã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ€§èƒ½é—®é¢˜çš„ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å„ç§æ€§èƒ½åˆ†æå·¥å…·\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å¸¸è§çš„æ€§èƒ½ç“¶é¢ˆåŠè§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£æ•°æ®åº“ã€ç¼“å­˜ã€ä»£ç å±‚é¢çš„ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"é—®é¢˜èƒŒæ™¯\"\u003eé—®é¢˜èƒŒæ™¯\u003c/h2\u003e\n\u003ch3 id=\"ä¸šåŠ¡åœºæ™¯\"\u003eä¸šåŠ¡åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿçš„è®¢å•è¯¦æƒ…æ¥å£ï¼Œç”¨æˆ·åé¦ˆé¡µé¢åŠ è½½ç¼“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ¥å£å®šä¹‰\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@GetMapping\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/api/orders/{orderId}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nd\"\u003e@PathVariable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esuccess\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eç›‘æ§æ•°æ®\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¹³å‡å“åº”æ—¶é—´ï¼š2.8ç§’\u003c/li\u003e\n\u003cli\u003eP95å“åº”æ—¶é—´ï¼š3.5ç§’\u003c/li\u003e\n\u003cli\u003eP99å“åº”æ—¶é—´ï¼š5ç§’\u003c/li\u003e\n\u003cli\u003eQPSï¼š100\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡è¦æ±‚\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå“åº”æ—¶é—´ \u0026lt; 500ms\u003c/li\u003e\n\u003cli\u003eP99 \u0026lt; 1ç§’\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e æ€§èƒ½ä¼˜åŒ–ä¸æ˜¯ç›²ç›®åœ°ä¼˜åŒ–ï¼Œè€Œæ˜¯è¦åŸºäºæ•°æ®å’Œç›®æ ‡ã€‚é¦–å…ˆè¦æ˜ç¡®æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŒ–ç›®æ ‡ï¼Œç„¶åç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥é—®é¢˜å®šä½\"\u003eç¬¬ä¸€æ­¥ï¼šé—®é¢˜å®šä½\u003c/h2\u003e\n\u003ch3 id=\"1-æ·»åŠ ç›‘æ§åŸ‹ç‚¹\"\u003e1. æ·»åŠ ç›‘æ§åŸ‹ç‚¹\u003c/h3\u003e\n\u003cp\u003eé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ—¶é—´éƒ½èŠ±åœ¨å“ªé‡Œäº†ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Slf4j\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrderService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderMapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eProductService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLogisticsService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogisticsService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estartTime\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep1Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep1Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep2Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep2Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. æŸ¥è¯¢å•†å“ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep3Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectItemsByOrderId\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eProduct\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eArrayList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e35\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eProduct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproduct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e36\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eproduct\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e37\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e38\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢å•†å“è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep3Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e39\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e40\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. æŸ¥è¯¢ç‰©æµä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e41\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep4Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e42\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eLogistics\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogistics\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogisticsService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetLogisticsByOrderId\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e43\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep4Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e44\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e45\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 5. ç»„è£…è¿”å›æ•°æ®\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e46\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003evo\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebuildOrderDetailVO\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogistics\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e47\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e48\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æ€»è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estartTime\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e49\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003evo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e50\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e51\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ—¥å¿—è¾“å‡º\u003c/strong\u003eï¼š\u003c/p\u003e","title":"æ¥å£å“åº”æ…¢ï¼Ÿä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…"},{"content":"åœ¨å¤§ä¿ƒã€ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œç³»ç»Ÿèƒ½å¦æ‰›ä½æµé‡å†²å‡»æ˜¯æ¯ä¸ªæŠ€æœ¯å›¢é˜Ÿæœ€å…³å¿ƒçš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„å•æ¥å£å‹æµ‹æ— æ³•çœŸå®åæ˜ ç³»ç»Ÿçš„æ•´ä½“æ‰¿è½½èƒ½åŠ›ï¼Œè€Œå…¨é“¾è·¯å‹æµ‹é€šè¿‡æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºï¼Œå¯ä»¥å…¨é¢éªŒè¯ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºå®Œæ•´çš„å‹æµ‹ä½“ç³»ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£å…¨é“¾è·¯å‹æµ‹çš„æ ¸å¿ƒä»·å€¼ æŒæ¡å‹æµ‹ç¯å¢ƒçš„æ­å»ºæ–¹æ¡ˆ å­¦ä¼šæ•°æ®éš”ç¦»ä¸æµé‡æ ‡è®° äº†è§£å‹æµ‹å·¥å…·çš„é€‰å‹ä¸ä½¿ç”¨ æŒæ¡æ€§èƒ½ç“¶é¢ˆçš„åˆ†æä¸ä¼˜åŒ– ä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹ ä¼ ç»Ÿå‹æµ‹ vs å…¨é“¾è·¯å‹æµ‹ ä¼ ç»Ÿå‹æµ‹ï¼š\né’ˆå¯¹å•ä¸ªæ¥å£æˆ–æœåŠ¡è¿›è¡Œå‹æµ‹ ä½¿ç”¨æµ‹è¯•ç¯å¢ƒæˆ–é¢„å‘å¸ƒç¯å¢ƒ æ•°æ®é‡å°ï¼Œæ— æ³•åæ˜ çœŸå®æƒ…å†µ å…¨é“¾è·¯å‹æµ‹ï¼š\nåœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå‹æµ‹ æ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„å®Œæ•´ä¸šåŠ¡æµç¨‹ ä½¿ç”¨çœŸå®çš„æ•°æ®é‡å’Œç³»ç»Ÿé…ç½® å…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼ çœŸå®æ€§ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œç»“æœæœ€å¯ä¿¡ å…¨é¢æ€§ï¼šè¦†ç›–æ‰€æœ‰ç³»ç»Ÿç»„ä»¶å’Œä¾èµ– åŠæ—¶æ€§ï¼šæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ æŒ‡å¯¼æ€§ï¼šä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æŒ å‹æµ‹åœºæ™¯ 1ç”¨æˆ·è®¿é—® â†’ ç½‘å…³ â†’ åº”ç”¨æœåŠ¡ â†’ ç¼“å­˜ â†’ æ•°æ®åº“ 2 â†“ 3 æ¶ˆæ¯é˜Ÿåˆ— â†’ å¼‚æ­¥æœåŠ¡ 4 â†“ 5 ç¬¬ä¸‰æ–¹æœåŠ¡ æ¶æ„æ€è€ƒï¼š å…¨é“¾è·¯å‹æµ‹ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯ä¸šåŠ¡é—®é¢˜ã€‚éœ€è¦äº§å“ã€è¿è¥ã€æŠ€æœ¯å›¢é˜Ÿå…±åŒå‚ä¸ï¼Œåˆ¶å®šåˆç†çš„å‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡†ã€‚\nå‹æµ‹æ–¹æ¡ˆè®¾è®¡ 1. å‹æµ‹ç›®æ ‡è®¾å®š æ€§èƒ½æŒ‡æ ‡ï¼š\nTPS/QPSï¼šæ¯ç§’äº‹åŠ¡æ•°/æŸ¥è¯¢æ•° å“åº”æ—¶é—´ï¼šP50ã€P95ã€P99 æˆåŠŸç‡ï¼šè¯·æ±‚æˆåŠŸçš„æ¯”ä¾‹ èµ„æºä½¿ç”¨ç‡ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ ä¸šåŠ¡æŒ‡æ ‡ï¼š\nè®¢å•åˆ›å»ºæˆåŠŸç‡ æ”¯ä»˜æˆåŠŸç‡ åº“å­˜æ‰£å‡å‡†ç¡®æ€§ ç¤ºä¾‹ç›®æ ‡ï¼š\n1å¤§ä¿ƒåœºæ™¯ï¼š 2- å³°å€¼ TPSï¼š10000 3- P99 å“åº”æ—¶é—´ï¼š\u0026lt; 500ms 4- æˆåŠŸç‡ï¼š\u0026gt; 99.9% 5- CPU ä½¿ç”¨ç‡ï¼š\u0026lt; 70% 2. å‹æµ‹æµé‡æ¨¡å‹ æµé‡ç‰¹å¾ï¼š\næµé‡æ›²çº¿ï¼šæ¨¡æ‹ŸçœŸå®çš„æµé‡æ³¢åŠ¨ ç”¨æˆ·è¡Œä¸ºï¼šæµè§ˆã€æœç´¢ã€ä¸‹å•ã€æ”¯ä»˜ ä¸šåŠ¡æ¯”ä¾‹ï¼šè¯»å†™æ¯”ä¾‹ã€çƒ­ç‚¹æ•°æ®åˆ†å¸ƒ å‹æµ‹è„šæœ¬ç¤ºä¾‹ï¼ˆJMeterï¼‰ï¼š\n1\u0026lt;TestPlan\u0026gt; 2 \u0026lt;ThreadGroup\u0026gt; 3 \u0026lt;stringProp name=\u0026#34;ThreadGroup.num_threads\u0026#34;\u0026gt;1000\u0026lt;/stringProp\u0026gt; 4 \u0026lt;stringProp name=\u0026#34;ThreadGroup.ramp_time\u0026#34;\u0026gt;60\u0026lt;/stringProp\u0026gt; 5 \u0026lt;stringProp name=\u0026#34;ThreadGroup.duration\u0026#34;\u0026gt;600\u0026lt;/stringProp\u0026gt; 6 7 \u0026lt;!-- æµè§ˆå•†å“ 60% --\u0026gt; 8 \u0026lt;HTTPSamplerProxy name=\u0026#34;æµè§ˆå•†å“\u0026#34;\u0026gt; 9 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/products/${productId}\u0026lt;/stringProp\u0026gt; 10 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;GET\u0026lt;/stringProp\u0026gt; 11 \u0026lt;/HTTPSamplerProxy\u0026gt; 12 13 \u0026lt;!-- åŠ å…¥è´­ç‰©è½¦ 30% --\u0026gt; 14 \u0026lt;HTTPSamplerProxy name=\u0026#34;åŠ å…¥è´­ç‰©è½¦\u0026#34;\u0026gt; 15 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/cart\u0026lt;/stringProp\u0026gt; 16 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;POST\u0026lt;/stringProp\u0026gt; 17 \u0026lt;/HTTPSamplerProxy\u0026gt; 18 19 \u0026lt;!-- ä¸‹å• 10% --\u0026gt; 20 \u0026lt;HTTPSamplerProxy name=\u0026#34;åˆ›å»ºè®¢å•\u0026#34;\u0026gt; 21 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/orders\u0026lt;/stringProp\u0026gt; 22 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;POST\u0026lt;/stringProp\u0026gt; 23 \u0026lt;/HTTPSamplerProxy\u0026gt; 24 \u0026lt;/ThreadGroup\u0026gt; 25\u0026lt;/TestPlan\u0026gt; 3. æ•°æ®éš”ç¦»æ–¹æ¡ˆ åœ¨ç”Ÿäº§ç¯å¢ƒå‹æµ‹ï¼Œå¿…é¡»åšå¥½æ•°æ®éš”ç¦»ï¼Œé¿å…å½±å“çœŸå®ç”¨æˆ·ï¼š\næ–¹æ¡ˆä¸€ï¼šå½±å­è¡¨\n1-- çœŸå®è¡¨ 2CREATE TABLE t_order ( 3 id BIGINT PRIMARY KEY, 4 user_id BIGINT, 5 amount DECIMAL(10,2), 6 status INT, 7 create_time DATETIME 8); 9 10-- å½±å­è¡¨ï¼ˆå‹æµ‹æ•°æ®ï¼‰ 11CREATE TABLE t_order_shadow ( 12 id BIGINT PRIMARY KEY, 13 user_id BIGINT, 14 amount DECIMAL(10,2), 15 status INT, 16 create_time DATETIME 17); æ–¹æ¡ˆäºŒï¼šå½±å­åº“\n1ç”Ÿäº§åº“ï¼šprod_db 2å½±å­åº“ï¼šprod_db_shadow æ–¹æ¡ˆä¸‰ï¼šæ•°æ®æ ‡è®°\n1// åœ¨æ•°æ®ä¸­æ·»åŠ å‹æµ‹æ ‡è®° 2@Data 3public class Order { 4 private Long id; 5 private Long userId; 6 private BigDecimal amount; 7 private Boolean isStressTest; // å‹æµ‹æ ‡è®° 8} æµé‡æ ‡è®°ä¸è·¯ç”± 1. æµé‡æ ‡è®° åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ å‹æµ‹æ ‡è®°ï¼š\n1public class StressTestFilter implements Filter { 2 3 private static final String STRESS_TEST_HEADER = \u0026#34;X-Stress-Test\u0026#34;; 4 5 @Override 6 public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) { 7 HttpServletRequest httpRequest = (HttpServletRequest) request; 8 9 // æ£€æŸ¥æ˜¯å¦ä¸ºå‹æµ‹æµé‡ 10 String stressTest = httpRequest.getHeader(STRESS_TEST_HEADER); 11 if (\u0026#34;true\u0026#34;.equals(stressTest)) { 12 // è®¾ç½®åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡ 13 StressTestContext.setStressTest(true); 14 } 15 16 try { 17 chain.doFilter(request, response); 18 } finally { 19 StressTestContext.clear(); 20 } 21 } 22} 2. æ•°æ®è·¯ç”± æ ¹æ®å‹æµ‹æ ‡è®°è·¯ç”±åˆ°å½±å­è¡¨/å½±å­åº“ï¼š\n1@Component 2public class StressTestDataSourceRouter extends AbstractRoutingDataSource { 3 4 @Override 5 protected Object determineCurrentLookupKey() { 6 // å¦‚æœæ˜¯å‹æµ‹æµé‡ï¼Œè·¯ç”±åˆ°å½±å­åº“ 7 if (StressTestContext.isStressTest()) { 8 return \u0026#34;shadow\u0026#34;; 9 } 10 return \u0026#34;master\u0026#34;; 11 } 12} 13 14@Configuration 15public class DataSourceConfig { 16 17 @Bean 18 public DataSource dataSource() { 19 StressTestDataSourceRouter router = new StressTestDataSourceRouter(); 20 21 Map\u0026lt;Object, Object\u0026gt; targetDataSources = new HashMap\u0026lt;\u0026gt;(); 22 targetDataSources.put(\u0026#34;master\u0026#34;, masterDataSource()); 23 targetDataSources.put(\u0026#34;shadow\u0026#34;, shadowDataSource()); 24 25 router.setTargetDataSources(targetDataSources); 26 router.setDefaultTargetDataSource(masterDataSource()); 27 28 return router; 29 } 30} 3. MyBatis æ‹¦æˆªå™¨ è‡ªåŠ¨åˆ‡æ¢è¡¨åï¼š\n1@Intercepts({ 2 @Signature(type = StatementHandler.class, method = \u0026#34;prepare\u0026#34;, args = {Connection.class, Integer.class}) 3}) 4public class StressTestInterceptor implements Interceptor { 5 6 @Override 7 public Object intercept(Invocation invocation) throws Throwable { 8 StatementHandler statementHandler = (StatementHandler) invocation.getTarget(); 9 BoundSql boundSql = statementHandler.getBoundSql(); 10 String sql = boundSql.getSql(); 11 12 // å¦‚æœæ˜¯å‹æµ‹æµé‡ï¼Œæ›¿æ¢è¡¨å 13 if (StressTestContext.isStressTest()) { 14 sql = sql.replaceAll(\u0026#34;t_(\\\\w+)\u0026#34;, \u0026#34;t_$1_shadow\u0026#34;); 15 16 // åå°„ä¿®æ”¹ SQL 17 Field field = boundSql.getClass().getDeclaredField(\u0026#34;sql\u0026#34;); 18 field.setAccessible(true); 19 field.set(boundSql, sql); 20 } 21 22 return invocation.proceed(); 23 } 24} å‹æµ‹å·¥å…·é€‰å‹ 1. JMeter ä¼˜ç‚¹ï¼š\nåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå¤šç§åè®® å›¾å½¢åŒ–ç•Œé¢ï¼Œæ˜“äºä½¿ç”¨ æ’ä»¶ä¸°å¯Œ ç¼ºç‚¹ï¼š\nå•æœºæ€§èƒ½æœ‰é™ èµ„æºæ¶ˆè€—è¾ƒå¤§ ä½¿ç”¨ç¤ºä¾‹ï¼š\n1# å‘½ä»¤è¡Œæ¨¡å¼è¿è¡Œ 2jmeter -n -t test-plan.jmx -l result.jtl -e -o report 3 4# åˆ†å¸ƒå¼å‹æµ‹ 5jmeter -n -t test-plan.jmx -R 192.168.1.101,192.168.1.102,192.168.1.103 2. Gatling ä¼˜ç‚¹ï¼š\nåŸºäº Scalaï¼Œæ€§èƒ½ä¼˜ç§€ DSL è„šæœ¬ï¼Œæ˜“äºç»´æŠ¤ æŠ¥å‘Šç¾è§‚ ç¤ºä¾‹è„šæœ¬ï¼š\n1import io.gatling.core.Predef._ 2import io.gatling.http.Predef._ 3import scala.concurrent.duration._ 4 5class OrderSimulation extends Simulation { 6 7 val httpProtocol = http 8 .baseUrl(\u0026#34;https://api.example.com\u0026#34;) 9 .header(\u0026#34;X-Stress-Test\u0026#34;, \u0026#34;true\u0026#34;) 10 11 val scn = scenario(\u0026#34;è®¢å•åœºæ™¯\u0026#34;) 12 .exec(http(\u0026#34;æµè§ˆå•†å“\u0026#34;) 13 .get(\u0026#34;/api/products/${productId}\u0026#34;) 14 .check(status.is(200))) 15 .pause(2) 16 .exec(http(\u0026#34;åŠ å…¥è´­ç‰©è½¦\u0026#34;) 17 .post(\u0026#34;/api/cart\u0026#34;) 18 .body(StringBody(\u0026#34;\u0026#34;\u0026#34;{\u0026#34;productId\u0026#34;: \u0026#34;${productId}\u0026#34;, \u0026#34;quantity\u0026#34;: 1}\u0026#34;\u0026#34;\u0026#34;)) 19 .check(status.is(200))) 20 .pause(3) 21 .exec(http(\u0026#34;åˆ›å»ºè®¢å•\u0026#34;) 22 .post(\u0026#34;/api/orders\u0026#34;) 23 .body(StringBody(\u0026#34;\u0026#34;\u0026#34;{\u0026#34;items\u0026#34;: [{\u0026#34;productId\u0026#34;: \u0026#34;${productId}\u0026#34;, \u0026#34;quantity\u0026#34;: 1}]}\u0026#34;\u0026#34;\u0026#34;)) 24 .check(status.is(200))) 25 26 setUp( 27 scn.inject( 28 rampUsersPerSec(10) to 1000 during (5 minutes), 29 constantUsersPerSec(1000) during (10 minutes) 30 ) 31 ).protocols(httpProtocol) 32} 3. é˜¿é‡Œäº‘ PTS ä¼˜ç‚¹ï¼š\näº‘ç«¯å‹æµ‹ï¼Œæ— éœ€æ­å»ºç¯å¢ƒ æ”¯æŒå¤§è§„æ¨¡å¹¶å‘ é›†æˆç›‘æ§å’ŒæŠ¥å‘Š é€‚ç”¨åœºæ™¯ï¼š\nå¤§è§„æ¨¡å‹æµ‹ï¼ˆä¸‡çº§å¹¶å‘ï¼‰ å¿«é€ŸéªŒè¯ æ— å‹æµ‹ç¯å¢ƒ å·¥å…·å¯¹æ¯” å·¥å…· æ€§èƒ½ æ˜“ç”¨æ€§ æˆæœ¬ é€‚ç”¨åœºæ™¯ JMeter ä¸­ é«˜ å…è´¹ ä¸­å°è§„æ¨¡å‹æµ‹ Gatling é«˜ ä¸­ å…è´¹ å¤§è§„æ¨¡å‹æµ‹ é˜¿é‡Œäº‘ PTS å¾ˆé«˜ é«˜ ä»˜è´¹ è¶…å¤§è§„æ¨¡å‹æµ‹ ç›‘æ§ä¸åˆ†æ 1. åº”ç”¨ç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nQPS/TPSï¼šæ¯ç§’è¯·æ±‚æ•° å“åº”æ—¶é—´ï¼šP50ã€P95ã€P99 é”™è¯¯ç‡ï¼š4xxã€5xx é”™è¯¯ çº¿ç¨‹æ± ï¼šæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ Prometheus + Grafanaï¼š\n1# prometheus.yml 2scrape_configs: 3 - job_name: \u0026#39;spring-boot\u0026#39; 4 metrics_path: \u0026#39;/actuator/prometheus\u0026#39; 5 static_configs: 6 - targets: [\u0026#39;192.168.1.101:8080\u0026#39;, \u0026#39;192.168.1.102:8080\u0026#39;] 2. ç³»ç»Ÿç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nCPUï¼šä½¿ç”¨ç‡ã€è´Ÿè½½ å†…å­˜ï¼šä½¿ç”¨ç‡ã€GC é¢‘ç‡ ç£ç›˜ï¼šIOPSã€ååé‡ ç½‘ç»œï¼šå¸¦å®½ã€è¿æ¥æ•° ä½¿ç”¨ Node Exporterï¼š\n1# å¯åŠ¨ Node Exporter 2docker run -d \\ 3 --name=node-exporter \\ 4 -p 9100:9100 \\ 5 prom/node-exporter 3. æ•°æ®åº“ç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nQPSï¼šæŸ¥è¯¢æ•° æ…¢æŸ¥è¯¢ï¼šæ‰§è¡Œæ—¶é—´ \u0026gt; 1s è¿æ¥æ•°ï¼šæ´»è·ƒè¿æ¥ é”ç­‰å¾…ï¼šè¡Œé”ã€è¡¨é” MySQL æ…¢æŸ¥è¯¢åˆ†æï¼š\n1-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— 2SET GLOBAL slow_query_log = \u0026#39;ON\u0026#39;; 3SET GLOBAL long_query_time = 1; 4 5-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ 6SELECT * FROM mysql.slow_log ORDER BY query_time DESC LIMIT 10; 4. æ€§èƒ½åˆ†æ ç«ç„°å›¾ï¼š\n1# ä½¿ç”¨ async-profiler 2./profiler.sh -d 60 -f flamegraph.html \u0026lt;pid\u0026gt; JVM åˆ†æï¼š\n1# æŸ¥çœ‹ GC æƒ…å†µ 2jstat -gcutil \u0026lt;pid\u0026gt; 1000 3 4# ç”Ÿæˆå †è½¬å‚¨ 5jmap -dump:format=b,file=heap.hprof \u0026lt;pid\u0026gt; 6 7# åˆ†æå †è½¬å‚¨ 8jhat heap.hprof æ€§èƒ½ä¼˜åŒ–å®æˆ˜ æ¡ˆä¾‹ä¸€ï¼šæ•°æ®åº“æ…¢æŸ¥è¯¢ é—®é¢˜ï¼šè®¢å•æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´ P99 è¾¾åˆ° 2 ç§’\nåˆ†æï¼š\n1-- æ…¢æŸ¥è¯¢ SQL 2SELECT * FROM t_order 3WHERE user_id = 123 AND status = 1 4ORDER BY create_time DESC 5LIMIT 10; 6 7-- æ‰§è¡Œè®¡åˆ’ 8EXPLAIN SELECT * FROM t_order 9WHERE user_id = 123 AND status = 1 10ORDER BY create_time DESC 11LIMIT 10; 12 13-- ç»“æœï¼štype=ALLï¼Œå…¨è¡¨æ‰«æ ä¼˜åŒ–ï¼š\n1-- æ·»åŠ å¤åˆç´¢å¼• 2CREATE INDEX idx_user_status_time ON t_order(user_id, status, create_time); 3 4-- ä¼˜åŒ–åï¼štype=refï¼Œä½¿ç”¨ç´¢å¼• æ•ˆæœï¼šå“åº”æ—¶é—´é™ä½åˆ° 50ms\næ¡ˆä¾‹äºŒï¼šç¼“å­˜ç©¿é€ é—®é¢˜ï¼šRedis ç¼“å­˜æœªå‘½ä¸­ï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“\nåˆ†æï¼š\n1// åŸä»£ç  2public Order getOrder(Long orderId) { 3 // æŸ¥è¯¢ç¼“å­˜ 4 Order order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 5 if (order == null) { 6 // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ 7 order = orderMapper.selectById(orderId); 8 if (order != null) { 9 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, order, 30, TimeUnit.MINUTES); 10 } 11 } 12 return order; 13} ä¼˜åŒ–ï¼š\n1// ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ 2@Autowired 3private BloomFilter\u0026lt;Long\u0026gt; orderBloomFilter; 4 5public Order getOrder(Long orderId) { 6 // å…ˆæ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨ 7 if (!orderBloomFilter.mightContain(orderId)) { 8 return null; // è®¢å•ä¸å­˜åœ¨ 9 } 10 11 // æŸ¥è¯¢ç¼“å­˜ 12 Order order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 13 if (order == null) { 14 // ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿ 15 String lockKey = \u0026#34;lock:order:\u0026#34; + orderId; 16 if (redisTemplate.opsForValue().setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS)) { 17 try { 18 // å†æ¬¡æ£€æŸ¥ç¼“å­˜ 19 order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 20 if (order == null) { 21 // æŸ¥è¯¢æ•°æ®åº“ 22 order = orderMapper.selectById(orderId); 23 if (order != null) { 24 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, order, 30, TimeUnit.MINUTES); 25 } else { 26 // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç©¿é€ 27 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, new Order(), 5, TimeUnit.MINUTES); 28 } 29 } 30 } finally { 31 redisTemplate.delete(lockKey); 32 } 33 } 34 } 35 return order; 36} æ¡ˆä¾‹ä¸‰ï¼šçº¿ç¨‹æ± æ»¡ é—®é¢˜ï¼šçº¿ç¨‹æ± é˜Ÿåˆ—æ»¡ï¼Œè¯·æ±‚è¢«æ‹’ç»\nåˆ†æï¼š\n1// åŸé…ç½® 2@Bean 3public ThreadPoolExecutor executor() { 4 return new ThreadPoolExecutor( 5 10, // æ ¸å¿ƒçº¿ç¨‹æ•° 6 20, // æœ€å¤§çº¿ç¨‹æ•° 7 60L, TimeUnit.SECONDS, 8 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), // é˜Ÿåˆ—å®¹é‡ 100 9 new ThreadPoolExecutor.AbortPolicy() // æ‹’ç»ç­–ç•¥ï¼šæŠ›å¼‚å¸¸ 10 ); 11} ä¼˜åŒ–ï¼š\n1@Bean 2public ThreadPoolExecutor executor() { 3 return new ThreadPoolExecutor( 4 50, // å¢åŠ æ ¸å¿ƒçº¿ç¨‹æ•° 5 100, // å¢åŠ æœ€å¤§çº¿ç¨‹æ•° 6 60L, TimeUnit.SECONDS, 7 new LinkedBlockingQueue\u0026lt;\u0026gt;(1000), // å¢åŠ é˜Ÿåˆ—å®¹é‡ 8 new ThreadFactoryBuilder() 9 .setNameFormat(\u0026#34;business-thread-%d\u0026#34;) 10 .build(), 11 new ThreadPoolExecutor.CallerRunsPolicy() // æ”¹ä¸ºè°ƒç”¨è€…è¿è¡Œç­–ç•¥ 12 ); 13} 14 15// æ·»åŠ ç›‘æ§ 16@Scheduled(fixedRate = 5000) 17public void monitorThreadPool() { 18 ThreadPoolExecutor executor = (ThreadPoolExecutor) this.executor; 19 log.info(\u0026#34;çº¿ç¨‹æ± çŠ¶æ€ - æ´»è·ƒçº¿ç¨‹ï¼š{}ï¼Œé˜Ÿåˆ—å¤§å°ï¼š{}ï¼Œå®Œæˆä»»åŠ¡ï¼š{}\u0026#34;, 20 executor.getActiveCount(), 21 executor.getQueue().size(), 22 executor.getCompletedTaskCount()); 23} å‹æµ‹æµç¨‹ 1. å‡†å¤‡é˜¶æ®µ ç¡®å®šå‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡† å‡†å¤‡å‹æµ‹ç¯å¢ƒå’Œæ•°æ® é…ç½®æµé‡æ ‡è®°å’Œæ•°æ®éš”ç¦» ç¼–å†™å‹æµ‹è„šæœ¬ æ­å»ºç›‘æ§ç³»ç»Ÿ 2. é¢„æ¼”é˜¶æ®µ å°æµé‡å‹æµ‹ï¼ˆ10% ç›®æ ‡æµé‡ï¼‰ éªŒè¯æ•°æ®éš”ç¦»æ˜¯å¦ç”Ÿæ•ˆ æ£€æŸ¥ç›‘æ§æŒ‡æ ‡æ˜¯å¦æ­£å¸¸ ç¡®è®¤æ— çœŸå®ç”¨æˆ·å½±å“ 3. æ­£å¼å‹æµ‹ é€æ­¥å¢åŠ å‹åŠ›ï¼ˆæ¢¯åº¦å‹æµ‹ï¼‰ å®æ—¶ç›‘æ§ç³»ç»ŸæŒ‡æ ‡ è®°å½•æ€§èƒ½ç“¶é¢ˆ è¾¾åˆ°ç›®æ ‡åæŒç»­ 10-30 åˆ†é’Ÿ 4. åˆ†æé˜¶æ®µ æ±‡æ€»å‹æµ‹æ•°æ® åˆ†ææ€§èƒ½ç“¶é¢ˆ åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ è¯„ä¼°å®¹é‡è§„åˆ’ 5. ä¼˜åŒ–é˜¶æ®µ å®æ–½ä¼˜åŒ–æ–¹æ¡ˆ å›å½’å‹æµ‹éªŒè¯ æŒç»­è¿­ä»£ä¼˜åŒ– æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼š\nå‹æµ‹ä»·å€¼ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ç³»ç»ŸçœŸå®æ‰¿è½½èƒ½åŠ› æ–¹æ¡ˆè®¾è®¡ï¼šç›®æ ‡è®¾å®šã€æµé‡æ¨¡å‹ã€æ•°æ®éš”ç¦» æµé‡æ ‡è®°ï¼šè¯·æ±‚æ ‡è®°ã€æ•°æ®è·¯ç”±ã€è¡¨ååˆ‡æ¢ å·¥å…·é€‰å‹ï¼šJMeterã€Gatlingã€é˜¿é‡Œäº‘ PTS ç›‘æ§åˆ†æï¼šåº”ç”¨ç›‘æ§ã€ç³»ç»Ÿç›‘æ§ã€æ•°æ®åº“ç›‘æ§ æ€§èƒ½ä¼˜åŒ–ï¼šæ…¢æŸ¥è¯¢ã€ç¼“å­˜ç©¿é€ã€çº¿ç¨‹æ±  å‹æµ‹æµç¨‹ï¼šå‡†å¤‡ã€é¢„æ¼”ã€æ­£å¼ã€åˆ†æã€ä¼˜åŒ– åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå…¨é“¾è·¯å‹æµ‹æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦ï¼š\nå®šæœŸå‹æµ‹ï¼šæ¯æ¬¡å¤§ä¿ƒå‰ã€é‡å¤§åŠŸèƒ½ä¸Šçº¿å‰ æŒç»­ä¼˜åŒ–ï¼šæ ¹æ®å‹æµ‹ç»“æœä¸æ–­ä¼˜åŒ– å®¹é‡è§„åˆ’ï¼šä¸ºä¸šåŠ¡å¢é•¿é¢„ç•™èµ„æº åº”æ€¥é¢„æ¡ˆï¼šåˆ¶å®šé™çº§ã€é™æµã€ç†”æ–­ç­–ç•¥ ä¸‹æ¬¡å½“ä½ éœ€è¦éªŒè¯ç³»ç»Ÿæ‰¿è½½èƒ½åŠ›æ—¶ï¼Œä¸å¦¨è¯•è¯•å…¨é“¾è·¯å‹æµ‹è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ã€‚\n","permalink":"http://localhost:1313/posts/2025/09/%E5%85%A8%E9%93%BE%E8%B7%AF%E5%8E%8B%E6%B5%8B%E5%A6%82%E4%BD%95%E9%AA%8C%E8%AF%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%9C%9F%E5%AE%9E%E6%89%BF%E8%BD%BD%E8%83%BD%E5%8A%9B/","summary":"\u003cp\u003eåœ¨å¤§ä¿ƒã€ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œç³»ç»Ÿèƒ½å¦æ‰›ä½æµé‡å†²å‡»æ˜¯æ¯ä¸ªæŠ€æœ¯å›¢é˜Ÿæœ€å…³å¿ƒçš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„å•æ¥å£å‹æµ‹æ— æ³•çœŸå®åæ˜ ç³»ç»Ÿçš„æ•´ä½“æ‰¿è½½èƒ½åŠ›ï¼Œè€Œå…¨é“¾è·¯å‹æµ‹é€šè¿‡æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºï¼Œå¯ä»¥å…¨é¢éªŒè¯ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†æ·±å…¥è®²è§£å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºå®Œæ•´çš„å‹æµ‹ä½“ç³»ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å…¨é“¾è·¯å‹æµ‹çš„æ ¸å¿ƒä»·å€¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å‹æµ‹ç¯å¢ƒçš„æ­å»ºæ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šæ•°æ®éš”ç¦»ä¸æµé‡æ ‡è®°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å‹æµ‹å·¥å…·çš„é€‰å‹ä¸ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ€§èƒ½ç“¶é¢ˆçš„åˆ†æä¸ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹\"\u003eä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹\u003c/h2\u003e\n\u003ch3 id=\"ä¼ ç»Ÿå‹æµ‹-vs-å…¨é“¾è·¯å‹æµ‹\"\u003eä¼ ç»Ÿå‹æµ‹ vs å…¨é“¾è·¯å‹æµ‹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿå‹æµ‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé’ˆå¯¹å•ä¸ªæ¥å£æˆ–æœåŠ¡è¿›è¡Œå‹æµ‹\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨æµ‹è¯•ç¯å¢ƒæˆ–é¢„å‘å¸ƒç¯å¢ƒ\u003c/li\u003e\n\u003cli\u003eæ•°æ®é‡å°ï¼Œæ— æ³•åæ˜ çœŸå®æƒ…å†µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå…¨é“¾è·¯å‹æµ‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå‹æµ‹\u003c/li\u003e\n\u003cli\u003eæ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„å®Œæ•´ä¸šåŠ¡æµç¨‹\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨çœŸå®çš„æ•°æ®é‡å’Œç³»ç»Ÿé…ç½®\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"å…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼\"\u003eå…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eçœŸå®æ€§\u003c/strong\u003eï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œç»“æœæœ€å¯ä¿¡\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå…¨é¢æ€§\u003c/strong\u003eï¼šè¦†ç›–æ‰€æœ‰ç³»ç»Ÿç»„ä»¶å’Œä¾èµ–\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåŠæ—¶æ€§\u003c/strong\u003eï¼šæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæŒ‡å¯¼æ€§\u003c/strong\u003eï¼šä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æŒ\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"å‹æµ‹åœºæ™¯\"\u003eå‹æµ‹åœºæ™¯\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eç”¨æˆ·è®¿é—® â†’ ç½‘å…³ â†’ åº”ç”¨æœåŠ¡ â†’ ç¼“å­˜ â†’ æ•°æ®åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e                â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e            æ¶ˆæ¯é˜Ÿåˆ— â†’ å¼‚æ­¥æœåŠ¡\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e                â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e            ç¬¬ä¸‰æ–¹æœåŠ¡\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e å…¨é“¾è·¯å‹æµ‹ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯ä¸šåŠ¡é—®é¢˜ã€‚éœ€è¦äº§å“ã€è¿è¥ã€æŠ€æœ¯å›¢é˜Ÿå…±åŒå‚ä¸ï¼Œåˆ¶å®šåˆç†çš„å‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡†ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"å‹æµ‹æ–¹æ¡ˆè®¾è®¡\"\u003eå‹æµ‹æ–¹æ¡ˆè®¾è®¡\u003c/h2\u003e\n\u003ch3 id=\"1-å‹æµ‹ç›®æ ‡è®¾å®š\"\u003e1. å‹æµ‹ç›®æ ‡è®¾å®š\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæ€§èƒ½æŒ‡æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eTPS/QPS\u003c/strong\u003eï¼šæ¯ç§’äº‹åŠ¡æ•°/æŸ¥è¯¢æ•°\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå“åº”æ—¶é—´\u003c/strong\u003eï¼šP50ã€P95ã€P99\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæˆåŠŸç‡\u003c/strong\u003eï¼šè¯·æ±‚æˆåŠŸçš„æ¯”ä¾‹\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eèµ„æºä½¿ç”¨ç‡\u003c/strong\u003eï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡æŒ‡æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eè®¢å•åˆ›å»ºæˆåŠŸç‡\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ”¯ä»˜æˆåŠŸç‡\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåº“å­˜æ‰£å‡å‡†ç¡®æ€§\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eç¤ºä¾‹ç›®æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå¤§ä¿ƒåœºæ™¯ï¼š\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e- å³°å€¼ TPSï¼š10000\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e- P99 å“åº”æ—¶é—´ï¼š\u0026lt; 500ms\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e- æˆåŠŸç‡ï¼š\u0026gt; 99.9%\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e- CPU ä½¿ç”¨ç‡ï¼š\u0026lt; 70%\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"2-å‹æµ‹æµé‡æ¨¡å‹\"\u003e2. å‹æµ‹æµé‡æ¨¡å‹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæµé‡ç‰¹å¾\u003c/strong\u003eï¼š\u003c/p\u003e","title":"å…¨é“¾è·¯å‹æµ‹ï¼šå¦‚ä½•éªŒè¯ç³»ç»Ÿçš„çœŸå®æ‰¿è½½èƒ½åŠ›"},{"content":"Git å·²ç»æˆä¸ºç°ä»£è½¯ä»¶å¼€å‘çš„æ ‡å‡†ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚ç„¶è€Œï¼Œä»…ä»…ä¼šç”¨ Git å‘½ä»¤æ˜¯ä¸å¤Ÿçš„ï¼Œå¦‚ä½•åœ¨å›¢é˜Ÿä¸­å»ºç«‹é«˜æ•ˆçš„ Git å·¥ä½œæµï¼Œæ‰æ˜¯æå‡å¼€å‘æ•ˆç‡çš„å…³é”®ã€‚\næœ¬æ–‡å°†ä»å®é™…å›¢é˜Ÿåä½œå‡ºå‘ï¼Œæ·±å…¥è®²è§£ Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ å’Œå›¢é˜Ÿå»ºç«‹è§„èŒƒã€é«˜æ•ˆçš„å¼€å‘æµç¨‹ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ä¸»æµ Git å·¥ä½œæµæ¨¡å‹ æŒæ¡åˆ†æ”¯ç®¡ç†çš„æœ€ä½³å®è·µ å­¦ä¼šè§„èŒƒçš„æäº¤ä¿¡æ¯ç¼–å†™ äº†è§£ä»£ç å®¡æŸ¥çš„æµç¨‹ä¸æŠ€å·§ æŒæ¡å†²çªè§£å†³ä¸å›æ»šç­–ç•¥ ä¸»æµ Git å·¥ä½œæµæ¨¡å‹ 1. Git Flow æœ€ç»å…¸çš„åˆ†æ”¯æ¨¡å‹ï¼Œé€‚åˆç‰ˆæœ¬å‘å¸ƒå‘¨æœŸè¾ƒé•¿çš„é¡¹ç›®ï¼š\n1master (ç”Ÿäº§ç¯å¢ƒ) 2 â†“ 3develop (å¼€å‘ç¯å¢ƒ) 4 â†“ 5feature/* (åŠŸèƒ½åˆ†æ”¯) 6release/* (å‘å¸ƒåˆ†æ”¯) 7hotfix/* (çƒ­ä¿®å¤åˆ†æ”¯) åˆ†æ”¯è¯´æ˜ï¼š\nmasterï¼šç”Ÿäº§ç¯å¢ƒä»£ç ï¼Œæ¯ä¸ªæäº¤éƒ½æ˜¯ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬ developï¼šå¼€å‘ç¯å¢ƒä»£ç ï¼Œé›†æˆæ‰€æœ‰åŠŸèƒ½ feature/*ï¼šåŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œå®Œæˆååˆå¹¶å› develop release/*ï¼šå‘å¸ƒå‡†å¤‡åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œæµ‹è¯•é€šè¿‡ååˆå¹¶åˆ° master å’Œ develop hotfix/*ï¼šç´§æ€¥ä¿®å¤åˆ†æ”¯ï¼Œä» master åˆ†å‡ºï¼Œä¿®å¤ååˆå¹¶åˆ° master å’Œ develop å·¥ä½œæµç¨‹ï¼š\n1# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ 2git checkout -b feature/user-login develop 3 4# 2. å¼€å‘åŠŸèƒ½ 5git add . 6git commit -m \u0026#34;feat: å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34; 7 8# 3. åˆå¹¶åˆ° develop 9git checkout develop 10git merge --no-ff feature/user-login 11git branch -d feature/user-login 12 13# 4. åˆ›å»ºå‘å¸ƒåˆ†æ”¯ 14git checkout -b release/1.0.0 develop 15 16# 5. å‘å¸ƒåˆ°ç”Ÿäº§ 17git checkout master 18git merge --no-ff release/1.0.0 19git tag -a v1.0.0 -m \u0026#34;Release version 1.0.0\u0026#34; 20 21# 6. åˆå¹¶å› develop 22git checkout develop 23git merge --no-ff release/1.0.0 24git branch -d release/1.0.0 2. GitHub Flow ç®€åŒ–ç‰ˆå·¥ä½œæµï¼Œé€‚åˆæŒç»­éƒ¨ç½²çš„é¡¹ç›®ï¼š\n1master (ç”Ÿäº§ç¯å¢ƒ) 2 â†“ 3feature/* (åŠŸèƒ½åˆ†æ”¯) å·¥ä½œæµç¨‹ï¼š\n1# 1. ä» master åˆ›å»ºåˆ†æ”¯ 2git checkout -b feature/add-payment master 3 4# 2. å¼€å‘å¹¶æäº¤ 5git add . 6git commit -m \u0026#34;feat: æ·»åŠ æ”¯ä»˜åŠŸèƒ½\u0026#34; 7 8# 3. æ¨é€åˆ°è¿œç¨‹ 9git push origin feature/add-payment 10 11# 4. åˆ›å»º Pull Request 12# åœ¨ GitHub ä¸Šåˆ›å»º PRï¼Œè¿›è¡Œä»£ç å®¡æŸ¥ 13 14# 5. åˆå¹¶åˆ° master 15# å®¡æŸ¥é€šè¿‡åï¼Œåœ¨ GitHub ä¸Šåˆå¹¶ PR 16 17# 6. éƒ¨ç½²åˆ°ç”Ÿäº§ 18# CI/CD è‡ªåŠ¨éƒ¨ç½² 3. GitLab Flow ç»“åˆäº† Git Flow å’Œ GitHub Flow çš„ä¼˜ç‚¹ï¼š\n1master (å¼€å‘ç¯å¢ƒ) 2 â†“ 3pre-production (é¢„å‘å¸ƒç¯å¢ƒ) 4 â†“ 5production (ç”Ÿäº§ç¯å¢ƒ) ç‰¹ç‚¹ï¼š\nä»¥ç¯å¢ƒä¸ºå¯¼å‘çš„åˆ†æ”¯ç­–ç•¥ ä»£ç ä»ä¸Šæ¸¸ç¯å¢ƒæµå‘ä¸‹æ¸¸ç¯å¢ƒ é€‚åˆå¤šç¯å¢ƒéƒ¨ç½²çš„é¡¹ç›® å·¥ä½œæµå¯¹æ¯” å·¥ä½œæµ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ ä¼˜ç‚¹ ç¼ºç‚¹ Git Flow é«˜ ç‰ˆæœ¬å‘å¸ƒå‘¨æœŸé•¿ æµç¨‹æ¸…æ™°ï¼Œé€‚åˆå¤§å›¢é˜Ÿ åˆ†æ”¯å¤šï¼Œæ“ä½œå¤æ‚ GitHub Flow ä½ æŒç»­éƒ¨ç½² ç®€å•ï¼Œå¿«é€Ÿè¿­ä»£ ä¸é€‚åˆå¤šç‰ˆæœ¬ç»´æŠ¤ GitLab Flow ä¸­ å¤šç¯å¢ƒéƒ¨ç½² çµæ´»ï¼Œç¯å¢ƒéš”ç¦» éœ€è¦ CI/CD æ”¯æŒ æ¶æ„æ€è€ƒï¼š é€‰æ‹©å·¥ä½œæµæ—¶ï¼Œè¦è€ƒè™‘å›¢é˜Ÿè§„æ¨¡ã€å‘å¸ƒé¢‘ç‡ã€ç¯å¢ƒæ•°é‡ç­‰å› ç´ ã€‚å°å›¢é˜Ÿæˆ–å¿«é€Ÿè¿­ä»£çš„é¡¹ç›®ï¼Œæ¨è GitHub Flowï¼›å¤§å›¢é˜Ÿæˆ–éœ€è¦å¤šç‰ˆæœ¬ç»´æŠ¤çš„é¡¹ç›®ï¼Œæ¨è Git Flowã€‚\nåˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ åˆ†æ”¯å‘½åè§„èŒƒ 1# åŠŸèƒ½åˆ†æ”¯ 2feature/user-authentication 3feature/payment-integration 4 5# ä¿®å¤åˆ†æ”¯ 6bugfix/login-error 7bugfix/payment-timeout 8 9# çƒ­ä¿®å¤åˆ†æ”¯ 10hotfix/critical-security-issue 11 12# å‘å¸ƒåˆ†æ”¯ 13release/v1.2.0 14 15# æ–‡æ¡£åˆ†æ”¯ 16docs/api-documentation åˆ†æ”¯ä¿æŠ¤è§„åˆ™ åœ¨ GitHub/GitLab ä¸­è®¾ç½®åˆ†æ”¯ä¿æŠ¤ï¼š\nç¦æ­¢ç›´æ¥æ¨é€åˆ° master/main è¦æ±‚ Pull Request å®¡æŸ¥ï¼šè‡³å°‘ 1-2 äººå®¡æŸ¥ è¦æ±‚çŠ¶æ€æ£€æŸ¥é€šè¿‡ï¼šCI/CD æ„å»ºæˆåŠŸ è¦æ±‚åˆ†æ”¯æ˜¯æœ€æ–°çš„ï¼šåˆå¹¶å‰å¿…é¡» rebase è¦æ±‚ç­¾åæäº¤ï¼šä½¿ç”¨ GPG ç­¾å åˆ†æ”¯æ¸…ç† 1# æŸ¥çœ‹å·²åˆå¹¶çš„åˆ†æ”¯ 2git branch --merged 3 4# åˆ é™¤å·²åˆå¹¶çš„æœ¬åœ°åˆ†æ”¯ 5git branch -d feature/user-login 6 7# åˆ é™¤è¿œç¨‹åˆ†æ”¯ 8git push origin --delete feature/user-login 9 10# æ‰¹é‡åˆ é™¤å·²åˆå¹¶çš„æœ¬åœ°åˆ†æ”¯ 11git branch --merged | grep -v \u0026#34;\\*\u0026#34; | grep -v \u0026#34;master\u0026#34; | grep -v \u0026#34;develop\u0026#34; | xargs -n 1 git branch -d æäº¤ä¿¡æ¯è§„èŒƒ Conventional Commits éµå¾ªçº¦å®šå¼æäº¤è§„èŒƒï¼š\n1\u0026lt;type\u0026gt;(\u0026lt;scope\u0026gt;): \u0026lt;subject\u0026gt; 2 3\u0026lt;body\u0026gt; 4 5\u0026lt;footer\u0026gt; Type ç±»å‹ï¼š\nfeatï¼šæ–°åŠŸèƒ½ fixï¼šä¿®å¤ Bug docsï¼šæ–‡æ¡£å˜æ›´ styleï¼šä»£ç æ ¼å¼ï¼ˆä¸å½±å“ä»£ç è¿è¡Œï¼‰ refactorï¼šé‡æ„ï¼ˆæ—¢ä¸æ˜¯æ–°åŠŸèƒ½ä¹Ÿä¸æ˜¯ä¿®å¤ï¼‰ perfï¼šæ€§èƒ½ä¼˜åŒ– testï¼šæµ‹è¯•ç›¸å…³ choreï¼šæ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨ ç¤ºä¾‹ï¼š\n1# æ–°åŠŸèƒ½ 2git commit -m \u0026#34;feat(auth): æ·»åŠ  JWT è®¤è¯åŠŸèƒ½\u0026#34; 3 4# ä¿®å¤ Bug 5git commit -m \u0026#34;fix(payment): ä¿®å¤æ”¯ä»˜é‡‘é¢è®¡ç®—é”™è¯¯ 6 7æ”¯ä»˜é‡‘é¢åœ¨è®¡ç®—æŠ˜æ‰£æ—¶å‡ºç°ç²¾åº¦é—®é¢˜ï¼Œå¯¼è‡´å®é™…æ”¯ä»˜é‡‘é¢ä¸æ­£ç¡®ã€‚ 8æœ¬æ¬¡ä¿®å¤ä½¿ç”¨ BigDecimal è¿›è¡Œç²¾ç¡®è®¡ç®—ã€‚ 9 10Closes #123\u0026#34; 11 12# ç ´åæ€§å˜æ›´ 13git commit -m \u0026#34;feat(api): é‡æ„ç”¨æˆ· API æ¥å£ 14 15BREAKING CHANGE: ç”¨æˆ· API æ¥å£è·¯å¾„ä» /api/user æ”¹ä¸º /api/v2/users\u0026#34; æäº¤æœ€ä½³å®è·µ åŸå­æ€§æäº¤ï¼šæ¯æ¬¡æäº¤åªåšä¸€ä»¶äº‹ æœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯ï¼šæ¸…æ¥šæè¿°åšäº†ä»€ä¹ˆå’Œä¸ºä»€ä¹ˆ é¢‘ç¹æäº¤ï¼šå°æ­¥å¿«è·‘ï¼Œä¾¿äºå›æ»š æäº¤å‰æ£€æŸ¥ï¼šä½¿ç”¨ git diff æ£€æŸ¥å˜æ›´ 1# æŸ¥çœ‹æš‚å­˜åŒºçš„å˜æ›´ 2git diff --staged 3 4# äº¤äº’å¼æš‚å­˜ 5git add -p 6 7# ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤ 8git commit --amend 9 10# ä¿®æ”¹æäº¤ä¿¡æ¯ 11git commit --amend -m \u0026#34;æ–°çš„æäº¤ä¿¡æ¯\u0026#34; ä½¿ç”¨ Commitizen è‡ªåŠ¨ç”Ÿæˆè§„èŒƒçš„æäº¤ä¿¡æ¯ï¼š\n1# å®‰è£… 2npm install -g commitizen cz-conventional-changelog 3 4# åˆå§‹åŒ– 5commitizen init cz-conventional-changelog --save-dev --save-exact 6 7# ä½¿ç”¨ 8git cz ä»£ç å®¡æŸ¥æµç¨‹ Pull Request æ¨¡æ¿ åˆ›å»º .github/pull_request_template.mdï¼š\n1## å˜æ›´è¯´æ˜ 2\u0026lt;!-- ç®€è¦æè¿°æœ¬æ¬¡å˜æ›´çš„å†…å®¹ --\u0026gt; 3 4## å˜æ›´ç±»å‹ 5- [ ] æ–°åŠŸèƒ½ 6- [ ] Bug ä¿®å¤ 7- [ ] é‡æ„ 8- [ ] æ–‡æ¡£æ›´æ–° 9- [ ] æ€§èƒ½ä¼˜åŒ– 10 11## ç›¸å…³ Issue 12\u0026lt;!-- å…³è”çš„ Issue ç¼–å·ï¼Œå¦‚ #123 --\u0026gt; 13 14## æµ‹è¯•è¯´æ˜ 15\u0026lt;!-- å¦‚ä½•æµ‹è¯•æœ¬æ¬¡å˜æ›´ --\u0026gt; 16 17## æˆªå›¾ï¼ˆå¦‚æœé€‚ç”¨ï¼‰ 18\u0026lt;!-- æ·»åŠ æˆªå›¾è¯´æ˜å˜æ›´æ•ˆæœ --\u0026gt; 19 20## æ£€æŸ¥æ¸…å• 21- [ ] ä»£ç éµå¾ªé¡¹ç›®è§„èŒƒ 22- [ ] å·²æ·»åŠ å¿…è¦çš„æµ‹è¯• 23- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ 24- [ ] å·²æ›´æ–°ç›¸å…³æ–‡æ¡£ 25- [ ] æ— æ–°å¢çš„ lint è­¦å‘Š ä»£ç å®¡æŸ¥è¦ç‚¹ åŠŸèƒ½æ€§ï¼š\nä»£ç æ˜¯å¦å®ç°äº†é¢„æœŸåŠŸèƒ½ æ˜¯å¦æœ‰é—æ¼çš„è¾¹ç•Œæƒ…å†µ é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„ å¯è¯»æ€§ï¼š\nå‘½åæ˜¯å¦æ¸…æ™° é€»è¾‘æ˜¯å¦æ˜“æ‡‚ æ˜¯å¦æœ‰å¿…è¦çš„æ³¨é‡Š æ€§èƒ½ï¼š\næ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜ æ•°æ®åº“æŸ¥è¯¢æ˜¯å¦ä¼˜åŒ– æ˜¯å¦æœ‰å†…å­˜æ³„æ¼é£é™© å®‰å…¨æ€§ï¼š\næ˜¯å¦æœ‰å®‰å…¨æ¼æ´ è¾“å…¥éªŒè¯æ˜¯å¦å……åˆ† æ•æ„Ÿä¿¡æ¯æ˜¯å¦æ³„éœ² å¯ç»´æŠ¤æ€§ï¼š\nä»£ç æ˜¯å¦ç¬¦åˆ SOLID åŸåˆ™ æ˜¯å¦æœ‰é‡å¤ä»£ç  æ˜¯å¦æ˜“äºæµ‹è¯• å®¡æŸ¥åé¦ˆæŠ€å·§ å¥½çš„åé¦ˆï¼š\n1å»ºè®®ï¼šè¿™é‡Œå¯ä»¥ä½¿ç”¨ Stream API ç®€åŒ–ä»£ç ï¼Œæé«˜å¯è¯»æ€§ã€‚ 2 3Optional\u0026lt;User\u0026gt; user = users.stream() 4 .filter(u -\u0026gt; u.getId().equals(userId)) 5 .findFirst(); ä¸å¥½çš„åé¦ˆï¼š\n1è¿™æ®µä»£ç å†™å¾—å¤ªçƒ‚äº†ï¼Œé‡å†™å§ã€‚ åŸåˆ™ï¼š\nå¯¹äº‹ä¸å¯¹äºº æä¾›å…·ä½“å»ºè®® è§£é‡ŠåŸå›  ä¿æŒå‹å¥½ å†²çªè§£å†³ é¢„é˜²å†²çª é¢‘ç¹åŒæ­¥ï¼šå®šæœŸä»ä¸»åˆ†æ”¯æ‹‰å–æœ€æ–°ä»£ç  å°æ­¥æäº¤ï¼šå‡å°‘å•æ¬¡å˜æ›´çš„èŒƒå›´ æ¨¡å—åŒ–å¼€å‘ï¼šå‡å°‘å¤šäººä¿®æ”¹åŒä¸€æ–‡ä»¶ 1# å®šæœŸåŒæ­¥ä¸»åˆ†æ”¯ 2git checkout feature/my-feature 3git fetch origin 4git rebase origin/develop è§£å†³å†²çª 1# 1. æ‹‰å–æœ€æ–°ä»£ç  2git fetch origin 3 4# 2. Rebase åˆ°æœ€æ–°çš„ develop 5git rebase origin/develop 6 7# 3. å¦‚æœæœ‰å†²çªï¼ŒGit ä¼šæç¤º 8# æ‰‹åŠ¨è§£å†³å†²çªåï¼š 9git add \u0026lt;å†²çªæ–‡ä»¶\u0026gt; 10git rebase --continue 11 12# 4. å¦‚æœæƒ³æ”¾å¼ƒ rebase 13git rebase --abort Merge vs Rebase Mergeï¼š\n1git checkout develop 2git merge feature/my-feature ä¼˜ç‚¹ï¼šä¿ç•™å®Œæ•´çš„å†å²è®°å½• ç¼ºç‚¹ï¼šäº§ç”Ÿé¢å¤–çš„åˆå¹¶æäº¤ï¼Œå†å²è®°å½•å¤æ‚\nRebaseï¼š\n1git checkout feature/my-feature 2git rebase develop ä¼˜ç‚¹ï¼šä¿æŒçº¿æ€§çš„å†å²è®°å½•ï¼Œæ›´æ¸…æ™° ç¼ºç‚¹ï¼šæ”¹å†™å†å²ï¼Œä¸é€‚åˆå·²æ¨é€çš„åˆ†æ”¯\næ¨èç­–ç•¥ï¼š\nåŠŸèƒ½åˆ†æ”¯å¼€å‘æ—¶ä½¿ç”¨ rebase ä¿æŒåŒæ­¥ åˆå¹¶åˆ°ä¸»åˆ†æ”¯æ—¶ä½¿ç”¨ merge ä¿ç•™å†å² é¿å‘æç¤ºï¼š æ°¸è¿œä¸è¦ rebase å·²ç»æ¨é€åˆ°è¿œç¨‹çš„å…¬å…±åˆ†æ”¯ï¼è¿™ä¼šå¯¼è‡´å…¶ä»–äººçš„å†å²è®°å½•æ··ä¹±ã€‚åªåœ¨æœ¬åœ°åˆ†æ”¯æˆ–ä¸ªäººåˆ†æ”¯ä¸Šä½¿ç”¨ rebaseã€‚\nå›æ»šç­–ç•¥ æ’¤é”€æœ¬åœ°ä¿®æ”¹ 1# æ’¤é”€å·¥ä½œåŒºçš„ä¿®æ”¹ 2git checkout -- \u0026lt;file\u0026gt; 3 4# æ’¤é”€æš‚å­˜åŒºçš„ä¿®æ”¹ 5git reset HEAD \u0026lt;file\u0026gt; 6 7# æ’¤é”€æœ€åä¸€æ¬¡æäº¤ï¼ˆä¿ç•™ä¿®æ”¹ï¼‰ 8git reset --soft HEAD^ 9 10# æ’¤é”€æœ€åä¸€æ¬¡æäº¤ï¼ˆä¸¢å¼ƒä¿®æ”¹ï¼‰ 11git reset --hard HEAD^ æ’¤é”€å·²æ¨é€çš„æäº¤ 1# æ–¹æ³• 1ï¼šRevertï¼ˆæ¨èï¼‰ 2# åˆ›å»ºä¸€ä¸ªæ–°æäº¤æ¥æ’¤é”€ä¹‹å‰çš„æäº¤ 3git revert \u0026lt;commit-hash\u0026gt; 4git push origin master 5 6# æ–¹æ³• 2ï¼šReset + Force Pushï¼ˆå±é™©ï¼‰ 7# åªåœ¨ä¸ªäººåˆ†æ”¯æˆ–ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨ 8git reset --hard \u0026lt;commit-hash\u0026gt; 9git push origin master --force æ¢å¤å·²åˆ é™¤çš„åˆ†æ”¯ 1# æŸ¥çœ‹æ‰€æœ‰æ“ä½œè®°å½• 2git reflog 3 4# æ¢å¤åˆ†æ”¯ 5git checkout -b \u0026lt;branch-name\u0026gt; \u0026lt;commit-hash\u0026gt; ç´§æ€¥å›æ»šç”Ÿäº§ç¯å¢ƒ 1# 1. åˆ›å»º hotfix åˆ†æ”¯ 2git checkout -b hotfix/rollback-v1.2.0 master 3 4# 2. å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ 5git revert \u0026lt;bad-commit-hash\u0026gt; 6 7# 3. æ¨é€å¹¶éƒ¨ç½² 8git push origin hotfix/rollback-v1.2.0 9 10# 4. åˆå¹¶åˆ° master 11git checkout master 12git merge hotfix/rollback-v1.2.0 13git tag -a v1.2.1 -m \u0026#34;Rollback to stable version\u0026#34; 14git push origin master --tags Git Hooks è‡ªåŠ¨åŒ– Pre-commit Hook åœ¨æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ä»£ç ï¼š\n1# .git/hooks/pre-commit 2 3#!/bin/sh 4 5# è¿è¡Œ lint æ£€æŸ¥ 6npm run lint 7if [ $? -ne 0 ]; then 8 echo \u0026#34;Lint æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤\u0026#34; 9 exit 1 10fi 11 12# è¿è¡Œå•å…ƒæµ‹è¯• 13npm run test 14if [ $? -ne 0 ]; then 15 echo \u0026#34;å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤\u0026#34; 16 exit 1 17fi 18 19echo \u0026#34;æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸æäº¤\u0026#34; 20exit 0 Commit-msg Hook æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ï¼š\n1# .git/hooks/commit-msg 2 3#!/bin/sh 4 5commit_msg=$(cat $1) 6 7# æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ 8if ! echo \u0026#34;$commit_msg\u0026#34; | grep -qE \u0026#34;^(feat|fix|docs|style|refactor|perf|test|chore)(\\(.+\\))?: .{1,50}\u0026#34;; then 9 echo \u0026#34;é”™è¯¯ï¼šæäº¤ä¿¡æ¯ä¸ç¬¦åˆè§„èŒƒ\u0026#34; 10 echo \u0026#34;æ ¼å¼ï¼š\u0026lt;type\u0026gt;(\u0026lt;scope\u0026gt;): \u0026lt;subject\u0026gt;\u0026#34; 11 echo \u0026#34;ç¤ºä¾‹ï¼šfeat(auth): æ·»åŠ ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34; 12 exit 1 13fi 14 15exit 0 ä½¿ç”¨ Husky æ›´æ–¹ä¾¿åœ°ç®¡ç† Git Hooksï¼š\n1# å®‰è£… 2npm install husky --save-dev 3 4# åˆå§‹åŒ– 5npx husky install 6 7# æ·»åŠ  pre-commit hook 8npx husky add .husky/pre-commit \u0026#34;npm run lint \u0026amp;\u0026amp; npm run test\u0026#34; 9 10# æ·»åŠ  commit-msg hook 11npx husky add .husky/commit-msg \u0026#39;npx --no -- commitlint --edit \u0026#34;$1\u0026#34;\u0026#39; å›¢é˜Ÿåä½œæŠ€å·§ 1. ä»£ç æ‰€æœ‰æƒ ä½¿ç”¨ CODEOWNERS æ–‡ä»¶ï¼š\n1# .github/CODEOWNERS 2 3# é»˜è®¤æ‰€æœ‰è€… 4* @team-lead 5 6# å‰ç«¯ä»£ç  7/frontend/** @frontend-team 8 9# åç«¯ä»£ç  10/backend/** @backend-team 11 12# æ•°æ®åº“è¿ç§» 13/migrations/** @dba-team @backend-lead 14 15# æ–‡æ¡£ 16/docs/** @tech-writer 2. Issue æ¨¡æ¿ åˆ›å»º .github/ISSUE_TEMPLATE/bug_report.mdï¼š\n1--- 2name: Bug æŠ¥å‘Š 3about: åˆ›å»º Bug æŠ¥å‘Šå¸®åŠ©æˆ‘ä»¬æ”¹è¿› 4title: \u0026#39;[BUG] \u0026#39; 5labels: bug 6assignees: \u0026#39;\u0026#39; 7--- 8 9## Bug æè¿° 10\u0026lt;!-- æ¸…æ™°ç®€æ´åœ°æè¿° Bug --\u0026gt; 11 12## å¤ç°æ­¥éª¤ 131. è®¿é—® \u0026#39;...\u0026#39; 142. ç‚¹å‡» \u0026#39;...\u0026#39; 153. æ»šåŠ¨åˆ° \u0026#39;...\u0026#39; 164. çœ‹åˆ°é”™è¯¯ 17 18## é¢„æœŸè¡Œä¸º 19\u0026lt;!-- æè¿°ä½ æœŸæœ›å‘ç”Ÿä»€ä¹ˆ --\u0026gt; 20 21## å®é™…è¡Œä¸º 22\u0026lt;!-- æè¿°å®é™…å‘ç”Ÿäº†ä»€ä¹ˆ --\u0026gt; 23 24## æˆªå›¾ 25\u0026lt;!-- å¦‚æœé€‚ç”¨ï¼Œæ·»åŠ æˆªå›¾ --\u0026gt; 26 27## ç¯å¢ƒä¿¡æ¯ 28- OS: [e.g. macOS 12.0] 29- Browser: [e.g. Chrome 96] 30- Version: [e.g. 1.2.0] 3. å‘å¸ƒæµç¨‹ 1# 1. æ›´æ–°ç‰ˆæœ¬å· 2npm version patch # 1.0.0 -\u0026gt; 1.0.1 3npm version minor # 1.0.0 -\u0026gt; 1.1.0 4npm version major # 1.0.0 -\u0026gt; 2.0.0 5 6# 2. ç”Ÿæˆ CHANGELOG 7npx conventional-changelog -p angular -i CHANGELOG.md -s 8 9# 3. æäº¤å¹¶æ‰“æ ‡ç­¾ 10git add . 11git commit -m \u0026#34;chore(release): v1.2.0\u0026#34; 12git tag -a v1.2.0 -m \u0026#34;Release version 1.2.0\u0026#34; 13 14# 4. æ¨é€ 15git push origin develop --tags æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº† Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œä»å·¥ä½œæµæ¨¡å‹åˆ°å›¢é˜Ÿåä½œï¼š\nå·¥ä½œæµæ¨¡å‹ï¼šGit Flowã€GitHub Flowã€GitLab Flow çš„é€‰æ‹© åˆ†æ”¯ç®¡ç†ï¼šå‘½åè§„èŒƒã€ä¿æŠ¤è§„åˆ™ã€æ¸…ç†ç­–ç•¥ æäº¤è§„èŒƒï¼šConventional Commitsã€åŸå­æ€§æäº¤ ä»£ç å®¡æŸ¥ï¼šPR æ¨¡æ¿ã€å®¡æŸ¥è¦ç‚¹ã€åé¦ˆæŠ€å·§ å†²çªè§£å†³ï¼šé¢„é˜²ç­–ç•¥ã€Merge vs Rebase å›æ»šç­–ç•¥ï¼šæœ¬åœ°æ’¤é”€ã€è¿œç¨‹å›æ»šã€ç´§æ€¥å¤„ç† è‡ªåŠ¨åŒ–ï¼šGit Hooksã€Husky å›¢é˜Ÿåä½œï¼šCODEOWNERSã€Issue æ¨¡æ¿ã€å‘å¸ƒæµç¨‹ åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒGit å·¥ä½œæµä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œéœ€è¦æ ¹æ®å›¢é˜Ÿè§„æ¨¡ã€é¡¹ç›®ç‰¹ç‚¹ã€å‘å¸ƒé¢‘ç‡ç­‰å› ç´ çµæ´»è°ƒæ•´ã€‚å…³é”®æ˜¯å»ºç«‹è§„èŒƒã€ä¿æŒä¸€è‡´ã€æŒç»­æ”¹è¿›ã€‚\nä¸‹æ¬¡å½“ä½ åœ¨å›¢é˜Ÿä¸­æ¨å¹¿ Git æœ€ä½³å®è·µæ—¶ï¼Œä¸å¦¨ä»æœ¬æ–‡çš„å»ºè®®å¼€å§‹ï¼Œé€æ­¥å»ºç«‹é€‚åˆä½ ä»¬å›¢é˜Ÿçš„å·¥ä½œæµã€‚\n","permalink":"http://localhost:1313/posts/2025/07/git-%E5%B7%A5%E4%BD%9C%E6%B5%81%E4%BB%8E%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86%E5%88%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/","summary":"\u003cp\u003eGit å·²ç»æˆä¸ºç°ä»£è½¯ä»¶å¼€å‘çš„æ ‡å‡†ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚ç„¶è€Œï¼Œä»…ä»…ä¼šç”¨ Git å‘½ä»¤æ˜¯ä¸å¤Ÿçš„ï¼Œå¦‚ä½•åœ¨å›¢é˜Ÿä¸­å»ºç«‹é«˜æ•ˆçš„ Git å·¥ä½œæµï¼Œæ‰æ˜¯æå‡å¼€å‘æ•ˆç‡çš„å…³é”®ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…å›¢é˜Ÿåä½œå‡ºå‘ï¼Œæ·±å…¥è®²è§£ Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ å’Œå›¢é˜Ÿå»ºç«‹è§„èŒƒã€é«˜æ•ˆçš„å¼€å‘æµç¨‹ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¸»æµ Git å·¥ä½œæµæ¨¡å‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡åˆ†æ”¯ç®¡ç†çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§„èŒƒçš„æäº¤ä¿¡æ¯ç¼–å†™\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ä»£ç å®¡æŸ¥çš„æµç¨‹ä¸æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å†²çªè§£å†³ä¸å›æ»šç­–ç•¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸»æµ-git-å·¥ä½œæµæ¨¡å‹\"\u003eä¸»æµ Git å·¥ä½œæµæ¨¡å‹\u003c/h2\u003e\n\u003ch3 id=\"1-git-flow\"\u003e1. Git Flow\u003c/h3\u003e\n\u003cp\u003eæœ€ç»å…¸çš„åˆ†æ”¯æ¨¡å‹ï¼Œé€‚åˆç‰ˆæœ¬å‘å¸ƒå‘¨æœŸè¾ƒé•¿çš„é¡¹ç›®ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003emaster (ç”Ÿäº§ç¯å¢ƒ)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003edevelop (å¼€å‘ç¯å¢ƒ)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003efeature/* (åŠŸèƒ½åˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003erelease/* (å‘å¸ƒåˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003ehotfix/* (çƒ­ä¿®å¤åˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ†æ”¯è¯´æ˜\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003emaster\u003c/code\u003eï¼šç”Ÿäº§ç¯å¢ƒä»£ç ï¼Œæ¯ä¸ªæäº¤éƒ½æ˜¯ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edevelop\u003c/code\u003eï¼šå¼€å‘ç¯å¢ƒä»£ç ï¼Œé›†æˆæ‰€æœ‰åŠŸèƒ½\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003efeature/*\u003c/code\u003eï¼šåŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œå®Œæˆååˆå¹¶å› develop\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003erelease/*\u003c/code\u003eï¼šå‘å¸ƒå‡†å¤‡åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œæµ‹è¯•é€šè¿‡ååˆå¹¶åˆ° master å’Œ develop\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ehotfix/*\u003c/code\u003eï¼šç´§æ€¥ä¿®å¤åˆ†æ”¯ï¼Œä» master åˆ†å‡ºï¼Œä¿®å¤ååˆå¹¶åˆ° master å’Œ develop\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå·¥ä½œæµç¨‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout -b feature/user-login develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. å¼€å‘åŠŸèƒ½\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003egit add .\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003egit commit -m \u003cspan class=\"s2\"\u003e\u0026#34;feat: å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 3. åˆå¹¶åˆ° develop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff feature/user-login\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003egit branch -d feature/user-login\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 4. åˆ›å»ºå‘å¸ƒåˆ†æ”¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout -b release/1.0.0 develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 5. å‘å¸ƒåˆ°ç”Ÿäº§\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout master\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003egit tag -a v1.0.0 -m \u003cspan class=\"s2\"\u003e\u0026#34;Release version 1.0.0\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 6. åˆå¹¶å› develop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003egit branch -d release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"2-github-flow\"\u003e2. GitHub Flow\u003c/h3\u003e\n\u003cp\u003eç®€åŒ–ç‰ˆå·¥ä½œæµï¼Œé€‚åˆæŒç»­éƒ¨ç½²çš„é¡¹ç›®ï¼š\u003c/p\u003e","title":"Git å·¥ä½œæµï¼šä»åˆ†æ”¯ç®¡ç†åˆ°ä»£ç å®¡æŸ¥çš„æœ€ä½³å®è·µ"},{"content":"Nginx ä½œä¸ºé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå·²ç»æˆä¸ºäº’è”ç½‘æ¶æ„ä¸­çš„æ ‡é…ç»„ä»¶ã€‚æ— è®ºæ˜¯é™æ€èµ„æºæœåŠ¡ã€åå‘ä»£ç†è¿˜æ˜¯è´Ÿè½½å‡è¡¡ï¼ŒNginx éƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚\næœ¬æ–‡å°†ä»å®é™…åœºæ™¯å‡ºå‘ï¼Œæ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œå¸®åŠ©ä½ æ„å»ºé«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åå‘ä»£ç†ä¸æ­£å‘ä»£ç†çš„åŒºåˆ« æŒæ¡ Nginx è´Ÿè½½å‡è¡¡çš„å¤šç§ç­–ç•¥ å­¦ä¼šé…ç½®å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» äº†è§£ä¼šè¯ä¿æŒçš„å®ç°æ–¹æ¡ˆ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§ åå‘ä»£ç†åŸºç¡€ æ­£å‘ä»£ç† vs åå‘ä»£ç† æ­£å‘ä»£ç†ï¼šå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®\n1å®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨ 2ï¼ˆå®¢æˆ·ç«¯é…ç½®ä»£ç†ï¼‰ åå‘ä»£ç†ï¼šå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å†³å®šè½¬å‘åˆ°å“ªå°æœåŠ¡å™¨\n1å®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨é›†ç¾¤ 2ï¼ˆæœåŠ¡ç«¯é…ç½®ä»£ç†ï¼‰ åå‘ä»£ç†çš„ä¼˜åŠ¿ è´Ÿè½½å‡è¡¡ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨ éšè—çœŸå®æœåŠ¡å™¨ï¼šæé«˜å®‰å…¨æ€§ SSL å¸è½½ï¼šåœ¨ä»£ç†å±‚å¤„ç† HTTPS ç¼“å­˜é™æ€èµ„æºï¼šå‡è½»åç«¯å‹åŠ› ç»Ÿä¸€å…¥å£ï¼šä¾¿äºç®¡ç†å’Œç›‘æ§ æ¶æ„æ€è€ƒï¼š åå‘ä»£ç†ä¸ä»…æ˜¯æµé‡åˆ†å‘å™¨ï¼Œæ›´æ˜¯æ¶æ„ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•ã€æµé‡æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚\nNginx åå‘ä»£ç†é…ç½® åŸºç¡€é…ç½® 1# /etc/nginx/nginx.conf 2 3user nginx; 4worker_processes auto; # è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° 5error_log /var/log/nginx/error.log warn; 6pid /var/run/nginx.pid; 7 8events { 9 worker_connections 1024; # æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° 10 use epoll; # Linux ä¸‹ä½¿ç”¨ epoll 11} 12 13http { 14 include /etc/nginx/mime.types; 15 default_type application/octet-stream; 16 17 # æ—¥å¿—æ ¼å¼ 18 log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; \u0026#39; 19 \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#39; 20 \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34; \u0026#39; 21 \u0026#39;$request_time $upstream_response_time\u0026#39;; 22 23 access_log /var/log/nginx/access.log main; 24 25 sendfile on; 26 tcp_nopush on; 27 tcp_nodelay on; 28 keepalive_timeout 65; 29 types_hash_max_size 2048; 30 31 # åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶ 32 include /etc/nginx/conf.d/*.conf; 33} ç®€å•åå‘ä»£ç† 1# /etc/nginx/conf.d/api.conf 2 3server { 4 listen 80; 5 server_name api.example.com; 6 7 location / { 8 # ä»£ç†åˆ°åç«¯æœåŠ¡å™¨ 9 proxy_pass http://192.168.1.100:8080; 10 11 # è®¾ç½®è¯·æ±‚å¤´ 12 proxy_set_header Host $host; 13 proxy_set_header X-Real-IP $remote_addr; 14 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 15 proxy_set_header X-Forwarded-Proto $scheme; 16 17 # è¶…æ—¶è®¾ç½® 18 proxy_connect_timeout 60s; 19 proxy_send_timeout 60s; 20 proxy_read_timeout 60s; 21 } 22} è·¯å¾„é‡å†™ 1server { 2 listen 80; 3 server_name api.example.com; 4 5 # å°† /api/v1/users ä»£ç†åˆ° http://backend/users 6 location /api/v1/ { 7 proxy_pass http://backend/; # æ³¨æ„æœ«å°¾çš„ / 8 proxy_set_header Host $host; 9 } 10 11 # å°† /old-api é‡å†™ä¸º /new-api 12 location /old-api { 13 rewrite ^/old-api/(.*)$ /new-api/$1 break; 14 proxy_pass http://backend; 15 } 16} è´Ÿè½½å‡è¡¡ç­–ç•¥ 1. è½®è¯¢ï¼ˆRound Robinï¼‰ é»˜è®¤ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†é…è¯·æ±‚ï¼š\n1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5} 6 7server { 8 listen 80; 9 server_name api.example.com; 10 11 location / { 12 proxy_pass http://backend; 13 } 14} 2. åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰ æ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…ä¸åŒæƒé‡ï¼š\n1upstream backend { 2 server 192.168.1.101:8080 weight=3; # æƒé‡ 3 3 server 192.168.1.102:8080 weight=2; # æƒé‡ 2 4 server 192.168.1.103:8080 weight=1; # æƒé‡ 1 5} æƒé‡ä¸º 3:2:1ï¼Œæ„å‘³ç€æ¯ 6 ä¸ªè¯·æ±‚ä¸­ï¼Œ101 æœåŠ¡å™¨å¤„ç† 3 ä¸ªï¼Œ102 å¤„ç† 2 ä¸ªï¼Œ103 å¤„ç† 1 ä¸ªã€‚\n3. IP Hash æ ¹æ®å®¢æˆ·ç«¯ IP è¿›è¡Œå“ˆå¸Œï¼ŒåŒä¸€ IP çš„è¯·æ±‚æ€»æ˜¯åˆ†é…åˆ°åŒä¸€å°æœåŠ¡å™¨ï¼š\n1upstream backend { 2 ip_hash; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šéœ€è¦ä¼šè¯ä¿æŒçš„åº”ç”¨ï¼ˆå¦‚è´­ç‰©è½¦ã€ç™»å½•çŠ¶æ€ï¼‰\nç¼ºç‚¹ï¼š\nè´Ÿè½½å¯èƒ½ä¸å‡è¡¡ï¼ˆIP åˆ†å¸ƒä¸å‡ï¼‰ æ— æ³•åº”å¯¹æœåŠ¡å™¨æ•…éšœï¼ˆIP é‡æ–°å“ˆå¸Œï¼‰ 4. æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰ å°†è¯·æ±‚åˆ†é…ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ï¼š\n1upstream backend { 2 least_conn; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šè¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚è¾ƒå¤§çš„åº”ç”¨\n5. ä¸€è‡´æ€§å“ˆå¸Œï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ 1upstream backend { 2 hash $request_uri consistent; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šç¼“å­˜æœåŠ¡å™¨é›†ç¾¤\nè´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯” ç­–ç•¥ ä¼˜ç‚¹ ç¼ºç‚¹ é€‚ç”¨åœºæ™¯ è½®è¯¢ ç®€å•ã€å‡è¡¡ æ— ä¼šè¯ä¿æŒ æ— çŠ¶æ€æœåŠ¡ åŠ æƒè½®è¯¢ è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½ æ— ä¼šè¯ä¿æŒ æœåŠ¡å™¨æ€§èƒ½ä¸åŒ IP Hash ä¼šè¯ä¿æŒ è´Ÿè½½å¯èƒ½ä¸å‡ æœ‰çŠ¶æ€æœåŠ¡ æœ€å°‘è¿æ¥ åŠ¨æ€å‡è¡¡ è®¡ç®—å¼€é”€å¤§ é•¿è¿æ¥æœåŠ¡ ä¸€è‡´æ€§å“ˆå¸Œ ç¼“å­˜å‘½ä¸­ç‡é«˜ å®ç°å¤æ‚ ç¼“å­˜é›†ç¾¤ å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» è¢«åŠ¨å¥åº·æ£€æŸ¥ Nginx é»˜è®¤çš„å¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œå½“è¯·æ±‚å¤±è´¥æ—¶æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¯ç”¨ï¼š\n1upstream backend { 2 server 192.168.1.101:8080 max_fails=3 fail_timeout=30s; 3 server 192.168.1.102:8080 max_fails=3 fail_timeout=30s; 4 server 192.168.1.103:8080 max_fails=3 fail_timeout=30s; 5} å‚æ•°è¯´æ˜ï¼š\nmax_fails=3ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡åæ ‡è®°ä¸ºä¸å¯ç”¨ fail_timeout=30sï¼šæ ‡è®°ä¸ºä¸å¯ç”¨åï¼Œ30 ç§’å†…ä¸å†åˆ†é…è¯·æ±‚ ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆNginx Plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ ä½¿ç”¨ nginx_upstream_check_module æ¨¡å—ï¼š\n1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5 6 check interval=3000 rise=2 fall=3 timeout=1000 type=http; 7 check_http_send \u0026#34;HEAD /health HTTP/1.0\\r\\n\\r\\n\u0026#34;; 8 check_http_expect_alive http_2xx http_3xx; 9} 10 11server { 12 listen 80; 13 14 location /status { 15 check_status; 16 access_log off; 17 } 18} å‚æ•°è¯´æ˜ï¼š\ninterval=3000ï¼šæ¯ 3 ç§’æ£€æŸ¥ä¸€æ¬¡ rise=2ï¼šè¿ç»­æˆåŠŸ 2 æ¬¡æ ‡è®°ä¸ºå¯ç”¨ fall=3ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡æ ‡è®°ä¸ºä¸å¯ç”¨ timeout=1000ï¼šè¶…æ—¶æ—¶é—´ 1 ç§’ type=httpï¼šä½¿ç”¨ HTTP åè®®æ£€æŸ¥ å¤‡ç”¨æœåŠ¡å™¨ 1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5 server 192.168.1.104:8080 backup; # å¤‡ç”¨æœåŠ¡å™¨ 6} åªæœ‰å½“æ‰€æœ‰ä¸»æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶ï¼Œæ‰ä¼šä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨ã€‚\næ•…éšœè½¬ç§»é…ç½® 1location / { 2 proxy_pass http://backend; 3 proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504; 4 proxy_next_upstream_tries 2; # æœ€å¤šå°è¯• 2 æ¬¡ 5 proxy_next_upstream_timeout 10s; # æ€»è¶…æ—¶æ—¶é—´ 10 ç§’ 6} ä¼šè¯ä¿æŒæ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šIP Hash 1upstream backend { 2 ip_hash; 3 server 192.168.1.101:8080; 4 server 192.168.1.102:8080; 5} ä¼˜ç‚¹ï¼šé…ç½®ç®€å• ç¼ºç‚¹ï¼šè´Ÿè½½å¯èƒ½ä¸å‡è¡¡\næ–¹æ¡ˆäºŒï¼šCookie ç»‘å®š 1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 5 sticky cookie srv_id expires=1h domain=.example.com path=/; 6} Nginx ä¼šåœ¨å“åº”ä¸­è®¾ç½®ä¸€ä¸ª Cookieï¼Œåç»­è¯·æ±‚æ ¹æ® Cookie è·¯ç”±åˆ°åŒä¸€å°æœåŠ¡å™¨ã€‚\næ–¹æ¡ˆä¸‰ï¼šSession å…±äº«ï¼ˆæ¨èï¼‰ ä¸ä¾èµ– Nginxï¼Œåœ¨åº”ç”¨å±‚å®ç° Session å…±äº«ï¼š\nä½¿ç”¨ Redis å­˜å‚¨ Sessionï¼š\n1@Configuration 2@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800) 3public class SessionConfig { 4 5 @Bean 6 public LettuceConnectionFactory connectionFactory() { 7 return new LettuceConnectionFactory(); 8 } 9} ä½¿ç”¨ JWT Tokenï¼š\n1@RestController 2public class AuthController { 3 4 @PostMapping(\u0026#34;/login\u0026#34;) 5 public Result login(@RequestBody LoginRequest request) { 6 // éªŒè¯ç”¨æˆ·åå¯†ç  7 User user = userService.authenticate(request.getUsername(), request.getPassword()); 8 9 // ç”Ÿæˆ JWT Token 10 String token = JwtUtil.generateToken(user.getId()); 11 12 return Result.success(token); 13 } 14} æ¶æ„æ€è€ƒï¼š ä¼šè¯ä¿æŒçš„æœ€ä½³å®è·µæ˜¯åœ¨åº”ç”¨å±‚å®ç°æ— çŠ¶æ€åŒ–ã€‚é€šè¿‡ Redis å…±äº« Session æˆ–ä½¿ç”¨ JWT Tokenï¼Œå¯ä»¥å®ç°çœŸæ­£çš„æ°´å¹³æ‰©å±•ï¼Œè€Œä¸ä¾èµ–äºè´Ÿè½½å‡è¡¡å™¨çš„ç‰¹å®šåŠŸèƒ½ã€‚\nHTTPS é…ç½® SSL è¯ä¹¦é…ç½® 1server { 2 listen 443 ssl http2; 3 server_name api.example.com; 4 5 # SSL è¯ä¹¦ 6 ssl_certificate /etc/nginx/ssl/api.example.com.crt; 7 ssl_certificate_key /etc/nginx/ssl/api.example.com.key; 8 9 # SSL åè®®å’ŒåŠ å¯†å¥—ä»¶ 10 ssl_protocols TLSv1.2 TLSv1.3; 11 ssl_ciphers \u0026#39;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256\u0026#39;; 12 ssl_prefer_server_ciphers on; 13 14 # SSL ä¼šè¯ç¼“å­˜ 15 ssl_session_cache shared:SSL:10m; 16 ssl_session_timeout 10m; 17 18 # HSTS 19 add_header Strict-Transport-Security \u0026#34;max-age=31536000\u0026#34; always; 20 21 location / { 22 proxy_pass http://backend; 23 proxy_set_header Host $host; 24 proxy_set_header X-Real-IP $remote_addr; 25 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 26 proxy_set_header X-Forwarded-Proto $scheme; 27 } 28} 29 30# HTTP é‡å®šå‘åˆ° HTTPS 31server { 32 listen 80; 33 server_name api.example.com; 34 return 301 https://$server_name$request_uri; 35} å…è´¹ SSL è¯ä¹¦ï¼ˆLet\u0026rsquo;s Encryptï¼‰ 1# å®‰è£… Certbot 2sudo yum install certbot python3-certbot-nginx 3 4# è·å–è¯ä¹¦ 5sudo certbot --nginx -d api.example.com 6 7# è‡ªåŠ¨ç»­æœŸ 8sudo certbot renew --dry-run æ€§èƒ½ä¼˜åŒ– 1. è¿æ¥ä¼˜åŒ– 1http { 2 # é•¿è¿æ¥é…ç½® 3 keepalive_timeout 65; 4 keepalive_requests 100; 5 6 # ä¸Šæ¸¸æœåŠ¡å™¨é•¿è¿æ¥ 7 upstream backend { 8 server 192.168.1.101:8080; 9 server 192.168.1.102:8080; 10 11 keepalive 32; # ä¿æŒ 32 ä¸ªç©ºé—²è¿æ¥ 12 } 13 14 server { 15 location / { 16 proxy_pass http://backend; 17 proxy_http_version 1.1; 18 proxy_set_header Connection \u0026#34;\u0026#34;; 19 } 20 } 21} 2. ç¼“å­˜é…ç½® 1# å®šä¹‰ç¼“å­˜è·¯å¾„ 2proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m; 3 4server { 5 location / { 6 proxy_pass http://backend; 7 8 # å¯ç”¨ç¼“å­˜ 9 proxy_cache my_cache; 10 proxy_cache_valid 200 304 10m; 11 proxy_cache_valid 404 1m; 12 proxy_cache_key $scheme$proxy_host$request_uri; 13 14 # ç¼“å­˜å¤´ä¿¡æ¯ 15 add_header X-Cache-Status $upstream_cache_status; 16 } 17 18 # é™æ€èµ„æºç¼“å­˜ 19 location ~* \\.(jpg|jpeg|png|gif|ico|css|js)$ { 20 proxy_pass http://backend; 21 proxy_cache my_cache; 22 proxy_cache_valid 200 30d; 23 expires 30d; 24 } 25} 3. Gzip å‹ç¼© 1http { 2 gzip on; 3 gzip_vary on; 4 gzip_proxied any; 5 gzip_comp_level 6; 6 gzip_types text/plain text/css text/xml text/javascript 7 application/json application/javascript application/xml+rss 8 application/rss+xml font/truetype font/opentype 9 application/vnd.ms-fontobject image/svg+xml; 10 gzip_disable \u0026#34;msie6\u0026#34;; 11} 4. é™æµé…ç½® 1http { 2 # å®šä¹‰é™æµåŒºåŸŸ 3 limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s; 4 limit_conn_zone $binary_remote_addr zone=conn_limit:10m; 5 6 server { 7 location /api/ { 8 # é™åˆ¶è¯·æ±‚é€Ÿç‡ï¼šæ¯ç§’ 10 ä¸ªè¯·æ±‚ï¼Œçªå‘ 20 ä¸ª 9 limit_req zone=api_limit burst=20 nodelay; 10 11 # é™åˆ¶å¹¶å‘è¿æ¥æ•°ï¼šæ¯ä¸ª IP æœ€å¤š 10 ä¸ªè¿æ¥ 12 limit_conn conn_limit 10; 13 14 proxy_pass http://backend; 15 } 16 } 17} 5. Worker è¿›ç¨‹ä¼˜åŒ– 1# è‡ªåŠ¨è®¾ç½® worker è¿›ç¨‹æ•°ä¸º CPU æ ¸å¿ƒæ•° 2worker_processes auto; 3 4# ç»‘å®š worker è¿›ç¨‹åˆ° CPU æ ¸å¿ƒ 5worker_cpu_affinity auto; 6 7# æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•° 8worker_rlimit_nofile 65535; 9 10events { 11 # æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° 12 worker_connections 10240; 13 14 # ä½¿ç”¨ epoll äº‹ä»¶æ¨¡å‹ 15 use epoll; 16 17 # å°½å¯èƒ½å¤šåœ°æ¥å—è¿æ¥ 18 multi_accept on; 19} ç›‘æ§ä¸æ—¥å¿— è®¿é—®æ—¥å¿—åˆ†æ 1# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ 2log_format detailed \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#39; 3 \u0026#39;\u0026#34;$request\u0026#34; $status $body_bytes_sent \u0026#39; 4 \u0026#39;\u0026#34;$http_referer\u0026#34; \u0026#34;$http_user_agent\u0026#34; \u0026#39; 5 \u0026#39;$request_time $upstream_response_time \u0026#39; 6 \u0026#39;$upstream_addr $upstream_status\u0026#39;; 7 8access_log /var/log/nginx/access.log detailed; ä½¿ç”¨ GoAccess åˆ†ææ—¥å¿— 1# å®‰è£… GoAccess 2sudo yum install goaccess 3 4# å®æ—¶åˆ†ææ—¥å¿— 5goaccess /var/log/nginx/access.log -o /var/www/html/report.html --log-format=COMBINED --real-time-html Nginx çŠ¶æ€ç›‘æ§ 1server { 2 listen 8080; 3 server_name localhost; 4 5 location /nginx_status { 6 stub_status on; 7 access_log off; 8 allow 127.0.0.1; 9 deny all; 10 } 11} è®¿é—® http://localhost:8080/nginx_status æŸ¥çœ‹çŠ¶æ€ï¼š\n1Active connections: 291 2server accepts handled requests 3 16630948 16630948 31070465 4Reading: 6 Writing: 179 Waiting: 106 Prometheus ç›‘æ§ ä½¿ç”¨ nginx-prometheus-exporterï¼š\n1# ä¸‹è½½å¹¶è¿è¡Œ exporter 2docker run -p 9113:9113 nginx/nginx-prometheus-exporter:latest \\ 3 -nginx.scrape-uri=http://nginx:8080/nginx_status ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ 1. é…ç½®æ–‡ä»¶ç»„ç»‡ 1/etc/nginx/ 2â”œâ”€â”€ nginx.conf # ä¸»é…ç½®æ–‡ä»¶ 3â”œâ”€â”€ conf.d/ 4â”‚ â”œâ”€â”€ api.conf # API æœåŠ¡é…ç½® 5â”‚ â”œâ”€â”€ web.conf # Web æœåŠ¡é…ç½® 6â”‚ â””â”€â”€ admin.conf # ç®¡ç†åå°é…ç½® 7â”œâ”€â”€ upstream/ 8â”‚ â”œâ”€â”€ api-backend.conf # API åç«¯æœåŠ¡å™¨åˆ—è¡¨ 9â”‚ â””â”€â”€ web-backend.conf # Web åç«¯æœåŠ¡å™¨åˆ—è¡¨ 10â””â”€â”€ ssl/ 11 â”œâ”€â”€ api.example.com.crt 12 â””â”€â”€ api.example.com.key 2. é…ç½®æ£€æŸ¥ä¸é‡è½½ 1# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³• 2sudo nginx -t 3 4# é‡è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰ 5sudo nginx -s reload 6 7# æŸ¥çœ‹ Nginx ç‰ˆæœ¬å’Œç¼–è¯‘å‚æ•° 8nginx -V 3. å®‰å…¨åŠ å›º 1# éšè— Nginx ç‰ˆæœ¬å· 2server_tokens off; 3 4# é™åˆ¶è¯·æ±‚æ–¹æ³• 5if ($request_method !~ ^(GET|POST|PUT|DELETE|HEAD)$) { 6 return 405; 7} 8 9# é˜²æ­¢ç‚¹å‡»åŠ«æŒ 10add_header X-Frame-Options \u0026#34;SAMEORIGIN\u0026#34; always; 11 12# XSS é˜²æŠ¤ 13add_header X-XSS-Protection \u0026#34;1; mode=block\u0026#34; always; 14 15# å†…å®¹ç±»å‹å—…æ¢é˜²æŠ¤ 16add_header X-Content-Type-Options \u0026#34;nosniff\u0026#34; always; 17 18# CSP ç­–ç•¥ 19add_header Content-Security-Policy \u0026#34;default-src \u0026#39;self\u0026#39;\u0026#34; always; 4. æ—¥å¿—è½®è½¬ 1# /etc/logrotate.d/nginx 2 3/var/log/nginx/*.log { 4 daily 5 missingok 6 rotate 14 7 compress 8 delaycompress 9 notifempty 10 create 0640 nginx adm 11 sharedscripts 12 postrotate 13 [ -f /var/run/nginx.pid ] \u0026amp;\u0026amp; kill -USR1 `cat /var/run/nginx.pid` 14 endscript 15} é¿å‘æç¤ºï¼š ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒåŠ¡å¿…åšå¥½ä»¥ä¸‹å‡ ç‚¹ï¼š1) å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶ï¼›2) ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®ï¼›3) é…ç½®å˜æ›´å‰å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼›4) è®¾ç½®ç›‘æ§å‘Šè­¦ï¼›5) å‡†å¤‡å›æ»šæ–¹æ¡ˆã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº† Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§å®è·µï¼š\nåå‘ä»£ç†ï¼šç†è§£åŸç†ï¼ŒæŒæ¡åŸºç¡€é…ç½®å’Œè·¯å¾„é‡å†™ è´Ÿè½½å‡è¡¡ï¼šæŒæ¡å¤šç§ç­–ç•¥ï¼Œæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ å¥åº·æ£€æŸ¥ï¼šå®ç°æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨è½¬ç§» ä¼šè¯ä¿æŒï¼šäº†è§£å¤šç§æ–¹æ¡ˆï¼Œæ¨èåº”ç”¨å±‚æ— çŠ¶æ€åŒ– HTTPS é…ç½®ï¼šSSL è¯ä¹¦é…ç½®å’Œå®‰å…¨åŠ å›º æ€§èƒ½ä¼˜åŒ–ï¼šè¿æ¥ä¼˜åŒ–ã€ç¼“å­˜ã€å‹ç¼©ã€é™æµç­‰ ç›‘æ§æ—¥å¿—ï¼šæ—¥å¿—åˆ†æå’ŒçŠ¶æ€ç›‘æ§ åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒNginx çš„ä½œç”¨è¿œä¸æ­¢äºæ­¤ã€‚é€šè¿‡åˆç†é…ç½®ï¼Œè¿˜å¯ä»¥å®ç°ï¼š\nç°åº¦å‘å¸ƒï¼šæ ¹æ®æ¡ä»¶å°†éƒ¨åˆ†æµé‡å¯¼å‘æ–°ç‰ˆæœ¬ A/B æµ‹è¯•ï¼šå°†ä¸åŒç”¨æˆ·å¯¼å‘ä¸åŒç‰ˆæœ¬ æµé‡æ§åˆ¶ï¼šé™æµã€ç†”æ–­ã€é™çº§ å®‰å…¨é˜²æŠ¤ï¼šWAFã€DDoS é˜²æŠ¤ ä¸‹æ¬¡å½“ä½ éœ€è¦æ­å»ºé«˜å¯ç”¨æœåŠ¡æ¶æ„æ—¶ï¼ŒNginx å°†æ˜¯ä½ çš„å¾—åŠ›åŠ©æ‰‹ã€‚\n","permalink":"http://localhost:1313/posts/2025/06/nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E6%88%98%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E4%BC%98%E5%8C%96/","summary":"\u003cp\u003eNginx ä½œä¸ºé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå·²ç»æˆä¸ºäº’è”ç½‘æ¶æ„ä¸­çš„æ ‡é…ç»„ä»¶ã€‚æ— è®ºæ˜¯é™æ€èµ„æºæœåŠ¡ã€åå‘ä»£ç†è¿˜æ˜¯è´Ÿè½½å‡è¡¡ï¼ŒNginx éƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…åœºæ™¯å‡ºå‘ï¼Œæ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œå¸®åŠ©ä½ æ„å»ºé«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åå‘ä»£ç†ä¸æ­£å‘ä»£ç†çš„åŒºåˆ«\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Nginx è´Ÿè½½å‡è¡¡çš„å¤šç§ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé…ç½®å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ä¼šè¯ä¿æŒçš„å®ç°æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åå‘ä»£ç†åŸºç¡€\"\u003eåå‘ä»£ç†åŸºç¡€\u003c/h2\u003e\n\u003ch3 id=\"æ­£å‘ä»£ç†-vs-åå‘ä»£ç†\"\u003eæ­£å‘ä»£ç† vs åå‘ä»£ç†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæ­£å‘ä»£ç†\u003c/strong\u003eï¼šå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eï¼ˆå®¢æˆ·ç«¯é…ç½®ä»£ç†ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåå‘ä»£ç†\u003c/strong\u003eï¼šå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å†³å®šè½¬å‘åˆ°å“ªå°æœåŠ¡å™¨\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨é›†ç¾¤\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eï¼ˆæœåŠ¡ç«¯é…ç½®ä»£ç†ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"åå‘ä»£ç†çš„ä¼˜åŠ¿\"\u003eåå‘ä»£ç†çš„ä¼˜åŠ¿\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eè´Ÿè½½å‡è¡¡\u003c/strong\u003eï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eéšè—çœŸå®æœåŠ¡å™¨\u003c/strong\u003eï¼šæé«˜å®‰å…¨æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSSL å¸è½½\u003c/strong\u003eï¼šåœ¨ä»£ç†å±‚å¤„ç† HTTPS\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç¼“å­˜é™æ€èµ„æº\u003c/strong\u003eï¼šå‡è½»åç«¯å‹åŠ›\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç»Ÿä¸€å…¥å£\u003c/strong\u003eï¼šä¾¿äºç®¡ç†å’Œç›‘æ§\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e åå‘ä»£ç†ä¸ä»…æ˜¯æµé‡åˆ†å‘å™¨ï¼Œæ›´æ˜¯æ¶æ„ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•ã€æµé‡æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"nginx-åå‘ä»£ç†é…ç½®\"\u003eNginx åå‘ä»£ç†é…ç½®\u003c/h2\u003e\n\u003ch3 id=\"åŸºç¡€é…ç½®\"\u003eåŸºç¡€é…ç½®\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /etc/nginx/nginx.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euser\u003c/span\u003e \u003cspan class=\"s\"\u003enginx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eworker_processes\u003c/span\u003e \u003cspan class=\"s\"\u003eauto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eerror_log\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/nginx/error.log\u003c/span\u003e \u003cspan class=\"s\"\u003ewarn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003epid\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/nginx.pid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eevents\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eworker_connections\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003euse\u003c/span\u003e \u003cspan class=\"s\"\u003eepoll\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# Linux ä¸‹ä½¿ç”¨ epoll\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ehttp\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003einclude\u003c/span\u003e \u003cspan class=\"s\"\u003e/etc/nginx/mime.types\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003edefault_type\u003c/span\u003e \u003cspan class=\"s\"\u003eapplication/octet-stream\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# æ—¥å¿—æ ¼å¼\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elog_format\u003c/span\u003e \u003cspan class=\"s\"\u003emain\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e \u003cspan class=\"s\"\u003e-\u003c/span\u003e \u003cspan class=\"nv\"\u003e$remote_user\u003c/span\u003e \u003cspan class=\"s\"\u003e[\u003c/span\u003e\u003cspan class=\"nv\"\u003e$time_local]\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$request\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$status\u003c/span\u003e \u003cspan class=\"nv\"\u003e$body_bytes_sent\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_referer\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_user_agent\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_x_forwarded_for\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$request_time\u003c/span\u003e \u003cspan class=\"nv\"\u003e$upstream_response_time\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eaccess_log\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/nginx/access.log\u003c/span\u003e \u003cspan class=\"s\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003esendfile\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etcp_nopush\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etcp_nodelay\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003ekeepalive_timeout\u003c/span\u003e \u003cspan class=\"mi\"\u003e65\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etypes_hash_max_size\u003c/span\u003e \u003cspan class=\"mi\"\u003e2048\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003einclude\u003c/span\u003e \u003cspan class=\"s\"\u003e/etc/nginx/conf.d/*.conf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ç®€å•åå‘ä»£ç†\"\u003eç®€å•åå‘ä»£ç†\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /etc/nginx/conf.d/api.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eserver\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elisten\u003c/span\u003e \u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eserver_name\u003c/span\u003e \u003cspan class=\"s\"\u003eapi.example.com\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# ä»£ç†åˆ°åç«¯æœåŠ¡å™¨\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://192.168.1.100:8080\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# è®¾ç½®è¯·æ±‚å¤´\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eHost\u003c/span\u003e \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Real-IP\u003c/span\u003e \u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Forwarded-For\u003c/span\u003e \u003cspan class=\"nv\"\u003e$proxy_add_x_forwarded_for\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Forwarded-Proto\u003c/span\u003e \u003cspan class=\"nv\"\u003e$scheme\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# è¶…æ—¶è®¾ç½®\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_connect_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_send_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_read_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"è·¯å¾„é‡å†™\"\u003eè·¯å¾„é‡å†™\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eserver\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elisten\u003c/span\u003e \u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eserver_name\u003c/span\u003e \u003cspan class=\"s\"\u003eapi.example.com\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# å°† /api/v1/users ä»£ç†åˆ° http://backend/users\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/api/v1/\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://backend/\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# æ³¨æ„æœ«å°¾çš„ /\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eHost\u003c/span\u003e \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# å°† /old-api é‡å†™ä¸º /new-api\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/old-api\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003erewrite\u003c/span\u003e \u003cspan class=\"s\"\u003e^/old-api/(.*)\u003c/span\u003e$ \u003cspan class=\"s\"\u003e/new-api/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e \u003cspan class=\"s\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://backend\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"è´Ÿè½½å‡è¡¡ç­–ç•¥\"\u003eè´Ÿè½½å‡è¡¡ç­–ç•¥\u003c/h2\u003e\n\u003ch3 id=\"1-è½®è¯¢round-robin\"\u003e1. è½®è¯¢ï¼ˆRound Robinï¼‰\u003c/h3\u003e\n\u003cp\u003eé»˜è®¤ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†é…è¯·æ±‚ï¼š\u003c/p\u003e","title":"Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ–"},{"content":"åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¤§æ•°æ®é‡å¯¼å‡ºæ˜¯ä¸€ä¸ªå¸¸è§ä½†æ£˜æ‰‹çš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„ Apache POI åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºï¼Œè€Œé˜¿é‡Œå¼€æºçš„ EasyExcel é€šè¿‡ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œå¯ä»¥è½»æ¾å¤„ç†ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€‚\næœ¬æ–‡å°†ä»å®é™…é—®é¢˜å‡ºå‘ï¼Œæ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°é«˜æ€§èƒ½çš„å¤§æ•°æ®é‡å¯¼å‡ºï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¼˜åŒ–ç»éªŒã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜ æŒæ¡ EasyExcel çš„æ ¸å¿ƒåŸç† å­¦ä¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„æœ€ä½³å®è·µ äº†è§£å¼‚æ­¥å¯¼å‡ºä¸è¿›åº¦åé¦ˆæ–¹æ¡ˆ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§ ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜ é—®é¢˜åœºæ™¯ æŸç”µå•†ç³»ç»Ÿéœ€è¦å¯¼å‡ºè®¢å•æ•°æ®ï¼Œæ•°æ®é‡è¾¾åˆ° 100 ä¸‡æ¡ã€‚ä½¿ç”¨ä¼ ç»Ÿçš„ Apache POI å®ç°ï¼š\n1// ä¼ ç»Ÿ POI å®ç°ï¼ˆæœ‰é—®é¢˜çš„ä»£ç ï¼‰ 2public void exportOrders() { 3 Workbook workbook = new XSSFWorkbook(); 4 Sheet sheet = workbook.createSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;); 5 6 // æŸ¥è¯¢ 100 ä¸‡æ¡æ•°æ® 7 List\u0026lt;Order\u0026gt; orders = orderMapper.selectAll(); 8 9 // å†™å…¥ Excel 10 for (int i = 0; i \u0026lt; orders.size(); i++) { 11 Row row = sheet.createRow(i); 12 Order order = orders.get(i); 13 row.createCell(0).setCellValue(order.getOrderNo()); 14 row.createCell(1).setCellValue(order.getUserName()); 15 // ... æ›´å¤šå­—æ®µ 16 } 17 18 // è¾“å‡ºæ–‡ä»¶ 19 FileOutputStream fos = new FileOutputStream(\u0026#34;orders.xlsx\u0026#34;); 20 workbook.write(fos); 21 fos.close(); 22} å†…å­˜åˆ†æ è¿™æ®µä»£ç å­˜åœ¨ä¸¥é‡çš„å†…å­˜é—®é¢˜ï¼š\nä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®ï¼š100 ä¸‡æ¡æ•°æ®å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ POI å¯¹è±¡å ç”¨å¤§ï¼šæ¯ä¸ª Cellã€Rowã€Sheet éƒ½æ˜¯ Java å¯¹è±¡ å†…å­˜æ— æ³•é‡Šæ”¾ï¼šæ•°æ®å†™å…¥å‰å¿…é¡»å…¨éƒ¨ä¿å­˜åœ¨å†…å­˜ä¸­ å†…å­˜å ç”¨ä¼°ç®—ï¼š\næ¯æ¡è®¢å•æ•°æ®ï¼šçº¦ 1KB 100 ä¸‡æ¡æ•°æ®ï¼šçº¦ 1GB POI å¯¹è±¡å¼€é”€ï¼šçº¦ 3-5 å€ æ€»å†…å­˜å ç”¨ï¼š3-5GB æ¶æ„æ€è€ƒï¼š ä¼ ç»Ÿ POI é‡‡ç”¨ DOM æ¨¡å¼ï¼Œéœ€è¦åœ¨å†…å­˜ä¸­æ„å»ºå®Œæ•´çš„æ–‡æ¡£å¯¹è±¡æ¨¡å‹ã€‚è¿™ç§æ–¹å¼è™½ç„¶çµæ´»ï¼Œä½†åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚EasyExcel é‡‡ç”¨ SAX æ¨¡å¼ï¼Œè¾¹è¯»è¾¹å†™ï¼Œå¤§å¤§é™ä½äº†å†…å­˜å ç”¨ã€‚\nEasyExcel æ ¸å¿ƒåŸç† å†…å­˜ä¼˜åŒ–ç­–ç•¥ EasyExcel é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¼˜åŒ–å†…å­˜ï¼š\næµå¼å†™å…¥ï¼šä¸åœ¨å†…å­˜ä¸­ä¿å­˜å®Œæ•´çš„ Excel å¯¹è±¡ åˆ†æ‰¹å¤„ç†ï¼šæ”¯æŒåˆ†æ‰¹æŸ¥è¯¢å’Œå†™å…¥ ä¸´æ—¶æ–‡ä»¶ï¼šä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ç¼“å­˜æ•°æ® å¯¹è±¡å¤ç”¨ï¼šå¤ç”¨ Java å¯¹è±¡ï¼Œå‡å°‘ GC å‹åŠ› å†…å­˜å ç”¨å¯¹æ¯” æ–¹æ¡ˆ 10ä¸‡æ¡ 50ä¸‡æ¡ 100ä¸‡æ¡ Apache POI 300MB 1.5GB OOM EasyExcel 20MB 50MB 100MB EasyExcel åŸºç¡€ä½¿ç”¨ é¡¹ç›®ä¾èµ– 1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;easyexcel\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;3.3.2\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; å®šä¹‰æ•°æ®æ¨¡å‹ 1@Data 2public class OrderExportDTO { 3 4 @ExcelProperty(value = \u0026#34;è®¢å•å·\u0026#34;, index = 0) 5 private String orderNo; 6 7 @ExcelProperty(value = \u0026#34;ç”¨æˆ·å\u0026#34;, index = 1) 8 private String userName; 9 10 @ExcelProperty(value = \u0026#34;å•†å“åç§°\u0026#34;, index = 2) 11 private String productName; 12 13 @ExcelProperty(value = \u0026#34;è®¢å•é‡‘é¢\u0026#34;, index = 3) 14 @NumberFormat(\u0026#34;#.##\u0026#34;) 15 private BigDecimal amount; 16 17 @ExcelProperty(value = \u0026#34;è®¢å•çŠ¶æ€\u0026#34;, index = 4) 18 @ExcelProperty(converter = OrderStatusConverter.class) 19 private Integer status; 20 21 @ExcelProperty(value = \u0026#34;åˆ›å»ºæ—¶é—´\u0026#34;, index = 5) 22 @DateTimeFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;) 23 private Date createTime; 24} ç®€å•å¯¼å‡ºç¤ºä¾‹ 1@Service 2public class OrderExportService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 /** 8 * ç®€å•å¯¼å‡ºï¼ˆé€‚ç”¨äºå°æ•°æ®é‡ï¼‰ 9 */ 10 public void simpleExport(HttpServletResponse response) throws IOException { 11 // æŸ¥è¯¢æ•°æ® 12 List\u0026lt;OrderExportDTO\u0026gt; data = orderMapper.selectForExport(); 13 14 // è®¾ç½®å“åº”å¤´ 15 response.setContentType(\u0026#34;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\u0026#34;); 16 response.setCharacterEncoding(\u0026#34;utf-8\u0026#34;); 17 String fileName = URLEncoder.encode(\u0026#34;è®¢å•æ•°æ®\u0026#34;, \u0026#34;UTF-8\u0026#34;); 18 response.setHeader(\u0026#34;Content-disposition\u0026#34;, \u0026#34;attachment;filename=\u0026#34; + fileName + \u0026#34;.xlsx\u0026#34;); 19 20 // å†™å…¥ Excel 21 EasyExcel.write(response.getOutputStream(), OrderExportDTO.class) 22 .sheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;) 23 .doWrite(data); 24 } 25} ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºæ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šåˆ†é¡µæŸ¥è¯¢ + æµå¼å†™å…¥ 1@Service 2@Slf4j 3public class LargeDataExportService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 private static final int PAGE_SIZE = 10000; // æ¯é¡µ 1 ä¸‡æ¡ 9 10 /** 11 * åˆ†é¡µå¯¼å‡ºå¤§æ•°æ®é‡ 12 */ 13 public void exportLargeData(HttpServletResponse response) throws IOException { 14 // è®¾ç½®å“åº”å¤´ 15 setResponseHeader(response, \u0026#34;è®¢å•æ•°æ®\u0026#34;); 16 17 // ä½¿ç”¨ EasyExcel çš„æµå¼å†™å…¥ 18 ExcelWriter excelWriter = null; 19 try { 20 excelWriter = EasyExcel.write(response.getOutputStream(), OrderExportDTO.class).build(); 21 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 22 23 // åˆ†é¡µæŸ¥è¯¢å¹¶å†™å…¥ 24 int pageNum = 1; 25 while (true) { 26 log.info(\u0026#34;å¼€å§‹å¯¼å‡ºç¬¬ {} é¡µæ•°æ®\u0026#34;, pageNum); 27 28 // åˆ†é¡µæŸ¥è¯¢ 29 PageHelper.startPage(pageNum, PAGE_SIZE); 30 List\u0026lt;OrderExportDTO\u0026gt; data = orderMapper.selectForExport(); 31 32 if (CollectionUtils.isEmpty(data)) { 33 break; 34 } 35 36 // å†™å…¥å½“å‰é¡µæ•°æ® 37 excelWriter.write(data, writeSheet); 38 39 log.info(\u0026#34;ç¬¬ {} é¡µæ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} æ¡\u0026#34;, pageNum, data.size()); 40 41 // å¦‚æœå½“å‰é¡µæ•°æ®ä¸è¶³ä¸€é¡µï¼Œè¯´æ˜å·²ç»æ˜¯æœ€åä¸€é¡µ 42 if (data.size() \u0026lt; PAGE_SIZE) { 43 break; 44 } 45 46 pageNum++; 47 } 48 49 log.info(\u0026#34;æ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} é¡µ\u0026#34;, pageNum); 50 } finally { 51 if (excelWriter != null) { 52 excelWriter.finish(); 53 } 54 } 55 } 56 57 private void setResponseHeader(HttpServletResponse response, String fileName) throws UnsupportedEncodingException { 58 response.setContentType(\u0026#34;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\u0026#34;); 59 response.setCharacterEncoding(\u0026#34;utf-8\u0026#34;); 60 String encodedFileName = URLEncoder.encode(fileName, \u0026#34;UTF-8\u0026#34;); 61 response.setHeader(\u0026#34;Content-disposition\u0026#34;, \u0026#34;attachment;filename=\u0026#34; + encodedFileName + \u0026#34;.xlsx\u0026#34;); 62 } 63} æ–¹æ¡ˆäºŒï¼šæ¸¸æ ‡æŸ¥è¯¢ + æµå¼å†™å…¥ å¯¹äº MyBatisï¼Œå¯ä»¥ä½¿ç”¨æ¸¸æ ‡ï¼ˆCursorï¼‰è¿›ä¸€æ­¥ä¼˜åŒ–å†…å­˜ï¼š\n1/** 2 * Mapper æ¥å£ 3 */ 4public interface OrderMapper { 5 /** 6 * ä½¿ç”¨æ¸¸æ ‡æŸ¥è¯¢ï¼ˆæµå¼æŸ¥è¯¢ï¼‰ 7 */ 8 @Options(resultSetType = ResultSetType.FORWARD_ONLY, fetchSize = 1000) 9 @Select(\u0026#34;SELECT * FROM t_order WHERE status = #{status}\u0026#34;) 10 Cursor\u0026lt;OrderExportDTO\u0026gt; selectByCursor(@Param(\u0026#34;status\u0026#34;) Integer status); 11} 12 13/** 14 * ä½¿ç”¨æ¸¸æ ‡å¯¼å‡º 15 */ 16public void exportWithCursor(HttpServletResponse response) throws IOException { 17 setResponseHeader(response, \u0026#34;è®¢å•æ•°æ®\u0026#34;); 18 19 ExcelWriter excelWriter = null; 20 Cursor\u0026lt;OrderExportDTO\u0026gt; cursor = null; 21 22 try { 23 excelWriter = EasyExcel.write(response.getOutputStream(), OrderExportDTO.class).build(); 24 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 25 26 // æ‰“å¼€æ¸¸æ ‡ 27 cursor = orderMapper.selectByCursor(1); 28 29 List\u0026lt;OrderExportDTO\u0026gt; batch = new ArrayList\u0026lt;\u0026gt;(PAGE_SIZE); 30 int count = 0; 31 32 // éå†æ¸¸æ ‡ 33 for (OrderExportDTO order : cursor) { 34 batch.add(order); 35 count++; 36 37 // æ¯ 1 ä¸‡æ¡å†™å…¥ä¸€æ¬¡ 38 if (batch.size() \u0026gt;= PAGE_SIZE) { 39 excelWriter.write(batch, writeSheet); 40 log.info(\u0026#34;å·²å¯¼å‡º {} æ¡æ•°æ®\u0026#34;, count); 41 batch.clear(); 42 } 43 } 44 45 // å†™å…¥å‰©ä½™æ•°æ® 46 if (!batch.isEmpty()) { 47 excelWriter.write(batch, writeSheet); 48 log.info(\u0026#34;æ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} æ¡\u0026#34;, count); 49 } 50 51 } finally { 52 if (cursor != null) { 53 cursor.close(); 54 } 55 if (excelWriter != null) { 56 excelWriter.finish(); 57 } 58 } 59} é¿å‘æç¤ºï¼š ä½¿ç”¨æ¸¸æ ‡æŸ¥è¯¢æ—¶ï¼Œéœ€è¦æ³¨æ„ï¼š1) å¿…é¡»åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆï¼›2) ä¸èƒ½ä½¿ç”¨åˆ†é¡µæ’ä»¶ï¼›3) éœ€è¦è®¾ç½® fetchSize æ§åˆ¶æ¯æ¬¡ä»æ•°æ®åº“è·å–çš„è®°å½•æ•°ã€‚\nå¼‚æ­¥å¯¼å‡ºæ–¹æ¡ˆ å¯¹äºè¶…å¤§æ•°æ®é‡ï¼ˆç™¾ä¸‡çº§ä»¥ä¸Šï¼‰ï¼ŒåŒæ­¥å¯¼å‡ºä¼šå¯¼è‡´è¯·æ±‚è¶…æ—¶ã€‚æ¨èä½¿ç”¨å¼‚æ­¥å¯¼å‡ºæ–¹æ¡ˆï¼š\næ•´ä½“æ¶æ„ 1ç”¨æˆ·å‘èµ·å¯¼å‡ºè¯·æ±‚ 2 â†“ 3åˆ›å»ºå¯¼å‡ºä»»åŠ¡ï¼ˆè¿”å›ä»»åŠ¡IDï¼‰ 4 â†“ 5å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå¯¼å‡º 6 â†“ 7å¯¼å‡ºå®Œæˆåä¸Šä¼ åˆ° OSS 8 â†“ 9é€šçŸ¥ç”¨æˆ·ä¸‹è½½ å¯¼å‡ºä»»åŠ¡è¡¨ 1CREATE TABLE export_task ( 2 id BIGINT PRIMARY KEY AUTO_INCREMENT, 3 task_id VARCHAR(64) NOT NULL COMMENT \u0026#39;ä»»åŠ¡ID\u0026#39;, 4 file_name VARCHAR(255) NOT NULL COMMENT \u0026#39;æ–‡ä»¶å\u0026#39;, 5 status TINYINT NOT NULL COMMENT \u0026#39;çŠ¶æ€ï¼š0-å¾…å¤„ç†ï¼Œ1-å¤„ç†ä¸­ï¼Œ2-æˆåŠŸï¼Œ3-å¤±è´¥\u0026#39;, 6 total_count INT COMMENT \u0026#39;æ€»è®°å½•æ•°\u0026#39;, 7 exported_count INT COMMENT \u0026#39;å·²å¯¼å‡ºè®°å½•æ•°\u0026#39;, 8 file_url VARCHAR(512) COMMENT \u0026#39;æ–‡ä»¶ä¸‹è½½åœ°å€\u0026#39;, 9 error_msg VARCHAR(1000) COMMENT \u0026#39;é”™è¯¯ä¿¡æ¯\u0026#39;, 10 create_by VARCHAR(64) COMMENT \u0026#39;åˆ›å»ºäºº\u0026#39;, 11 create_time DATETIME NOT NULL, 12 update_time DATETIME NOT NULL, 13 INDEX idx_task_id (task_id), 14 INDEX idx_create_by (create_by) 15) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;å¯¼å‡ºä»»åŠ¡è¡¨\u0026#39;; å¼‚æ­¥å¯¼å‡ºå®ç° 1@Service 2@Slf4j 3public class AsyncExportService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 @Autowired 9 private ExportTaskMapper exportTaskMapper; 10 11 @Autowired 12 private OssService ossService; 13 14 @Autowired 15 private ThreadPoolExecutor exportExecutor; 16 17 /** 18 * åˆ›å»ºå¯¼å‡ºä»»åŠ¡ 19 */ 20 public String createExportTask(String userId) { 21 // ç”Ÿæˆä»»åŠ¡ ID 22 String taskId = UUID.randomUUID().toString().replace(\u0026#34;-\u0026#34;, \u0026#34;\u0026#34;); 23 24 // åˆ›å»ºä»»åŠ¡è®°å½• 25 ExportTask task = new ExportTask(); 26 task.setTaskId(taskId); 27 task.setFileName(\u0026#34;è®¢å•æ•°æ®_\u0026#34; + DateUtil.format(new Date(), \u0026#34;yyyyMMddHHmmss\u0026#34;) + \u0026#34;.xlsx\u0026#34;); 28 task.setStatus(0); // å¾…å¤„ç† 29 task.setCreateBy(userId); 30 task.setCreateTime(new Date()); 31 task.setUpdateTime(new Date()); 32 exportTaskMapper.insert(task); 33 34 // æäº¤å¼‚æ­¥ä»»åŠ¡ 35 exportExecutor.execute(() -\u0026gt; executeExport(taskId)); 36 37 return taskId; 38 } 39 40 /** 41 * æ‰§è¡Œå¯¼å‡º 42 */ 43 private void executeExport(String taskId) { 44 ExportTask task = exportTaskMapper.selectByTaskId(taskId); 45 46 try { 47 // æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­ 48 task.setStatus(1); 49 exportTaskMapper.updateById(task); 50 51 // åˆ›å»ºä¸´æ—¶æ–‡ä»¶ 52 String tempFilePath = \u0026#34;/tmp/\u0026#34; + task.getFileName(); 53 File tempFile = new File(tempFilePath); 54 55 // å¯¼å‡ºæ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶ 56 exportToFile(tempFile, task); 57 58 // ä¸Šä¼ åˆ° OSS 59 String fileUrl = ossService.upload(tempFile, \u0026#34;export/\u0026#34; + task.getFileName()); 60 61 // æ›´æ–°ä»»åŠ¡çŠ¶æ€ 62 task.setStatus(2); // æˆåŠŸ 63 task.setFileUrl(fileUrl); 64 task.setUpdateTime(new Date()); 65 exportTaskMapper.updateById(task); 66 67 // åˆ é™¤ä¸´æ—¶æ–‡ä»¶ 68 tempFile.delete(); 69 70 // å‘é€é€šçŸ¥ï¼ˆé‚®ä»¶ã€ç«™å†…ä¿¡ç­‰ï¼‰ 71 sendNotification(task); 72 73 log.info(\u0026#34;å¯¼å‡ºä»»åŠ¡ {} å®Œæˆ\u0026#34;, taskId); 74 75 } catch (Exception e) { 76 log.error(\u0026#34;å¯¼å‡ºä»»åŠ¡ {} å¤±è´¥\u0026#34;, taskId, e); 77 78 // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥ 79 task.setStatus(3); 80 task.setErrorMsg(e.getMessage()); 81 task.setUpdateTime(new Date()); 82 exportTaskMapper.updateById(task); 83 } 84 } 85 86 /** 87 * å¯¼å‡ºæ•°æ®åˆ°æ–‡ä»¶ 88 */ 89 private void exportToFile(File file, ExportTask task) throws IOException { 90 ExcelWriter excelWriter = null; 91 Cursor\u0026lt;OrderExportDTO\u0026gt; cursor = null; 92 93 try { 94 excelWriter = EasyExcel.write(file, OrderExportDTO.class).build(); 95 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 96 97 cursor = orderMapper.selectByCursor(1); 98 99 List\u0026lt;OrderExportDTO\u0026gt; batch = new ArrayList\u0026lt;\u0026gt;(10000); 100 int totalCount = 0; 101 int exportedCount = 0; 102 103 for (OrderExportDTO order : cursor) { 104 batch.add(order); 105 totalCount++; 106 107 if (batch.size() \u0026gt;= 10000) { 108 excelWriter.write(batch, writeSheet); 109 exportedCount += batch.size(); 110 batch.clear(); 111 112 // æ›´æ–°è¿›åº¦ 113 task.setTotalCount(totalCount); 114 task.setExportedCount(exportedCount); 115 task.setUpdateTime(new Date()); 116 exportTaskMapper.updateById(task); 117 118 log.info(\u0026#34;ä»»åŠ¡ {} å·²å¯¼å‡º {} æ¡æ•°æ®\u0026#34;, task.getTaskId(), exportedCount); 119 } 120 } 121 122 // å†™å…¥å‰©ä½™æ•°æ® 123 if (!batch.isEmpty()) { 124 excelWriter.write(batch, writeSheet); 125 exportedCount += batch.size(); 126 } 127 128 // æ›´æ–°æœ€ç»ˆè®¡æ•° 129 task.setTotalCount(totalCount); 130 task.setExportedCount(exportedCount); 131 task.setUpdateTime(new Date()); 132 exportTaskMapper.updateById(task); 133 134 } finally { 135 if (cursor != null) { 136 cursor.close(); 137 } 138 if (excelWriter != null) { 139 excelWriter.finish(); 140 } 141 } 142 } 143 144 /** 145 * æŸ¥è¯¢ä»»åŠ¡è¿›åº¦ 146 */ 147 public ExportTask queryProgress(String taskId) { 148 return exportTaskMapper.selectByTaskId(taskId); 149 } 150 151 /** 152 * å‘é€é€šçŸ¥ 153 */ 154 private void sendNotification(ExportTask task) { 155 // å‘é€é‚®ä»¶ã€ç«™å†…ä¿¡ç­‰ 156 log.info(\u0026#34;å‘é€å¯¼å‡ºå®Œæˆé€šçŸ¥ç»™ç”¨æˆ· {}\u0026#34;, task.getCreateBy()); 157 } 158} å‰ç«¯è½®è¯¢è¿›åº¦ 1// åˆ›å»ºå¯¼å‡ºä»»åŠ¡ 2async function createExportTask() { 3 const response = await fetch(\u0026#39;/api/export/create\u0026#39;, { 4 method: \u0026#39;POST\u0026#39; 5 }); 6 const data = await response.json(); 7 const taskId = data.taskId; 8 9 // å¼€å§‹è½®è¯¢è¿›åº¦ 10 pollProgress(taskId); 11} 12 13// è½®è¯¢è¿›åº¦ 14function pollProgress(taskId) { 15 const timer = setInterval(async () =\u0026gt; { 16 const response = await fetch(`/api/export/progress/${taskId}`); 17 const task = await response.json(); 18 19 // æ›´æ–°è¿›åº¦æ¡ 20 const progress = task.totalCount \u0026gt; 0 21 ? (task.exportedCount / task.totalCount * 100).toFixed(2) 22 : 0; 23 updateProgressBar(progress); 24 25 // æ£€æŸ¥çŠ¶æ€ 26 if (task.status === 2) { 27 // å¯¼å‡ºæˆåŠŸ 28 clearInterval(timer); 29 showDownloadLink(task.fileUrl); 30 } else if (task.status === 3) { 31 // å¯¼å‡ºå¤±è´¥ 32 clearInterval(timer); 33 showError(task.errorMsg); 34 } 35 }, 2000); // æ¯ 2 ç§’è½®è¯¢ä¸€æ¬¡ 36} æ€§èƒ½ä¼˜åŒ–æŠ€å·§ 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– 1/** 2 * åªæŸ¥è¯¢éœ€è¦å¯¼å‡ºçš„å­—æ®µ 3 */ 4@Select(\u0026#34;SELECT order_no, user_name, product_name, amount, status, create_time \u0026#34; + 5 \u0026#34;FROM t_order WHERE status = #{status}\u0026#34;) 6List\u0026lt;OrderExportDTO\u0026gt; selectForExport(@Param(\u0026#34;status\u0026#34;) Integer status); 7 8/** 9 * æ·»åŠ ç´¢å¼• 10 */ 11CREATE INDEX idx_status_create_time ON t_order(status, create_time); 2. çº¿ç¨‹æ± é…ç½® 1@Configuration 2public class ThreadPoolConfig { 3 4 @Bean(\u0026#34;exportExecutor\u0026#34;) 5 public ThreadPoolExecutor exportExecutor() { 6 return new ThreadPoolExecutor( 7 2, // æ ¸å¿ƒçº¿ç¨‹æ•° 8 5, // æœ€å¤§çº¿ç¨‹æ•° 9 60L, TimeUnit.SECONDS, 10 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 11 new ThreadFactoryBuilder() 12 .setNameFormat(\u0026#34;export-thread-%d\u0026#34;) 13 .build(), 14 new ThreadPoolExecutor.CallerRunsPolicy() 15 ); 16 } 17} 3. è‡ªå®šä¹‰æ ·å¼ 1/** 2 * è‡ªå®šä¹‰è¡¨å¤´æ ·å¼ 3 */ 4public class CustomCellWriteHandler implements CellWriteHandler { 5 6 @Override 7 public void afterCellDispose(WriteSheetHolder writeSheetHolder, 8 WriteTableHolder writeTableHolder, 9 List\u0026lt;WriteCellData\u0026lt;?\u0026gt;\u0026gt; cellDataList, 10 Cell cell, 11 Head head, 12 Integer relativeRowIndex, 13 Boolean isHead) { 14 if (isHead) { 15 // è®¾ç½®è¡¨å¤´æ ·å¼ 16 CellStyle cellStyle = cell.getSheet().getWorkbook().createCellStyle(); 17 cellStyle.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex()); 18 cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND); 19 20 Font font = cell.getSheet().getWorkbook().createFont(); 21 font.setBold(true); 22 font.setFontHeightInPoints((short) 12); 23 cellStyle.setFont(font); 24 25 cell.setCellStyle(cellStyle); 26 } 27 } 28} 29 30// ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼ 31EasyExcel.write(file, OrderExportDTO.class) 32 .registerWriteHandler(new CustomCellWriteHandler()) 33 .sheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;) 34 .doWrite(data); 4. æ•°æ®è½¬æ¢å™¨ 1/** 2 * è®¢å•çŠ¶æ€è½¬æ¢å™¨ 3 */ 4public class OrderStatusConverter implements Converter\u0026lt;Integer\u0026gt; { 5 6 private static final Map\u0026lt;Integer, String\u0026gt; STATUS_MAP = new HashMap\u0026lt;\u0026gt;(); 7 8 static { 9 STATUS_MAP.put(0, \u0026#34;å¾…æ”¯ä»˜\u0026#34;); 10 STATUS_MAP.put(1, \u0026#34;å·²æ”¯ä»˜\u0026#34;); 11 STATUS_MAP.put(2, \u0026#34;å·²å‘è´§\u0026#34;); 12 STATUS_MAP.put(3, \u0026#34;å·²å®Œæˆ\u0026#34;); 13 STATUS_MAP.put(4, \u0026#34;å·²å–æ¶ˆ\u0026#34;); 14 } 15 16 @Override 17 public Class\u0026lt;Integer\u0026gt; supportJavaTypeKey() { 18 return Integer.class; 19 } 20 21 @Override 22 public CellDataTypeEnum supportExcelTypeKey() { 23 return CellDataTypeEnum.STRING; 24 } 25 26 @Override 27 public WriteCellData\u0026lt;?\u0026gt; convertToExcelData(Integer value, ExcelContentProperty contentProperty, 28 GlobalConfiguration globalConfiguration) { 29 return new WriteCellData\u0026lt;\u0026gt;(STATUS_MAP.getOrDefault(value, \u0026#34;æœªçŸ¥\u0026#34;)); 30 } 31} 5. å†…å­˜ç›‘æ§ 1@Component 2@Slf4j 3public class MemoryMonitor { 4 5 @Scheduled(fixedRate = 5000) 6 public void monitorMemory() { 7 Runtime runtime = Runtime.getRuntime(); 8 long totalMemory = runtime.totalMemory(); 9 long freeMemory = runtime.freeMemory(); 10 long usedMemory = totalMemory - freeMemory; 11 long maxMemory = runtime.maxMemory(); 12 13 double usedPercent = (double) usedMemory / maxMemory * 100; 14 15 if (usedPercent \u0026gt; 80) { 16 log.warn(\u0026#34;å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼š{:.2f}%ï¼Œå·²ä½¿ç”¨ï¼š{}MBï¼Œæœ€å¤§ï¼š{}MB\u0026#34;, 17 usedPercent, 18 usedMemory / 1024 / 1024, 19 maxMemory / 1024 / 1024); 20 } 21 } 22} é¿å‘æç¤ºï¼š åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ï¼š1) é™åˆ¶å•æ¬¡å¯¼å‡ºçš„æœ€å¤§è®°å½•æ•°ï¼ˆå¦‚ 100 ä¸‡æ¡ï¼‰ï¼›2) è®¾ç½®å¯¼å‡ºä»»åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼›3) å®šæœŸæ¸…ç†è¿‡æœŸçš„å¯¼å‡ºæ–‡ä»¶ï¼›4) ç›‘æ§å¯¼å‡ºä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºï¼Œä»å†…å­˜é—®é¢˜åˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œæä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼š\nå†…å­˜ä¼˜åŒ–ï¼šä½¿ç”¨ EasyExcel æ›¿ä»£ä¼ ç»Ÿ POIï¼Œå†…å­˜å ç”¨é™ä½ 90% åˆ†æ‰¹å¤„ç†ï¼šé€šè¿‡åˆ†é¡µæŸ¥è¯¢æˆ–æ¸¸æ ‡æŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ® å¼‚æ­¥å¯¼å‡ºï¼šå¯¹äºè¶…å¤§æ•°æ®é‡ï¼Œä½¿ç”¨å¼‚æ­¥ä»»åŠ¡ + è¿›åº¦åé¦ˆ æ€§èƒ½è°ƒä¼˜ï¼šæ•°æ®åº“ä¼˜åŒ–ã€çº¿ç¨‹æ± é…ç½®ã€æ ·å¼å®šåˆ¶ç­‰ ç”Ÿäº§å®è·µï¼šä»»åŠ¡ç®¡ç†ã€æ–‡ä»¶å­˜å‚¨ã€é€šçŸ¥æœºåˆ¶ç­‰ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦è€ƒè™‘ï¼š\næ•°æ®å®‰å…¨ï¼šå¯¼å‡ºæ–‡ä»¶çš„è®¿é—®æƒé™æ§åˆ¶ å¹¶å‘æ§åˆ¶ï¼šé™åˆ¶åŒæ—¶æ‰§è¡Œçš„å¯¼å‡ºä»»åŠ¡æ•°é‡ èµ„æºéš”ç¦»ï¼šå¯¼å‡ºä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥æ±  ç›‘æ§å‘Šè­¦ï¼šå¯¼å‡ºå¤±è´¥ç‡ã€å¹³å‡è€—æ—¶ç­‰æŒ‡æ ‡ ä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°å¤§æ•°æ®é‡å¯¼å‡ºåŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯• EasyExcel è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ã€‚\n","permalink":"http://localhost:1313/posts/2025/05/easyexcel-%E7%99%BE%E4%B8%87%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E7%9A%84%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¤§æ•°æ®é‡å¯¼å‡ºæ˜¯ä¸€ä¸ªå¸¸è§ä½†æ£˜æ‰‹çš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„ Apache POI åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºï¼Œè€Œé˜¿é‡Œå¼€æºçš„ EasyExcel é€šè¿‡ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œå¯ä»¥è½»æ¾å¤„ç†ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…é—®é¢˜å‡ºå‘ï¼Œæ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°é«˜æ€§èƒ½çš„å¤§æ•°æ®é‡å¯¼å‡ºï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¼˜åŒ–ç»éªŒã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ EasyExcel çš„æ ¸å¿ƒåŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¼‚æ­¥å¯¼å‡ºä¸è¿›åº¦åé¦ˆæ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¼ ç»Ÿ-poi-çš„å†…å­˜é—®é¢˜\"\u003eä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜åœºæ™¯\"\u003eé—®é¢˜åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿéœ€è¦å¯¼å‡ºè®¢å•æ•°æ®ï¼Œæ•°æ®é‡è¾¾åˆ° 100 ä¸‡æ¡ã€‚ä½¿ç”¨ä¼ ç»Ÿçš„ Apache POI å®ç°ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// ä¼ ç»Ÿ POI å®ç°ï¼ˆæœ‰é—®é¢˜çš„ä»£ç ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eexportOrders\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eWorkbook\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eXSSFWorkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eSheet\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003esheet\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateSheet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;è®¢å•æ•°æ®\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æŸ¥è¯¢ 100 ä¸‡æ¡æ•°æ®\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectAll\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å†™å…¥ Excel\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eRow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003esheet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateRow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateCell\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003esetCellValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetOrderNo\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateCell\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003esetCellValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserName\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ... æ›´å¤šå­—æ®µ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è¾“å‡ºæ–‡ä»¶\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eFileOutputStream\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eFileOutputStream\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;orders.xlsx\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"å†…å­˜åˆ†æ\"\u003eå†…å­˜åˆ†æ\u003c/h3\u003e\n\u003cp\u003eè¿™æ®µä»£ç å­˜åœ¨ä¸¥é‡çš„å†…å­˜é—®é¢˜ï¼š\u003c/p\u003e","title":"EasyExcel ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„å†…å­˜ä¼˜åŒ–å®æˆ˜"},{"content":"åœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå®æ—¶æ¶ˆæ¯æ¨é€å·²æˆä¸ºæ ‡é…åŠŸèƒ½ã€‚ä»å³æ—¶é€šè®¯ã€åœ¨çº¿å®¢æœåˆ°å®æ—¶ç›‘æ§å¤§å±ï¼Œéƒ½ç¦»ä¸å¼€é«˜æ€§èƒ½çš„æ¶ˆæ¯æ¨é€èƒ½åŠ›ã€‚ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼å­˜åœ¨å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹ç­‰é—®é¢˜ï¼Œè€Œ WebSocket åè®®çš„å‡ºç°å®Œç¾è§£å†³äº†è¿™äº›ç—›ç‚¹ã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty æ¡†æ¶å®ç°åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜ï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¨é€æœåŠ¡ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ WebSocket åè®®åŸç†ä¸æ¡æ‰‹æµç¨‹ å­¦ä¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨ ç†è§£å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ç®¡ç†ç­–ç•¥ æŒæ¡é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±æ–¹æ¡ˆ äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§ ä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket WebSocket åè®®ä¼˜åŠ¿ ç›¸æ¯”ä¼ ç»Ÿçš„ HTTP è½®è¯¢ï¼ŒWebSocket å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\nç‰¹æ€§ HTTP è½®è¯¢ WebSocket é€šä¿¡æ–¹å¼ åŠåŒå·¥ å…¨åŒå·¥ è¿æ¥å¼€é”€ æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥ ä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥ å®æ—¶æ€§ å–å†³äºè½®è¯¢é—´éš”ï¼ˆç§’çº§ï¼‰ æ¯«ç§’çº§ æœåŠ¡å™¨å‹åŠ› é«˜ï¼ˆé¢‘ç¹çš„ HTTP è¯·æ±‚ï¼‰ ä½ï¼ˆé•¿è¿æ¥ï¼‰ å¸¦å®½æ¶ˆè€— é«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰ HTTP å¤´ï¼‰ ä½ï¼ˆåªä¼ è¾“æ•°æ®å¸§ï¼‰ Netty æ¡†æ¶ä¼˜åŠ¿ Netty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\né«˜æ€§èƒ½ï¼šåŸºäº NIOï¼Œæ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥ æ˜“ç”¨æ€§ï¼šæä¾›äº†ä¸°å¯Œçš„ç¼–è§£ç å™¨å’Œå¤„ç†å™¨ ç¨³å®šæ€§ï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯ æ‰©å±•æ€§ï¼šçµæ´»çš„ Pipeline æœºåˆ¶ æ¶æ„æ€è€ƒï¼š é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œä¸ä»…è¦çœ‹æŠ€æœ¯æœ¬èº«çš„ä¼˜åŠ¿ï¼Œæ›´è¦è€ƒè™‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€è¿ç»´æˆæœ¬å’Œç¤¾åŒºç”Ÿæ€ã€‚Netty åœ¨ Java ç”Ÿæ€ä¸­å·²ç»æˆä¸ºäº‹å®æ ‡å‡†ï¼ŒDubboã€RocketMQã€Elasticsearch ç­‰çŸ¥åé¡¹ç›®éƒ½åœ¨ä½¿ç”¨ã€‚\nWebSocket åè®®åŸç† æ¡æ‰‹æµç¨‹ WebSocket åŸºäº HTTP åè®®è¿›è¡Œæ¡æ‰‹ï¼Œç„¶åå‡çº§ä¸º WebSocket åè®®ï¼š\n1å®¢æˆ·ç«¯è¯·æ±‚ï¼š 2GET /chat HTTP/1.1 3Host: server.example.com 4Upgrade: websocket 5Connection: Upgrade 6Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ== 7Sec-WebSocket-Version: 13 8 9æœåŠ¡ç«¯å“åº”ï¼š 10HTTP/1.1 101 Switching Protocols 11Upgrade: websocket 12Connection: Upgrade 13Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo= æ•°æ®å¸§æ ¼å¼ WebSocket ä½¿ç”¨å¸§ï¼ˆFrameï¼‰æ¥ä¼ è¾“æ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ï¼š\næ–‡æœ¬å¸§ï¼šä¼ è¾“ UTF-8 ç¼–ç çš„æ–‡æœ¬ äºŒè¿›åˆ¶å¸§ï¼šä¼ è¾“äºŒè¿›åˆ¶æ•°æ® æ§åˆ¶å¸§ï¼šPingã€Pongã€Close Netty WebSocket æœåŠ¡å™¨å®ç° é¡¹ç›®ä¾èµ– 1\u0026lt;dependencies\u0026gt; 2 \u0026lt;!-- Netty --\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;io.netty\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;netty-all\u0026lt;/artifactId\u0026gt; 6 \u0026lt;version\u0026gt;4.1.100.Final\u0026lt;/version\u0026gt; 7 \u0026lt;/dependency\u0026gt; 8 9 \u0026lt;!-- JSON å¤„ç† --\u0026gt; 10 \u0026lt;dependency\u0026gt; 11 \u0026lt;groupId\u0026gt;com.alibaba.fastjson2\u0026lt;/groupId\u0026gt; 12 \u0026lt;artifactId\u0026gt;fastjson2\u0026lt;/artifactId\u0026gt; 13 \u0026lt;version\u0026gt;2.0.43\u0026lt;/version\u0026gt; 14 \u0026lt;/dependency\u0026gt; 15\u0026lt;/dependencies\u0026gt; æœåŠ¡å™¨å¯åŠ¨ç±» 1@Slf4j 2@Component 3public class WebSocketServer { 4 5 private final int port = 8888; 6 private EventLoopGroup bossGroup; 7 private EventLoopGroup workerGroup; 8 9 @PostConstruct 10 public void start() throws InterruptedException { 11 bossGroup = new NioEventLoopGroup(1); 12 workerGroup = new NioEventLoopGroup(); 13 14 try { 15 ServerBootstrap bootstrap = new ServerBootstrap(); 16 bootstrap.group(bossGroup, workerGroup) 17 .channel(NioServerSocketChannel.class) 18 .childHandler(new WebSocketChannelInitializer()) 19 .option(ChannelOption.SO_BACKLOG, 128) 20 .childOption(ChannelOption.SO_KEEPALIVE, true); 21 22 ChannelFuture future = bootstrap.bind(port).sync(); 23 log.info(\u0026#34;WebSocket æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç«¯å£ï¼š{}\u0026#34;, port); 24 25 // ç­‰å¾…æœåŠ¡å™¨å…³é—­ 26 future.channel().closeFuture().sync(); 27 } finally { 28 shutdown(); 29 } 30 } 31 32 @PreDestroy 33 public void shutdown() { 34 if (bossGroup != null) { 35 bossGroup.shutdownGracefully(); 36 } 37 if (workerGroup != null) { 38 workerGroup.shutdownGracefully(); 39 } 40 log.info(\u0026#34;WebSocket æœåŠ¡å™¨å·²å…³é—­\u0026#34;); 41 } 42} Channel åˆå§‹åŒ–å™¨ 1public class WebSocketChannelInitializer extends ChannelInitializer\u0026lt;SocketChannel\u0026gt; { 2 3 @Override 4 protected void initChannel(SocketChannel ch) { 5 ChannelPipeline pipeline = ch.pipeline(); 6 7 // HTTP ç¼–è§£ç å™¨ 8 pipeline.addLast(new HttpServerCodec()); 9 // HTTP èšåˆå™¨ï¼ˆå°†å¤šä¸ª HTTP æ¶ˆæ¯èšåˆæˆä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼‰ 10 pipeline.addLast(new HttpObjectAggregator(65536)); 11 // HTTP å‹ç¼© 12 pipeline.addLast(new HttpContentCompressor()); 13 14 // WebSocket åè®®å¤„ç†å™¨ï¼ˆå¤„ç†æ¡æ‰‹ã€Closeã€Pingã€Pongï¼‰ 15 pipeline.addLast(new WebSocketServerProtocolHandler(\u0026#34;/ws\u0026#34;, null, true)); 16 17 // å¿ƒè·³æ£€æµ‹ï¼ˆè¯»ç©ºé—² 60 ç§’ï¼Œå†™ç©ºé—² 0 ç§’ï¼Œè¯»å†™ç©ºé—² 0 ç§’ï¼‰ 18 pipeline.addLast(new IdleStateHandler(60, 0, 0, TimeUnit.SECONDS)); 19 20 // è‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†å™¨ 21 pipeline.addLast(new WebSocketHandler()); 22 } 23} ä¸šåŠ¡å¤„ç†å™¨ 1@Slf4j 2@ChannelHandler.Sharable 3public class WebSocketHandler extends SimpleChannelInboundHandler\u0026lt;TextWebSocketFrame\u0026gt; { 4 5 @Override 6 public void channelActive(ChannelHandlerContext ctx) { 7 // è¿æ¥å»ºç«‹æ—¶ 8 Channel channel = ctx.channel(); 9 log.info(\u0026#34;å®¢æˆ·ç«¯è¿æ¥ï¼š{}\u0026#34;, channel.id().asShortText()); 10 11 // å°† Channel åŠ å…¥ç®¡ç†å™¨ 12 ChannelManager.addChannel(channel); 13 } 14 15 @Override 16 protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) { 17 // æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ 18 String content = msg.text(); 19 log.info(\u0026#34;æ”¶åˆ°æ¶ˆæ¯ï¼š{}\u0026#34;, content); 20 21 // è§£ææ¶ˆæ¯ 22 Message message = JSON.parseObject(content, Message.class); 23 24 // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ 25 switch (message.getType()) { 26 case \u0026#34;auth\u0026#34;: 27 handleAuth(ctx, message); 28 break; 29 case \u0026#34;heartbeat\u0026#34;: 30 handleHeartbeat(ctx); 31 break; 32 case \u0026#34;message\u0026#34;: 33 handleMessage(ctx, message); 34 break; 35 default: 36 log.warn(\u0026#34;æœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼š{}\u0026#34;, message.getType()); 37 } 38 } 39 40 @Override 41 public void channelInactive(ChannelHandlerContext ctx) { 42 // è¿æ¥æ–­å¼€æ—¶ 43 Channel channel = ctx.channel(); 44 log.info(\u0026#34;å®¢æˆ·ç«¯æ–­å¼€ï¼š{}\u0026#34;, channel.id().asShortText()); 45 46 // ä»ç®¡ç†å™¨ä¸­ç§»é™¤ 47 ChannelManager.removeChannel(channel); 48 } 49 50 @Override 51 public void userEventTriggered(ChannelHandlerContext ctx, Object evt) { 52 // å¤„ç†ç©ºé—²äº‹ä»¶ 53 if (evt instanceof IdleStateEvent) { 54 IdleStateEvent event = (IdleStateEvent) evt; 55 if (event.state() == IdleState.READER_IDLE) { 56 log.warn(\u0026#34;å®¢æˆ·ç«¯ {} è¯»ç©ºé—²ï¼Œå…³é—­è¿æ¥\u0026#34;, ctx.channel().id().asShortText()); 57 ctx.close(); 58 } 59 } 60 } 61 62 @Override 63 public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) { 64 log.error(\u0026#34;è¿æ¥å¼‚å¸¸ï¼š{}\u0026#34;, cause.getMessage(), cause); 65 ctx.close(); 66 } 67 68 /** 69 * å¤„ç†è®¤è¯æ¶ˆæ¯ 70 */ 71 private void handleAuth(ChannelHandlerContext ctx, Message message) { 72 String userId = message.getUserId(); 73 Channel channel = ctx.channel(); 74 75 // ç»‘å®šç”¨æˆ· ID å’Œ Channel 76 ChannelManager.bindUser(userId, channel); 77 78 // å‘é€è®¤è¯æˆåŠŸæ¶ˆæ¯ 79 Message response = Message.builder() 80 .type(\u0026#34;auth_response\u0026#34;) 81 .content(\u0026#34;è®¤è¯æˆåŠŸ\u0026#34;) 82 .build(); 83 ctx.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(response))); 84 85 log.info(\u0026#34;ç”¨æˆ· {} è®¤è¯æˆåŠŸ\u0026#34;, userId); 86 } 87 88 /** 89 * å¤„ç†å¿ƒè·³æ¶ˆæ¯ 90 */ 91 private void handleHeartbeat(ChannelHandlerContext ctx) { 92 Message response = Message.builder() 93 .type(\u0026#34;heartbeat_response\u0026#34;) 94 .content(\u0026#34;pong\u0026#34;) 95 .build(); 96 ctx.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(response))); 97 } 98 99 /** 100 * å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ 101 */ 102 private void handleMessage(ChannelHandlerContext ctx, Message message) { 103 // æ ¹æ®ä¸šåŠ¡é€»è¾‘å¤„ç†æ¶ˆæ¯ 104 log.info(\u0026#34;å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ï¼š{}\u0026#34;, message.getContent()); 105 106 // ç¤ºä¾‹ï¼šå¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ· 107 ChannelManager.broadcast(message); 108 } 109} è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯æ¨é€ Channel ç®¡ç†å™¨ 1@Slf4j 2public class ChannelManager { 3 4 // æ‰€æœ‰è¿æ¥çš„ Channel 5 private static final ChannelGroup CHANNELS = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE); 6 7 // ç”¨æˆ· ID ä¸ Channel çš„æ˜ å°„ 8 private static final ConcurrentHashMap\u0026lt;String, Channel\u0026gt; USER_CHANNELS = new ConcurrentHashMap\u0026lt;\u0026gt;(); 9 10 /** 11 * æ·»åŠ  Channel 12 */ 13 public static void addChannel(Channel channel) { 14 CHANNELS.add(channel); 15 log.info(\u0026#34;å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}\u0026#34;, CHANNELS.size()); 16 } 17 18 /** 19 * ç§»é™¤ Channel 20 */ 21 public static void removeChannel(Channel channel) { 22 CHANNELS.remove(channel); 23 24 // ç§»é™¤ç”¨æˆ·ç»‘å®š 25 USER_CHANNELS.entrySet().removeIf(entry -\u0026gt; entry.getValue().equals(channel)); 26 27 log.info(\u0026#34;å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}\u0026#34;, CHANNELS.size()); 28 } 29 30 /** 31 * ç»‘å®šç”¨æˆ·å’Œ Channel 32 */ 33 public static void bindUser(String userId, Channel channel) { 34 USER_CHANNELS.put(userId, channel); 35 log.info(\u0026#34;ç”¨æˆ· {} ç»‘å®šæˆåŠŸï¼Œå½“å‰åœ¨çº¿ç”¨æˆ·æ•°ï¼š{}\u0026#34;, userId, USER_CHANNELS.size()); 36 } 37 38 /** 39 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ· 40 */ 41 public static void pushToUser(String userId, Message message) { 42 Channel channel = USER_CHANNELS.get(userId); 43 if (channel != null \u0026amp;\u0026amp; channel.isActive()) { 44 channel.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(message))); 45 log.info(\u0026#34;æ¨é€æ¶ˆæ¯ç»™ç”¨æˆ· {}ï¼š{}\u0026#34;, userId, message.getContent()); 46 } else { 47 log.warn(\u0026#34;ç”¨æˆ· {} ä¸åœ¨çº¿æˆ–è¿æ¥å·²æ–­å¼€\u0026#34;, userId); 48 } 49 } 50 51 /** 52 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ· 53 */ 54 public static void broadcast(Message message) { 55 TextWebSocketFrame frame = new TextWebSocketFrame(JSON.toJSONString(message)); 56 CHANNELS.writeAndFlush(frame); 57 log.info(\u0026#34;å¹¿æ’­æ¶ˆæ¯ç»™ {} ä¸ªç”¨æˆ·ï¼š{}\u0026#34;, CHANNELS.size(), message.getContent()); 58 } 59 60 /** 61 * è·å–åœ¨çº¿ç”¨æˆ·æ•° 62 */ 63 public static int getOnlineUserCount() { 64 return USER_CHANNELS.size(); 65 } 66} æ¶ˆæ¯æ¨é€æœåŠ¡ 1@Slf4j 2@Service 3public class MessagePushService { 4 5 /** 6 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ· 7 */ 8 public void pushToUser(String userId, String content) { 9 Message message = Message.builder() 10 .type(\u0026#34;push\u0026#34;) 11 .content(content) 12 .timestamp(System.currentTimeMillis()) 13 .build(); 14 15 ChannelManager.pushToUser(userId, message); 16 } 17 18 /** 19 * æ¨é€æ¶ˆæ¯ç»™å¤šä¸ªç”¨æˆ· 20 */ 21 public void pushToUsers(List\u0026lt;String\u0026gt; userIds, String content) { 22 Message message = Message.builder() 23 .type(\u0026#34;push\u0026#34;) 24 .content(content) 25 .timestamp(System.currentTimeMillis()) 26 .build(); 27 28 userIds.forEach(userId -\u0026gt; ChannelManager.pushToUser(userId, message)); 29 } 30 31 /** 32 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ· 33 */ 34 public void broadcast(String content) { 35 Message message = Message.builder() 36 .type(\u0026#34;broadcast\u0026#34;) 37 .content(content) 38 .timestamp(System.currentTimeMillis()) 39 .build(); 40 41 ChannelManager.broadcast(message); 42 } 43} å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ä¿æ´» ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³ åœ¨é•¿è¿æ¥åœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nç½‘ç»œä¸­æ–­æ£€æµ‹ï¼šç½‘ç»œå¼‚å¸¸æ—¶ï¼ŒTCP è¿æ¥ä¸ä¼šç«‹å³æ–­å¼€ NAT è¶…æ—¶ï¼šNAT è®¾å¤‡ä¼šæ¸…ç†é•¿æ—¶é—´æ— æ•°æ®ä¼ è¾“çš„è¿æ¥ è´Ÿè½½å‡è¡¡è¶…æ—¶ï¼šè´Ÿè½½å‡è¡¡å™¨å¯èƒ½ä¼šå…³é—­ç©ºé—²è¿æ¥ å¿ƒè·³å®ç°æ–¹æ¡ˆ æœåŠ¡ç«¯å¿ƒè·³æ£€æµ‹ï¼š\n1// åœ¨ ChannelInitializer ä¸­æ·»åŠ  2pipeline.addLast(new IdleStateHandler(60, 0, 0, TimeUnit.SECONDS)); å®¢æˆ·ç«¯å¿ƒè·³å‘é€ï¼ˆJavaScript ç¤ºä¾‹ï¼‰ï¼š\n1class WebSocketClient { 2 constructor(url) { 3 this.url = url; 4 this.ws = null; 5 this.heartbeatTimer = null; 6 this.reconnectTimer = null; 7 } 8 9 connect() { 10 this.ws = new WebSocket(this.url); 11 12 this.ws.onopen = () =\u0026gt; { 13 console.log(\u0026#39;WebSocket è¿æ¥æˆåŠŸ\u0026#39;); 14 this.startHeartbeat(); 15 16 // å‘é€è®¤è¯æ¶ˆæ¯ 17 this.send({ 18 type: \u0026#39;auth\u0026#39;, 19 userId: \u0026#39;user123\u0026#39;, 20 token: \u0026#39;xxx\u0026#39; 21 }); 22 }; 23 24 this.ws.onmessage = (event) =\u0026gt; { 25 const message = JSON.parse(event.data); 26 console.log(\u0026#39;æ”¶åˆ°æ¶ˆæ¯ï¼š\u0026#39;, message); 27 28 // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ 29 switch (message.type) { 30 case \u0026#39;auth_response\u0026#39;: 31 console.log(\u0026#39;è®¤è¯æˆåŠŸ\u0026#39;); 32 break; 33 case \u0026#39;push\u0026#39;: 34 this.handlePush(message); 35 break; 36 case \u0026#39;heartbeat_response\u0026#39;: 37 // æ”¶åˆ°å¿ƒè·³å“åº” 38 break; 39 } 40 }; 41 42 this.ws.onclose = () =\u0026gt; { 43 console.log(\u0026#39;WebSocket è¿æ¥å…³é—­\u0026#39;); 44 this.stopHeartbeat(); 45 this.reconnect(); 46 }; 47 48 this.ws.onerror = (error) =\u0026gt; { 49 console.error(\u0026#39;WebSocket é”™è¯¯ï¼š\u0026#39;, error); 50 }; 51 } 52 53 send(message) { 54 if (this.ws \u0026amp;\u0026amp; this.ws.readyState === WebSocket.OPEN) { 55 this.ws.send(JSON.stringify(message)); 56 } 57 } 58 59 startHeartbeat() { 60 this.heartbeatTimer = setInterval(() =\u0026gt; { 61 this.send({ 62 type: \u0026#39;heartbeat\u0026#39;, 63 timestamp: Date.now() 64 }); 65 }, 30000); // æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ 66 } 67 68 stopHeartbeat() { 69 if (this.heartbeatTimer) { 70 clearInterval(this.heartbeatTimer); 71 this.heartbeatTimer = null; 72 } 73 } 74 75 reconnect() { 76 if (this.reconnectTimer) { 77 return; 78 } 79 80 this.reconnectTimer = setTimeout(() =\u0026gt; { 81 console.log(\u0026#39;å°è¯•é‡æ–°è¿æ¥...\u0026#39;); 82 this.reconnectTimer = null; 83 this.connect(); 84 }, 5000); // 5 ç§’åé‡è¿ 85 } 86 87 handlePush(message) { 88 // å¤„ç†æ¨é€æ¶ˆæ¯ 89 console.log(\u0026#39;æ”¶åˆ°æ¨é€ï¼š\u0026#39;, message.content); 90 } 91 92 close() { 93 this.stopHeartbeat(); 94 if (this.ws) { 95 this.ws.close(); 96 } 97 } 98} 99 100// ä½¿ç”¨ç¤ºä¾‹ 101const client = new WebSocketClient(\u0026#39;ws://localhost:8888/ws\u0026#39;); 102client.connect(); é¿å‘æç¤ºï¼š å¿ƒè·³é—´éš”çš„è®¾ç½®éœ€è¦æƒè¡¡ï¼šé—´éš”å¤ªçŸ­ä¼šå¢åŠ æœåŠ¡å™¨å‹åŠ›ï¼Œé—´éš”å¤ªé•¿å¯èƒ½æ— æ³•åŠæ—¶å‘ç°è¿æ¥æ–­å¼€ã€‚å»ºè®®å®¢æˆ·ç«¯å¿ƒè·³é—´éš”ä¸º 30 ç§’ï¼ŒæœåŠ¡ç«¯è¶…æ—¶æ—¶é—´ä¸º 60 ç§’ã€‚\né›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”± å•æœºæ¶æ„çš„å±€é™ å•æœº WebSocket æœåŠ¡å™¨å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nè¿æ¥æ•°é™åˆ¶ï¼šå•æœºæœ€å¤šæ”¯æŒå‡ ä¸‡åˆ°åå‡ ä¸‡è¿æ¥ å•ç‚¹æ•…éšœï¼šæœåŠ¡å™¨å®•æœºå¯¼è‡´æ‰€æœ‰è¿æ¥æ–­å¼€ æ¶ˆæ¯è·¯ç”±ï¼šæ— æ³•æ¨é€æ¶ˆæ¯ç»™å…¶ä»–æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ· é›†ç¾¤æ¶æ„æ–¹æ¡ˆ 1 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2 â”‚ Nginx â”‚ 3 â”‚ (è´Ÿè½½å‡è¡¡) â”‚ 4 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ 5 â”‚ 6 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 7 â”‚ â”‚ â”‚ 8 â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” 9 â”‚ WS Serverâ”‚ â”‚ WS Serverâ”‚ â”‚ WS Serverâ”‚ 10 â”‚ Node1 â”‚ â”‚ Node2 â”‚ â”‚ Node3 â”‚ 11 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ 12 â”‚ â”‚ â”‚ 13 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 14 â”‚ 15 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” 16 â”‚ Redis â”‚ 17 â”‚ (æ¶ˆæ¯è·¯ç”±) â”‚ 18 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Nginx é…ç½® 1upstream websocket { 2 # IP Hash ç­–ç•¥ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·è¿æ¥åˆ°åŒä¸€å°æœåŠ¡å™¨ 3 ip_hash; 4 5 server 192.168.1.101:8888; 6 server 192.168.1.102:8888; 7 server 192.168.1.103:8888; 8} 9 10server { 11 listen 80; 12 server_name ws.example.com; 13 14 location /ws { 15 proxy_pass http://websocket; 16 proxy_http_version 1.1; 17 proxy_set_header Upgrade $http_upgrade; 18 proxy_set_header Connection \u0026#34;upgrade\u0026#34;; 19 proxy_set_header Host $host; 20 proxy_set_header X-Real-IP $remote_addr; 21 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 22 23 # è¶…æ—¶è®¾ç½® 24 proxy_connect_timeout 60s; 25 proxy_send_timeout 60s; 26 proxy_read_timeout 60s; 27 } 28} Redis æ¶ˆæ¯è·¯ç”± 1@Slf4j 2@Component 3public class RedisMessageRouter { 4 5 @Autowired 6 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 7 8 private static final String CHANNEL_PREFIX = \u0026#34;ws:message:\u0026#34;; 9 10 @PostConstruct 11 public void init() { 12 // è®¢é˜… Redis é¢‘é“ 13 redisTemplate.getConnectionFactory().getConnection() 14 .subscribe((message, pattern) -\u0026gt; { 15 String msg = new String(message.getBody()); 16 handleMessage(msg); 17 }, (CHANNEL_PREFIX + \u0026#34;*\u0026#34;).getBytes()); 18 } 19 20 /** 21 * å‘å¸ƒæ¶ˆæ¯åˆ° Redis 22 */ 23 public void publish(String userId, Message message) { 24 String channel = CHANNEL_PREFIX + userId; 25 redisTemplate.convertAndSend(channel, JSON.toJSONString(message)); 26 } 27 28 /** 29 * å¤„ç†ä» Redis æ¥æ”¶åˆ°çš„æ¶ˆæ¯ 30 */ 31 private void handleMessage(String msg) { 32 Message message = JSON.parseObject(msg, Message.class); 33 String userId = message.getUserId(); 34 35 // å¦‚æœç”¨æˆ·åœ¨æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥æ¨é€ 36 ChannelManager.pushToUser(userId, message); 37 } 38} æ”¹è¿›çš„æ¨é€æœåŠ¡ 1@Slf4j 2@Service 3public class ClusterMessagePushService { 4 5 @Autowired 6 private RedisMessageRouter redisMessageRouter; 7 8 @Autowired 9 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 10 11 /** 12 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰ 13 */ 14 public void pushToUser(String userId, String content) { 15 Message message = Message.builder() 16 .type(\u0026#34;push\u0026#34;) 17 .userId(userId) 18 .content(content) 19 .timestamp(System.currentTimeMillis()) 20 .build(); 21 22 // å…ˆå°è¯•æœ¬åœ°æ¨é€ 23 Channel channel = ChannelManager.getUserChannel(userId); 24 if (channel != null \u0026amp;\u0026amp; channel.isActive()) { 25 ChannelManager.pushToUser(userId, message); 26 } else { 27 // ç”¨æˆ·ä¸åœ¨æœ¬èŠ‚ç‚¹ï¼Œé€šè¿‡ Redis è·¯ç”± 28 redisMessageRouter.publish(userId, message); 29 } 30 } 31 32 /** 33 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰ 34 */ 35 public void broadcast(String content) { 36 Message message = Message.builder() 37 .type(\u0026#34;broadcast\u0026#34;) 38 .content(content) 39 .timestamp(System.currentTimeMillis()) 40 .build(); 41 42 // å‘å¸ƒåˆ° Redis å¹¿æ’­é¢‘é“ 43 redisTemplate.convertAndSend(\u0026#34;ws:broadcast\u0026#34;, JSON.toJSONString(message)); 44 } 45} æ¶æ„æ€è€ƒï¼š åœ¨é›†ç¾¤æ¶æ„ä¸­ï¼Œæ¶ˆæ¯è·¯ç”±æ˜¯æ ¸å¿ƒé—®é¢˜ã€‚é™¤äº† Redis Pub/Subï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ RocketMQã€Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—ã€‚é€‰æ‹©æ—¶éœ€è¦è€ƒè™‘ï¼š1) æ¶ˆæ¯å¯é æ€§è¦æ±‚ï¼›2) æ¶ˆæ¯é¡ºåºæ€§è¦æ±‚ï¼›3) ç³»ç»Ÿå¤æ‚åº¦ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜ä½†å¯é æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼ŒRedis Pub/Sub æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚\nç”Ÿäº§ç¯å¢ƒä¼˜åŒ– æ€§èƒ½ä¼˜åŒ– 1. çº¿ç¨‹æ± é…ç½®\n1// Boss çº¿ç¨‹ç»„ï¼šå¤„ç†è¿æ¥è¯·æ±‚ 2EventLoopGroup bossGroup = new NioEventLoopGroup(1); 3 4// Worker çº¿ç¨‹ç»„ï¼šå¤„ç† I/O æ“ä½œ 5// é»˜è®¤çº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2 6EventLoopGroup workerGroup = new NioEventLoopGroup(); 7 8// ä¸šåŠ¡çº¿ç¨‹æ± ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ 9ThreadPoolExecutor businessExecutor = new ThreadPoolExecutor( 10 10, 50, 60L, TimeUnit.SECONDS, 11 new LinkedBlockingQueue\u0026lt;\u0026gt;(1000), 12 new ThreadFactoryBuilder().setNameFormat(\u0026#34;business-%d\u0026#34;).build(), 13 new ThreadPoolExecutor.CallerRunsPolicy() 14); 2. å†…å­˜ä¼˜åŒ–\n1// ä½¿ç”¨æ± åŒ–çš„ ByteBuf 2bootstrap.option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); 3bootstrap.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); 4 5// è®¾ç½®æ¥æ”¶ç¼“å†²åŒºå¤§å° 6bootstrap.childOption(ChannelOption.RCVBUF_ALLOCATOR, 7 new AdaptiveRecvByteBufAllocator(64, 1024, 65536)); 3. è¿æ¥æ•°ä¼˜åŒ–\n1// å¢åŠ  TCP è¿æ¥é˜Ÿåˆ—é•¿åº¦ 2bootstrap.option(ChannelOption.SO_BACKLOG, 1024); 3 4// å¯ç”¨ TCP_NODELAYï¼ˆç¦ç”¨ Nagle ç®—æ³•ï¼‰ 5bootstrap.childOption(ChannelOption.TCP_NODELAY, true); 6 7// å¯ç”¨ SO_KEEPALIVE 8bootstrap.childOption(ChannelOption.SO_KEEPALIVE, true); ç›‘æ§æŒ‡æ ‡ 1@Component 2public class WebSocketMetrics { 3 4 private final AtomicLong totalConnections = new AtomicLong(0); 5 private final AtomicLong activeConnections = new AtomicLong(0); 6 private final AtomicLong totalMessages = new AtomicLong(0); 7 8 /** 9 * è®°å½•è¿æ¥å»ºç«‹ 10 */ 11 public void recordConnect() { 12 totalConnections.incrementAndGet(); 13 activeConnections.incrementAndGet(); 14 } 15 16 /** 17 * è®°å½•è¿æ¥æ–­å¼€ 18 */ 19 public void recordDisconnect() { 20 activeConnections.decrementAndGet(); 21 } 22 23 /** 24 * è®°å½•æ¶ˆæ¯å‘é€ 25 */ 26 public void recordMessage() { 27 totalMessages.incrementAndGet(); 28 } 29 30 /** 31 * è·å–ç›‘æ§æ•°æ® 32 */ 33 public Map\u0026lt;String, Object\u0026gt; getMetrics() { 34 Map\u0026lt;String, Object\u0026gt; metrics = new HashMap\u0026lt;\u0026gt;(); 35 metrics.put(\u0026#34;totalConnections\u0026#34;, totalConnections.get()); 36 metrics.put(\u0026#34;activeConnections\u0026#34;, activeConnections.get()); 37 metrics.put(\u0026#34;totalMessages\u0026#34;, totalMessages.get()); 38 metrics.put(\u0026#34;onlineUsers\u0026#34;, ChannelManager.getOnlineUserCount()); 39 return metrics; 40 } 41} å®‰å…¨åŠ å›º 1. è®¤è¯é‰´æƒ\n1private void handleAuth(ChannelHandlerContext ctx, Message message) { 2 String token = message.getToken(); 3 4 // éªŒè¯ Token 5 if (!validateToken(token)) { 6 ctx.writeAndFlush(new TextWebSocketFrame( 7 JSON.toJSONString(Message.builder() 8 .type(\u0026#34;auth_response\u0026#34;) 9 .code(401) 10 .content(\u0026#34;è®¤è¯å¤±è´¥\u0026#34;) 11 .build()) 12 )); 13 ctx.close(); 14 return; 15 } 16 17 // è®¤è¯æˆåŠŸï¼Œç»‘å®šç”¨æˆ· 18 String userId = getUserIdFromToken(token); 19 ChannelManager.bindUser(userId, ctx.channel()); 20} 2. æ¶ˆæ¯é™æµ\n1@Component 2public class MessageRateLimiter { 3 4 private final LoadingCache\u0026lt;String, RateLimiter\u0026gt; limiters = CacheBuilder.newBuilder() 5 .maximumSize(10000) 6 .expireAfterAccess(1, TimeUnit.HOURS) 7 .build(new CacheLoader\u0026lt;String, RateLimiter\u0026gt;() { 8 @Override 9 public RateLimiter load(String key) { 10 // æ¯ç§’æœ€å¤š 10 æ¡æ¶ˆæ¯ 11 return RateLimiter.create(10.0); 12 } 13 }); 14 15 public boolean tryAcquire(String userId) { 16 try { 17 RateLimiter limiter = limiters.get(userId); 18 return limiter.tryAcquire(); 19 } catch (ExecutionException e) { 20 return false; 21 } 22 } 23} 3. XSS é˜²æŠ¤\n1private String sanitizeContent(String content) { 2 // è¿‡æ»¤ HTML æ ‡ç­¾å’Œè„šæœ¬ 3 return content.replaceAll(\u0026#34;\u0026lt;[^\u0026gt;]*\u0026gt;\u0026#34;, \u0026#34;\u0026#34;) 4 .replaceAll(\u0026#34;javascript:\u0026#34;, \u0026#34;\u0026#34;) 5 .replaceAll(\u0026#34;on\\\\w+\\\\s*=\u0026#34;, \u0026#34;\u0026#34;); 6} é¿å‘æç¤ºï¼š ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå®‰å…¨æ€§è‡³å…³é‡è¦ã€‚é™¤äº†ä¸Šè¿°æªæ–½ï¼Œè¿˜éœ€è¦ï¼š1) ä½¿ç”¨ WSSï¼ˆWebSocket over TLSï¼‰åŠ å¯†ä¼ è¾“ï¼›2) è®¾ç½®åˆç†çš„æ¶ˆæ¯å¤§å°é™åˆ¶ï¼›3) å®æ–½ IP é»‘ç™½åå•ï¼›4) è®°å½•å®¡è®¡æ—¥å¿—ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–äº†ä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜çš„å®Œæ•´å†…å®¹ï¼š\nåè®®åŸç†ï¼šç†è§£ WebSocket æ¡æ‰‹æµç¨‹å’Œæ•°æ®å¸§æ ¼å¼ æœåŠ¡å™¨å®ç°ï¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨ è¿æ¥ç®¡ç†ï¼šå®ç° Channel ç®¡ç†å’Œæ¶ˆæ¯æ¨é€ å¿ƒè·³æœºåˆ¶ï¼šä¿è¯è¿æ¥å¯é æ€§å’ŒåŠæ—¶æ£€æµ‹æ–­çº¿ é›†ç¾¤éƒ¨ç½²ï¼šé€šè¿‡ Redis å®ç°è·¨èŠ‚ç‚¹æ¶ˆæ¯è·¯ç”± æ€§èƒ½ä¼˜åŒ–ï¼šçº¿ç¨‹æ± ã€å†…å­˜ã€è¿æ¥æ•°ç­‰å¤šæ–¹é¢ä¼˜åŒ– å®‰å…¨åŠ å›ºï¼šè®¤è¯é‰´æƒã€é™æµã€XSS é˜²æŠ¤ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯è¿›è¡Œè°ƒæ•´ã€‚ä¾‹å¦‚ï¼š\nå³æ—¶é€šè®¯ï¼šéœ€è¦è€ƒè™‘æ¶ˆæ¯å¯é æ€§ã€ç¦»çº¿æ¶ˆæ¯ã€æ¶ˆæ¯é¡ºåº åœ¨çº¿å®¢æœï¼šéœ€è¦è€ƒè™‘ä¼šè¯ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±ã€å®¢æœåˆ†é… å®æ—¶ç›‘æ§ï¼šéœ€è¦è€ƒè™‘æ•°æ®èšåˆã€å‘Šè­¦æ¨é€ã€å¤§å±å±•ç¤º ä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°å®æ—¶æ¶ˆæ¯æ¨é€åŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯• Netty + WebSocket è¿™ä¸ªå¼ºå¤§çš„ç»„åˆã€‚\n","permalink":"http://localhost:1313/posts/2025/04/netty--websocket-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå®æ—¶æ¶ˆæ¯æ¨é€å·²æˆä¸ºæ ‡é…åŠŸèƒ½ã€‚ä»å³æ—¶é€šè®¯ã€åœ¨çº¿å®¢æœåˆ°å®æ—¶ç›‘æ§å¤§å±ï¼Œéƒ½ç¦»ä¸å¼€é«˜æ€§èƒ½çš„æ¶ˆæ¯æ¨é€èƒ½åŠ›ã€‚ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼å­˜åœ¨å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹ç­‰é—®é¢˜ï¼Œè€Œ WebSocket åè®®çš„å‡ºç°å®Œç¾è§£å†³äº†è¿™äº›ç—›ç‚¹ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty æ¡†æ¶å®ç°åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜ï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¨é€æœåŠ¡ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ WebSocket åè®®åŸç†ä¸æ¡æ‰‹æµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ç®¡ç†ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆé€‰æ‹©-netty--websocket\"\u003eä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket\u003c/h2\u003e\n\u003ch3 id=\"websocket-åè®®ä¼˜åŠ¿\"\u003eWebSocket åè®®ä¼˜åŠ¿\u003c/h3\u003e\n\u003cp\u003eç›¸æ¯”ä¼ ç»Ÿçš„ HTTP è½®è¯¢ï¼ŒWebSocket å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eç‰¹æ€§\u003c/th\u003e\n          \u003cth\u003eHTTP è½®è¯¢\u003c/th\u003e\n          \u003cth\u003eWebSocket\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eé€šä¿¡æ–¹å¼\u003c/td\u003e\n          \u003ctd\u003eåŠåŒå·¥\u003c/td\u003e\n          \u003ctd\u003eå…¨åŒå·¥\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eè¿æ¥å¼€é”€\u003c/td\u003e\n          \u003ctd\u003eæ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥\u003c/td\u003e\n          \u003ctd\u003eä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå®æ—¶æ€§\u003c/td\u003e\n          \u003ctd\u003eå–å†³äºè½®è¯¢é—´éš”ï¼ˆç§’çº§ï¼‰\u003c/td\u003e\n          \u003ctd\u003eæ¯«ç§’çº§\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eæœåŠ¡å™¨å‹åŠ›\u003c/td\u003e\n          \u003ctd\u003eé«˜ï¼ˆé¢‘ç¹çš„ HTTP è¯·æ±‚ï¼‰\u003c/td\u003e\n          \u003ctd\u003eä½ï¼ˆé•¿è¿æ¥ï¼‰\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå¸¦å®½æ¶ˆè€—\u003c/td\u003e\n          \u003ctd\u003eé«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰ HTTP å¤´ï¼‰\u003c/td\u003e\n          \u003ctd\u003eä½ï¼ˆåªä¼ è¾“æ•°æ®å¸§ï¼‰\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"netty-æ¡†æ¶ä¼˜åŠ¿\"\u003eNetty æ¡†æ¶ä¼˜åŠ¿\u003c/h3\u003e\n\u003cp\u003eNetty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eé«˜æ€§èƒ½\u003c/strong\u003eï¼šåŸºäº NIOï¼Œæ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ˜“ç”¨æ€§\u003c/strong\u003eï¼šæä¾›äº†ä¸°å¯Œçš„ç¼–è§£ç å™¨å’Œå¤„ç†å™¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç¨³å®šæ€§\u003c/strong\u003eï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ‰©å±•æ€§\u003c/strong\u003eï¼šçµæ´»çš„ Pipeline æœºåˆ¶\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œä¸ä»…è¦çœ‹æŠ€æœ¯æœ¬èº«çš„ä¼˜åŠ¿ï¼Œæ›´è¦è€ƒè™‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€è¿ç»´æˆæœ¬å’Œç¤¾åŒºç”Ÿæ€ã€‚Netty åœ¨ Java ç”Ÿæ€ä¸­å·²ç»æˆä¸ºäº‹å®æ ‡å‡†ï¼ŒDubboã€RocketMQã€Elasticsearch ç­‰çŸ¥åé¡¹ç›®éƒ½åœ¨ä½¿ç”¨ã€‚\u003c/p\u003e","title":"Netty + WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜"},{"content":"åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚ä½†ç¼“å­˜ä½¿ç”¨ä¸å½“ä¼šå¼•å‘ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æè¿™äº›é—®é¢˜çš„åŸç†ï¼Œå¹¶æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„æœ¬è´¨åŒºåˆ« æŒæ¡å¸ƒéš†è¿‡æ»¤å™¨ã€äº’æ–¥é”ç­‰é˜²æŠ¤æ‰‹æ®µ å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„ç¼“å­˜æ¶æ„ äº†è§£ç¼“å­˜é¢„çƒ­ã€é™çº§ç­‰æœ€ä½³å®è·µ ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜ é—®é¢˜å¯¹æ¯” é—®é¢˜ åŸå›  å½±å“ è§£å†³æ–¹æ¡ˆ ç¼“å­˜ç©¿é€ æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® å¤§é‡è¯·æ±‚æ‰“åˆ°DB å¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜ ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹keyè¿‡æœŸ ç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°DB äº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ ç¼“å­˜é›ªå´© å¤§é‡keyåŒæ—¶è¿‡æœŸ DBå‹åŠ›éª¤å¢ è¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜ ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® é—®é¢˜åœºæ™¯ 1// æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID 2for (int i = -1000000; i \u0026lt; 0; i--) { 3 User user = getUser(i); // ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æŸ¥DB 4} æµç¨‹ï¼š\n1è¯·æ±‚ â†’ æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ æŸ¥æ•°æ®åº“ï¼ˆæœªå‘½ä¸­ï¼‰â†’ è¿”å›null æ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\nè§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨ åŸç†ï¼š ç”¨ä½æ•°ç»„åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚\n1@Configuration 2public class BloomFilterConfig { 3 4 @Bean 5 public BloomFilter\u0026lt;Long\u0026gt; userBloomFilter() { 6 // é¢„æœŸå…ƒç´ æ•°é‡ï¼š1000ä¸‡ï¼Œè¯¯åˆ¤ç‡ï¼š0.01% 7 BloomFilter\u0026lt;Long\u0026gt; bloomFilter = BloomFilter.create( 8 Funnels.longFunnel(), 9 10000000, 10 0.0001 11 ); 12 13 // åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ 14 List\u0026lt;Long\u0026gt; userIds = userMapper.selectAllIds(); 15 userIds.forEach(bloomFilter::put); 16 17 return bloomFilter; 18 } 19} 1@Service 2public class UserService { 3 4 @Autowired 5 private BloomFilter\u0026lt;Long\u0026gt; userBloomFilter; 6 7 @Autowired 8 private RedisTemplate\u0026lt;String, User\u0026gt; redisTemplate; 9 10 @Autowired 11 private UserMapper userMapper; 12 13 public User getUser(Long userId) { 14 // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ 15 if (!userBloomFilter.mightContain(userId)) { 16 return null; // ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å› 17 } 18 19 // 2. æŸ¥ç¼“å­˜ 20 String key = \u0026#34;user:\u0026#34; + userId; 21 User user = redisTemplate.opsForValue().get(key); 22 if (user != null) { 23 return user; 24 } 25 26 // 3. æŸ¥æ•°æ®åº“ 27 user = userMapper.selectById(userId); 28 if (user != null) { 29 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 30 } 31 32 return user; 33 } 34} ä¼˜ç‚¹ï¼š\nå†…å­˜å ç”¨å°ï¼ˆ1000ä¸‡æ•°æ®åªéœ€çº¦12MBï¼‰ æŸ¥è¯¢é€Ÿåº¦å¿«ï¼ˆO(k)ï¼Œkä¸ºå“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼‰ ç¼ºç‚¹ï¼š\nå­˜åœ¨è¯¯åˆ¤ï¼ˆå¯èƒ½åˆ¤æ–­å­˜åœ¨ä½†å®é™…ä¸å­˜åœ¨ï¼‰ æ— æ³•åˆ é™¤å…ƒç´  è§£å†³æ–¹æ¡ˆ2ï¼šç¼“å­˜ç©ºå€¼ 1public User getUser(Long userId) { 2 String key = \u0026#34;user:\u0026#34; + userId; 3 4 // 1. æŸ¥ç¼“å­˜ 5 User user = redisTemplate.opsForValue().get(key); 6 if (user != null) { 7 // ç©ºå¯¹è±¡æ ‡è®° 8 if (user.getId() == null) { 9 return null; 10 } 11 return user; 12 } 13 14 // 2. æŸ¥æ•°æ®åº“ 15 user = userMapper.selectById(userId); 16 17 // 3. ç¼“å­˜ç»“æœï¼ˆåŒ…æ‹¬nullï¼‰ 18 if (user == null) { 19 // ç¼“å­˜ç©ºå¯¹è±¡ï¼Œè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ 20 User emptyUser = new User(); 21 redisTemplate.opsForValue().set(key, emptyUser, 5, TimeUnit.MINUTES); 22 } else { 23 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 24 } 25 26 return user; 27} ä¼˜ç‚¹ï¼š\nå®ç°ç®€å• å¯ä»¥é˜²æ­¢åŒä¸€ä¸ªä¸å­˜åœ¨çš„keyåå¤æŸ¥è¯¢ ç¼ºç‚¹ï¼š\nå ç”¨ç¼“å­˜ç©ºé—´ å¯èƒ½ç¼“å­˜å¤§é‡æ— æ•ˆæ•°æ® è§£å†³æ–¹æ¡ˆ3ï¼šå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜ 1public User getUser(Long userId) { 2 // 1. å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­ 3 if (!userBloomFilter.mightContain(userId)) { 4 return null; 5 } 6 7 String key = \u0026#34;user:\u0026#34; + userId; 8 9 // 2. æŸ¥ç¼“å­˜ï¼ˆåŒ…æ‹¬ç©ºå€¼ï¼‰ 10 User user = redisTemplate.opsForValue().get(key); 11 if (user != null) { 12 return user.getId() == null ? null : user; 13 } 14 15 // 3. æŸ¥æ•°æ®åº“ 16 user = userMapper.selectById(userId); 17 18 // 4. ç¼“å­˜ç»“æœ 19 if (user == null) { 20 User emptyUser = new User(); 21 redisTemplate.opsForValue().set(key, emptyUser, 5, TimeUnit.MINUTES); 22 } else { 23 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 24 } 25 26 return user; 27} æ¶æ„æ€è€ƒï¼š å¸ƒéš†è¿‡æ»¤å™¨é€‚åˆè¿‡æ»¤å¤§éƒ¨åˆ†ä¸å­˜åœ¨çš„è¯·æ±‚ï¼Œç©ºå€¼ç¼“å­˜é€‚åˆå¤„ç†å°‘é‡ä¸å­˜åœ¨ä½†è¢«é¢‘ç¹æŸ¥è¯¢çš„keyã€‚ä¸¤è€…ç»“åˆä½¿ç”¨ï¼Œå¯ä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœã€‚\nç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyè¿‡æœŸ é—®é¢˜åœºæ™¯ 1çƒ­ç‚¹å•†å“è¯¦æƒ…é¡µï¼Œç¼“å­˜è¿‡æœŸç¬é—´ï¼Œ1000ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“ æµç¨‹ï¼š\n1æ—¶åˆ»Tï¼šç¼“å­˜è¿‡æœŸ 2æ—¶åˆ»T+1msï¼š1000ä¸ªè¯·æ±‚åŒæ—¶æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ åŒæ—¶æŸ¥æ•°æ®åº“ è§£å†³æ–¹æ¡ˆ1ï¼šäº’æ–¥é” 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // 1. æŸ¥ç¼“å­˜ 5 Product product = redisTemplate.opsForValue().get(key); 6 if (product != null) { 7 return product; 8 } 9 10 // 2. è·å–äº’æ–¥é” 11 String lockKey = \u0026#34;lock:product:\u0026#34; + productId; 12 Boolean locked = redisTemplate.opsForValue() 13 .setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS); 14 15 if (locked) { 16 try { 17 // 3. åŒé‡æ£€æŸ¥ 18 product = redisTemplate.opsForValue().get(key); 19 if (product != null) { 20 return product; 21 } 22 23 // 4. æŸ¥æ•°æ®åº“ 24 product = productMapper.selectById(productId); 25 26 // 5. å†™å…¥ç¼“å­˜ 27 if (product != null) { 28 redisTemplate.opsForValue().set(key, product, 1, TimeUnit.HOURS); 29 } 30 31 return product; 32 } finally { 33 // 6. é‡Šæ”¾é” 34 redisTemplate.delete(lockKey); 35 } 36 } else { 37 // 7. æœªè·å–åˆ°é”ï¼Œç­‰å¾…åé‡è¯• 38 try { 39 Thread.sleep(50); 40 } catch (InterruptedException e) { 41 Thread.currentThread().interrupt(); 42 } 43 return getProduct(productId); // é€’å½’é‡è¯• 44 } 45} ä¼˜ç‚¹ï¼š\nä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®åº“ å®ç°ç®€å• ç¼ºç‚¹ï¼š\nå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾… å¯èƒ½å¯¼è‡´è¯·æ±‚å †ç§¯ è§£å†³æ–¹æ¡ˆ2ï¼šé€»è¾‘è¿‡æœŸ 1@Data 2public class CacheData\u0026lt;T\u0026gt; { 3 private T data; 4 private LocalDateTime expireTime; 5} 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // 1. æŸ¥ç¼“å­˜ï¼ˆæ°¸ä¸è¿‡æœŸï¼‰ 5 CacheData\u0026lt;Product\u0026gt; cacheData = redisTemplate.opsForValue().get(key); 6 7 if (cacheData == null) { 8 // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ 9 return loadAndCache(productId); 10 } 11 12 // 2. åˆ¤æ–­é€»è¾‘è¿‡æœŸ 13 if (cacheData.getExpireTime().isBefore(LocalDateTime.now())) { 14 // 3. å¼‚æ­¥æ›´æ–°ç¼“å­˜ 15 String lockKey = \u0026#34;lock:product:\u0026#34; + productId; 16 Boolean locked = redisTemplate.opsForValue() 17 .setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS); 18 19 if (locked) { 20 CompletableFuture.runAsync(() -\u0026gt; { 21 try { 22 loadAndCache(productId); 23 } finally { 24 redisTemplate.delete(lockKey); 25 } 26 }); 27 } 28 } 29 30 // 4. è¿”å›æ—§æ•°æ® 31 return cacheData.getData(); 32} 33 34private Product loadAndCache(Long productId) { 35 Product product = productMapper.selectById(productId); 36 if (product != null) { 37 CacheData\u0026lt;Product\u0026gt; cacheData = new CacheData\u0026lt;\u0026gt;(); 38 cacheData.setData(product); 39 cacheData.setExpireTime(LocalDateTime.now().plusHours(1)); 40 41 redisTemplate.opsForValue().set(\u0026#34;product:\u0026#34; + productId, cacheData); 42 } 43 return product; 44} ä¼˜ç‚¹ï¼š\nä¸ä¼šé˜»å¡è¯·æ±‚ å§‹ç»ˆè¿”å›æ•°æ®ï¼ˆå³ä½¿æ˜¯æ—§æ•°æ®ï¼‰ ç¼ºç‚¹ï¼š\nå¯èƒ½è¿”å›è¿‡æœŸæ•°æ® å®ç°å¤æ‚ è§£å†³æ–¹æ¡ˆ3ï¼šçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // çƒ­ç‚¹å•†å“æ°¸ä¸è¿‡æœŸ 5 Product product = redisTemplate.opsForValue().get(key); 6 if (product != null) { 7 return product; 8 } 9 10 // æŸ¥æ•°æ®åº“å¹¶ç¼“å­˜ï¼ˆä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰ 11 product = productMapper.selectById(productId); 12 if (product != null) { 13 redisTemplate.opsForValue().set(key, product); 14 } 15 16 return product; 17} 18 19// é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ›´æ–°ç¼“å­˜ 20@RabbitListener(queues = \u0026#34;product.update\u0026#34;) 21public void updateProductCache(Long productId) { 22 Product product = productMapper.selectById(productId); 23 redisTemplate.opsForValue().set(\u0026#34;product:\u0026#34; + productId, product); 24} ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸ é—®é¢˜åœºæ™¯ 1å‡Œæ™¨2ç‚¹ï¼Œç³»ç»Ÿé‡å¯ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶åŠ è½½ï¼Œè®¾ç½®1å°æ—¶è¿‡æœŸ 2å‡Œæ™¨3ç‚¹ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ è§£å†³æ–¹æ¡ˆ1ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ– 1public void setCache(String key, Object value, long baseExpireSeconds) { 2 // åœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¸Šå¢åŠ éšæœºå€¼ 3 long randomSeconds = ThreadLocalRandom.current().nextLong(0, 300); 4 long expireSeconds = baseExpireSeconds + randomSeconds; 5 6 redisTemplate.opsForValue().set(key, value, expireSeconds, TimeUnit.SECONDS); 7} 1// ä½¿ç”¨ç¤ºä¾‹ 2setCache(\u0026#34;user:1\u0026#34;, user, 3600); // 3600 ~ 3900ç§’ 3setCache(\u0026#34;user:2\u0026#34;, user, 3600); // 3600 ~ 3900ç§’ è§£å†³æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜ 1è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â†’ Redis â†’ æ•°æ®åº“ 1@Configuration 2public class CacheConfig { 3 4 @Bean 5 public Cache\u0026lt;String, Object\u0026gt; localCache() { 6 return Caffeine.newBuilder() 7 .maximumSize(10000) 8 .expireAfterWrite(5, TimeUnit.MINUTES) 9 .build(); 10 } 11} 1@Service 2public class UserService { 3 4 @Autowired 5 private Cache\u0026lt;String, Object\u0026gt; localCache; 6 7 @Autowired 8 private RedisTemplate\u0026lt;String, User\u0026gt; redisTemplate; 9 10 @Autowired 11 private UserMapper userMapper; 12 13 public User getUser(Long userId) { 14 String key = \u0026#34;user:\u0026#34; + userId; 15 16 // 1. æŸ¥æœ¬åœ°ç¼“å­˜ 17 User user = (User) localCache.getIfPresent(key); 18 if (user != null) { 19 return user; 20 } 21 22 // 2. æŸ¥Redis 23 user = redisTemplate.opsForValue().get(key); 24 if (user != null) { 25 localCache.put(key, user); 26 return user; 27 } 28 29 // 3. æŸ¥æ•°æ®åº“ 30 user = userMapper.selectById(userId); 31 if (user != null) { 32 // å†™å…¥Rediså’Œæœ¬åœ°ç¼“å­˜ 33 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 34 localCache.put(key, user); 35 } 36 37 return user; 38 } 39} è§£å†³æ–¹æ¡ˆ3ï¼šç¼“å­˜é¢„çƒ­ 1@Component 2public class CacheWarmUp implements ApplicationRunner { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; 6 7 @Autowired 8 private ProductMapper productMapper; 9 10 @Override 11 public void run(ApplicationArguments args) { 12 log.info(\u0026#34;å¼€å§‹ç¼“å­˜é¢„çƒ­...\u0026#34;); 13 14 // åŠ è½½çƒ­ç‚¹å•†å“ 15 List\u0026lt;Product\u0026gt; hotProducts = productMapper.selectHotProducts(100); 16 for (Product product : hotProducts) { 17 String key = \u0026#34;product:\u0026#34; + product.getId(); 18 long expireSeconds = 3600 + ThreadLocalRandom.current().nextLong(0, 300); 19 redisTemplate.opsForValue().set(key, product, expireSeconds, TimeUnit.SECONDS); 20 } 21 22 log.info(\u0026#34;ç¼“å­˜é¢„çƒ­å®Œæˆï¼Œå…±åŠ è½½ {} ä¸ªå•†å“\u0026#34;, hotProducts.size()); 23 } 24} è§£å†³æ–¹æ¡ˆ4ï¼šé™æµé™çº§ 1@Service 2public class ProductService { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Product\u0026gt; redisTemplate; 6 7 @Autowired 8 private ProductMapper productMapper; 9 10 /** 11 * ä½¿ç”¨ Sentinel é™æµ 12 */ 13 @SentinelResource( 14 value = \u0026#34;getProduct\u0026#34;, 15 blockHandler = \u0026#34;getProductBlockHandler\u0026#34;, 16 fallback = \u0026#34;getProductFallback\u0026#34; 17 ) 18 public Product getProduct(Long productId) { 19 String key = \u0026#34;product:\u0026#34; + productId; 20 21 // æŸ¥ç¼“å­˜ 22 Product product = redisTemplate.opsForValue().get(key); 23 if (product != null) { 24 return product; 25 } 26 27 // æŸ¥æ•°æ®åº“ 28 product = productMapper.selectById(productId); 29 if (product != null) { 30 redisTemplate.opsForValue().set(key, product, 1, TimeUnit.HOURS); 31 } 32 33 return product; 34 } 35 36 /** 37 * é™æµé™çº§å¤„ç† 38 */ 39 public Product getProductBlockHandler(Long productId, BlockException ex) { 40 log.warn(\u0026#34;è§¦å‘é™æµ: productId={}\u0026#34;, productId); 41 // è¿”å›é»˜è®¤å•†å“æˆ–æç¤ºä¿¡æ¯ 42 return getDefaultProduct(); 43 } 44 45 /** 46 * å¼‚å¸¸é™çº§å¤„ç† 47 */ 48 public Product getProductFallback(Long productId, Throwable ex) { 49 log.error(\u0026#34;æŸ¥è¯¢å¼‚å¸¸: productId={}\u0026#34;, productId, ex); 50 // è¿”å›é»˜è®¤å•†å“ 51 return getDefaultProduct(); 52 } 53} ç¼“å­˜æ›´æ–°ç­–ç•¥ ç­–ç•¥å¯¹æ¯” ç­–ç•¥ ä¸€è‡´æ€§ å®ç°å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ Cache Aside å¼±ä¸€è‡´æ€§ ç®€å• è¯»å¤šå†™å°‘ Read/Write Through å¼ºä¸€è‡´æ€§ å¤æ‚ è¯»å†™å‡è¡¡ Write Behind æœ€ç»ˆä¸€è‡´æ€§ å¤æ‚ å†™å¤šè¯»å°‘ Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰ 1// è¯»æ“ä½œ 2public User getUser(Long userId) { 3 String key = \u0026#34;user:\u0026#34; + userId; 4 5 // 1. æŸ¥ç¼“å­˜ 6 User user = redisTemplate.opsForValue().get(key); 7 if (user != null) { 8 return user; 9 } 10 11 // 2. æŸ¥æ•°æ®åº“ 12 user = userMapper.selectById(userId); 13 14 // 3. å†™å…¥ç¼“å­˜ 15 if (user != null) { 16 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 17 } 18 19 return user; 20} 21 22// å†™æ“ä½œ 23public void updateUser(User user) { 24 // 1. æ›´æ–°æ•°æ®åº“ 25 userMapper.updateById(user); 26 27 // 2. åˆ é™¤ç¼“å­˜ 28 String key = \u0026#34;user:\u0026#34; + user.getId(); 29 redisTemplate.delete(key); 30} ä¸ºä»€ä¹ˆæ˜¯åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ\næ›´æ–°ç¼“å­˜å¯èƒ½æµªè´¹ï¼ˆæ›´æ–°åå¯èƒ½æ²¡äººæŸ¥è¯¢ï¼‰ å¹¶å‘æ›´æ–°å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ å»¶è¿ŸåŒåˆ  1public void updateUser(User user) { 2 String key = \u0026#34;user:\u0026#34; + user.getId(); 3 4 // 1. åˆ é™¤ç¼“å­˜ 5 redisTemplate.delete(key); 6 7 // 2. æ›´æ–°æ•°æ®åº“ 8 userMapper.updateById(user); 9 10 // 3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜ 11 CompletableFuture.runAsync(() -\u0026gt; { 12 try { 13 Thread.sleep(500); // å»¶è¿Ÿ500ms 14 redisTemplate.delete(key); 15 } catch (InterruptedException e) { 16 Thread.currentThread().interrupt(); 17 } 18 }); 19} ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿ŸåŒåˆ ï¼Ÿ\né˜²æ­¢ä»¥ä¸‹åœºæ™¯çš„æ•°æ®ä¸ä¸€è‡´ï¼š\n1æ—¶åˆ»1ï¼šçº¿ç¨‹Aåˆ é™¤ç¼“å­˜ 2æ—¶åˆ»2ï¼šçº¿ç¨‹BæŸ¥è¯¢ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰ 3æ—¶åˆ»3ï¼šçº¿ç¨‹BæŸ¥è¯¢æ•°æ®åº“ï¼ˆæ—§æ•°æ®ï¼‰ 4æ—¶åˆ»4ï¼šçº¿ç¨‹Aæ›´æ–°æ•°æ®åº“ 5æ—¶åˆ»5ï¼šçº¿ç¨‹Bå†™å…¥ç¼“å­˜ï¼ˆæ—§æ•°æ®ï¼‰ å»¶è¿ŸåŒåˆ å¯ä»¥åˆ é™¤çº¿ç¨‹Bå†™å…¥çš„æ—§æ•°æ®ã€‚\nç¼“å­˜ç›‘æ§ å…³é”®æŒ‡æ ‡ 1@Component 2public class CacheMonitor { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; 6 7 @Scheduled(fixedDelay = 60000) 8 public void monitor() { 9 RedisConnection connection = redisTemplate.getConnectionFactory().getConnection(); 10 Properties info = connection.info(); 11 12 // 1. å†…å­˜ä½¿ç”¨ 13 long usedMemory = Long.parseLong(info.getProperty(\u0026#34;used_memory\u0026#34;)); 14 long maxMemory = Long.parseLong(info.getProperty(\u0026#34;maxmemory\u0026#34;)); 15 double memoryUsageRate = (double) usedMemory / maxMemory * 100; 16 17 // 2. å‘½ä¸­ç‡ 18 long hits = Long.parseLong(info.getProperty(\u0026#34;keyspace_hits\u0026#34;)); 19 long misses = Long.parseLong(info.getProperty(\u0026#34;keyspace_misses\u0026#34;)); 20 double hitRate = (double) hits / (hits + misses) * 100; 21 22 // 3. è¿æ¥æ•° 23 int connectedClients = Integer.parseInt(info.getProperty(\u0026#34;connected_clients\u0026#34;)); 24 25 log.info(\u0026#34;Redisç›‘æ§ - å†…å­˜ä½¿ç”¨ç‡: {}%, å‘½ä¸­ç‡: {}%, è¿æ¥æ•°: {}\u0026#34;, 26 memoryUsageRate, hitRate, connectedClients); 27 28 // 4. å‘Šè­¦ 29 if (memoryUsageRate \u0026gt; 80) { 30 log.warn(\u0026#34;Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, memoryUsageRate); 31 } 32 if (hitRate \u0026lt; 80) { 33 log.warn(\u0026#34;Rediså‘½ä¸­ç‡è¿‡ä½: {}%\u0026#34;, hitRate); 34 } 35 } 36} æœ€ä½³å®è·µ 1. åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´\nçƒ­ç‚¹æ•°æ®ï¼š1-2å°æ—¶ æ™®é€šæ•°æ®ï¼š30åˆ†é’Ÿ-1å°æ—¶ å†·æ•°æ®ï¼š5-10åˆ†é’Ÿ 2. ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„\nStringï¼šç®€å•key-value Hashï¼šå¯¹è±¡å­˜å‚¨ Listï¼šåˆ—è¡¨ã€é˜Ÿåˆ— Setï¼šå»é‡ã€äº¤é›† ZSetï¼šæ’è¡Œæ¦œ 3. é¿å…å¤§key\nå•ä¸ªkeyä¸è¶…è¿‡10KB é›†åˆå…ƒç´ ä¸è¶…è¿‡5000ä¸ª ä½¿ç”¨SCANä»£æ›¿KEYS 4. è®¾ç½®å†…å­˜æ·˜æ±°ç­–ç•¥\n1# redis.conf 2maxmemory 2gb 3maxmemory-policy allkeys-lru 5. ç›‘æ§å‘Šè­¦\nå†…å­˜ä½¿ç”¨ç‡ \u0026gt; 80% å‘½ä¸­ç‡ \u0026lt; 80% æ…¢æŸ¥è¯¢ \u0026gt; 10ms é¿å‘æç¤ºï¼š ç¼“å­˜ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¸è¦ä¸ºäº†ç¼“å­˜è€Œç¼“å­˜ã€‚åªæœ‰é«˜é¢‘è®¿é—®ã€å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®æ‰é€‚åˆç¼“å­˜ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜çš„æ•°æ®ï¼Œç›´æ¥æŸ¥æ•°æ®åº“å¯èƒ½æ›´åˆé€‚ã€‚\næ€»ç»“ä¸æ€è€ƒ Redis ç¼“å­˜æ¶æ„çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€ ä½¿ç”¨äº’æ–¥é”æˆ–é€»è¾‘è¿‡æœŸé˜²æ­¢ç¼“å­˜å‡»ç©¿ ä½¿ç”¨è¿‡æœŸæ—¶é—´éšæœºåŒ–å’Œå¤šçº§ç¼“å­˜é˜²æ­¢ç¼“å­˜é›ªå´© ä½¿ç”¨ Cache Aside æ¨¡å¼æ›´æ–°ç¼“å­˜ ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œå†…å­˜ä½¿ç”¨ç‡ ç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„åˆ©å™¨ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¤æ‚åº¦ã€‚åœ¨è®¾è®¡ç¼“å­˜æ¶æ„æ—¶è¦æƒè¡¡ï¼š\næ˜¯å¦çœŸçš„éœ€è¦ç¼“å­˜ï¼Ÿ ç¼“å­˜ä»€ä¹ˆæ•°æ®ï¼Ÿ å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ å¦‚ä½•åº”å¯¹ç¼“å­˜å¤±æ•ˆï¼Ÿ ä¸‹æ¬¡å½“ä½ çš„ç³»ç»Ÿé¢ä¸´é«˜å¹¶å‘æŒ‘æˆ˜æ—¶ï¼Œä¸å¦¨è¯•è¯•æœ¬æ–‡ä»‹ç»çš„ç¼“å­˜æ¶æ„æ–¹æ¡ˆï¼Œè®©ç³»ç»Ÿæ€§èƒ½æ›´ä¸Šä¸€å±‚æ¥¼ã€‚\n","permalink":"http://localhost:1313/posts/2025/03/redis-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E4%BB%8E%E7%A9%BF%E9%80%8F%E5%88%B0%E9%9B%AA%E5%B4%A9%E7%9A%84%E5%85%A8%E9%93%BE%E8%B7%AF%E9%98%B2%E6%8A%A4/","summary":"\u003cp\u003eåœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚ä½†ç¼“å­˜ä½¿ç”¨ä¸å½“ä¼šå¼•å‘ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æè¿™äº›é—®é¢˜çš„åŸç†ï¼Œå¹¶æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„æœ¬è´¨åŒºåˆ«\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å¸ƒéš†è¿‡æ»¤å™¨ã€äº’æ–¥é”ç­‰é˜²æŠ¤æ‰‹æ®µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„ç¼“å­˜æ¶æ„\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç¼“å­˜é¢„çƒ­ã€é™çº§ç­‰æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜\"\u003eç¼“å­˜çš„ä¸‰å¤§é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜å¯¹æ¯”\"\u003eé—®é¢˜å¯¹æ¯”\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eé—®é¢˜\u003c/th\u003e\n          \u003cth\u003eåŸå› \u003c/th\u003e\n          \u003cth\u003eå½±å“\u003c/th\u003e\n          \u003cth\u003eè§£å†³æ–¹æ¡ˆ\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜ç©¿é€\u003c/td\u003e\n          \u003ctd\u003eæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\u003c/td\u003e\n          \u003ctd\u003eå¤§é‡è¯·æ±‚æ‰“åˆ°DB\u003c/td\u003e\n          \u003ctd\u003eå¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜å‡»ç©¿\u003c/td\u003e\n          \u003ctd\u003eçƒ­ç‚¹keyè¿‡æœŸ\u003c/td\u003e\n          \u003ctd\u003eç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°DB\u003c/td\u003e\n          \u003ctd\u003eäº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜é›ªå´©\u003c/td\u003e\n          \u003ctd\u003eå¤§é‡keyåŒæ—¶è¿‡æœŸ\u003c/td\u003e\n          \u003ctd\u003eDBå‹åŠ›éª¤å¢\u003c/td\u003e\n          \u003ctd\u003eè¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¼“å­˜ç©¿é€æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\"\u003eç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜åœºæ™¯\"\u003eé—®é¢˜åœºæ™¯\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003e1000000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æŸ¥DB\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæµç¨‹ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eè¯·æ±‚ â†’ æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ æŸ¥æ•°æ®åº“ï¼ˆæœªå‘½ä¸­ï¼‰â†’ è¿”å›null\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\u003c/p\u003e\n\u003ch3 id=\"è§£å†³æ–¹æ¡ˆ1å¸ƒéš†è¿‡æ»¤å™¨\"\u003eè§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eåŸç†ï¼š\u003c/strong\u003e ç”¨ä½æ•°ç»„åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBloomFilterConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// é¢„æœŸå…ƒç´ æ•°é‡ï¼š1000ä¸‡ï¼Œè¯¯åˆ¤ç‡ï¼š0.01%\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eFunnels\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003elongFunnel\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10000000\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003e0001\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserIds\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectAllIds\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003euserIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eforEach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eput\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRedisTemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserMapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emightContain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æŸ¥ç¼“å­˜\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;user:\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. æŸ¥æ•°æ®åº“\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eHOURS\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eä¼˜ç‚¹ï¼š\u003c/strong\u003e\u003c/p\u003e","title":"Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤"},{"content":"å½“å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§åˆ«æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆã€‚æœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ ShardingSphere å®ç°åˆ†åº“åˆ†è¡¨ï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒçš„å®æˆ˜ç»éªŒã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒæ¦‚å¿µå’Œåº”ç”¨åœºæ™¯ æŒæ¡ ShardingSphere çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³• å­¦ä¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡ç­–ç•¥ äº†è§£åˆ†åº“åˆ†è¡¨çš„æœ€ä½³å®è·µå’Œå¸¸è§é—®é¢˜ ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ åœºæ™¯ï¼šè®¢å•è¡¨æ•°æ®çˆ†ç‚¸\nç”µå•†ç³»ç»Ÿçš„è®¢å•è¡¨ï¼Œæ¯å¤©æ–°å¢10ä¸‡æ¡æ•°æ®ï¼Œä¸€å¹´å°±æ˜¯3600ä¸‡æ¡ã€‚éšç€æ•°æ®é‡å¢é•¿ï¼š\næŸ¥è¯¢å˜æ…¢ï¼šå•è¡¨æŸ¥è¯¢ä»æ¯«ç§’çº§å˜æˆç§’çº§ ç´¢å¼•å¤±æ•ˆï¼šB+æ ‘å±‚çº§å¢åŠ ï¼Œç´¢å¼•æ•ˆç‡ä¸‹é™ é”ç«äº‰ï¼šå¤§è¡¨çš„é”ç²’åº¦å¤§ï¼Œå¹¶å‘æ€§èƒ½å·® å¤‡ä»½å›°éš¾ï¼šå•è¡¨å¤‡ä»½æ—¶é—´è¿‡é•¿ ä¼ ç»Ÿä¼˜åŒ–æ–¹æ¡ˆçš„å±€é™\n1-- ä¼˜åŒ–ç´¢å¼• 2CREATE INDEX idx_user_id_create_time ON orders(user_id, create_time); 3 4-- åˆ†åŒºè¡¨ 5ALTER TABLE orders PARTITION BY RANGE (YEAR(create_time)) ( 6 PARTITION p2023 VALUES LESS THAN (2024), 7 PARTITION p2024 VALUES LESS THAN (2025) 8); è¿™äº›æ–¹æ¡ˆåªèƒ½ç¼“è§£é—®é¢˜ï¼Œæ— æ³•æ ¹æœ¬è§£å†³ã€‚å½“æ•°æ®é‡è¾¾åˆ°äº¿çº§æ—¶ï¼Œåˆ†åº“åˆ†è¡¨æ˜¯å¿…ç„¶é€‰æ‹©ã€‚\nåˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ å‚ç›´æ‹†åˆ† vs æ°´å¹³æ‹†åˆ† å‚ç›´æ‹†åˆ†ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†\n1åŸå§‹æ•°æ®åº“ 2â”œâ”€â”€ ç”¨æˆ·è¡¨ 3â”œâ”€â”€ è®¢å•è¡¨ 4â”œâ”€â”€ å•†å“è¡¨ 5â””â”€â”€ æ”¯ä»˜è¡¨ 6 7æ‹†åˆ†å 8â”œâ”€â”€ ç”¨æˆ·åº“ 9â”‚ â””â”€â”€ ç”¨æˆ·è¡¨ 10â”œâ”€â”€ è®¢å•åº“ 11â”‚ â””â”€â”€ è®¢å•è¡¨ 12â”œâ”€â”€ å•†å“åº“ 13â”‚ â””â”€â”€ å•†å“è¡¨ 14â””â”€â”€ æ”¯ä»˜åº“ 15 â””â”€â”€ æ”¯ä»˜è¡¨ æ°´å¹³æ‹†åˆ†ï¼šæŒ‰æ•°æ®è¡Œæ‹†åˆ†\n1è®¢å•è¡¨ï¼ˆ1äº¿æ¡æ•°æ®ï¼‰ 2 3æ‹†åˆ†å 4â”œâ”€â”€ orders_0ï¼ˆ2500ä¸‡æ¡ï¼‰ 5â”œâ”€â”€ orders_1ï¼ˆ2500ä¸‡æ¡ï¼‰ 6â”œâ”€â”€ orders_2ï¼ˆ2500ä¸‡æ¡ï¼‰ 7â””â”€â”€ orders_3ï¼ˆ2500ä¸‡æ¡ï¼‰ åˆ†ç‰‡é”®çš„é€‰æ‹© åˆ†ç‰‡é”®å†³å®šäº†æ•°æ®å¦‚ä½•åˆ†å¸ƒï¼Œé€‰æ‹©ä¸å½“ä¼šå¯¼è‡´æ•°æ®å€¾æ–œã€‚\nå¸¸è§åˆ†ç‰‡é”®ï¼š\nç”¨æˆ·IDï¼šé€‚åˆç”¨æˆ·ç»´åº¦æŸ¥è¯¢ è®¢å•IDï¼šé€‚åˆè®¢å•ç»´åº¦æŸ¥è¯¢ æ—¶é—´ï¼šé€‚åˆæ—¶é—´èŒƒå›´æŸ¥è¯¢ é€‰æ‹©åŸåˆ™ï¼š\né«˜é¢‘æŸ¥è¯¢å­—æ®µ æ•°æ®åˆ†å¸ƒå‡åŒ€ é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ ShardingSphere å¿«é€Ÿå…¥é—¨ å¼•å…¥ä¾èµ– 1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;org.apache.shardingsphere\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;shardingsphere-jdbc-core-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;5.3.2\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; åŸºç¡€é…ç½® 1spring: 2 shardingsphere: 3 # æ•°æ®æºé…ç½® 4 datasource: 5 names: ds0,ds1 6 ds0: 7 type: com.zaxxer.hikari.HikariDataSource 8 driver-class-name: com.mysql.cj.jdbc.Driver 9 jdbc-url: jdbc:mysql://localhost:3306/order_db_0 10 username: root 11 password: root 12 ds1: 13 type: com.zaxxer.hikari.HikariDataSource 14 driver-class-name: com.mysql.cj.jdbc.Driver 15 jdbc-url: jdbc:mysql://localhost:3306/order_db_1 16 username: root 17 password: root 18 19 # åˆ†ç‰‡è§„åˆ™ 20 rules: 21 sharding: 22 tables: 23 orders: 24 # å®é™…èŠ‚ç‚¹ 25 actual-data-nodes: ds$-\u0026gt;{0..1}.orders_$-\u0026gt;{0..3} 26 # åˆ†åº“ç­–ç•¥ 27 database-strategy: 28 standard: 29 sharding-column: user_id 30 sharding-algorithm-name: database-inline 31 # åˆ†è¡¨ç­–ç•¥ 32 table-strategy: 33 standard: 34 sharding-column: order_id 35 sharding-algorithm-name: table-inline 36 37 # åˆ†ç‰‡ç®—æ³• 38 sharding-algorithms: 39 database-inline: 40 type: INLINE 41 props: 42 algorithm-expression: ds$-\u0026gt;{user_id % 2} 43 table-inline: 44 type: INLINE 45 props: 46 algorithm-expression: orders_$-\u0026gt;{order_id % 4} 47 48 # å±æ€§é…ç½® 49 props: 50 sql-show: true å®ä½“ç±» 1@Data 2@TableName(\u0026#34;orders\u0026#34;) 3public class Order { 4 private Long orderId; 5 private Long userId; 6 private BigDecimal amount; 7 private Integer status; 8 private LocalDateTime createTime; 9} ä½¿ç”¨ç¤ºä¾‹ 1@Service 2public class OrderService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 /** 8 * æ’å…¥è®¢å• 9 * ShardingSphere ä¼šæ ¹æ® user_id å’Œ order_id è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”çš„åº“è¡¨ 10 */ 11 public void createOrder(Order order) { 12 orderMapper.insert(order); 13 } 14 15 /** 16 * æ ¹æ®è®¢å•IDæŸ¥è¯¢ 17 * å•åˆ†ç‰‡æŸ¥è¯¢ï¼Œæ€§èƒ½æœ€ä¼˜ 18 */ 19 public Order getById(Long orderId) { 20 return orderMapper.selectById(orderId); 21 } 22 23 /** 24 * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è®¢å•åˆ—è¡¨ 25 * å•åº“å¤šè¡¨æŸ¥è¯¢ï¼Œéœ€è¦åˆå¹¶ç»“æœ 26 */ 27 public List\u0026lt;Order\u0026gt; listByUserId(Long userId) { 28 return orderMapper.selectList( 29 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 30 .eq(Order::getUserId, userId) 31 .orderByDesc(Order::getCreateTime) 32 ); 33 } 34} åˆ†ç‰‡ç­–ç•¥è¯¦è§£ 1. æ ‡å‡†åˆ†ç‰‡ç­–ç•¥ï¼ˆStandardï¼‰ é€‚ç”¨äºå•ä¸€åˆ†ç‰‡é”®çš„åœºæ™¯ã€‚\n1database-strategy: 2 standard: 3 sharding-column: user_id 4 sharding-algorithm-name: database-mod å–æ¨¡ç®—æ³•\n1sharding-algorithms: 2 database-mod: 3 type: MOD 4 props: 5 sharding-count: 2 å“ˆå¸Œå–æ¨¡ç®—æ³•\n1sharding-algorithms: 2 database-hash-mod: 3 type: HASH_MOD 4 props: 5 sharding-count: 2 2. å¤åˆåˆ†ç‰‡ç­–ç•¥ï¼ˆComplexï¼‰ é€‚ç”¨äºå¤šä¸ªåˆ†ç‰‡é”®çš„åœºæ™¯ã€‚\n1database-strategy: 2 complex: 3 sharding-columns: user_id,order_id 4 sharding-algorithm-name: complex-inline 1sharding-algorithms: 2 complex-inline: 3 type: CLASS_BASED 4 props: 5 strategy: COMPLEX 6 algorithm-class-name: com.example.ComplexShardingAlgorithm è‡ªå®šä¹‰å¤åˆç®—æ³•\n1public class ComplexShardingAlgorithm implements ComplexKeysShardingAlgorithm\u0026lt;Long\u0026gt; { 2 3 @Override 4 public Collection\u0026lt;String\u0026gt; doSharding( 5 Collection\u0026lt;String\u0026gt; availableTargetNames, 6 ComplexKeysShardingValue\u0026lt;Long\u0026gt; shardingValue) { 7 8 // è·å–åˆ†ç‰‡é”®å€¼ 9 Map\u0026lt;String, Collection\u0026lt;Long\u0026gt;\u0026gt; columnNameAndShardingValuesMap = 10 shardingValue.getColumnNameAndShardingValuesMap(); 11 12 Collection\u0026lt;Long\u0026gt; userIds = columnNameAndShardingValuesMap.get(\u0026#34;user_id\u0026#34;); 13 Collection\u0026lt;Long\u0026gt; orderIds = columnNameAndShardingValuesMap.get(\u0026#34;order_id\u0026#34;); 14 15 // è‡ªå®šä¹‰åˆ†ç‰‡é€»è¾‘ 16 Set\u0026lt;String\u0026gt; result = new HashSet\u0026lt;\u0026gt;(); 17 for (Long userId : userIds) { 18 for (Long orderId : orderIds) { 19 String suffix = String.valueOf((userId + orderId) % 4); 20 result.addAll(availableTargetNames.stream() 21 .filter(name -\u0026gt; name.endsWith(suffix)) 22 .collect(Collectors.toList())); 23 } 24 } 25 return result; 26 } 27} 3. èŒƒå›´åˆ†ç‰‡ç­–ç•¥ï¼ˆRangeï¼‰ é€‚ç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢ã€‚\n1table-strategy: 2 standard: 3 sharding-column: create_time 4 sharding-algorithm-name: table-range 1sharding-algorithms: 2 table-range: 3 type: CLASS_BASED 4 props: 5 strategy: STANDARD 6 algorithm-class-name: com.example.RangeShardingAlgorithm æŒ‰æœˆåˆ†ç‰‡\n1public class RangeShardingAlgorithm implements StandardShardingAlgorithm\u0026lt;LocalDateTime\u0026gt; { 2 3 @Override 4 public String doSharding( 5 Collection\u0026lt;String\u0026gt; availableTargetNames, 6 PreciseShardingValue\u0026lt;LocalDateTime\u0026gt; shardingValue) { 7 8 LocalDateTime createTime = shardingValue.getValue(); 9 int month = createTime.getMonthValue(); 10 String suffix = String.format(\u0026#34;%02d\u0026#34;, month); 11 12 return availableTargetNames.stream() 13 .filter(name -\u0026gt; name.endsWith(suffix)) 14 .findFirst() 15 .orElseThrow(() -\u0026gt; new IllegalArgumentException(\u0026#34;æ‰¾ä¸åˆ°å¯¹åº”çš„åˆ†ç‰‡è¡¨\u0026#34;)); 16 } 17 18 @Override 19 public Collection\u0026lt;String\u0026gt; doSharding( 20 Collection\u0026lt;String\u0026gt; availableTargetNames, 21 RangeShardingValue\u0026lt;LocalDateTime\u0026gt; shardingValue) { 22 23 Range\u0026lt;LocalDateTime\u0026gt; range = shardingValue.getValueRange(); 24 LocalDateTime start = range.lowerEndpoint(); 25 LocalDateTime end = range.upperEndpoint(); 26 27 Set\u0026lt;String\u0026gt; result = new HashSet\u0026lt;\u0026gt;(); 28 for (int month = start.getMonthValue(); month \u0026lt;= end.getMonthValue(); month++) { 29 String suffix = String.format(\u0026#34;%02d\u0026#34;, month); 30 result.addAll(availableTargetNames.stream() 31 .filter(name -\u0026gt; name.endsWith(suffix)) 32 .collect(Collectors.toList())); 33 } 34 return result; 35 } 36} åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆ åˆ†åº“åˆ†è¡¨åï¼Œè‡ªå¢ä¸»é”®ä¼šå†²çªï¼Œéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®ã€‚\nSnowflake ç®—æ³• 1rules: 2 sharding: 3 tables: 4 orders: 5 key-generate-strategy: 6 column: order_id 7 key-generator-name: snowflake 8 9 key-generators: 10 snowflake: 11 type: SNOWFLAKE 12 props: 13 worker-id: 1 è‡ªå®šä¹‰ä¸»é”®ç”Ÿæˆå™¨ 1public class CustomKeyGenerator implements KeyGenerateAlgorithm { 2 3 @Override 4 public Comparable\u0026lt;?\u0026gt; generateKey() { 5 // æ—¶é—´æˆ³ï¼ˆ41ä½ï¼‰+ æœºå™¨IDï¼ˆ10ä½ï¼‰+ åºåˆ—å·ï¼ˆ12ä½ï¼‰ 6 long timestamp = System.currentTimeMillis(); 7 long workerId = getWorkerId(); 8 long sequence = getSequence(); 9 10 return (timestamp \u0026lt;\u0026lt; 22) | (workerId \u0026lt;\u0026lt; 12) | sequence; 11 } 12} è¯»å†™åˆ†ç¦» ShardingSphere æ”¯æŒä¸»ä»è¯»å†™åˆ†ç¦»ã€‚\n1rules: 2 readwrite-splitting: 3 data-sources: 4 ds0: 5 type: Static 6 props: 7 write-data-source-name: ds0-master 8 read-data-source-names: ds0-slave0,ds0-slave1 9 load-balancer-name: round-robin 10 ds1: 11 type: Static 12 props: 13 write-data-source-name: ds1-master 14 read-data-source-names: ds1-slave0,ds1-slave1 15 load-balancer-name: round-robin 16 17 load-balancers: 18 round-robin: 19 type: ROUND_ROBIN å¼ºåˆ¶ä¸»åº“æŸ¥è¯¢\n1// ä½¿ç”¨ HintManager å¼ºåˆ¶è·¯ç”±åˆ°ä¸»åº“ 2HintManager hintManager = HintManager.getInstance(); 3hintManager.setWriteRouteOnly(); 4try { 5 Order order = orderMapper.selectById(orderId); 6} finally { 7 hintManager.close(); 8} è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ï¼šå…¨è¡¨æ‰«æ 1// ä¸å¸¦åˆ†ç‰‡é”®çš„æŸ¥è¯¢ï¼Œä¼šæ‰«ææ‰€æœ‰åˆ†ç‰‡ 2List\u0026lt;Order\u0026gt; orders = orderMapper.selectList( 3 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 4 .eq(Order::getStatus, 1) 5); è§£å†³æ–¹æ¡ˆ1ï¼šå†—ä½™åˆ†ç‰‡é”® 1// åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­æ·»åŠ åˆ†ç‰‡é”® 2List\u0026lt;Order\u0026gt; orders = orderMapper.selectList( 3 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 4 .eq(Order::getUserId, userId) // åˆ†ç‰‡é”® 5 .eq(Order::getStatus, 1) 6); è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨ Hint 1// æ‰‹åŠ¨æŒ‡å®šåˆ†ç‰‡ 2HintManager hintManager = HintManager.getInstance(); 3hintManager.addDatabaseShardingValue(\u0026#34;orders\u0026#34;, \u0026#34;user_id\u0026#34;, userId); 4hintManager.addTableShardingValue(\u0026#34;orders\u0026#34;, \u0026#34;order_id\u0026#34;, orderId); 5try { 6 Order order = orderMapper.selectById(orderId); 7} finally { 8 hintManager.close(); 9} è§£å†³æ–¹æ¡ˆ3ï¼šå»ºç«‹æ˜ å°„è¡¨ 1-- è®¢å•çŠ¶æ€æ˜ å°„è¡¨ï¼ˆä¸åˆ†ç‰‡ï¼‰ 2CREATE TABLE order_status_mapping ( 3 order_id BIGINT PRIMARY KEY, 4 user_id BIGINT, 5 status INT, 6 INDEX idx_status (status) 7); 1// å…ˆæŸ¥æ˜ å°„è¡¨è·å–åˆ†ç‰‡é”® 2List\u0026lt;Long\u0026gt; orderIds = mappingMapper.selectOrderIdsByStatus(status); 3 4// å†æ ¹æ®åˆ†ç‰‡é”®æŸ¥è¯¢è¯¦æƒ… 5List\u0026lt;Order\u0026gt; orders = orderIds.stream() 6 .map(orderMapper::selectById) 7 .collect(Collectors.toList()); åˆ†å¸ƒå¼äº‹åŠ¡ ShardingSphere æ”¯æŒ XA å’Œ Saga ä¸¤ç§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nXA äº‹åŠ¡ 1rules: 2 transaction: 3 default-type: XA 4 provider-type: Atomikos 1@Transactional 2public void createOrderWithXA(Order order, OrderItem item) { 3 // è·¨åˆ†ç‰‡çš„äº‹åŠ¡æ“ä½œ 4 orderMapper.insert(order); 5 orderItemMapper.insert(item); 6} Saga äº‹åŠ¡ 1rules: 2 transaction: 3 default-type: BASE 4 provider-type: Seata æ¶æ„æ€è€ƒï¼š XA äº‹åŠ¡ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½è¾ƒå·®ï¼›Saga äº‹åŠ¡ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½æ›´å¥½ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Sagaï¼Œé€šè¿‡è¡¥å¿æœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚\næ•°æ®è¿ç§»æ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šåŒå†™ + æ•°æ®æ ¡éªŒ 1@Service 2public class OrderMigrationService { 3 4 @Autowired 5 private OrderMapper oldOrderMapper; // æ—§è¡¨ 6 7 @Autowired 8 private OrderMapper newOrderMapper; // æ–°è¡¨ï¼ˆåˆ†ç‰‡ï¼‰ 9 10 /** 11 * åŒå†™é˜¶æ®µï¼šåŒæ—¶å†™å…¥æ—§è¡¨å’Œæ–°è¡¨ 12 */ 13 public void createOrder(Order order) { 14 // å†™å…¥æ—§è¡¨ 15 oldOrderMapper.insert(order); 16 17 // å¼‚æ­¥å†™å…¥æ–°è¡¨ 18 CompletableFuture.runAsync(() -\u0026gt; { 19 try { 20 newOrderMapper.insert(order); 21 } catch (Exception e) { 22 log.error(\u0026#34;æ–°è¡¨å†™å…¥å¤±è´¥\u0026#34;, e); 23 // è®°å½•å¤±è´¥æ—¥å¿—ï¼Œåç»­è¡¥å¿ 24 } 25 }); 26 } 27 28 /** 29 * æ•°æ®æ ¡éªŒï¼šå¯¹æ¯”æ–°æ—§è¡¨æ•°æ® 30 */ 31 public void verifyData(Long orderId) { 32 Order oldOrder = oldOrderMapper.selectById(orderId); 33 Order newOrder = newOrderMapper.selectById(orderId); 34 35 if (!Objects.equals(oldOrder, newOrder)) { 36 log.error(\u0026#34;æ•°æ®ä¸ä¸€è‡´: orderId={}\u0026#34;, orderId); 37 // è§¦å‘å‘Šè­¦ 38 } 39 } 40} æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Canal åŒæ­¥ 1# Canal é…ç½® 2canal: 3 server: 127.0.0.1:11111 4 destination: example 5 username: canal 6 password: canal 7 filter: order_db\\\\.orders 1@Component 2public class CanalDataSyncListener { 3 4 @Autowired 5 private OrderMapper shardingOrderMapper; 6 7 @CanalEventListener 8 public void onEvent(CanalEntry.Entry entry) { 9 if (entry.getEntryType() == CanalEntry.EntryType.ROWDATA) { 10 RowChange rowChange = RowChange.parseFrom(entry.getStoreValue()); 11 12 for (CanalEntry.RowData rowData : rowChange.getRowDatasList()) { 13 if (rowChange.getEventType() == CanalEntry.EventType.INSERT) { 14 Order order = parseOrder(rowData.getAfterColumnsList()); 15 shardingOrderMapper.insert(order); 16 } 17 } 18 } 19 } 20} æ€§èƒ½å¯¹æ¯” æµ‹è¯•ç¯å¢ƒ æ•°æ®é‡ï¼š5000ä¸‡æ¡ åˆ†ç‰‡é…ç½®ï¼š2åº“ Ã— 4è¡¨ = 8ä¸ªåˆ†ç‰‡ æ¯ä¸ªåˆ†ç‰‡ï¼š625ä¸‡æ¡æ•°æ® æŸ¥è¯¢æ€§èƒ½å¯¹æ¯” åœºæ™¯ å•è¡¨ åˆ†åº“åˆ†è¡¨ æå‡ ä¸»é”®æŸ¥è¯¢ 150ms 15ms 10å€ ç´¢å¼•æŸ¥è¯¢ 800ms 80ms 10å€ èŒƒå›´æŸ¥è¯¢ 2000ms 250ms 8å€ èšåˆæŸ¥è¯¢ 5000ms 800ms 6å€ å†™å…¥æ€§èƒ½å¯¹æ¯” åœºæ™¯ å•è¡¨ åˆ†åº“åˆ†è¡¨ æå‡ å•æ¡æ’å…¥ 5ms 6ms æŒå¹³ æ‰¹é‡æ’å…¥ï¼ˆ1000æ¡ï¼‰ 800ms 200ms 4å€ æœ€ä½³å®è·µ 1. åˆ†ç‰‡é”®é€‰æ‹©\nä¼˜å…ˆé€‰æ‹©é«˜é¢‘æŸ¥è¯¢å­—æ®µ ç¡®ä¿æ•°æ®åˆ†å¸ƒå‡åŒ€ é¿å…çƒ­ç‚¹æ•°æ® 2. é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢\nåœ¨æŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«åˆ†ç‰‡é”® ä½¿ç”¨æ˜ å°„è¡¨è¾…åŠ©æŸ¥è¯¢ åˆç†è®¾è®¡æ•°æ®æ¨¡å‹ 3. åˆ†ç‰‡æ•°é‡è§„åˆ’\nå•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨500ä¸‡ä»¥å†… é¢„ç•™æ‰©å±•ç©ºé—´ï¼ˆ2-3å€ï¼‰ åˆ†ç‰‡æ•°é‡å»ºè®®ä¸º2çš„å¹‚æ¬¡æ–¹ 4. ç›‘æ§å‘Šè­¦\nç›‘æ§å„åˆ†ç‰‡æ•°æ®é‡ ç›‘æ§æ…¢æŸ¥è¯¢ ç›‘æ§è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹ 5. ç°åº¦å‘å¸ƒ\nå…ˆè¿ç§»å†å²æ•°æ® å†å¼€å¯åŒå†™ æœ€ååˆ‡æ¢è¯»æµé‡ é¿å‘æç¤ºï¼š åˆ†åº“åˆ†è¡¨ä¸æ˜¯é“¶å¼¹ï¼Œä¼šå¢åŠ ç³»ç»Ÿå¤æ‚åº¦ã€‚åœ¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§ä¹‹å‰ï¼Œä¼˜å…ˆè€ƒè™‘ç´¢å¼•ä¼˜åŒ–ã€ç¼“å­˜ã€è¯»å†™åˆ†ç¦»ç­‰æ–¹æ¡ˆã€‚åªæœ‰åœ¨è¿™äº›æ–¹æ¡ˆéƒ½æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå†è€ƒè™‘åˆ†åº“åˆ†è¡¨ã€‚\næ€»ç»“ä¸æ€è€ƒ ShardingSphere åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒè¦ç‚¹ï¼š\né€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®ï¼Œé¿å…æ•°æ®å€¾æ–œ ä½¿ç”¨æ ‡å‡†åˆ†ç‰‡ç­–ç•¥ï¼Œç®€åŒ–é…ç½® é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½ ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®ï¼Œé¿å…IDå†²çª ç°åº¦è¿ç§»æ•°æ®ï¼Œé™ä½é£é™© åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¤æ‚åº¦ã€‚åœ¨å®æ–½å‰è¦å……åˆ†è¯„ä¼°ï¼š\næ˜¯å¦çœŸçš„éœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ åˆ†ç‰‡é”®å¦‚ä½•é€‰æ‹©ï¼Ÿ å¦‚ä½•å¤„ç†è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼Ÿ å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ ä¸‹æ¬¡å½“ä½ çš„å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§æ—¶ï¼Œä¸å¦¨è¯•è¯• ShardingSphereï¼Œè®©æ•°æ®åº“æ€§èƒ½é‡å›å·…å³°ã€‚\n","permalink":"http://localhost:1313/posts/2025/02/shardingsphere-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9A%84%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eå½“å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§åˆ«æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆã€‚æœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ ShardingSphere å®ç°åˆ†åº“åˆ†è¡¨ï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒçš„å®æˆ˜ç»éªŒã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒæ¦‚å¿µå’Œåº”ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ ShardingSphere çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†åº“åˆ†è¡¨çš„æœ€ä½³å®è·µå’Œå¸¸è§é—®é¢˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨\"\u003eä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼šè®¢å•è¡¨æ•°æ®çˆ†ç‚¸\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç”µå•†ç³»ç»Ÿçš„è®¢å•è¡¨ï¼Œæ¯å¤©æ–°å¢10ä¸‡æ¡æ•°æ®ï¼Œä¸€å¹´å°±æ˜¯3600ä¸‡æ¡ã€‚éšç€æ•°æ®é‡å¢é•¿ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæŸ¥è¯¢å˜æ…¢\u003c/strong\u003eï¼šå•è¡¨æŸ¥è¯¢ä»æ¯«ç§’çº§å˜æˆç§’çº§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç´¢å¼•å¤±æ•ˆ\u003c/strong\u003eï¼šB+æ ‘å±‚çº§å¢åŠ ï¼Œç´¢å¼•æ•ˆç‡ä¸‹é™\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eé”ç«äº‰\u003c/strong\u003eï¼šå¤§è¡¨çš„é”ç²’åº¦å¤§ï¼Œå¹¶å‘æ€§èƒ½å·®\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå¤‡ä»½å›°éš¾\u003c/strong\u003eï¼šå•è¡¨å¤‡ä»½æ—¶é—´è¿‡é•¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿä¼˜åŒ–æ–¹æ¡ˆçš„å±€é™\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e-- ä¼˜åŒ–ç´¢å¼•\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCREATE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eINDEX\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eidx_user_id_create_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eON\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser_id\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e-- åˆ†åŒºè¡¨\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eALTER\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eBY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRANGE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eYEAR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ep2023\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eLESS\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTHAN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2024\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ep2024\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eLESS\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTHAN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2025\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™äº›æ–¹æ¡ˆåªèƒ½ç¼“è§£é—®é¢˜ï¼Œæ— æ³•æ ¹æœ¬è§£å†³ã€‚å½“æ•°æ®é‡è¾¾åˆ°äº¿çº§æ—¶ï¼Œåˆ†åº“åˆ†è¡¨æ˜¯å¿…ç„¶é€‰æ‹©ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ\"\u003eåˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003ch3 id=\"å‚ç›´æ‹†åˆ†-vs-æ°´å¹³æ‹†åˆ†\"\u003eå‚ç›´æ‹†åˆ† vs æ°´å¹³æ‹†åˆ†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eå‚ç›´æ‹†åˆ†\u003c/strong\u003eï¼šæŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003eåŸå§‹æ•°æ®åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ ç”¨æˆ·è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ è®¢å•è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ å•†å“è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ æ”¯ä»˜è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003eæ‹†åˆ†å\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ ç”¨æˆ·åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ ç”¨æˆ·è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ è®¢å•åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ è®¢å•è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ å•†å“åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ å•†å“è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ æ”¯ä»˜åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    â””â”€â”€ æ”¯ä»˜è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ°´å¹³æ‹†åˆ†\u003c/strong\u003eï¼šæŒ‰æ•°æ®è¡Œæ‹†åˆ†\u003c/p\u003e","title":"ShardingSphere åˆ†åº“åˆ†è¡¨çš„ç”Ÿäº§å®æˆ˜"},{"content":"åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°çš„é…ç½®å¾€å¾€éœ€è¦æ ¹æ®å®é™…è´Ÿè½½åŠ¨æ€è°ƒæ•´ã€‚ç¡¬ç¼–ç çš„å‚æ•°é…ç½®ç¼ºä¹çµæ´»æ€§ï¼Œé‡å¯æœåŠ¡åˆä¼šå½±å“ä¸šåŠ¡ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•è®¾è®¡ä¸€ä¸ªçº¿ç¨‹æ± ç®¡ç†åå°ï¼Œå®ç°å‚æ•°çš„åŠ¨æ€é…ç½®å’Œå®æ—¶ç›‘æ§ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£çº¿ç¨‹æ± å‚æ•°åŠ¨æ€è°ƒæ•´çš„åŸç†ä¸å®ç° æŒæ¡çº¿ç¨‹æ± ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†ä¸å±•ç¤º å­¦ä¼šè®¾è®¡ç”Ÿäº§çº§çš„çº¿ç¨‹æ± ç®¡ç†å¹³å° äº†è§£çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜çš„æœ€ä½³å®è·µ ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®ï¼Ÿ åœºæ™¯ä¸€ï¼šæµé‡çªå¢\nåŒåä¸€æœŸé—´ï¼Œè®¢å•å¤„ç†çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º 10ï¼Œæœ€å¤§çº¿ç¨‹æ•° 20ã€‚çªç„¶æµé‡æš´å¢ï¼Œé˜Ÿåˆ—å †ç§¯ä¸¥é‡ï¼Œå¯¼è‡´è®¢å•å¤„ç†å»¶è¿Ÿã€‚\nå¦‚æœèƒ½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼Œå°†æ ¸å¿ƒçº¿ç¨‹æ•°è°ƒæ•´ä¸º 50ï¼Œæœ€å¤§çº¿ç¨‹æ•°è°ƒæ•´ä¸º 100ï¼Œå°±èƒ½å¿«é€Ÿåº”å¯¹æµé‡é«˜å³°ã€‚\nåœºæ™¯äºŒï¼šèµ„æºæµªè´¹\nå‡Œæ™¨æ—¶æ®µæµé‡å¾ˆä½ï¼Œä½†çº¿ç¨‹æ± ä»ç„¶ä¿æŒé«˜å³°æœŸçš„é…ç½®ï¼Œæµªè´¹äº†å¤§é‡ç³»ç»Ÿèµ„æºã€‚\nä¼ ç»Ÿåšæ³•çš„é—®é¢˜\n1@Configuration 2public class ThreadPoolConfig { 3 @Bean(\u0026#34;orderThreadPool\u0026#34;) 4 public ThreadPoolExecutor orderThreadPool() { 5 return new ThreadPoolExecutor( 6 10, // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç  7 20, // æœ€å¤§çº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç  8 60, TimeUnit.SECONDS, 9 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 10 new ThreadFactoryBuilder().setNameFormat(\u0026#34;order-pool-%d\u0026#34;).build(), 11 new ThreadPoolExecutor.CallerRunsPolicy() 12 ); 13 } 14} é—®é¢˜ï¼š\nå‚æ•°ç¡¬ç¼–ç ï¼Œæ— æ³•åŠ¨æ€è°ƒæ•´ è°ƒæ•´å‚æ•°éœ€è¦é‡å¯æœåŠ¡ ç¼ºä¹ç›‘æ§ï¼Œæ— æ³•äº†è§£çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ ç³»ç»Ÿæ¶æ„è®¾è®¡ æ•´ä½“æ¶æ„ 1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ Admin ç®¡ç†åå° â”‚ 3â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 4â”‚ â”‚ çº¿ç¨‹æ± åˆ—è¡¨ â”‚ â”‚ å®æ—¶ç›‘æ§ â”‚ â”‚ å‚æ•°è°ƒæ•´ â”‚ â”‚ 5â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 6â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 7 â†“ HTTP API 8â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 9â”‚ Spring Boot åº”ç”¨ â”‚ 10â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 11â”‚ â”‚ ThreadPoolRegistry â”‚ â”‚ 12â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ 13â”‚ â”‚ â”‚ è®¢å•çº¿ç¨‹æ± â”‚ â”‚ æ”¯ä»˜çº¿ç¨‹æ± â”‚ â”‚ é€šçŸ¥çº¿ç¨‹æ± â”‚ â”‚ â”‚ 14â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ 15â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 16â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 17â”‚ â”‚ ThreadPoolMonitor â”‚ â”‚ 18â”‚ â”‚ (å®šæ—¶é‡‡é›†æŒ‡æ ‡ï¼Œä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ) â”‚ â”‚ 19â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 20â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒç»„ä»¶ ThreadPoolRegistryï¼šçº¿ç¨‹æ± æ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†æ‰€æœ‰çº¿ç¨‹æ± å®ä¾‹ ThreadPoolMonitorï¼šç›‘æ§ç»„ä»¶ï¼Œå®šæ—¶é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ ThreadPoolControllerï¼šREST APIï¼Œæä¾›æŸ¥è¯¢å’Œè°ƒæ•´æ¥å£ Admin ç®¡ç†åå°ï¼šå‰ç«¯é¡µé¢ï¼Œå±•ç¤ºç›‘æ§æ•°æ®å’Œå‚æ•°è°ƒæ•´ç•Œé¢ ç¬¬ä¸€æ­¥ï¼šçº¿ç¨‹æ± æ³¨å†Œä¸­å¿ƒ ThreadPoolRegistry\n1@Component 2public class ThreadPoolRegistry { 3 4 private final Map\u0026lt;String, ThreadPoolExecutor\u0026gt; executors = new ConcurrentHashMap\u0026lt;\u0026gt;(); 5 6 /** 7 * æ³¨å†Œçº¿ç¨‹æ±  8 */ 9 public void register(String name, ThreadPoolExecutor executor) { 10 executors.put(name, executor); 11 log.info(\u0026#34;æ³¨å†Œçº¿ç¨‹æ± : {}, æ ¸å¿ƒçº¿ç¨‹æ•°: {}, æœ€å¤§çº¿ç¨‹æ•°: {}\u0026#34;, 12 name, executor.getCorePoolSize(), executor.getMaximumPoolSize()); 13 } 14 15 /** 16 * è·å–æ‰€æœ‰çº¿ç¨‹æ±  17 */ 18 public Map\u0026lt;String, ThreadPoolExecutor\u0026gt; getAll() { 19 return Collections.unmodifiableMap(executors); 20 } 21 22 /** 23 * æ ¹æ®åç§°è·å–çº¿ç¨‹æ±  24 */ 25 public ThreadPoolExecutor get(String name) { 26 return executors.get(name); 27 } 28 29 /** 30 * åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 31 */ 32 public void adjust(String name, int corePoolSize, int maximumPoolSize) { 33 ThreadPoolExecutor executor = executors.get(name); 34 if (executor == null) { 35 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + name); 36 } 37 38 // å‚æ•°æ ¡éªŒ 39 if (corePoolSize \u0026lt;= 0 || maximumPoolSize \u0026lt;= 0) { 40 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± å‚æ•°å¿…é¡»å¤§äº 0\u0026#34;); 41 } 42 if (corePoolSize \u0026gt; maximumPoolSize) { 43 throw new IllegalArgumentException(\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å¤§äºæœ€å¤§çº¿ç¨‹æ•°\u0026#34;); 44 } 45 46 // è°ƒæ•´å‚æ•° 47 executor.setCorePoolSize(corePoolSize); 48 executor.setMaximumPoolSize(maximumPoolSize); 49 50 log.info(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°: {}, æ ¸å¿ƒçº¿ç¨‹æ•°: {} -\u0026gt; {}, æœ€å¤§çº¿ç¨‹æ•°: {} -\u0026gt; {}\u0026#34;, 51 name, executor.getCorePoolSize(), corePoolSize, 52 executor.getMaximumPoolSize(), maximumPoolSize); 53 } 54} è‡ªåŠ¨æ³¨å†Œçº¿ç¨‹æ± \nä½¿ç”¨ BeanPostProcessor è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰ ThreadPoolExecutorï¼š\n1@Component 2public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Override 8 public Object postProcessAfterInitialization(Object bean, String beanName) { 9 if (bean instanceof ThreadPoolExecutor) { 10 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 11 registry.register(beanName, executor); 12 } 13 return bean; 14 } 15} è¿™æ ·ï¼Œæ‰€æœ‰é€šè¿‡ Spring ç®¡ç†çš„ ThreadPoolExecutor éƒ½ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° Registry ä¸­ã€‚\nç¬¬äºŒæ­¥ï¼šç›‘æ§æŒ‡æ ‡é‡‡é›† ThreadPoolMetrics\n1@Data 2@Builder 3public class ThreadPoolMetrics { 4 private String name; // çº¿ç¨‹æ± åç§° 5 private int corePoolSize; // æ ¸å¿ƒçº¿ç¨‹æ•° 6 private int maximumPoolSize; // æœ€å¤§çº¿ç¨‹æ•° 7 private int activeCount; // æ´»è·ƒçº¿ç¨‹æ•° 8 private int poolSize; // å½“å‰çº¿ç¨‹æ•° 9 private int queueSize; // é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•° 10 private int queueRemainingCapacity; // é˜Ÿåˆ—å‰©ä½™å®¹é‡ 11 private long completedTaskCount; // å·²å®Œæˆä»»åŠ¡æ•° 12 private long taskCount; // æ€»ä»»åŠ¡æ•° 13 private String rejectedExecutionHandler; // æ‹’ç»ç­–ç•¥ 14 private long timestamp; // é‡‡é›†æ—¶é—´æˆ³ 15 16 /** 17 * è®¡ç®—çº¿ç¨‹æ± ä½¿ç”¨ç‡ 18 */ 19 public double getPoolUsageRate() { 20 return maximumPoolSize == 0 ? 0 : (double) poolSize / maximumPoolSize * 100; 21 } 22 23 /** 24 * è®¡ç®—é˜Ÿåˆ—ä½¿ç”¨ç‡ 25 */ 26 public double getQueueUsageRate() { 27 int capacity = queueSize + queueRemainingCapacity; 28 return capacity == 0 ? 0 : (double) queueSize / capacity * 100; 29 } 30} ThreadPoolMonitor\n1@Component 2@Slf4j 3public class ThreadPoolMonitor { 4 5 @Autowired 6 private ThreadPoolRegistry registry; 7 8 /** 9 * å®šæ—¶é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ 10 */ 11 @Scheduled(fixedDelay = 30000) // æ¯ 30 ç§’é‡‡é›†ä¸€æ¬¡ 12 public void collect() { 13 registry.getAll().forEach((name, executor) -\u0026gt; { 14 ThreadPoolMetrics metrics = collectMetrics(name, executor); 15 16 // æ‰“å°æ—¥å¿— 17 log.info(\u0026#34;çº¿ç¨‹æ± æŒ‡æ ‡: {}\u0026#34;, metrics); 18 19 // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€InfluxDB ç­‰ï¼‰ 20 reportToMonitor(metrics); 21 22 // æ£€æŸ¥å‘Šè­¦æ¡ä»¶ 23 checkAlert(metrics); 24 }); 25 } 26 27 /** 28 * é‡‡é›†å•ä¸ªçº¿ç¨‹æ± çš„æŒ‡æ ‡ 29 */ 30 private ThreadPoolMetrics collectMetrics(String name, ThreadPoolExecutor executor) { 31 return ThreadPoolMetrics.builder() 32 .name(name) 33 .corePoolSize(executor.getCorePoolSize()) 34 .maximumPoolSize(executor.getMaximumPoolSize()) 35 .activeCount(executor.getActiveCount()) 36 .poolSize(executor.getPoolSize()) 37 .queueSize(executor.getQueue().size()) 38 .queueRemainingCapacity(executor.getQueue().remainingCapacity()) 39 .completedTaskCount(executor.getCompletedTaskCount()) 40 .taskCount(executor.getTaskCount()) 41 .rejectedExecutionHandler(executor.getRejectedExecutionHandler().getClass().getSimpleName()) 42 .timestamp(System.currentTimeMillis()) 43 .build(); 44 } 45 46 /** 47 * ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ 48 */ 49 private void reportToMonitor(ThreadPoolMetrics metrics) { 50 // é›†æˆ Prometheusã€InfluxDB ç­‰ç›‘æ§ç³»ç»Ÿ 51 // è¿™é‡Œçœç•¥å…·ä½“å®ç° 52 } 53 54 /** 55 * æ£€æŸ¥å‘Šè­¦æ¡ä»¶ 56 */ 57 private void checkAlert(ThreadPoolMetrics metrics) { 58 // é˜Ÿåˆ—ä½¿ç”¨ç‡è¶…è¿‡ 80% 59 if (metrics.getQueueUsageRate() \u0026gt; 80) { 60 log.warn(\u0026#34;çº¿ç¨‹æ±  {} é˜Ÿåˆ—ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, 61 metrics.getName(), metrics.getQueueUsageRate()); 62 // å‘é€å‘Šè­¦ï¼ˆé’‰é’‰ã€é‚®ä»¶ç­‰ï¼‰ 63 } 64 65 // çº¿ç¨‹æ± ä½¿ç”¨ç‡è¶…è¿‡ 90% 66 if (metrics.getPoolUsageRate() \u0026gt; 90) { 67 log.warn(\u0026#34;çº¿ç¨‹æ±  {} ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, 68 metrics.getName(), metrics.getPoolUsageRate()); 69 } 70 } 71} æ¶æ„æ€è€ƒï¼š ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†é¢‘ç‡éœ€è¦æƒè¡¡ã€‚é¢‘ç‡å¤ªé«˜ä¼šå¢åŠ ç³»ç»Ÿå¼€é”€ï¼Œé¢‘ç‡å¤ªä½åˆæ— æ³•åŠæ—¶å‘ç°é—®é¢˜ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®® 30-60 ç§’é‡‡é›†ä¸€æ¬¡ï¼Œå‘Šè­¦é˜ˆå€¼å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚\nç¬¬ä¸‰æ­¥ï¼šREST API æ¥å£ ThreadPoolController\n1@RestController 2@RequestMapping(\u0026#34;/api/threadpool\u0026#34;) 3@Slf4j 4public class ThreadPoolController { 5 6 @Autowired 7 private ThreadPoolRegistry registry; 8 9 /** 10 * æŸ¥è¯¢æ‰€æœ‰çº¿ç¨‹æ±  11 */ 12 @GetMapping(\u0026#34;/list\u0026#34;) 13 public Result\u0026lt;List\u0026lt;ThreadPoolInfo\u0026gt;\u0026gt; list() { 14 List\u0026lt;ThreadPoolInfo\u0026gt; list = registry.getAll().entrySet().stream() 15 .map(entry -\u0026gt; ThreadPoolInfo.from(entry.getKey(), entry.getValue())) 16 .collect(Collectors.toList()); 17 return Result.success(list); 18 } 19 20 /** 21 * æŸ¥è¯¢å•ä¸ªçº¿ç¨‹æ± è¯¦æƒ… 22 */ 23 @GetMapping(\u0026#34;/detail/{name}\u0026#34;) 24 public Result\u0026lt;ThreadPoolInfo\u0026gt; detail(@PathVariable String name) { 25 ThreadPoolExecutor executor = registry.get(name); 26 if (executor == null) { 27 return Result.error(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + name); 28 } 29 return Result.success(ThreadPoolInfo.from(name, executor)); 30 } 31 32 /** 33 * åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 34 */ 35 @PostMapping(\u0026#34;/adjust\u0026#34;) 36 public Result\u0026lt;Void\u0026gt; adjust(@RequestBody ThreadPoolAdjustRequest request) { 37 try { 38 registry.adjust( 39 request.getName(), 40 request.getCorePoolSize(), 41 request.getMaximumPoolSize() 42 ); 43 return Result.success(); 44 } catch (Exception e) { 45 log.error(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°å¤±è´¥\u0026#34;, e); 46 return Result.error(e.getMessage()); 47 } 48 } 49} ThreadPoolInfo\n1@Data 2@Builder 3public class ThreadPoolInfo { 4 private String name; 5 private int corePoolSize; 6 private int maximumPoolSize; 7 private int activeCount; 8 private int poolSize; 9 private int queueSize; 10 private int queueCapacity; 11 private long completedTaskCount; 12 private long taskCount; 13 private String rejectedExecutionHandler; 14 private double poolUsageRate; 15 private double queueUsageRate; 16 17 public static ThreadPoolInfo from(String name, ThreadPoolExecutor executor) { 18 int queueSize = executor.getQueue().size(); 19 int queueCapacity = queueSize + executor.getQueue().remainingCapacity(); 20 21 return ThreadPoolInfo.builder() 22 .name(name) 23 .corePoolSize(executor.getCorePoolSize()) 24 .maximumPoolSize(executor.getMaximumPoolSize()) 25 .activeCount(executor.getActiveCount()) 26 .poolSize(executor.getPoolSize()) 27 .queueSize(queueSize) 28 .queueCapacity(queueCapacity) 29 .completedTaskCount(executor.getCompletedTaskCount()) 30 .taskCount(executor.getTaskCount()) 31 .rejectedExecutionHandler(executor.getRejectedExecutionHandler().getClass().getSimpleName()) 32 .poolUsageRate((double) executor.getPoolSize() / executor.getMaximumPoolSize() * 100) 33 .queueUsageRate(queueCapacity == 0 ? 0 : (double) queueSize / queueCapacity * 100) 34 .build(); 35 } 36} ThreadPoolAdjustRequest\n1@Data 2public class ThreadPoolAdjustRequest { 3 @NotBlank(message = \u0026#34;çº¿ç¨‹æ± åç§°ä¸èƒ½ä¸ºç©º\u0026#34;) 4 private String name; 5 6 @Min(value = 1, message = \u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°å¿…é¡»å¤§äº 0\u0026#34;) 7 private int corePoolSize; 8 9 @Min(value = 1, message = \u0026#34;æœ€å¤§çº¿ç¨‹æ•°å¿…é¡»å¤§äº 0\u0026#34;) 10 private int maximumPoolSize; 11} ç¬¬å››æ­¥ï¼šAdmin ç®¡ç†åå° å‰ç«¯æŠ€æœ¯æ ˆ\nVue 3 + Element Plus EChartsï¼ˆå›¾è¡¨å±•ç¤ºï¼‰ Axiosï¼ˆHTTP è¯·æ±‚ï¼‰ çº¿ç¨‹æ± åˆ—è¡¨é¡µé¢\n1\u0026lt;template\u0026gt; 2 \u0026lt;div class=\u0026#34;threadpool-list\u0026#34;\u0026gt; 3 \u0026lt;el-table :data=\u0026#34;threadPoolList\u0026#34; border\u0026gt; 4 \u0026lt;el-table-column prop=\u0026#34;name\u0026#34; label=\u0026#34;çº¿ç¨‹æ± åç§°\u0026#34; width=\u0026#34;200\u0026#34; /\u0026gt; 5 \u0026lt;el-table-column prop=\u0026#34;corePoolSize\u0026#34; label=\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 6 \u0026lt;el-table-column prop=\u0026#34;maximumPoolSize\u0026#34; label=\u0026#34;æœ€å¤§çº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 7 \u0026lt;el-table-column prop=\u0026#34;activeCount\u0026#34; label=\u0026#34;æ´»è·ƒçº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 8 \u0026lt;el-table-column prop=\u0026#34;poolSize\u0026#34; label=\u0026#34;å½“å‰çº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 9 \u0026lt;el-table-column prop=\u0026#34;queueSize\u0026#34; label=\u0026#34;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 10 \u0026lt;el-table-column label=\u0026#34;çº¿ç¨‹æ± ä½¿ç”¨ç‡\u0026#34; width=\u0026#34;150\u0026#34;\u0026gt; 11 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 12 \u0026lt;el-progress 13 :percentage=\u0026#34;row.poolUsageRate\u0026#34; 14 :color=\u0026#34;getProgressColor(row.poolUsageRate)\u0026#34; 15 /\u0026gt; 16 \u0026lt;/template\u0026gt; 17 \u0026lt;/el-table-column\u0026gt; 18 \u0026lt;el-table-column label=\u0026#34;é˜Ÿåˆ—ä½¿ç”¨ç‡\u0026#34; width=\u0026#34;150\u0026#34;\u0026gt; 19 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 20 \u0026lt;el-progress 21 :percentage=\u0026#34;row.queueUsageRate\u0026#34; 22 :color=\u0026#34;getProgressColor(row.queueUsageRate)\u0026#34; 23 /\u0026gt; 24 \u0026lt;/template\u0026gt; 25 \u0026lt;/el-table-column\u0026gt; 26 \u0026lt;el-table-column label=\u0026#34;æ“ä½œ\u0026#34; width=\u0026#34;200\u0026#34;\u0026gt; 27 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 28 \u0026lt;el-button size=\u0026#34;small\u0026#34; @click=\u0026#34;showAdjustDialog(row)\u0026#34;\u0026gt; 29 è°ƒæ•´å‚æ•° 30 \u0026lt;/el-button\u0026gt; 31 \u0026lt;el-button size=\u0026#34;small\u0026#34; @click=\u0026#34;showMonitorDialog(row)\u0026#34;\u0026gt; 32 æŸ¥çœ‹ç›‘æ§ 33 \u0026lt;/el-button\u0026gt; 34 \u0026lt;/template\u0026gt; 35 \u0026lt;/el-table-column\u0026gt; 36 \u0026lt;/el-table\u0026gt; 37 38 \u0026lt;!-- å‚æ•°è°ƒæ•´å¯¹è¯æ¡† --\u0026gt; 39 \u0026lt;el-dialog v-model=\u0026#34;adjustDialogVisible\u0026#34; title=\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°\u0026#34;\u0026gt; 40 \u0026lt;el-form :model=\u0026#34;adjustForm\u0026#34; label-width=\u0026#34;120px\u0026#34;\u0026gt; 41 \u0026lt;el-form-item label=\u0026#34;çº¿ç¨‹æ± åç§°\u0026#34;\u0026gt; 42 \u0026lt;el-input v-model=\u0026#34;adjustForm.name\u0026#34; disabled /\u0026gt; 43 \u0026lt;/el-form-item\u0026gt; 44 \u0026lt;el-form-item label=\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#34;\u0026gt; 45 \u0026lt;el-input-number v-model=\u0026#34;adjustForm.corePoolSize\u0026#34; :min=\u0026#34;1\u0026#34; /\u0026gt; 46 \u0026lt;/el-form-item\u0026gt; 47 \u0026lt;el-form-item label=\u0026#34;æœ€å¤§çº¿ç¨‹æ•°\u0026#34;\u0026gt; 48 \u0026lt;el-input-number v-model=\u0026#34;adjustForm.maximumPoolSize\u0026#34; :min=\u0026#34;1\u0026#34; /\u0026gt; 49 \u0026lt;/el-form-item\u0026gt; 50 \u0026lt;/el-form\u0026gt; 51 \u0026lt;template #footer\u0026gt; 52 \u0026lt;el-button @click=\u0026#34;adjustDialogVisible = false\u0026#34;\u0026gt;å–æ¶ˆ\u0026lt;/el-button\u0026gt; 53 \u0026lt;el-button type=\u0026#34;primary\u0026#34; @click=\u0026#34;adjustThreadPool\u0026#34;\u0026gt;ç¡®å®š\u0026lt;/el-button\u0026gt; 54 \u0026lt;/template\u0026gt; 55 \u0026lt;/el-dialog\u0026gt; 56 \u0026lt;/div\u0026gt; 57\u0026lt;/template\u0026gt; 58 59\u0026lt;script setup\u0026gt; 60import { ref, onMounted } from \u0026#39;vue\u0026#39;; 61import { ElMessage } from \u0026#39;element-plus\u0026#39;; 62import axios from \u0026#39;axios\u0026#39;; 63 64const threadPoolList = ref([]); 65const adjustDialogVisible = ref(false); 66const adjustForm = ref({ 67 name: \u0026#39;\u0026#39;, 68 corePoolSize: 0, 69 maximumPoolSize: 0 70}); 71 72// åŠ è½½çº¿ç¨‹æ± åˆ—è¡¨ 73const loadThreadPoolList = async () =\u0026gt; { 74 const { data } = await axios.get(\u0026#39;/api/threadpool/list\u0026#39;); 75 threadPoolList.value = data.data; 76}; 77 78// æ˜¾ç¤ºè°ƒæ•´å¯¹è¯æ¡† 79const showAdjustDialog = (row) =\u0026gt; { 80 adjustForm.value = { 81 name: row.name, 82 corePoolSize: row.corePoolSize, 83 maximumPoolSize: row.maximumPoolSize 84 }; 85 adjustDialogVisible.value = true; 86}; 87 88// è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 89const adjustThreadPool = async () =\u0026gt; { 90 try { 91 await axios.post(\u0026#39;/api/threadpool/adjust\u0026#39;, adjustForm.value); 92 ElMessage.success(\u0026#39;è°ƒæ•´æˆåŠŸ\u0026#39;); 93 adjustDialogVisible.value = false; 94 loadThreadPoolList(); 95 } catch (error) { 96 ElMessage.error(\u0026#39;è°ƒæ•´å¤±è´¥: \u0026#39; + error.message); 97 } 98}; 99 100// è¿›åº¦æ¡é¢œè‰² 101const getProgressColor = (percentage) =\u0026gt; { 102 if (percentage \u0026lt; 60) return \u0026#39;#67C23A\u0026#39;; 103 if (percentage \u0026lt; 80) return \u0026#39;#E6A23C\u0026#39;; 104 return \u0026#39;#F56C6C\u0026#39;; 105}; 106 107onMounted(() =\u0026gt; { 108 loadThreadPoolList(); 109 // æ¯ 30 ç§’åˆ·æ–°ä¸€æ¬¡ 110 setInterval(loadThreadPoolList, 30000); 111}); 112\u0026lt;/script\u0026gt; å®æ—¶ç›‘æ§é¡µé¢\nä½¿ç”¨ ECharts å±•ç¤ºçº¿ç¨‹æ± æŒ‡æ ‡çš„æ—¶é—´åºåˆ—å›¾ï¼š\n1// çº¿ç¨‹æ± ç›‘æ§å›¾è¡¨ 2const initChart = () =\u0026gt; { 3 const chart = echarts.init(document.getElementById(\u0026#39;chart\u0026#39;)); 4 5 const option = { 6 title: { text: \u0026#39;çº¿ç¨‹æ± ç›‘æ§\u0026#39; }, 7 tooltip: { trigger: \u0026#39;axis\u0026#39; }, 8 legend: { 9 data: [\u0026#39;æ´»è·ƒçº¿ç¨‹æ•°\u0026#39;, \u0026#39;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#39;, \u0026#39;å®Œæˆä»»åŠ¡æ•°\u0026#39;] 10 }, 11 xAxis: { 12 type: \u0026#39;category\u0026#39;, 13 data: timeLabels.value 14 }, 15 yAxis: { type: \u0026#39;value\u0026#39; }, 16 series: [ 17 { 18 name: \u0026#39;æ´»è·ƒçº¿ç¨‹æ•°\u0026#39;, 19 type: \u0026#39;line\u0026#39;, 20 data: activeCountData.value 21 }, 22 { 23 name: \u0026#39;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#39;, 24 type: \u0026#39;line\u0026#39;, 25 data: queueSizeData.value 26 }, 27 { 28 name: \u0026#39;å®Œæˆä»»åŠ¡æ•°\u0026#39;, 29 type: \u0026#39;line\u0026#39;, 30 data: completedTaskCountData.value 31 } 32 ] 33 }; 34 35 chart.setOption(option); 36}; ç¬¬äº”æ­¥ï¼šæŒä¹…åŒ–é…ç½® å°†è°ƒæ•´åçš„å‚æ•°æŒä¹…åŒ–åˆ°æ•°æ®åº“æˆ–é…ç½®ä¸­å¿ƒï¼Œé‡å¯åè‡ªåŠ¨åŠ è½½ã€‚\næ•°æ®åº“è¡¨è®¾è®¡\n1CREATE TABLE threadpool_config ( 2 id BIGINT PRIMARY KEY AUTO_INCREMENT, 3 name VARCHAR(100) NOT NULL UNIQUE COMMENT \u0026#39;çº¿ç¨‹æ± åç§°\u0026#39;, 4 core_pool_size INT NOT NULL COMMENT \u0026#39;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#39;, 5 maximum_pool_size INT NOT NULL COMMENT \u0026#39;æœ€å¤§çº¿ç¨‹æ•°\u0026#39;, 6 keep_alive_time BIGINT NOT NULL COMMENT \u0026#39;ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰\u0026#39;, 7 queue_capacity INT NOT NULL COMMENT \u0026#39;é˜Ÿåˆ—å®¹é‡\u0026#39;, 8 rejected_execution_handler VARCHAR(100) COMMENT \u0026#39;æ‹’ç»ç­–ç•¥\u0026#39;, 9 created_time DATETIME NOT NULL, 10 updated_time DATETIME NOT NULL, 11 INDEX idx_name (name) 12) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;çº¿ç¨‹æ± é…ç½®è¡¨\u0026#39;; é…ç½®åŠ è½½\n1@Component 2public class ThreadPoolConfigLoader implements ApplicationRunner { 3 4 @Autowired 5 private ThreadPoolConfigMapper configMapper; 6 7 @Autowired 8 private ThreadPoolRegistry registry; 9 10 @Override 11 public void run(ApplicationArguments args) { 12 // ä»æ•°æ®åº“åŠ è½½é…ç½® 13 List\u0026lt;ThreadPoolConfig\u0026gt; configs = configMapper.selectAll(); 14 15 for (ThreadPoolConfig config : configs) { 16 ThreadPoolExecutor executor = registry.get(config.getName()); 17 if (executor != null) { 18 // åº”ç”¨é…ç½® 19 executor.setCorePoolSize(config.getCorePoolSize()); 20 executor.setMaximumPoolSize(config.getMaximumPoolSize()); 21 22 log.info(\u0026#34;åŠ è½½çº¿ç¨‹æ± é…ç½®: {}\u0026#34;, config); 23 } 24 } 25 } 26} é…ç½®ä¿å­˜\n1@Service 2public class ThreadPoolConfigService { 3 4 @Autowired 5 private ThreadPoolConfigMapper configMapper; 6 7 @Transactional 8 public void saveConfig(String name, int corePoolSize, int maximumPoolSize) { 9 ThreadPoolConfig config = configMapper.selectByName(name); 10 11 if (config == null) { 12 config = new ThreadPoolConfig(); 13 config.setName(name); 14 config.setCreatedTime(LocalDateTime.now()); 15 } 16 17 config.setCorePoolSize(corePoolSize); 18 config.setMaximumPoolSize(maximumPoolSize); 19 config.setUpdatedTime(LocalDateTime.now()); 20 21 configMapper.insertOrUpdate(config); 22 } 23} é¿å‘æç¤ºï¼š åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°æ—¶ï¼Œè¦æ³¨æ„å‚æ•°çš„åˆæ³•æ€§æ ¡éªŒã€‚æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å¤§äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¦åˆ™ä¼šæŠ›å‡º IllegalArgumentExceptionã€‚è°ƒæ•´å‚æ•°åï¼Œå»ºè®®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œé¿å…é‡å¯åé…ç½®ä¸¢å¤±ã€‚\nå‚æ•°è°ƒä¼˜æœ€ä½³å®è·µ 1. æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®\nCPU å¯†é›†å‹ä»»åŠ¡ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° + 1 IO å¯†é›†å‹ä»»åŠ¡ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2 2. æœ€å¤§çº¿ç¨‹æ•°è®¾ç½®\næœ€å¤§çº¿ç¨‹æ•° = æ ¸å¿ƒçº¿ç¨‹æ•° * 1.5 ~ 2\n3. é˜Ÿåˆ—å®¹é‡è®¾ç½®\næœ‰ç•Œé˜Ÿåˆ—ï¼šå»ºè®® 100-1000ï¼Œé¿å…å†…å­˜æº¢å‡º æ— ç•Œé˜Ÿåˆ—ï¼šæ…ç”¨ï¼Œå¯èƒ½å¯¼è‡´ OOM 4. æ‹’ç»ç­–ç•¥é€‰æ‹©\nç­–ç•¥ è¯´æ˜ é€‚ç”¨åœºæ™¯ AbortPolicy æŠ›å‡ºå¼‚å¸¸ éœ€è¦æ„ŸçŸ¥ä»»åŠ¡è¢«æ‹’ç» CallerRunsPolicy è°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ ä»»åŠ¡ä¸èƒ½ä¸¢å¤± DiscardPolicy é™é»˜ä¸¢å¼ƒ ä»»åŠ¡å¯ä»¥ä¸¢å¤± DiscardOldestPolicy ä¸¢å¼ƒæœ€è€çš„ä»»åŠ¡ ä¼˜å…ˆæ‰§è¡Œæ–°ä»»åŠ¡ 5. ç›‘æ§å‘Šè­¦\né˜Ÿåˆ—ä½¿ç”¨ç‡ \u0026gt; 80%ï¼šå‘Šè­¦ çº¿ç¨‹æ± ä½¿ç”¨ç‡ \u0026gt; 90%ï¼šå‘Šè­¦ ä»»åŠ¡æ‹’ç»æ¬¡æ•° \u0026gt; 0ï¼šå‘Šè­¦ æ€»ç»“ä¸æ€è€ƒ çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ ThreadPoolRegistry ç»Ÿä¸€ç®¡ç†æ‰€æœ‰çº¿ç¨‹æ±  é€šè¿‡ BeanPostProcessor è‡ªåŠ¨æ³¨å†Œçº¿ç¨‹æ±  å®šæ—¶é‡‡é›†ç›‘æ§æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ æä¾› REST API å’Œç®¡ç†åå°ï¼Œæ–¹ä¾¿è¿ç»´äººå‘˜è°ƒæ•´å‚æ•° å°†é…ç½®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œé‡å¯åè‡ªåŠ¨åŠ è½½ çº¿ç¨‹æ± å‚æ•°çš„è°ƒä¼˜æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®å®é™…è´Ÿè½½ä¸æ–­è°ƒæ•´ã€‚é€šè¿‡ç›‘æ§æ•°æ®åˆ†æï¼Œæ‰¾åˆ°æœ€ä¼˜çš„å‚æ•°é…ç½®ã€‚\nä¸‹æ¬¡å½“ä½ çš„çº¿ç¨‹æ± å‡ºç°æ€§èƒ½é—®é¢˜æ—¶ï¼Œä¸å¦¨è¯•è¯•æœ¬æ–‡ä»‹ç»çš„åŠ¨æ€é…ç½®æ–¹æ¡ˆï¼Œè®©çº¿ç¨‹æ± å‚æ•°è°ƒæ•´å˜å¾—æ›´åŠ çµæ´»å’Œé«˜æ•ˆã€‚\n","permalink":"http://localhost:1313/posts/2025/01/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8F%82%E6%95%B0%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AEadmin-%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1/","summary":"\u003cp\u003eåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°çš„é…ç½®å¾€å¾€éœ€è¦æ ¹æ®å®é™…è´Ÿè½½åŠ¨æ€è°ƒæ•´ã€‚ç¡¬ç¼–ç çš„å‚æ•°é…ç½®ç¼ºä¹çµæ´»æ€§ï¼Œé‡å¯æœåŠ¡åˆä¼šå½±å“ä¸šåŠ¡ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•è®¾è®¡ä¸€ä¸ªçº¿ç¨‹æ± ç®¡ç†åå°ï¼Œå®ç°å‚æ•°çš„åŠ¨æ€é…ç½®å’Œå®æ—¶ç›‘æ§ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£çº¿ç¨‹æ± å‚æ•°åŠ¨æ€è°ƒæ•´çš„åŸç†ä¸å®ç°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡çº¿ç¨‹æ± ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†ä¸å±•ç¤º\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡ç”Ÿäº§çº§çš„çº¿ç¨‹æ± ç®¡ç†å¹³å°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®\"\u003eä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šæµé‡çªå¢\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåŒåä¸€æœŸé—´ï¼Œè®¢å•å¤„ç†çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º 10ï¼Œæœ€å¤§çº¿ç¨‹æ•° 20ã€‚çªç„¶æµé‡æš´å¢ï¼Œé˜Ÿåˆ—å †ç§¯ä¸¥é‡ï¼Œå¯¼è‡´è®¢å•å¤„ç†å»¶è¿Ÿã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœèƒ½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼Œå°†æ ¸å¿ƒçº¿ç¨‹æ•°è°ƒæ•´ä¸º 50ï¼Œæœ€å¤§çº¿ç¨‹æ•°è°ƒæ•´ä¸º 100ï¼Œå°±èƒ½å¿«é€Ÿåº”å¯¹æµé‡é«˜å³°ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šèµ„æºæµªè´¹\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå‡Œæ™¨æ—¶æ®µæµé‡å¾ˆä½ï¼Œä½†çº¿ç¨‹æ± ä»ç„¶ä¿æŒé«˜å³°æœŸçš„é…ç½®ï¼Œæµªè´¹äº†å¤§é‡ç³»ç»Ÿèµ„æºã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿåšæ³•çš„é—®é¢˜\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eThreadPoolConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;orderThreadPool\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eorderThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æœ€å¤§çº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e60\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLinkedBlockingQueue\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadFactoryBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003esetNameFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;order-pool-%d\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003ebuild\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eCallerRunsPolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e","title":"çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®ï¼šAdmin ç®¡ç†åå°è®¾è®¡"},{"content":"ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚æœ¬æ–‡é€šè¿‡çœŸå®çš„ç”Ÿäº§æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Œè®©ä½ æŒæ¡ SQL æ€§èƒ½è°ƒä¼˜çš„å®Œæ•´æ–¹æ³•è®ºã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„åˆ†ææ–¹æ³• å­¦ä¼šä½¿ç”¨ Explain å®šä½æ€§èƒ½ç“¶é¢ˆ äº†è§£å¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§ ç†è§£æ•°æ®åº“å±‚é¢çš„æ€§èƒ½ä¼˜åŒ– æ¡ˆä¾‹èƒŒæ™¯ æŸç”µå•†ç³»ç»Ÿçš„è®¢å•åˆ—è¡¨æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´è¾¾åˆ° 5 ç§’ï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚\nåŸå§‹ SQL\n1SELECT o.*, u.username, u.phone 2FROM `order` o 3LEFT JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; æ•°æ®é‡ï¼š\norder è¡¨ï¼š100 ä¸‡æ¡ user è¡¨ï¼š50 ä¸‡æ¡ ç¬¬ä¸€æ­¥ï¼šå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— é…ç½® MySQL\n1[mysqld] 2slow_query_log = 1 3slow_query_log_file = /var/log/mysql/slow.log 4long_query_time = 1 5log_queries_not_using_indexes = 1 åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—\n1# ä½¿ç”¨ mysqldumpslow åˆ†æ 2mysqldumpslow -s t -t 10 /var/log/mysql/slow.log è¾“å‡ºï¼š\n1Count: 1000 Time=5.23s (5230s) Lock=0.00s (0s) Rows=20.0 (20000) 2SELECT o.*, u.username, u.phone FROM order o LEFT JOIN user u ... ç¬¬äºŒæ­¥ï¼šExplain åˆ†ææ‰§è¡Œè®¡åˆ’ 1EXPLAIN SELECT o.*, u.username, u.phone 2FROM `order` o 3LEFT JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; æ‰§è¡Œè®¡åˆ’åˆ†æ\nid table type key rows Extra 1 o ALL NULL 1000000 Using where; Using filesort 1 u eq_ref PRIMARY 1 Using where é—®é¢˜ï¼š\norder è¡¨å…¨è¡¨æ‰«æï¼ˆtype = ALLï¼‰ æ‰«æäº† 100 ä¸‡è¡Œæ•°æ® éœ€è¦é¢å¤–çš„æ’åºæ“ä½œï¼ˆUsing filesortï¼‰ ç¬¬ä¸‰æ­¥ï¼šä¼˜åŒ–ç´¢å¼• åˆ†ææŸ¥è¯¢æ¡ä»¶\nWHEREï¼šstatusã€create_time JOINï¼šuser_id ORDER BYï¼šcreate_time åˆ›å»ºè”åˆç´¢å¼•\n1CREATE INDEX idx_status_time ON `order`(status, create_time); å†æ¬¡ Explain\nid table type key rows Extra 1 o range idx_status_time 50000 Using index condition 1 u eq_ref PRIMARY 1 Using where æ”¹è¿›ï¼š\ntype ä» ALL å˜æˆ range rows ä» 100 ä¸‡é™ä½åˆ° 5 ä¸‡ å»æ‰äº† Using filesort æ‰§è¡Œæ—¶é—´ï¼šä» 5 ç§’é™ä½åˆ° 800ms\nç¬¬å››æ­¥ï¼šä¼˜åŒ– JOIN é—®é¢˜åˆ†æ\nLEFT JOIN ä¼šå…ˆæŸ¥è¯¢ order è¡¨çš„æ‰€æœ‰æ•°æ®ï¼Œç„¶åå†å…³è” user è¡¨ã€‚ä½†å®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦ city = \u0026lsquo;Beijing\u0026rsquo; çš„ç”¨æˆ·ã€‚\nä¼˜åŒ–æ–¹æ¡ˆï¼šæ”¹ä¸º INNER JOIN\n1SELECT o.*, u.username, u.phone 2FROM `order` o 3INNER JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; ä¸º user è¡¨åˆ›å»ºç´¢å¼•\n1CREATE INDEX idx_city ON user(city); å†æ¬¡ Explain\nid table type key rows Extra 1 u ref idx_city 10000 Using where 1 o ref idx_user_status_time 100 Using where æ‰§è¡Œæ—¶é—´ï¼šä» 800ms é™ä½åˆ° 200ms\nç¬¬äº”æ­¥ï¼šé¿å… SELECT * é—®é¢˜\nSELECT * ä¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬ä¸éœ€è¦çš„å¤§å­—æ®µï¼ˆå¦‚è®¢å•è¯¦æƒ… JSONï¼‰ã€‚\nä¼˜åŒ–\n1SELECT o.id, o.order_no, o.amount, o.status, o.create_time, 2 u.username, u.phone 3FROM `order` o 4INNER JOIN user u ON o.user_id = u.id 5WHERE o.status IN (1, 2, 3) 6 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 7 AND u.city = \u0026#39;Beijing\u0026#39; 8ORDER BY o.create_time DESC 9LIMIT 20; æ‰§è¡Œæ—¶é—´ï¼šä» 200ms é™ä½åˆ° 120ms\nç¬¬å…­æ­¥ï¼šä½¿ç”¨è¦†ç›–ç´¢å¼• åˆ›å»ºè¦†ç›–ç´¢å¼•\n1CREATE INDEX idx_status_time_user ON `order`(status, create_time, user_id); ä¼˜åŒ–åçš„ Explain\nid table type key rows Extra 1 u ref idx_city 10000 Using index 1 o ref idx_status_time_user 100 Using index Extra å˜æˆäº† Using indexï¼Œè¯´æ˜ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ã€‚\næ‰§è¡Œæ—¶é—´ï¼šä» 120ms é™ä½åˆ° 50ms\nä¼˜åŒ–æ€»ç»“ ä¼˜åŒ–æ­¥éª¤ æ‰§è¡Œæ—¶é—´ ä¼˜åŒ–æ•ˆæœ åŸå§‹ SQL 5000ms - åˆ›å»ºç´¢å¼• 800ms æå‡ 6.25 å€ ä¼˜åŒ– JOIN 200ms æå‡ 4 å€ é¿å… SELECT * 120ms æå‡ 1.67 å€ ä½¿ç”¨è¦†ç›–ç´¢å¼• 50ms æå‡ 2.4 å€ æ€»ä½“æå‡ï¼š100 å€\nå¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§ 1. é¿å…åœ¨ WHERE ä¸­ä½¿ç”¨å‡½æ•°\n1-- ä¸å¥½ 2SELECT * FROM `order` WHERE DATE(create_time) = \u0026#39;2024-01-01\u0026#39;; 3 4-- å¥½ 5SELECT * FROM `order` WHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2024-01-02\u0026#39;; 2. ä½¿ç”¨ UNION ALL ä»£æ›¿ UNION\nUNION ä¼šå»é‡ï¼Œéœ€è¦é¢å¤–çš„æ’åºæ“ä½œã€‚å¦‚æœç¡®å®šæ²¡æœ‰é‡å¤æ•°æ®ï¼Œä½¿ç”¨ UNION ALLã€‚\n1-- ä¸å¥½ 2SELECT * FROM order WHERE status = 1 3UNION 4SELECT * FROM order WHERE status = 2; 5 6-- å¥½ 7SELECT * FROM order WHERE status = 1 8UNION ALL 9SELECT * FROM order WHERE status = 2; 3. ä½¿ç”¨ EXISTS ä»£æ›¿ IN\nå½“å­æŸ¥è¯¢ç»“æœé›†å¾ˆå¤§æ—¶ï¼ŒEXISTS æ€§èƒ½æ›´å¥½ã€‚\n1-- ä¸å¥½ 2SELECT * FROM user WHERE id IN (SELECT user_id FROM order); 3 4-- å¥½ 5SELECT * FROM user u WHERE EXISTS (SELECT 1 FROM order o WHERE o.user_id = u.id); 4. é¿å…ä½¿ç”¨å­æŸ¥è¯¢\nå­æŸ¥è¯¢ä¼šåˆ›å»ºä¸´æ—¶è¡¨ï¼Œæ€§èƒ½è¾ƒå·®ã€‚å¯ä»¥æ”¹ä¸º JOINã€‚\n1-- ä¸å¥½ 2SELECT * FROM user WHERE id IN (SELECT user_id FROM order WHERE status = 1); 3 4-- å¥½ 5SELECT DISTINCT u.* FROM user u 6INNER JOIN order o ON u.id = o.user_id 7WHERE o.status = 1; 5. åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é‡\n1-- ä¸å¥½ï¼šä¸€æ¬¡æ›´æ–° 100 ä¸‡æ¡æ•°æ® 2UPDATE order SET status = 2 WHERE status = 1; 3 4-- å¥½ï¼šåˆ†æ‰¹æ›´æ–° 5UPDATE order SET status = 2 WHERE status = 1 LIMIT 1000; 6. ä½¿ç”¨ LIMIT é™åˆ¶è¿”å›æ•°æ®é‡\n1-- ä¸å¥½ 2SELECT * FROM order WHERE status = 1; 3 4-- å¥½ 5SELECT * FROM order WHERE status = 1 LIMIT 100; æ•°æ®åº“å±‚é¢çš„ä¼˜åŒ– 1. è°ƒæ•´ InnoDB ç¼“å†²æ± å¤§å°\n1[mysqld] 2innodb_buffer_pool_size = 8G # è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 70-80% 2. å¼€å¯æŸ¥è¯¢ç¼“å­˜ï¼ˆMySQL 5.7 åŠä»¥ä¸‹ï¼‰\n1[mysqld] 2query_cache_type = 1 3query_cache_size = 256M æ³¨æ„ï¼šMySQL 8.0 å·²ç§»é™¤æŸ¥è¯¢ç¼“å­˜ã€‚\n3. è°ƒæ•´è¿æ¥æ•°\n1[mysqld] 2max_connections = 1000 4. å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\n1[mysqld] 2slow_query_log = 1 3long_query_time = 1 5. å®šæœŸåˆ†æè¡¨\n1ANALYZE TABLE order; æ›´æ–°è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¸®åŠ©ä¼˜åŒ–å™¨é€‰æ‹©æ›´å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚\nç›‘æ§ä¸é¢„è­¦ 1. ä½¿ç”¨ Prometheus + Grafana ç›‘æ§\nç›‘æ§æŒ‡æ ‡ï¼š\nQPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰ æ…¢æŸ¥è¯¢æ•°é‡ è¿æ¥æ•° ç¼“å†²æ± å‘½ä¸­ç‡ 2. è®¾ç½®æ…¢æŸ¥è¯¢å‘Šè­¦\nå½“æ…¢æŸ¥è¯¢æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œå‘é€å‘Šè­¦é€šçŸ¥ã€‚\n3. å®šæœŸå®¡æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—\næ¯å‘¨åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæ‰¾å‡ºéœ€è¦ä¼˜åŒ–çš„ SQLã€‚\næ€»ç»“ä¸æ€è€ƒ SQL æ€§èƒ½ä¼˜åŒ–çš„æ–¹æ³•è®ºï¼š\nå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå®šä½é—®é¢˜ SQL ä½¿ç”¨ Explain åˆ†ææ‰§è¡Œè®¡åˆ’ åˆ›å»ºåˆé€‚çš„ç´¢å¼• ä¼˜åŒ– SQL è¯­å¥ï¼ˆé¿å… SELECT *ã€ä¼˜åŒ– JOINï¼‰ æ•°æ®åº“å±‚é¢ä¼˜åŒ–ï¼ˆè°ƒæ•´å‚æ•°ã€ç›‘æ§ï¼‰ æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡å˜åŒ–ä¸æ–­è°ƒæ•´ã€‚\nè®°ä½ï¼šè¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚å…ˆä¿è¯åŠŸèƒ½æ­£ç¡®ï¼Œå†æ ¹æ®ç›‘æ§æ•°æ®ä¼˜åŒ–æ€§èƒ½ã€‚\nä¸‹æ¬¡å½“ä½ çš„ SQL æŸ¥è¯¢å¾ˆæ…¢æ—¶ï¼ŒæŒ‰ç…§è¿™ä¸ªæ–¹æ³•è®ºä¸€æ­¥æ­¥æ’æŸ¥ï¼Œä¸€å®šèƒ½æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚\n","permalink":"http://localhost:1313/posts/2024/12/mysql-%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/","summary":"\u003cp\u003eä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚æœ¬æ–‡é€šè¿‡çœŸå®çš„ç”Ÿäº§æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Œè®©ä½ æŒæ¡ SQL æ€§èƒ½è°ƒä¼˜çš„å®Œæ•´æ–¹æ³•è®ºã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ Explain å®šä½æ€§èƒ½ç“¶é¢ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£æ•°æ®åº“å±‚é¢çš„æ€§èƒ½ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¡ˆä¾‹èƒŒæ™¯\"\u003eæ¡ˆä¾‹èƒŒæ™¯\u003c/h2\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿçš„è®¢å•åˆ—è¡¨æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´è¾¾åˆ° 5 ç§’ï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåŸå§‹ SQL\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eusername\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ephone\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e`\u003c/span\u003e\u003cspan class=\"k\"\u003eorder\u003c/span\u003e\u003cspan class=\"o\"\u003e`\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eLEFT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eJOIN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eON\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003euser_id\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eWHERE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eIN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003eAND\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;2024-01-01\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003eAND\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecity\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Beijing\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eORDER\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eBY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eDESC\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eLIMIT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ•°æ®é‡ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eorder è¡¨ï¼š100 ä¸‡æ¡\u003c/li\u003e\n\u003cli\u003euser è¡¨ï¼š50 ä¸‡æ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\"\u003eç¬¬ä¸€æ­¥ï¼šå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eé…ç½® MySQL\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[mysqld]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eslow_query_log\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eslow_query_log_file\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/mysql/slow.log\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elong_query_time\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elog_queries_not_using_indexes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—\u003c/strong\u003e\u003c/p\u003e","title":"MySQL æ…¢æŸ¥è¯¢ä¼˜åŒ–å®æˆ˜æ¡ˆä¾‹"},{"content":"åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŸMySQL é€šè¿‡äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œ MVCC æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡æ·±å…¥å‰–æ MySQL çš„å¹¶å‘æ§åˆ¶åŸç†ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯ æŒæ¡ MVCC çš„ ReadView æœºåˆ¶ å­¦ä¼šè§£å†³å¹»è¯»é—®é¢˜çš„æ–¹æ³• äº†è§£é”æœºåˆ¶ä¸ MVCC çš„é…åˆ äº‹åŠ¡çš„å¹¶å‘é—®é¢˜ è„è¯»ï¼ˆDirty Readï¼‰\näº‹åŠ¡ A è¯»å–äº†äº‹åŠ¡ B æœªæäº¤çš„æ•°æ®ï¼Œäº‹åŠ¡ B å›æ»šåï¼Œäº‹åŠ¡ A è¯»åˆ°çš„æ•°æ®æ˜¯æ— æ•ˆçš„ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ 3T2: äº‹åŠ¡ B å¼€å§‹ï¼Œå°† balance ä» 100 æ”¹ä¸º 200 4T3: äº‹åŠ¡ A è¯»å– balance = 200ï¼ˆè„è¯»ï¼‰ 5T4: äº‹åŠ¡ B å›æ»šï¼Œbalance æ¢å¤ä¸º 100 6T5: äº‹åŠ¡ A æäº¤ ä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readï¼‰\näº‹åŠ¡ A ä¸¤æ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸ä¸€è‡´ï¼ˆå› ä¸ºäº‹åŠ¡ B ä¿®æ”¹å¹¶æäº¤äº†æ•°æ®ï¼‰ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A è¯»å– balance = 100 3T2: äº‹åŠ¡ B å°† balance æ”¹ä¸º 200 å¹¶æäº¤ 4T3: äº‹åŠ¡ A å†æ¬¡è¯»å– balance = 200ï¼ˆä¸å¯é‡å¤è¯»ï¼‰ å¹»è¯»ï¼ˆPhantom Readï¼‰\näº‹åŠ¡ A ä¸¤æ¬¡æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢å¤šå‡ºäº†æ–°çš„è¡Œï¼ˆå› ä¸ºäº‹åŠ¡ B æ’å…¥äº†æ–°æ•°æ®ï¼‰ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A æŸ¥è¯¢ age \u0026gt; 20 çš„ç”¨æˆ·ï¼Œç»“æœ 2 æ¡ 3T2: äº‹åŠ¡ B æ’å…¥ä¸€æ¡ age = 25 çš„ç”¨æˆ·å¹¶æäº¤ 4T3: äº‹åŠ¡ A å†æ¬¡æŸ¥è¯¢ age \u0026gt; 20 çš„ç”¨æˆ·ï¼Œç»“æœ 3 æ¡ï¼ˆå¹»è¯»ï¼‰ å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ« éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» READ UNCOMMITTED å¯èƒ½ å¯èƒ½ å¯èƒ½ READ COMMITTED ä¸å¯èƒ½ å¯èƒ½ å¯èƒ½ REPEATABLE READï¼ˆé»˜è®¤ï¼‰ ä¸å¯èƒ½ ä¸å¯èƒ½ å¯èƒ½ SERIALIZABLE ä¸å¯èƒ½ ä¸å¯èƒ½ ä¸å¯èƒ½ æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«\n1SELECT @@transaction_isolation; è®¾ç½®éš”ç¦»çº§åˆ«\n1-- ä¼šè¯çº§åˆ« 2SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; 3 4-- å…¨å±€çº§åˆ« 5SET GLOBAL TRANSACTION ISOLATION LEVEL REPEATABLE READ; READ UNCOMMITTEDï¼šè¯»æœªæäº¤ ç‰¹ç‚¹ï¼š äº‹åŠ¡å¯ä»¥è¯»å–å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚\né—®é¢˜ï¼š ä¼šå‡ºç°è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€‚\né€‚ç”¨åœºæ™¯ï¼š å‡ ä¹ä¸ä½¿ç”¨ï¼Œæ•°æ®ä¸€è‡´æ€§æ— æ³•ä¿è¯ã€‚\næ¼”ç¤ºè„è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9 10-- äº‹åŠ¡ A 11SELECT balance FROM account WHERE id = 1; -- 200ï¼ˆè„è¯»ï¼‰ 12 13-- äº‹åŠ¡ B 14ROLLBACK; 15 16-- äº‹åŠ¡ A 17SELECT balance FROM account WHERE id = 1; -- 100 18COMMIT; READ COMMITTEDï¼šè¯»å·²æäº¤ ç‰¹ç‚¹ï¼š äº‹åŠ¡åªèƒ½è¯»å–å…¶ä»–äº‹åŠ¡å·²æäº¤çš„æ•°æ®ã€‚\né—®é¢˜ï¼š ä¼šå‡ºç°ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€‚\né€‚ç”¨åœºæ™¯ï¼š Oracleã€PostgreSQL çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚\næ¼”ç¤ºä¸å¯é‡å¤è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9COMMIT; 10 11-- äº‹åŠ¡ A 12SELECT balance FROM account WHERE id = 1; -- 200ï¼ˆä¸å¯é‡å¤è¯»ï¼‰ 13COMMIT; REPEATABLE READï¼šå¯é‡å¤è¯» ç‰¹ç‚¹ï¼š äº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸€è‡´ã€‚\né—®é¢˜ï¼š ç†è®ºä¸Šä¼šå‡ºç°å¹»è¯»ï¼Œä½† MySQL é€šè¿‡ MVCC + Next-Key Lock è§£å†³äº†å¤§éƒ¨åˆ†å¹»è¯»é—®é¢˜ã€‚\né€‚ç”¨åœºæ™¯ï¼š MySQL çš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ã€‚\næ¼”ç¤ºå¯é‡å¤è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9COMMIT; 10 11-- äº‹åŠ¡ A 12SELECT balance FROM account WHERE id = 1; -- 100ï¼ˆå¯é‡å¤è¯»ï¼‰ 13COMMIT; SERIALIZABLEï¼šä¸²è¡ŒåŒ– ç‰¹ç‚¹ï¼š äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œå®Œå…¨é¿å…å¹¶å‘é—®é¢˜ã€‚\né—®é¢˜ï¼š æ€§èƒ½æœ€å·®ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚\né€‚ç”¨åœºæ™¯ï¼š å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼ˆå¦‚é‡‘èç³»ç»Ÿï¼‰ã€‚\nå®ç°æ–¹å¼ï¼š å¯¹è¯»å–çš„æ¯ä¸€è¡Œæ•°æ®éƒ½åŠ é”ã€‚\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE; 3START TRANSACTION; 4SELECT * FROM account WHERE id = 1; -- åŠ å…±äº«é” 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; -- ç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é” MVCCï¼šå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ æ ¸å¿ƒæ€æƒ³ï¼š ä¸ºæ¯ä¸ªäº‹åŠ¡æä¾›æ•°æ®çš„å¿«ç…§ï¼Œä¸åŒäº‹åŠ¡çœ‹åˆ°ä¸åŒç‰ˆæœ¬çš„æ•°æ®ã€‚\nä¼˜åŠ¿ï¼š\nè¯»ä¸åŠ é”ï¼Œå†™ä¸é˜»å¡è¯» æå‡å¹¶å‘æ€§èƒ½ å®ç°æœºåˆ¶ï¼š\néšè—å­—æ®µï¼šDB_TRX_IDã€DB_ROLL_PTRã€DB_ROW_ID Undo Logï¼šè®°å½•æ•°æ®çš„å†å²ç‰ˆæœ¬ ReadViewï¼šåˆ¤æ–­æ•°æ®ç‰ˆæœ¬çš„å¯è§æ€§ éšè—å­—æ®µ InnoDB ä¸ºæ¯ä¸€è¡Œæ•°æ®æ·»åŠ äº†ä¸‰ä¸ªéšè—å­—æ®µï¼š\nå­—æ®µ è¯´æ˜ DB_TRX_ID æœ€åä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡ ID DB_ROLL_PTR æŒ‡å‘ Undo Log çš„æŒ‡é’ˆ DB_ROW_ID è¡Œ IDï¼ˆå¦‚æœæ²¡æœ‰ä¸»é”®ï¼‰ ç¤ºä¾‹\n1åŸå§‹æ•°æ®ï¼š 2id | name | age | DB_TRX_ID | DB_ROLL_PTR 31 | Alice | 20 | 100 | NULL 4 5äº‹åŠ¡ 101 ä¿®æ”¹ï¼š 6id | name | age | DB_TRX_ID | DB_ROLL_PTR 71 | Alice | 25 | 101 | â†’ Undo Log (age=20, TRX_ID=100) 8 9äº‹åŠ¡ 102 ä¿®æ”¹ï¼š 10id | name | age | DB_TRX_ID | DB_ROLL_PTR 111 | Alice | 30 | 102 | â†’ Undo Log (age=25, TRX_ID=101) é€šè¿‡ Undo Logï¼Œå¯ä»¥æ„å»ºç‰ˆæœ¬é“¾ï¼Œå›æº¯åˆ°ä»»æ„å†å²ç‰ˆæœ¬ã€‚\nReadViewï¼šå¯è§æ€§åˆ¤æ–­ ReadView æ˜¯äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºçš„å¿«ç…§ï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š\nå­—æ®µ è¯´æ˜ m_ids å½“å‰æ´»è·ƒçš„äº‹åŠ¡ ID åˆ—è¡¨ min_trx_id æœ€å°çš„æ´»è·ƒäº‹åŠ¡ ID max_trx_id ä¸‹ä¸€ä¸ªè¦åˆ†é…çš„äº‹åŠ¡ ID creator_trx_id åˆ›å»º ReadView çš„äº‹åŠ¡ ID å¯è§æ€§è§„åˆ™\nå¯¹äºæ•°æ®è¡Œçš„ DB_TRX_IDï¼š\nå¦‚æœ DB_TRX_ID \u0026lt; min_trx_idï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬åœ¨ ReadView åˆ›å»ºå‰å·²æäº¤ï¼Œå¯è§ å¦‚æœ DB_TRX_ID \u0026gt;= max_trx_idï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬åœ¨ ReadView åˆ›å»ºåæ‰å¼€å§‹ï¼Œä¸å¯è§ å¦‚æœ min_trx_id \u0026lt;= DB_TRX_ID \u0026lt; max_trx_idï¼š å¦‚æœ DB_TRX_ID åœ¨ m_ids ä¸­ï¼Œè¯´æ˜è¯¥äº‹åŠ¡è¿˜æœªæäº¤ï¼Œä¸å¯è§ å¦‚æœ DB_TRX_ID ä¸åœ¨ m_ids ä¸­ï¼Œè¯´æ˜è¯¥äº‹åŠ¡å·²æäº¤ï¼Œå¯è§ å¦‚æœ DB_TRX_ID == creator_trx_idï¼Œè¯´æ˜æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ä¿®æ”¹çš„ï¼Œå¯è§ å¦‚æœå½“å‰ç‰ˆæœ¬ä¸å¯è§ï¼Œé€šè¿‡ DB_ROLL_PTR æ‰¾åˆ° Undo Log ä¸­çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œç»§ç»­åˆ¤æ–­ã€‚\nREAD COMMITTED ä¸ REPEATABLE READ çš„åŒºåˆ« READ COMMITTED\næ¯æ¬¡ SELECT éƒ½åˆ›å»ºæ–°çš„ ReadViewã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ï¼ˆTRX_ID=100ï¼‰ 3T2: äº‹åŠ¡ A ç¬¬ä¸€æ¬¡ SELECTï¼Œåˆ›å»º ReadView1ï¼ˆm_ids=[100]ï¼‰ 4T3: äº‹åŠ¡ Bï¼ˆTRX_ID=101ï¼‰ä¿®æ”¹æ•°æ®å¹¶æäº¤ 5T4: äº‹åŠ¡ A ç¬¬äºŒæ¬¡ SELECTï¼Œåˆ›å»º ReadView2ï¼ˆm_ids=[100]ï¼‰ 6 æ­¤æ—¶äº‹åŠ¡ 101 å·²æäº¤ï¼Œä¸åœ¨ m_ids ä¸­ï¼Œå¯è§ ç»“æœï¼šä¸¤æ¬¡ SELECT ç»“æœä¸åŒï¼ˆä¸å¯é‡å¤è¯»ï¼‰ã€‚\nREPEATABLE READ\näº‹åŠ¡å¼€å§‹æ—¶åˆ›å»º ReadViewï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´å¤ç”¨ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ï¼ˆTRX_ID=100ï¼‰ï¼Œåˆ›å»º ReadViewï¼ˆm_ids=[100]ï¼‰ 3T2: äº‹åŠ¡ A ç¬¬ä¸€æ¬¡ SELECT 4T3: äº‹åŠ¡ Bï¼ˆTRX_ID=101ï¼‰ä¿®æ”¹æ•°æ®å¹¶æäº¤ 5T4: äº‹åŠ¡ A ç¬¬äºŒæ¬¡ SELECTï¼Œå¤ç”¨ ReadViewï¼ˆm_ids=[100]ï¼‰ 6 äº‹åŠ¡ 101 åœ¨ ReadView åˆ›å»ºåæ‰æäº¤ï¼Œä¸å¯è§ ç»“æœï¼šä¸¤æ¬¡ SELECT ç»“æœç›¸åŒï¼ˆå¯é‡å¤è¯»ï¼‰ã€‚\næ¶æ„æ€è€ƒï¼š MVCC çš„è®¾è®¡ä½“ç°äº†\u0026quot;ç©ºé—´æ¢æ—¶é—´\u0026quot;çš„æ€æƒ³ã€‚é€šè¿‡ Undo Log ä¿å­˜å†å²ç‰ˆæœ¬ï¼Œç‰ºç‰²äº†å­˜å‚¨ç©ºé—´ï¼Œæ¢å–äº†è¯»å†™å¹¶å‘çš„æ€§èƒ½æå‡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ Git çš„ç‰ˆæœ¬æ§åˆ¶ã€Redis çš„ RDB å¿«ç…§ã€‚\nå¹»è¯»é—®é¢˜ ä»€ä¹ˆæ˜¯å¹»è¯»ï¼Ÿ\näº‹åŠ¡ A ä¸¤æ¬¡æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢å¤šå‡ºäº†æ–°çš„è¡Œã€‚\nMVCC èƒ½è§£å†³å¹»è¯»å—ï¼Ÿ\néƒ¨åˆ†è§£å†³ã€‚å¯¹äºå¿«ç…§è¯»ï¼ˆæ™®é€š SELECTï¼‰ï¼ŒMVCC å¯ä»¥è§£å†³å¹»è¯»ã€‚ä½†å¯¹äºå½“å‰è¯»ï¼ˆSELECT FOR UPDATEã€UPDATEã€DELETEï¼‰ï¼ŒMVCC æ— æ³•è§£å†³å¹»è¯»ã€‚\næ¼”ç¤ºå¹»è¯»\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3SELECT * FROM user WHERE age \u0026gt; 20; -- 2 æ¡è®°å½• 4 5-- äº‹åŠ¡ B 6START TRANSACTION; 7INSERT INTO user (name, age) VALUES (\u0026#39;Charlie\u0026#39;, 25); 8COMMIT; 9 10-- äº‹åŠ¡ A 11SELECT * FROM user WHERE age \u0026gt; 20; -- ä»ç„¶ 2 æ¡ï¼ˆMVCC è§£å†³äº†å¿«ç…§è¯»çš„å¹»è¯»ï¼‰ 12 13-- ä½†æ˜¯ 14SELECT * FROM user WHERE age \u0026gt; 20 FOR UPDATE; -- 3 æ¡ï¼ˆå½“å‰è¯»å‡ºç°å¹»è¯»ï¼‰ è§£å†³æ–¹æ¡ˆï¼šNext-Key Lock\nNext-Key Lock = Record Lockï¼ˆè¡Œé”ï¼‰ + Gap Lockï¼ˆé—´éš™é”ï¼‰\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3SELECT * FROM user WHERE age \u0026gt; 20 FOR UPDATE; -- é”å®š age \u0026gt; 20 çš„æ‰€æœ‰è¡Œå’Œé—´éš™ 4 5-- äº‹åŠ¡ B 6INSERT INTO user (name, age) VALUES (\u0026#39;Charlie\u0026#39;, 25); -- ç­‰å¾…ï¼ˆè¢«é—´éš™é”é˜»å¡ï¼‰ é—´éš™é”é”å®šçš„æ˜¯ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥æ•°æ®ã€‚\né”æœºåˆ¶ å…±äº«é”ï¼ˆS Lockï¼‰\nè¯»é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ã€‚\n1SELECT * FROM user WHERE id = 1 LOCK IN SHARE MODE; æ’ä»–é”ï¼ˆX Lockï¼‰\nå†™é”ï¼Œåªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥æŒæœ‰ã€‚\n1SELECT * FROM user WHERE id = 1 FOR UPDATE; 2UPDATE user SET age = 25 WHERE id = 1; 3DELETE FROM user WHERE id = 1; è¡Œé”ï¼ˆRecord Lockï¼‰\né”å®šå•ä¸ªç´¢å¼•è®°å½•ã€‚\né—´éš™é”ï¼ˆGap Lockï¼‰\né”å®šç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ï¼Œé˜²æ­¢æ’å…¥ã€‚\nNext-Key Lock\nè¡Œé” + é—´éš™é”ï¼Œé”å®šç´¢å¼•è®°å½•åŠå…¶å‰é¢çš„é—´éš™ã€‚\né”çš„å…¼å®¹æ€§\nS Lock X Lock S Lock å…¼å®¹ å†²çª X Lock å†²çª å†²çª æ­»é” åœºæ™¯\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3UPDATE user SET age = 25 WHERE id = 1; -- é”å®š id=1 4 5-- äº‹åŠ¡ B 6START TRANSACTION; 7UPDATE user SET age = 30 WHERE id = 2; -- é”å®š id=2 8 9-- äº‹åŠ¡ A 10UPDATE user SET age = 26 WHERE id = 2; -- ç­‰å¾…äº‹åŠ¡ B é‡Šæ”¾é” 11 12-- äº‹åŠ¡ B 13UPDATE user SET age = 31 WHERE id = 1; -- ç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é”ï¼ˆæ­»é”ï¼‰ æ£€æµ‹ä¸è§£å†³\nMySQL ä¼šè‡ªåŠ¨æ£€æµ‹æ­»é”ï¼Œå¹¶å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡ã€‚\né¿å…æ­»é”\næŒ‰ç›¸åŒé¡ºåºè®¿é—®èµ„æº ç¼©çŸ­äº‹åŠ¡æ—¶é—´ é™ä½éš”ç¦»çº§åˆ« ä½¿ç”¨ä¹è§‚é” å®æˆ˜æ¡ˆä¾‹ï¼šç§’æ€ç³»ç»Ÿçš„åº“å­˜æ‰£å‡ æ–¹æ¡ˆä¸€ï¼šæ‚²è§‚é”\n1START TRANSACTION; 2SELECT stock FROM product WHERE id = 1 FOR UPDATE; -- åŠ æ’ä»–é” 3UPDATE product SET stock = stock - 1 WHERE id = 1; 4COMMIT; ä¼˜ç‚¹ï¼šæ•°æ®ä¸€è‡´æ€§å¼º ç¼ºç‚¹ï¼šå¹¶å‘æ€§èƒ½å·®\næ–¹æ¡ˆäºŒï¼šä¹è§‚é”\n1-- æŸ¥è¯¢åº“å­˜å’Œç‰ˆæœ¬å· 2SELECT stock, version FROM product WHERE id = 1; 3 4-- æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å· 5UPDATE product SET stock = stock - 1, version = version + 1 6WHERE id = 1 AND version = #{oldVersion}; ä¼˜ç‚¹ï¼šå¹¶å‘æ€§èƒ½å¥½ ç¼ºç‚¹ï¼šé«˜å¹¶å‘ä¸‹æ›´æ–°å¤±è´¥ç‡é«˜\næ–¹æ¡ˆä¸‰ï¼šRedis + æ•°æ®åº“\n1// 1. Redis é¢„æ‰£å‡ 2Long stock = redisTemplate.opsForValue().decrement(\u0026#34;stock:1\u0026#34;); 3if (stock \u0026lt; 0) { 4 redisTemplate.opsForValue().increment(\u0026#34;stock:1\u0026#34;); 5 return \u0026#34;åº“å­˜ä¸è¶³\u0026#34;; 6} 7 8// 2. å¼‚æ­¥æ›´æ–°æ•°æ®åº“ 9rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, orderId); ä¼˜ç‚¹ï¼šæ€§èƒ½æœ€å¥½ ç¼ºç‚¹ï¼šå®ç°å¤æ‚ï¼Œéœ€è¦ä¿è¯æœ€ç»ˆä¸€è‡´æ€§\næ€»ç»“ä¸æ€è€ƒ MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ MVCC çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nå››ç§éš”ç¦»çº§åˆ«è§£å†³ä¸åŒçš„å¹¶å‘é—®é¢˜ MVCC é€šè¿‡ ReadView å’Œ Undo Log å®ç°å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ READ COMMITTED æ¯æ¬¡ SELECT åˆ›å»ºæ–° ReadView REPEATABLE READ äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»º ReadView å¹¶å¤ç”¨ Next-Key Lock è§£å†³å½“å‰è¯»çš„å¹»è¯»é—®é¢˜ ç†è§£è¿™äº›æœºåˆ¶ï¼Œæ‰èƒ½åœ¨å®é™…å¼€å‘ä¸­é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«å’Œé”ç­–ç•¥ã€‚\nä¸‹æ¬¡å½“ä½ é‡åˆ°å¹¶å‘é—®é¢˜æ—¶ï¼Œä¸å¦¨æƒ³æƒ³ï¼šè¿™æ˜¯è„è¯»ã€ä¸å¯é‡å¤è¯»è¿˜æ˜¯å¹»è¯»ï¼Ÿåº”è¯¥ç”¨ä»€ä¹ˆéš”ç¦»çº§åˆ«å’Œé”æœºåˆ¶ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/11/mysql-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8E-mvcc-%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŸMySQL é€šè¿‡äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œ MVCC æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡æ·±å…¥å‰–æ MySQL çš„å¹¶å‘æ§åˆ¶åŸç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ MVCC çš„ ReadView æœºåˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§£å†³å¹»è¯»é—®é¢˜çš„æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£é”æœºåˆ¶ä¸ MVCC çš„é…åˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"äº‹åŠ¡çš„å¹¶å‘é—®é¢˜\"\u003eäº‹åŠ¡çš„å¹¶å‘é—®é¢˜\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eè„è¯»ï¼ˆDirty Readï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eäº‹åŠ¡ A è¯»å–äº†äº‹åŠ¡ B æœªæäº¤çš„æ•°æ®ï¼Œäº‹åŠ¡ B å›æ»šåï¼Œäº‹åŠ¡ A è¯»åˆ°çš„æ•°æ®æ˜¯æ— æ•ˆçš„ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eæ—¶é—´çº¿ï¼š\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eT1: äº‹åŠ¡ A å¼€å§‹\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003eT2: äº‹åŠ¡ B å¼€å§‹ï¼Œå°† balance ä» 100 æ”¹ä¸º 200\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003eT3: äº‹åŠ¡ A è¯»å– balance = 200ï¼ˆè„è¯»ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003eT4: äº‹åŠ¡ B å›æ»šï¼Œbalance æ¢å¤ä¸º 100\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003eT5: äº‹åŠ¡ A æäº¤\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eäº‹åŠ¡ A ä¸¤æ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸ä¸€è‡´ï¼ˆå› ä¸ºäº‹åŠ¡ B ä¿®æ”¹å¹¶æäº¤äº†æ•°æ®ï¼‰ã€‚\u003c/p\u003e","title":"MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ MVCC æœºåˆ¶æ·±åº¦è§£æ"},{"content":"SQL æ€§èƒ½ä¼˜åŒ–æ˜¯åç«¯å¼€å‘çš„å¿…å¤‡æŠ€èƒ½ã€‚ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿï¼Œè€Œåˆç†çš„ç´¢å¼•è®¾è®¡èƒ½è®©æŸ¥è¯¢é€Ÿåº¦æå‡ç™¾å€ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ–¹æ³•è®ºã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ B+ æ ‘ç´¢å¼•çš„åº•å±‚åŸç† æŒæ¡ Explain æ‰§è¡Œè®¡åˆ’çš„åˆ†ææ–¹æ³• å­¦ä¼šè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é…è§„åˆ™ äº†è§£è¦†ç›–ç´¢å¼•ä¸ç´¢å¼•ä¸‹æ¨ä¼˜åŒ– B+ æ ‘ç´¢å¼•åŸç† ä¸ºä»€ä¹ˆé€‰æ‹© B+ æ ‘ï¼Ÿ\nå¸¸è§çš„æ•°æ®ç»“æ„å¯¹æ¯”ï¼š\næ•°æ®ç»“æ„ æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ é—®é¢˜ æ•°ç»„ O(n) æŸ¥è¯¢æ…¢ äºŒå‰æœç´¢æ ‘ O(log n) å¯èƒ½é€€åŒ–ä¸ºé“¾è¡¨ å¹³è¡¡äºŒå‰æ ‘ O(log n) æ ‘é«˜å¤ªé«˜ï¼ŒIO æ¬¡æ•°å¤š B æ ‘ O(log n) éå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œæµªè´¹ç©ºé—´ B+ æ ‘ O(log n) å¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜ç´¢å¼• B+ æ ‘çš„ç‰¹ç‚¹\næ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ å¶å­èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢ éå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šçš„é”®å€¼ æ ‘çš„é«˜åº¦ä½ï¼ŒIO æ¬¡æ•°å°‘ InnoDB çš„èšç°‡ç´¢å¼•\nInnoDB çš„ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨å®Œæ•´çš„è¡Œæ•°æ®ã€‚\n1ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰ 2 10 3 / \\ 4 5 15 5 / \\ / \\ 6 1 7 12 18 7 | | | | 8 [å®Œæ•´è¡Œæ•°æ®] äºŒçº§ç´¢å¼•ï¼ˆéä¸»é”®ç´¢å¼•ï¼‰çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼Œéœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\n1äºŒçº§ç´¢å¼•ï¼ˆname ç´¢å¼•ï¼‰ 2 \u0026#34;Bob\u0026#34; 3 / \\ 4 \u0026#34;Alice\u0026#34; \u0026#34;Charlie\u0026#34; 5 | | 6 [ä¸»é”®1] [ä¸»é”®3] 7 â†“ â†“ 8 å›è¡¨æŸ¥è¯¢å®Œæ•´æ•°æ® æ¶æ„æ€è€ƒï¼š èšç°‡ç´¢å¼•çš„è®¾è®¡ä½“ç°äº†\u0026quot;å±€éƒ¨æ€§åŸç†\u0026quot;ã€‚ç›¸é‚»çš„ä¸»é”®å€¼å­˜å‚¨åœ¨ç›¸é‚»çš„ç£ç›˜ä½ç½®ï¼ŒèŒƒå›´æŸ¥è¯¢æ—¶å¯ä»¥é¡ºåºè¯»å–ï¼Œå‡å°‘éšæœº IOã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨è‡ªå¢ä¸»é”®çš„åŸå› ã€‚\nExplain æ‰§è¡Œè®¡åˆ’åˆ†æ åŸºæœ¬ç”¨æ³•\n1EXPLAIN SELECT * FROM user WHERE age = 25; å…³é”®å­—æ®µè§£æ\n1. typeï¼ˆè®¿é—®ç±»å‹ï¼‰\næ€§èƒ½ä»å¥½åˆ°åï¼š\nsystemï¼šè¡¨åªæœ‰ä¸€è¡Œæ•°æ®ï¼ˆç³»ç»Ÿè¡¨ï¼‰ constï¼šé€šè¿‡ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æŸ¥è¯¢ï¼Œæœ€å¤šè¿”å›ä¸€è¡Œ eq_refï¼šå”¯ä¸€ç´¢å¼•æ‰«æï¼Œå¯¹äºæ¯ä¸ªç´¢å¼•é”®ï¼Œè¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•åŒ¹é… refï¼šéå”¯ä¸€ç´¢å¼•æ‰«æï¼Œè¿”å›åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„æ‰€æœ‰è¡Œ rangeï¼šç´¢å¼•èŒƒå›´æ‰«æï¼ˆBETWEENã€\u0026gt;ã€\u0026lt;ï¼‰ indexï¼šå…¨ç´¢å¼•æ‰«æ ALLï¼šå…¨è¡¨æ‰«æï¼ˆæœ€å·®ï¼‰ 1-- const 2EXPLAIN SELECT * FROM user WHERE id = 1; 3 4-- ref 5EXPLAIN SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6 7-- range 8EXPLAIN SELECT * FROM user WHERE age BETWEEN 20 AND 30; 9 10-- ALL 11EXPLAIN SELECT * FROM user WHERE email LIKE \u0026#39;%@gmail.com\u0026#39;; 2. keyï¼ˆå®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼‰\nå¦‚æœä¸º NULLï¼Œè¯´æ˜æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚\n3. rowsï¼ˆæ‰«æçš„è¡Œæ•°ï¼‰\né¢„ä¼°éœ€è¦æ‰«æçš„è¡Œæ•°ï¼Œè¶Šå°‘è¶Šå¥½ã€‚\n4. Extraï¼ˆé¢å¤–ä¿¡æ¯ï¼‰\nUsing indexï¼šä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ Using whereï¼šä½¿ç”¨äº† WHERE è¿‡æ»¤ Using filesortï¼šéœ€è¦é¢å¤–çš„æ’åºæ“ä½œï¼ˆæ€§èƒ½å·®ï¼‰ Using temporaryï¼šéœ€è¦åˆ›å»ºä¸´æ—¶è¡¨ï¼ˆæ€§èƒ½å·®ï¼‰ ç´¢å¼•å¤±æ•ˆçš„ 10 ç§åœºæ™¯ 1. ä½¿ç”¨å‡½æ•°æˆ–è¡¨è¾¾å¼\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE YEAR(create_time) = 2024; 3 4-- ä¼˜åŒ– 5SELECT * FROM user WHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2025-01-01\u0026#39;; 2. éšå¼ç±»å‹è½¬æ¢\n1-- phone æ˜¯ VARCHAR ç±»å‹ï¼Œç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE phone = 13800138000; 3 4-- ä¼˜åŒ– 5SELECT * FROM user WHERE phone = \u0026#39;13800138000\u0026#39;; 3. ä½¿ç”¨ OR è¿æ¥\n1-- å¦‚æœ age æ²¡æœ‰ç´¢å¼•ï¼Œæ•´ä¸ªæŸ¥è¯¢ä¸èµ°ç´¢å¼• 2SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; OR age = 25; 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨ UNION 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; 6UNION 7SELECT * FROM user WHERE age = 25; 4. LIKE ä»¥ % å¼€å¤´\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE name LIKE \u0026#39;%Alice\u0026#39;; 3 4-- ä¼˜åŒ–ï¼š% æ”¾åœ¨åé¢ 5SELECT * FROM user WHERE name LIKE \u0026#39;Alice%\u0026#39;; 5. ä¸ç­‰äºï¼ˆ!= æˆ– \u0026lt;\u0026gt;ï¼‰\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE age != 25; 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨èŒƒå›´æŸ¥è¯¢ 5SELECT * FROM user WHERE age \u0026lt; 25 OR age \u0026gt; 25; 6. IS NULL æˆ– IS NOT NULL\n1-- å¯èƒ½ç´¢å¼•å¤±æ•ˆï¼ˆå–å†³äº NULL å€¼çš„æ¯”ä¾‹ï¼‰ 2SELECT * FROM user WHERE age IS NULL; 3 4-- ä¼˜åŒ–ï¼šé¿å…å­—æ®µä¸º NULLï¼Œä½¿ç”¨é»˜è®¤å€¼ 7. NOT IN å’Œ NOT EXISTS\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE id NOT IN (1, 2, 3); 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨ LEFT JOIN 5SELECT u.* FROM user u 6LEFT JOIN (SELECT 1 AS id UNION SELECT 2 UNION SELECT 3) t ON u.id = t.id 7WHERE t.id IS NULL; 8. è”åˆç´¢å¼•ä¸æ»¡è¶³æœ€å·¦å‰ç¼€\n1-- è”åˆç´¢å¼• (name, age, city) 2 3-- èµ°ç´¢å¼• 4SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25; 6 7-- ä¸èµ°ç´¢å¼• 8SELECT * FROM user WHERE age = 25; 9SELECT * FROM user WHERE city = \u0026#39;Beijing\u0026#39;; 9. èŒƒå›´æŸ¥è¯¢åçš„å­—æ®µä¸èµ°ç´¢å¼•\n1-- è”åˆç´¢å¼• (name, age, city) 2 3-- age èµ°ç´¢å¼•ï¼Œcity ä¸èµ°ç´¢å¼• 4SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age \u0026gt; 20 AND city = \u0026#39;Beijing\u0026#39;; 10. æ•°æ®é‡å¤ªå°\nå¦‚æœè¡¨çš„æ•°æ®é‡å¾ˆå°ï¼ˆå‡ ç™¾è¡Œï¼‰ï¼ŒMySQL å¯èƒ½é€‰æ‹©å…¨è¡¨æ‰«æè€Œä¸æ˜¯ç´¢å¼•ã€‚\nè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é… è§„åˆ™\nè”åˆç´¢å¼• (a, b, c) ç›¸å½“äºåˆ›å»ºäº†ä¸‰ä¸ªç´¢å¼•ï¼š\n(a) (a, b) (a, b, c) æ¡ˆä¾‹åˆ†æ\n1-- åˆ›å»ºè”åˆç´¢å¼• 2CREATE INDEX idx_name_age_city ON user(name, age, city); 3 4-- èµ°ç´¢å¼• 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25; 7SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25 AND city = \u0026#39;Beijing\u0026#39;; 8SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND city = \u0026#39;Beijing\u0026#39;; -- name èµ°ç´¢å¼•ï¼Œcity ä¸èµ° 9 10-- ä¸èµ°ç´¢å¼• 11SELECT * FROM user WHERE age = 25; 12SELECT * FROM user WHERE city = \u0026#39;Beijing\u0026#39;; 13SELECT * FROM user WHERE age = 25 AND city = \u0026#39;Beijing\u0026#39;; ç´¢å¼•é¡ºåºçš„é€‰æ‹©\nåŒºåˆ†åº¦é«˜çš„å­—æ®µæ”¾åœ¨å‰é¢ã€‚\n1-- å‡è®¾ name æœ‰ 1000 ä¸ªä¸åŒå€¼ï¼Œage æœ‰ 50 ä¸ªä¸åŒå€¼ï¼Œcity æœ‰ 10 ä¸ªä¸åŒå€¼ 2-- åº”è¯¥åˆ›å»º (name, age, city)ï¼Œè€Œä¸æ˜¯ (city, age, name) è¦†ç›–ç´¢å¼• è¦†ç›–ç´¢å¼•æ˜¯æŒ‡æŸ¥è¯¢çš„å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­ï¼Œä¸éœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\næ¡ˆä¾‹\n1-- åˆ›å»ºç´¢å¼• 2CREATE INDEX idx_name_age ON user(name, age); 3 4-- è¦†ç›–ç´¢å¼•ï¼ˆä¸éœ€è¦å›è¡¨ï¼‰ 5SELECT name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6 7-- éœ€è¦å›è¡¨ 8SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; ä¼˜åŒ–å»ºè®®\nå¦‚æœæŸ¥è¯¢åªéœ€è¦å°‘æ•°å‡ ä¸ªå­—æ®µï¼Œå¯ä»¥åˆ›å»ºè”åˆç´¢å¼•è¦†ç›–è¿™äº›å­—æ®µã€‚\n1-- ä¼˜åŒ–å‰ 2SELECT id, name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; 3 4-- åˆ›å»ºè¦†ç›–ç´¢å¼• 5CREATE INDEX idx_name_age ON user(name, age); 6 7-- ä¼˜åŒ–åï¼ˆä¸éœ€è¦å›è¡¨ï¼‰ 8SELECT id, name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; ç´¢å¼•ä¸‹æ¨ï¼ˆICPï¼‰ MySQL 5.6 å¼•å…¥çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œå°†éƒ¨åˆ† WHERE æ¡ä»¶ä¸‹æ¨åˆ°å­˜å‚¨å¼•æ“å±‚è¿‡æ»¤ã€‚\næ¡ˆä¾‹\n1-- è”åˆç´¢å¼• (name, age) 2SELECT * FROM user WHERE name LIKE \u0026#39;A%\u0026#39; AND age = 25; æ²¡æœ‰ç´¢å¼•ä¸‹æ¨\nå­˜å‚¨å¼•æ“æ ¹æ® name LIKE \u0026lsquo;A%\u0026rsquo; æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„è®°å½• è¿”å›ç»™ Server å±‚ Server å±‚è¿‡æ»¤ age = 25 æœ‰ç´¢å¼•ä¸‹æ¨\nå­˜å‚¨å¼•æ“æ ¹æ® name LIKE \u0026lsquo;A%\u0026rsquo; æ‰¾åˆ°åŒ¹é…çš„è®°å½• åœ¨å­˜å‚¨å¼•æ“å±‚ç›´æ¥è¿‡æ»¤ age = 25 åªè¿”å›ç¬¦åˆæ¡ä»¶çš„è®°å½•ç»™ Server å±‚ å‡å°‘äº†å›è¡¨æ¬¡æ•°ï¼Œæå‡äº†æ€§èƒ½ã€‚\nåˆ†é¡µæŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ï¼šæ·±åº¦åˆ†é¡µ\n1-- æŸ¥è¯¢ç¬¬ 100 ä¸‡æ¡æ•°æ® 2SELECT * FROM user ORDER BY id LIMIT 1000000, 10; MySQL éœ€è¦æ‰«æ 100 ä¸‡ + 10 æ¡æ•°æ®ï¼Œç„¶åä¸¢å¼ƒå‰ 100 ä¸‡æ¡ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\nä¼˜åŒ–æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨å­æŸ¥è¯¢\n1SELECT * FROM user 2WHERE id \u0026gt;= (SELECT id FROM user ORDER BY id LIMIT 1000000, 1) 3LIMIT 10; å­æŸ¥è¯¢ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œåªè¿”å› idï¼Œç„¶åé€šè¿‡ id æŸ¥è¯¢å®Œæ•´æ•°æ®ã€‚\nä¼˜åŒ–æ–¹æ¡ˆäºŒï¼šè®°å½•ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§ ID\n1-- ç¬¬ä¸€æ¬¡æŸ¥è¯¢ 2SELECT * FROM user ORDER BY id LIMIT 10; 3 4-- ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ˆå‡è®¾ä¸Šæ¬¡æœ€å¤§ ID æ˜¯ 10ï¼‰ 5SELECT * FROM user WHERE id \u0026gt; 10 ORDER BY id LIMIT 10; è¿™ç§æ–¹å¼åªé€‚ç”¨äº ID è¿ç»­çš„åœºæ™¯ã€‚\nç´¢å¼•è®¾è®¡çš„æœ€ä½³å®è·µ 1. é€‰æ‹©åˆé€‚çš„å­—æ®µåˆ›å»ºç´¢å¼•\nWHEREã€ORDER BYã€GROUP BYã€JOIN çš„å­—æ®µ åŒºåˆ†åº¦é«˜çš„å­—æ®µï¼ˆä¸è¦ç»™æ€§åˆ«åˆ›å»ºç´¢å¼•ï¼‰ å­—æ®µé•¿åº¦å°çš„å­—æ®µ 2. ä½¿ç”¨å‰ç¼€ç´¢å¼•\nå¯¹äºé•¿å­—ç¬¦ä¸²å­—æ®µï¼Œå¯ä»¥åªç´¢å¼•å‰å‡ ä¸ªå­—ç¬¦ã€‚\n1CREATE INDEX idx_email ON user(email(10)); 3. é¿å…å†—ä½™ç´¢å¼•\nå¦‚æœå·²ç»æœ‰è”åˆç´¢å¼• (name, age)ï¼Œå°±ä¸éœ€è¦å•ç‹¬åˆ›å»º (name) ç´¢å¼•ã€‚\n4. å®šæœŸåˆ†æå’Œä¼˜åŒ–ç´¢å¼•\n1-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ 2SHOW INDEX FROM user; 3 4-- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼• 5DROP INDEX idx_unused ON user; 5. ä½¿ç”¨è‡ªå¢ä¸»é”®\né¿å…é¡µåˆ†è£‚ï¼Œæå‡æ’å…¥æ€§èƒ½ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šæ…¢æŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ SQL\n1SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; æ‰§è¡Œæ—¶é—´ï¼š3 ç§’\nåˆ†æ\n1EXPLAIN SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; ç»“æœï¼štype = ALLï¼Œrows = 1000000ï¼ŒExtra = Using filesort\nä¼˜åŒ–æ­¥éª¤\nåˆ›å»ºè”åˆç´¢å¼• 1CREATE INDEX idx_user_status_time ON order(user_id, status, create_time); å†æ¬¡åˆ†æ 1EXPLAIN SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; ç»“æœï¼štype = rangeï¼Œrows = 100ï¼ŒExtra = Using index condition\næ‰§è¡Œæ—¶é—´ï¼š50ms\næ€§èƒ½æå‡ï¼š60 å€\næ€»ç»“ä¸æ€è€ƒ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nç†è§£ B+ æ ‘çš„åŸç†ï¼ŒçŸ¥é“ä¸ºä»€ä¹ˆç´¢å¼•èƒ½æå‡æ€§èƒ½ æŒæ¡ Explain çš„ä½¿ç”¨ï¼Œèƒ½å¤Ÿåˆ†ææ‰§è¡Œè®¡åˆ’ é¿å…ç´¢å¼•å¤±æ•ˆçš„ 10 ç§åœºæ™¯ åˆç†è®¾è®¡è”åˆç´¢å¼•ï¼Œåˆ©ç”¨æœ€å·¦å‰ç¼€åŒ¹é… ä½¿ç”¨è¦†ç›–ç´¢å¼•å’Œç´¢å¼•ä¸‹æ¨ä¼˜åŒ–æŸ¥è¯¢ ç´¢å¼•ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œæ¯ä¸ªç´¢å¼•éƒ½ä¼šå ç”¨å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”å½±å“å†™å…¥æ€§èƒ½ã€‚è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯åˆç†è®¾è®¡ç´¢å¼•ã€‚\nä¸‹æ¬¡å½“ä½ çš„ SQL æŸ¥è¯¢å¾ˆæ…¢æ—¶ï¼Œä¸å¦¨ç”¨ Explain åˆ†æä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦èµ°äº†ç´¢å¼•ã€‚\n","permalink":"http://localhost:1313/posts/2024/11/mysql-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E4%BB%8E-explain-%E5%88%B0%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/","summary":"\u003cp\u003eSQL æ€§èƒ½ä¼˜åŒ–æ˜¯åç«¯å¼€å‘çš„å¿…å¤‡æŠ€èƒ½ã€‚ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿï¼Œè€Œåˆç†çš„ç´¢å¼•è®¾è®¡èƒ½è®©æŸ¥è¯¢é€Ÿåº¦æå‡ç™¾å€ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ–¹æ³•è®ºã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ B+ æ ‘ç´¢å¼•çš„åº•å±‚åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Explain æ‰§è¡Œè®¡åˆ’çš„åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é…è§„åˆ™\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£è¦†ç›–ç´¢å¼•ä¸ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"b-æ ‘ç´¢å¼•åŸç†\"\u003eB+ æ ‘ç´¢å¼•åŸç†\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eä¸ºä»€ä¹ˆé€‰æ‹© B+ æ ‘ï¼Ÿ\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¸¸è§çš„æ•°æ®ç»“æ„å¯¹æ¯”ï¼š\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eæ•°æ®ç»“æ„\u003c/th\u003e\n          \u003cth\u003eæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦\u003c/th\u003e\n          \u003cth\u003eé—®é¢˜\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eæ•°ç»„\u003c/td\u003e\n          \u003ctd\u003eO(n)\u003c/td\u003e\n          \u003ctd\u003eæŸ¥è¯¢æ…¢\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eäºŒå‰æœç´¢æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eå¯èƒ½é€€åŒ–ä¸ºé“¾è¡¨\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå¹³è¡¡äºŒå‰æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eæ ‘é«˜å¤ªé«˜ï¼ŒIO æ¬¡æ•°å¤š\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eB æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eéå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œæµªè´¹ç©ºé—´\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eB+ æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜ç´¢å¼•\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003eB+ æ ‘çš„ç‰¹ç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹\u003c/li\u003e\n\u003cli\u003eå¶å­èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢\u003c/li\u003e\n\u003cli\u003eéå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šçš„é”®å€¼\u003c/li\u003e\n\u003cli\u003eæ ‘çš„é«˜åº¦ä½ï¼ŒIO æ¬¡æ•°å°‘\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eInnoDB çš„èšç°‡ç´¢å¼•\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eInnoDB çš„ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨å®Œæ•´çš„è¡Œæ•°æ®ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e       10\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e      /  \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e     5    15\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    / \\   / \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e   1  7  12 18\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e   |  |  |  |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  [å®Œæ•´è¡Œæ•°æ®]\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eäºŒçº§ç´¢å¼•ï¼ˆéä¸»é”®ç´¢å¼•ï¼‰çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼Œéœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\u003c/p\u003e","title":"MySQL ç´¢å¼•ä¼˜åŒ–ï¼šä» Explain åˆ°æ‰§è¡Œè®¡åˆ’"},{"content":"ç”Ÿäº§ç¯å¢ƒçš„ OOMï¼ˆOut Of Memoryï¼‰æ˜¯åç«¯å¼€å‘æœ€å¤´ç–¼çš„é—®é¢˜ä¹‹ä¸€ã€‚æœ¬æ–‡é€šè¿‡çœŸå®æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œè§£å†³ JVM å†…å­˜é—®é¢˜ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ JVM å†…å­˜æ¨¡å‹ä¸ GC æœºåˆ¶ æŒæ¡ Heap Dump çš„ç”Ÿæˆä¸åˆ†ææ–¹æ³• å­¦ä¼šä½¿ç”¨ MAT å·¥å…·å®šä½å†…å­˜æ³„æ¼ äº†è§£å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ JVM å†…å­˜æ¨¡å‹ å †å†…å­˜ï¼ˆHeapï¼‰\nå¹´è½»ä»£ï¼ˆYoung Generationï¼‰ Eden åŒºï¼šæ–°å¯¹è±¡åˆ†é…çš„åŒºåŸŸ Survivor åŒºï¼šS0 å’Œ S1ï¼Œå­˜æ”¾ç»è¿‡ä¸€æ¬¡ GC åå­˜æ´»çš„å¯¹è±¡ è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡ éå †å†…å­˜\næ–¹æ³•åŒºï¼ˆMetaspaceï¼‰ï¼šå­˜æ”¾ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ æ ˆï¼ˆStackï¼‰ï¼šå­˜æ”¾å±€éƒ¨å˜é‡ã€æ–¹æ³•è°ƒç”¨ ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ï¼šNIO ä½¿ç”¨çš„å †å¤–å†…å­˜ GC æœºåˆ¶\nMinor GCï¼šæ¸…ç†å¹´è½»ä»£ Major GCï¼šæ¸…ç†è€å¹´ä»£ Full GCï¼šæ¸…ç†æ•´ä¸ªå †å†…å­˜ å¯¹è±¡æ™‹å‡\næ–°å¯¹è±¡åœ¨ Eden åŒºåˆ†é… Eden åŒºæ»¡äº†ï¼Œè§¦å‘ Minor GC å­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ° Survivor åŒº ç»è¿‡å¤šæ¬¡ GC åï¼Œå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ æ¶æ„æ€è€ƒï¼š JVM çš„åˆ†ä»£æ”¶é›†ä½“ç°äº†\u0026quot;å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•æ­»\u0026quot;çš„ç‰¹ç‚¹ã€‚å¹´è½»ä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¿«é€Ÿå›æ”¶çŸ­å‘½å¯¹è±¡ï¼›è€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå¤„ç†é•¿æœŸå­˜æ´»çš„å¯¹è±¡ã€‚è¿™ç§è®¾è®¡åœ¨æ€§èƒ½å’Œå†…å­˜åˆ©ç”¨ç‡ä¹‹é—´æ‰¾åˆ°äº†å¹³è¡¡ã€‚\nOOM çš„å¸¸è§ç±»å‹ 1. java.lang.OutOfMemoryError: Java heap space\nå †å†…å­˜ä¸è¶³ï¼Œæœ€å¸¸è§çš„ OOMã€‚\nåŸå› ï¼š\nå†…å­˜æ³„æ¼ï¼šå¯¹è±¡æ— æ³•è¢« GC å›æ”¶ å†…å­˜æº¢å‡ºï¼šå¯¹è±¡å¤ªå¤šï¼Œè¶…è¿‡å †å†…å­˜å¤§å° 2. java.lang.OutOfMemoryError: GC overhead limit exceeded\nGC å ç”¨äº† 98% çš„æ—¶é—´ï¼Œä½†åªå›æ”¶äº†ä¸åˆ° 2% çš„å†…å­˜ã€‚\n3. java.lang.OutOfMemoryError: Metaspace\næ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰å†…å­˜ä¸è¶³ã€‚\nåŸå› ï¼š\nåŠ è½½äº†å¤ªå¤šçš„ç±» åŠ¨æ€ç”Ÿæˆç±»ï¼ˆå¦‚ CGLIB ä»£ç†ï¼‰ 4. java.lang.OutOfMemoryError: Direct buffer memory\nç›´æ¥å†…å­˜ä¸è¶³ï¼Œé€šå¸¸æ˜¯ NIO ä½¿ç”¨ä¸å½“ã€‚\næ¡ˆä¾‹ä¸€ï¼šThreadLocal å¯¼è‡´çš„å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOMã€‚\næ’æŸ¥æ­¥éª¤\n1. ç”Ÿæˆ Heap Dump\n1# æ–¹å¼ä¸€ï¼šOOM æ—¶è‡ªåŠ¨ç”Ÿæˆ 2java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/heapdump.hprof -jar app.jar 3 4# æ–¹å¼äºŒï¼šæ‰‹åŠ¨ç”Ÿæˆ 5jmap -dump:format=b,file=/tmp/heapdump.hprof \u0026lt;pid\u0026gt; 2. ä½¿ç”¨ MAT åˆ†æ\nä¸‹è½½ Eclipse Memory Analyzerï¼ˆMATï¼‰å·¥å…·ï¼Œæ‰“å¼€ Heap Dump æ–‡ä»¶ã€‚\n3. æŸ¥çœ‹ Dominator Tree\nDominator Tree æ˜¾ç¤ºå ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡ã€‚\nå‘ç°ï¼šThread å¯¹è±¡å ç”¨äº† 2GB å†…å­˜ã€‚\n4. æŸ¥çœ‹ Thread å¯¹è±¡çš„å¼•ç”¨é“¾\nå±•å¼€ Thread å¯¹è±¡ï¼Œå‘ç° threadLocals å­—æ®µä¸­æœ‰å¤§é‡ Entry å¯¹è±¡ã€‚\n5. æŸ¥çœ‹ Entry çš„ value\nå‘ç° value æ˜¯ä¸šåŠ¡å¯¹è±¡ï¼ˆUser Listï¼‰ï¼ŒåŒ…å« 10 ä¸‡æ¡æ•°æ®ã€‚\næ ¹å› \nä»£ç ä¸­ä½¿ç”¨äº† ThreadLocalï¼Œä½†æ²¡æœ‰è°ƒç”¨ remove()ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 8 cache.set(users); 9 10 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 11 doSomething(users); 12 13 // å¿˜è®°è°ƒç”¨ remove() 14 } 15} è§£å†³æ–¹æ¡ˆ\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 try { 8 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 9 cache.set(users); 10 doSomething(users); 11 } finally { 12 cache.remove(); // å¿…é¡»åœ¨ finally ä¸­æ¸…ç† 13 } 14 } 15} æ¡ˆä¾‹äºŒï¼šå¤§å¯¹è±¡å¯¼è‡´çš„ OOM é—®é¢˜ç°è±¡\nå¯¼å‡º Excel æ—¶ï¼Œåº”ç”¨ OOMã€‚\næ’æŸ¥æ­¥éª¤\n1. æŸ¥çœ‹ GC æ—¥å¿—\n1java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/tmp/gc.log -jar app.jar GC æ—¥å¿—æ˜¾ç¤ºï¼šFull GC é¢‘ç¹ï¼Œä½†å›æ”¶æ•ˆæœä¸æ˜æ˜¾ã€‚\n2. åˆ†æ Heap Dump\nå‘ç°å¤§é‡çš„ ArrayList å¯¹è±¡ï¼Œæ¯ä¸ªåŒ…å« 10 ä¸‡æ¡æ•°æ®ã€‚\næ ¹å› \nä½¿ç”¨ä¼ ç»Ÿçš„ POI å¯¼å‡º Excelï¼Œä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ã€‚\n1public void exportExcel() { 2 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); // æŸ¥è¯¢ 10 ä¸‡æ¡æ•°æ® 3 4 Workbook workbook = new XSSFWorkbook(); 5 Sheet sheet = workbook.createSheet(); 6 7 for (int i = 0; i \u0026lt; users.size(); i++) { 8 Row row = sheet.createRow(i); 9 // å¡«å……æ•°æ® 10 } 11 12 workbook.write(outputStream); 13} è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ EasyExcel æµå¼å†™å…¥\n1public void exportExcel() { 2 EasyExcel.write(outputStream, User.class) 3 .registerWriteHandler(new LongestMatchColumnWidthStyleStrategy()) 4 .sheet(\u0026#34;ç”¨æˆ·åˆ—è¡¨\u0026#34;) 5 .doWrite(() -\u0026gt; { 6 // åˆ†æ‰¹æŸ¥è¯¢ 7 int pageSize = 1000; 8 int pageNum = 1; 9 List\u0026lt;User\u0026gt; users; 10 List\u0026lt;User\u0026gt; allUsers = new ArrayList\u0026lt;\u0026gt;(); 11 12 do { 13 users = userMapper.selectPage(pageNum, pageSize); 14 allUsers.addAll(users); 15 pageNum++; 16 } while (users.size() == pageSize); 17 18 return allUsers; 19 }); 20} æ›´å¥½çš„æ–¹æ¡ˆï¼šä½¿ç”¨ EasyExcel çš„åˆ†æ‰¹å†™å…¥\n1public void exportExcel() { 2 ExcelWriter excelWriter = EasyExcel.write(outputStream, User.class).build(); 3 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;ç”¨æˆ·åˆ—è¡¨\u0026#34;).build(); 4 5 int pageSize = 1000; 6 int pageNum = 1; 7 List\u0026lt;User\u0026gt; users; 8 9 do { 10 users = userMapper.selectPage(pageNum, pageSize); 11 excelWriter.write(users, writeSheet); 12 pageNum++; 13 } while (users.size() == pageSize); 14 15 excelWriter.finish(); 16} æ¡ˆä¾‹ä¸‰ï¼šé™æ€é›†åˆå¯¼è‡´çš„å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nåº”ç”¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå†…å­˜æŒç»­å¢é•¿ã€‚\næ ¹å› \nä½¿ç”¨é™æ€é›†åˆç¼“å­˜æ•°æ®ï¼Œä½†æ²¡æœ‰æ¸…ç†æœºåˆ¶ã€‚\n1public class CacheManager { 2 3 private static final Map\u0026lt;String, Object\u0026gt; cache = new HashMap\u0026lt;\u0026gt;(); 4 5 public static void put(String key, Object value) { 6 cache.put(key, value); 7 } 8 9 public static Object get(String key) { 10 return cache.get(key); 11 } 12} è§£å†³æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ WeakHashMap\n1private static final Map\u0026lt;String, Object\u0026gt; cache = new WeakHashMap\u0026lt;\u0026gt;(); WeakHashMap çš„ key æ˜¯å¼±å¼•ç”¨ï¼Œå½“ key æ²¡æœ‰å¼ºå¼•ç”¨æ—¶ï¼Œä¼šè¢« GC å›æ”¶ã€‚\nè§£å†³æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Guava Cache\n1private static final Cache\u0026lt;String, Object\u0026gt; cache = CacheBuilder.newBuilder() 2 .maximumSize(10000) // æœ€å¤§ç¼“å­˜æ•°é‡ 3 .expireAfterWrite(10, TimeUnit.MINUTES) // å†™å…¥å 10 åˆ†é’Ÿè¿‡æœŸ 4 .build(); è§£å†³æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨ Redis\nå°†ç¼“å­˜æ”¾åˆ° Redisï¼Œé¿å…å ç”¨ JVM å†…å­˜ã€‚\nå¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ 1. ThreadLocal æœªæ¸…ç†\nåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹ï¼ŒThreadLocal å¿…é¡»è°ƒç”¨ remove()ã€‚\n2. é™æ€é›†åˆ\né™æ€é›†åˆçš„ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç›¸åŒï¼Œå®¹æ˜“å¯¼è‡´å†…å­˜æ³„æ¼ã€‚\n3. ç›‘å¬å™¨æœªæ³¨é”€\n1// æ³¨å†Œç›‘å¬å™¨ 2eventBus.register(listener); 3 4// å¿˜è®°æ³¨é”€ 5// eventBus.unregister(listener); 4. æ•°æ®åº“è¿æ¥æœªå…³é—­\n1Connection conn = DriverManager.getConnection(url); 2// å¿˜è®°å…³é—­ 3// conn.close(); 5. IO æµæœªå…³é—­\n1FileInputStream fis = new FileInputStream(file); 2// å¿˜è®°å…³é—­ 3// fis.close(); ä½¿ç”¨ try-with-resources è‡ªåŠ¨å…³é—­èµ„æºï¼š\n1try (FileInputStream fis = new FileInputStream(file)) { 2 // ä½¿ç”¨æµ 3} JVM å‚æ•°è°ƒä¼˜ å †å†…å­˜è®¾ç½®\n1-Xms4g # åˆå§‹å †å†…å­˜ 2-Xmx4g # æœ€å¤§å †å†…å­˜ï¼ˆå»ºè®®ä¸ Xms ç›¸åŒï¼Œé¿å…åŠ¨æ€æ‰©å®¹ï¼‰ å¹´è½»ä»£è®¾ç½®\n1-Xmn2g # å¹´è½»ä»£å¤§å°ï¼ˆå»ºè®®ä¸ºå †å†…å­˜çš„ 1/3 åˆ° 1/2ï¼‰ å…ƒç©ºé—´è®¾ç½®\n1-XX:MetaspaceSize=256m # åˆå§‹å…ƒç©ºé—´å¤§å° 2-XX:MaxMetaspaceSize=512m # æœ€å¤§å…ƒç©ºé—´å¤§å° GC æ—¥å¿—\n1-XX:+PrintGCDetails # æ‰“å° GC è¯¦ç»†ä¿¡æ¯ 2-XX:+PrintGCDateStamps # æ‰“å° GC æ—¶é—´æˆ³ 3-Xloggc:/tmp/gc.log # GC æ—¥å¿—æ–‡ä»¶ OOM æ—¶ç”Ÿæˆ Heap Dump\n1-XX:+HeapDumpOnOutOfMemoryError 2-XX:HeapDumpPath=/tmp/heapdump.hprof GC æ”¶é›†å™¨é€‰æ‹©\n1# G1 æ”¶é›†å™¨ï¼ˆæ¨èï¼‰ 2-XX:+UseG1GC 3-XX:MaxGCPauseMillis=200 # æœ€å¤§ GC åœé¡¿æ—¶é—´ 4 5# ZGCï¼ˆJDK 11+ï¼‰ 6-XX:+UseZGC ç›‘æ§ä¸é¢„è­¦ 1. ä½¿ç”¨ JVM ç›‘æ§å·¥å…·\nJConsoleï¼šJDK è‡ªå¸¦çš„ç›‘æ§å·¥å…· VisualVMï¼šå¯è§†åŒ–ç›‘æ§å·¥å…· Arthasï¼šé˜¿é‡Œå¼€æºçš„è¯Šæ–­å·¥å…· 2. ä½¿ç”¨ APM å·¥å…·\nSkyWalkingï¼šåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ Prometheus + Grafanaï¼šç›‘æ§ä¸å¯è§†åŒ– 3. è®¾ç½®å†…å­˜å‘Šè­¦\nå½“å †å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 80% æ—¶ï¼Œå‘é€å‘Šè­¦é€šçŸ¥ã€‚\næ€»ç»“ä¸æ€è€ƒ JVM OOM æ’æŸ¥çš„æ–¹æ³•è®ºï¼š\nç”Ÿæˆ Heap Dump ä½¿ç”¨ MAT åˆ†æå†…å­˜å ç”¨ æŸ¥çœ‹ Dominator Treeï¼Œæ‰¾åˆ°å ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡ åˆ†æå¼•ç”¨é“¾ï¼Œæ‰¾åˆ°æ ¹å›  ä¿®å¤ä»£ç ï¼Œé¿å…å†…å­˜æ³„æ¼ å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ï¼š\nThreadLocal æœªæ¸…ç† é™æ€é›†åˆæ— é™å¢é•¿ ç›‘å¬å™¨æœªæ³¨é”€ èµ„æºæœªå…³é—­ é¢„é˜²æªæ–½ï¼š\nCode Review é‡ç‚¹å…³æ³¨èµ„æºç®¡ç† ä½¿ç”¨ try-with-resources è‡ªåŠ¨å…³é—­èµ„æº å®šæœŸåˆ†æ Heap Dumpï¼Œæå‰å‘ç°é—®é¢˜ è®¾ç½®åˆç†çš„ JVM å‚æ•°å’Œç›‘æ§å‘Šè­¦ ä¸‹æ¬¡å½“ä½ çš„åº”ç”¨ OOM æ—¶ï¼ŒæŒ‰ç…§è¿™ä¸ªæ–¹æ³•è®ºä¸€æ­¥æ­¥æ’æŸ¥ï¼Œä¸€å®šèƒ½æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚\n","permalink":"http://localhost:1313/posts/2024/10/jvm-oom-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98%E4%BB%8E-heap-dump-%E5%88%B0%E6%A0%B9%E5%9B%A0%E5%88%86%E6%9E%90/","summary":"\u003cp\u003eç”Ÿäº§ç¯å¢ƒçš„ OOMï¼ˆOut Of Memoryï¼‰æ˜¯åç«¯å¼€å‘æœ€å¤´ç–¼çš„é—®é¢˜ä¹‹ä¸€ã€‚æœ¬æ–‡é€šè¿‡çœŸå®æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œè§£å†³ JVM å†…å­˜é—®é¢˜ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ JVM å†…å­˜æ¨¡å‹ä¸ GC æœºåˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Heap Dump çš„ç”Ÿæˆä¸åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ MAT å·¥å…·å®šä½å†…å­˜æ³„æ¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"jvm-å†…å­˜æ¨¡å‹\"\u003eJVM å†…å­˜æ¨¡å‹\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå †å†…å­˜ï¼ˆHeapï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¹´è½»ä»£ï¼ˆYoung Generationï¼‰\n\u003cul\u003e\n\u003cli\u003eEden åŒºï¼šæ–°å¯¹è±¡åˆ†é…çš„åŒºåŸŸ\u003c/li\u003e\n\u003cli\u003eSurvivor åŒºï¼šS0 å’Œ S1ï¼Œå­˜æ”¾ç»è¿‡ä¸€æ¬¡ GC åå­˜æ´»çš„å¯¹è±¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eè€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eéå †å†…å­˜\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ–¹æ³•åŒºï¼ˆMetaspaceï¼‰ï¼šå­˜æ”¾ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡\u003c/li\u003e\n\u003cli\u003eæ ˆï¼ˆStackï¼‰ï¼šå­˜æ”¾å±€éƒ¨å˜é‡ã€æ–¹æ³•è°ƒç”¨\u003c/li\u003e\n\u003cli\u003eç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ï¼šNIO ä½¿ç”¨çš„å †å¤–å†…å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eGC æœºåˆ¶\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMinor GCï¼šæ¸…ç†å¹´è½»ä»£\u003c/li\u003e\n\u003cli\u003eMajor GCï¼šæ¸…ç†è€å¹´ä»£\u003c/li\u003e\n\u003cli\u003eFull GCï¼šæ¸…ç†æ•´ä¸ªå †å†…å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå¯¹è±¡æ™‹å‡\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ–°å¯¹è±¡åœ¨ Eden åŒºåˆ†é…\u003c/li\u003e\n\u003cli\u003eEden åŒºæ»¡äº†ï¼Œè§¦å‘ Minor GC\u003c/li\u003e\n\u003cli\u003eå­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ° Survivor åŒº\u003c/li\u003e\n\u003cli\u003eç»è¿‡å¤šæ¬¡ GC åï¼Œå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e JVM çš„åˆ†ä»£æ”¶é›†ä½“ç°äº†\u0026quot;å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•æ­»\u0026quot;çš„ç‰¹ç‚¹ã€‚å¹´è½»ä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¿«é€Ÿå›æ”¶çŸ­å‘½å¯¹è±¡ï¼›è€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå¤„ç†é•¿æœŸå­˜æ´»çš„å¯¹è±¡ã€‚è¿™ç§è®¾è®¡åœ¨æ€§èƒ½å’Œå†…å­˜åˆ©ç”¨ç‡ä¹‹é—´æ‰¾åˆ°äº†å¹³è¡¡ã€‚\u003c/p\u003e","title":"JVM OOM é—®é¢˜æ’æŸ¥å®æˆ˜ï¼šä» Heap Dump åˆ°æ ¹å› åˆ†æ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´çš„åŒæ­¥è°ƒç”¨ä¼šå¯¼è‡´å¼ºè€¦åˆå’Œæ€§èƒ½ç“¶é¢ˆã€‚æ¶ˆæ¯é˜Ÿåˆ—é€šè¿‡å¼‚æ­¥è§£è€¦ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚æœ¬æ–‡è®²è§£ RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å®æˆ˜åº”ç”¨ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒä»·å€¼ä¸é€‰å‹æ ‡å‡† æŒæ¡ RabbitMQ çš„æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæ¨¡å¼ å­¦ä¼šä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆ äº†è§£æ¶ˆæ¯å¹‚ç­‰æ€§ä¸é¡ºåºæ€§çš„å¤„ç† ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ åœºæ™¯ï¼šè®¢å•åˆ›å»ºæµç¨‹\nåŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private InventoryService inventoryService; 6 7 @Autowired 8 private PaymentService paymentService; 9 10 @Autowired 11 private NotificationService notificationService; 12 13 public void createOrder(Order order) { 14 // 1. ä¿å­˜è®¢å• 15 orderMapper.insert(order); 16 17 // 2. æ‰£å‡åº“å­˜ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 18 inventoryService.deduct(order.getProductId(), order.getQuantity()); 19 20 // 3. åˆ›å»ºæ”¯ä»˜å•ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 21 paymentService.createPayment(order.getId()); 22 23 // 4. å‘é€é€šçŸ¥ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 24 notificationService.sendOrderCreatedNotification(order.getUserId()); 25 } 26} é—®é¢˜ï¼š\nå“åº”æ—¶é—´é•¿ï¼šæ€»è€—æ—¶ = ä¿å­˜è®¢å• + æ‰£å‡åº“å­˜ + åˆ›å»ºæ”¯ä»˜å• + å‘é€é€šçŸ¥ å¼ºè€¦åˆï¼šä»»ä½•ä¸€ä¸ªæœåŠ¡ä¸å¯ç”¨ï¼Œæ•´ä¸ªæµç¨‹å¤±è´¥ æ€§èƒ½ç“¶é¢ˆï¼šä¸‹æ¸¸æœåŠ¡çš„æ€§èƒ½å½±å“ä¸Šæ¸¸æœåŠ¡ å¼‚æ­¥è§£è€¦çš„æ–¹æ¡ˆ\n1@Service 2public class OrderService { 3 4 @Autowired 5 private RabbitTemplate rabbitTemplate; 6 7 public void createOrder(Order order) { 8 // 1. ä¿å­˜è®¢å• 9 orderMapper.insert(order); 10 11 // 2. å‘é€æ¶ˆæ¯åˆ° MQ 12 OrderCreatedEvent event = new OrderCreatedEvent(order.getId(), order.getUserId()); 13 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, event); 14 } 15} 16 17// åº“å­˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ 18@Component 19public class InventoryListener { 20 21 @RabbitListener(queues = \u0026#34;inventory.queue\u0026#34;) 22 public void handleOrderCreated(OrderCreatedEvent event) { 23 inventoryService.deduct(event.getOrderId()); 24 } 25} å¥½å¤„ï¼š\nå“åº”æ—¶é—´çŸ­ï¼šåªéœ€è¦ä¿å­˜è®¢å• + å‘é€æ¶ˆæ¯ æ¾è€¦åˆï¼šä¸‹æ¸¸æœåŠ¡ä¸å¯ç”¨ä¸å½±å“è®¢å•åˆ›å»º å‰Šå³°å¡«è°·ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²æµé‡é«˜å³° æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹ï¼šRabbitMQ vs Kafka ç‰¹æ€§ RabbitMQ Kafka æ¶ˆæ¯æ¨¡å‹ æ¨æ¨¡å¼ï¼ˆPushï¼‰ æ‹‰æ¨¡å¼ï¼ˆPullï¼‰ ååé‡ ä¸‡çº§ ç™¾ä¸‡çº§ å»¶è¿Ÿ å¾®ç§’çº§ æ¯«ç§’çº§ æ¶ˆæ¯é¡ºåº é˜Ÿåˆ—çº§åˆ« åˆ†åŒºçº§åˆ« æ¶ˆæ¯æŒä¹…åŒ– æ”¯æŒ æ”¯æŒ é€‚ç”¨åœºæ™¯ ä¸šåŠ¡è§£è€¦ã€ä»»åŠ¡é˜Ÿåˆ— æ—¥å¿—æ”¶é›†ã€æµå¤„ç† é€‰æ‹© RabbitMQ çš„ç†ç”±\nä¸šåŠ¡åœºæ™¯éœ€è¦å¤æ‚çš„è·¯ç”±è§„åˆ™ï¼ˆExchange + Routing Keyï¼‰ éœ€è¦æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆACKï¼‰ æ¶ˆæ¯é‡ä¸å¤§ï¼Œæ›´å…³æ³¨å¯é æ€§ é€‰æ‹© Kafka çš„ç†ç”±\næµ·é‡æ—¥å¿—æ”¶é›† å®æ—¶æµå¤„ç† éœ€è¦æ¶ˆæ¯å›æº¯ RabbitMQ æ ¸å¿ƒæ¦‚å¿µ æ¶æ„å›¾\n1Producer â†’ Exchange â†’ Queue â†’ Consumer Exchangeï¼ˆäº¤æ¢æœºï¼‰\næ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œæ ¹æ®è·¯ç”±è§„åˆ™åˆ†å‘åˆ°é˜Ÿåˆ—ã€‚\nå››ç§ç±»å‹ï¼š\nDirectï¼šç²¾ç¡®åŒ¹é… Routing Key Topicï¼šæ¨¡ç³ŠåŒ¹é… Routing Keyï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰ Fanoutï¼šå¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ— Headersï¼šæ ¹æ®æ¶ˆæ¯å¤´åŒ¹é… Queueï¼ˆé˜Ÿåˆ—ï¼‰\nå­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚\nBindingï¼ˆç»‘å®šï¼‰\nExchange å’Œ Queue ä¹‹é—´çš„è·¯ç”±è§„åˆ™ã€‚\nå·¥ä½œæ¨¡å¼ 1. Simple æ¨¡å¼ï¼ˆç®€å•é˜Ÿåˆ—ï¼‰\nä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ã€‚\n1// ç”Ÿäº§è€… 2rabbitTemplate.convertAndSend(\u0026#34;simple.queue\u0026#34;, \u0026#34;Hello\u0026#34;); 3 4// æ¶ˆè´¹è€… 5@RabbitListener(queues = \u0026#34;simple.queue\u0026#34;) 6public void receive(String message) { 7 System.out.println(\u0026#34;æ”¶åˆ°æ¶ˆæ¯: \u0026#34; + message); 8} 2. Work æ¨¡å¼ï¼ˆå·¥ä½œé˜Ÿåˆ—ï¼‰\nä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯è½®è¯¢åˆ†å‘ã€‚\n1@RabbitListener(queues = \u0026#34;work.queue\u0026#34;) 2public void worker1(String message) { 3 System.out.println(\u0026#34;Worker1: \u0026#34; + message); 4} 5 6@RabbitListener(queues = \u0026#34;work.queue\u0026#34;) 7public void worker2(String message) { 8 System.out.println(\u0026#34;Worker2: \u0026#34; + message); 9} 3. Publish/Subscribe æ¨¡å¼ï¼ˆå‘å¸ƒè®¢é˜…ï¼‰\nä½¿ç”¨ Fanout Exchangeï¼Œæ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰é˜Ÿåˆ—ã€‚\n1// é…ç½® 2@Bean 3public FanoutExchange fanoutExchange() { 4 return new FanoutExchange(\u0026#34;fanout.exchange\u0026#34;); 5} 6 7@Bean 8public Queue queue1() { 9 return new Queue(\u0026#34;queue1\u0026#34;); 10} 11 12@Bean 13public Binding binding1(FanoutExchange fanoutExchange, Queue queue1) { 14 return BindingBuilder.bind(queue1).to(fanoutExchange); 15} 16 17// ç”Ÿäº§è€… 18rabbitTemplate.convertAndSend(\u0026#34;fanout.exchange\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;Hello\u0026#34;); 4. Routing æ¨¡å¼ï¼ˆè·¯ç”±ï¼‰\nä½¿ç”¨ Direct Exchangeï¼Œæ ¹æ® Routing Key ç²¾ç¡®åŒ¹é…ã€‚\n1// é…ç½® 2@Bean 3public DirectExchange directExchange() { 4 return new DirectExchange(\u0026#34;direct.exchange\u0026#34;); 5} 6 7@Bean 8public Binding bindingError(Queue errorQueue, DirectExchange directExchange) { 9 return BindingBuilder.bind(errorQueue).to(directExchange).with(\u0026#34;error\u0026#34;); 10} 11 12// ç”Ÿäº§è€… 13rabbitTemplate.convertAndSend(\u0026#34;direct.exchange\u0026#34;, \u0026#34;error\u0026#34;, \u0026#34;Error message\u0026#34;); 5. Topic æ¨¡å¼ï¼ˆä¸»é¢˜ï¼‰\nä½¿ç”¨ Topic Exchangeï¼Œæ”¯æŒé€šé…ç¬¦åŒ¹é…ã€‚\n*ï¼šåŒ¹é…ä¸€ä¸ªå•è¯ #ï¼šåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå•è¯ 1// é…ç½® 2@Bean 3public TopicExchange topicExchange() { 4 return new TopicExchange(\u0026#34;topic.exchange\u0026#34;); 5} 6 7@Bean 8public Binding bindingOrder(Queue orderQueue, TopicExchange topicExchange) { 9 return BindingBuilder.bind(orderQueue).to(topicExchange).with(\u0026#34;order.*\u0026#34;); 10} 11 12// ç”Ÿäº§è€… 13rabbitTemplate.convertAndSend(\u0026#34;topic.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, \u0026#34;Order created\u0026#34;); 14rabbitTemplate.convertAndSend(\u0026#34;topic.exchange\u0026#34;, \u0026#34;order.paid\u0026#34;, \u0026#34;Order paid\u0026#34;); æ¶æ„æ€è€ƒï¼š RabbitMQ çš„ Exchange æœºåˆ¶ä½“ç°äº†\u0026quot;ç­–ç•¥æ¨¡å¼\u0026quot;çš„æ€æƒ³ã€‚ä¸åŒç±»å‹çš„ Exchange å®ç°ä¸åŒçš„è·¯ç”±ç­–ç•¥ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸éœ€è¦å…³å¿ƒè·¯ç”±ç»†èŠ‚ã€‚è¿™ç§è®¾è®¡è®©ç³»ç»Ÿæ›´åŠ çµæ´»ï¼Œæ˜“äºæ‰©å±•ã€‚\næ¶ˆæ¯å¯é æ€§ä¿éšœ é—®é¢˜ä¸€ï¼šç”Ÿäº§è€…æ¶ˆæ¯ä¸¢å¤±\nç”Ÿäº§è€…å‘é€æ¶ˆæ¯åï¼ŒRabbitMQ å®•æœºï¼Œæ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼ˆPublisher Confirmï¼‰\n1spring: 2 rabbitmq: 3 publisher-confirm-type: correlated 4 publisher-returns: true 1@Configuration 2public class RabbitConfig { 3 4 @Bean 5 public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) { 6 RabbitTemplate template = new RabbitTemplate(connectionFactory); 7 8 // æ¶ˆæ¯å‘é€åˆ° Exchange çš„ç¡®è®¤ 9 template.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { 10 if (ack) { 11 log.info(\u0026#34;æ¶ˆæ¯å‘é€æˆåŠŸ\u0026#34;); 12 } else { 13 log.error(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥: {}\u0026#34;, cause); 14 // é‡è¯•æˆ–è®°å½•åˆ°æ•°æ®åº“ 15 } 16 }); 17 18 // æ¶ˆæ¯ä» Exchange è·¯ç”±åˆ° Queue çš„ç¡®è®¤ 19 template.setReturnsCallback(returned -\u0026gt; { 20 log.error(\u0026#34;æ¶ˆæ¯è·¯ç”±å¤±è´¥: {}\u0026#34;, returned.getMessage()); 21 }); 22 23 return template; 24 } 25} é—®é¢˜äºŒï¼šæ¶ˆæ¯åœ¨ RabbitMQ ä¸­ä¸¢å¤±\nRabbitMQ å®•æœºï¼Œå†…å­˜ä¸­çš„æ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ¶ˆæ¯æŒä¹…åŒ–\n1// 1. Exchange æŒä¹…åŒ– 2@Bean 3public DirectExchange directExchange() { 4 return new DirectExchange(\u0026#34;direct.exchange\u0026#34;, true, false); 5} 6 7// 2. Queue æŒä¹…åŒ– 8@Bean 9public Queue queue() { 10 return new Queue(\u0026#34;my.queue\u0026#34;, true); 11} 12 13// 3. æ¶ˆæ¯æŒä¹…åŒ– 14rabbitTemplate.convertAndSend(\u0026#34;direct.exchange\u0026#34;, \u0026#34;routing.key\u0026#34;, message, msg -\u0026gt; { 15 msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); 16 return msg; 17}); é—®é¢˜ä¸‰ï¼šæ¶ˆè´¹è€…æ¶ˆæ¯ä¸¢å¤±\næ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯åï¼Œè¿˜æ²¡å¤„ç†å®Œå°±å®•æœºï¼Œæ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨ ACK\n1spring: 2 rabbitmq: 3 listener: 4 simple: 5 acknowledge-mode: manual 1@RabbitListener(queues = \u0026#34;my.queue\u0026#34;) 2public void receive(String message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag) { 3 try { 4 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 5 processMessage(message); 6 7 // æ‰‹åŠ¨ç¡®è®¤ 8 channel.basicAck(tag, false); 9 } catch (Exception e) { 10 log.error(\u0026#34;æ¶ˆæ¯å¤„ç†å¤±è´¥\u0026#34;, e); 11 12 // æ‹’ç»æ¶ˆæ¯ï¼Œé‡æ–°å…¥é˜Ÿ 13 channel.basicNack(tag, false, true); 14 } 15} é¿å‘æç¤ºï¼š æ‰‹åŠ¨ ACK æ—¶ï¼Œå¦‚æœå¿˜è®°è°ƒç”¨ basicAck æˆ– basicNackï¼Œæ¶ˆæ¯ä¼šä¸€ç›´å¤„äº Unacked çŠ¶æ€ï¼Œå ç”¨å†…å­˜ã€‚å»ºè®®åœ¨ finally å—ä¸­ç¡®ä¿æ¶ˆæ¯è¢«ç¡®è®¤ã€‚\næ¶ˆæ¯å¹‚ç­‰æ€§ æ¶ˆæ¯å¯èƒ½è¢«é‡å¤æ¶ˆè´¹ï¼ˆç½‘ç»œæŠ–åŠ¨ã€æ¶ˆè´¹è€…é‡å¯ï¼‰ï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§ã€‚\næ–¹æ¡ˆä¸€ï¼šå”¯ä¸€ ID + æ•°æ®åº“å»é‡\n1@RabbitListener(queues = \u0026#34;order.queue\u0026#34;) 2public void handleOrder(OrderMessage message) { 3 String messageId = message.getMessageId(); 4 5 // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç† 6 if (messageLogMapper.exists(messageId)) { 7 log.info(\u0026#34;æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: {}\u0026#34;, messageId); 8 return; 9 } 10 11 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 12 processOrder(message); 13 14 // è®°å½•æ¶ˆæ¯ ID 15 messageLogMapper.insert(new MessageLog(messageId)); 16} æ–¹æ¡ˆäºŒï¼šRedis å»é‡\n1@RabbitListener(queues = \u0026#34;order.queue\u0026#34;) 2public void handleOrder(OrderMessage message) { 3 String messageId = message.getMessageId(); 4 String key = \u0026#34;message:processed:\u0026#34; + messageId; 5 6 // ä½¿ç”¨ SETNX ä¿è¯åŸå­æ€§ 7 Boolean success = redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;, 1, TimeUnit.HOURS); 8 if (!success) { 9 log.info(\u0026#34;æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: {}\u0026#34;, messageId); 10 return; 11 } 12 13 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 14 processOrder(message); 15} æ¶ˆæ¯é¡ºåºæ€§ RabbitMQ ä¸ä¿è¯å…¨å±€é¡ºåºï¼Œåªä¿è¯å•ä¸ªé˜Ÿåˆ—çš„é¡ºåºã€‚\næ–¹æ¡ˆï¼šæŒ‰ä¸šåŠ¡ ID è·¯ç”±åˆ°åŒä¸€é˜Ÿåˆ—\n1// ç”Ÿäº§è€…ï¼šæ ¹æ®è®¢å• ID è®¡ç®— Routing Key 2public void sendMessage(OrderMessage message) { 3 String routingKey = \u0026#34;order.\u0026#34; + (message.getOrderId() % 10); 4 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, routingKey, message); 5} 6 7// æ¶ˆè´¹è€…ï¼šæ¯ä¸ªé˜Ÿåˆ—åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€… 8@RabbitListener(queues = \u0026#34;order.queue.0\u0026#34;, concurrency = \u0026#34;1\u0026#34;) 9public void handleOrder0(OrderMessage message) { 10 processOrder(message); 11} æ­»ä¿¡é˜Ÿåˆ— æ¶ˆæ¯å¤„ç†å¤±è´¥åï¼Œå¯ä»¥å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Œé¿å…é˜»å¡æ­£å¸¸æ¶ˆæ¯ã€‚\né…ç½®æ­»ä¿¡é˜Ÿåˆ—\n1@Bean 2public Queue normalQueue() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-dead-letter-exchange\u0026#34;, \u0026#34;dlx.exchange\u0026#34;); 5 args.put(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;dlx.routing.key\u0026#34;); 6 return new Queue(\u0026#34;normal.queue\u0026#34;, true, false, false, args); 7} 8 9@Bean 10public Queue deadLetterQueue() { 11 return new Queue(\u0026#34;dead.letter.queue\u0026#34;); 12} 13 14@Bean 15public DirectExchange dlxExchange() { 16 return new DirectExchange(\u0026#34;dlx.exchange\u0026#34;); 17} 18 19@Bean 20public Binding dlxBinding() { 21 return BindingBuilder.bind(deadLetterQueue()).to(dlxExchange()).with(\u0026#34;dlx.routing.key\u0026#34;); 22} æ¶ˆè´¹è€…æ‹’ç»æ¶ˆæ¯\n1@RabbitListener(queues = \u0026#34;normal.queue\u0026#34;) 2public void receive(String message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag) { 3 try { 4 processMessage(message); 5 channel.basicAck(tag, false); 6 } catch (Exception e) { 7 // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ— 8 channel.basicNack(tag, false, false); 9 } 10} å»¶è¿Ÿé˜Ÿåˆ— å®ç°å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆã€‚\næ–¹æ¡ˆä¸€ï¼šTTL + æ­»ä¿¡é˜Ÿåˆ—\n1@Bean 2public Queue delayQueue() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-message-ttl\u0026#34;, 30000); // 30 ç§’åè¿‡æœŸ 5 args.put(\u0026#34;x-dead-letter-exchange\u0026#34;, \u0026#34;order.exchange\u0026#34;); 6 args.put(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;order.timeout\u0026#34;); 7 return new Queue(\u0026#34;delay.queue\u0026#34;, true, false, false, args); 8} æ–¹æ¡ˆäºŒï¼šRabbitMQ å»¶è¿Ÿæ’ä»¶\n1rabbitmq-plugins enable rabbitmq_delayed_message_exchange 1@Bean 2public CustomExchange delayExchange() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-delayed-type\u0026#34;, \u0026#34;direct\u0026#34;); 5 return new CustomExchange(\u0026#34;delay.exchange\u0026#34;, \u0026#34;x-delayed-message\u0026#34;, true, false, args); 6} 7 8// å‘é€å»¶è¿Ÿæ¶ˆæ¯ 9rabbitTemplate.convertAndSend(\u0026#34;delay.exchange\u0026#34;, \u0026#34;routing.key\u0026#34;, message, msg -\u0026gt; { 10 msg.getMessageProperties().setDelay(30000); // å»¶è¿Ÿ 30 ç§’ 11 return msg; 12}); æ€»ç»“ä¸æ€è€ƒ RabbitMQ çš„æ ¸å¿ƒä»·å€¼æ˜¯å¼‚æ­¥è§£è€¦ï¼Œæå‡ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚\nä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆï¼š\nç”Ÿäº§è€…ç¡®è®¤ï¼šPublisher Confirm æ¶ˆæ¯æŒä¹…åŒ–ï¼šExchangeã€Queueã€Message éƒ½æŒä¹…åŒ– æ¶ˆè´¹è€…ç¡®è®¤ï¼šæ‰‹åŠ¨ ACK å¹‚ç­‰æ€§ï¼šå”¯ä¸€ ID + å»é‡ æ­»ä¿¡é˜Ÿåˆ—ï¼šå¤„ç†å¤±è´¥æ¶ˆæ¯ ä¸‹æ¬¡å½“ä½ çš„ç³»ç»Ÿéœ€è¦å¼‚æ­¥è§£è€¦æ—¶ï¼Œä¸å¦¨è¯•è¯• RabbitMQï¼Œä½“éªŒæ¶ˆæ¯é˜Ÿåˆ—çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/10/rabbitmq-%E5%9C%A8%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E8%A7%A3%E8%80%A6%E5%AE%9E%E8%B7%B5/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´çš„åŒæ­¥è°ƒç”¨ä¼šå¯¼è‡´å¼ºè€¦åˆå’Œæ€§èƒ½ç“¶é¢ˆã€‚æ¶ˆæ¯é˜Ÿåˆ—é€šè¿‡å¼‚æ­¥è§£è€¦ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚æœ¬æ–‡è®²è§£ RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å®æˆ˜åº”ç”¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒä»·å€¼ä¸é€‰å‹æ ‡å‡†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ RabbitMQ çš„æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæ¨¡å¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£æ¶ˆæ¯å¹‚ç­‰æ€§ä¸é¡ºåºæ€§çš„å¤„ç†\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—\"\u003eä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼šè®¢å•åˆ›å»ºæµç¨‹\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrderService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eInventoryService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einventoryService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epaymentService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eNotificationService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enotificationService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecreateOrder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. ä¿å­˜è®¢å•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einsert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æ‰£å‡åº“å­˜ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003einventoryService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ededuct\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductId\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆ›å»ºæ”¯ä»˜å•ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003epaymentService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreatePayment\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. å‘é€é€šçŸ¥ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003enotificationService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esendOrderCreatedNotification\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e","title":"RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å¼‚æ­¥è§£è€¦å®è·µ"},{"content":"DDDï¼ˆDomain-Driven Designï¼‰æ˜¯ä¸€å¥—å¤æ‚ä¸šåŠ¡ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•è®ºã€‚ä½†å¾ˆå¤šäººå­¦äº† DDD çš„æ¦‚å¿µï¼Œå´ä¸çŸ¥é“å¦‚ä½•è½åœ°ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªç”µå•†è®¢å•ç³»ç»Ÿçš„æ¡ˆä¾‹ï¼Œè®²è§£ DDD çš„å®æˆ˜åº”ç”¨ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ DDD çš„æ ¸å¿ƒæ¦‚å¿µï¼šå®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡ æŒæ¡é™ç•Œä¸Šä¸‹æ–‡çš„åˆ’åˆ†æ–¹æ³• å­¦ä¼šç”¨é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦ äº†è§£ DDD åˆ†å±‚æ¶æ„çš„ä»£ç ç»„ç»‡ ä¸ºä»€ä¹ˆéœ€è¦ DDDï¼Ÿ ä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨ç®€å•ä¸šåŠ¡åœºæ™¯ä¸‹å¤Ÿç”¨ï¼Œä½†å½“ä¸šåŠ¡å¤æ‚åº¦å¢åŠ æ—¶ï¼Œä¼šå‡ºç°å‡ ä¸ªé—®é¢˜ï¼š\nService å±‚é€»è¾‘è‡ƒè‚¿\næ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å †åœ¨ Service å±‚ï¼Œä¸€ä¸ª OrderService å¯èƒ½æœ‰å‡ åƒè¡Œä»£ç ã€‚\nä¸šåŠ¡è§„åˆ™æ•£è½å„å¤„\nè®¢å•çš„çŠ¶æ€æµè½¬è§„åˆ™å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ª Service æ–¹æ³•ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚\né¢†åŸŸçŸ¥è¯†æµå¤±\nä»£ç ä¸­å……æ–¥ç€ updateStatus(orderId, 3)ï¼Œæ²¡äººçŸ¥é“ 3 ä»£è¡¨ä»€ä¹ˆçŠ¶æ€ã€‚\nDDD é€šè¿‡é¢†åŸŸå»ºæ¨¡ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ï¼Œæå‡å¯ç»´æŠ¤æ€§ã€‚\nDDD æ ¸å¿ƒæ¦‚å¿µ å®ä½“ï¼ˆEntityï¼‰\næœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå†…æ ‡è¯†ä¸å˜ã€‚æ¯”å¦‚è®¢å•ã€ç”¨æˆ·ã€‚\n1public class Order { 2 private OrderId id; // å”¯ä¸€æ ‡è¯† 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 // ä¸šåŠ¡æ–¹æ³• 8 public void pay() { 9 if (this.status != OrderStatus.PENDING_PAYMENT) { 10 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 11 } 12 this.status = OrderStatus.PAID; 13 } 14} å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰\næ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œé€šè¿‡å±æ€§å€¼åˆ¤æ–­ç›¸ç­‰æ€§ã€‚æ¯”å¦‚åœ°å€ã€é‡‘é¢ã€‚\n1public class Money { 2 private final BigDecimal amount; 3 private final Currency currency; 4 5 public Money(BigDecimal amount, Currency currency) { 6 if (amount.compareTo(BigDecimal.ZERO) \u0026lt; 0) { 7 throw new IllegalArgumentException(\u0026#34;é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°\u0026#34;); 8 } 9 this.amount = amount; 10 this.currency = currency; 11 } 12 13 public Money add(Money other) { 14 if (!this.currency.equals(other.currency)) { 15 throw new IllegalArgumentException(\u0026#34;è´§å¸ç±»å‹ä¸ä¸€è‡´\u0026#34;); 16 } 17 return new Money(this.amount.add(other.amount), this.currency); 18 } 19} å€¼å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€æœ‰æ“ä½œéƒ½è¿”å›æ–°å¯¹è±¡ã€‚\nèšåˆæ ¹ï¼ˆAggregate Rootï¼‰\nèšåˆæ˜¯ä¸€ç»„ç›¸å…³å¯¹è±¡çš„é›†åˆï¼Œèšåˆæ ¹æ˜¯èšåˆçš„å…¥å£ã€‚å¤–éƒ¨åªèƒ½é€šè¿‡èšåˆæ ¹è®¿é—®èšåˆå†…çš„å¯¹è±¡ã€‚\n1public class Order { // èšåˆæ ¹ 2 private OrderId id; 3 private List\u0026lt;OrderItem\u0026gt; items; // èšåˆå†…çš„å®ä½“ 4 5 // å¤–éƒ¨ä¸èƒ½ç›´æ¥ä¿®æ”¹ itemsï¼Œå¿…é¡»é€šè¿‡èšåˆæ ¹çš„æ–¹æ³• 6 public void addItem(Product product, int quantity) { 7 OrderItem item = new OrderItem(product, quantity); 8 this.items.add(item); 9 } 10} èšåˆæ ¹çš„ä½œç”¨æ˜¯ä¿æŠ¤èšåˆçš„ä¸å˜æ€§ï¼ˆInvariantï¼‰ã€‚\né¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰\nä¸å±äºä»»ä½•å®ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ”¾åœ¨é¢†åŸŸæœåŠ¡ä¸­ã€‚\n1public class PricingService { 2 3 public Money calculateTotalPrice(Order order) { 4 Money total = Money.zero(); 5 for (OrderItem item : order.getItems()) { 6 Money itemPrice = item.getProduct().getPrice().multiply(item.getQuantity()); 7 total = total.add(itemPrice); 8 } 9 return total; 10 } 11} æ¶æ„æ€è€ƒï¼š å®ä½“å’Œå€¼å¯¹è±¡çš„åŒºåˆ«åœ¨äºæ˜¯å¦æœ‰å”¯ä¸€æ ‡è¯†ã€‚è®¢å•æœ‰è®¢å•å·ï¼Œæ˜¯å®ä½“ï¼›é‡‘é¢æ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œæ˜¯å€¼å¯¹è±¡ã€‚åˆ¤æ–­æ ‡å‡†æ˜¯ï¼šå¦‚æœä¸¤ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§éƒ½ç›¸åŒï¼Œå®ƒä»¬æ˜¯å¦åº”è¯¥è¢«è§†ä¸ºåŒä¸€ä¸ªå¯¹è±¡ï¼Ÿ\né™ç•Œä¸Šä¸‹æ–‡ï¼šåˆ’åˆ†é¢†åŸŸè¾¹ç•Œ ä¸€ä¸ªå¤æ‚ç³»ç»ŸåŒ…å«å¤šä¸ªå­åŸŸï¼Œæ¯ä¸ªå­åŸŸæœ‰è‡ªå·±çš„é¢†åŸŸæ¨¡å‹ã€‚é™ç•Œä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰å®šä¹‰äº†é¢†åŸŸæ¨¡å‹çš„è¾¹ç•Œã€‚\næ¡ˆä¾‹ï¼šç”µå•†ç³»ç»Ÿçš„é™ç•Œä¸Šä¸‹æ–‡\nè®¢å•ä¸Šä¸‹æ–‡ï¼š è®¢å•ã€è®¢å•é¡¹ã€è®¢å•çŠ¶æ€ åº“å­˜ä¸Šä¸‹æ–‡ï¼š å•†å“ã€åº“å­˜ã€åº“å­˜æ‰£å‡ æ”¯ä»˜ä¸Šä¸‹æ–‡ï¼š æ”¯ä»˜å•ã€æ”¯ä»˜æ–¹å¼ã€æ”¯ä»˜çŠ¶æ€ ç‰©æµä¸Šä¸‹æ–‡ï¼š ç‰©æµå•ã€ç‰©æµçŠ¶æ€ã€ç‰©æµå…¬å¸ æ¯ä¸ªä¸Šä¸‹æ–‡æœ‰è‡ªå·±çš„é¢†åŸŸæ¨¡å‹ã€‚æ¯”å¦‚\u0026quot;å•†å“\u0026quot;åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„å«ä¹‰ä¸åŒï¼š\nè®¢å•ä¸Šä¸‹æ–‡ï¼šå•†å“æ˜¯è®¢å•é¡¹çš„ä¸€éƒ¨åˆ†ï¼Œå…³æ³¨å•†å“åç§°ã€ä»·æ ¼ åº“å­˜ä¸Šä¸‹æ–‡ï¼šå•†å“æ˜¯åº“å­˜ç®¡ç†çš„å¯¹è±¡ï¼Œå…³æ³¨åº“å­˜æ•°é‡ã€ä»“åº“ä½ç½® ä¸Šä¸‹æ–‡æ˜ å°„ï¼ˆContext Mappingï¼‰\nä¸åŒä¸Šä¸‹æ–‡ä¹‹é—´éœ€è¦åä½œï¼Œé€šè¿‡ä¸Šä¸‹æ–‡æ˜ å°„å®šä¹‰åä½œæ–¹å¼ï¼š\nå…±äº«å†…æ ¸ï¼ˆShared Kernelï¼‰ï¼š ä¸¤ä¸ªä¸Šä¸‹æ–‡å…±äº«éƒ¨åˆ†é¢†åŸŸæ¨¡å‹ å®¢æˆ·-ä¾›åº”å•†ï¼ˆCustomer-Supplierï¼‰ï¼š ä¸€ä¸ªä¸Šä¸‹æ–‡ä¾èµ–å¦ä¸€ä¸ªä¸Šä¸‹æ–‡ é˜²è…å±‚ï¼ˆAnti-Corruption Layerï¼‰ï¼š é€šè¿‡é€‚é…å™¨éš”ç¦»å¤–éƒ¨ç³»ç»Ÿ æ¡ˆä¾‹ï¼šè®¢å•ä¸Šä¸‹æ–‡ä¾èµ–åº“å­˜ä¸Šä¸‹æ–‡\n1// è®¢å•ä¸Šä¸‹æ–‡ä¸­çš„é˜²è…å±‚ 2public class InventoryAdapter { 3 4 @Autowired 5 private InventoryClient inventoryClient; 6 7 public boolean checkStock(ProductId productId, int quantity) { 8 // è°ƒç”¨åº“å­˜ä¸Šä¸‹æ–‡çš„æ¥å£ 9 InventoryDTO inventory = inventoryClient.getInventory(productId.getValue()); 10 return inventory.getStock() \u0026gt;= quantity; 11 } 12} é˜²è…å±‚çš„ä½œç”¨æ˜¯ï¼šéš”ç¦»å¤–éƒ¨ç³»ç»Ÿçš„å˜åŒ–ï¼Œä¿æŠ¤æœ¬ä¸Šä¸‹æ–‡çš„é¢†åŸŸæ¨¡å‹ã€‚\né¢†åŸŸäº‹ä»¶ï¼šå®ç°æœåŠ¡è§£è€¦ é¢†åŸŸäº‹ä»¶æ˜¯é¢†åŸŸä¸­å‘ç”Ÿçš„é‡è¦äº‹æƒ…ï¼Œæ¯”å¦‚\u0026quot;è®¢å•å·²åˆ›å»º\u0026quot;ã€\u0026ldquo;è®¢å•å·²æ”¯ä»˜\u0026rdquo;ã€‚\nå‘å¸ƒé¢†åŸŸäº‹ä»¶\n1public class Order { 2 3 public void pay() { 4 if (this.status != OrderStatus.PENDING_PAYMENT) { 5 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 6 } 7 this.status = OrderStatus.PAID; 8 9 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ 10 DomainEventPublisher.publish(new OrderPaidEvent(this.id, this.userId)); 11 } 12} ç›‘å¬é¢†åŸŸäº‹ä»¶\n1@Component 2public class OrderEventListener { 3 4 @Autowired 5 private InventoryService inventoryService; 6 7 @EventListener 8 public void handleOrderPaid(OrderPaidEvent event) { 9 // è®¢å•æ”¯ä»˜åï¼Œæ‰£å‡åº“å­˜ 10 inventoryService.deduct(event.getOrderId()); 11 } 12} é¢†åŸŸäº‹ä»¶çš„å¥½å¤„ï¼š\nè§£è€¦ï¼šè®¢å•ä¸Šä¸‹æ–‡ä¸éœ€è¦çŸ¥é“åº“å­˜ä¸Šä¸‹æ–‡çš„å­˜åœ¨ æ‰©å±•æ€§ï¼šæ–°å¢ç›‘å¬å™¨ä¸éœ€è¦ä¿®æ”¹è®¢å•ä»£ç  å®¡è®¡ï¼šäº‹ä»¶æµè®°å½•äº†ç³»ç»Ÿçš„æ‰€æœ‰å˜åŒ– æ¶æ„æ€è€ƒï¼š é¢†åŸŸäº‹ä»¶æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEDAï¼‰çš„åŸºç¡€ã€‚å®ƒè®©ç³»ç»Ÿä»\u0026quot;è°ƒç”¨é©±åŠ¨\u0026quot;å˜æˆ\u0026quot;äº‹ä»¶é©±åŠ¨\u0026quot;ï¼Œæå‡äº†ç³»ç»Ÿçš„æ¾è€¦åˆæ€§ã€‚ç±»ä¼¼çš„æ€æƒ³è¿˜æœ‰ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€å‘å¸ƒè®¢é˜…æ¨¡å¼ã€CQRSã€‚\nDDD åˆ†å±‚æ¶æ„ DDD æ¨èçš„åˆ†å±‚æ¶æ„ï¼š\n1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ ç”¨æˆ·æ¥å£å±‚ï¼ˆUser Interfaceï¼‰ â”‚ Controllerã€DTO 3â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 4â”‚ åº”ç”¨å±‚ï¼ˆApplicationï¼‰ â”‚ ApplicationServiceã€äº‹ä»¶å‘å¸ƒ 5â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 6â”‚ é¢†åŸŸå±‚ï¼ˆDomainï¼‰ â”‚ Entityã€ValueObjectã€DomainService 7â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 8â”‚ åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰ â”‚ Repositoryã€MQã€ç¼“å­˜ 9â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ç”¨æˆ·æ¥å£å±‚\nå¤„ç† HTTP è¯·æ±‚ï¼Œè°ƒç”¨åº”ç”¨å±‚æœåŠ¡ã€‚\n1@RestController 2@RequestMapping(\u0026#34;/orders\u0026#34;) 3public class OrderController { 4 5 @Autowired 6 private OrderApplicationService orderApplicationService; 7 8 @PostMapping 9 public OrderDTO createOrder(@RequestBody CreateOrderRequest request) { 10 OrderId orderId = orderApplicationService.createOrder(request); 11 return orderApplicationService.getOrder(orderId); 12 } 13} åº”ç”¨å±‚\nç¼–æ’é¢†åŸŸå¯¹è±¡ï¼Œå¤„ç†äº‹åŠ¡å’Œäº‹ä»¶å‘å¸ƒã€‚\n1@Service 2public class OrderApplicationService { 3 4 @Autowired 5 private OrderRepository orderRepository; 6 7 @Autowired 8 private DomainEventPublisher eventPublisher; 9 10 @Transactional 11 public OrderId createOrder(CreateOrderRequest request) { 12 // åˆ›å»ºè®¢å•èšåˆ 13 Order order = Order.create(request.getUserId(), request.getItems()); 14 15 // ä¿å­˜è®¢å• 16 orderRepository.save(order); 17 18 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ 19 eventPublisher.publish(new OrderCreatedEvent(order.getId())); 20 21 return order.getId(); 22 } 23} é¢†åŸŸå±‚\næ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨æ¡†æ¶ã€‚\n1public class Order { 2 private OrderId id; 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 public static Order create(UserId userId, List\u0026lt;OrderItem\u0026gt; items) { 8 if (items.isEmpty()) { 9 throw new IllegalArgumentException(\u0026#34;è®¢å•é¡¹ä¸èƒ½ä¸ºç©º\u0026#34;); 10 } 11 Order order = new Order(); 12 order.id = OrderId.generate(); 13 order.userId = userId; 14 order.status = OrderStatus.PENDING_PAYMENT; 15 order.items = items; 16 return order; 17 } 18 19 public void pay() { 20 if (this.status != OrderStatus.PENDING_PAYMENT) { 21 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 22 } 23 this.status = OrderStatus.PAID; 24 } 25} åŸºç¡€è®¾æ–½å±‚\nå®ç°é¢†åŸŸå±‚å®šä¹‰çš„æ¥å£ï¼Œå¤„ç†æŒä¹…åŒ–ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ã€‚\n1@Repository 2public class OrderRepositoryImpl implements OrderRepository { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 @Override 8 public void save(Order order) { 9 OrderPO po = OrderConverter.toPO(order); 10 orderMapper.insert(po); 11 } 12 13 @Override 14 public Order findById(OrderId id) { 15 OrderPO po = orderMapper.selectById(id.getValue()); 16 return OrderConverter.toDomain(po); 17 } 18} é¿å‘æç¤ºï¼š é¢†åŸŸå±‚ä¸åº”è¯¥ä¾èµ–åŸºç¡€è®¾æ–½å±‚ã€‚Repository æ¥å£å®šä¹‰åœ¨é¢†åŸŸå±‚ï¼Œå®ç°åœ¨åŸºç¡€è®¾æ–½å±‚ã€‚è¿™æ˜¯ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰çš„ä½“ç°ã€‚\nDDD çš„é€‚ç”¨åœºæ™¯ DDD ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒé€‚åˆå¤æ‚ä¸šåŠ¡ç³»ç»Ÿï¼Œä¸é€‚åˆç®€å•çš„ CRUD åº”ç”¨ã€‚\né€‚åˆ DDD çš„åœºæ™¯ï¼š\nä¸šåŠ¡è§„åˆ™å¤æ‚ï¼Œéœ€è¦é¢‘ç¹å˜æ›´ å¤šä¸ªå›¢é˜Ÿåä½œå¼€å‘ ç³»ç»Ÿéœ€è¦é•¿æœŸæ¼”è¿› ä¸é€‚åˆ DDD çš„åœºæ™¯ï¼š\nç®€å•çš„å¢åˆ æ”¹æŸ¥ ä¸šåŠ¡é€»è¾‘å¾ˆå°‘ é¡¹ç›®å‘¨æœŸçŸ­ï¼Œä¸éœ€è¦é•¿æœŸç»´æŠ¤ æ€»ç»“ä¸æ€è€ƒ DDD çš„æ ¸å¿ƒæ˜¯ï¼šç”¨ä»£ç è¡¨è¾¾ä¸šåŠ¡è¯­è¨€ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ã€‚\né€šè¿‡å®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹å»ºæ¨¡é¢†åŸŸå¯¹è±¡ é€šè¿‡é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†é¢†åŸŸè¾¹ç•Œ é€šè¿‡é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦ é€šè¿‡åˆ†å±‚æ¶æ„éš”ç¦»ä¸šåŠ¡é€»è¾‘å’ŒæŠ€æœ¯å®ç° DDD ä¸æ˜¯æŠ€æœ¯ï¼Œè€Œæ˜¯æ€ç»´æ–¹å¼ã€‚å®ƒè¦æ±‚å¼€å‘è€…æ·±å…¥ç†è§£ä¸šåŠ¡ï¼Œä¸ä¸šåŠ¡ä¸“å®¶å…±åŒå»ºæ¨¡ã€‚è¿™æ˜¯ä¸€ä¸ªæŒç»­è¿­ä»£çš„è¿‡ç¨‹ã€‚\nä¸‹æ¬¡å½“ä½ çš„ Service å±‚ä»£ç è¶…è¿‡ 500 è¡Œæ—¶ï¼Œä¸å¦¨è¯•è¯• DDDï¼Œé‡æ–°å®¡è§†ä½ çš„é¢†åŸŸæ¨¡å‹ã€‚\n","permalink":"http://localhost:1313/posts/2024/09/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1ddd%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E4%BB%A3%E7%A0%81/","summary":"\u003cp\u003eDDDï¼ˆDomain-Driven Designï¼‰æ˜¯ä¸€å¥—å¤æ‚ä¸šåŠ¡ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•è®ºã€‚ä½†å¾ˆå¤šäººå­¦äº† DDD çš„æ¦‚å¿µï¼Œå´ä¸çŸ¥é“å¦‚ä½•è½åœ°ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªç”µå•†è®¢å•ç³»ç»Ÿçš„æ¡ˆä¾‹ï¼Œè®²è§£ DDD çš„å®æˆ˜åº”ç”¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ DDD çš„æ ¸å¿ƒæ¦‚å¿µï¼šå®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é™ç•Œä¸Šä¸‹æ–‡çš„åˆ’åˆ†æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç”¨é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ DDD åˆ†å±‚æ¶æ„çš„ä»£ç ç»„ç»‡\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦-ddd\"\u003eä¸ºä»€ä¹ˆéœ€è¦ DDDï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨ç®€å•ä¸šåŠ¡åœºæ™¯ä¸‹å¤Ÿç”¨ï¼Œä½†å½“ä¸šåŠ¡å¤æ‚åº¦å¢åŠ æ—¶ï¼Œä¼šå‡ºç°å‡ ä¸ªé—®é¢˜ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eService å±‚é€»è¾‘è‡ƒè‚¿\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å †åœ¨ Service å±‚ï¼Œä¸€ä¸ª OrderService å¯èƒ½æœ‰å‡ åƒè¡Œä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡è§„åˆ™æ•£è½å„å¤„\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eè®¢å•çš„çŠ¶æ€æµè½¬è§„åˆ™å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ª Service æ–¹æ³•ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé¢†åŸŸçŸ¥è¯†æµå¤±\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eä»£ç ä¸­å……æ–¥ç€ \u003ccode\u003eupdateStatus(orderId, 3)\u003c/code\u003eï¼Œæ²¡äººçŸ¥é“ 3 ä»£è¡¨ä»€ä¹ˆçŠ¶æ€ã€‚\u003c/p\u003e\n\u003cp\u003eDDD é€šè¿‡é¢†åŸŸå»ºæ¨¡ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ï¼Œæå‡å¯ç»´æŠ¤æ€§ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"ddd-æ ¸å¿ƒæ¦‚å¿µ\"\u003eDDD æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå®ä½“ï¼ˆEntityï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå†…æ ‡è¯†ä¸å˜ã€‚æ¯”å¦‚è®¢å•ã€ç”¨æˆ·ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å”¯ä¸€æ ‡è¯†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸šåŠ¡æ–¹æ³•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epay\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePENDING_PAYMENT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ethrow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eIllegalStateException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePAID\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eå€¼å¯¹è±¡ï¼ˆValue Objectï¼‰\u003c/strong\u003e\u003c/p\u003e","title":"é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰è½åœ°å®è·µï¼šä»ç†è®ºåˆ°ä»£ç "},{"content":"å®¹å™¨åŒ–å·²ç»æˆä¸ºç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†æ–¹å¼ã€‚Docker è®©åº”ç”¨éƒ¨ç½²å˜å¾—ç®€å•ã€å¯é ã€å¯ç§»æ¤ã€‚æœ¬æ–‡è®²è§£ Docker åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ Dockerfile çš„ç¼–å†™æŠ€å·§ä¸ä¼˜åŒ–æ–¹æ³• ç†è§£ Docker é•œåƒçš„åˆ†å±‚æ„å»ºåŸç† å­¦ä¼šä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒä½“ç§¯ äº†è§£ Docker Compose ç¼–æ’å¤šæœåŠ¡ç¯å¢ƒ ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–ï¼Ÿ ä¼ ç»Ÿéƒ¨ç½²çš„ç—›ç‚¹\nç¯å¢ƒä¸ä¸€è‡´ï¼š\u0026ldquo;åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘\u0026rdquo; ä¾èµ–ç®¡ç†å¤æ‚ï¼šJDKã€Tomcatã€MySQL ç‰ˆæœ¬ä¸ä¸€è‡´ éƒ¨ç½²æµç¨‹ç¹çï¼šæ‰‹åŠ¨ä¸Šä¼ ã€è§£å‹ã€é…ç½®ã€å¯åŠ¨ èµ„æºåˆ©ç”¨ç‡ä½ï¼šä¸€å°æœåŠ¡å™¨åªè·‘ä¸€ä¸ªåº”ç”¨ å®¹å™¨åŒ–çš„ä¼˜åŠ¿\nç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´ å¿«é€Ÿéƒ¨ç½²ï¼šç§’çº§å¯åŠ¨ï¼Œä¸€é”®éƒ¨ç½² èµ„æºéš”ç¦»ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“ æ˜“äºæ‰©å±•ï¼šæ°´å¹³æ‰©å±•åªéœ€å¯åŠ¨æ›´å¤šå®¹å™¨ Dockerfile åŸºç¡€ æœ€ç®€å•çš„ Dockerfile\n1FROM openjdk:11-jre-slim 2COPY app.jar /app.jar 3ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] æ„å»ºé•œåƒ\n1docker build -t myapp:1.0 . è¿è¡Œå®¹å™¨\n1docker run -d -p 8080:8080 myapp:1.0 Dockerfile æœ€ä½³å®è·µ 1. é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ ä¸å¥½çš„åšæ³•\n1FROM ubuntu:20.04 2RUN apt-get update \u0026amp;\u0026amp; apt-get install -y openjdk-11-jdk é•œåƒå¤§å°ï¼š600MB+\nå¥½çš„åšæ³•\n1FROM openjdk:11-jre-slim é•œåƒå¤§å°ï¼š200MB\næ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨ Alpine\n1FROM openjdk:11-jre-alpine é•œåƒå¤§å°ï¼š150MB\né€‰æ‹©åŸåˆ™ï¼š ä¼˜å…ˆä½¿ç”¨å®˜æ–¹é•œåƒï¼Œé€‰æ‹©æœ€å°çš„æ»¡è¶³éœ€æ±‚çš„ç‰ˆæœ¬ï¼ˆslim \u0026gt; alpineï¼‰\n2. åˆ©ç”¨æ„å»ºç¼“å­˜ Docker æ„å»ºé•œåƒæ—¶ï¼Œä¼šç¼“å­˜æ¯ä¸€å±‚ã€‚å¦‚æœæŸä¸€å±‚æ²¡æœ‰å˜åŒ–ï¼Œä¼šç›´æ¥ä½¿ç”¨ç¼“å­˜ã€‚\nä¸å¥½çš„åšæ³•\n1FROM openjdk:11-jre-slim 2COPY . /app 3RUN cd /app \u0026amp;\u0026amp; ./mvnw clean package æ¯æ¬¡ä»£ç å˜åŒ–ï¼Œéƒ½è¦é‡æ–°ä¸‹è½½ä¾èµ–ã€‚\nå¥½çš„åšæ³•ï¼šåˆ†ç¦»ä¾èµ–å’Œä»£ç \n1FROM openjdk:11-jre-slim 2 3# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ 4COPY pom.xml /app/ 5COPY mvnw /app/ 6COPY .mvn /app/.mvn 7WORKDIR /app 8RUN ./mvnw dependency:go-offline 9 10# å†å¤åˆ¶ä»£ç  11COPY src /app/src 12RUN ./mvnw clean package -DskipTests 13 14ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app/target/app.jar\u0026#34;] è¿™æ ·ï¼Œåªæœ‰ pom.xml å˜åŒ–æ—¶æ‰ä¼šé‡æ–°ä¸‹è½½ä¾èµ–ã€‚\n3. å¤šé˜¶æ®µæ„å»º é—®é¢˜ï¼š æ„å»ºå·¥å…·ï¼ˆMavenã€Gradleï¼‰ä¼šå¢åŠ é•œåƒä½“ç§¯ã€‚\nè§£å†³æ–¹æ¡ˆï¼š ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œåªä¿ç•™è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶ã€‚\n1# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º 2FROM maven:3.8-openjdk-11 AS builder 3WORKDIR /app 4COPY pom.xml . 5RUN mvn dependency:go-offline 6COPY src ./src 7RUN mvn clean package -DskipTests 8 9# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ 10FROM openjdk:11-jre-slim 11WORKDIR /app 12COPY --from=builder /app/target/app.jar . 13EXPOSE 8080 14ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;app.jar\u0026#34;] æ•ˆæœï¼š\næ„å»ºé˜¶æ®µé•œåƒï¼š800MB æœ€ç»ˆé•œåƒï¼š200MB 4. å‡å°‘é•œåƒå±‚æ•° ä¸å¥½çš„åšæ³•\n1RUN apt-get update 2RUN apt-get install -y curl 3RUN apt-get install -y vim 4RUN apt-get clean æ¯ä¸ª RUN éƒ½ä¼šåˆ›å»ºä¸€å±‚ï¼Œå¢åŠ é•œåƒä½“ç§¯ã€‚\nå¥½çš„åšæ³•ï¼šåˆå¹¶å‘½ä»¤\n1RUN apt-get update \u0026amp;\u0026amp; \\ 2 apt-get install -y curl vim \u0026amp;\u0026amp; \\ 3 apt-get clean \u0026amp;\u0026amp; \\ 4 rm -rf /var/lib/apt/lists/* 5. ä½¿ç”¨ .dockerignore ç±»ä¼¼ .gitignoreï¼Œé¿å…å°†ä¸å¿…è¦çš„æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­ã€‚\n1# .dockerignore 2target/ 3*.log 4.git/ 5.idea/ 6*.md 6. ä¸è¦åœ¨å®¹å™¨ä¸­å­˜å‚¨æ•°æ® å®¹å™¨æ˜¯ä¸´æ—¶çš„ï¼Œæ•°æ®åº”è¯¥å­˜å‚¨åœ¨å¤–éƒ¨ã€‚\nä½¿ç”¨ Volume æŒ‚è½½æ•°æ®\n1docker run -d -v /data/mysql:/var/lib/mysql mysql:8.0 ä½¿ç”¨å‘½åå·\n1docker volume create mysql-data 2docker run -d -v mysql-data:/var/lib/mysql mysql:8.0 7. å¥åº·æ£€æŸ¥ 1FROM openjdk:11-jre-slim 2COPY app.jar /app.jar 3 4HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \\ 5 CMD curl -f http://localhost:8080/actuator/health || exit 1 6 7ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] Docker ä¼šå®šæœŸæ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€ï¼Œä¸å¥åº·çš„å®¹å™¨ä¼šè¢«é‡å¯ã€‚\n8. ä½¿ç”¨é root ç”¨æˆ· å®‰å…¨é£é™©ï¼š é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨å†…çš„è¿›ç¨‹ä»¥ root ç”¨æˆ·è¿è¡Œã€‚\nè§£å†³æ–¹æ¡ˆï¼š åˆ›å»ºæ™®é€šç”¨æˆ·\n1FROM openjdk:11-jre-slim 2 3# åˆ›å»ºç”¨æˆ· 4RUN groupadd -r appuser \u0026amp;\u0026amp; useradd -r -g appuser appuser 5 6# å¤åˆ¶æ–‡ä»¶ 7COPY app.jar /app.jar 8RUN chown appuser:appuser /app.jar 9 10# åˆ‡æ¢ç”¨æˆ· 11USER appuser 12 13ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] ä¼˜åŒ– Spring Boot åº”ç”¨çš„ Dockerfile å®Œæ•´ç¤ºä¾‹\n1# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º 2FROM maven:3.8-openjdk-11-slim AS builder 3WORKDIR /build 4 5# å¤åˆ¶ä¾èµ–æ–‡ä»¶ 6COPY pom.xml . 7COPY .mvn .mvn 8COPY mvnw . 9RUN ./mvnw dependency:go-offline -B 10 11# å¤åˆ¶æºç å¹¶æ„å»º 12COPY src src 13RUN ./mvnw package -DskipTests -B 14 15# è§£å‹ jar åŒ…ï¼ˆåˆ©ç”¨ Spring Boot çš„åˆ†å±‚ç‰¹æ€§ï¼‰ 16RUN mkdir -p target/dependency \u0026amp;\u0026amp; \\ 17 cd target/dependency \u0026amp;\u0026amp; \\ 18 jar -xf ../*.jar 19 20# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ 21FROM openjdk:11-jre-slim 22WORKDIR /app 23 24# åˆ›å»ºé root ç”¨æˆ· 25RUN groupadd -r spring \u0026amp;\u0026amp; useradd -r -g spring spring 26 27# åˆ†å±‚å¤åˆ¶ï¼ˆåˆ©ç”¨ Docker ç¼“å­˜ï¼‰ 28COPY --from=builder /build/target/dependency/BOOT-INF/lib /app/lib 29COPY --from=builder /build/target/dependency/META-INF /app/META-INF 30COPY --from=builder /build/target/dependency/BOOT-INF/classes /app 31 32# ä¿®æ”¹æ‰€æœ‰è€… 33RUN chown -R spring:spring /app 34 35# åˆ‡æ¢ç”¨æˆ· 36USER spring 37 38# å¥åº·æ£€æŸ¥ 39HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \\ 40 CMD curl -f http://localhost:8080/actuator/health || exit 1 41 42# å¯åŠ¨åº”ç”¨ 43ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-cp\u0026#34;, \u0026#34;/app:/app/lib/*\u0026#34;, \u0026#34;com.example.Application\u0026#34;] ä¼˜åŒ–æ•ˆæœï¼š\nåˆ©ç”¨åˆ†å±‚ç¼“å­˜ï¼Œä¾èµ–å˜åŒ–æ—¶ä¸éœ€è¦é‡æ–°æ„å»ºæ•´ä¸ªåº”ç”¨ ä½¿ç”¨é root ç”¨æˆ·ï¼Œæå‡å®‰å…¨æ€§ æ·»åŠ å¥åº·æ£€æŸ¥ï¼Œæå‡å¯é æ€§ Docker Composeï¼šç¼–æ’å¤šæœåŠ¡ åœºæ™¯ï¼š åº”ç”¨éœ€è¦ MySQLã€Redisã€Nginx\ndocker-compose.yml\n1version: \u0026#39;3.8\u0026#39; 2 3services: 4 # MySQL æ•°æ®åº“ 5 mysql: 6 image: mysql:8.0 7 container_name: mysql 8 environment: 9 MYSQL_ROOT_PASSWORD: root123 10 MYSQL_DATABASE: myapp 11 volumes: 12 - mysql-data:/var/lib/mysql 13 ports: 14 - \u0026#34;3306:3306\u0026#34; 15 networks: 16 - app-network 17 healthcheck: 18 test: [\u0026#34;CMD\u0026#34;, \u0026#34;mysqladmin\u0026#34;, \u0026#34;ping\u0026#34;, \u0026#34;-h\u0026#34;, \u0026#34;localhost\u0026#34;] 19 interval: 10s 20 timeout: 5s 21 retries: 5 22 23 # Redis ç¼“å­˜ 24 redis: 25 image: redis:7-alpine 26 container_name: redis 27 ports: 28 - \u0026#34;6379:6379\u0026#34; 29 networks: 30 - app-network 31 healthcheck: 32 test: [\u0026#34;CMD\u0026#34;, \u0026#34;redis-cli\u0026#34;, \u0026#34;ping\u0026#34;] 33 interval: 10s 34 timeout: 3s 35 retries: 5 36 37 # Spring Boot åº”ç”¨ 38 app: 39 build: 40 context: . 41 dockerfile: Dockerfile 42 container_name: myapp 43 environment: 44 SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/myapp 45 SPRING_REDIS_HOST: redis 46 ports: 47 - \u0026#34;8080:8080\u0026#34; 48 depends_on: 49 mysql: 50 condition: service_healthy 51 redis: 52 condition: service_healthy 53 networks: 54 - app-network 55 restart: unless-stopped 56 57 # Nginx åå‘ä»£ç† 58 nginx: 59 image: nginx:alpine 60 container_name: nginx 61 volumes: 62 - ./nginx.conf:/etc/nginx/nginx.conf:ro 63 ports: 64 - \u0026#34;80:80\u0026#34; 65 depends_on: 66 - app 67 networks: 68 - app-network 69 70volumes: 71 mysql-data: 72 73networks: 74 app-network: 75 driver: bridge å¯åŠ¨æ‰€æœ‰æœåŠ¡\n1docker-compose up -d æŸ¥çœ‹æ—¥å¿—\n1docker-compose logs -f app åœæ­¢æ‰€æœ‰æœåŠ¡\n1docker-compose down ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² 1. ä½¿ç”¨ç¯å¢ƒå˜é‡ ä¸è¦åœ¨é•œåƒä¸­ç¡¬ç¼–ç é…ç½®\n1# ä¸å¥½ 2ENV SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/myapp ä½¿ç”¨ç¯å¢ƒå˜é‡\n1docker run -d \\ 2 -e SPRING_DATASOURCE_URL=jdbc:mysql://prod-mysql:3306/myapp \\ 3 -e SPRING_DATASOURCE_PASSWORD=prod_password \\ 4 myapp:1.0 2. èµ„æºé™åˆ¶ 1docker run -d \\ 2 --memory=\u0026#34;512m\u0026#34; \\ 3 --cpus=\u0026#34;1.0\u0026#34; \\ 4 myapp:1.0 3. æ—¥å¿—ç®¡ç† ä½¿ç”¨æ—¥å¿—é©±åŠ¨\n1docker run -d \\ 2 --log-driver=json-file \\ 3 --log-opt max-size=10m \\ 4 --log-opt max-file=3 \\ 5 myapp:1.0 4. è‡ªåŠ¨é‡å¯ 1docker run -d --restart=unless-stopped myapp:1.0 é‡å¯ç­–ç•¥ï¼š\nnoï¼šä¸è‡ªåŠ¨é‡å¯ï¼ˆé»˜è®¤ï¼‰ on-failureï¼šå¤±è´¥æ—¶é‡å¯ alwaysï¼šæ€»æ˜¯é‡å¯ unless-stoppedï¼šé™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™æ€»æ˜¯é‡å¯ CI/CD é›†æˆ GitLab CI ç¤ºä¾‹\n1# .gitlab-ci.yml 2stages: 3 - build 4 - deploy 5 6build: 7 stage: build 8 script: 9 - docker build -t myapp:$CI_COMMIT_SHA . 10 - docker tag myapp:$CI_COMMIT_SHA myapp:latest 11 - docker push myapp:$CI_COMMIT_SHA 12 - docker push myapp:latest 13 14deploy: 15 stage: deploy 16 script: 17 - docker pull myapp:$CI_COMMIT_SHA 18 - docker stop myapp || true 19 - docker rm myapp || true 20 - docker run -d --name myapp -p 8080:8080 myapp:$CI_COMMIT_SHA 21 only: 22 - main å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ 1. å®¹å™¨æ—¶åŒºé—®é¢˜ 1FROM openjdk:11-jre-slim 2ENV TZ=Asia/Shanghai 3RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \u0026amp;\u0026amp; echo $TZ \u0026gt; /etc/timezone 2. å®¹å™¨å†…æ— æ³•è®¿é—®å®¿ä¸»æœºæœåŠ¡ ä½¿ç”¨ host.docker.internalï¼ˆMac/Windowsï¼‰æˆ– 172.17.0.1ï¼ˆLinuxï¼‰\n1environment: 2 SPRING_DATASOURCE_URL: jdbc:mysql://host.docker.internal:3306/myapp 3. é•œåƒæ„å»ºæ…¢ ä½¿ç”¨å›½å†…é•œåƒæº åˆ©ç”¨æ„å»ºç¼“å­˜ ä½¿ç”¨å¤šé˜¶æ®µæ„å»º 4. å®¹å™¨å†…å­˜æº¢å‡º è®¾ç½® JVM å‚æ•°ï¼š\n1ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-Xmx512m\u0026#34;, \u0026#34;-Xms512m\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] æ€»ç»“ä¸æ€è€ƒ Docker å®¹å™¨åŒ–çš„æ ¸å¿ƒè¦ç‚¹ï¼š\né€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒï¼Œå‡å°‘é•œåƒä½“ç§¯ åˆ©ç”¨æ„å»ºç¼“å­˜å’Œå¤šé˜¶æ®µæ„å»ºï¼Œæå‡æ„å»ºé€Ÿåº¦ ä½¿ç”¨é root ç”¨æˆ·ï¼Œæå‡å®‰å…¨æ€§ ä½¿ç”¨ Docker Compose ç¼–æ’å¤šæœåŠ¡ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾ç½®èµ„æºé™åˆ¶å’Œå¥åº·æ£€æŸ¥ å®¹å™¨åŒ–ä¸ä»…ä»…æ˜¯æŠ€æœ¯ï¼Œæ›´æ˜¯ä¸€ç§æ€ç»´æ–¹å¼ã€‚å®ƒè®©æˆ‘ä»¬é‡æ–°æ€è€ƒåº”ç”¨çš„éƒ¨ç½²å’Œè¿ç»´æ–¹å¼ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦éƒ¨ç½²åº”ç”¨æ—¶ï¼Œä¸å¦¨è¯•è¯• Dockerï¼Œä½“éªŒå®¹å™¨åŒ–å¸¦æ¥çš„ä¾¿åˆ©ã€‚\n","permalink":"http://localhost:1313/posts/2024/09/docker-%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%BB%8E-dockerfile-%E5%88%B0%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83/","summary":"\u003cp\u003eå®¹å™¨åŒ–å·²ç»æˆä¸ºç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†æ–¹å¼ã€‚Docker è®©åº”ç”¨éƒ¨ç½²å˜å¾—ç®€å•ã€å¯é ã€å¯ç§»æ¤ã€‚æœ¬æ–‡è®²è§£ Docker åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Dockerfile çš„ç¼–å†™æŠ€å·§ä¸ä¼˜åŒ–æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Docker é•œåƒçš„åˆ†å±‚æ„å»ºåŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒä½“ç§¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ Docker Compose ç¼–æ’å¤šæœåŠ¡ç¯å¢ƒ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–\"\u003eä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿéƒ¨ç½²çš„ç—›ç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eç¯å¢ƒä¸ä¸€è‡´ï¼š\u0026ldquo;åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘\u0026rdquo;\u003c/li\u003e\n\u003cli\u003eä¾èµ–ç®¡ç†å¤æ‚ï¼šJDKã€Tomcatã€MySQL ç‰ˆæœ¬ä¸ä¸€è‡´\u003c/li\u003e\n\u003cli\u003eéƒ¨ç½²æµç¨‹ç¹çï¼šæ‰‹åŠ¨ä¸Šä¼ ã€è§£å‹ã€é…ç½®ã€å¯åŠ¨\u003c/li\u003e\n\u003cli\u003eèµ„æºåˆ©ç”¨ç‡ä½ï¼šä¸€å°æœåŠ¡å™¨åªè·‘ä¸€ä¸ªåº”ç”¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eå®¹å™¨åŒ–çš„ä¼˜åŠ¿\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´\u003c/li\u003e\n\u003cli\u003eå¿«é€Ÿéƒ¨ç½²ï¼šç§’çº§å¯åŠ¨ï¼Œä¸€é”®éƒ¨ç½²\u003c/li\u003e\n\u003cli\u003eèµ„æºéš”ç¦»ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“\u003c/li\u003e\n\u003cli\u003eæ˜“äºæ‰©å±•ï¼šæ°´å¹³æ‰©å±•åªéœ€å¯åŠ¨æ›´å¤šå®¹å™¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"dockerfile-åŸºç¡€\"\u003eDockerfile åŸºç¡€\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eæœ€ç®€å•çš„ Dockerfile\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dockerfile\" data-lang=\"dockerfile\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eopenjdk:11-jre-slim\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCOPY\u003c/span\u003e app.jar /app.jar\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eENTRYPOINT\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;java\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;-jar\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/app.jar\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ„å»ºé•œåƒ\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003edocker build -t myapp:1.0 .\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eè¿è¡Œå®¹å™¨\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003edocker run -d -p 8080:8080 myapp:1.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"dockerfile-æœ€ä½³å®è·µ\"\u003eDockerfile æœ€ä½³å®è·µ\u003c/h2\u003e\n\u003ch3 id=\"1-é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ\"\u003e1. é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¸å¥½çš„åšæ³•\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dockerfile\" data-lang=\"dockerfile\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eubuntu:20.04\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eRUN\u003c/span\u003e apt-get update \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e apt-get install -y openjdk-11-jdk\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé•œåƒå¤§å°ï¼š600MB+\u003c/p\u003e","title":"Docker å®¹å™¨åŒ–éƒ¨ç½²æœ€ä½³å®è·µï¼šä» Dockerfile åˆ°ç”Ÿäº§ç¯å¢ƒ"},{"content":"åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å®ä¾‹å¯èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œéœ€è¦åˆ†å¸ƒå¼é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚Redis æ˜¯å®ç°åˆ†å¸ƒå¼é”çš„å¸¸ç”¨æ–¹æ¡ˆï¼Œä½†å¾ˆå¤šäººåªä¼šç”¨ SETNXï¼Œä¸çŸ¥é“å…¶ä¸­çš„å‘ã€‚æœ¬æ–‡æ·±å…¥å‰–æ Redis åˆ†å¸ƒå¼é”çš„å®ç°ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Redis åˆ†å¸ƒå¼é”çš„å®ç°åŸç†ä¸å¸¸è§é—®é¢˜ æŒæ¡ Redisson çœ‹é—¨ç‹—æœºåˆ¶çš„è®¾è®¡æ€æƒ³ å­¦ä¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„é”ä¼˜åŒ–æ–¹æ¡ˆ äº†è§£åˆ†å¸ƒå¼é”çš„æœ€ä½³å®è·µ ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ åœºæ™¯ä¸€ï¼šåº“å­˜æ‰£å‡\n1// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰åŠ é” 2public void deductStock(Long productId, int quantity) { 3 Stock stock = stockMapper.selectById(productId); 4 if (stock.getQuantity() \u0026gt;= quantity) { 5 stock.setQuantity(stock.getQuantity() - quantity); 6 stockMapper.updateById(stock); 7 } 8} åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–åº“å­˜ï¼Œå¯èƒ½å¯¼è‡´è¶…å–ã€‚\nåœºæ™¯äºŒï¼šå®šæ—¶ä»»åŠ¡å»é‡\nå¤šä¸ªæœåŠ¡å®ä¾‹éƒ¨ç½²æ—¶ï¼Œå®šæ—¶ä»»åŠ¡ä¼šé‡å¤æ‰§è¡Œï¼Œéœ€è¦åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œã€‚\nåŸºç¡€å®ç°ï¼šSETNX + EXPIRE ç‰ˆæœ¬ä¸€ï¼šæœ€ç®€å•çš„å®ç°\n1public boolean tryLock(String key) { 2 return redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;); 3} 4 5public void unlock(String key) { 6 redisTemplate.delete(key); 7} é—®é¢˜ï¼šå¦‚æœè·å–é”åï¼ŒæœåŠ¡å®•æœºï¼Œé”æ°¸è¿œä¸ä¼šé‡Šæ”¾ï¼Œå¯¼è‡´æ­»é”ã€‚\nç‰ˆæœ¬äºŒï¼šåŠ ä¸Šè¿‡æœŸæ—¶é—´\n1public boolean tryLock(String key, long expireTime) { 2 Boolean result = redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;); 3 if (result) { 4 redisTemplate.expire(key, expireTime, TimeUnit.SECONDS); 5 } 6 return result; 7} é—®é¢˜ï¼šSETNX å’Œ EXPIRE ä¸æ˜¯åŸå­æ“ä½œï¼Œå¦‚æœåœ¨ä¸¤è€…ä¹‹é—´å®•æœºï¼Œä»ç„¶ä¼šæ­»é”ã€‚\nç‰ˆæœ¬ä¸‰ï¼šåŸå­æ“ä½œ\n1public boolean tryLock(String key, long expireTime) { 2 return redisTemplate.opsForValue() 3 .setIfAbsent(key, \u0026#34;1\u0026#34;, expireTime, TimeUnit.SECONDS); 4} Redis 2.6.12 ä¹‹åï¼ŒSET å‘½ä»¤æ”¯æŒ NX å’Œ EX å‚æ•°ï¼Œä¿è¯åŸå­æ€§ã€‚\n1SET lock_key unique_value NX EX 30 NXï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶è®¾ç½® EXï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ è¿›é˜¶é—®é¢˜ï¼šé”è¯¯åˆ  é—®é¢˜åœºæ™¯\n11. çº¿ç¨‹ A è·å–é”ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ 30 ç§’ 22. çº¿ç¨‹ A æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œè€—æ—¶ 35 ç§’ 33. 30 ç§’åï¼Œé”è‡ªåŠ¨è¿‡æœŸï¼Œçº¿ç¨‹ B è·å–é” 44. çº¿ç¨‹ A æ‰§è¡Œå®Œæ¯•ï¼Œåˆ é™¤é”ï¼ˆè¯¯åˆ äº†çº¿ç¨‹ B çš„é”ï¼‰ è§£å†³æ–¹æ¡ˆï¼šé”çš„å”¯ä¸€æ ‡è¯†\n1public boolean tryLock(String key, String requestId, long expireTime) { 2 return redisTemplate.opsForValue() 3 .setIfAbsent(key, requestId, expireTime, TimeUnit.SECONDS); 4} 5 6public void unlock(String key, String requestId) { 7 String value = redisTemplate.opsForValue().get(key); 8 if (requestId.equals(value)) { 9 redisTemplate.delete(key); 10 } 11} æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å”¯ä¸€çš„ requestIdï¼ˆå¦‚ UUIDï¼‰ï¼Œé‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„é”ã€‚\nä½†è¿™é‡Œä»æœ‰é—®é¢˜ï¼šGET å’Œ DELETE ä¸æ˜¯åŸå­æ“ä½œã€‚\nLua è„šæœ¬ä¿è¯åŸå­æ€§\n1public void unlock(String key, String requestId) { 2 String script = 3 \u0026#34;if redis.call(\u0026#39;get\u0026#39;, KEYS[1]) == ARGV[1] then \u0026#34; + 4 \u0026#34; return redis.call(\u0026#39;del\u0026#39;, KEYS[1]) \u0026#34; + 5 \u0026#34;else \u0026#34; + 6 \u0026#34; return 0 \u0026#34; + 7 \u0026#34;end\u0026#34;; 8 9 redisTemplate.execute( 10 new DefaultRedisScript\u0026lt;\u0026gt;(script, Long.class), 11 Collections.singletonList(key), 12 requestId 13 ); 14} Lua è„šæœ¬åœ¨ Redis ä¸­æ˜¯åŸå­æ‰§è¡Œçš„ï¼Œä¿è¯äº†åˆ¤æ–­å’Œåˆ é™¤çš„åŸå­æ€§ã€‚\næ¶æ„æ€è€ƒï¼š åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒé—®é¢˜æ˜¯\u0026quot;åŸå­æ€§\u0026quot;ã€‚SETNX + EXPIRE ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦ç”¨ SET NX EXï¼›GET + DELETE ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦ç”¨ Lua è„šæœ¬ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šåœºæ™¯éƒ½é€‚ç”¨ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚\nRedissonï¼šç”Ÿäº§çº§çš„åˆ†å¸ƒå¼é” Redisson æ˜¯ Redis å®˜æ–¹æ¨èçš„ Java å®¢æˆ·ç«¯ï¼Œæä¾›äº†å¼€ç®±å³ç”¨çš„åˆ†å¸ƒå¼é”ã€‚\nåŸºæœ¬ä½¿ç”¨\n1@Autowired 2private RedissonClient redissonClient; 3 4public void doSomething() { 5 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 6 try { 7 // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾… 10 ç§’ï¼Œé”è‡ªåŠ¨è¿‡æœŸæ—¶é—´ 30 ç§’ 8 boolean isLocked = lock.tryLock(10, 30, TimeUnit.SECONDS); 9 if (isLocked) { 10 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 11 } 12 } catch (InterruptedException e) { 13 Thread.currentThread().interrupt(); 14 } finally { 15 lock.unlock(); 16 } 17} çœ‹é—¨ç‹—æœºåˆ¶ï¼ˆWatchdogï¼‰\nå¦‚æœä¸æŒ‡å®šé”çš„è¿‡æœŸæ—¶é—´ï¼ŒRedisson ä¼šå¯åŠ¨çœ‹é—¨ç‹—æœºåˆ¶ï¼š\n1lock.lock(); // é»˜è®¤è¿‡æœŸæ—¶é—´ 30 ç§’ çœ‹é—¨ç‹—ä¼šæ¯éš” 10 ç§’ï¼ˆè¿‡æœŸæ—¶é—´çš„ 1/3ï¼‰æ£€æŸ¥é”æ˜¯å¦è¿˜è¢«æŒæœ‰ï¼Œå¦‚æœæ˜¯ï¼Œè‡ªåŠ¨ç»­æœŸ 30 ç§’ã€‚\nçœ‹é—¨ç‹—çš„å®ç°åŸç†\n1private void scheduleExpirationRenewal(long threadId) { 2 ExpirationEntry entry = new ExpirationEntry(); 3 ExpirationEntry oldEntry = EXPIRATION_RENEWAL_MAP.putIfAbsent(getEntryName(), entry); 4 5 if (oldEntry != null) { 6 oldEntry.addThreadId(threadId); 7 } else { 8 entry.addThreadId(threadId); 9 renewExpiration(); 10 } 11} 12 13private void renewExpiration() { 14 ExpirationEntry ee = EXPIRATION_RENEWAL_MAP.get(getEntryName()); 15 if (ee == null) { 16 return; 17 } 18 19 Timeout task = commandExecutor.getConnectionManager().newTimeout(timeout -\u0026gt; { 20 // ç»­æœŸé” 21 RFuture\u0026lt;Boolean\u0026gt; future = renewExpirationAsync(threadId); 22 future.onComplete((res, e) -\u0026gt; { 23 if (e != null) { 24 return; 25 } 26 if (res) { 27 // ç»­æœŸæˆåŠŸï¼Œç»§ç»­è°ƒåº¦ä¸‹ä¸€æ¬¡ç»­æœŸ 28 renewExpiration(); 29 } 30 }); 31 }, internalLockLeaseTime / 3, TimeUnit.MILLISECONDS); 32 33 ee.setTimeout(task); 34} çœ‹é—¨ç‹—çš„å¥½å¤„ï¼š\né¿å…ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”è¿‡æœŸ é¿å…æ‰‹åŠ¨è®¾ç½®è¿‡æœŸæ—¶é—´ä¸å‡†ç¡® é¿å‘æç¤ºï¼š çœ‹é—¨ç‹—åªåœ¨æœªæŒ‡å®šè¿‡æœŸæ—¶é—´æ—¶ç”Ÿæ•ˆã€‚å¦‚æœä½ è°ƒç”¨ lock.tryLock(10, 30, TimeUnit.SECONDS)ï¼Œçœ‹é—¨ç‹—ä¸ä¼šå¯åŠ¨ï¼Œé”ä¼šåœ¨ 30 ç§’åè‡ªåŠ¨è¿‡æœŸã€‚\nå¯é‡å…¥é” Redisson çš„é”æ˜¯å¯é‡å…¥çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”ã€‚\n1public void methodA() { 2 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 3 lock.lock(); 4 try { 5 methodB(); // å¯ä»¥å†æ¬¡è·å–é” 6 } finally { 7 lock.unlock(); 8 } 9} 10 11public void methodB() { 12 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 13 lock.lock(); 14 try { 15 // ä¸šåŠ¡é€»è¾‘ 16 } finally { 17 lock.unlock(); 18 } 19} å®ç°åŸç†ï¼šHash ç»“æ„\n1HSET myLock thread-1 1 # ç¬¬ä¸€æ¬¡åŠ é” 2HINCRBY myLock thread-1 1 # ç¬¬äºŒæ¬¡åŠ é”ï¼Œè®¡æ•°å™¨ +1 é‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°å™¨ -1ï¼Œåªæœ‰è®¡æ•°å™¨ä¸º 0 æ—¶æ‰çœŸæ­£é‡Šæ”¾é”ã€‚\né«˜å¹¶å‘ä¼˜åŒ–ï¼šåˆ†æ®µé” åœ¨ç§’æ€åœºæ™¯ä¸‹ï¼Œæ‰€æœ‰è¯·æ±‚ç«äº‰åŒä¸€æŠŠé”ï¼Œæ€§èƒ½å¾ˆå·®ã€‚å¯ä»¥ä½¿ç”¨åˆ†æ®µé”ä¼˜åŒ–ã€‚\nåœºæ™¯ï¼šåº“å­˜æ‰£å‡\n1public void deductStock(Long productId, int quantity) { 2 // æ ¹æ®å•†å“ ID åˆ†æ®µ 3 int segment = (int) (productId % 10); 4 String lockKey = \u0026#34;stock_lock:\u0026#34; + productId + \u0026#34;:\u0026#34; + segment; 5 6 RLock lock = redissonClient.getLock(lockKey); 7 lock.lock(); 8 try { 9 // æ‰£å‡åº“å­˜ 10 Stock stock = stockMapper.selectById(productId); 11 if (stock.getQuantity() \u0026gt;= quantity) { 12 stock.setQuantity(stock.getQuantity() - quantity); 13 stockMapper.updateById(stock); 14 } 15 } finally { 16 lock.unlock(); 17 } 18} å°†åº“å­˜åˆ†æˆ 10 æ®µï¼Œæ¯æ®µç‹¬ç«‹åŠ é”ï¼Œæå‡å¹¶å‘åº¦ã€‚\nè¯»å†™é”\nå¦‚æœè¯»å¤šå†™å°‘ï¼Œå¯ä»¥ä½¿ç”¨è¯»å†™é”ï¼š\n1RReadWriteLock rwLock = redissonClient.getReadWriteLock(\u0026#34;myLock\u0026#34;); 2 3// è¯»é”ï¼ˆå…±äº«é”ï¼‰ 4RLock readLock = rwLock.readLock(); 5readLock.lock(); 6try { 7 // è¯»æ“ä½œ 8} finally { 9 readLock.unlock(); 10} 11 12// å†™é”ï¼ˆæ’ä»–é”ï¼‰ 13RLock writeLock = rwLock.writeLock(); 14writeLock.lock(); 15try { 16 // å†™æ“ä½œ 17} finally { 18 writeLock.unlock(); 19} å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰è¯»é”ï¼Œä½†å†™é”æ˜¯æ’ä»–çš„ã€‚\nçº¢é”ï¼ˆRedLockï¼‰ï¼šå¤šèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é” å•èŠ‚ç‚¹ Redis å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ï¼ŒRedLock é€šè¿‡å¤šä¸ªç‹¬ç«‹çš„ Redis èŠ‚ç‚¹å®ç°é«˜å¯ç”¨ã€‚\nRedLock ç®—æ³•\nè·å–å½“å‰æ—¶é—´æˆ³ ä¾æ¬¡å‘ N ä¸ª Redis èŠ‚ç‚¹è¯·æ±‚åŠ é” å¦‚æœè¶…è¿‡åŠæ•°èŠ‚ç‚¹åŠ é”æˆåŠŸï¼Œä¸”æ€»è€—æ—¶å°äºé”çš„è¿‡æœŸæ—¶é—´ï¼Œåˆ™è®¤ä¸ºåŠ é”æˆåŠŸ å¦‚æœåŠ é”å¤±è´¥ï¼Œå‘æ‰€æœ‰èŠ‚ç‚¹é‡Šæ”¾é” Redisson å®ç°\n1RLock lock1 = redissonClient1.getLock(\u0026#34;myLock\u0026#34;); 2RLock lock2 = redissonClient2.getLock(\u0026#34;myLock\u0026#34;); 3RLock lock3 = redissonClient3.getLock(\u0026#34;myLock\u0026#34;); 4 5RedissonRedLock redLock = new RedissonRedLock(lock1, lock2, lock3); 6redLock.lock(); 7try { 8 // ä¸šåŠ¡é€»è¾‘ 9} finally { 10 redLock.unlock(); 11} RedLock çš„äº‰è®®ï¼š\nMartin Kleppmann è®¤ä¸º RedLock ä¸å®‰å…¨ï¼ˆæ—¶é’Ÿæ¼‚ç§»é—®é¢˜ï¼‰ Redis ä½œè€… Antirez è®¤ä¸º RedLock åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹å¤Ÿç”¨ å®é™…ç”Ÿäº§ä¸­ï¼Œå•èŠ‚ç‚¹ + ä¸»ä»å¤åˆ¶ + å“¨å…µæ¨¡å¼å·²ç»è¶³å¤Ÿã€‚\næœ€ä½³å®è·µ 1. è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´\nè¿‡æœŸæ—¶é—´å¤ªçŸ­ï¼Œä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œé”å°±è¿‡æœŸäº†ï¼›è¿‡æœŸæ—¶é—´å¤ªé•¿ï¼Œå®•æœºåé”é•¿æ—¶é—´ä¸é‡Šæ”¾ã€‚\nå»ºè®®ï¼šæ ¹æ®ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è®¾ç½®ï¼Œæˆ–ä½¿ç”¨ Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶ã€‚\n2. ä½¿ç”¨ try-finally é‡Šæ”¾é”\n1lock.lock(); 2try { 3 // ä¸šåŠ¡é€»è¾‘ 4} finally { 5 lock.unlock(); 6} 3. é¿å…é•¿æ—¶é—´æŒæœ‰é”\né”çš„ç²’åº¦è¦å°½é‡å°ï¼Œåªé”å¿…è¦çš„ä»£ç å—ã€‚\n1// ä¸å¥½ï¼šé”çš„ç²’åº¦å¤ªå¤§ 2lock.lock(); 3try { 4 queryDatabase(); // è€—æ—¶æ“ä½œ 5 updateCache(); 6 sendMessage(); 7} finally { 8 lock.unlock(); 9} 10 11// å¥½ï¼šåªé”å¿…è¦çš„ä»£ç  12queryDatabase(); 13lock.lock(); 14try { 15 updateCache(); 16} finally { 17 lock.unlock(); 18} 19sendMessage(); 4. é”é™çº§\nå¦‚æœ Redis ä¸å¯ç”¨ï¼Œå¯ä»¥é™çº§ä¸ºæœ¬åœ°é”æˆ–ç›´æ¥æ”¾è¡Œã€‚\n1RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 2try { 3 boolean isLocked = lock.tryLock(1, 30, TimeUnit.SECONDS); 4 if (!isLocked) { 5 // é™çº§å¤„ç† 6 log.warn(\u0026#34;è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼Œé™çº§ä¸ºæœ¬åœ°é”\u0026#34;); 7 synchronized (this) { 8 // ä¸šåŠ¡é€»è¾‘ 9 } 10 } 11} catch (Exception e) { 12 log.error(\u0026#34;åˆ†å¸ƒå¼é”å¼‚å¸¸\u0026#34;, e); 13 // é™çº§å¤„ç† 14} æ€»ç»“ä¸æ€è€ƒ Redis åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ SET NX EX ä¿è¯åŠ é”çš„åŸå­æ€§ ä½¿ç”¨ Lua è„šæœ¬ä¿è¯è§£é”çš„åŸå­æ€§ ä½¿ç”¨å”¯ä¸€æ ‡è¯†é¿å…é”è¯¯åˆ  ä½¿ç”¨ Redisson ç®€åŒ–å®ç°ï¼Œåˆ©ç”¨çœ‹é—¨ç‹—æœºåˆ¶è‡ªåŠ¨ç»­æœŸ åˆ†å¸ƒå¼é”ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚åœ¨è®¾è®¡æ—¶è¦æƒè¡¡ï¼š\næ˜¯å¦çœŸçš„éœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿèƒ½å¦é€šè¿‡æ•°æ®åº“çš„ä¹è§‚é”è§£å†³ï¼Ÿ é”çš„ç²’åº¦æ˜¯å¦åˆç†ï¼Ÿèƒ½å¦é€šè¿‡åˆ†æ®µé”æå‡å¹¶å‘åº¦ï¼Ÿ æ˜¯å¦éœ€è¦é«˜å¯ç”¨ï¼Ÿå•èŠ‚ç‚¹æ˜¯å¦å¤Ÿç”¨ï¼Ÿ ä¸‹æ¬¡å½“ä½ éœ€è¦åˆ†å¸ƒå¼é”æ—¶ï¼Œä¸å¦¨å…ˆé—®é—®è‡ªå·±ï¼šè¿™ä¸ªåœºæ™¯çœŸçš„éœ€è¦å¼ºä¸€è‡´æ€§å—ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/08/redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E7%94%9F%E4%BA%A7%E7%BA%A7%E5%AE%9E%E8%B7%B5%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0-redisson/","summary":"\u003cp\u003eåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å®ä¾‹å¯èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œéœ€è¦åˆ†å¸ƒå¼é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚Redis æ˜¯å®ç°åˆ†å¸ƒå¼é”çš„å¸¸ç”¨æ–¹æ¡ˆï¼Œä½†å¾ˆå¤šäººåªä¼šç”¨ SETNXï¼Œä¸çŸ¥é“å…¶ä¸­çš„å‘ã€‚æœ¬æ–‡æ·±å…¥å‰–æ Redis åˆ†å¸ƒå¼é”çš„å®ç°ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Redis åˆ†å¸ƒå¼é”çš„å®ç°åŸç†ä¸å¸¸è§é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Redisson çœ‹é—¨ç‹—æœºåˆ¶çš„è®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„é”ä¼˜åŒ–æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†å¸ƒå¼é”çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”\"\u003eä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šåº“å­˜æ‰£å‡\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰åŠ é”\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003edeductStock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eStock\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estockMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eproductId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003estockMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eupdateById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–åº“å­˜ï¼Œå¯èƒ½å¯¼è‡´è¶…å–ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šå®šæ—¶ä»»åŠ¡å»é‡\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¤šä¸ªæœåŠ¡å®ä¾‹éƒ¨ç½²æ—¶ï¼Œå®šæ—¶ä»»åŠ¡ä¼šé‡å¤æ‰§è¡Œï¼Œéœ€è¦åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"åŸºç¡€å®ç°setnx--expire\"\u003eåŸºç¡€å®ç°ï¼šSETNX + EXPIRE\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eç‰ˆæœ¬ä¸€ï¼šæœ€ç®€å•çš„å®ç°\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003etryLock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003esetIfAbsent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eunlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edelete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼šå¦‚æœè·å–é”åï¼ŒæœåŠ¡å®•æœºï¼Œé”æ°¸è¿œä¸ä¼šé‡Šæ”¾ï¼Œå¯¼è‡´æ­»é”ã€‚\u003c/p\u003e","title":"Redis åˆ†å¸ƒå¼é”çš„ç”Ÿäº§çº§å®è·µï¼šä»åŸç†åˆ° Redisson"},{"content":"Spring Boot çš„æ ¸å¿ƒé­…åŠ›åœ¨äº\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;ï¼Œè€Œ Starter æœºåˆ¶æ˜¯å®ç°è¿™ä¸€ç†å¿µçš„å…³é”®ã€‚æœ¬æ–‡é€šè¿‡å®æˆ˜æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å¼€å‘ä¸€ä¸ªç”Ÿäº§çº§çš„è‡ªå®šä¹‰ Starterã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Spring Boot è‡ªåŠ¨è£…é…çš„åº•å±‚åŸç† æŒæ¡ BeanPostProcessor çš„ä½¿ç”¨åœºæ™¯ å­¦ä¼šè®¾è®¡é›¶ä¾µå…¥å¼çš„åŸºç¡€ç»„ä»¶ äº†è§£ Starter çš„æœ€ä½³å®è·µä¸è§„èŒƒ ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ Starterï¼Ÿ åœºæ™¯ï¼š å…¬å¸æœ‰å¤šä¸ª Spring Boot é¡¹ç›®ï¼Œéƒ½éœ€è¦é›†æˆçº¿ç¨‹æ± ç›‘æ§åŠŸèƒ½ã€‚\nä¼ ç»Ÿåšæ³•ï¼š æ¯ä¸ªé¡¹ç›®éƒ½å¤åˆ¶ä¸€éé…ç½®ä»£ç ã€‚\né—®é¢˜ï¼š\nä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜ é…ç½®ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“å‡ºé”™ å‡çº§å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æ‰€æœ‰é¡¹ç›® Starter çš„ä¼˜åŠ¿ï¼š\nä¸€æ¬¡å¼€å‘ï¼Œå¤šå¤„å¤ç”¨ é›¶ä¾µå…¥ï¼Œå¼•å…¥ä¾èµ–å³å¯ä½¿ç”¨ ç»Ÿä¸€ç®¡ç†ï¼Œå‡çº§æ–¹ä¾¿ æ¡ˆä¾‹ï¼šå¼€å‘çº¿ç¨‹æ± ç›‘æ§ Starter åŠŸèƒ½éœ€æ±‚ï¼š\nè‡ªåŠ¨æ‰«æé¡¹ç›®ä¸­çš„ ThreadPoolExecutor å®šæ—¶ä¸ŠæŠ¥çº¿ç¨‹æ± æŒ‡æ ‡ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰ æä¾›ç®¡ç†åå°æŸ¥çœ‹å’Œè°ƒæ•´çº¿ç¨‹æ± å‚æ•° ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Starter é¡¹ç›® é¡¹ç›®ç»“æ„\n1threadpool-spring-boot-starter 2â”œâ”€â”€ src/main/java 3â”‚ â””â”€â”€ com/example/threadpool 4â”‚ â”œâ”€â”€ autoconfigure 5â”‚ â”‚ â”œâ”€â”€ ThreadPoolAutoConfiguration.java 6â”‚ â”‚ â””â”€â”€ ThreadPoolProperties.java 7â”‚ â”œâ”€â”€ core 8â”‚ â”‚ â”œâ”€â”€ ThreadPoolMonitor.java 9â”‚ â”‚ â””â”€â”€ ThreadPoolRegistry.java 10â”‚ â””â”€â”€ processor 11â”‚ â””â”€â”€ ThreadPoolBeanPostProcessor.java 12â”œâ”€â”€ src/main/resources 13â”‚ â””â”€â”€ META-INF 14â”‚ â””â”€â”€ spring.factories 15â””â”€â”€ pom.xml pom.xml\n1\u0026lt;dependencies\u0026gt; 2 \u0026lt;!-- Spring Boot è‡ªåŠ¨é…ç½® --\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;spring-boot-autoconfigure\u0026lt;/artifactId\u0026gt; 6 \u0026lt;/dependency\u0026gt; 7 8 \u0026lt;!-- é…ç½®æç¤º --\u0026gt; 9 \u0026lt;dependency\u0026gt; 10 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 11 \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; 12 \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; 13 \u0026lt;/dependency\u0026gt; 14\u0026lt;/dependencies\u0026gt; ç¬¬äºŒæ­¥ï¼šå®šä¹‰é…ç½®å±æ€§ 1@ConfigurationProperties(prefix = \u0026#34;threadpool.monitor\u0026#34;) 2public class ThreadPoolProperties { 3 4 /** 5 * æ˜¯å¦å¯ç”¨çº¿ç¨‹æ± ç›‘æ§ 6 */ 7 private boolean enabled = true; 8 9 /** 10 * ä¸ŠæŠ¥é—´éš”ï¼ˆç§’ï¼‰ 11 */ 12 private int reportInterval = 60; 13 14 /** 15 * æ˜¯å¦å¯ç”¨åŠ¨æ€è°ƒæ•´ 16 */ 17 private boolean dynamicAdjust = false; 18 19 // getter/setter 20} é…ç½®æç¤º\nåˆ›å»º src/main/resources/META-INF/spring-configuration-metadata.jsonï¼š\n1{ 2 \u0026#34;properties\u0026#34;: [ 3 { 4 \u0026#34;name\u0026#34;: \u0026#34;threadpool.monitor.enabled\u0026#34;, 5 \u0026#34;type\u0026#34;: \u0026#34;java.lang.Boolean\u0026#34;, 6 \u0026#34;description\u0026#34;: \u0026#34;æ˜¯å¦å¯ç”¨çº¿ç¨‹æ± ç›‘æ§\u0026#34;, 7 \u0026#34;defaultValue\u0026#34;: true 8 }, 9 { 10 \u0026#34;name\u0026#34;: \u0026#34;threadpool.monitor.report-interval\u0026#34;, 11 \u0026#34;type\u0026#34;: \u0026#34;java.lang.Integer\u0026#34;, 12 \u0026#34;description\u0026#34;: \u0026#34;ä¸ŠæŠ¥é—´éš”ï¼ˆç§’ï¼‰\u0026#34;, 13 \u0026#34;defaultValue\u0026#34;: 60 14 } 15 ] 16} è¿™æ ·åœ¨ application.yml ä¸­é…ç½®æ—¶ï¼ŒIDE ä¼šæœ‰æ™ºèƒ½æç¤ºã€‚\nç¬¬ä¸‰æ­¥ï¼šå®ç° BeanPostProcessor æ ¸å¿ƒæ€æƒ³ï¼š åœ¨ Bean åˆå§‹åŒ–åï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ ThreadPoolExecutorï¼Œå¦‚æœæ˜¯ï¼Œæ³¨å†Œåˆ°ç›‘æ§ä¸­å¿ƒã€‚\n1@Component 2public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Override 8 public Object postProcessAfterInitialization(Object bean, String beanName) { 9 if (bean instanceof ThreadPoolExecutor) { 10 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 11 registry.register(beanName, executor); 12 log.info(\u0026#34;æ³¨å†Œçº¿ç¨‹æ± : {}\u0026#34;, beanName); 13 } 14 return bean; 15 } 16} ThreadPoolRegistry\n1@Component 2public class ThreadPoolRegistry { 3 4 private final Map\u0026lt;String, ThreadPoolExecutor\u0026gt; executors = new ConcurrentHashMap\u0026lt;\u0026gt;(); 5 6 public void register(String name, ThreadPoolExecutor executor) { 7 executors.put(name, executor); 8 } 9 10 public Map\u0026lt;String, ThreadPoolExecutor\u0026gt; getAll() { 11 return Collections.unmodifiableMap(executors); 12 } 13 14 public ThreadPoolExecutor get(String name) { 15 return executors.get(name); 16 } 17} ç¬¬å››æ­¥ï¼šå®ç°ç›‘æ§é€»è¾‘ 1@Component 2public class ThreadPoolMonitor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Autowired 8 private ThreadPoolProperties properties; 9 10 @Scheduled(fixedDelayString = \u0026#34;${threadpool.monitor.report-interval:60}000\u0026#34;) 11 public void report() { 12 if (!properties.isEnabled()) { 13 return; 14 } 15 16 registry.getAll().forEach((name, executor) -\u0026gt; { 17 ThreadPoolMetrics metrics = collectMetrics(name, executor); 18 log.info(\u0026#34;çº¿ç¨‹æ± æŒ‡æ ‡: {}\u0026#34;, metrics); 19 20 // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€InfluxDB ç­‰ï¼‰ 21 reportToMonitor(metrics); 22 }); 23 } 24 25 private ThreadPoolMetrics collectMetrics(String name, ThreadPoolExecutor executor) { 26 return ThreadPoolMetrics.builder() 27 .name(name) 28 .corePoolSize(executor.getCorePoolSize()) 29 .maximumPoolSize(executor.getMaximumPoolSize()) 30 .activeCount(executor.getActiveCount()) 31 .poolSize(executor.getPoolSize()) 32 .queueSize(executor.getQueue().size()) 33 .queueRemainingCapacity(executor.getQueue().remainingCapacity()) 34 .completedTaskCount(executor.getCompletedTaskCount()) 35 .taskCount(executor.getTaskCount()) 36 .build(); 37 } 38 39 private void reportToMonitor(ThreadPoolMetrics metrics) { 40 // å®ç°ä¸ŠæŠ¥é€»è¾‘ 41 } 42} ç¬¬äº”æ­¥ï¼šè‡ªåŠ¨é…ç½®ç±» 1@Configuration 2@EnableConfigurationProperties(ThreadPoolProperties.class) 3@ConditionalOnProperty(prefix = \u0026#34;threadpool.monitor\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;, matchIfMissing = true) 4@EnableScheduling 5public class ThreadPoolAutoConfiguration { 6 7 @Bean 8 public ThreadPoolRegistry threadPoolRegistry() { 9 return new ThreadPoolRegistry(); 10 } 11 12 @Bean 13 public ThreadPoolBeanPostProcessor threadPoolBeanPostProcessor() { 14 return new ThreadPoolBeanPostProcessor(); 15 } 16 17 @Bean 18 public ThreadPoolMonitor threadPoolMonitor() { 19 return new ThreadPoolMonitor(); 20 } 21} æ³¨è§£è¯´æ˜ï¼š\n@EnableConfigurationPropertiesï¼šå¯ç”¨é…ç½®å±æ€§ @ConditionalOnPropertyï¼šæ¡ä»¶è£…é…ï¼Œåªæœ‰é…ç½®å¯ç”¨æ—¶æ‰ç”Ÿæ•ˆ @EnableSchedulingï¼šå¯ç”¨å®šæ—¶ä»»åŠ¡ ç¬¬å…­æ­¥ï¼šæ³¨å†Œè‡ªåŠ¨é…ç½® åˆ›å»º src/main/resources/META-INF/spring.factoriesï¼š\n1org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 2com.example.threadpool.autoconfigure.ThreadPoolAutoConfiguration Spring Boot å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½è¿™ä¸ªé…ç½®ç±»ã€‚\nç¬¬ä¸ƒæ­¥ï¼šä½¿ç”¨ Starter 1. å¼•å…¥ä¾èµ–\n1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;threadpool-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; 2. é…ç½®ï¼ˆå¯é€‰ï¼‰\n1threadpool: 2 monitor: 3 enabled: true 4 report-interval: 30 3. å®šä¹‰çº¿ç¨‹æ± \n1@Configuration 2public class ThreadPoolConfig { 3 4 @Bean(\u0026#34;orderThreadPool\u0026#34;) 5 public ThreadPoolExecutor orderThreadPool() { 6 return new ThreadPoolExecutor( 7 10, 20, 60, TimeUnit.SECONDS, 8 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 9 new ThreadFactoryBuilder().setNameFormat(\u0026#34;order-pool-%d\u0026#34;).build(), 10 new ThreadPoolExecutor.CallerRunsPolicy() 11 ); 12 } 13} 4. è‡ªåŠ¨ç›‘æ§\næ— éœ€ä»»ä½•é¢å¤–ä»£ç ï¼ŒStarter ä¼šè‡ªåŠ¨æ‰«æå¹¶ç›‘æ§æ‰€æœ‰ ThreadPoolExecutorã€‚\nè¿›é˜¶ï¼šåŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° æä¾› REST API\n1@RestController 2@RequestMapping(\u0026#34;/threadpool\u0026#34;) 3public class ThreadPoolController { 4 5 @Autowired 6 private ThreadPoolRegistry registry; 7 8 @GetMapping(\u0026#34;/list\u0026#34;) 9 public List\u0026lt;ThreadPoolInfo\u0026gt; list() { 10 return registry.getAll().entrySet().stream() 11 .map(entry -\u0026gt; ThreadPoolInfo.from(entry.getKey(), entry.getValue())) 12 .collect(Collectors.toList()); 13 } 14 15 @PostMapping(\u0026#34;/adjust\u0026#34;) 16 public void adjust(@RequestBody ThreadPoolAdjustRequest request) { 17 ThreadPoolExecutor executor = registry.get(request.getName()); 18 if (executor == null) { 19 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + request.getName()); 20 } 21 22 executor.setCorePoolSize(request.getCorePoolSize()); 23 executor.setMaximumPoolSize(request.getMaximumPoolSize()); 24 25 log.info(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°: {}\u0026#34;, request); 26 } 27} è‡ªåŠ¨è£…é…åŸç† @SpringBootApplication æ³¨è§£\n1@SpringBootConfiguration 2@EnableAutoConfiguration // å…³é”®æ³¨è§£ 3@ComponentScan 4public @interface SpringBootApplication { 5} @EnableAutoConfiguration æ³¨è§£\n1@Import(AutoConfigurationImportSelector.class) 2public @interface EnableAutoConfiguration { 3} AutoConfigurationImportSelector\n1public class AutoConfigurationImportSelector { 2 3 protected List\u0026lt;String\u0026gt; getCandidateConfigurations() { 4 // è¯»å– META-INF/spring.factories 5 return SpringFactoriesLoader.loadFactoryNames( 6 EnableAutoConfiguration.class, 7 getBeanClassLoader() 8 ); 9 } 10} æµç¨‹ï¼š\nSpring Boot å¯åŠ¨æ—¶ï¼Œæ‰«ææ‰€æœ‰ jar åŒ…çš„ META-INF/spring.factories åŠ è½½ EnableAutoConfiguration å¯¹åº”çš„é…ç½®ç±» æ ¹æ® @Conditional æ³¨è§£åˆ¤æ–­æ˜¯å¦ç”Ÿæ•ˆ æ³¨å†Œ Bean åˆ° Spring å®¹å™¨ æ¶æ„æ€è€ƒï¼š Spring Boot çš„è‡ªåŠ¨è£…é…ä½“ç°äº†\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;çš„æ€æƒ³ã€‚é€šè¿‡ SPI æœºåˆ¶ï¼ˆspring.factoriesï¼‰å’Œæ¡ä»¶è£…é…ï¼ˆ@Conditionalï¼‰ï¼Œå®ç°äº†çµæ´»çš„æ¨¡å—åŒ–è®¾è®¡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šæ¡†æ¶ä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ Dubbo çš„ SPIã€Java çš„ ServiceLoaderã€‚\nStarter å¼€å‘è§„èŒƒ 1. å‘½åè§„èŒƒ\nå®˜æ–¹ Starterï¼šspring-boot-starter-{name} ç¬¬ä¸‰æ–¹ Starterï¼š{name}-spring-boot-starter 2. æ¨¡å—æ‹†åˆ†\n1{name}-spring-boot-starter # ä¾èµ–ç®¡ç†ï¼Œä¸åŒ…å«ä»£ç  2â””â”€â”€ {name}-spring-boot-autoconfigure # è‡ªåŠ¨é…ç½®ä»£ç  3. é…ç½®å‰ç¼€\nä½¿ç”¨ç»Ÿä¸€çš„é…ç½®å‰ç¼€ï¼Œé¿å…å†²çªã€‚\n1mycompany: 2 threadpool: 3 enabled: true 4. æ¡ä»¶è£…é…\nä½¿ç”¨ @ConditionalOnClassã€@ConditionalOnProperty ç­‰æ³¨è§£ï¼Œé¿å…å¼ºä¾èµ–ã€‚\n1@ConditionalOnClass(RedisTemplate.class) 2@ConditionalOnProperty(prefix = \u0026#34;redis.cache\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) 5. æä¾›é»˜è®¤é…ç½®\n1@ConfigurationProperties(prefix = \u0026#34;threadpool.monitor\u0026#34;) 2public class ThreadPoolProperties { 3 private boolean enabled = true; // é»˜è®¤å¯ç”¨ 4 private int reportInterval = 60; // é»˜è®¤ 60 ç§’ 5} 6. æ–‡æ¡£å®Œå–„\næä¾› README.mdï¼Œè¯´æ˜ï¼š\nåŠŸèƒ½ä»‹ç» å¿«é€Ÿå¼€å§‹ é…ç½®è¯´æ˜ ç¤ºä¾‹ä»£ç  æ€»ç»“ä¸æ€è€ƒ è‡ªå®šä¹‰ Starter çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼æ‰«æ é€šè¿‡ @ConfigurationProperties æä¾›çµæ´»çš„é…ç½® ä½¿ç”¨ @Conditional æ³¨è§£å®ç°æ¡ä»¶è£…é… åœ¨ spring.factories ä¸­æ³¨å†Œè‡ªåŠ¨é…ç½®ç±» Starter ä¸ä»…ä»…æ˜¯ä»£ç å¤ç”¨ï¼Œæ›´æ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ã€‚å®ƒè®©æˆ‘ä»¬é‡æ–°æ€è€ƒå¦‚ä½•è®¾è®¡å¯å¤ç”¨çš„åŸºç¡€ç»„ä»¶ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åœ¨å¤šä¸ªé¡¹ç›®ä¸­å¤ç”¨åŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯•å¼€å‘ä¸€ä¸ª Starterï¼Œä½“éªŒ\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/08/spring-boot-starter-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%80%E5%8F%91%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eSpring Boot çš„æ ¸å¿ƒé­…åŠ›åœ¨äº\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;ï¼Œè€Œ Starter æœºåˆ¶æ˜¯å®ç°è¿™ä¸€ç†å¿µçš„å…³é”®ã€‚æœ¬æ–‡é€šè¿‡å®æˆ˜æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å¼€å‘ä¸€ä¸ªç”Ÿäº§çº§çš„è‡ªå®šä¹‰ Starterã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Spring Boot è‡ªåŠ¨è£…é…çš„åº•å±‚åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ BeanPostProcessor çš„ä½¿ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡é›¶ä¾µå…¥å¼çš„åŸºç¡€ç»„ä»¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ Starter çš„æœ€ä½³å®è·µä¸è§„èŒƒ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰-starter\"\u003eä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ Starterï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼š\u003c/strong\u003e å…¬å¸æœ‰å¤šä¸ª Spring Boot é¡¹ç›®ï¼Œéƒ½éœ€è¦é›†æˆçº¿ç¨‹æ± ç›‘æ§åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿåšæ³•ï¼š\u003c/strong\u003e æ¯ä¸ªé¡¹ç›®éƒ½å¤åˆ¶ä¸€éé…ç½®ä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé—®é¢˜ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜\u003c/li\u003e\n\u003cli\u003eé…ç½®ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“å‡ºé”™\u003c/li\u003e\n\u003cli\u003eå‡çº§å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æ‰€æœ‰é¡¹ç›®\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eStarter çš„ä¼˜åŠ¿ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eä¸€æ¬¡å¼€å‘ï¼Œå¤šå¤„å¤ç”¨\u003c/li\u003e\n\u003cli\u003eé›¶ä¾µå…¥ï¼Œå¼•å…¥ä¾èµ–å³å¯ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eç»Ÿä¸€ç®¡ç†ï¼Œå‡çº§æ–¹ä¾¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¡ˆä¾‹å¼€å‘çº¿ç¨‹æ± ç›‘æ§-starter\"\u003eæ¡ˆä¾‹ï¼šå¼€å‘çº¿ç¨‹æ± ç›‘æ§ Starter\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåŠŸèƒ½éœ€æ±‚ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eè‡ªåŠ¨æ‰«æé¡¹ç›®ä¸­çš„ ThreadPoolExecutor\u003c/li\u003e\n\u003cli\u003eå®šæ—¶ä¸ŠæŠ¥çº¿ç¨‹æ± æŒ‡æ ‡ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰\u003c/li\u003e\n\u003cli\u003eæä¾›ç®¡ç†åå°æŸ¥çœ‹å’Œè°ƒæ•´çº¿ç¨‹æ± å‚æ•°\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥åˆ›å»º-starter-é¡¹ç›®\"\u003eç¬¬ä¸€æ­¥ï¼šåˆ›å»º Starter é¡¹ç›®\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eé¡¹ç›®ç»“æ„\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003ethreadpool-spring-boot-starter\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ src/main/java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ com/example/threadpool\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”œâ”€â”€ autoconfigure\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â”œâ”€â”€ ThreadPoolAutoConfiguration.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â””â”€â”€ ThreadPoolProperties.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”œâ”€â”€ core\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â”œâ”€â”€ ThreadPoolMonitor.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â””â”€â”€ ThreadPoolRegistry.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â””â”€â”€ processor\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚           â””â”€â”€ ThreadPoolBeanPostProcessor.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ src/main/resources\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ META-INF\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â””â”€â”€ spring.factories\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ pom.xml\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003epom.xml\u003c/strong\u003e\u003c/p\u003e","title":"Spring Boot Starter è‡ªå®šä¹‰å¼€å‘ï¼šä»åŸç†åˆ°å®æˆ˜"},{"content":"åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”Ÿæˆå…¨å±€å”¯ä¸€ ID æ˜¯ä¸€ä¸ªåŸºç¡€éœ€æ±‚ã€‚æ•°æ®åº“è‡ªå¢ ID åœ¨åˆ†åº“åˆ†è¡¨åæ— æ³•ä½¿ç”¨ï¼ŒUUID è™½ç„¶ç®€å•ä½†ä¸é€‚åˆä½œä¸ºä¸»é”®ã€‚æœ¬æ–‡å¯¹æ¯”ä¸»æµçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚ æŒæ¡é›ªèŠ±ç®—æ³•çš„å®ç°ä¸æ—¶é’Ÿå›æ‹¨é—®é¢˜ äº†è§£ç¾å›¢ Leaf æ–¹æ¡ˆçš„è®¾è®¡æ€æƒ³ å­¦ä¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚ å…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½é‡å¤ è¶‹åŠ¿é€’å¢ï¼šæ–¹ä¾¿æ’åºå’Œç´¢å¼• é«˜æ€§èƒ½ï¼šç”Ÿæˆé€Ÿåº¦å¿« é«˜å¯ç”¨ï¼šæœåŠ¡ä¸èƒ½æŒ‚ ä¿¡æ¯å®‰å…¨ï¼šä¸èƒ½æ³„éœ²ä¸šåŠ¡ä¿¡æ¯ æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“è‡ªå¢ ID 1CREATE TABLE id_generator ( 2 id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY, 3 stub CHAR(1) NOT NULL DEFAULT \u0026#39;\u0026#39;, 4 UNIQUE KEY stub (stub) 5); 6 7INSERT INTO id_generator (stub) VALUES (\u0026#39;a\u0026#39;); 8SELECT LAST_INSERT_ID(); ä¼˜ç‚¹ï¼šç®€å•ï¼Œè¶‹åŠ¿é€’å¢\nç¼ºç‚¹ï¼š\næ€§èƒ½ç“¶é¢ˆï¼šæ•°æ®åº“å‹åŠ›å¤§ å•ç‚¹æ•…éšœï¼šæ•°æ®åº“æŒ‚äº†å°±æ— æ³•ç”Ÿæˆ ID æ‰©å±•æ€§å·®ï¼šåˆ†åº“åˆ†è¡¨åéœ€è¦è®¾ç½®ä¸åŒçš„æ­¥é•¿ æ–¹æ¡ˆäºŒï¼šUUID 1String id = UUID.randomUUID().toString(); ä¼˜ç‚¹ï¼šç®€å•ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ€§èƒ½é«˜\nç¼ºç‚¹ï¼š\næ— åºï¼šä¸åˆ©äºæ•°æ®åº“ç´¢å¼• é•¿åº¦é•¿ï¼š36 ä¸ªå­—ç¬¦ï¼Œå ç”¨ç©ºé—´å¤§ ä¸é€‚åˆä½œä¸ºä¸»é”®ï¼šB+ æ ‘ç´¢å¼•æ€§èƒ½å·® æ–¹æ¡ˆä¸‰ï¼šé›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰ Twitter å¼€æºçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆç®—æ³•ï¼Œç”Ÿæˆ 64 ä½ long å‹ IDã€‚\nID ç»“æ„\n10 - 41ä½æ—¶é—´æˆ³ - 10ä½æœºå™¨ID - 12ä½åºåˆ—å· 1 ä½ï¼šç¬¦å·ä½ï¼Œå›ºå®šä¸º 0 41 ä½ï¼šæ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼Œå¯ç”¨ 69 å¹´ 10 ä½ï¼šæœºå™¨ IDï¼ˆ5 ä½æ•°æ®ä¸­å¿ƒ ID + 5 ä½æœºå™¨ IDï¼‰ï¼Œæ”¯æŒ 1024 å°æœºå™¨ 12 ä½ï¼šåºåˆ—å·ï¼ŒåŒä¸€æ¯«ç§’å†…å¯ç”Ÿæˆ 4096 ä¸ª ID å®ç°ä»£ç \n1public class SnowflakeIdGenerator { 2 3 private final long twepoch = 1288834974657L; // èµ·å§‹æ—¶é—´æˆ³ 4 private final long workerIdBits = 5L; 5 private final long datacenterIdBits = 5L; 6 private final long sequenceBits = 12L; 7 8 private final long workerIdShift = sequenceBits; 9 private final long datacenterIdShift = sequenceBits + workerIdBits; 10 private final long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits; 11 private final long sequenceMask = -1L ^ (-1L \u0026lt;\u0026lt; sequenceBits); 12 13 private long workerId; 14 private long datacenterId; 15 private long sequence = 0L; 16 private long lastTimestamp = -1L; 17 18 public synchronized long nextId() { 19 long timestamp = System.currentTimeMillis(); 20 21 // æ—¶é’Ÿå›æ‹¨æ£€æµ‹ 22 if (timestamp \u0026lt; lastTimestamp) { 23 throw new RuntimeException(\u0026#34;Clock moved backwards\u0026#34;); 24 } 25 26 // åŒä¸€æ¯«ç§’å†…ï¼Œåºåˆ—å·è‡ªå¢ 27 if (lastTimestamp == timestamp) { 28 sequence = (sequence + 1) \u0026amp; sequenceMask; 29 if (sequence == 0) { 30 // åºåˆ—å·ç”¨å®Œï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’ 31 timestamp = tilNextMillis(lastTimestamp); 32 } 33 } else { 34 sequence = 0L; 35 } 36 37 lastTimestamp = timestamp; 38 39 // ç»„è£… ID 40 return ((timestamp - twepoch) \u0026lt;\u0026lt; timestampLeftShift) 41 | (datacenterId \u0026lt;\u0026lt; datacenterIdShift) 42 | (workerId \u0026lt;\u0026lt; workerIdShift) 43 | sequence; 44 } 45 46 private long tilNextMillis(long lastTimestamp) { 47 long timestamp = System.currentTimeMillis(); 48 while (timestamp \u0026lt;= lastTimestamp) { 49 timestamp = System.currentTimeMillis(); 50 } 51 return timestamp; 52 } 53} æ—¶é’Ÿå›æ‹¨é—®é¢˜\nå¦‚æœç³»ç»Ÿæ—¶é—´è¢«å›æ‹¨ï¼Œä¼šå¯¼è‡´ ID é‡å¤ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\næ‹’ç»ç”Ÿæˆ IDï¼ŒæŠ›å‡ºå¼‚å¸¸ ç­‰å¾…æ—¶é’Ÿè¿½ä¸Š ä½¿ç”¨æ‰©å±•ä½è®°å½•æ—¶é’Ÿå›æ‹¨æ¬¡æ•° æ–¹æ¡ˆå››ï¼šç¾å›¢ Leaf ç¾å›¢å¼€æºçš„åˆ†å¸ƒå¼ ID ç”ŸæˆæœåŠ¡ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š\nLeaf-segmentï¼šå·æ®µæ¨¡å¼\nä»æ•°æ®åº“æ‰¹é‡è·å– ID å·æ®µï¼Œç¼“å­˜åœ¨å†…å­˜ä¸­åˆ†é…ã€‚\n1CREATE TABLE leaf_alloc ( 2 biz_tag VARCHAR(128) NOT NULL, 3 max_id BIGINT NOT NULL, 4 step INT NOT NULL, 5 PRIMARY KEY (biz_tag) 6); æµç¨‹ï¼š\næœåŠ¡å¯åŠ¨æ—¶ï¼Œä»æ•°æ®åº“è·å–å·æ®µï¼ˆå¦‚ 1-1000ï¼‰ åœ¨å†…å­˜ä¸­åˆ†é… ID å·æ®µç”¨å®Œåï¼Œå†æ¬¡ä»æ•°æ®åº“è·å–ä¸‹ä¸€ä¸ªå·æ®µ ä¼˜ç‚¹ï¼š\nå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•° æ”¯æŒåŠ¨æ€è°ƒæ•´æ­¥é•¿ Leaf-snowflakeï¼šé›ªèŠ±æ¨¡å¼\nåŸºäº Zookeeper ç”Ÿæˆæœºå™¨ IDï¼Œè§£å†³äº†é›ªèŠ±ç®—æ³•çš„æœºå™¨ ID åˆ†é…é—®é¢˜ã€‚\næ–¹æ¡ˆå¯¹æ¯” æ–¹æ¡ˆ æ€§èƒ½ å¯ç”¨æ€§ è¶‹åŠ¿é€’å¢ å¤æ‚åº¦ æ•°æ®åº“è‡ªå¢ ä½ ä½ æ˜¯ ä½ UUID é«˜ é«˜ å¦ ä½ é›ªèŠ±ç®—æ³• é«˜ é«˜ æ˜¯ ä¸­ Leaf-segment ä¸­ ä¸­ æ˜¯ ä¸­ Leaf-snowflake é«˜ é«˜ æ˜¯ é«˜ é€‰å‹å»ºè®® å°å‹é¡¹ç›®ï¼šæ•°æ®åº“è‡ªå¢ ID å¯¹é¡ºåºæ— è¦æ±‚ï¼šUUID é«˜æ€§èƒ½è¦æ±‚ï¼šé›ªèŠ±ç®—æ³• éœ€è¦é›†ä¸­ç®¡ç†ï¼šLeaf æ€»ç»“ä¸æ€è€ƒ åˆ†å¸ƒå¼ ID ç”Ÿæˆæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€é—®é¢˜ï¼Œä¸åŒæ–¹æ¡ˆé€‚ç”¨äºä¸åŒåœºæ™¯ã€‚\né›ªèŠ±ç®—æ³•æ€§èƒ½é«˜ï¼Œä½†éœ€è¦è§£å†³æ—¶é’Ÿå›æ‹¨å’Œæœºå™¨ ID åˆ†é…é—®é¢˜ Leaf æä¾›äº†æ›´å®Œå–„çš„è§£å†³æ–¹æ¡ˆï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ ä¸‹æ¬¡å½“ä½ éœ€è¦ç”Ÿæˆåˆ†å¸ƒå¼ ID æ—¶ï¼Œæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\n","permalink":"http://localhost:1313/posts/2024/07/%E5%88%86%E5%B8%83%E5%BC%8F-id-%E7%94%9F%E6%88%90%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94%E4%B8%8E%E9%80%89%E5%9E%8B%E6%8C%87%E5%8D%97/","summary":"\u003cp\u003eåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”Ÿæˆå…¨å±€å”¯ä¸€ ID æ˜¯ä¸€ä¸ªåŸºç¡€éœ€æ±‚ã€‚æ•°æ®åº“è‡ªå¢ ID åœ¨åˆ†åº“åˆ†è¡¨åæ— æ³•ä½¿ç”¨ï¼ŒUUID è™½ç„¶ç®€å•ä½†ä¸é€‚åˆä½œä¸ºä¸»é”®ã€‚æœ¬æ–‡å¯¹æ¯”ä¸»æµçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é›ªèŠ±ç®—æ³•çš„å®ç°ä¸æ—¶é’Ÿå›æ‹¨é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç¾å›¢ Leaf æ–¹æ¡ˆçš„è®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†å¸ƒå¼-id-çš„æ ¸å¿ƒè¦æ±‚\"\u003eåˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eå…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½é‡å¤\u003c/li\u003e\n\u003cli\u003eè¶‹åŠ¿é€’å¢ï¼šæ–¹ä¾¿æ’åºå’Œç´¢å¼•\u003c/li\u003e\n\u003cli\u003eé«˜æ€§èƒ½ï¼šç”Ÿæˆé€Ÿåº¦å¿«\u003c/li\u003e\n\u003cli\u003eé«˜å¯ç”¨ï¼šæœåŠ¡ä¸èƒ½æŒ‚\u003c/li\u003e\n\u003cli\u003eä¿¡æ¯å®‰å…¨ï¼šä¸èƒ½æ³„éœ²ä¸šåŠ¡ä¿¡æ¯\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ–¹æ¡ˆä¸€æ•°æ®åº“è‡ªå¢-id\"\u003eæ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“è‡ªå¢ ID\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCREATE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid_generator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003eBIGINT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTO_INCREMENT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ePRIMARY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003eCHAR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eDEFAULT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eUNIQUE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eINSERT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eINTO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid_generator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;a\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLAST_INSERT_ID\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¼˜ç‚¹ï¼šç®€å•ï¼Œè¶‹åŠ¿é€’å¢\u003c/p\u003e\n\u003cp\u003eç¼ºç‚¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ€§èƒ½ç“¶é¢ˆï¼šæ•°æ®åº“å‹åŠ›å¤§\u003c/li\u003e\n\u003cli\u003eå•ç‚¹æ•…éšœï¼šæ•°æ®åº“æŒ‚äº†å°±æ— æ³•ç”Ÿæˆ ID\u003c/li\u003e\n\u003cli\u003eæ‰©å±•æ€§å·®ï¼šåˆ†åº“åˆ†è¡¨åéœ€è¦è®¾ç½®ä¸åŒçš„æ­¥é•¿\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ–¹æ¡ˆäºŒuuid\"\u003eæ–¹æ¡ˆäºŒï¼šUUID\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUUID\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erandomUUID\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003etoString\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¼˜ç‚¹ï¼šç®€å•ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ€§èƒ½é«˜\u003c/p\u003e","title":"åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹æŒ‡å—"},{"content":"ç†è§£ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯æŒæ¡ Spring æ¡†æ¶çš„å…³é”®ã€‚æœ¬æ–‡ä»æºç å±‚é¢å‰–æ Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ Spring çš„æ ¸å¿ƒæœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ Bean ç”Ÿå‘½å‘¨æœŸçš„å®Œæ•´æµç¨‹ ç†è§£ BeanPostProcessor çš„æ‰§è¡Œæ—¶æœº å­¦ä¼šè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ äº†è§£ InitializingBean vs @PostConstruct çš„åŒºåˆ« Bean ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ 1å®ä¾‹åŒ– â†’ å±æ€§å¡«å…… â†’ åˆå§‹åŒ–å‰ â†’ åˆå§‹åŒ– â†’ åˆå§‹åŒ–å â†’ ä½¿ç”¨ â†’ é”€æ¯ è¯¦ç»†æµç¨‹ï¼š\nå®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ï¼šé€šè¿‡åå°„åˆ›å»º Bean å®ä¾‹ å±æ€§å¡«å……ï¼ˆPopulateï¼‰ï¼šæ³¨å…¥ä¾èµ–çš„ Bean Aware æ¥å£å›è°ƒï¼šBeanNameAwareã€BeanFactoryAware ç­‰ BeanPostProcessor.postProcessBeforeInitialization InitializingBean.afterPropertiesSet è‡ªå®šä¹‰ init-method BeanPostProcessor.postProcessAfterInitialization Bean å¯ä»¥ä½¿ç”¨ DisposableBean.destroy è‡ªå®šä¹‰ destroy-method å®ä¾‹åŒ–ï¼šåå°„åˆ›å»ºå¯¹è±¡ 1protected Object doCreateBean(String beanName, RootBeanDefinition mbd, Object[] args) { 2 // 1. å®ä¾‹åŒ– Bean 3 BeanWrapper instanceWrapper = createBeanInstance(beanName, mbd, args); 4 Object bean = instanceWrapper.getWrappedInstance(); 5 6 // 2. å±æ€§å¡«å…… 7 populateBean(beanName, mbd, instanceWrapper); 8 9 // 3. åˆå§‹åŒ– 10 Object exposedObject = initializeBean(beanName, bean, mbd); 11 12 return exposedObject; 13} å±æ€§å¡«å……ï¼šä¾èµ–æ³¨å…¥ 1protected void populateBean(String beanName, RootBeanDefinition mbd, BeanWrapper bw) { 2 // è·å–å±æ€§å€¼ 3 PropertyValues pvs = mbd.getPropertyValues(); 4 5 // è‡ªåŠ¨è£…é…ï¼ˆbyNameã€byTypeï¼‰ 6 if (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_NAME) { 7 autowireByName(beanName, mbd, bw, newPvs); 8 } 9 if (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_TYPE) { 10 autowireByType(beanName, mbd, bw, newPvs); 11 } 12 13 // åº”ç”¨å±æ€§å€¼ 14 applyPropertyValues(beanName, mbd, bw, pvs); 15} åˆå§‹åŒ–ï¼šå›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘ 1protected Object initializeBean(String beanName, Object bean, RootBeanDefinition mbd) { 2 // 1. Aware æ¥å£å›è°ƒ 3 invokeAwareMethods(beanName, bean); 4 5 // 2. BeanPostProcessor å‰ç½®å¤„ç† 6 Object wrappedBean = applyBeanPostProcessorsBeforeInitialization(bean, beanName); 7 8 // 3. åˆå§‹åŒ–æ–¹æ³• 9 invokeInitMethods(beanName, wrappedBean, mbd); 10 11 // 4. BeanPostProcessor åç½®å¤„ç† 12 wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); 13 14 return wrappedBean; 15} BeanPostProcessorï¼šæ‰©å±•ç‚¹ 1public interface BeanPostProcessor { 2 3 // åˆå§‹åŒ–å‰å›è°ƒ 4 default Object postProcessBeforeInitialization(Object bean, String beanName) { 5 return bean; 6 } 7 8 // åˆå§‹åŒ–åå›è°ƒ 9 default Object postProcessAfterInitialization(Object bean, String beanName) { 10 return bean; 11 } 12} åº”ç”¨åœºæ™¯ï¼š\n@Autowired æ³¨è§£çš„å¤„ç†ï¼ˆAutowiredAnnotationBeanPostProcessorï¼‰ AOP ä»£ç†çš„åˆ›å»ºï¼ˆAbstractAutoProxyCreatorï¼‰ @PostConstruct æ³¨è§£çš„å¤„ç†ï¼ˆCommonAnnotationBeanPostProcessorï¼‰ å¾ªç¯ä¾èµ–ï¼šä¸‰çº§ç¼“å­˜ 1@Service 2public class A { 3 @Autowired 4 private B b; 5} 6 7@Service 8public class B { 9 @Autowired 10 private A a; 11} Spring é€šè¿‡ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼š\n1// ä¸€çº§ç¼“å­˜ï¼šå®Œæ•´çš„ Bean 2private final Map\u0026lt;String, Object\u0026gt; singletonObjects = new ConcurrentHashMap\u0026lt;\u0026gt;(); 3 4// äºŒçº§ç¼“å­˜ï¼šæ—©æœŸçš„ Beanï¼ˆå·²å®ä¾‹åŒ–ï¼Œæœªåˆå§‹åŒ–ï¼‰ 5private final Map\u0026lt;String, Object\u0026gt; earlySingletonObjects = new HashMap\u0026lt;\u0026gt;(); 6 7// ä¸‰çº§ç¼“å­˜ï¼šBean å·¥å‚ 8private final Map\u0026lt;String, ObjectFactory\u0026lt;?\u0026gt;\u0026gt; singletonFactories = new HashMap\u0026lt;\u0026gt;(); è§£å†³æµç¨‹ï¼š\nåˆ›å»º Aï¼Œå®ä¾‹åŒ–åæ”¾å…¥ä¸‰çº§ç¼“å­˜ å¡«å…… A çš„å±æ€§ï¼Œå‘ç°ä¾èµ– B åˆ›å»º Bï¼Œå®ä¾‹åŒ–åæ”¾å…¥ä¸‰çº§ç¼“å­˜ å¡«å…… B çš„å±æ€§ï¼Œå‘ç°ä¾èµ– A ä»ä¸‰çº§ç¼“å­˜è·å– A çš„æ—©æœŸå¼•ç”¨ï¼Œæ³¨å…¥åˆ° B B åˆå§‹åŒ–å®Œæˆï¼Œæ³¨å…¥åˆ° A A åˆå§‹åŒ–å®Œæˆ é¿å‘æç¤ºï¼š æ„é€ å™¨æ³¨å…¥æ— æ³•è§£å†³å¾ªç¯ä¾èµ–ï¼Œå› ä¸ºå®ä¾‹åŒ–æ—¶å°±éœ€è¦ä¾èµ–å¯¹è±¡ã€‚åªæœ‰ setter æ³¨å…¥å’Œå­—æ®µæ³¨å…¥å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–ã€‚\nInitializingBean vs @PostConstruct ä¸‰ç§åˆå§‹åŒ–æ–¹å¼çš„æ‰§è¡Œé¡ºåºï¼š\n1@Component 2public class MyBean implements InitializingBean { 3 4 @PostConstruct 5 public void postConstruct() { 6 System.out.println(\u0026#34;1. @PostConstruct\u0026#34;); 7 } 8 9 @Override 10 public void afterPropertiesSet() { 11 System.out.println(\u0026#34;2. InitializingBean.afterPropertiesSet\u0026#34;); 12 } 13 14 public void initMethod() { 15 System.out.println(\u0026#34;3. init-method\u0026#34;); 16 } 17} æ¨èä½¿ç”¨ @PostConstructï¼Œå› ä¸ºå®ƒæ˜¯ JSR-250 æ ‡å‡†ï¼Œä¸ä¾èµ– Springã€‚\næ€»ç»“ä¸æ€è€ƒ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸä½“ç°äº†\u0026quot;æ¨¡æ¿æ–¹æ³•æ¨¡å¼\u0026quot;å’Œ\u0026quot;è´£ä»»é“¾æ¨¡å¼\u0026quot;çš„è®¾è®¡æ€æƒ³ã€‚\næ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰äº† Bean åˆ›å»ºçš„éª¨æ¶æµç¨‹ è´£ä»»é“¾ï¼šBeanPostProcessor å½¢æˆå¤„ç†é“¾ ç†è§£ Bean ç”Ÿå‘½å‘¨æœŸï¼Œæ‰èƒ½æ›´å¥½åœ°æ‰©å±• Spring æ¡†æ¶ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åœ¨ Bean åˆå§‹åŒ–æ—¶æ‰§è¡Œé€»è¾‘ï¼Œä¸å¦¨è¯•è¯• @PostConstruct æˆ– BeanPostProcessorã€‚\n","permalink":"http://localhost:1313/posts/2024/06/spring-bean-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eç†è§£ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯æŒæ¡ Spring æ¡†æ¶çš„å…³é”®ã€‚æœ¬æ–‡ä»æºç å±‚é¢å‰–æ Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ Spring çš„æ ¸å¿ƒæœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Bean ç”Ÿå‘½å‘¨æœŸçš„å®Œæ•´æµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ BeanPostProcessor çš„æ‰§è¡Œæ—¶æœº\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ InitializingBean vs @PostConstruct çš„åŒºåˆ«\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"bean-ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ\"\u003eBean ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®ä¾‹åŒ– â†’ å±æ€§å¡«å…… â†’ åˆå§‹åŒ–å‰ â†’ åˆå§‹åŒ– â†’ åˆå§‹åŒ–å â†’ ä½¿ç”¨ â†’ é”€æ¯\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¯¦ç»†æµç¨‹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ï¼šé€šè¿‡åå°„åˆ›å»º Bean å®ä¾‹\u003c/li\u003e\n\u003cli\u003eå±æ€§å¡«å……ï¼ˆPopulateï¼‰ï¼šæ³¨å…¥ä¾èµ–çš„ Bean\u003c/li\u003e\n\u003cli\u003eAware æ¥å£å›è°ƒï¼šBeanNameAwareã€BeanFactoryAware ç­‰\u003c/li\u003e\n\u003cli\u003eBeanPostProcessor.postProcessBeforeInitialization\u003c/li\u003e\n\u003cli\u003eInitializingBean.afterPropertiesSet\u003c/li\u003e\n\u003cli\u003eè‡ªå®šä¹‰ init-method\u003c/li\u003e\n\u003cli\u003eBeanPostProcessor.postProcessAfterInitialization\u003c/li\u003e\n\u003cli\u003eBean å¯ä»¥ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eDisposableBean.destroy\u003c/li\u003e\n\u003cli\u003eè‡ªå®šä¹‰ destroy-method\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"å®ä¾‹åŒ–åå°„åˆ›å»ºå¯¹è±¡\"\u003eå®ä¾‹åŒ–ï¼šåå°„åˆ›å»ºå¯¹è±¡\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003edoCreateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. å®ä¾‹åŒ– Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eBeanWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecreateBeanInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetWrappedInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. å±æ€§å¡«å……\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003epopulateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆå§‹åŒ–\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexposedObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einitializeBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexposedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"å±æ€§å¡«å……ä¾èµ–æ³¨å…¥\"\u003eå±æ€§å¡«å……ï¼šä¾èµ–æ³¨å…¥\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epopulateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBeanWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è·å–å±æ€§å€¼\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePropertyValues\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epvs\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetPropertyValues\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è‡ªåŠ¨è£…é…ï¼ˆbyNameã€byTypeï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetResolvedAutowireMode\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTOWIRE_BY_NAME\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eautowireByName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enewPvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetResolvedAutowireMode\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTOWIRE_BY_TYPE\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eautowireByType\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enewPvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åº”ç”¨å±æ€§å€¼\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyPropertyValues\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"åˆå§‹åŒ–å›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘\"\u003eåˆå§‹åŒ–ï¼šå›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003einitializeBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. Aware æ¥å£å›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003einvokeAwareMethods\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. BeanPostProcessor å‰ç½®å¤„ç†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyBeanPostProcessorsBeforeInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆå§‹åŒ–æ–¹æ³•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003einvokeInitMethods\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. BeanPostProcessor åç½®å¤„ç†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyBeanPostProcessorsAfterInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"beanpostprocessoræ‰©å±•ç‚¹\"\u003eBeanPostProcessorï¼šæ‰©å±•ç‚¹\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eBeanPostProcessor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–å‰å›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epostProcessBeforeInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–åå›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epostProcessAfterInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåº”ç”¨åœºæ™¯ï¼š\u003c/p\u003e","title":"Spring Bean ç”Ÿå‘½å‘¨æœŸå®Œå…¨è§£æ"},{"content":"Spring äº‹åŠ¡ç®¡ç†æ˜¯åç«¯å¼€å‘çš„åŸºç¡€æŠ€èƒ½ï¼Œä½†å¾ˆå¤šäººåªä¼šåœ¨æ–¹æ³•ä¸ŠåŠ  @Transactionalï¼Œå´ä¸çŸ¥é“äº‹åŠ¡ä¼ æ’­æœºåˆ¶å’Œå¤±æ•ˆåœºæ™¯ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ Spring äº‹åŠ¡çš„æ ¸å¿ƒåŸç†ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯ æŒæ¡äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§å¸¸è§åœºæ™¯ å­¦ä¼šç¼–ç¨‹å¼äº‹åŠ¡çš„ä½¿ç”¨æ–¹æ³• äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ äº‹åŠ¡çš„ ACID ç‰¹æ€§ Atomicityï¼ˆåŸå­æ€§ï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€ Isolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¹¶å‘äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰° Durabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º REQUIREDï¼ˆé»˜è®¤ï¼‰\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°äº‹åŠ¡ã€‚\n1@Transactional(propagation = Propagation.REQUIRED) 2public void methodA() { 3 // æ“ä½œ 1 4 methodB(); // åŠ å…¥ methodA çš„äº‹åŠ¡ 5} 6 7@Transactional(propagation = Propagation.REQUIRED) 8public void methodB() { 9 // æ“ä½œ 2 10} å¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼ŒmethodA å’Œ methodB çš„æ“ä½œéƒ½ä¼šå›æ»šã€‚\nREQUIRES_NEW\næ— è®ºå½“å‰æ˜¯å¦å­˜åœ¨äº‹åŠ¡ï¼Œéƒ½åˆ›å»ºæ–°äº‹åŠ¡ã€‚å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚\n1@Transactional 2public void methodA() { 3 // æ“ä½œ 1 4 methodB(); // åˆ›å»ºæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ· methodA çš„äº‹åŠ¡ 5 // æ“ä½œ 3 6} 7 8@Transactional(propagation = Propagation.REQUIRES_NEW) 9public void methodB() { 10 // æ“ä½œ 2 11} å¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼Œåªå›æ»šæ“ä½œ 2ï¼Œæ“ä½œ 1 å’Œæ“ä½œ 3 ä¸å—å½±å“ã€‚\nNESTED\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ›å»ºåµŒå¥—äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œç­‰åŒäº REQUIREDã€‚\n1@Transactional 2public void methodA() { 3 // æ“ä½œ 1 4 try { 5 methodB(); // åˆ›å»ºåµŒå¥—äº‹åŠ¡ï¼ˆä¿å­˜ç‚¹ï¼‰ 6 } catch (Exception e) { 7 // methodB å›æ»šï¼Œä½† methodA å¯ä»¥ç»§ç»­ 8 } 9 // æ“ä½œ 3 10} 11 12@Transactional(propagation = Propagation.NESTED) 13public void methodB() { 14 // æ“ä½œ 2 15} åµŒå¥—äº‹åŠ¡åŸºäºæ•°æ®åº“çš„ Savepoint æœºåˆ¶å®ç°ã€‚\nSUPPORTS\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚\né€‚ç”¨äºæŸ¥è¯¢æ–¹æ³•ã€‚\nNOT_SUPPORTED\nä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚\nMANDATORY\nå¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦‚æœå½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\nNEVER\nå¿…é¡»åœ¨éäº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\næ¶æ„æ€è€ƒï¼š äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„è®¾è®¡ä½“ç°äº†\u0026quot;çµæ´»æ€§ä¸å®‰å…¨æ€§çš„å¹³è¡¡\u0026quot;ã€‚REQUIRED ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§ï¼ŒREQUIRES_NEW æä¾›äº†äº‹åŠ¡éš”ç¦»ï¼ŒNESTED æ”¯æŒéƒ¨åˆ†å›æ»šã€‚ä¸åŒçš„ä¸šåŠ¡åœºæ™¯éœ€è¦ä¸åŒçš„ä¼ æ’­è¡Œä¸ºã€‚\näº‹åŠ¡å¤±æ•ˆçš„ 5 ç§åœºæ™¯ åœºæ™¯ä¸€ï¼šæ–¹æ³•ä¸æ˜¯ public\n@Transactional åªå¯¹ public æ–¹æ³•ç”Ÿæ•ˆã€‚\n1@Service 2public class UserService { 3 4 @Transactional 5 private void addUser(User user) { // äº‹åŠ¡å¤±æ•ˆ 6 userMapper.insert(user); 7 } 8} åŸå› ï¼šSpring AOP åŸºäºä»£ç†ï¼Œåªèƒ½ä»£ç† public æ–¹æ³•ã€‚\nåœºæ™¯äºŒï¼šæ–¹æ³•å†…éƒ¨è°ƒç”¨\nåŒä¸€ä¸ªç±»ä¸­ï¼Œæ–¹æ³• A è°ƒç”¨æ–¹æ³• Bï¼Œæ–¹æ³• B çš„äº‹åŠ¡å¤±æ•ˆã€‚\n1@Service 2public class UserService { 3 4 public void methodA() { 5 methodB(); // ç›´æ¥è°ƒç”¨ï¼Œä¸èµ°ä»£ç† 6 } 7 8 @Transactional 9 public void methodB() { // äº‹åŠ¡å¤±æ•ˆ 10 userMapper.insert(user); 11 } 12} åŸå› ï¼šå†…éƒ¨è°ƒç”¨ä¸èµ°ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ this.methodB()ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\n1@Service 2public class UserService { 3 4 @Autowired 5 private UserService self; // æ³¨å…¥è‡ªå·± 6 7 public void methodA() { 8 self.methodB(); // é€šè¿‡ä»£ç†è°ƒç”¨ 9 } 10 11 @Transactional 12 public void methodB() { 13 userMapper.insert(user); 14 } 15} åœºæ™¯ä¸‰ï¼šå¼‚å¸¸è¢«æ•è·\n1@Transactional 2public void addUser(User user) { 3 try { 4 userMapper.insert(user); 5 int i = 1 / 0; // æŠ›å‡ºå¼‚å¸¸ 6 } catch (Exception e) { 7 log.error(\u0026#34;å¼‚å¸¸\u0026#34;, e); // å¼‚å¸¸è¢«æ•è·ï¼Œäº‹åŠ¡ä¸å›æ»š 8 } 9} è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨å›æ»š\n1@Transactional 2public void addUser(User user) { 3 try { 4 userMapper.insert(user); 5 int i = 1 / 0; 6 } catch (Exception e) { 7 log.error(\u0026#34;å¼‚å¸¸\u0026#34;, e); 8 TransactionAspectSupport.currentTransactionStatus().setRollbackOnly(); 9 } 10} åœºæ™¯å››ï¼šå¼‚å¸¸ç±»å‹ä¸åŒ¹é…\n@Transactional é»˜è®¤åªå›æ»š RuntimeException å’Œ Errorã€‚\n1@Transactional 2public void addUser(User user) throws Exception { 3 userMapper.insert(user); 4 throw new Exception(\u0026#34;checked exception\u0026#34;); // äº‹åŠ¡ä¸å›æ»š 5} è§£å†³æ–¹æ¡ˆï¼šæŒ‡å®šå›æ»šçš„å¼‚å¸¸ç±»å‹\n1@Transactional(rollbackFor = Exception.class) 2public void addUser(User user) throws Exception { 3 userMapper.insert(user); 4 throw new Exception(\u0026#34;checked exception\u0026#34;); 5} åœºæ™¯äº”ï¼šæ•°æ®åº“ä¸æ”¯æŒäº‹åŠ¡\nMyISAM å¼•æ“ä¸æ”¯æŒäº‹åŠ¡ï¼Œåªæœ‰ InnoDB æ”¯æŒã€‚\nç¼–ç¨‹å¼äº‹åŠ¡ å£°æ˜å¼äº‹åŠ¡ï¼ˆ@Transactionalï¼‰ç®€å•æ˜“ç”¨ï¼Œä½†ä¸å¤Ÿçµæ´»ã€‚ç¼–ç¨‹å¼äº‹åŠ¡æä¾›äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚\n1@Service 2public class UserService { 3 4 @Autowired 5 private TransactionTemplate transactionTemplate; 6 7 public void addUser(User user) { 8 transactionTemplate.execute(status -\u0026gt; { 9 try { 10 userMapper.insert(user); 11 // å…¶ä»–æ“ä½œ 12 return true; 13 } catch (Exception e) { 14 status.setRollbackOnly(); 15 return false; 16 } 17 }); 18 } 19} åˆ†å¸ƒå¼äº‹åŠ¡ å•ä½“åº”ç”¨çš„äº‹åŠ¡ç”±æ•°æ®åº“ä¿è¯ï¼Œä½†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡å¯èƒ½æ¶‰åŠå¤šä¸ªæœåŠ¡å’Œæ•°æ®åº“ï¼Œéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nè§£å†³æ–¹æ¡ˆä¸€ï¼šä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰\nåè°ƒè€…å…ˆè¯¢é—®æ‰€æœ‰å‚ä¸è€…æ˜¯å¦å¯ä»¥æäº¤ï¼Œå¦‚æœéƒ½åŒæ„ï¼Œå†é€šçŸ¥æäº¤ã€‚\nç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œå­˜åœ¨å•ç‚¹æ•…éšœã€‚\nè§£å†³æ–¹æ¡ˆäºŒï¼šTCC\nTry-Confirm-Cancelï¼Œä¸šåŠ¡å±‚é¢çš„ä¸¤é˜¶æ®µæäº¤ã€‚\nTryï¼šé¢„ç•™èµ„æº Confirmï¼šç¡®è®¤æäº¤ Cancelï¼šå–æ¶ˆå›æ»š è§£å†³æ–¹æ¡ˆä¸‰ï¼šSeata AT æ¨¡å¼\nè‡ªåŠ¨è®°å½• SQL çš„å‰åé•œåƒï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›æ»šã€‚\nè§£å†³æ–¹æ¡ˆå››ï¼šæœ€ç»ˆä¸€è‡´æ€§\né€šè¿‡æ¶ˆæ¯é˜Ÿåˆ— + è¡¥å¿æœºåˆ¶å®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚\næ€»ç»“ä¸æ€è€ƒ Spring äº‹åŠ¡çš„æ ¸å¿ƒæ˜¯ AOP ä»£ç†ï¼Œç†è§£ä»£ç†æœºåˆ¶æ‰èƒ½é¿å…äº‹åŠ¡å¤±æ•ˆã€‚\n7 ç§ä¼ æ’­è¡Œä¸ºé€‚ç”¨äºä¸åŒåœºæ™¯ äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§åœºæ™¯è¦ç‰¢è®° åˆ†å¸ƒå¼äº‹åŠ¡è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©æ–¹æ¡ˆ ä¸‹æ¬¡å½“ä½ çš„äº‹åŠ¡ä¸ç”Ÿæ•ˆæ—¶ï¼Œæ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯è¸©äº†è¿™äº›å‘ã€‚\n","permalink":"http://localhost:1313/posts/2024/05/spring-%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eSpring äº‹åŠ¡ç®¡ç†æ˜¯åç«¯å¼€å‘çš„åŸºç¡€æŠ€èƒ½ï¼Œä½†å¾ˆå¤šäººåªä¼šåœ¨æ–¹æ³•ä¸ŠåŠ  @Transactionalï¼Œå´ä¸çŸ¥é“äº‹åŠ¡ä¼ æ’­æœºåˆ¶å’Œå¤±æ•ˆåœºæ™¯ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ Spring äº‹åŠ¡çš„æ ¸å¿ƒåŸç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§å¸¸è§åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç¼–ç¨‹å¼äº‹åŠ¡çš„ä½¿ç”¨æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"äº‹åŠ¡çš„-acid-ç‰¹æ€§\"\u003eäº‹åŠ¡çš„ ACID ç‰¹æ€§\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eAtomicityï¼ˆåŸå­æ€§ï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥\u003c/li\u003e\n\u003cli\u003eConsistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€\u003c/li\u003e\n\u003cli\u003eIsolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¹¶å‘äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°\u003c/li\u003e\n\u003cli\u003eDurabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"7-ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º\"\u003e7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eREQUIREDï¼ˆé»˜è®¤ï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°äº‹åŠ¡ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Transactional\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epropagation\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePropagation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eREQUIRED\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003emethodA\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ“ä½œ 1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003emethodB\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åŠ å…¥ methodA çš„äº‹åŠ¡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Transactional\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epropagation\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePropagation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eREQUIRED\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003emethodB\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ“ä½œ 2\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼ŒmethodA å’Œ methodB çš„æ“ä½œéƒ½ä¼šå›æ»šã€‚\u003c/p\u003e","title":"Spring äº‹åŠ¡ä¼ æ’­æœºåˆ¶ä¸å¤±æ•ˆåœºæ™¯å®Œå…¨è§£æ"},{"content":"åœ¨ä¼ ç»Ÿ Java åº”ç”¨ä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°ä¸€æ—¦åœ¨ä»£ç ä¸­å†™æ­»ï¼Œå°±åªèƒ½é€šè¿‡é‡å¯åº”ç”¨æ¥è°ƒæ•´ã€‚å½“çº¿ä¸Šæµé‡çªå¢å¯¼è‡´çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯æ—¶ï¼Œå¼€å‘è€…åªèƒ½çœ¼çççœ‹ç€ç³»ç»Ÿå´©æºƒã€‚æœ¬é¡¹ç›®é€šè¿‡è‡ªå®šä¹‰ Spring Boot Starterï¼Œå®ç°äº†çº¿ç¨‹æ± å‚æ•°çš„åŠ¨æ€è°ƒæ•´ã€å®æ—¶ç›‘æ§å’Œå¯è§†åŒ–ç®¡ç†ã€‚\né¡¹ç›®äº®ç‚¹ æ·±å…¥ç ”ç©¶ Spring Boot Starter åŸç†ï¼Œåˆ©ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼ SDK åŸºäº Redisson Pub/Sub æœºåˆ¶å®ç°é…ç½®å®æ—¶æ¨é€ï¼Œæ— éœ€é‡å¯åº”ç”¨ è®¾è®¡ ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ä¸ŠæŠ¥ Redis å¼€å‘ Admin ç®¡ç†åå°ï¼Œæä¾›å¯è§†åŒ–çš„å‚æ•°é…ç½®å’Œç›‘æ§ç•Œé¢ é—®é¢˜èƒŒæ™¯ï¼šçº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹ åœ¨ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œçº¿ç¨‹æ± çš„åˆ›å»ºæ–¹å¼é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š\n1@Configuration 2public class ThreadPoolConfig { 3 @Bean 4 public ThreadPoolExecutor bizThreadPool() { 5 return new ThreadPoolExecutor( 6 10, // æ ¸å¿ƒçº¿ç¨‹æ•° 7 20, // æœ€å¤§çº¿ç¨‹æ•° 8 60, TimeUnit.SECONDS, 9 new LinkedBlockingQueue\u0026lt;\u0026gt;(100) 10 ); 11 } 12} è¿™ç§ç¡¬ç¼–ç æ–¹å¼æœ‰ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\nå‚æ•°è°ƒæ•´éœ€è¦é‡å¯ï¼š å½“å‘ç°çº¿ç¨‹æ± é…ç½®ä¸åˆç†æ—¶ï¼Œå¿…é¡»ä¿®æ”¹ä»£ç ã€é‡æ–°æ‰“åŒ…ã€é‡å¯åº”ç”¨ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé‡å¯æ„å‘³ç€æœåŠ¡ä¸­æ–­ã€‚\nç¼ºä¹ç›‘æ§æ‰‹æ®µï¼š æ— æ³•å®æ—¶æŸ¥çœ‹çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰ï¼Œåªèƒ½ç­‰åˆ°å‡ºé—®é¢˜åé€šè¿‡æ—¥å¿—æ’æŸ¥ã€‚\né…ç½®åˆ†æ•£ç®¡ç†ï¼š ä¸åŒæœåŠ¡çš„çº¿ç¨‹æ± é…ç½®æ•£è½åœ¨å„è‡ªçš„ä»£ç ä¸­ï¼Œç¼ºä¹ç»Ÿä¸€çš„ç®¡ç†å¹³å°ã€‚\nè¿™äº›ç—›ç‚¹å€’é€¼æˆ‘ä»¬å¿…é¡»è®¾è®¡ä¸€å¥—åŠ¨æ€çº¿ç¨‹æ± ç®¡ç†æ–¹æ¡ˆã€‚\næ¶æ„è®¾è®¡ï¼šé›¶ä¾µå…¥å¼ SDK æ ¸å¿ƒè®¾è®¡æ€è·¯æ˜¯ï¼šé€šè¿‡ Spring Boot Starter æœºåˆ¶ï¼Œè®©ä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥åœ°æ¥å…¥åŠ¨æ€çº¿ç¨‹æ± èƒ½åŠ›ã€‚å¼€å‘è€…åªéœ€è¦å¼•å…¥ä¾èµ–ï¼Œçº¿ç¨‹æ± å°±è‡ªåŠ¨å…·å¤‡äº†åŠ¨æ€è°ƒæ•´å’Œç›‘æ§èƒ½åŠ›ã€‚\næŠ€æœ¯é€‰å‹ï¼š\nBeanPostProcessorï¼š æ‹¦æˆª Spring å®¹å™¨ä¸­çš„ ThreadPoolExecutor Beanï¼Œæ›¿æ¢ä¸ºå¯åŠ¨æ€è°ƒæ•´çš„ä»£ç†å¯¹è±¡ Redisson Pub/Subï¼š å®ç°é…ç½®ä¸­å¿ƒåˆ°åº”ç”¨å®ä¾‹çš„å®æ—¶æ¨é€ å®šæ—¶ä»»åŠ¡ï¼š æ¯ 20 ç§’é‡‡é›†ä¸€æ¬¡çº¿ç¨‹æ± æŒ‡æ ‡ï¼Œä¸ŠæŠ¥åˆ° Redis Admin åå°ï¼š æä¾› Web ç•Œé¢ï¼Œç®¡ç†æ‰€æœ‰æœåŠ¡çš„çº¿ç¨‹æ± é…ç½® æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š\n1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” é…ç½®å˜æ›´ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ Admin åå° â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\u0026gt; â”‚ Redis â”‚ 3â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 4 â”‚ 5 â”‚ Pub/Sub æ¨é€ 6 â†“ 7 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 8 â”‚ åº”ç”¨å®ä¾‹ A/B/C â”‚ 9 â”‚ (SDK è‡ªåŠ¨æ¥å…¥) â”‚ 10 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 11 â”‚ 12 â”‚ å®šæ—¶ä¸ŠæŠ¥æŒ‡æ ‡ 13 â†“ 14 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 15 â”‚ Redis â”‚ 16 â”‚ (ç›‘æ§æ•°æ®å­˜å‚¨) â”‚ 17 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒå®ç°ï¼šBeanPostProcessor æ‹¦æˆªä¸æ›¿æ¢ Spring Boot Starter çš„æ ¸å¿ƒæ˜¯è‡ªåŠ¨è£…é…æœºåˆ¶ã€‚æˆ‘ä»¬é€šè¿‡ spring.factories æ–‡ä»¶å£°æ˜è‡ªåŠ¨é…ç½®ç±»ï¼š\n1# META-INF/spring.factories 2org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 3com.example.threadpool.autoconfigure.ThreadPoolAutoConfiguration åœ¨è‡ªåŠ¨é…ç½®ç±»ä¸­ï¼Œæ³¨å†Œ BeanPostProcessorï¼š\n1@Configuration 2public class ThreadPoolAutoConfiguration { 3 4 @Bean 5 public ThreadPoolBeanPostProcessor threadPoolBeanPostProcessor() { 6 return new ThreadPoolBeanPostProcessor(); 7 } 8} BeanPostProcessor ä¼šåœ¨ Spring å®¹å™¨åˆå§‹åŒ–æ¯ä¸ª Bean åæ‰§è¡Œå›è°ƒï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ‹¦æˆª ThreadPoolExecutorï¼š\n1public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 2 3 @Override 4 public Object postProcessAfterInitialization(Object bean, String beanName) { 5 if (bean instanceof ThreadPoolExecutor) { 6 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 7 // å°†åŸå§‹çº¿ç¨‹æ± åŒ…è£…ä¸ºåŠ¨æ€çº¿ç¨‹æ±  8 return new DynamicThreadPoolExecutor(executor, beanName); 9 } 10 return bean; 11 } 12} DynamicThreadPoolExecutor æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„çº¿ç¨‹æ± åŒ…è£…ç±»ï¼Œå®ƒæŒæœ‰åŸå§‹ ThreadPoolExecutor çš„å¼•ç”¨ï¼Œå¹¶æä¾›åŠ¨æ€è°ƒæ•´èƒ½åŠ›ï¼š\n1public class DynamicThreadPoolExecutor extends ThreadPoolExecutor { 2 3 private final String poolName; 4 5 public void updateConfig(ThreadPoolConfig config) { 6 // åŠ¨æ€è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•° 7 this.setCorePoolSize(config.getCorePoolSize()); 8 // åŠ¨æ€è°ƒæ•´æœ€å¤§çº¿ç¨‹æ•° 9 this.setMaximumPoolSize(config.getMaxPoolSize()); 10 // åŠ¨æ€è°ƒæ•´é˜Ÿåˆ—å®¹é‡ï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰ 11 this.setQueue(new ResizableLinkedBlockingQueue\u0026lt;\u0026gt;(config.getQueueCapacity())); 12 } 13} æ¶æ„æ€è€ƒï¼š BeanPostProcessor æ˜¯ Spring æ¡†æ¶çš„æ‰©å±•ç‚¹ä¹‹ä¸€ï¼Œå¾ˆå¤šä¸­é—´ä»¶ï¼ˆå¦‚ MyBatisã€Dubboï¼‰éƒ½é€šè¿‡å®ƒå®ç°é›¶ä¾µå…¥å¼æ¥å…¥ã€‚ç†è§£è¿™ä¸ªæœºåˆ¶ï¼Œå°±èƒ½è®¾è®¡å‡ºå¯¹ä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥çš„åŸºç¡€ç»„ä»¶ã€‚\nåŠ¨æ€å‚æ•°è°ƒæ•´ï¼šRedisson Pub/Sub å®æ—¶æ¨é€ å½“ç®¡ç†å‘˜åœ¨ Admin åå°ä¿®æ”¹çº¿ç¨‹æ± é…ç½®åï¼Œå¦‚ä½•å®æ—¶é€šçŸ¥åˆ°æ‰€æœ‰åº”ç”¨å®ä¾‹ï¼Ÿæˆ‘ä»¬ä½¿ç”¨ Redisson çš„ Pub/Sub æœºåˆ¶ã€‚\nå‘å¸ƒç«¯ï¼ˆAdmin åå°ï¼‰ï¼š\n1@Service 2public class ThreadPoolConfigService { 3 4 @Autowired 5 private RedissonClient redisson; 6 7 public void updateConfig(String appName, String poolName, ThreadPoolConfig config) { 8 // ä¿å­˜é…ç½®åˆ° Redis 9 String key = \u0026#34;threadpool:config:\u0026#34; + appName + \u0026#34;:\u0026#34; + poolName; 10 redisson.getBucket(key).set(config); 11 12 // å‘å¸ƒé…ç½®å˜æ›´æ¶ˆæ¯ 13 RTopic topic = redisson.getTopic(\u0026#34;threadpool:config:update\u0026#34;); 14 topic.publish(new ConfigUpdateMessage(appName, poolName, config)); 15 } 16} è®¢é˜…ç«¯ï¼ˆåº”ç”¨å®ä¾‹ï¼‰ï¼š\n1@Component 2public class ThreadPoolConfigListener implements ApplicationListener\u0026lt;ContextRefreshedEvent\u0026gt; { 3 4 @Autowired 5 private RedissonClient redisson; 6 7 @Autowired 8 private Map\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; threadPoolMap; 9 10 @Override 11 public void onApplicationEvent(ContextRefreshedEvent event) { 12 // è®¢é˜…é…ç½®å˜æ›´æ¶ˆæ¯ 13 RTopic topic = redisson.getTopic(\u0026#34;threadpool:config:update\u0026#34;); 14 topic.addListener(ConfigUpdateMessage.class, (channel, msg) -\u0026gt; { 15 // åªå¤„ç†æœ¬åº”ç”¨çš„é…ç½® 16 if (!msg.getAppName().equals(appName)) { 17 return; 18 } 19 // åŠ¨æ€æ›´æ–°çº¿ç¨‹æ± é…ç½® 20 DynamicThreadPoolExecutor executor = threadPoolMap.get(msg.getPoolName()); 21 if (executor != null) { 22 executor.updateConfig(msg.getConfig()); 23 log.info(\u0026#34;çº¿ç¨‹æ±  {} é…ç½®å·²æ›´æ–°: {}\u0026#34;, msg.getPoolName(), msg.getConfig()); 24 } 25 }); 26 } 27} è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šé…ç½®å˜æ›´å¯ä»¥åœ¨ç§’çº§å†…æ¨é€åˆ°æ‰€æœ‰å®ä¾‹ï¼Œæ— éœ€é‡å¯åº”ç”¨ã€‚å³ä½¿æœ‰ä¸Šç™¾ä¸ªå®ä¾‹ï¼Œä¹Ÿèƒ½ä¿è¯é…ç½®çš„ä¸€è‡´æ€§ã€‚\né¿å‘æç¤ºï¼š Redisson çš„ Pub/Sub æ˜¯åŸºäº Redis çš„å‘å¸ƒè®¢é˜…æœºåˆ¶ï¼Œæ¶ˆæ¯ä¸ä¼šæŒä¹…åŒ–ã€‚å¦‚æœåº”ç”¨å®ä¾‹åœ¨é…ç½®å˜æ›´æ—¶å¤„äºç¦»çº¿çŠ¶æ€ï¼Œé‡æ–°ä¸Šçº¿åéœ€è¦ä¸»åŠ¨ä» Redis æ‹‰å–æœ€æ–°é…ç½®ã€‚\nç›‘æ§æŒ‡æ ‡é‡‡é›†ï¼šå®šæ—¶ä»»åŠ¡ä¸ŠæŠ¥ åŠ¨æ€è°ƒæ•´åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œæ›´é‡è¦çš„æ˜¯å®æ—¶ç›‘æ§çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ã€‚æˆ‘ä»¬è®¾è®¡äº† ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œæ¯ 20 ç§’é‡‡é›†ä¸€æ¬¡æŒ‡æ ‡ï¼š\n1@Component 2public class ThreadPoolDataReportJob { 3 4 @Autowired 5 private Map\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; threadPoolMap; 6 7 @Autowired 8 private RedissonClient redisson; 9 10 @Scheduled(fixedRate = 20000) 11 public void reportMetrics() { 12 for (Map.Entry\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; entry : threadPoolMap.entrySet()) { 13 String poolName = entry.getKey(); 14 ThreadPoolExecutor executor = entry.getValue(); 15 16 // é‡‡é›†æŒ‡æ ‡ 17 ThreadPoolMetrics metrics = ThreadPoolMetrics.builder() 18 .poolName(poolName) 19 .corePoolSize(executor.getCorePoolSize()) 20 .maximumPoolSize(executor.getMaximumPoolSize()) 21 .activeCount(executor.getActiveCount()) // æ´»è·ƒçº¿ç¨‹æ•° 22 .queueSize(executor.getQueue().size()) // é˜Ÿåˆ—é•¿åº¦ 23 .completedTaskCount(executor.getCompletedTaskCount()) 24 .rejectedCount(getRejectedCount(executor)) // æ‹’ç»æ¬¡æ•° 25 .timestamp(System.currentTimeMillis()) 26 .build(); 27 28 // ä¸ŠæŠ¥åˆ° Redisï¼ˆä½¿ç”¨ List ç»“æ„ï¼Œä¿ç•™æœ€è¿‘ 100 æ¡è®°å½•ï¼‰ 29 String key = \u0026#34;threadpool:metrics:\u0026#34; + appName + \u0026#34;:\u0026#34; + poolName; 30 RList\u0026lt;ThreadPoolMetrics\u0026gt; list = redisson.getList(key); 31 list.add(metrics); 32 if (list.size() \u0026gt; 100) { 33 list.remove(0); // ç§»é™¤æœ€æ—§çš„è®°å½• 34 } 35 } 36 } 37} ä¸ºäº†ç»Ÿè®¡æ‹’ç»æ¬¡æ•°ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ RejectedExecutionHandlerï¼š\n1public class MonitorableRejectedHandler implements RejectedExecutionHandler { 2 3 private final AtomicLong rejectedCount = new AtomicLong(0); 4 5 @Override 6 public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) { 7 rejectedCount.incrementAndGet(); 8 // é™çº§ç­–ç•¥ï¼šè°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ 9 new ThreadPoolExecutor.CallerRunsPolicy().rejectedExecution(r, executor); 10 } 11 12 public long getRejectedCount() { 13 return rejectedCount.get(); 14 } 15} å¯è§†åŒ–ç®¡ç†ï¼šAdmin åå°è®¾è®¡ Admin åå°æä¾›ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š\n1. é…ç½®ç®¡ç†ç•Œé¢\nå±•ç¤ºæ‰€æœ‰åº”ç”¨çš„çº¿ç¨‹æ± åˆ—è¡¨ï¼Œæ”¯æŒåœ¨çº¿ä¿®æ”¹å‚æ•°ï¼š\n1@RestController 2@RequestMapping(\u0026#34;/api/threadpool\u0026#34;) 3public class ThreadPoolController { 4 5 @GetMapping(\u0026#34;/list\u0026#34;) 6 public List\u0026lt;ThreadPoolInfo\u0026gt; listThreadPools(@RequestParam String appName) { 7 // ä» Redis æŸ¥è¯¢æ‰€æœ‰çº¿ç¨‹æ± é…ç½® 8 String pattern = \u0026#34;threadpool:config:\u0026#34; + appName + \u0026#34;:*\u0026#34;; 9 return redisson.getKeys().getKeysByPattern(pattern).stream() 10 .map(key -\u0026gt; redisson.getBucket(key).get()) 11 .collect(Collectors.toList()); 12 } 13 14 @PostMapping(\u0026#34;/update\u0026#34;) 15 public void updateConfig(@RequestBody ThreadPoolUpdateRequest request) { 16 threadPoolConfigService.updateConfig( 17 request.getAppName(), 18 request.getPoolName(), 19 request.getConfig() 20 ); 21 } 22} 2. ç›‘æ§å¤§ç›˜\nå®æ—¶å±•ç¤ºçº¿ç¨‹æ± çš„è¿è¡ŒæŒ‡æ ‡ï¼Œæ”¯æŒå›¾è¡¨å¯è§†åŒ–ï¼š\næ´»è·ƒçº¿ç¨‹æ•°è¶‹åŠ¿å›¾ é˜Ÿåˆ—é•¿åº¦å˜åŒ–æ›²çº¿ ä»»åŠ¡æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ ä»»åŠ¡å®Œæˆé€Ÿç‡ å‰ç«¯ä½¿ç”¨ ECharts æ¸²æŸ“å›¾è¡¨ï¼Œæ¯ 5 ç§’è½®è¯¢ä¸€æ¬¡åç«¯æ¥å£è·å–æœ€æ–°æ•°æ®ã€‚\næ¶æ„æ€è€ƒï¼š ç›‘æ§æ•°æ®çš„å­˜å‚¨æ–¹å¼æœ‰å¤šç§é€‰æ‹©ï¼šRedisã€InfluxDBã€Prometheusã€‚æˆ‘ä»¬é€‰æ‹© Redis æ˜¯å› ä¸ºå®ƒéƒ¨ç½²ç®€å•ï¼Œä¸”æˆ‘ä»¬çš„ç›‘æ§æ•°æ®é‡ä¸å¤§ï¼ˆæ¯ä¸ªçº¿ç¨‹æ± æ¯ 20 ç§’ä¸€æ¡è®°å½•ï¼‰ã€‚å¦‚æœéœ€è¦é•¿æœŸå­˜å‚¨å’Œå¤æ‚æŸ¥è¯¢ï¼Œå»ºè®®ä½¿ç”¨æ—¶åºæ•°æ®åº“ã€‚\né¡¹ç›®æˆæœä¸åæ€ è¿™ä¸ª SDK åœ¨å…¬å¸å†…éƒ¨æ¨å¹¿åï¼Œæ¥å…¥äº† 20+ ä¸ªæœåŠ¡ï¼Œç´¯è®¡ç®¡ç† 50+ ä¸ªçº¿ç¨‹æ± ã€‚æ ¸å¿ƒæ”¶ç›Šï¼š\nçº¿ä¸Šé—®é¢˜å“åº”æ—¶é—´ä»\u0026quot;å°æ—¶çº§\u0026quot;é™ä½åˆ°\u0026quot;åˆ†é’Ÿçº§\u0026quot;ï¼ˆæ— éœ€é‡å¯è°ƒæ•´å‚æ•°ï¼‰ é€šè¿‡ç›‘æ§å¤§ç›˜æå‰å‘ç° 3 æ¬¡æ½œåœ¨çš„çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯é—®é¢˜ ç»Ÿä¸€çš„é…ç½®ç®¡ç†é™ä½äº†è¿ç»´æˆæœ¬ å¦‚æœé‡æ–°è®¾è®¡ï¼Œæˆ‘ä¼šè€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–ï¼š\næ”¯æŒæ›´å¤šçº¿ç¨‹æ± ç±»å‹ï¼š ç›®å‰åªæ”¯æŒ ThreadPoolExecutorï¼Œæœªæ¥å¯ä»¥æ‰©å±•åˆ° ScheduledThreadPoolExecutorã€ForkJoinPool ç­‰ã€‚\nå‘Šè­¦æœºåˆ¶ï¼š å½“é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼æˆ–æ‹’ç»æ¬¡æ•°æ¿€å¢æ—¶ï¼Œè‡ªåŠ¨å‘é€é’‰é’‰/é‚®ä»¶å‘Šè­¦ã€‚\nå†å²é…ç½®å›æ»šï¼š è®°å½•æ¯æ¬¡é…ç½®å˜æ›´çš„å†å²ï¼Œæ”¯æŒä¸€é”®å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚\nè¿™ä¸ªé¡¹ç›®æœ€å¤§çš„æ”¶è·æ˜¯ï¼šç†è§£äº† Spring Boot Starter çš„è®¾è®¡å“²å­¦â€”â€”é€šè¿‡çº¦å®šå’Œè‡ªåŠ¨åŒ–ï¼Œè®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯åŸºç¡€è®¾æ–½çš„æ­å»ºã€‚è¿™ç§\u0026quot;é›¶ä¾µå…¥å¼\u0026quot;çš„è®¾è®¡æ€æƒ³ï¼Œå€¼å¾—åœ¨å…¶ä»–åŸºç¡€ç»„ä»¶ä¸­æ¨å¹¿ã€‚\n","permalink":"http://localhost:1313/projects/thread-pool-sdk/","summary":"\u003cp\u003eåœ¨ä¼ ç»Ÿ Java åº”ç”¨ä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°ä¸€æ—¦åœ¨ä»£ç ä¸­å†™æ­»ï¼Œå°±åªèƒ½é€šè¿‡é‡å¯åº”ç”¨æ¥è°ƒæ•´ã€‚å½“çº¿ä¸Šæµé‡çªå¢å¯¼è‡´çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯æ—¶ï¼Œå¼€å‘è€…åªèƒ½çœ¼çççœ‹ç€ç³»ç»Ÿå´©æºƒã€‚æœ¬é¡¹ç›®é€šè¿‡è‡ªå®šä¹‰ Spring Boot Starterï¼Œå®ç°äº†çº¿ç¨‹æ± å‚æ•°çš„åŠ¨æ€è°ƒæ•´ã€å®æ—¶ç›‘æ§å’Œå¯è§†åŒ–ç®¡ç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"é¡¹ç›®äº®ç‚¹\"\u003eé¡¹ç›®äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æ·±å…¥ç ”ç©¶ Spring Boot Starter åŸç†ï¼Œåˆ©ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼ SDK\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e åŸºäº Redisson Pub/Sub æœºåˆ¶å®ç°é…ç½®å®æ—¶æ¨é€ï¼Œæ— éœ€é‡å¯åº”ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è®¾è®¡ ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ä¸ŠæŠ¥ Redis\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å¼€å‘ Admin ç®¡ç†åå°ï¼Œæä¾›å¯è§†åŒ–çš„å‚æ•°é…ç½®å’Œç›‘æ§ç•Œé¢\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"é—®é¢˜èƒŒæ™¯çº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹\"\u003eé—®é¢˜èƒŒæ™¯ï¼šçº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹\u003c/h2\u003e\n\u003cp\u003eåœ¨ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œçº¿ç¨‹æ± çš„åˆ›å»ºæ–¹å¼é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eThreadPoolConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ebizThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ ¸å¿ƒçº¿ç¨‹æ•°\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æœ€å¤§çº¿ç¨‹æ•°\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e60\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLinkedBlockingQueue\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™ç§ç¡¬ç¼–ç æ–¹å¼æœ‰ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\u003c/p\u003e","title":"åŠ¨æ€çº¿ç¨‹æ±  SDKï¼šä»é›¶å®ç° Spring Boot Starter"},{"content":"AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡ AOPï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰ä»ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ä½† AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæœ¬æ–‡æ·±å…¥å‰–æ Spring AOP çš„åº•å±‚æœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ AOP çš„æ ¸å¿ƒæ¦‚å¿µï¼šåˆ‡é¢ã€åˆ‡ç‚¹ã€é€šçŸ¥ã€è¿æ¥ç‚¹ æŒæ¡ JDK åŠ¨æ€ä»£ç†ä¸ CGLIB ä»£ç†çš„å®ç°åŸç† å­¦ä¼š ProxyFactory çš„åˆ›å»ºæµç¨‹ äº†è§£åˆ‡é¢æ‰§è¡Œé¡ºåºä¸è´£ä»»é“¾æ¨¡å¼ AOP æ ¸å¿ƒæ¦‚å¿µ åˆ‡é¢ï¼ˆAspectï¼‰\næ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–ï¼Œæ¯”å¦‚æ—¥å¿—åˆ‡é¢ã€äº‹åŠ¡åˆ‡é¢ã€‚\n1@Aspect 2@Component 3public class LogAspect { 4 5 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 6 public void logBefore(JoinPoint joinPoint) { 7 log.info(\u0026#34;æ–¹æ³•æ‰§è¡Œå‰: {}\u0026#34;, joinPoint.getSignature().getName()); 8 } 9} åˆ‡ç‚¹ï¼ˆPointcutï¼‰\nå®šä¹‰åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨é€šçŸ¥ï¼Œé€šè¿‡è¡¨è¾¾å¼åŒ¹é…ã€‚\n1@Pointcut(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 2public void serviceLayer() {} é€šçŸ¥ï¼ˆAdviceï¼‰\nåœ¨åˆ‡ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼Œåˆ†ä¸ºäº”ç§ç±»å‹ï¼š\n@Beforeï¼šå‰ç½®é€šçŸ¥ @Afterï¼šåç½®é€šçŸ¥ @AfterReturningï¼šè¿”å›é€šçŸ¥ @AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥ @Aroundï¼šç¯ç»•é€šçŸ¥ è¿æ¥ç‚¹ï¼ˆJoinPointï¼‰\nç¨‹åºæ‰§è¡Œçš„æŸä¸ªç‚¹ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºã€‚\nJDK åŠ¨æ€ä»£ç† vs CGLIB ä»£ç† Spring AOP ä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼š\nJDK åŠ¨æ€ä»£ç†\nåŸºäºæ¥å£çš„ä»£ç†ï¼Œè¦æ±‚ç›®æ ‡ç±»å®ç°æ¥å£ã€‚\n1public interface UserService { 2 void addUser(User user); 3} 4 5@Service 6public class UserServiceImpl implements UserService { 7 @Override 8 public void addUser(User user) { 9 // ä¸šåŠ¡é€»è¾‘ 10 } 11} JDK åŠ¨æ€ä»£ç†çš„å®ç°ï¼š\n1public class JdkProxyFactory implements InvocationHandler { 2 3 private Object target; 4 5 public Object createProxy(Object target) { 6 this.target = target; 7 return Proxy.newProxyInstance( 8 target.getClass().getClassLoader(), 9 target.getClass().getInterfaces(), 10 this 11 ); 12 } 13 14 @Override 15 public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { 16 System.out.println(\u0026#34;Before method\u0026#34;); 17 Object result = method.invoke(target, args); 18 System.out.println(\u0026#34;After method\u0026#34;); 19 return result; 20 } 21} CGLIB ä»£ç†\nåŸºäºç»§æ‰¿çš„ä»£ç†ï¼Œé€šè¿‡ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»å®ç°ã€‚\n1@Service 2public class UserService { // æ²¡æœ‰å®ç°æ¥å£ 3 public void addUser(User user) { 4 // ä¸šåŠ¡é€»è¾‘ 5 } 6} CGLIB ä»£ç†çš„å®ç°ï¼š\n1public class CglibProxyFactory implements MethodInterceptor { 2 3 public Object createProxy(Object target) { 4 Enhancer enhancer = new Enhancer(); 5 enhancer.setSuperclass(target.getClass()); 6 enhancer.setCallback(this); 7 return enhancer.create(); 8 } 9 10 @Override 11 public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable { 12 System.out.println(\u0026#34;Before method\u0026#34;); 13 Object result = proxy.invokeSuper(obj, args); 14 System.out.println(\u0026#34;After method\u0026#34;); 15 return result; 16 } 17} é€‰æ‹©è§„åˆ™\nå¦‚æœç›®æ ‡ç±»å®ç°äº†æ¥å£ï¼Œé»˜è®¤ä½¿ç”¨ JDK åŠ¨æ€ä»£ç† å¦‚æœç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œä½¿ç”¨ CGLIB ä»£ç† å¯ä»¥é€šè¿‡é…ç½®å¼ºåˆ¶ä½¿ç”¨ CGLIBï¼š@EnableAspectJAutoProxy(proxyTargetClass = true) æ¶æ„æ€è€ƒï¼š JDK åŠ¨æ€ä»£ç†å’Œ CGLIB ä»£ç†ä½“ç°äº†\u0026quot;ç­–ç•¥æ¨¡å¼\u0026quot;çš„æ€æƒ³ã€‚Spring æ ¹æ®ç›®æ ‡ç±»çš„ç‰¹å¾ï¼Œé€‰æ‹©åˆé€‚çš„ä»£ç†ç­–ç•¥ã€‚è¿™ç§è®¾è®¡è®©æ¡†æ¶æ›´åŠ çµæ´»ï¼Œèƒ½å¤Ÿé€‚åº”ä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚\nProxyFactory åˆ›å»ºæµç¨‹ Spring AOP é€šè¿‡ ProxyFactory åˆ›å»ºä»£ç†å¯¹è±¡ï¼š\n1@Component 2public class AopProxyCreator { 3 4 public Object createProxy(Object target) { 5 ProxyFactory proxyFactory = new ProxyFactory(); 6 proxyFactory.setTarget(target); 7 8 // æ·»åŠ é€šçŸ¥ 9 proxyFactory.addAdvice(new MethodBeforeAdvice() { 10 @Override 11 public void before(Method method, Object[] args, Object target) { 12 System.out.println(\u0026#34;Before: \u0026#34; + method.getName()); 13 } 14 }); 15 16 return proxyFactory.getProxy(); 17 } 18} ProxyFactory çš„åˆ›å»ºæµç¨‹ï¼š\nåˆ›å»º AopProxyFactoryï¼ˆé»˜è®¤æ˜¯ DefaultAopProxyFactoryï¼‰ æ ¹æ®ç›®æ ‡ç±»é€‰æ‹©ä»£ç†æ–¹å¼ï¼ˆJDK æˆ– CGLIBï¼‰ åˆ›å»º AopProxy å¯¹è±¡ï¼ˆJdkDynamicAopProxy æˆ– CglibAopProxyï¼‰ ç”Ÿæˆä»£ç†å¯¹è±¡ åˆ‡é¢æ‰§è¡Œé¡ºåº å½“æœ‰å¤šä¸ªåˆ‡é¢æ—¶ï¼Œæ‰§è¡Œé¡ºåºç”± @Order æ³¨è§£æ§åˆ¶ï¼š\n1@Aspect 2@Component 3@Order(1) 4public class LogAspect { 5 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 6 public void logBefore() { 7 System.out.println(\u0026#34;Log Before\u0026#34;); 8 } 9} 10 11@Aspect 12@Component 13@Order(2) 14public class TransactionAspect { 15 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 16 public void transactionBefore() { 17 System.out.println(\u0026#34;Transaction Before\u0026#34;); 18 } 19} æ‰§è¡Œé¡ºåºï¼š\n1Log Before 2Transaction Before 3ç›®æ ‡æ–¹æ³•æ‰§è¡Œ 4Transaction After 5Log After è¿™æ˜¯è´£ä»»é“¾æ¨¡å¼çš„å…¸å‹åº”ç”¨ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šè‡ªå®šä¹‰æ³¨è§£å®ç°æƒé™æ ¡éªŒ 1@Target(ElementType.METHOD) 2@Retention(RetentionPolicy.RUNTIME) 3public @interface RequirePermission { 4 String value(); 5} 6 7@Aspect 8@Component 9public class PermissionAspect { 10 11 @Around(\u0026#34;@annotation(requirePermission)\u0026#34;) 12 public Object checkPermission(ProceedingJoinPoint joinPoint, RequirePermission requirePermission) throws Throwable { 13 String permission = requirePermission.value(); 14 User user = UserContext.getUser(); 15 16 if (!user.hasPermission(permission)) { 17 throw new PermissionDeniedException(\u0026#34;æ— æƒé™è®¿é—®\u0026#34;); 18 } 19 20 return joinPoint.proceed(); 21 } 22} 23 24// ä½¿ç”¨ 25@Service 26public class UserService { 27 28 @RequirePermission(\u0026#34;user:delete\u0026#34;) 29 public void deleteUser(Long userId) { 30 // ä¸šåŠ¡é€»è¾‘ 31 } 32} æ€»ç»“ä¸æ€è€ƒ Spring AOP çš„æ ¸å¿ƒæ˜¯åŠ¨æ€ä»£ç†ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡åœ¨ç›®æ ‡æ–¹æ³•å‰åæ’å…¥æ¨ªåˆ‡é€»è¾‘ã€‚\nJDK åŠ¨æ€ä»£ç†åŸºäºæ¥å£ï¼ŒCGLIB ä»£ç†åŸºäºç»§æ‰¿ ProxyFactory è´Ÿè´£åˆ›å»ºä»£ç†å¯¹è±¡ å¤šä¸ªåˆ‡é¢é€šè¿‡è´£ä»»é“¾æ¨¡å¼ä¸²è”æ‰§è¡Œ ç†è§£ AOP çš„å®ç°åŸç†ï¼Œæ‰èƒ½æ›´å¥½åœ°ä½¿ç”¨å®ƒï¼Œé¿å…è¸©å‘ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹æ—¶ï¼Œä¸å¦¨è¯•è¯• AOPï¼Œè®©ä»£ç æ›´åŠ ä¼˜é›…ã€‚\n","permalink":"http://localhost:1313/posts/2024/04/spring-aop-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eAOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡ AOPï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰ä»ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ä½† AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæœ¬æ–‡æ·±å…¥å‰–æ Spring AOP çš„åº•å±‚æœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ AOP çš„æ ¸å¿ƒæ¦‚å¿µï¼šåˆ‡é¢ã€åˆ‡ç‚¹ã€é€šçŸ¥ã€è¿æ¥ç‚¹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ JDK åŠ¨æ€ä»£ç†ä¸ CGLIB ä»£ç†çš„å®ç°åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼š ProxyFactory çš„åˆ›å»ºæµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ‡é¢æ‰§è¡Œé¡ºåºä¸è´£ä»»é“¾æ¨¡å¼\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"aop-æ ¸å¿ƒæ¦‚å¿µ\"\u003eAOP æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ‡é¢ï¼ˆAspectï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–ï¼Œæ¯”å¦‚æ—¥å¿—åˆ‡é¢ã€äº‹åŠ¡åˆ‡é¢ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Aspect\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Component\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eLogAspect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Before\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003elogBefore\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eJoinPoint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ejoinPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æ–¹æ³•æ‰§è¡Œå‰: {}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ejoinPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetSignature\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003egetName\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ‡ç‚¹ï¼ˆPointcutï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå®šä¹‰åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨é€šçŸ¥ï¼Œé€šè¿‡è¡¨è¾¾å¼åŒ¹é…ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Pointcut\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eserviceLayer\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eé€šçŸ¥ï¼ˆAdviceï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨åˆ‡ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼Œåˆ†ä¸ºäº”ç§ç±»å‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e@Beforeï¼šå‰ç½®é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@Afterï¼šåç½®é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@AfterReturningï¼šè¿”å›é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@Aroundï¼šç¯ç»•é€šçŸ¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eè¿æ¥ç‚¹ï¼ˆJoinPointï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç¨‹åºæ‰§è¡Œçš„æŸä¸ªç‚¹ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"jdk-åŠ¨æ€ä»£ç†-vs-cglib-ä»£ç†\"\u003eJDK åŠ¨æ€ä»£ç† vs CGLIB ä»£ç†\u003c/h2\u003e\n\u003cp\u003eSpring AOP ä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼š\u003c/p\u003e","title":"Spring AOP åŸç†ä¸åŠ¨æ€ä»£ç†å®ç°æ·±åº¦è§£æ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªæ¥å£å¾€å¾€éœ€è¦è°ƒç”¨å¤šä¸ªä¸‹æ¸¸æœåŠ¡ã€‚å¦‚æœä¸²è¡Œè°ƒç”¨ï¼Œå“åº”æ—¶é—´ä¼šç´¯åŠ ï¼›å¦‚æœç”¨ä¼ ç»Ÿçš„ Futureï¼Œä»£ç ä¼šå˜å¾—å¤æ‚éš¾ç»´æŠ¤ã€‚CompletableFuture æä¾›äº†ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ CompletableFuture çš„é“¾å¼è°ƒç”¨ä¸ç»„åˆæ“ä½œ å­¦ä¼šå¼‚å¸¸å¤„ç†ä¸è¶…æ—¶æ§åˆ¶ ç†è§£ä¸çº¿ç¨‹æ± çš„é…åˆä½¿ç”¨ äº†è§£å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ ä¼ ç»Ÿ Future çš„ç—›ç‚¹ JDK 1.5 å¼•å…¥çš„ Future æ¥å£åªèƒ½é€šè¿‡ get() æ–¹æ³•é˜»å¡ç­‰å¾…ç»“æœï¼š\n1ExecutorService executor = Executors.newFixedThreadPool(10); 2 3Future\u0026lt;String\u0026gt; future = executor.submit(() -\u0026gt; { 4 Thread.sleep(1000); 5 return \u0026#34;Hello\u0026#34;; 6}); 7 8// é˜»å¡ç­‰å¾…ç»“æœ 9String result = future.get(); é—®é¢˜ï¼š\nget() ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ— æ³•å¼‚æ­¥å¤„ç†ç»“æœ æ— æ³•ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ å¼‚å¸¸å¤„ç†ä¸æ–¹ä¾¿ CompletableFuture è§£å†³äº†è¿™äº›é—®é¢˜ã€‚\nCompletableFuture åŸºç¡€ç”¨æ³• åˆ›å»º CompletableFuture\n1// æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨å®Œæˆ 2CompletableFuture\u0026lt;String\u0026gt; future = new CompletableFuture\u0026lt;\u0026gt;(); 3future.complete(\u0026#34;Hello\u0026#34;); 4 5// æ–¹å¼äºŒï¼šå¼‚æ­¥æ‰§è¡Œ 6CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 7 return \u0026#34;Hello\u0026#34;; 8}); 9 10// æ–¹å¼ä¸‰ï¼šæ— è¿”å›å€¼çš„å¼‚æ­¥æ‰§è¡Œ 11CompletableFuture\u0026lt;Void\u0026gt; future = CompletableFuture.runAsync(() -\u0026gt; { 12 System.out.println(\u0026#34;Hello\u0026#34;); 13}); è·å–ç»“æœ\n1// é˜»å¡ç­‰å¾…ï¼ˆä¸æ¨èï¼‰ 2String result = future.get(); 3 4// é˜»å¡ç­‰å¾…ï¼Œå¸¦è¶…æ—¶ 5String result = future.get(1, TimeUnit.SECONDS); 6 7// éé˜»å¡è·å–ï¼Œå¦‚æœæœªå®Œæˆè¿”å›é»˜è®¤å€¼ 8String result = future.getNow(\u0026#34;default\u0026#34;); 9 10// é˜»å¡ç­‰å¾…ï¼Œä¸æŠ›å‡ºå—æ£€å¼‚å¸¸ 11String result = future.join(); é“¾å¼è°ƒç”¨ï¼šä¼˜é›…çš„å¼‚æ­¥æµæ°´çº¿ thenApplyï¼šè½¬æ¢ç»“æœ\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenApply(s -\u0026gt; { 4 return s + \u0026#34; World\u0026#34;; 5}).thenApply(s -\u0026gt; { 6 return s.toUpperCase(); 7}); 8 9System.out.println(future.join()); // HELLO WORLD thenAcceptï¼šæ¶ˆè´¹ç»“æœ\n1CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenAccept(s -\u0026gt; { 4 System.out.println(s); // ä¸è¿”å›ç»“æœ 5}); thenRunï¼šæ‰§è¡Œåç»­æ“ä½œ\n1CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenRun(() -\u0026gt; { 4 System.out.println(\u0026#34;Done\u0026#34;); // ä¸å…³å¿ƒå‰é¢çš„ç»“æœ 5}); thenComposeï¼šæ‰å¹³åŒ–åµŒå¥—çš„ CompletableFuture\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;user123\u0026#34;; 3}).thenCompose(userId -\u0026gt; { 4 // æ ¹æ® userId æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆè¿”å› CompletableFutureï¼‰ 5 return getUserInfo(userId); 6}); 7 8CompletableFuture\u0026lt;User\u0026gt; getUserInfo(String userId) { 9 return CompletableFuture.supplyAsync(() -\u0026gt; { 10 return userMapper.selectById(userId); 11 }); 12} æ¶æ„æ€è€ƒï¼š thenApply å’Œ thenCompose çš„åŒºåˆ«ç±»ä¼¼äº Stream çš„ map å’Œ flatMapã€‚thenApply ç”¨äºç®€å•çš„è½¬æ¢ï¼ŒthenCompose ç”¨äºæ‰å¹³åŒ–åµŒå¥—çš„å¼‚æ­¥æ“ä½œã€‚\nç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ thenCombineï¼šåˆå¹¶ä¸¤ä¸ªä»»åŠ¡çš„ç»“æœ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}); 4 5CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; { 6 return \u0026#34;World\u0026#34;; 7}); 8 9CompletableFuture\u0026lt;String\u0026gt; result = future1.thenCombine(future2, (s1, s2) -\u0026gt; { 10 return s1 + \u0026#34; \u0026#34; + s2; 11}); 12 13System.out.println(result.join()); // Hello World allOfï¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task1\u0026#34;); 2CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task2\u0026#34;); 3CompletableFuture\u0026lt;String\u0026gt; future3 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task3\u0026#34;); 4 5CompletableFuture\u0026lt;Void\u0026gt; allFutures = CompletableFuture.allOf(future1, future2, future3); 6 7// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ 8allFutures.join(); 9 10// è·å–æ‰€æœ‰ç»“æœ 11List\u0026lt;String\u0026gt; results = Stream.of(future1, future2, future3) 12 .map(CompletableFuture::join) 13 .collect(Collectors.toList()); anyOfï¼šç­‰å¾…ä»»æ„ä¸€ä¸ªä»»åŠ¡å®Œæˆ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(1000); 3 return \u0026#34;Task1\u0026#34;; 4}); 5 6CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; { 7 Thread.sleep(500); 8 return \u0026#34;Task2\u0026#34;; 9}); 10 11CompletableFuture\u0026lt;Object\u0026gt; anyFuture = CompletableFuture.anyOf(future1, future2); 12 13System.out.println(anyFuture.join()); // Task2ï¼ˆå…ˆå®Œæˆçš„ï¼‰ å®æˆ˜æ¡ˆä¾‹ï¼šå¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡ å‡è®¾ä¸€ä¸ªå•†å“è¯¦æƒ…é¡µéœ€è¦è°ƒç”¨ä¸‰ä¸ªæœåŠ¡ï¼š\nå•†å“æœåŠ¡ï¼šæŸ¥è¯¢å•†å“ä¿¡æ¯ åº“å­˜æœåŠ¡ï¼šæŸ¥è¯¢åº“å­˜ è¯„è®ºæœåŠ¡ï¼šæŸ¥è¯¢è¯„è®º ä¸²è¡Œè°ƒç”¨ï¼ˆæ…¢ï¼‰\n1public ProductDetailDTO getProductDetail(Long productId) { 2 Product product = productService.getProduct(productId); // 100ms 3 Stock stock = stockService.getStock(productId); // 100ms 4 List\u0026lt;Comment\u0026gt; comments = commentService.getComments(productId); // 100ms 5 6 return ProductDetailDTO.builder() 7 .product(product) 8 .stock(stock) 9 .comments(comments) 10 .build(); 11} 12// æ€»è€—æ—¶ï¼š300ms å¹¶è¡Œè°ƒç”¨ï¼ˆå¿«ï¼‰\n1public ProductDetailDTO getProductDetail(Long productId) { 2 CompletableFuture\u0026lt;Product\u0026gt; productFuture = CompletableFuture.supplyAsync(() -\u0026gt; 3 productService.getProduct(productId) 4 ); 5 6 CompletableFuture\u0026lt;Stock\u0026gt; stockFuture = CompletableFuture.supplyAsync(() -\u0026gt; 7 stockService.getStock(productId) 8 ); 9 10 CompletableFuture\u0026lt;List\u0026lt;Comment\u0026gt;\u0026gt; commentsFuture = CompletableFuture.supplyAsync(() -\u0026gt; 11 commentService.getComments(productId) 12 ); 13 14 // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ 15 CompletableFuture.allOf(productFuture, stockFuture, commentsFuture).join(); 16 17 return ProductDetailDTO.builder() 18 .product(productFuture.join()) 19 .stock(stockFuture.join()) 20 .comments(commentsFuture.join()) 21 .build(); 22} 23// æ€»è€—æ—¶ï¼š100msï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰ æ€§èƒ½æå‡ï¼šä» 300ms é™ä½åˆ° 100msã€‚\nå¼‚å¸¸å¤„ç† exceptionallyï¼šæ•è·å¼‚å¸¸å¹¶è¿”å›é»˜è®¤å€¼\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 if (Math.random() \u0026gt; 0.5) { 3 throw new RuntimeException(\u0026#34;Error\u0026#34;); 4 } 5 return \u0026#34;Success\u0026#34;; 6}).exceptionally(ex -\u0026gt; { 7 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 8 return \u0026#34;Default\u0026#34;; 9}); handleï¼šåŒæ—¶å¤„ç†æ­£å¸¸ç»“æœå’Œå¼‚å¸¸\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 if (Math.random() \u0026gt; 0.5) { 3 throw new RuntimeException(\u0026#34;Error\u0026#34;); 4 } 5 return \u0026#34;Success\u0026#34;; 6}).handle((result, ex) -\u0026gt; { 7 if (ex != null) { 8 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 9 return \u0026#34;Default\u0026#34;; 10 } 11 return result; 12}); whenCompleteï¼šä¸æ”¹å˜ç»“æœï¼Œåªåšå‰¯ä½œç”¨æ“ä½œ\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Success\u0026#34;; 3}).whenComplete((result, ex) -\u0026gt; { 4 if (ex != null) { 5 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 6 } else { 7 log.info(\u0026#34;ç»“æœ: {}\u0026#34;, result); 8 } 9}); é¿å‘æç¤ºï¼š exceptionally å’Œ handle ä¼šæ”¹å˜ CompletableFuture çš„ç»“æœï¼Œè€Œ whenComplete ä¸ä¼šã€‚é€‰æ‹©å“ªä¸ªå–å†³äºä½ æ˜¯å¦éœ€è¦æ”¹å˜ç»“æœã€‚\nè¶…æ—¶æ§åˆ¶ JDK 9 å¼•å…¥äº†è¶…æ—¶æ§åˆ¶æ–¹æ³•ï¼š\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(2000); 3 return \u0026#34;Success\u0026#34;; 4}).orTimeout(1, TimeUnit.SECONDS) // è¶…æ—¶æŠ›å‡º TimeoutException 5 .exceptionally(ex -\u0026gt; { 6 return \u0026#34;Timeout\u0026#34;; 7 }); JDK 8 å¯ä»¥é€šè¿‡ CompletableFuture.anyOf å®ç°ï¼š\n1CompletableFuture\u0026lt;String\u0026gt; taskFuture = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(2000); 3 return \u0026#34;Success\u0026#34;; 4}); 5 6CompletableFuture\u0026lt;String\u0026gt; timeoutFuture = new CompletableFuture\u0026lt;\u0026gt;(); 7scheduler.schedule(() -\u0026gt; { 8 timeoutFuture.completeExceptionally(new TimeoutException()); 9}, 1, TimeUnit.SECONDS); 10 11CompletableFuture\u0026lt;String\u0026gt; result = (CompletableFuture\u0026lt;String\u0026gt;) CompletableFuture.anyOf( 12 taskFuture, timeoutFuture 13); ä¸çº¿ç¨‹æ± çš„é…åˆ é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompletableFuture ä½¿ç”¨ ForkJoinPool.commonPool()ï¼Œçº¿ç¨‹æ•°ç­‰äº CPU æ ¸å¿ƒæ•°ã€‚\nå¯¹äº IO å¯†é›†å‹ä»»åŠ¡ï¼Œåº”è¯¥ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š\n1ExecutorService executor = Executors.newFixedThreadPool(20); 2 3CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 4 // IO å¯†é›†å‹ä»»åŠ¡ 5 return httpClient.get(url); 6}, executor); æ³¨æ„äº‹é¡¹\nä¸åŒç±»å‹çš„ä»»åŠ¡ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼ˆCPU å¯†é›†å‹ vs IO å¯†é›†å‹ï¼‰ çº¿ç¨‹æ± è¦åˆç†é…ç½®å¤§å°ï¼Œé¿å…èµ„æºè€—å°½ åº”ç”¨å…³é—­æ—¶è¦ä¼˜é›…åœ°å…³é—­çº¿ç¨‹æ±  1@PreDestroy 2public void shutdown() { 3 executor.shutdown(); 4 try { 5 if (!executor.awaitTermination(60, TimeUnit.SECONDS)) { 6 executor.shutdownNow(); 7 } 8 } catch (InterruptedException e) { 9 executor.shutdownNow(); 10 } 11} æœ€ä½³å®è·µ 1. é¿å…é˜»å¡æ“ä½œ\nä¸è¦åœ¨ CompletableFuture çš„å›è°ƒä¸­æ‰§è¡Œé˜»å¡æ“ä½œï¼Œä¼šå ç”¨çº¿ç¨‹æ± èµ„æºã€‚\n1// ä¸å¥½ï¼šé˜»å¡æ“ä½œ 2CompletableFuture.supplyAsync(() -\u0026gt; { 3 Thread.sleep(1000); // é˜»å¡çº¿ç¨‹ 4 return \u0026#34;Result\u0026#34;; 5}); 6 7// å¥½ï¼šä½¿ç”¨å¼‚æ­¥ API 8CompletableFuture.supplyAsync(() -\u0026gt; { 9 return asyncHttpClient.get(url).join(); 10}); 2. åˆç†è®¾ç½®è¶…æ—¶\né¿å…ä»»åŠ¡æ— é™ç­‰å¾…ï¼Œå¯¼è‡´èµ„æºæ³„æ¼ã€‚\n3. å¼‚å¸¸å¤„ç†è¦å®Œå–„\nç¡®ä¿æ¯ä¸ª CompletableFuture éƒ½æœ‰å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œé¿å…å¼‚å¸¸è¢«åæ‰ã€‚\n4. é¿å…è¿‡åº¦å¹¶è¡Œ\nå¹¶è¡Œä»»åŠ¡æ•°ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè¦æ ¹æ®ç³»ç»Ÿèµ„æºå’Œä¸‹æ¸¸æœåŠ¡çš„æ‰¿è½½èƒ½åŠ›è°ƒæ•´ã€‚\næ€»ç»“ä¸æ€è€ƒ CompletableFuture æ˜¯ Java å¼‚æ­¥ç¼–ç¨‹çš„åˆ©å™¨ï¼Œå®ƒæä¾›äº†ï¼š\né“¾å¼è°ƒç”¨ï¼šä¼˜é›…çš„å¼‚æ­¥æµæ°´çº¿ ç»„åˆæ“ä½œï¼šçµæ´»çš„ä»»åŠ¡ç¼–æ’ å¼‚å¸¸å¤„ç†ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ çº¿ç¨‹æ± é›†æˆï¼šé«˜æ•ˆçš„èµ„æºåˆ©ç”¨ æŒæ¡ CompletableFutureï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å’Œä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡æ—¶ï¼Œä¸å¦¨è¯•è¯• CompletableFutureï¼Œä½“éªŒå¼‚æ­¥ç¼–ç¨‹çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/03/completablefuture-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªæ¥å£å¾€å¾€éœ€è¦è°ƒç”¨å¤šä¸ªä¸‹æ¸¸æœåŠ¡ã€‚å¦‚æœä¸²è¡Œè°ƒç”¨ï¼Œå“åº”æ—¶é—´ä¼šç´¯åŠ ï¼›å¦‚æœç”¨ä¼ ç»Ÿçš„ Futureï¼Œä»£ç ä¼šå˜å¾—å¤æ‚éš¾ç»´æŠ¤ã€‚CompletableFuture æä¾›äº†ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ CompletableFuture çš„é“¾å¼è°ƒç”¨ä¸ç»„åˆæ“ä½œ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šå¼‚å¸¸å¤„ç†ä¸è¶…æ—¶æ§åˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¸çº¿ç¨‹æ± çš„é…åˆä½¿ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¼ ç»Ÿ-future-çš„ç—›ç‚¹\"\u003eä¼ ç»Ÿ Future çš„ç—›ç‚¹\u003c/h2\u003e\n\u003cp\u003eJDK 1.5 å¼•å…¥çš„ Future æ¥å£åªèƒ½é€šè¿‡ get() æ–¹æ³•é˜»å¡ç­‰å¾…ç»“æœï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eExecutorService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eExecutors\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003enewFixedThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esubmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// é˜»å¡ç­‰å¾…ç»“æœ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eget() ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ— æ³•å¼‚æ­¥å¤„ç†ç»“æœ\u003c/li\u003e\n\u003cli\u003eæ— æ³•ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡\u003c/li\u003e\n\u003cli\u003eå¼‚å¸¸å¤„ç†ä¸æ–¹ä¾¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eCompletableFuture è§£å†³äº†è¿™äº›é—®é¢˜ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"completablefuture-åŸºç¡€ç”¨æ³•\"\u003eCompletableFuture åŸºç¡€ç”¨æ³•\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ›å»º CompletableFuture\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨å®Œæˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecomplete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼äºŒï¼šå¼‚æ­¥æ‰§è¡Œ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esupplyAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼ä¸‰ï¼šæ— è¿”å›å€¼çš„å¼‚æ­¥æ‰§è¡Œ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eVoid\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erunAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eè·å–ç»“æœ\u003c/strong\u003e\u003c/p\u003e","title":"CompletableFuture å¼‚æ­¥ç¼–ç¨‹å®æˆ˜æŒ‡å—"},{"content":"åœ¨ç”µå•†ä¸šåŠ¡é«˜é€Ÿå‘å±•çš„èƒŒæ™¯ä¸‹ï¼Œæ‹¼å›¢æ¨¡å¼å› å…¶ç¤¾äº¤è£‚å˜å±æ€§æˆä¸ºæµé‡å¢é•¿çš„åˆ©å™¨ã€‚ä½†çœ‹ä¼¼ç®€å•çš„\u0026quot;å‡‘å¤Ÿ N äººæˆå›¢\u0026quot;èƒŒåï¼Œéšè—ç€åº“å­˜è¶…å–ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€æµ·é‡æ•°æ®å­˜å‚¨ç­‰ä¸€ç³»åˆ—æŠ€æœ¯æŒ‘æˆ˜ã€‚æœ¬æ–‡å¤ç›˜æˆ‘åœ¨æ‹¼å›¢äº¤æ˜“å¹³å°é¡¹ç›®ä¸­çš„æ¶æ„è®¾è®¡ä¸æŠ€æœ¯é€‰å‹æ€è€ƒã€‚\né¡¹ç›®äº®ç‚¹ åŸºäº DDD æ€æƒ³çš„é¢†åŸŸæ¨¡å‹è®¾è®¡ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦ Redis åˆ†å¸ƒå¼é” + åˆ†åº“åˆ†è¡¨è§£å†³é«˜å¹¶å‘åº“å­˜æ‰£å‡é—®é¢˜ RabbitMQ å¼‚æ­¥è§£è€¦å®ç°å•æ­¥æµæ°´çº¿ï¼Œæå‡ç³»ç»Ÿååé‡ ShardingSphere åˆ†åº“åˆ†è¡¨æ”¯æ’‘æµ·é‡è®¢å•æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢ ä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜ æ‹¼å›¢äº¤æ˜“çš„æ ¸å¿ƒæµç¨‹çœ‹ä¼¼ç®€å•ï¼šç”¨æˆ·å‘èµ·æ‹¼å›¢ â†’ å…¶ä»–ç”¨æˆ·å‚å›¢ â†’ è¾¾åˆ°äººæ•°åæˆå›¢ â†’ æ‰£å‡åº“å­˜ â†’ é€šçŸ¥æ”¯ä»˜ã€‚ä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªæµç¨‹ä¼šé‡åˆ°ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\nåº“å­˜è¶…å–ï¼š 100 ä»¶å•†å“ï¼Œ1000 äººåŒæ—¶ä¸‹å•ï¼Œå¦‚ä½•ä¿è¯ä¸ä¼šè¶…å–ï¼Ÿä¼ ç»Ÿçš„æ•°æ®åº“è¡Œé”åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤±æ•ˆã€‚\nåˆ†å¸ƒå¼äº‹åŠ¡ï¼š è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡ã€æ”¯ä»˜é€šçŸ¥åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\næµ·é‡æ•°æ®ï¼š è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚ä½•ä¿è¯æŸ¥è¯¢æ€§èƒ½ä¸éšæ•°æ®é‡å¢é•¿è€ŒåŠ£åŒ–ï¼Ÿ\nè¿™äº›é—®é¢˜å€’é€¼æˆ‘ä»¬å¿…é¡»ä»æ¶æ„å±‚é¢é‡æ–°æ€è€ƒç³»ç»Ÿè®¾è®¡ã€‚\næ¶æ„è®¾è®¡ï¼šDDD æ€æƒ³çš„è½åœ°å®è·µ ä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹ä¼šå¯¼è‡´ Service å±‚é€»è¾‘è‡ƒè‚¿ï¼Œä¸šåŠ¡è§„åˆ™æ•£è½åœ¨å„å¤„ã€‚æˆ‘ä»¬é‡‡ç”¨ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ€æƒ³ï¼Œå°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒé¢†åŸŸï¼š\nè®¢å•åŸŸï¼ˆOrderï¼‰ï¼š è´Ÿè´£æ‹¼å›¢è®¢å•çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€çŠ¶æ€æµè½¬ã€è¶…æ—¶å–æ¶ˆç­‰ã€‚\nåº“å­˜åŸŸï¼ˆInventoryï¼‰ï¼š è´Ÿè´£å•†å“åº“å­˜çš„æ‰£å‡ã€å›æ»šã€é¢„å ç­‰æ“ä½œï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒç“¶é¢ˆã€‚\næ”¯ä»˜åŸŸï¼ˆPaymentï¼‰ï¼š è´Ÿè´£æ”¯ä»˜æµç¨‹çš„ç¼–æ’ï¼ŒåŒ…æ‹¬æ”¯ä»˜é€šçŸ¥ã€é€€æ¬¾å¤„ç†ç­‰ã€‚\næ¯ä¸ªé¢†åŸŸéƒ½æœ‰è‡ªå·±çš„èšåˆæ ¹ï¼ˆAggregate Rootï¼‰å’Œé¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰ã€‚æ¯”å¦‚è®¢å•åŸŸçš„èšåˆæ ¹æ˜¯ Orderï¼Œå®ƒå°è£…äº†è®¢å•çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™ï¼š\n1public class Order { 2 private OrderId id; 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 // ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰å¾…æ”¯ä»˜çŠ¶æ€æ‰èƒ½å–æ¶ˆ 8 public void cancel() { 9 if (this.status != OrderStatus.PENDING_PAYMENT) { 10 throw new OrderCannotCancelException(); 11 } 12 this.status = OrderStatus.CANCELLED; 13 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼šè®¢å•å·²å–æ¶ˆ 14 DomainEventPublisher.publish(new OrderCancelledEvent(this.id)); 15 } 16} è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šä¸šåŠ¡è§„åˆ™å†…èšåœ¨é¢†åŸŸå¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨ Service å±‚çš„å„ç§ if-else é‡Œã€‚å½“äº§å“ç»ç†è¯´\u0026quot;å¢åŠ ä¸€ä¸ªæ‹¼å›¢å¤±è´¥è‡ªåŠ¨é€€æ¬¾çš„é€»è¾‘\u0026quot;æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç›‘å¬ OrderCancelledEvent äº‹ä»¶ï¼Œè€Œä¸éœ€è¦æ”¹åŠ¨è®¢å•å–æ¶ˆçš„æ ¸å¿ƒé€»è¾‘ã€‚\næ¶æ„æ€è€ƒï¼š DDD çš„æœ¬è´¨æ˜¯\u0026quot;ç”¨ä»£ç è¡¨è¾¾ä¸šåŠ¡è¯­è¨€\u0026quot;ã€‚å½“ä½ çš„ä»£ç ä¸­å‡ºç° Order.cancel() è€Œä¸æ˜¯ orderService.updateStatus(orderId, 3)ï¼Œä¸šåŠ¡äººå‘˜ä¹Ÿèƒ½çœ‹æ‡‚ä»£ç åœ¨åšä»€ä¹ˆã€‚è¿™ç§\u0026quot;é€šç”¨è¯­è¨€\u0026quot;ï¼ˆUbiquitous Languageï¼‰æ˜¯ DDD æœ€å¤§çš„ä»·å€¼ã€‚\næ ¸å¿ƒéš¾ç‚¹ï¼šåˆ†å¸ƒå¼é”è§£å†³åº“å­˜è¶…å– åº“å­˜æ‰£å‡æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚æœ€ç®€å•çš„æ–¹æ¡ˆæ˜¯åœ¨æ•°æ®åº“å±‚é¢åŠ è¡Œé”ï¼š\n1UPDATE inventory SET stock = stock - 1 WHERE product_id = ? AND stock \u0026gt; 0 ä½†è¿™ç§æ–¹æ¡ˆåœ¨é«˜å¹¶å‘ä¸‹ä¼šå¯¼è‡´å¤§é‡çº¿ç¨‹é˜»å¡åœ¨æ•°æ®åº“é”ä¸Šï¼ŒTPS ä¸Šä¸å»ã€‚æˆ‘ä»¬çš„ä¼˜åŒ–æ€è·¯æ˜¯ï¼šç”¨ Redis åˆ†å¸ƒå¼é” + é¢„æ‰£å‡æœºåˆ¶ã€‚\nç¬¬ä¸€æ­¥ï¼šRedis é¢„æ‰£å‡\nç”¨æˆ·ä¸‹å•æ—¶ï¼Œå…ˆåœ¨ Redis ä¸­æ‰£å‡åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰ï¼š\n1public boolean preDeductStock(String productId, int quantity) { 2 String key = \u0026#34;stock:\u0026#34; + productId; 3 Long remaining = redisTemplate.opsForValue().decrement(key, quantity); 4 return remaining != null \u0026amp;\u0026amp; remaining \u0026gt;= 0; 5} å¦‚æœ Redis æ‰£å‡æˆåŠŸï¼Œè¯´æ˜æœ‰åº“å­˜ï¼Œå…è®¸åˆ›å»ºè®¢å•ã€‚å¦‚æœå¤±è´¥ï¼Œç›´æ¥è¿”å›\u0026quot;åº“å­˜ä¸è¶³\u0026quot;ï¼Œä¸éœ€è¦è®¿é—®æ•°æ®åº“ã€‚\nç¬¬äºŒæ­¥ï¼šå¼‚æ­¥åŒæ­¥åˆ°æ•°æ®åº“\né€šè¿‡ RabbitMQ å‘é€æ¶ˆæ¯ï¼Œå¼‚æ­¥å°†åº“å­˜å˜æ›´åŒæ­¥åˆ° MySQLï¼š\n1rabbitTemplate.convertAndSend(\u0026#34;inventory.exchange\u0026#34;, \u0026#34;stock.deduct\u0026#34;, 2 new StockDeductMessage(productId, quantity, orderId)); æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯ï¼Œæ›´æ–°æ•°æ®åº“åº“å­˜ï¼š\n1@RabbitListener(queues = \u0026#34;stock.deduct.queue\u0026#34;) 2public void handleStockDeduct(StockDeductMessage msg) { 3 inventoryMapper.deductStock(msg.getProductId(), msg.getQuantity()); 4} ç¬¬ä¸‰æ­¥ï¼šRedisson çœ‹é—¨ç‹—æœºåˆ¶\nä¸ºäº†é˜²æ­¢ Redis å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬ç”¨ Redisson çš„åˆ†å¸ƒå¼é”ä¿æŠ¤æ•´ä¸ªæ‰£å‡æµç¨‹ï¼š\n1RLock lock = redisson.getLock(\u0026#34;lock:stock:\u0026#34; + productId); 2try { 3 lock.lock(10, TimeUnit.SECONDS); 4 // æ‰§è¡Œæ‰£å‡é€»è¾‘ 5} finally { 6 lock.unlock(); 7} Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶ä¼šè‡ªåŠ¨ç»­æœŸé”ï¼Œé¿å…ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”æå‰é‡Šæ”¾ã€‚\né¿å‘æç¤ºï¼š Redis é¢„æ‰£å‡æ–¹æ¡ˆæœ‰ä¸ªéšæ‚£ï¼šå¦‚æœè®¢å•è¶…æ—¶æœªæ”¯ä»˜ï¼Œéœ€è¦å›æ»šåº“å­˜ã€‚è¿™æ—¶å¿…é¡»ä¿è¯ Redis å’Œæ•°æ®åº“çš„åº“å­˜æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚æˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šå®šæ—¶ä»»åŠ¡æ‰«æè¶…æ—¶è®¢å•ï¼ŒåŒæ—¶å›æ»š Redis å’Œæ•°æ®åº“åº“å­˜ã€‚\nå¼‚æ­¥è§£è€¦ï¼šRabbitMQ å•æ­¥æµæ°´çº¿è®¾è®¡ ä¼ ç»Ÿçš„åŒæ­¥è°ƒç”¨é“¾è·¯æ˜¯ï¼šåˆ›å»ºè®¢å• â†’ æ‰£å‡åº“å­˜ â†’ å‘é€æ”¯ä»˜é€šçŸ¥ã€‚å¦‚æœæ¯ä¸€æ­¥éƒ½åŒæ­¥ç­‰å¾…ï¼Œæ•´ä¸ªæ¥å£çš„ RTï¼ˆå“åº”æ—¶é—´ï¼‰ä¼šç´¯åŠ ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå·®ã€‚\næˆ‘ä»¬ç”¨ RabbitMQ å®ç°å¼‚æ­¥è§£è€¦ï¼š\nç”¨æˆ·ä¸‹å•åï¼Œç«‹å³è¿”å›\u0026quot;è®¢å•åˆ›å»ºæˆåŠŸ\u0026quot; å‘é€æ¶ˆæ¯åˆ° order.created é˜Ÿåˆ— åº“å­˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ï¼Œæ‰£å‡åº“å­˜åå‘é€ stock.deducted æ¶ˆæ¯ æ”¯ä»˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ï¼Œå‘é€æ”¯ä»˜é€šçŸ¥ è¿™ç§å•æ­¥æµæ°´çº¿è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šæ¯ä¸ªæœåŠ¡åªå…³å¿ƒè‡ªå·±çš„èŒè´£ï¼Œé€šè¿‡æ¶ˆæ¯é©±åŠ¨å®ç°æ¾è€¦åˆã€‚å¦‚æœåº“å­˜æœåŠ¡æŒ‚äº†ï¼Œæ¶ˆæ¯ä¼šå †ç§¯åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ¢å¤åè‡ªåŠ¨æ¶ˆè´¹ï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ã€‚\n1// è®¢å•æœåŠ¡ï¼šå‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶ 2@Transactional 3public void createOrder(OrderDTO dto) { 4 Order order = orderMapper.insert(dto); 5 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, 6 new OrderCreatedEvent(order.getId())); 7} 8 9// åº“å­˜æœåŠ¡ï¼šç›‘å¬è®¢å•åˆ›å»ºäº‹ä»¶ 10@RabbitListener(queues = \u0026#34;order.created.queue\u0026#34;) 11public void handleOrderCreated(OrderCreatedEvent event) { 12 inventoryService.deductStock(event.getOrderId()); 13 rabbitTemplate.convertAndSend(\u0026#34;inventory.exchange\u0026#34;, \u0026#34;stock.deducted\u0026#34;, 14 new StockDeductedEvent(event.getOrderId())); 15} æ¶æ„æ€è€ƒï¼š å¼‚æ­¥åŒ–çš„ä»£ä»·æ˜¯è°ƒè¯•å¤æ‚åº¦å¢åŠ ã€‚å½“è®¢å•åˆ›å»ºæˆåŠŸä½†åº“å­˜æ‰£å‡å¤±è´¥æ—¶ï¼Œå¦‚ä½•æ’æŸ¥é—®é¢˜ï¼Ÿæˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šæ¯æ¡æ¶ˆæ¯éƒ½å¸¦ä¸Š traceIdï¼Œé€šè¿‡æ—¥å¿—ç³»ç»Ÿä¸²è”æ•´ä¸ªè°ƒç”¨é“¾è·¯ã€‚\næµ·é‡æ•°æ®ï¼šShardingSphere åˆ†åº“åˆ†è¡¨å®æˆ˜ è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚æœä¸åšåˆ†åº“åˆ†è¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šéšç€æ•°æ®é‡å¢é•¿è€Œæ€¥å‰§ä¸‹é™ã€‚æˆ‘ä»¬ç”¨ ShardingSphere å®ç°æ°´å¹³åˆ†è¡¨ï¼š\nåˆ†ç‰‡ç­–ç•¥ï¼š æŒ‰ user_id å–æ¨¡åˆ† 16 å¼ è¡¨ï¼ˆt_order_0 ~ t_order_15ï¼‰\n1shardingRule: 2 tables: 3 t_order: 4 actualDataNodes: ds0.t_order_${0..15} 5 tableStrategy: 6 standard: 7 shardingColumn: user_id 8 shardingAlgorithmName: order_mod 9 shardingAlgorithms: 10 order_mod: 11 type: MOD 12 props: 13 sharding-count: 16 ä¸ºä»€ä¹ˆé€‰æ‹© user_id è€Œä¸æ˜¯ order_idï¼Ÿ\nå› ä¸ºå¤§éƒ¨åˆ†æŸ¥è¯¢åœºæ™¯æ˜¯\u0026quot;æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„è®¢å•åˆ—è¡¨\u0026quot;ï¼ŒæŒ‰ user_id åˆ†ç‰‡å¯ä»¥ä¿è¯å•ä¸ªç”¨æˆ·çš„è®¢å•éƒ½åœ¨åŒä¸€å¼ è¡¨ï¼Œé¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ã€‚\nè·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–ï¼š\nå¦‚æœéœ€è¦æŒ‰ order_id æŸ¥è¯¢ï¼ˆæ¯”å¦‚è®¢å•è¯¦æƒ…é¡µï¼‰ï¼Œä¼šè§¦å‘å…¨è¡¨æ‰«æã€‚æˆ‘ä»¬çš„ä¼˜åŒ–æ–¹æ¡ˆæ˜¯ï¼šåœ¨ Redis ä¸­ç»´æŠ¤ order_id -\u0026gt; user_id çš„æ˜ å°„å…³ç³»ï¼Œå…ˆæŸ¥ Redis è·å– user_idï¼Œå†ç²¾å‡†è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡ã€‚\n1public Order getOrderById(String orderId) { 2 // å…ˆä» Redis è·å– user_id 3 String userId = redisTemplate.opsForValue().get(\u0026#34;order:user:\u0026#34; + orderId); 4 if (userId != null) { 5 // ç²¾å‡†è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡ 6 return orderMapper.selectByOrderIdAndUserId(orderId, userId); 7 } 8 // é™çº§æ–¹æ¡ˆï¼šå…¨è¡¨æ‰«æ 9 return orderMapper.selectByOrderId(orderId); 10} é¿å‘æç¤ºï¼š åˆ†åº“åˆ†è¡¨åï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¼šå˜å¾—æ›´å¤æ‚ã€‚æˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šå°½é‡é¿å…è·¨åˆ†ç‰‡äº‹åŠ¡ï¼Œé€šè¿‡ä¸šåŠ¡è®¾è®¡ä¿è¯å•ä¸ªäº‹åŠ¡åªæ“ä½œä¸€ä¸ªåˆ†ç‰‡ã€‚å¦‚æœå®åœ¨éœ€è¦è·¨åˆ†ç‰‡ï¼Œä½¿ç”¨ Seata çš„ AT æ¨¡å¼ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚\né¡¹ç›®æˆæœä¸æ€è€ƒ ç»è¿‡ä¸‰ä¸ªæœˆçš„è¿­ä»£ï¼Œæ‹¼å›¢äº¤æ˜“å¹³å°æˆåŠŸä¸Šçº¿ï¼Œæ ¸å¿ƒæŒ‡æ ‡å¦‚ä¸‹ï¼š\nè®¢å•åˆ›å»ºæ¥å£ RT ä» 800ms é™ä½åˆ° 120ms åº“å­˜æ‰£å‡ TPS ä» 500 æå‡åˆ° 3000+ æ”¯æŒå•æ—¥ç™¾ä¸‡çº§è®¢å•æ•°æ®å†™å…¥ï¼ŒæŸ¥è¯¢æ€§èƒ½ç¨³å®šåœ¨ 50ms ä»¥å†… è¿™ä¸ªé¡¹ç›®æœ€å¤§çš„æ”¶è·ä¸æ˜¯æŠ€æœ¯æ ˆçš„å †ç Œï¼Œè€Œæ˜¯å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„æ·±åº¦ç†è§£ï¼š\næ²¡æœ‰é“¶å¼¹ï¼š Redis åˆ†å¸ƒå¼é”ã€RabbitMQ å¼‚æ­¥ã€ShardingSphere åˆ†åº“åˆ†è¡¨ï¼Œæ¯ä¸ªæŠ€æœ¯æ–¹æ¡ˆéƒ½æœ‰é€‚ç”¨åœºæ™¯å’Œä»£ä»·ã€‚é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆçš„æœ¬è´¨æ˜¯åœ¨æ€§èƒ½ã€ä¸€è‡´æ€§ã€å¤æ‚åº¦ä¹‹é—´åšæƒè¡¡ã€‚\næ¶æ„æ¼”è¿›ï¼š ç³»ç»Ÿä¸æ˜¯ä¸€å¼€å§‹å°±è®¾è®¡æˆåˆ†å¸ƒå¼çš„ã€‚æˆ‘ä»¬æœ€åˆæ˜¯å•ä½“åº”ç”¨ + MySQL ä¸»ä»ï¼Œå½“ TPS åˆ°è¾¾ç“¶é¢ˆåæ‰å¼•å…¥ Redis å’Œ RabbitMQã€‚è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚\nå¯è§‚æµ‹æ€§ï¼š åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤§çš„æŒ‘æˆ˜æ˜¯æ’æŸ¥é—®é¢˜ã€‚æˆ‘ä»¬åœ¨æ¯ä¸ªå…³é”®èŠ‚ç‚¹éƒ½åŸ‹ç‚¹ä¸ŠæŠ¥ç›‘æ§æ•°æ®ï¼ˆè®¢å•åˆ›å»ºæ•°ã€åº“å­˜æ‰£å‡æ•°ã€æ¶ˆæ¯å †ç§¯æ•°ï¼‰ï¼Œé€šè¿‡ Grafana å®æ—¶ç›‘æ§ç³»ç»Ÿå¥åº·åº¦ã€‚\nå¦‚æœè®©æˆ‘é‡æ–°è®¾è®¡è¿™ä¸ªç³»ç»Ÿï¼Œæˆ‘ä¼šåœ¨é¡¹ç›®åˆæœŸå°±å¼•å…¥å…¨é“¾è·¯å‹æµ‹ï¼Œæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆï¼Œè€Œä¸æ˜¯ç­‰åˆ°ä¸Šçº¿åæ‰å‘ç°é—®é¢˜ã€‚\n","permalink":"http://localhost:1313/projects/pindan-trading-platform/","summary":"\u003cp\u003eåœ¨ç”µå•†ä¸šåŠ¡é«˜é€Ÿå‘å±•çš„èƒŒæ™¯ä¸‹ï¼Œæ‹¼å›¢æ¨¡å¼å› å…¶ç¤¾äº¤è£‚å˜å±æ€§æˆä¸ºæµé‡å¢é•¿çš„åˆ©å™¨ã€‚ä½†çœ‹ä¼¼ç®€å•çš„\u0026quot;å‡‘å¤Ÿ N äººæˆå›¢\u0026quot;èƒŒåï¼Œéšè—ç€åº“å­˜è¶…å–ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€æµ·é‡æ•°æ®å­˜å‚¨ç­‰ä¸€ç³»åˆ—æŠ€æœ¯æŒ‘æˆ˜ã€‚æœ¬æ–‡å¤ç›˜æˆ‘åœ¨æ‹¼å›¢äº¤æ˜“å¹³å°é¡¹ç›®ä¸­çš„æ¶æ„è®¾è®¡ä¸æŠ€æœ¯é€‰å‹æ€è€ƒã€‚\u003c/p\u003e\n\u003ch3 id=\"é¡¹ç›®äº®ç‚¹\"\u003eé¡¹ç›®äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e åŸºäº DDD æ€æƒ³çš„é¢†åŸŸæ¨¡å‹è®¾è®¡ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e Redis åˆ†å¸ƒå¼é” + åˆ†åº“åˆ†è¡¨è§£å†³é«˜å¹¶å‘åº“å­˜æ‰£å‡é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e RabbitMQ å¼‚æ­¥è§£è€¦å®ç°å•æ­¥æµæ°´çº¿ï¼Œæå‡ç³»ç»Ÿååé‡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ShardingSphere åˆ†åº“åˆ†è¡¨æ”¯æ’‘æµ·é‡è®¢å•æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜\"\u003eä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜\u003c/h2\u003e\n\u003cp\u003eæ‹¼å›¢äº¤æ˜“çš„æ ¸å¿ƒæµç¨‹çœ‹ä¼¼ç®€å•ï¼šç”¨æˆ·å‘èµ·æ‹¼å›¢ â†’ å…¶ä»–ç”¨æˆ·å‚å›¢ â†’ è¾¾åˆ°äººæ•°åæˆå›¢ â†’ æ‰£å‡åº“å­˜ â†’ é€šçŸ¥æ”¯ä»˜ã€‚ä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªæµç¨‹ä¼šé‡åˆ°ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåº“å­˜è¶…å–ï¼š\u003c/strong\u003e 100 ä»¶å•†å“ï¼Œ1000 äººåŒæ—¶ä¸‹å•ï¼Œå¦‚ä½•ä¿è¯ä¸ä¼šè¶…å–ï¼Ÿä¼ ç»Ÿçš„æ•°æ®åº“è¡Œé”åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤±æ•ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ†å¸ƒå¼äº‹åŠ¡ï¼š\u003c/strong\u003e è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡ã€æ”¯ä»˜é€šçŸ¥åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæµ·é‡æ•°æ®ï¼š\u003c/strong\u003e è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚ä½•ä¿è¯æŸ¥è¯¢æ€§èƒ½ä¸éšæ•°æ®é‡å¢é•¿è€ŒåŠ£åŒ–ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eè¿™äº›é—®é¢˜å€’é€¼æˆ‘ä»¬å¿…é¡»ä»æ¶æ„å±‚é¢é‡æ–°æ€è€ƒç³»ç»Ÿè®¾è®¡ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¶æ„è®¾è®¡ddd-æ€æƒ³çš„è½åœ°å®è·µ\"\u003eæ¶æ„è®¾è®¡ï¼šDDD æ€æƒ³çš„è½åœ°å®è·µ\u003c/h2\u003e\n\u003cp\u003eä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹ä¼šå¯¼è‡´ Service å±‚é€»è¾‘è‡ƒè‚¿ï¼Œä¸šåŠ¡è§„åˆ™æ•£è½åœ¨å„å¤„ã€‚æˆ‘ä»¬é‡‡ç”¨ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ€æƒ³ï¼Œå°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒé¢†åŸŸï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè®¢å•åŸŸï¼ˆOrderï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£æ‹¼å›¢è®¢å•çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€çŠ¶æ€æµè½¬ã€è¶…æ—¶å–æ¶ˆç­‰ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåº“å­˜åŸŸï¼ˆInventoryï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£å•†å“åº“å­˜çš„æ‰£å‡ã€å›æ»šã€é¢„å ç­‰æ“ä½œï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒç“¶é¢ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ”¯ä»˜åŸŸï¼ˆPaymentï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£æ”¯ä»˜æµç¨‹çš„ç¼–æ’ï¼ŒåŒ…æ‹¬æ”¯ä»˜é€šçŸ¥ã€é€€æ¬¾å¤„ç†ç­‰ã€‚\u003c/p\u003e\n\u003cp\u003eæ¯ä¸ªé¢†åŸŸéƒ½æœ‰è‡ªå·±çš„èšåˆæ ¹ï¼ˆAggregate Rootï¼‰å’Œé¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰ã€‚æ¯”å¦‚è®¢å•åŸŸçš„èšåˆæ ¹æ˜¯ \u003ccode\u003eOrder\u003c/code\u003eï¼Œå®ƒå°è£…äº†è®¢å•çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰å¾…æ”¯ä»˜çŠ¶æ€æ‰èƒ½å–æ¶ˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecancel\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePENDING_PAYMENT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ethrow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderCannotCancelException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eCANCELLED\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼šè®¢å•å·²å–æ¶ˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eDomainEventPublisher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003epublish\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderCancelledEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šä¸šåŠ¡è§„åˆ™å†…èšåœ¨é¢†åŸŸå¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨ Service å±‚çš„å„ç§ if-else é‡Œã€‚å½“äº§å“ç»ç†è¯´\u0026quot;å¢åŠ ä¸€ä¸ªæ‹¼å›¢å¤±è´¥è‡ªåŠ¨é€€æ¬¾çš„é€»è¾‘\u0026quot;æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç›‘å¬ \u003ccode\u003eOrderCancelledEvent\u003c/code\u003e äº‹ä»¶ï¼Œè€Œä¸éœ€è¦æ”¹åŠ¨è®¢å•å–æ¶ˆçš„æ ¸å¿ƒé€»è¾‘ã€‚\u003c/p\u003e","title":"æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿï¼šDDD æ¶æ„ä¸‹çš„åˆ†å¸ƒå¼å®æˆ˜"},{"content":"ThreadLocal æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦å·¥å…·ï¼Œå®ƒä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚ä½†å¾ˆå¤šäººåªçŸ¥é“æ€ä¹ˆç”¨ï¼Œä¸çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œæ›´ä¸çŸ¥é“å®ƒå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚æœ¬æ–‡æ·±å…¥å‰–æ ThreadLocal çš„åº•å±‚æœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ ThreadLocal çš„å®ç°åŸç†ä¸ ThreadLocalMap ç»“æ„ æŒæ¡å¼±å¼•ç”¨çš„è®¾è®¡æ„å›¾ä¸å†…å­˜æ³„æ¼çš„æ ¹å›  å­¦ä¼šåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹æ­£ç¡®ä½¿ç”¨ ThreadLocal äº†è§£ InheritableThreadLocal çš„ä½¿ç”¨åœºæ™¯ ThreadLocal çš„ä½¿ç”¨åœºæ™¯ ThreadLocal å¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\nåœºæ™¯ä¸€ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’\n1public class UserContext { 2 private static final ThreadLocal\u0026lt;User\u0026gt; context = new ThreadLocal\u0026lt;\u0026gt;(); 3 4 public static void setUser(User user) { 5 context.set(user); 6 } 7 8 public static User getUser() { 9 return context.get(); 10 } 11 12 public static void remove() { 13 context.remove(); 14 } 15} 16 17// åœ¨ Controller ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯ 18@RestController 19public class UserController { 20 21 @GetMapping(\u0026#34;/user/info\u0026#34;) 22 public UserDTO getUserInfo() { 23 User user = UserContext.getUser(); 24 return UserDTO.from(user); 25 } 26} åœºæ™¯äºŒï¼šæ•°æ®åº“è¿æ¥ç®¡ç†\n1public class ConnectionManager { 2 private static final ThreadLocal\u0026lt;Connection\u0026gt; connectionHolder = new ThreadLocal\u0026lt;\u0026gt;(); 3 4 public static Connection getConnection() { 5 Connection conn = connectionHolder.get(); 6 if (conn == null) { 7 conn = DriverManager.getConnection(url, user, password); 8 connectionHolder.set(conn); 9 } 10 return conn; 11 } 12 13 public static void closeConnection() { 14 Connection conn = connectionHolder.get(); 15 if (conn != null) { 16 conn.close(); 17 connectionHolder.remove(); 18 } 19 } 20} åœºæ™¯ä¸‰ï¼šSimpleDateFormat çº¿ç¨‹å®‰å…¨\nSimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥ç”¨ ThreadLocal ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºç‹¬ç«‹å®ä¾‹ï¼š\n1public class DateUtil { 2 private static final ThreadLocal\u0026lt;SimpleDateFormat\u0026gt; formatter = 3 ThreadLocal.withInitial(() -\u0026gt; new SimpleDateFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;)); 4 5 public static String format(Date date) { 6 return formatter.get().format(date); 7 } 8} ThreadLocal çš„å®ç°åŸç† ThreadLocalMapï¼šçœŸæ­£çš„å­˜å‚¨ç»“æ„\nThreadLocal æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œæ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡çš„ threadLocals å­—æ®µä¸­ï¼š\n1public class Thread { 2 ThreadLocal.ThreadLocalMap threadLocals = null; 3} ThreadLocalMap æ˜¯ ThreadLocal çš„é™æ€å†…éƒ¨ç±»ï¼Œç±»ä¼¼äº HashMapï¼Œä½†å®ç°æ›´ç®€å•ï¼š\n1static class ThreadLocalMap { 2 3 static class Entry extends WeakReference\u0026lt;ThreadLocal\u0026lt;?\u0026gt;\u0026gt; { 4 Object value; 5 6 Entry(ThreadLocal\u0026lt;?\u0026gt; k, Object v) { 7 super(k); // key æ˜¯å¼±å¼•ç”¨ 8 value = v; 9 } 10 } 11 12 private Entry[] table; 13 private int size = 0; 14 private int threshold; 15} å…³é”®ç‚¹ï¼šEntry çš„ key æ˜¯ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ã€‚\nset æ–¹æ³•çš„å®ç°\n1public void set(T value) { 2 Thread t = Thread.currentThread(); 3 ThreadLocalMap map = getMap(t); 4 if (map != null) { 5 map.set(this, value); 6 } else { 7 createMap(t, value); 8 } 9} 10 11ThreadLocalMap getMap(Thread t) { 12 return t.threadLocals; 13} 14 15void createMap(Thread t, T firstValue) { 16 t.threadLocals = new ThreadLocalMap(this, firstValue); 17} æµç¨‹ï¼š\nè·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¦‚æœ map ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ map å°† ThreadLocal ä½œä¸º keyï¼Œvalue ä½œä¸ºå€¼å­˜å…¥ map get æ–¹æ³•çš„å®ç°\n1public T get() { 2 Thread t = Thread.currentThread(); 3 ThreadLocalMap map = getMap(t); 4 if (map != null) { 5 ThreadLocalMap.Entry e = map.getEntry(this); 6 if (e != null) { 7 return (T) e.value; 8 } 9 } 10 return setInitialValue(); 11} 12 13private T setInitialValue() { 14 T value = initialValue(); // é»˜è®¤è¿”å› null 15 Thread t = Thread.currentThread(); 16 ThreadLocalMap map = getMap(t); 17 if (map != null) { 18 map.set(this, value); 19 } else { 20 createMap(t, value); 21 } 22 return value; 23} æ¶æ„æ€è€ƒï¼š ThreadLocal çš„è®¾è®¡å·§å¦™ä¹‹å¤„åœ¨äºï¼šæ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯ ThreadLocal å¯¹è±¡ä¸­ã€‚è¿™æ ·ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®è‡ªå·±çš„æ•°æ®æ—¶ï¼Œä¸éœ€è¦åŠ é”ï¼Œé¿å…äº†çº¿ç¨‹ç«äº‰ã€‚\nå¼±å¼•ç”¨ï¼šä¸ºä»€ä¹ˆ key æ˜¯å¼±å¼•ç”¨ï¼Ÿ å››ç§å¼•ç”¨ç±»å‹\nå¼ºå¼•ç”¨ï¼šæ™®é€šçš„å¯¹è±¡å¼•ç”¨ï¼Œåªè¦å¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶ è½¯å¼•ç”¨ï¼šå†…å­˜ä¸è¶³æ—¶ä¼šè¢«å›æ”¶ å¼±å¼•ç”¨ï¼šä¸‹æ¬¡ GC æ—¶ä¸€å®šä¼šè¢«å›æ”¶ è™šå¼•ç”¨ï¼šæ— æ³•é€šè¿‡å¼•ç”¨è·å–å¯¹è±¡ï¼Œåªç”¨äºè·Ÿè¸ªå¯¹è±¡è¢«å›æ”¶çš„çŠ¶æ€ ä¸ºä»€ä¹ˆ key æ˜¯å¼±å¼•ç”¨ï¼Ÿ\nå‡è®¾ key æ˜¯å¼ºå¼•ç”¨ï¼š\n1ThreadLocal\u0026lt;User\u0026gt; userThreadLocal = new ThreadLocal\u0026lt;\u0026gt;(); 2userThreadLocal.set(new User()); 3 4// ä¸šåŠ¡ä»£ç ä¸å†ä½¿ç”¨ userThreadLocal 5userThreadLocal = null; æ­¤æ—¶ï¼Œè™½ç„¶ userThreadLocal å˜é‡è¢«ç½®ä¸º nullï¼Œä½† ThreadLocalMap ä¸­çš„ Entry ä»ç„¶æŒæœ‰ ThreadLocal çš„å¼ºå¼•ç”¨ï¼Œå¯¼è‡´ ThreadLocal å¯¹è±¡æ— æ³•è¢«å›æ”¶ã€‚\nå¦‚æœ key æ˜¯å¼±å¼•ç”¨ï¼š\n1userThreadLocal = null; 2// ä¸‹æ¬¡ GC æ—¶ï¼ŒThreadLocal å¯¹è±¡ä¼šè¢«å›æ”¶ 3// ThreadLocalMap ä¸­çš„ Entry çš„ key å˜æˆ null è¿™æ ·ï¼ŒThreadLocal å¯¹è±¡å¯ä»¥è¢«åŠæ—¶å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚\nä½†æ˜¯ï¼Œvalue ä»ç„¶æ˜¯å¼ºå¼•ç”¨ï¼\nå³ä½¿ key è¢«å›æ”¶ï¼Œvalue ä»ç„¶å­˜åœ¨ï¼Œè¿™å°±æ˜¯å†…å­˜æ³„æ¼çš„æ ¹æºã€‚\nå†…å­˜æ³„æ¼ï¼šçº¿ç¨‹æ± ç¯å¢ƒä¸‹çš„é™·é˜± é—®é¢˜åœºæ™¯\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); // å‡è®¾æœ‰ 10 ä¸‡æ¡æ•°æ® 8 cache.set(users); 9 10 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 11 doSomething(users); 12 13 // å¿˜è®°è°ƒç”¨ remove() 14 } 15} åœ¨ Tomcat çº¿ç¨‹æ± ç¯å¢ƒä¸‹ï¼š\nè¯·æ±‚åˆ°è¾¾ï¼Œçº¿ç¨‹æ± åˆ†é…çº¿ç¨‹ A å¤„ç†è¯·æ±‚ çº¿ç¨‹ A æ‰§è¡Œ processUsers()ï¼Œå°† 10 ä¸‡æ¡æ•°æ®å­˜å…¥ ThreadLocal è¯·æ±‚ç»“æŸï¼Œçº¿ç¨‹ A è¿”å›çº¿ç¨‹æ± ï¼Œä½† ThreadLocal ä¸­çš„æ•°æ®æ²¡æœ‰æ¸…ç† ä¸‹æ¬¡è¯·æ±‚å¤ç”¨çº¿ç¨‹ A æ—¶ï¼ŒThreadLocal ä¸­ä»ç„¶ä¿å­˜ç€ä¸Šæ¬¡çš„æ•°æ® éšç€è¯·æ±‚å¢å¤šï¼Œæ¯ä¸ªçº¿ç¨‹çš„ ThreadLocal éƒ½ä¼šç§¯ç´¯å¤§é‡æ•°æ®ï¼Œæœ€ç»ˆå¯¼è‡´ OOMã€‚\nå†…å­˜æ³„æ¼çš„æ ¹å› \n1Thread (å¼ºå¼•ç”¨) 2 â†“ 3ThreadLocalMap (å¼ºå¼•ç”¨) 4 â†“ 5Entry[] (å¼ºå¼•ç”¨) 6 â†“ 7Entry.key (å¼±å¼•ç”¨) â†’ ThreadLocal (å¯èƒ½è¢«å›æ”¶) 8Entry.value (å¼ºå¼•ç”¨) â†’ User List (æ— æ³•è¢«å›æ”¶) å³ä½¿ ThreadLocal å¯¹è±¡è¢«å›æ”¶ï¼Œvalue ä»ç„¶è¢« Entry å¼ºå¼•ç”¨ï¼Œæ— æ³•è¢« GC å›æ”¶ã€‚\næ­£ç¡®çš„ä½¿ç”¨æ–¹å¼\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 try { 8 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 9 cache.set(users); 10 doSomething(users); 11 } finally { 12 cache.remove(); // å¿…é¡»åœ¨ finally ä¸­æ¸…ç† 13 } 14 } 15} ThreadLocal çš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶\nThreadLocalMap åœ¨ setã€getã€remove æ—¶ä¼šè§¦å‘æ¸…ç†ï¼š\n1private int expungeStaleEntry(int staleSlot) { 2 Entry[] tab = table; 3 int len = tab.length; 4 5 // æ¸…ç† key ä¸º null çš„ Entry 6 tab[staleSlot].value = null; 7 tab[staleSlot] = null; 8 size--; 9 10 // ç»§ç»­æ‰«æåç»­çš„ Entry 11 Entry e; 12 int i; 13 for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) { 14 ThreadLocal\u0026lt;?\u0026gt; k = e.get(); 15 if (k == null) { 16 e.value = null; 17 tab[i] = null; 18 size--; 19 } 20 } 21 return i; 22} ä½†è¿™ç§æ¸…ç†æ˜¯è¢«åŠ¨çš„ï¼Œä¸èƒ½å®Œå…¨ä¾èµ–ã€‚æœ€ä½³å®è·µæ˜¯æ‰‹åŠ¨è°ƒç”¨ remove()ã€‚\né¿å‘æç¤ºï¼š åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„ç¯å¢ƒä¸‹ï¼ŒThreadLocal å¿…é¡»åœ¨ finally å—ä¸­è°ƒç”¨ remove()ã€‚å¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼å’Œæ•°æ®æ··ä¹±ï¼ˆä¸‹ä¸€ä¸ªè¯·æ±‚å¯èƒ½è¯»åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚çš„æ•°æ®ï¼‰ã€‚\nInheritableThreadLocalï¼šçˆ¶å­çº¿ç¨‹ä¼ é€’ ThreadLocal çš„æ•°æ®æ— æ³•åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä¼ é€’ï¼š\n1ThreadLocal\u0026lt;String\u0026gt; threadLocal = new ThreadLocal\u0026lt;\u0026gt;(); 2threadLocal.set(\u0026#34;parent\u0026#34;); 3 4new Thread(() -\u0026gt; { 5 System.out.println(threadLocal.get()); // è¾“å‡º null 6}).start(); InheritableThreadLocal è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼š\n1InheritableThreadLocal\u0026lt;String\u0026gt; inheritableThreadLocal = new InheritableThreadLocal\u0026lt;\u0026gt;(); 2inheritableThreadLocal.set(\u0026#34;parent\u0026#34;); 3 4new Thread(() -\u0026gt; { 5 System.out.println(inheritableThreadLocal.get()); // è¾“å‡º parent 6}).start(); å®ç°åŸç†\nThread ç±»æœ‰ä¸¤ä¸ª ThreadLocalMap å­—æ®µï¼š\n1public class Thread { 2 ThreadLocal.ThreadLocalMap threadLocals = null; 3 ThreadLocal.ThreadLocalMap inheritableThreadLocals = null; 4} åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œä¼šå¤åˆ¶çˆ¶çº¿ç¨‹çš„ inheritableThreadLocalsï¼š\n1private void init(ThreadGroup g, Runnable target, String name, long stackSize) { 2 Thread parent = currentThread(); 3 4 if (parent.inheritableThreadLocals != null) { 5 this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); 6 } 7} æ³¨æ„äº‹é¡¹\nInheritableThreadLocal åªåœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶å¤åˆ¶æ•°æ®ï¼Œå¦‚æœä½¿ç”¨çº¿ç¨‹æ± ï¼Œå­çº¿ç¨‹ä¼šè¢«å¤ç”¨ï¼Œæ•°æ®ä¸ä¼šæ›´æ–°ã€‚\nè§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨é˜¿é‡Œå¼€æºçš„ TransmittableThreadLocalï¼ˆTTLï¼‰ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šæ’æŸ¥ ThreadLocal å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOMã€‚é€šè¿‡ MAT åˆ†æ Heap Dumpï¼Œå‘ç°å¤§é‡ ThreadLocalMap.Entry å¯¹è±¡ã€‚\næ’æŸ¥æ­¥éª¤\næŸ¥çœ‹ Dominator Treeï¼Œå‘ç° Thread å¯¹è±¡å ç”¨äº†å¤§é‡å†…å­˜ å±•å¼€ Thread å¯¹è±¡ï¼Œå‘ç° threadLocals å­—æ®µä¸­æœ‰å¤§é‡ Entry æŸ¥çœ‹ Entry çš„ valueï¼Œå‘ç°æ˜¯ä¸šåŠ¡å¯¹è±¡ï¼ˆUser Listï¼‰ é€šè¿‡å¼•ç”¨é“¾æ‰¾åˆ°åˆ›å»º ThreadLocal çš„ä»£ç ä½ç½® ä¿®å¤æ–¹æ¡ˆ\nåœ¨æ‰€æœ‰ä½¿ç”¨ ThreadLocal çš„åœ°æ–¹ï¼Œæ·»åŠ  finally å—è°ƒç”¨ remove()ï¼š\n1try { 2 threadLocal.set(value); 3 // ä¸šåŠ¡é€»è¾‘ 4} finally { 5 threadLocal.remove(); 6} é¢„é˜²æªæ–½\nCode Review é‡ç‚¹å…³æ³¨ ThreadLocal çš„ä½¿ç”¨ ä½¿ç”¨ Alibaba Java Coding Guidelines æ’ä»¶ï¼Œè‡ªåŠ¨æ£€æµ‹ ThreadLocal æœªè°ƒç”¨ remove() åœ¨å•å…ƒæµ‹è¯•ä¸­æ¨¡æ‹Ÿçº¿ç¨‹æ± ç¯å¢ƒï¼Œæ£€æµ‹å†…å­˜æ³„æ¼ æ€»ç»“ä¸æ€è€ƒ ThreadLocal çš„æ ¸å¿ƒåŸç†ï¼š\næ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡çš„ ThreadLocalMap ä¸­ key æ˜¯ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ å¼±å¼•ç”¨è®¾è®¡é¿å…äº† ThreadLocal å¯¹è±¡çš„å†…å­˜æ³„æ¼ï¼Œä½† value ä»å¯èƒ½æ³„æ¼ ä½¿ç”¨ ThreadLocal çš„æœ€ä½³å®è·µï¼š\nåœ¨ finally å—ä¸­è°ƒç”¨ remove() é¿å…å­˜å‚¨å¤§å¯¹è±¡ ä½¿ç”¨ try-with-resources æ¨¡å¼å°è£… ThreadLocal ä¸‹æ¬¡å½“ä½ ä½¿ç”¨ ThreadLocal æ—¶ï¼Œè®°å¾—é—®è‡ªå·±ï¼šæˆ‘åœ¨ finally ä¸­è°ƒç”¨ remove() äº†å—ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/02/threadlocal-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eThreadLocal æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦å·¥å…·ï¼Œå®ƒä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚ä½†å¾ˆå¤šäººåªçŸ¥é“æ€ä¹ˆç”¨ï¼Œä¸çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œæ›´ä¸çŸ¥é“å®ƒå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚æœ¬æ–‡æ·±å…¥å‰–æ ThreadLocal çš„åº•å±‚æœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ ThreadLocal çš„å®ç°åŸç†ä¸ ThreadLocalMap ç»“æ„\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å¼±å¼•ç”¨çš„è®¾è®¡æ„å›¾ä¸å†…å­˜æ³„æ¼çš„æ ¹å› \u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹æ­£ç¡®ä½¿ç”¨ ThreadLocal\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ InheritableThreadLocal çš„ä½¿ç”¨åœºæ™¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"threadlocal-çš„ä½¿ç”¨åœºæ™¯\"\u003eThreadLocal çš„ä½¿ç”¨åœºæ™¯\u003c/h2\u003e\n\u003cp\u003eThreadLocal å¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserContext\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efinal\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadLocal\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadLocal\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003esetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// åœ¨ Controller ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@RestController\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserController\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@GetMapping\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/user/info\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserDTO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUserInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserDTO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šæ•°æ®åº“è¿æ¥ç®¡ç†\u003c/strong\u003e\u003c/p\u003e","title":"ThreadLocal åŸç†ä¸å†…å­˜æ³„æ¼æ’æŸ¥å®æˆ˜"},{"content":"å¼€å§‹å†™åšå®¢ é‚£æ˜¯ä¸€æ¡ç¥å¥‡çš„å¤©è·¯å•Š ğŸµ\nä»Šå¤©å¼€å§‹äº†æˆ‘çš„åšå®¢ä¹‹æ—…ï¼Œå¸Œæœ›èƒ½åœ¨è¿™é‡Œè®°å½•ä¸‹ï¼š\nğŸ’¡ æŠ€æœ¯å­¦ä¹ çš„å¿ƒå¾— ğŸš€ é¡¹ç›®å¼€å‘çš„ç»éªŒ ğŸ“– è¯»ä¹¦æ€è€ƒçš„æ€»ç»“ ğŸŒŸ ç”Ÿæ´»ä¸­çš„æ„Ÿæ‚Ÿ ä¸ºä»€ä¹ˆå†™åšå®¢ å†™åšå®¢ä¸ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯ï¼š\næ•´ç†æ€è·¯ï¼šé€šè¿‡å†™ä½œæ¢³ç†çŸ¥è¯†ä½“ç³» æ·±åŒ–ç†è§£ï¼šæ•™æ˜¯æœ€å¥½çš„å­¦ åˆ†äº«äº¤æµï¼šä¸ä»–äººäº¤æµæƒ³æ³• è®°å½•æˆé•¿ï¼šè§è¯è‡ªå·±çš„è¿›æ­¥ æœªæ¥è®¡åˆ’ æ¥ä¸‹æ¥æˆ‘ä¼šåˆ†äº«æ›´å¤šå…³äºæŠ€æœ¯å’Œç”Ÿæ´»çš„å†…å®¹ï¼Œæ•¬è¯·æœŸå¾…ï¼\n\u0026ldquo;The journey of a thousand miles begins with one step.\u0026rdquo; - è€å­\n","permalink":"http://localhost:1313/posts/2024/02/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0/","summary":"\u003ch2 id=\"å¼€å§‹å†™åšå®¢\"\u003eå¼€å§‹å†™åšå®¢\u003c/h2\u003e\n\u003cp\u003eé‚£æ˜¯ä¸€æ¡ç¥å¥‡çš„å¤©è·¯å•Š ğŸµ\u003c/p\u003e\n\u003cp\u003eä»Šå¤©å¼€å§‹äº†æˆ‘çš„åšå®¢ä¹‹æ—…ï¼Œå¸Œæœ›èƒ½åœ¨è¿™é‡Œè®°å½•ä¸‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eğŸ’¡ æŠ€æœ¯å­¦ä¹ çš„å¿ƒå¾—\u003c/li\u003e\n\u003cli\u003eğŸš€ é¡¹ç›®å¼€å‘çš„ç»éªŒ\u003c/li\u003e\n\u003cli\u003eğŸ“– è¯»ä¹¦æ€è€ƒçš„æ€»ç»“\u003c/li\u003e\n\u003cli\u003eğŸŒŸ ç”Ÿæ´»ä¸­çš„æ„Ÿæ‚Ÿ\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆå†™åšå®¢\"\u003eä¸ºä»€ä¹ˆå†™åšå®¢\u003c/h2\u003e\n\u003cp\u003eå†™åšå®¢ä¸ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæ•´ç†æ€è·¯\u003c/strong\u003eï¼šé€šè¿‡å†™ä½œæ¢³ç†çŸ¥è¯†ä½“ç³»\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ·±åŒ–ç†è§£\u003c/strong\u003eï¼šæ•™æ˜¯æœ€å¥½çš„å­¦\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåˆ†äº«äº¤æµ\u003c/strong\u003eï¼šä¸ä»–äººäº¤æµæƒ³æ³•\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè®°å½•æˆé•¿\u003c/strong\u003eï¼šè§è¯è‡ªå·±çš„è¿›æ­¥\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"æœªæ¥è®¡åˆ’\"\u003eæœªæ¥è®¡åˆ’\u003c/h2\u003e\n\u003cp\u003eæ¥ä¸‹æ¥æˆ‘ä¼šåˆ†äº«æ›´å¤šå…³äºæŠ€æœ¯å’Œç”Ÿæ´»çš„å†…å®¹ï¼Œæ•¬è¯·æœŸå¾…ï¼\u003c/p\u003e\n\u003chr\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u0026ldquo;The journey of a thousand miles begins with one step.\u0026rdquo; - è€å­\u003c/p\u003e\n\u003c/blockquote\u003e","title":"æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢æ–‡ç« "},{"content":"åœ¨ Java å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ ¸å¿ƒæœºåˆ¶ã€‚ä»æœ€æ—©çš„ synchronized åˆ° JDK 1.5 å¼•å…¥çš„ AQS æ¡†æ¶ï¼ŒJava çš„é”æœºåˆ¶ç»å†äº†å·¨å¤§çš„æ¼”è¿›ã€‚ç†è§£è¿™ä¸ªæ¼”è¿›è¿‡ç¨‹ï¼Œæ˜¯æŒæ¡ Java å¹¶å‘ç¼–ç¨‹çš„å…³é”®ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ synchronized çš„é”å‡çº§è¿‡ç¨‹ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼‰ æŒæ¡ AQS çš„æ ¸å¿ƒåŸç†ä¸åº”ç”¨åœºæ™¯ å­¦ä¼šé€‰æ‹© ReentrantLock è¿˜æ˜¯ synchronized äº†è§£ CAS æ“ä½œä¸è‡ªæ—‹é”çš„å®ç° synchronizedï¼šä»é‡é‡çº§åˆ°è½»é‡çº§ åœ¨ JDK 1.6 ä¹‹å‰ï¼Œsynchronized æ˜¯é‡é‡çº§é”ï¼Œæ¯æ¬¡åŠ é”éƒ½éœ€è¦æ“ä½œç³»ç»Ÿçš„ mutex äº’æ–¥é‡ï¼Œæ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\nJDK 1.6 å¯¹ synchronized è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œå¼•å…¥äº†é”å‡çº§æœºåˆ¶ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”ã€‚\nå¯¹è±¡å¤´ï¼šé”ä¿¡æ¯çš„å­˜å‚¨ä½ç½®\nJava å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……ã€‚é”ä¿¡æ¯å­˜å‚¨åœ¨å¯¹è±¡å¤´çš„ Mark Word ä¸­ã€‚\nMark Word çš„ç»“æ„ï¼ˆ64 ä½ JVMï¼‰ï¼š\n1|--------------------------------------------------------------| 2| é”çŠ¶æ€ | 25bit | 31bit | 1bit | 4bit | 1bitåå‘é” | 2bité”æ ‡å¿— | 3|--------------------------------------------------------------| 4| æ— é” | unused | hashcode | unused | age | 0 | 01 | 5| åå‘é” | ThreadID | Epoch | unused | age | 1 | 01 | 6| è½»é‡çº§é” | æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ | 00 | 7| é‡é‡çº§é” | æŒ‡å‘äº’æ–¥é‡çš„æŒ‡é’ˆ | 10 | åå‘é”ï¼šå•çº¿ç¨‹åœºæ™¯çš„ä¼˜åŒ–\nå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–ã€‚åå‘é”çš„æ€æƒ³æ˜¯ï¼šç¬¬ä¸€æ¬¡è·å–é”æ—¶ï¼Œåœ¨å¯¹è±¡å¤´ä¸­è®°å½•çº¿ç¨‹ IDï¼Œåç»­è¯¥çº¿ç¨‹å†æ¬¡è·å–é”æ—¶ï¼Œåªéœ€è¦åˆ¤æ–­ Mark Word ä¸­çš„çº¿ç¨‹ ID æ˜¯å¦æ˜¯è‡ªå·±ï¼Œæ— éœ€ CAS æ“ä½œã€‚\n1public class BiasedLockDemo { 2 private static Object lock = new Object(); 3 4 public static void main(String[] args) { 5 // ç¬¬ä¸€æ¬¡åŠ é”ï¼šå‡çº§ä¸ºåå‘é” 6 synchronized (lock) { 7 System.out.println(\u0026#34;ç¬¬ä¸€æ¬¡åŠ é”\u0026#34;); 8 } 9 10 // ç¬¬äºŒæ¬¡åŠ é”ï¼šç›´æ¥è·å–åå‘é”ï¼Œæ— éœ€ CAS 11 synchronized (lock) { 12 System.out.println(\u0026#34;ç¬¬äºŒæ¬¡åŠ é”\u0026#34;); 13 } 14 } 15} åå‘é”çš„æ’¤é”€ï¼šå½“å…¶ä»–çº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œåå‘é”ä¼šæ’¤é”€ï¼Œå‡çº§ä¸ºè½»é‡çº§é”ã€‚\nè½»é‡çº§é”ï¼šå¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡Œçš„ä¼˜åŒ–\nå½“æœ‰ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿è·å–é”ï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä½¿ç”¨è½»é‡çº§é”ã€‚è½»é‡çº§é”é€šè¿‡ CAS æ“ä½œå°† Mark Word æ›¿æ¢ä¸ºæŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆã€‚\n1// çº¿ç¨‹ A 2synchronized (lock) { 3 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 4} 5 6// çº¿ç¨‹ Bï¼ˆåœ¨ A é‡Šæ”¾é”åæ‰è·å–ï¼‰ 7synchronized (lock) { 8 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 9} è½»é‡çº§é”çš„åŠ é”æµç¨‹ï¼š\nåœ¨æ ˆå¸§ä¸­åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰ å°†å¯¹è±¡å¤´çš„ Mark Word å¤åˆ¶åˆ°é”è®°å½•ä¸­ é€šè¿‡ CAS å°†å¯¹è±¡å¤´çš„ Mark Word æ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆ å¦‚æœ CAS æˆåŠŸï¼Œè·å–é”ï¼›å¦‚æœå¤±è´¥ï¼Œè‡ªæ—‹é‡è¯• é‡é‡çº§é”ï¼šå¤šçº¿ç¨‹ç«äº‰çš„æœ€ç»ˆæ–¹æ¡ˆ\nå½“è‡ªæ—‹æ¬¡æ•°è¿‡å¤šï¼ˆé»˜è®¤ 10 æ¬¡ï¼‰ï¼Œæˆ–è€…æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰é”ï¼Œè½»é‡çº§é”ä¼šå‡çº§ä¸ºé‡é‡çº§é”ã€‚é‡é‡çº§é”ä¼šé˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œé€šè¿‡æ“ä½œç³»ç»Ÿçš„ mutex å®ç°ã€‚\n1// å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰ 2for (int i = 0; i \u0026lt; 10; i++) { 3 new Thread(() -\u0026gt; { 4 synchronized (lock) { 5 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 6 } 7 }).start(); 8} æ¶æ„æ€è€ƒï¼š synchronized çš„é”å‡çº§ä½“ç°äº†\u0026quot;é€‚åº”æ€§ä¼˜åŒ–\u0026quot;çš„æ€æƒ³ã€‚åœ¨ä¸åŒçš„ç«äº‰åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ä¸åŒçš„é”å®ç°ï¼Œåœ¨æ€§èƒ½å’Œæ­£ç¡®æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ MySQL çš„è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ã€JVM çš„åˆ†å±‚ç¼–è¯‘ã€‚\nAQSï¼šå¹¶å‘å·¥å…·çš„åŸºçŸ³ AQSï¼ˆAbstractQueuedSynchronizerï¼‰æ˜¯ JDK 1.5 å¼•å…¥çš„å¹¶å‘æ¡†æ¶ï¼ŒReentrantLockã€Semaphoreã€CountDownLatch ç­‰å·¥å…·éƒ½åŸºäº AQS å®ç°ã€‚\nAQS çš„æ ¸å¿ƒæ€æƒ³\nAQS ç»´æŠ¤äº†ä¸€ä¸ª volatile int state å˜é‡å’Œä¸€ä¸ª FIFO é˜Ÿåˆ—ã€‚\nstateï¼šè¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼ˆ0 è¡¨ç¤ºæœªé”å®šï¼Œ1 è¡¨ç¤ºå·²é”å®šï¼‰ FIFO é˜Ÿåˆ—ï¼šå­˜å‚¨ç­‰å¾…è·å–é”çš„çº¿ç¨‹ ç‹¬å æ¨¡å¼ï¼šReentrantLock çš„å®ç°\nReentrantLock çš„åŠ é”æµç¨‹ï¼š\n1public class ReentrantLock { 2 3 private final Sync sync; 4 5 public void lock() { 6 sync.acquire(1); 7 } 8 9 abstract static class Sync extends AbstractQueuedSynchronizer { 10 11 final boolean tryAcquire(int acquires) { 12 final Thread current = Thread.currentThread(); 13 int c = getState(); 14 15 // å¦‚æœ state == 0ï¼Œè¯´æ˜é”æœªè¢«å ç”¨ 16 if (c == 0) { 17 if (compareAndSetState(0, acquires)) { 18 setExclusiveOwnerThread(current); 19 return true; 20 } 21 } 22 // å¦‚æœæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é”ï¼Œæ”¯æŒé‡å…¥ 23 else if (current == getExclusiveOwnerThread()) { 24 int nextc = c + acquires; 25 setState(nextc); 26 return true; 27 } 28 return false; 29 } 30 } 31} å¦‚æœ tryAcquire å¤±è´¥ï¼Œçº¿ç¨‹ä¼šè¢«åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼š\n1private Node addWaiter(Node mode) { 2 Node node = new Node(Thread.currentThread(), mode); 3 Node pred = tail; 4 5 // å¿«é€Ÿå°è¯•åœ¨é˜Ÿå°¾æ·»åŠ  6 if (pred != null) { 7 node.prev = pred; 8 if (compareAndSetTail(pred, node)) { 9 pred.next = node; 10 return node; 11 } 12 } 13 14 // å¦‚æœå¤±è´¥ï¼Œé€šè¿‡è‡ªæ—‹æ·»åŠ  15 enq(node); 16 return node; 17} ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å«çº¿ç¨‹å¼•ç”¨å’Œç­‰å¾…çŠ¶æ€ã€‚\nå…±äº«æ¨¡å¼ï¼šSemaphore çš„å®ç°\nSemaphore å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®èµ„æºï¼Œé€šè¿‡ state è¡¨ç¤ºå¯ç”¨è®¸å¯æ•°ã€‚\n1public class Semaphore { 2 3 private final Sync sync; 4 5 public void acquire() throws InterruptedException { 6 sync.acquireSharedInterruptibly(1); 7 } 8 9 abstract static class Sync extends AbstractQueuedSynchronizer { 10 11 final int tryAcquireShared(int acquires) { 12 for (;;) { 13 int available = getState(); 14 int remaining = available - acquires; 15 16 // å¦‚æœè®¸å¯ä¸è¶³ï¼Œè¿”å›è´Ÿæ•° 17 if (remaining \u0026lt; 0) { 18 return remaining; 19 } 20 21 // é€šè¿‡ CAS æ‰£å‡è®¸å¯ 22 if (compareAndSetState(available, remaining)) { 23 return remaining; 24 } 25 } 26 } 27 } 28} å…±äº«æ¨¡å¼ä¸‹ï¼Œé‡Šæ”¾é”æ—¶ä¼šå”¤é†’é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚\né¿å‘æç¤ºï¼š AQS çš„ state æ˜¯ volatile çš„ï¼Œä¿è¯äº†å¯è§æ€§ï¼Œä½†ä¸ä¿è¯åŸå­æ€§ã€‚æ‰€ä»¥ä¿®æ”¹ state æ—¶å¿…é¡»ä½¿ç”¨ CAS æ“ä½œã€‚\nReentrantLock vs synchronized åŠŸèƒ½å¯¹æ¯”\nç‰¹æ€§ synchronized ReentrantLock é”çš„å®ç° JVM å±‚é¢ JDK å±‚é¢ å¯é‡å…¥æ€§ æ”¯æŒ æ”¯æŒ å…¬å¹³é” ä¸æ”¯æŒ æ”¯æŒ å¯ä¸­æ–­ ä¸æ”¯æŒ æ”¯æŒ è¶…æ—¶è·å– ä¸æ”¯æŒ æ”¯æŒ æ¡ä»¶å˜é‡ å•ä¸ªï¼ˆwait/notifyï¼‰ å¤šä¸ªï¼ˆConditionï¼‰ æ€§èƒ½å¯¹æ¯”\nåœ¨ JDK 1.6 ä¹‹åï¼Œsynchronized ç»è¿‡ä¼˜åŒ–ï¼Œæ€§èƒ½å·²ç»å’Œ ReentrantLock ç›¸å½“ã€‚åœ¨ä½ç«äº‰åœºæ™¯ä¸‹ï¼Œsynchronized ç”šè‡³æ›´å¿«ï¼ˆå› ä¸ºæœ‰é”æ¶ˆé™¤å’Œé”ç²—åŒ–ä¼˜åŒ–ï¼‰ã€‚\nä½¿ç”¨å»ºè®®\nä¼˜å…ˆä½¿ç”¨ synchronizedï¼šä»£ç ç®€æ´ï¼ŒJVM ä¼šè‡ªåŠ¨ä¼˜åŒ– éœ€è¦é«˜çº§ç‰¹æ€§æ—¶ä½¿ç”¨ ReentrantLockï¼šå…¬å¹³é”ã€å¯ä¸­æ–­ã€è¶…æ—¶è·å– å®æˆ˜æ¡ˆä¾‹ï¼šå¯ä¸­æ–­é”\n1public class InterruptibleLockDemo { 2 3 private final ReentrantLock lock = new ReentrantLock(); 4 5 public void doWork() throws InterruptedException { 6 // å¯ä¸­æ–­åœ°è·å–é” 7 lock.lockInterruptibly(); 8 try { 9 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 10 Thread.sleep(10000); 11 } finally { 12 lock.unlock(); 13 } 14 } 15 16 public static void main(String[] args) throws InterruptedException { 17 InterruptibleLockDemo demo = new InterruptibleLockDemo(); 18 19 Thread t1 = new Thread(() -\u0026gt; { 20 try { 21 demo.doWork(); 22 } catch (InterruptedException e) { 23 System.out.println(\u0026#34;çº¿ç¨‹è¢«ä¸­æ–­\u0026#34;); 24 } 25 }); 26 27 t1.start(); 28 Thread.sleep(1000); 29 t1.interrupt(); // ä¸­æ–­çº¿ç¨‹ 30 } 31} å¦‚æœä½¿ç”¨ synchronizedï¼Œçº¿ç¨‹æ— æ³•è¢«ä¸­æ–­ï¼Œåªèƒ½ç­‰å¾…é”é‡Šæ”¾ã€‚\nCAS ä¸è‡ªæ—‹é” CASï¼ˆCompare And Swapï¼‰æ˜¯å®ç°æ— é”å¹¶å‘çš„åŸºç¡€ã€‚\nCAS çš„åŸç†\nCAS åŒ…å«ä¸‰ä¸ªæ“ä½œæ•°ï¼šå†…å­˜ä½ç½® Vã€é¢„æœŸå€¼ Aã€æ–°å€¼ Bã€‚åªæœ‰å½“ V çš„å€¼ç­‰äº A æ—¶ï¼Œæ‰ä¼šå°† V æ›´æ–°ä¸º Bã€‚\n1public class AtomicInteger { 2 3 private volatile int value; 4 5 public final boolean compareAndSet(int expect, int update) { 6 return unsafe.compareAndSwapInt(this, valueOffset, expect, update); 7 } 8 9 public final int incrementAndGet() { 10 for (;;) { 11 int current = get(); 12 int next = current + 1; 13 if (compareAndSet(current, next)) { 14 return next; 15 } 16 } 17 } 18} CAS çš„ä¼˜åŠ¿ï¼šæ— éœ€åŠ é”ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\nCAS çš„é—®é¢˜ï¼š\nABA é—®é¢˜ï¼šå€¼ä» A å˜æˆ Bï¼Œå†å˜å› Aï¼ŒCAS æ— æ³•æ„ŸçŸ¥ è‡ªæ—‹å¼€é”€ï¼šå¦‚æœé•¿æ—¶é—´ CAS å¤±è´¥ï¼Œä¼šæµªè´¹ CPU åªèƒ½ä¿è¯å•ä¸ªå˜é‡çš„åŸå­æ€§ è‡ªæ—‹é”çš„å®ç°\n1public class SpinLock { 2 3 private AtomicReference\u0026lt;Thread\u0026gt; owner = new AtomicReference\u0026lt;\u0026gt;(); 4 5 public void lock() { 6 Thread current = Thread.currentThread(); 7 // è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ° CAS æˆåŠŸ 8 while (!owner.compareAndSet(null, current)) { 9 } 10 } 11 12 public void unlock() { 13 Thread current = Thread.currentThread(); 14 owner.compareAndSet(current, null); 15 } 16} è‡ªæ—‹é”é€‚åˆé”æŒæœ‰æ—¶é—´å¾ˆçŸ­çš„åœºæ™¯ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡çš„å¼€é”€ã€‚\næ€»ç»“ä¸æ€è€ƒ Java é”æœºåˆ¶çš„æ¼”è¿›ä½“ç°äº†æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€æƒ³ï¼šåœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ã€‚\nsynchronizedï¼šä»é‡é‡çº§é”ä¼˜åŒ–ä¸ºé”å‡çº§æœºåˆ¶ï¼Œé€‚åº”ä¸åŒç«äº‰åœºæ™¯ AQSï¼šæä¾›äº†çµæ´»çš„å¹¶å‘å·¥å…·æ¡†æ¶ï¼Œæ”¯æŒç‹¬å å’Œå…±äº«æ¨¡å¼ CASï¼šæ— é”å¹¶å‘çš„åŸºç¡€ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡ ç†è§£è¿™äº›æœºåˆ¶ï¼Œæ‰èƒ½åœ¨å®é™…å¼€å‘ä¸­é€‰æ‹©åˆé€‚çš„å¹¶å‘å·¥å…·ï¼Œå†™å‡ºé«˜æ€§èƒ½çš„å¹¶å‘ä»£ç ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åŠ é”æ—¶ï¼Œä¸å¦¨æƒ³æƒ³ï¼šè¿™ä¸ªåœºæ™¯é€‚åˆ synchronized è¿˜æ˜¯ ReentrantLockï¼Ÿæ˜¯å¦å¯ä»¥ç”¨ CAS å®ç°æ— é”å¹¶å‘ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/01/java-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%BB%8E-synchronized-%E5%88%B0-aqs-%E7%9A%84%E6%BC%94%E8%BF%9B/","summary":"\u003cp\u003eåœ¨ Java å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ ¸å¿ƒæœºåˆ¶ã€‚ä»æœ€æ—©çš„ synchronized åˆ° JDK 1.5 å¼•å…¥çš„ AQS æ¡†æ¶ï¼ŒJava çš„é”æœºåˆ¶ç»å†äº†å·¨å¤§çš„æ¼”è¿›ã€‚ç†è§£è¿™ä¸ªæ¼”è¿›è¿‡ç¨‹ï¼Œæ˜¯æŒæ¡ Java å¹¶å‘ç¼–ç¨‹çš„å…³é”®ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ synchronized çš„é”å‡çº§è¿‡ç¨‹ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼‰\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ AQS çš„æ ¸å¿ƒåŸç†ä¸åº”ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé€‰æ‹© ReentrantLock è¿˜æ˜¯ synchronized\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ CAS æ“ä½œä¸è‡ªæ—‹é”çš„å®ç°\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"synchronizedä»é‡é‡çº§åˆ°è½»é‡çº§\"\u003esynchronizedï¼šä»é‡é‡çº§åˆ°è½»é‡çº§\u003c/h2\u003e\n\u003cp\u003eåœ¨ JDK 1.6 ä¹‹å‰ï¼Œsynchronized æ˜¯é‡é‡çº§é”ï¼Œæ¯æ¬¡åŠ é”éƒ½éœ€è¦æ“ä½œç³»ç»Ÿçš„ mutex äº’æ–¥é‡ï¼Œæ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\u003c/p\u003e\n\u003cp\u003eJDK 1.6 å¯¹ synchronized è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œå¼•å…¥äº†é”å‡çº§æœºåˆ¶ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå¯¹è±¡å¤´ï¼šé”ä¿¡æ¯çš„å­˜å‚¨ä½ç½®\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eJava å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……ã€‚é”ä¿¡æ¯å­˜å‚¨åœ¨å¯¹è±¡å¤´çš„ Mark Word ä¸­ã€‚\u003c/p\u003e\n\u003cp\u003eMark Word çš„ç»“æ„ï¼ˆ64 ä½ JVMï¼‰ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e|--------------------------------------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e| é”çŠ¶æ€   | 25bit | 31bit | 1bit | 4bit | 1bitåå‘é” | 2bité”æ ‡å¿— |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e|--------------------------------------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e| æ— é”     | unused | hashcode | unused | age | 0 | 01 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e| åå‘é”   | ThreadID | Epoch | unused | age | 1 | 01 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e| è½»é‡çº§é” | æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ | 00 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e| é‡é‡çº§é” | æŒ‡å‘äº’æ–¥é‡çš„æŒ‡é’ˆ | 10 |\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåå‘é”ï¼šå•çº¿ç¨‹åœºæ™¯çš„ä¼˜åŒ–\u003c/strong\u003e\u003c/p\u003e","title":"Java å¹¶å‘ç¼–ç¨‹ï¼šä» synchronized åˆ° AQS çš„æ¼”è¿›"},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"ä½ å¥½ï¼Œæˆ‘æ˜¯ wawayu ä¸€åä¸“æ³¨äºåˆ†å¸ƒå¼ç³»ç»Ÿå’Œé«˜å¹¶å‘æ¶æ„çš„ Java åç«¯å¼€å‘å·¥ç¨‹å¸ˆã€‚æˆ‘çƒ­è¡·äºç”¨æŠ€æœ¯è§£å†³å®é™…ä¸šåŠ¡é—®é¢˜ï¼Œæ“…é•¿ä» 0 åˆ° 1 è®¾è®¡å’Œå®ç°å¤æ‚ç³»ç»Ÿã€‚\nç›®å‰åœ¨æŸæ˜•ç½‘ç»œç§‘æŠ€å…¬å¸æ‹…ä»» Java å¼€å‘å®ä¹ ç”Ÿï¼Œè´Ÿè´£å¿«é€Ÿè¿­ä»£ä¸äº¤ä»˜ 20+ ä¸ªå®šåˆ¶åŒ–é¡¹ç›®ï¼Œç§¯ç´¯äº†ä¸°å¯Œçš„ä¸šåŠ¡å¼€å‘å’Œç³»ç»Ÿä¼˜åŒ–ç»éªŒã€‚\næˆ‘çš„æŠ€æœ¯ç†å¿µ ä»£ç æ˜¯å†™ç»™äººçœ‹çš„ï¼Œé¡ºä¾¿è®©æœºå™¨æ‰§è¡Œ æ¶æ„è®¾è®¡è¦é€‚é…ä¸šåŠ¡å¤æ‚åº¦ï¼Œé¿å…è¿‡åº¦è®¾è®¡ æ€§èƒ½ä¼˜åŒ–è¦åŸºäºæ•°æ®é©±åŠ¨ï¼Œè€Œä¸æ˜¯å‡­æ„Ÿè§‰ æŠ€æœ¯çš„æœ¬è´¨æ˜¯è§£å†³é—®é¢˜ï¼Œè€Œä¸æ˜¯ç‚«æŠ€ æ•™è‚²èƒŒæ™¯ å¤ªåŸç†å·¥å¤§å­¦ - è½¯ä»¶å·¥ç¨‹ï¼ˆåŒä¸€æµï¼‰ - æœ¬ç§‘ (2022.09 - 2026.06) å·¥ä½œç»å† æŸæ˜•ç½‘ç»œç§‘æŠ€å…¬å¸ - Java å¼€å‘å®ä¹ ç”Ÿ (2024.06 - 2024.12)\nè´Ÿè´£å¿«é€Ÿå¼€å‘ä¸äº¤ä»˜ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¸»åŠ¨æ•´ç†é€šç”¨ä»£ç æ¨¡ç‰ˆï¼Œå‡å°‘äº†é‡å¤ CRUD å·¥ä½œï¼Œé…åˆå›¢é˜Ÿé«˜æ•ˆäº¤ä»˜äº† 20+ ä¸ªå®šåˆ¶åŒ–é¡¹ç›®ã€‚\næ ¸å¿ƒæˆæœï¼š\nè®¾è®¡å¹¶å®ç°åŠ¨æ€çº¿ç¨‹æ±  SDKï¼Œæ”¯æŒå‚æ•°å®æ—¶è°ƒæ•´å’Œå¯è§†åŒ–ç›‘æ§ å‚ä¸æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿå¼€å‘ï¼Œè´Ÿè´£ DDD æ¶æ„è®¾è®¡å’Œåˆ†å¸ƒå¼é”ä¼˜åŒ– ä¼˜åŒ–æ ¸å¿ƒæ¥å£æ€§èƒ½ï¼ŒRT ä» 800ms é™ä½åˆ° 120ms æŠ€æœ¯ä¸“é•¿ è¯¦è§ æŠ€èƒ½æ ˆ\né¡¹ç›®ä½œå“ è¯¦è§ é¡¹ç›®å±•ç¤º\nå¼€æºè´¡çŒ® æ­£åœ¨ç­¹å¤‡ä¸­ï¼Œè®¡åˆ’å¼€æºåŠ¨æ€çº¿ç¨‹æ±  SDK å’Œä¸€äº›å®ç”¨å·¥å…·åº“ã€‚\nè”ç³»æ–¹å¼ Email: your-email@example.com GitHub: github.com/wawayu-dev åšå®¢: ä½ æ­£åœ¨æµè§ˆçš„è¿™ä¸ªç«™ç‚¹ å…³äºè¿™ä¸ªåšå®¢ è¿™ä¸ªåšå®¢æ˜¯æˆ‘çš„æŠ€æœ¯ç¬”è®°å’Œæ€è€ƒæ²‰æ·€çš„åœ°æ–¹ã€‚æˆ‘ä¼šåœ¨è¿™é‡Œåˆ†äº«ï¼š\né¡¹ç›®å®æˆ˜ç»éªŒå’Œè¸©å‘è®°å½• æŠ€æœ¯åŸç†çš„æ·±åº¦å‰–æ æ¶æ„è®¾è®¡çš„æ€è€ƒä¸å®è·µ å­¦ä¹ æ–¹æ³•å’Œæˆé•¿å¿ƒå¾— å¦‚æœä½ å¯¹æŸä¸ªè¯é¢˜æ„Ÿå…´è¶£ï¼Œæˆ–è€…å‘ç°æ–‡ç« ä¸­çš„é—®é¢˜ï¼Œæ¬¢è¿é€šè¿‡é‚®ä»¶æˆ– GitHub ä¸æˆ‘äº¤æµã€‚\nè¿™ä¸ªç½‘ç«™ä½¿ç”¨ Hugo + PaperMod æ­å»ºï¼Œæ‰˜ç®¡åœ¨ GitHub Pages\n","permalink":"http://localhost:1313/about/","summary":"Java åç«¯å¼€å‘å·¥ç¨‹å¸ˆ | åˆ†å¸ƒå¼ç³»ç»Ÿå®è·µè€…","title":"å…³äºæˆ‘"},{"content":"ç¼–ç¨‹è¯­è¨€ è¯­è¨€ ç†Ÿç»ƒåº¦ ä¸»è¦ç”¨é€” Java â­â­â­â­â­ åç«¯å¼€å‘ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€å¾®æœåŠ¡æ¶æ„ SQL â­â­â­â­ æ•°æ®åº“è®¾è®¡ã€æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•è°ƒä¼˜ JavaScript â­â­â­ å‰ç«¯å¼€å‘ã€Vue 3 åº”ç”¨ æ ¸å¿ƒæŠ€æœ¯æ ˆ åç«¯æ¡†æ¶ä¸ä¸­é—´ä»¶ Spring ç”Ÿæ€\nSpring Bootï¼šç†Ÿæ‚‰è‡ªåŠ¨è£…é…åŸç†ï¼Œèƒ½å¤Ÿè‡ªå®šä¹‰ Starter Spring AOP/IOCï¼šç†è§£æ ¸å¿ƒæ€æƒ³ï¼Œç†Ÿæ‚‰ Bean ç”Ÿå‘½å‘¨æœŸ MyBatis-Plusï¼šå¿«é€Ÿå¼€å‘ CRUDï¼Œç†Ÿæ‚‰ä»£ç ç”Ÿæˆå’Œé€šç”¨ Mapper åˆ†å¸ƒå¼ä¸é«˜å¹¶å‘\nRedisï¼šåˆ†å¸ƒå¼é”ï¼ˆRedissonï¼‰ã€ç¼“å­˜æ¶æ„è®¾è®¡ã€Pub/Sub æœºåˆ¶ RabbitMQï¼šæ¶ˆæ¯å¯é æ€§ä¿éšœã€å¼‚æ­¥è§£è€¦ã€æ­»ä¿¡é˜Ÿåˆ— Netty + WebSocketï¼šå®æ—¶æ¶ˆæ¯æ¨é€ã€é•¿è¿æ¥ç®¡ç† æ•°æ®åº“\nMySQLï¼šç´¢å¼•ä¼˜åŒ–ã€äº‹åŠ¡éš”ç¦»çº§åˆ«ã€MVCC æœºåˆ¶ã€B+ æ ‘ç´¢å¼•å¼•æ“ ShardingSphereï¼šåˆ†åº“åˆ†è¡¨å®æˆ˜ã€åˆ†ç‰‡ç­–ç•¥è®¾è®¡ æ¶æ„è®¾è®¡ è®¾è®¡æ¨¡å¼ä¸æ¶æ„æ€æƒ³\nDDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰ï¼šèšåˆæ ¹ã€é™ç•Œä¸Šä¸‹æ–‡ã€é¢†åŸŸäº‹ä»¶ è®¾è®¡æ¨¡å¼ï¼šç†Ÿæ‚‰ç­–ç•¥ã€æ¨¡æ¿æ–¹æ³•ã€è´£ä»»é“¾ç­‰å¸¸ç”¨æ¨¡å¼ è§„åˆ™å¼•æ“ï¼šç†è§£å¦‚ä½•é€šè¿‡è§„åˆ™å¼•æ“åˆ¤æ–­å¤æ‚ä¸šåŠ¡é€»è¾‘ æ€§èƒ½ä¼˜åŒ–\nJVM è°ƒä¼˜ï¼šç†è§£ GC æœºåˆ¶ã€å†…å­˜æ¨¡å‹ã€OOM æ’æŸ¥ æ¥å£ä¼˜åŒ–ï¼šä» 800ms ä¼˜åŒ–åˆ° 120ms çš„å®æˆ˜ç»éªŒ æ•°æ®åº“ä¼˜åŒ–ï¼šSQL è°ƒä¼˜ã€ç´¢å¼•è®¾è®¡ã€åˆ†åº“åˆ†è¡¨ å‰ç«¯æŠ€æœ¯ Vue 3ï¼šComposition APIã€å‰åç«¯åˆ†ç¦»å¼€å‘ EasyExcelï¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€å†…å­˜ä¼˜åŒ– å·¥å…·ä¸è¿ç»´ å¼€å‘å·¥å…·\nGitï¼šåˆ†æ”¯ç®¡ç†ã€ä»£ç å®¡æŸ¥ã€å›¢é˜Ÿåä½œ Mavenï¼šä¾èµ–ç®¡ç†ã€å¤šæ¨¡å—é¡¹ç›®æ„å»º Dockerï¼šå®¹å™¨åŒ–éƒ¨ç½²ã€å¤šé˜¶æ®µæ„å»ºã€Docker Compose è¿ç»´ä¸éƒ¨ç½²\nNginxï¼šåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€é™æ€èµ„æºç¼“å­˜ Linuxï¼šå¸¸ç”¨å‘½ä»¤ã€Shell è„šæœ¬ã€æœåŠ¡å™¨è¿ç»´ ä¸­é—´ä»¶ä¸å·¥å…·\nZookeeperï¼šåˆ†å¸ƒå¼åè°ƒã€æœåŠ¡æ³¨å†Œå‘ç° Dubboï¼šRPC æ¡†æ¶ã€æœåŠ¡æ²»ç† æŠ€æœ¯æ·±åº¦ æºç é˜…è¯»èƒ½åŠ› Spring Boot Starter è‡ªåŠ¨è£…é…æœºåˆ¶ Redisson çœ‹é—¨ç‹—ç»­æœŸåŸç† MyBatis åŠ¨æ€ SQL ç”Ÿæˆæµç¨‹ é—®é¢˜æ’æŸ¥èƒ½åŠ› çº¿ä¸Š OOM é—®é¢˜å®šä½ï¼ˆjmapã€MAT å·¥å…·ï¼‰ æ¥å£æ€§èƒ½ç“¶é¢ˆåˆ†æï¼ˆArthasã€JProfilerï¼‰ åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜æ’æŸ¥ æ¶æ„è®¾è®¡èƒ½åŠ› ä» 0 åˆ° 1 è®¾è®¡æ‹¼å›¢äº¤æ˜“å¹³å°ï¼ˆDDD æ¶æ„ï¼‰ è®¾è®¡åŠ¨æ€çº¿ç¨‹æ±  SDKï¼ˆé›¶ä¾µå…¥å¼ï¼‰ åˆ†å¸ƒå¼é”æ–¹æ¡ˆè®¾è®¡ï¼ˆRedis + Redissonï¼‰ å­¦ä¹ æ–¹æ³• æˆ‘ç›¸ä¿¡\u0026quot;æºç æ˜¯æœ€å¥½çš„è€å¸ˆ\u0026quot;ã€‚åœ¨å­¦ä¹ æ–°æŠ€æœ¯æ—¶ï¼Œæˆ‘ä¼šï¼š\nå…ˆç†è§£æ ¸å¿ƒæ¦‚å¿µå’Œä½¿ç”¨åœºæ™¯ é€šè¿‡å®æˆ˜é¡¹ç›®åŠ æ·±ç†è§£ é˜…è¯»æºç ç†è§£åº•å±‚å®ç° æ€»ç»“æˆåšå®¢æ–‡ç« æ²‰æ·€çŸ¥è¯† æ­£åœ¨å­¦ä¹  Kubernetesï¼šå®¹å™¨ç¼–æ’ã€æœåŠ¡ç½‘æ ¼ Elasticsearchï¼šå…¨æ–‡æœç´¢ã€æ—¥å¿—åˆ†æ Go è¯­è¨€ï¼šé«˜å¹¶å‘ç¼–ç¨‹ã€å¾®æœåŠ¡å¼€å‘ æŠ€èƒ½è®¤è¯ ç†Ÿæ‚‰ JUC å¹¶å‘å·¥å…·ã€ç†è§£ AQSã€CAS åŠé”å‡çº§è¿‡ç¨‹ ç†Ÿæ‚‰çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜å’Œç›‘æ§ ç†è§£ volatileã€synchronized çš„å†…å­˜è¯­ä¹‰ä¸å¯è§æ€§ ä»¥ä¸ŠæŠ€èƒ½å‡æ¥è‡ªå®é™…é¡¹ç›®ç»éªŒå’Œæ·±åº¦å­¦ä¹ ï¼ŒæŒç»­æ›´æ–°ä¸­\n","permalink":"http://localhost:1313/skills/","summary":"æŠ€æœ¯èƒ½åŠ›æ€»è§ˆ - ä¸“æ³¨åç«¯å¼€å‘ä¸åˆ†å¸ƒå¼ç³»ç»Ÿ","title":"æŠ€èƒ½æ ˆ"},{"content":"é¡¹ç›®ç®€ä»‹ [ç”¨ 2-3 å¥è¯è¯´æ¸…æ¥šï¼šåšäº†ä»€ä¹ˆã€è§£å†³ä»€ä¹ˆé—®é¢˜]\næºç ï¼šGitHub\næ¼”ç¤ºï¼šåœ¨çº¿åœ°å€ï¼ˆå¯é€‰ï¼‰\næŠ€æœ¯æ ˆ åç«¯ï¼š å‰ç«¯ï¼š æ•°æ®åº“ï¼š éƒ¨ç½²ï¼š æ ¸å¿ƒåŠŸèƒ½ æŠ€æœ¯äº®ç‚¹ [äº®ç‚¹1ï¼šæ¯”å¦‚æ€§èƒ½ä¼˜åŒ–] [ç®€è¿°é—®é¢˜ + è§£å†³æ–¹æ¡ˆ]\n1// å…³é”®ä»£ç ç‰‡æ®µï¼ˆå¯é€‰ï¼‰ [äº®ç‚¹2ï¼šæ¯”å¦‚æ¶æ„è®¾è®¡] [ç®€è¿°æ€è·¯]\né¡¹ç›®æˆæœ æ•°æ®æŒ‡æ ‡ï¼ˆå¦‚æœ‰ï¼‰ å­¦åˆ°äº†ä»€ä¹ˆ ğŸ’¡ å¤åˆ¶è¿™ä¸ªæ¨¡æ¿ï¼Œå¡«å…¥ä½ çš„çœŸå®é¡¹ç›®\n","permalink":"http://localhost:1313/projects/example-project/","summary":"\u003ch2 id=\"é¡¹ç›®ç®€ä»‹\"\u003eé¡¹ç›®ç®€ä»‹\u003c/h2\u003e\n\u003cp\u003e[ç”¨ 2-3 å¥è¯è¯´æ¸…æ¥šï¼šåšäº†ä»€ä¹ˆã€è§£å†³ä»€ä¹ˆé—®é¢˜]\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæºç \u003c/strong\u003eï¼š\u003ca href=\"https://github.com/%E4%BD%A0%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D/%E9%A1%B9%E7%9B%AE%E5%90%8D\"\u003eGitHub\u003c/a\u003e\u003cbr\u003e\n\u003cstrong\u003eæ¼”ç¤º\u003c/strong\u003eï¼š\u003ca href=\"#\"\u003eåœ¨çº¿åœ°å€\u003c/a\u003eï¼ˆå¯é€‰ï¼‰\u003c/p\u003e\n\u003ch2 id=\"æŠ€æœ¯æ ˆ\"\u003eæŠ€æœ¯æ ˆ\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eåç«¯ï¼š\u003c/li\u003e\n\u003cli\u003eå‰ç«¯ï¼š\u003c/li\u003e\n\u003cli\u003eæ•°æ®åº“ï¼š\u003c/li\u003e\n\u003cli\u003eéƒ¨ç½²ï¼š\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"æ ¸å¿ƒåŠŸèƒ½\"\u003eæ ¸å¿ƒåŠŸèƒ½\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"æŠ€æœ¯äº®ç‚¹\"\u003eæŠ€æœ¯äº®ç‚¹\u003c/h2\u003e\n\u003ch3 id=\"äº®ç‚¹1æ¯”å¦‚æ€§èƒ½ä¼˜åŒ–\"\u003e[äº®ç‚¹1ï¼šæ¯”å¦‚æ€§èƒ½ä¼˜åŒ–]\u003c/h3\u003e\n\u003cp\u003e[ç®€è¿°é—®é¢˜ + è§£å†³æ–¹æ¡ˆ]\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e// å…³é”®ä»£ç ç‰‡æ®µï¼ˆå¯é€‰ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"äº®ç‚¹2æ¯”å¦‚æ¶æ„è®¾è®¡\"\u003e[äº®ç‚¹2ï¼šæ¯”å¦‚æ¶æ„è®¾è®¡]\u003c/h3\u003e\n\u003cp\u003e[ç®€è¿°æ€è·¯]\u003c/p\u003e\n\u003ch2 id=\"é¡¹ç›®æˆæœ\"\u003eé¡¹ç›®æˆæœ\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eæ•°æ®æŒ‡æ ‡ï¼ˆå¦‚æœ‰ï¼‰\u003c/li\u003e\n\u003cli\u003eå­¦åˆ°äº†ä»€ä¹ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cblockquote\u003e\n\u003cp\u003eğŸ’¡ å¤åˆ¶è¿™ä¸ªæ¨¡æ¿ï¼Œå¡«å…¥ä½ çš„çœŸå®é¡¹ç›®\u003c/p\u003e\n\u003c/blockquote\u003e","title":"[é¡¹ç›®åç§°]"},{"content":"åœ¨ç¢ç‰‡åŒ–ä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œæ‹¥æœ‰ä¸€å¥—å®Œå…¨å—è‡ªå·±æŒæ§çš„æŠ€æœ¯ä¸“æ ï¼Œæ˜¯æ¯ä½å¼€å‘è€…æ²‰æ·€æ€è€ƒã€æ‰“é€ ä¸ªäººå“ç‰Œçš„æ ¸å¿ƒèµ„äº§ã€‚ç›¸æ¯”äºè¢«å¹³å°ç®—æ³•ç»‘æ¶çš„å…¬ä¼—å·ï¼Œæˆ–æ˜¯å……æ–¥å¹¿å‘Šçš„ç¬¬ä¸‰æ–¹åšå®¢ï¼ŒHugo è¿™ç±»é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ç»™äº†æˆ‘ä»¬çœŸæ­£çš„è‡ªç”±ï¼šæ¯«ç§’çº§æ„å»ºã€Markdown åŸç”Ÿæ”¯æŒã€å®Œå…¨çš„æ ·å¼æ§åˆ¶æƒã€‚\nä½†å¾ˆå¤šäººåœ¨æ­å»º Hugo åšå®¢æ—¶ï¼Œå¾€å¾€é™·å…¥\u0026quot;ç…§ç€æ–‡æ¡£æ•²å‘½ä»¤\u0026quot;çš„æœºæ¢°é‡å¤ã€‚æœ¬æ–‡ä¸æ˜¯åˆä¸€ç¯‡å®‰è£…æ•™ç¨‹ï¼Œè€Œæ˜¯ä»ç³»ç»Ÿæ¶æ„çš„è§’åº¦ï¼Œå¸¦ä½ ç†è§£ Hugo + PaperMod è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡é€»è¾‘ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Hugo Extended ä¸ PaperMod çš„ä¾èµ–å…³ç³» æŒæ¡ Git Submodule çš„ä¸»é¢˜ç®¡ç†æ–¹æ¡ˆ è®¾è®¡åŸºäº GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿ å»ºç«‹å·¥ç¨‹åŒ–æ€ç»´è€Œé\u0026quot;è·Ÿç€åš\u0026quot;çš„æ“ä½œæ€ç»´ 01. åŸºç¡€è®¾æ–½ï¼šä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ Hugo Extendedï¼Ÿ å¾ˆå¤šäººç¬¬ä¸€æ¬¡æ­å»º Hugo åšå®¢æ—¶ï¼Œä¼šé‡åˆ°ä¸€ä¸ªè¯¡å¼‚çš„æŠ¥é”™ï¼šTOCSS: failed to transform \u0026quot;css/main.css\u0026quot;ã€‚æ˜æ˜æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è£…äº† Hugoï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºé”™ï¼Ÿ\né—®é¢˜å‡ºåœ¨ç‰ˆæœ¬é€‰æ‹©ä¸Šã€‚Hugo åˆ†ä¸ºæ™®é€šç‰ˆå’Œ Extended ç‰ˆï¼Œåè€…å†…ç½®äº† LibSass ç¼–è¯‘å™¨ã€‚è€Œ PaperMod è¿™ç±»ç°ä»£ä¸»é¢˜å¤§é‡ä½¿ç”¨ SCSS/SASS æ¥å®ç°ä¸»é¢˜å˜é‡ã€æš—é»‘æ¨¡å¼åˆ‡æ¢ç­‰ç‰¹æ€§ã€‚å¦‚æœä½ ç”¨æ™®é€šç‰ˆ Hugoï¼Œç¼–è¯‘æµç¨‹ä¼šåœ¨ CSS è½¬æ¢ç¯èŠ‚ç›´æ¥å´©æºƒã€‚\nåœ¨ Windows ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ç”¨ Winget æ¥å®‰è£…ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ä¸‹è½½ zip åŒ…ï¼š\n1# ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œç¡®ä¿ç‰ˆæœ¬å¯è¿½æº¯ 2winget install Hugo.Hugo.Extended 3 4# éªŒè¯å®‰è£…ï¼šå¿…é¡»çœ‹åˆ° +extended æ ‡è¯† 5hugo version 6# é¢„æœŸè¾“å‡º: hugo v0.12x.x+extended windows/amd64 ä¸ºä»€ä¹ˆåšæŒç”¨åŒ…ç®¡ç†å™¨ï¼Ÿå› ä¸ºè¿™æ˜¯\u0026quot;å¯å¤ç°ç¯å¢ƒ\u0026quot;çš„ç¬¬ä¸€æ­¥ã€‚å½“ä½ çš„åšå®¢éœ€è¦å›¢é˜Ÿåä½œï¼Œæˆ–è€…æ¢äº†å°ç”µè„‘é‡æ–°éƒ¨ç½²æ—¶ï¼Œä¸€æ¡å‘½ä»¤å°±èƒ½æ¢å¤å®Œå…¨ä¸€è‡´çš„ç¯å¢ƒï¼Œè€Œä¸æ˜¯åœ¨\u0026quot;æˆ‘ç”µè„‘ä¸Šèƒ½è·‘\u0026quot;çš„æ³¥æ½­é‡ŒæŒ£æ‰ã€‚\næ¥ä¸‹æ¥åˆå§‹åŒ–ç«™ç‚¹éª¨æ¶ï¼š\n1hugo new site myblog 2cd myblog 3git init è¿™ä¸‰è¡Œå‘½ä»¤çœ‹ä¼¼ç®€å•ï¼Œä½†èƒŒåæ˜¯ Hugo çš„\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;å“²å­¦ï¼šcontent/ å­˜æ”¾å†…å®¹æºæ–‡ä»¶ï¼Œthemes/ ç®¡ç†è§†è§‰å±‚ï¼Œpublic/ ä½œä¸ºç¼–è¯‘äº§ç‰©è¾“å‡ºã€‚è¿™ç§æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œè®©æˆ‘ä»¬å¯ä»¥ç‹¬ç«‹ç®¡ç†å†…å®¹ã€ä¸»é¢˜å’Œæ„å»ºæµç¨‹ã€‚\næ¶æ„æ€è€ƒï¼š Hugo çš„ç›®å½•ç»“æ„æœ¬è´¨ä¸Šæ˜¯ä¸€ç§\u0026quot;å…³æ³¨ç‚¹åˆ†ç¦»\u0026quot;çš„è®¾è®¡æ¨¡å¼ã€‚å†…å®¹åˆ›ä½œè€…åªéœ€è¦å…³å¿ƒ content/ ä¸‹çš„ Markdownï¼Œä¸»é¢˜å¼€å‘è€…ä¸“æ³¨äº themes/ çš„æ¨¡æ¿é€»è¾‘ï¼Œè€Œ CI/CD æµæ°´çº¿åªéœ€è¦å¤„ç† public/ çš„éƒ¨ç½²ã€‚è¿™ç§è§£è€¦è®¾è®¡ï¼Œæ˜¯å¤§è§„æ¨¡å†…å®¹ç”Ÿäº§çš„åŸºç¡€ã€‚\n02. ä¸»é¢˜ä¾èµ–ï¼šä¸ºä»€ä¹ˆé€‰æ‹© Git Submoduleï¼Ÿ å¼•å…¥ PaperMod ä¸»é¢˜æœ‰ä¸¤ç§æ–¹å¼ï¼šç›´æ¥ä¸‹è½½ zip åŒ…è§£å‹åˆ° themes/ ç›®å½•ï¼Œæˆ–è€…ç”¨ Git Submoduleã€‚å¾ˆå¤šæ•™ç¨‹ä¼šæ¨èå‰è€…ï¼Œå› ä¸º\u0026quot;ç®€å•\u0026quot;ã€‚ä½†è¿™ç§ç®€å•æ˜¯æœ‰ä»£ä»·çš„ã€‚\næƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šPaperMod å®˜æ–¹ä¿®å¤äº†ä¸€ä¸ªæš—é»‘æ¨¡å¼çš„ Bugï¼Œæˆ–è€…æ–°å¢äº†æœç´¢åŠŸèƒ½ã€‚å¦‚æœä½ æ˜¯ç›´æ¥ä¸‹è½½çš„ä¸»é¢˜ï¼Œæ›´æ–°æµç¨‹ä¼šå˜æˆï¼šå» GitHub ä¸‹è½½æ–°ç‰ˆ â†’ åˆ é™¤æ—§æ–‡ä»¶ â†’ è§£å‹è¦†ç›– â†’ ç¥ˆç¥·æ²¡æœ‰å†²çªã€‚è€Œå¦‚æœç”¨ Submoduleï¼Œåªéœ€è¦ä¸€æ¡å‘½ä»¤ï¼š\n1# å»ºç«‹ä¸»é¢˜å­æ¨¡å—ä¾èµ– 2git submodule add --depth=1 https://github.com/adityatelange/hugo-PaperMod.git themes/PaperMod 3 4# æœªæ¥æ›´æ–°ä¸»é¢˜åªéœ€è¦ 5git submodule update --remote --merge Submodule çš„æœ¬è´¨æ˜¯\u0026quot;ä¾èµ–å¤–éƒ¨åŒ–\u0026quot;ã€‚ä¸»é¢˜ä»£ç ä¸ä¼šæ±¡æŸ“ä½ çš„ä¸»ä»“åº“æäº¤å†å²ï¼ŒåŒæ—¶åˆèƒ½é€šè¿‡ .gitmodules æ–‡ä»¶ç²¾ç¡®é”å®šä¾èµ–ç‰ˆæœ¬ã€‚è¿™ç§è®¾è®¡åœ¨å¤§å‹å¼€æºé¡¹ç›®ä¸­æä¸ºå¸¸è§ï¼ˆæ¯”å¦‚ Linux å†…æ ¸çš„é©±åŠ¨æ¨¡å—ç®¡ç†ï¼‰ã€‚\nç„¶ååœ¨ hugo.toml ä¸­æ¿€æ´»ä¸»é¢˜ï¼š\n1theme = \u0026#34;PaperMod\u0026#34; è¿™ä¸€è¡Œé…ç½®æ˜¯æ•´ä¸ªç«™ç‚¹çš„\u0026quot;æ§åˆ¶æ¢çº½\u0026quot;ï¼Œå®ƒå‘Šè¯‰ Hugo åœ¨ç¼–è¯‘æ—¶å» themes/PaperMod/ ç›®å½•å¯»æ‰¾æ¨¡æ¿æ–‡ä»¶ã€‚\né¿å‘æç¤ºï¼š å¦‚æœä½ å…‹éš†äº†åˆ«äººçš„ Hugo é¡¹ç›®ï¼Œè®°å¾—æ‰§è¡Œ git submodule update --init --recursiveï¼Œå¦åˆ™ themes/ ç›®å½•ä¼šæ˜¯ç©ºçš„ï¼Œå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚\n03. å†…å®¹ç”Ÿäº§ï¼šä»æ¨¡æ¿åˆ°å®æ—¶é¢„è§ˆ åˆ›å»ºç¬¬ä¸€ç¯‡æ–‡ç« ï¼š\n1hugo new posts/my-first-post.md è¿™æ¡å‘½ä»¤ä¼šæ ¹æ® archetypes/default.md æ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆæ–‡ç« éª¨æ¶ï¼ŒåŒ…æ‹¬ Front Matterï¼ˆæ ‡é¢˜ã€æ—¥æœŸã€æ ‡ç­¾ç­‰å…ƒæ•°æ®ï¼‰ã€‚è¿™ä¿è¯äº†å…¨ç«™æ–‡ç« æ ¼å¼çš„ä¸€è‡´æ€§ï¼Œé¿å…äº†æ‰‹åŠ¨ç¼–å†™ YAML æ—¶çš„ä½çº§é”™è¯¯ã€‚\né»˜è®¤ç”Ÿæˆçš„æ–‡ç« åŒ…å« draft: true å­—æ®µï¼Œè¿™æ˜¯ Hugo çš„\u0026quot;è‰ç¨¿æ€\u0026quot;æœºåˆ¶ã€‚åœ¨æ­£å¼æ„å»ºæ—¶ï¼Œè‰ç¨¿ä¸ä¼šè¢«ç¼–è¯‘ã€‚è¿™ä¸ªè®¾è®¡å¾ˆè´´å¿ƒï¼šä½ å¯ä»¥åœ¨æœ¬åœ°éšæ„å†™åŠæˆå“æ–‡ç« ï¼Œä¸ç”¨æ‹…å¿ƒå®ƒä»¬è¢«æ„å¤–å‘å¸ƒã€‚\nå¯åŠ¨æœ¬åœ°é¢„è§ˆæœåŠ¡å™¨ï¼š\n1hugo server -D 2# è®¿é—® http://localhost:1313 -D å‚æ•°è¡¨ç¤ºé¢„è§ˆè‰ç¨¿ã€‚Hugo çš„å®æ—¶é¢„è§ˆèƒ½åŠ›æºäºå…¶\u0026quot;å¢é‡ç¼–è¯‘\u0026quot;è®¾è®¡ï¼šå®ƒä¸ä¼šåœ¨æ¯æ¬¡æ–‡ä»¶å˜æ›´æ—¶é‡æ–°æ„å»ºæ•´ä¸ªç«™ç‚¹ï¼Œè€Œæ˜¯é€šè¿‡ä¾èµ–å›¾åˆ†æï¼Œåªé‡æ–°ç¼–è¯‘å—å½±å“çš„é¡µé¢ã€‚å³ä½¿ä½ çš„åšå®¢æœ‰ä¸Šåƒç¯‡æ–‡ç« ï¼Œé¢„è§ˆå»¶è¿Ÿä¹Ÿèƒ½æ§åˆ¶åœ¨ 100ms ä»¥å†…ã€‚\nè¿™ç§æ¯«ç§’çº§çš„åé¦ˆå¾ªç¯ï¼Œè®©å†™ä½œå˜æˆäº†ä¸€ç§\u0026quot;æ‰€è§å³æ‰€å¾—\u0026quot;çš„æµç•…ä½“éªŒã€‚ä½ æ”¹ä¸€ä¸ªæ ‡ç‚¹ï¼Œæµè§ˆå™¨ç«‹åˆ»åˆ·æ–°ï¼›ä½ è°ƒæ•´ä¸€ä¸ªæ ·å¼ï¼Œæ•ˆæœç¬é—´å‘ˆç°ã€‚è¿™ç§å³æ—¶åé¦ˆï¼Œæ˜¯ä¿æŒåˆ›ä½œå¿ƒæµçš„å…³é”®ã€‚\n04. è‡ªåŠ¨åŒ–æµæ°´çº¿ï¼šæäº¤å³å‘å¸ƒçš„é­”æ³• æ‰‹åŠ¨æ„å»ºã€æ‰‹åŠ¨ä¸Šä¼ çš„æ—¶ä»£æ—©è¯¥ç»“æŸäº†ã€‚æˆ‘ä»¬è¦çš„æ˜¯\u0026quot;git push ä¹‹åå–æ¯å’–å•¡ï¼Œå›æ¥åšå®¢å°±æ›´æ–°äº†\u0026quot;çš„ä¸æ»‘ä½“éªŒã€‚\nGitHub Actions æ˜¯å®ç°è¿™ä¸ªç›®æ ‡çš„æœ€ä½³å·¥å…·ã€‚å®ƒçš„å·¥ä½œæµç¨‹æ˜¯ï¼šä½ æ¨é€ä»£ç åˆ° GitHub â†’ Actions è‡ªåŠ¨æ‹‰å–ä»£ç  â†’ è°ƒç”¨ Hugo ç¼–è¯‘ â†’ å°†ç”Ÿæˆçš„é™æ€æ–‡ä»¶éƒ¨ç½²åˆ° GitHub Pagesã€‚\nåœ¨ .github/workflows/hugo.yml ä¸­åˆ›å»ºå·¥ä½œæµé…ç½®ï¼š\n1name: Deploy Hugo site to Pages 2 3on: 4 push: 5 branches: [\u0026#34;main\u0026#34;] 6 7permissions: 8 contents: read 9 pages: write 10 id-token: write 11 12jobs: 13 build: 14 runs-on: ubuntu-latest 15 steps: 16 - name: Checkout 17 uses: actions/checkout@v4 18 with: 19 submodules: recursive # å…³é”®ï¼šé€’å½’æ‹‰å–ä¸»é¢˜å­æ¨¡å— 20 fetch-depth: 0 21 22 - name: Setup Hugo 23 uses: peaceiris/actions-hugo@v3 24 with: 25 hugo-version: \u0026#39;latest\u0026#39; 26 extended: true # å¿…é¡»å¼€å¯ Extended æ”¯æŒ 27 28 - name: Build 29 run: hugo --minify # å‹ç¼© HTML/CSS/JS 30 31 - name: Upload artifact 32 uses: actions/upload-pages-artifact@v3 33 with: 34 path: ./public 35 36 deploy: 37 environment: 38 name: github-pages 39 runs-on: ubuntu-latest 40 needs: build 41 steps: 42 - id: deployment 43 uses: actions/deploy-pages@v4 è¿™ä¸ªé…ç½®æ–‡ä»¶çš„æ ¸å¿ƒæ˜¯ submodules: recursiveã€‚å¦‚æœæ¼æ‰è¿™ä¸€è¡Œï¼ŒActions æ‹‰å–ä»£ç æ—¶ä¸ä¼šä¸‹è½½ PaperMod ä¸»é¢˜ï¼Œå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚è¿™æ˜¯å¾ˆå¤šäººç¬¬ä¸€æ¬¡é…ç½® CI/CD æ—¶è¸©çš„å‘ã€‚\nhugo --minify ä¼šå‹ç¼©ç”Ÿæˆçš„ HTMLã€CSSã€JS æ–‡ä»¶ï¼Œå‡å°‘ä¼ è¾“ä½“ç§¯ã€‚å¯¹äºä¸€ä¸ªä¸­ç­‰è§„æ¨¡çš„åšå®¢ï¼Œè¿™èƒ½èŠ‚çœ 30-40% çš„å¸¦å®½ã€‚\næ¶æ„æ€è€ƒï¼š è¿™å¥— CI/CD æµæ°´çº¿çš„æœ¬è´¨æ˜¯\u0026quot;åŸºç¡€è®¾æ–½å³ä»£ç \u0026quot;ï¼ˆInfrastructure as Codeï¼‰ã€‚éƒ¨ç½²æµç¨‹ä¸å†æ˜¯å£å£ç›¸ä¼ çš„æ“ä½œæ‰‹å†Œï¼Œè€Œæ˜¯ç‰ˆæœ¬æ§åˆ¶çš„ YAML æ–‡ä»¶ã€‚ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°éƒ¨ç½²é€»è¾‘ï¼Œä»»ä½•ä¿®æ”¹éƒ½æœ‰å®¡è®¡è®°å½•ã€‚è¿™ç§é€æ˜æ€§å’Œå¯å¤ç°æ€§ï¼Œæ˜¯ç°ä»£ DevOps çš„æ ¸å¿ƒç†å¿µã€‚\n05. æ€»ç»“ä¸æ€è€ƒ æˆ‘ä»¬ä» Hugo Extended çš„ç‰ˆæœ¬é€‰æ‹©ï¼Œåˆ° Git Submodule çš„ä¾èµ–ç®¡ç†ï¼Œå†åˆ° GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œæ„å»ºäº†ä¸€å¥—å®Œæ•´çš„åšå®¢å·¥ç¨‹åŒ–æ–¹æ¡ˆã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸ºäº†\u0026quot;æ­ä¸ªåšå®¢\u0026quot;ï¼Œæ›´æ˜¯ä¸€æ¬¡å¯¹é™æ€ç«™ç‚¹ç¼–è¯‘æµç¨‹ã€ä¾èµ–ç®¡ç†æ€æƒ³ã€CI/CD å®è·µçš„æ·±åº¦ç†è§£ã€‚\nå¦‚æœä½ çš„åšå®¢æœªæ¥éœ€è¦æ”¯æŒå¤šè¯­è¨€ç‰ˆæœ¬ï¼Œæˆ–è€…éœ€è¦é’ˆå¯¹ä¸åŒç»ˆç«¯æä¾›å·®å¼‚åŒ–çš„æœç´¢ä½“éªŒï¼Œä½ ä¼šå¦‚ä½•ä» hugo.toml çš„é…ç½®å±‚çº§è¿›è¡Œè§£è€¦è®¾è®¡ï¼Ÿæç¤ºï¼šå¯ä»¥ç ”ç©¶ Hugo çš„ languages é…ç½®å’Œ outputFormats æœºåˆ¶ã€‚\næŠ€æœ¯çš„æœ¬è´¨ä¸æ˜¯å·¥å…·çš„å †ç Œï¼Œè€Œæ˜¯å¯¹é—®é¢˜çš„æ·±åº¦ç†è§£ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ è·³å‡º\u0026quot;ç…§ç€åš\u0026quot;çš„æ€ç»´å®šå¼ï¼ŒçœŸæ­£ç†è§£ Hugo è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡å“²å­¦ã€‚\n","permalink":"http://localhost:1313/posts/2026/02/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%9E%84%E5%BB%BA-hugo--papermod-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/","summary":"\u003cp\u003eåœ¨ç¢ç‰‡åŒ–ä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œæ‹¥æœ‰ä¸€å¥—å®Œå…¨å—è‡ªå·±æŒæ§çš„æŠ€æœ¯ä¸“æ ï¼Œæ˜¯æ¯ä½å¼€å‘è€…æ²‰æ·€æ€è€ƒã€æ‰“é€ ä¸ªäººå“ç‰Œçš„æ ¸å¿ƒèµ„äº§ã€‚ç›¸æ¯”äºè¢«å¹³å°ç®—æ³•ç»‘æ¶çš„å…¬ä¼—å·ï¼Œæˆ–æ˜¯å……æ–¥å¹¿å‘Šçš„ç¬¬ä¸‰æ–¹åšå®¢ï¼ŒHugo è¿™ç±»é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ç»™äº†æˆ‘ä»¬çœŸæ­£çš„è‡ªç”±ï¼šæ¯«ç§’çº§æ„å»ºã€Markdown åŸç”Ÿæ”¯æŒã€å®Œå…¨çš„æ ·å¼æ§åˆ¶æƒã€‚\u003c/p\u003e\n\u003cp\u003eä½†å¾ˆå¤šäººåœ¨æ­å»º Hugo åšå®¢æ—¶ï¼Œå¾€å¾€é™·å…¥\u0026quot;ç…§ç€æ–‡æ¡£æ•²å‘½ä»¤\u0026quot;çš„æœºæ¢°é‡å¤ã€‚æœ¬æ–‡ä¸æ˜¯åˆä¸€ç¯‡å®‰è£…æ•™ç¨‹ï¼Œè€Œæ˜¯ä»ç³»ç»Ÿæ¶æ„çš„è§’åº¦ï¼Œå¸¦ä½ ç†è§£ Hugo + PaperMod è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡é€»è¾‘ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Hugo Extended ä¸ PaperMod çš„ä¾èµ–å…³ç³»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Git Submodule çš„ä¸»é¢˜ç®¡ç†æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è®¾è®¡åŸºäº GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹å·¥ç¨‹åŒ–æ€ç»´è€Œé\u0026quot;è·Ÿç€åš\u0026quot;çš„æ“ä½œæ€ç»´\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"01-åŸºç¡€è®¾æ–½ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯-hugo-extended\"\u003e01. åŸºç¡€è®¾æ–½ï¼šä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ Hugo Extendedï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eå¾ˆå¤šäººç¬¬ä¸€æ¬¡æ­å»º Hugo åšå®¢æ—¶ï¼Œä¼šé‡åˆ°ä¸€ä¸ªè¯¡å¼‚çš„æŠ¥é”™ï¼š\u003ccode\u003eTOCSS: failed to transform \u0026quot;css/main.css\u0026quot;\u003c/code\u003eã€‚æ˜æ˜æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è£…äº† Hugoï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºé”™ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eé—®é¢˜å‡ºåœ¨ç‰ˆæœ¬é€‰æ‹©ä¸Šã€‚Hugo åˆ†ä¸ºæ™®é€šç‰ˆå’Œ Extended ç‰ˆï¼Œåè€…å†…ç½®äº† LibSass ç¼–è¯‘å™¨ã€‚è€Œ PaperMod è¿™ç±»ç°ä»£ä¸»é¢˜å¤§é‡ä½¿ç”¨ SCSS/SASS æ¥å®ç°ä¸»é¢˜å˜é‡ã€æš—é»‘æ¨¡å¼åˆ‡æ¢ç­‰ç‰¹æ€§ã€‚å¦‚æœä½ ç”¨æ™®é€šç‰ˆ Hugoï¼Œç¼–è¯‘æµç¨‹ä¼šåœ¨ CSS è½¬æ¢ç¯èŠ‚ç›´æ¥å´©æºƒã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ Windows ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ç”¨ Winget æ¥å®‰è£…ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ä¸‹è½½ zip åŒ…ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-powershell\" data-lang=\"powershell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œç¡®ä¿ç‰ˆæœ¬å¯è¿½æº¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ewinget\u003c/span\u003e \u003cspan class=\"n\"\u003einstall\u003c/span\u003e \u003cspan class=\"n\"\u003eHugo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"py\"\u003eHugo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"py\"\u003eExtended\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# éªŒè¯å®‰è£…ï¼šå¿…é¡»çœ‹åˆ° +extended æ ‡è¯†\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ehugo\u003c/span\u003e \u003cspan class=\"n\"\u003eversion\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# é¢„æœŸè¾“å‡º: hugo v0.12x.x+extended windows/amd64\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¸ºä»€ä¹ˆåšæŒç”¨åŒ…ç®¡ç†å™¨ï¼Ÿå› ä¸ºè¿™æ˜¯\u0026quot;å¯å¤ç°ç¯å¢ƒ\u0026quot;çš„ç¬¬ä¸€æ­¥ã€‚å½“ä½ çš„åšå®¢éœ€è¦å›¢é˜Ÿåä½œï¼Œæˆ–è€…æ¢äº†å°ç”µè„‘é‡æ–°éƒ¨ç½²æ—¶ï¼Œä¸€æ¡å‘½ä»¤å°±èƒ½æ¢å¤å®Œå…¨ä¸€è‡´çš„ç¯å¢ƒï¼Œè€Œä¸æ˜¯åœ¨\u0026quot;æˆ‘ç”µè„‘ä¸Šèƒ½è·‘\u0026quot;çš„æ³¥æ½­é‡ŒæŒ£æ‰ã€‚\u003c/p\u003e","title":"ä»é›¶åˆ°ä¸€ï¼šæ„å»º Hugo + PaperMod è‡ªåŠ¨åŒ–åšå®¢ç³»ç»Ÿ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œå¾€å¾€éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯è¿™äº›æ“ä½œçš„ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªç»å…¸éš¾é¢˜ã€‚æœ¬æ–‡å°†ç³»ç»Ÿè®²è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒé—®é¢˜ æŒæ¡2PCã€3PCã€TCCã€Sagaç­‰æ–¹æ¡ˆ å­¦ä¼šä½¿ç”¨Seataæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ äº†è§£å„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ ä¸šåŠ¡åœºæ™¯ ç”µå•†ä¸‹å•åœºæ™¯ï¼Œæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼š\n1ç”¨æˆ·ä¸‹å• 2 â†“ 3è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å• 4 â†“ 5åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜ 6 â†“ 7è´¦æˆ·æœåŠ¡ï¼šæ‰£å‡ä½™é¢ 8 â†“ 9ç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ† é—®é¢˜ï¼šå¦‚æœæŸä¸ªæœåŠ¡å¤±è´¥ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\nCAPç†è®º åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸‰ä¸ªç‰¹æ€§ï¼š\nC (Consistency)ï¼šä¸€è‡´æ€§ A (Availability)ï¼šå¯ç”¨æ€§ P (Partition Tolerance)ï¼šåˆ†åŒºå®¹é”™æ€§ CAPå®šç†ï¼šä¸‰è€…æœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤ä¸ª\nå®é™…é€‰æ‹©ï¼š\nCPï¼šç‰ºç‰²å¯ç”¨æ€§ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ˆå¦‚ZooKeeperï¼‰ APï¼šç‰ºç‰²ä¸€è‡´æ€§ï¼Œä¿è¯å¯ç”¨æ€§ï¼ˆå¦‚Eurekaï¼‰ BASEç†è®º BA (Basically Available)ï¼šåŸºæœ¬å¯ç”¨ S (Soft State)ï¼šè½¯çŠ¶æ€ E (Eventually Consistent)ï¼šæœ€ç»ˆä¸€è‡´æ€§ æ¶æ„æ€è€ƒï¼š åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¼ºä¸€è‡´æ€§å¾€å¾€éš¾ä»¥å®ç°ä¸”ä»£ä»·é«˜æ˜‚ã€‚å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼Œè¿™ä¹Ÿæ˜¯ç°ä»£åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆçš„åŸºç¡€ã€‚\n2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ åŸç† ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰\nåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€Prepareè¯·æ±‚ å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤ å‚ä¸è€…è¿”å›Yesæˆ–No ç¬¬äºŒé˜¶æ®µï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰\nå¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›Yesï¼Œåè°ƒè€…å‘é€Commitè¯·æ±‚ å¦‚æœæœ‰å‚ä¸è€…è¿”å›Noï¼Œåè°ƒè€…å‘é€Rollbackè¯·æ±‚ æµç¨‹å›¾ 1åè°ƒè€… å‚ä¸è€…1 å‚ä¸è€…2 2 | | | 3 |---Prepare----------\u0026gt;| | 4 |---Prepare----------------------------\u0026gt;| 5 | | | 6 |\u0026lt;--Yes/No------------| | 7 |\u0026lt;--Yes/No-------------------------------| 8 | | | 9 |---Commit/Rollback--\u0026gt;| | 10 |---Commit/Rollback----------------------\u0026gt;| ä»£ç ç¤ºä¾‹ 1public class TwoPhaseCommitCoordinator { 2 3 private List\u0026lt;Participant\u0026gt; participants; 4 5 public boolean executeTransaction() { 6 // ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡ 7 boolean canCommit = prepare(); 8 9 // ç¬¬äºŒé˜¶æ®µï¼šæäº¤æˆ–å›æ»š 10 if (canCommit) { 11 commit(); 12 return true; 13 } else { 14 rollback(); 15 return false; 16 } 17 } 18 19 private boolean prepare() { 20 for (Participant participant : participants) { 21 if (!participant.prepare()) { 22 return false; 23 } 24 } 25 return true; 26 } 27 28 private void commit() { 29 for (Participant participant : participants) { 30 participant.commit(); 31 } 32 } 33 34 private void rollback() { 35 for (Participant participant : participants) { 36 participant.rollback(); 37 } 38 } 39} 40 41interface Participant { 42 boolean prepare(); 43 void commit(); 44 void rollback(); 45} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nå¼ºä¸€è‡´æ€§ å®ç°ç›¸å¯¹ç®€å• ç¼ºç‚¹ï¼š\nåŒæ­¥é˜»å¡ï¼šå‚ä¸è€…åœ¨ç­‰å¾…åè°ƒè€…æŒ‡ä»¤æ—¶ä¼šé˜»å¡ å•ç‚¹æ•…éšœï¼šåè°ƒè€…æ•…éšœä¼šå¯¼è‡´å‚ä¸è€…ä¸€ç›´é˜»å¡ æ•°æ®ä¸ä¸€è‡´ï¼šç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´éƒ¨åˆ†å‚ä¸è€…æäº¤ï¼Œéƒ¨åˆ†å›æ»š 3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰ åŸç† åœ¨2PCåŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶æœºåˆ¶å’ŒCanCommité˜¶æ®µï¼š\nç¬¬ä¸€é˜¶æ®µï¼šCanCommit\nåè°ƒè€…è¯¢é—®å‚ä¸è€…æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡ ç¬¬äºŒé˜¶æ®µï¼šPreCommit\nå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤ ç¬¬ä¸‰é˜¶æ®µï¼šDoCommit\nå‚ä¸è€…æäº¤æˆ–å›æ»šäº‹åŠ¡ æ”¹è¿› è¶…æ—¶æœºåˆ¶ï¼šå‚ä¸è€…ç­‰å¾…è¶…æ—¶åè‡ªåŠ¨æäº¤ å‡å°‘é˜»å¡ï¼šCanCommité˜¶æ®µä¸å ç”¨èµ„æº ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\né™ä½äº†é˜»å¡èŒƒå›´ å¢åŠ äº†è¶…æ—¶æœºåˆ¶ ç¼ºç‚¹ï¼š\nä»ç„¶å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„é£é™© å®ç°æ›´å¤æ‚ æ€§èƒ½å¼€é”€æ›´å¤§ TCCï¼ˆTry-Confirm-Cancelï¼‰ åŸç† å°†äº‹åŠ¡åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š\nTryé˜¶æ®µï¼š\nå°è¯•æ‰§è¡Œä¸šåŠ¡ å®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ é¢„ç•™å¿…é¡»çš„ä¸šåŠ¡èµ„æº Confirmé˜¶æ®µï¼š\nç¡®è®¤æ‰§è¡Œä¸šåŠ¡ ä¸åšä»»ä½•ä¸šåŠ¡æ£€æŸ¥ åªä½¿ç”¨Tryé˜¶æ®µé¢„ç•™çš„èµ„æº Cancelé˜¶æ®µï¼š\nå–æ¶ˆæ‰§è¡Œä¸šåŠ¡ é‡Šæ”¾Tryé˜¶æ®µé¢„ç•™çš„èµ„æº ä»£ç ç¤ºä¾‹ 1// è®¢å•æœåŠ¡ 2@Service 3public class OrderService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 /** 9 * Tryï¼šåˆ›å»ºè®¢å•ï¼ŒçŠ¶æ€ä¸ºINIT 10 */ 11 @Transactional 12 public Long tryCreateOrder(OrderDTO orderDTO) { 13 Order order = new Order(); 14 order.setUserId(orderDTO.getUserId()); 15 order.setAmount(orderDTO.getAmount()); 16 order.setStatus(OrderStatus.INIT); // åˆå§‹çŠ¶æ€ 17 orderMapper.insert(order); 18 return order.getId(); 19 } 20 21 /** 22 * Confirmï¼šç¡®è®¤è®¢å•ï¼ŒçŠ¶æ€æ”¹ä¸ºSUCCESS 23 */ 24 @Transactional 25 public void confirmOrder(Long orderId) { 26 Order order = orderMapper.selectById(orderId); 27 order.setStatus(OrderStatus.SUCCESS); 28 orderMapper.updateById(order); 29 } 30 31 /** 32 * Cancelï¼šå–æ¶ˆè®¢å•ï¼ŒçŠ¶æ€æ”¹ä¸ºCANCEL 33 */ 34 @Transactional 35 public void cancelOrder(Long orderId) { 36 Order order = orderMapper.selectById(orderId); 37 order.setStatus(OrderStatus.CANCEL); 38 orderMapper.updateById(order); 39 } 40} 41 42// åº“å­˜æœåŠ¡ 43@Service 44public class InventoryService { 45 46 @Autowired 47 private InventoryMapper inventoryMapper; 48 49 /** 50 * Tryï¼šå†»ç»“åº“å­˜ 51 */ 52 @Transactional 53 public void tryDeductInventory(Long productId, Integer quantity) { 54 Inventory inventory = inventoryMapper.selectByProductId(productId); 55 56 // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³ 57 if (inventory.getAvailable() \u0026lt; quantity) { 58 throw new BusinessException(\u0026#34;åº“å­˜ä¸è¶³\u0026#34;); 59 } 60 61 // å†»ç»“åº“å­˜ 62 inventory.setAvailable(inventory.getAvailable() - quantity); 63 inventory.setFrozen(inventory.getFrozen() + quantity); 64 inventoryMapper.updateById(inventory); 65 } 66 67 /** 68 * Confirmï¼šæ‰£å‡å†»ç»“åº“å­˜ 69 */ 70 @Transactional 71 public void confirmDeductInventory(Long productId, Integer quantity) { 72 Inventory inventory = inventoryMapper.selectByProductId(productId); 73 inventory.setFrozen(inventory.getFrozen() - quantity); 74 inventoryMapper.updateById(inventory); 75 } 76 77 /** 78 * Cancelï¼šé‡Šæ”¾å†»ç»“åº“å­˜ 79 */ 80 @Transactional 81 public void cancelDeductInventory(Long productId, Integer quantity) { 82 Inventory inventory = inventoryMapper.selectByProductId(productId); 83 inventory.setAvailable(inventory.getAvailable() + quantity); 84 inventory.setFrozen(inventory.getFrozen() - quantity); 85 inventoryMapper.updateById(inventory); 86 } 87} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nä¸ä¾èµ–èµ„æºç®¡ç†å™¨çš„äº‹åŠ¡æ”¯æŒ æ€§èƒ½è¾ƒå¥½ï¼Œä¸ä¼šé•¿æ—¶é—´é”å®šèµ„æº å¯ä»¥è·¨æ•°æ®åº“ã€è·¨åº”ç”¨ ç¼ºç‚¹ï¼š\nä¸šåŠ¡ä¾µå…¥æ€§å¼ºï¼Œéœ€è¦å®ç°Tryã€Confirmã€Cancelä¸‰ä¸ªæ–¹æ³• å®ç°å¤æ‚ï¼Œéœ€è¦è€ƒè™‘å¹‚ç­‰æ€§ã€ç©ºå›æ»šã€æ‚¬æŒ‚ç­‰é—®é¢˜ Sagaæ¨¡å¼ åŸç† å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°çŸ­äº‹åŠ¡ï¼Œæ¯ä¸ªçŸ­äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿äº‹åŠ¡ã€‚\næ­£å‘æµç¨‹ï¼šT1 â†’ T2 â†’ T3 â†’ \u0026hellip; â†’ Tn\nè¡¥å¿æµç¨‹ï¼šC1 â† C2 â† C3 â† \u0026hellip; â† Cn\nå®ç°æ–¹å¼ 1. äº‹ä»¶é©±åŠ¨ï¼ˆChoreographyï¼‰ï¼š\næ¯ä¸ªæœåŠ¡å®Œæˆåå‘å¸ƒäº‹ä»¶ ä¸‹ä¸€ä¸ªæœåŠ¡ç›‘å¬äº‹ä»¶å¹¶æ‰§è¡Œ 2. å‘½ä»¤åè°ƒï¼ˆOrchestrationï¼‰ï¼š\nä¸­å¤®åè°ƒå™¨æ§åˆ¶æ•´ä¸ªæµç¨‹ åè°ƒå™¨è°ƒç”¨å„ä¸ªæœåŠ¡ ä»£ç ç¤ºä¾‹ 1// Sagaåè°ƒå™¨ 2@Service 3public class OrderSagaOrchestrator { 4 5 @Autowired 6 private OrderService orderService; 7 8 @Autowired 9 private InventoryService inventoryService; 10 11 @Autowired 12 private AccountService accountService; 13 14 public void createOrder(OrderDTO orderDTO) { 15 Long orderId = null; 16 try { 17 // 1. åˆ›å»ºè®¢å• 18 orderId = orderService.createOrder(orderDTO); 19 20 // 2. æ‰£å‡åº“å­˜ 21 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 22 23 // 3. æ‰£å‡ä½™é¢ 24 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 25 26 // 4. å®Œæˆè®¢å• 27 orderService.completeOrder(orderId); 28 29 } catch (Exception e) { 30 // è¡¥å¿æµç¨‹ 31 if (orderId != null) { 32 accountService.refundBalance(orderDTO.getUserId(), orderDTO.getAmount()); 33 inventoryService.restoreInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 34 orderService.cancelOrder(orderId); 35 } 36 throw e; 37 } 38 } 39} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nä¸€é˜¶æ®µæäº¤ï¼Œæ€§èƒ½å¥½ å‚ä¸è€…å¯ä»¥å¼‚æ­¥æ‰§è¡Œ è¡¥å¿æœºåˆ¶çµæ´» ç¼ºç‚¹ï¼š\nä¸ä¿è¯éš”ç¦»æ€§ éœ€è¦è®¾è®¡è¡¥å¿é€»è¾‘ å®ç°å¤æ‚åº¦é«˜ Seataæ¡†æ¶ æ¶æ„ 1åº”ç”¨å±‚ 2 â†“ 3Seata Client (RM + TM) 4 â†“ 5Seata Server (TC) 6 â†“ 7æ•°æ®åº“ ä¸‰ä¸ªè§’è‰²ï¼š\nTC (Transaction Coordinator)ï¼šäº‹åŠ¡åè°ƒå™¨ï¼Œç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ TM (Transaction Manager)ï¼šäº‹åŠ¡ç®¡ç†å™¨ï¼Œå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ RM (Resource Manager)ï¼šèµ„æºç®¡ç†å™¨ï¼Œç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æº ATæ¨¡å¼ Seataçš„é»˜è®¤æ¨¡å¼ï¼ŒåŸºäºæ”¯æŒæœ¬åœ°ACIDäº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“ã€‚\nåŸç†ï¼š\nä¸€é˜¶æ®µï¼šä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—è®°å½•åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æäº¤ äºŒé˜¶æ®µï¼š æäº¤ï¼šå¼‚æ­¥åŒ–ï¼Œå¿«é€Ÿå®Œæˆ å›æ»šï¼šé€šè¿‡å›æ»šæ—¥å¿—è¿›è¡Œåå‘è¡¥å¿ å¿«é€Ÿå¼€å§‹ 1. æ·»åŠ ä¾èµ–ï¼š\n1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;io.seata\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;seata-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;1.7.1\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; 2. é…ç½®Seataï¼š\n1seata: 2 enabled: true 3 application-id: order-service 4 tx-service-group: my_test_tx_group 5 service: 6 vgroup-mapping: 7 my_test_tx_group: default 8 grouplist: 9 default: 127.0.0.1:8091 10 registry: 11 type: nacos 12 nacos: 13 server-addr: 127.0.0.1:8848 14 namespace: public 15 group: SEATA_GROUP 3. åˆ›å»ºundo_logè¡¨ï¼š\n1CREATE TABLE `undo_log` ( 2 `id` bigint(20) NOT NULL AUTO_INCREMENT, 3 `branch_id` bigint(20) NOT NULL, 4 `xid` varchar(100) NOT NULL, 5 `context` varchar(128) NOT NULL, 6 `rollback_info` longblob NOT NULL, 7 `log_status` int(11) NOT NULL, 8 `log_created` datetime NOT NULL, 9 `log_modified` datetime NOT NULL, 10 PRIMARY KEY (`id`), 11 UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`) 12) ENGINE=InnoDB DEFAULT CHARSET=utf8; 4. ä½¿ç”¨@GlobalTransactionalï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 @Autowired 8 private InventoryServiceClient inventoryService; 9 10 @Autowired 11 private AccountServiceClient accountService; 12 13 @GlobalTransactional(name = \u0026#34;create-order\u0026#34;, rollbackFor = Exception.class) 14 public void createOrder(OrderDTO orderDTO) { 15 // 1. åˆ›å»ºè®¢å• 16 Order order = new Order(); 17 order.setUserId(orderDTO.getUserId()); 18 order.setAmount(orderDTO.getAmount()); 19 orderMapper.insert(order); 20 21 // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰ 22 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 23 24 // 3. æ‰£å‡ä½™é¢ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰ 25 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 26 } 27} TCCæ¨¡å¼ Seataä¹Ÿæ”¯æŒTCCæ¨¡å¼ï¼Œéœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š\n1@LocalTCC 2public interface InventoryTccAction { 3 4 @TwoPhaseBusinessAction(name = \u0026#34;deductInventory\u0026#34;, commitMethod = \u0026#34;commit\u0026#34;, rollbackMethod = \u0026#34;rollback\u0026#34;) 5 boolean prepare(BusinessActionContext context, 6 @BusinessActionContextParameter(paramName = \u0026#34;productId\u0026#34;) Long productId, 7 @BusinessActionContextParameter(paramName = \u0026#34;quantity\u0026#34;) Integer quantity); 8 9 boolean commit(BusinessActionContext context); 10 11 boolean rollback(BusinessActionContext context); 12} 13 14@Service 15public class InventoryTccActionImpl implements InventoryTccAction { 16 17 @Override 18 @Transactional 19 public boolean prepare(BusinessActionContext context, Long productId, Integer quantity) { 20 // Tryï¼šå†»ç»“åº“å­˜ 21 inventoryMapper.freezeInventory(productId, quantity); 22 return true; 23 } 24 25 @Override 26 @Transactional 27 public boolean commit(BusinessActionContext context) { 28 // Confirmï¼šæ‰£å‡å†»ç»“åº“å­˜ 29 Long productId = (Long) context.getActionContext(\u0026#34;productId\u0026#34;); 30 Integer quantity = (Integer) context.getActionContext(\u0026#34;quantity\u0026#34;); 31 inventoryMapper.deductFrozenInventory(productId, quantity); 32 return true; 33 } 34 35 @Override 36 @Transactional 37 public boolean rollback(BusinessActionContext context) { 38 // Cancelï¼šé‡Šæ”¾å†»ç»“åº“å­˜ 39 Long productId = (Long) context.getActionContext(\u0026#34;productId\u0026#34;); 40 Integer quantity = (Integer) context.getActionContext(\u0026#34;quantity\u0026#34;); 41 inventoryMapper.releaseFrozenInventory(productId, quantity); 42 return true; 43 } 44} Sagaæ¨¡å¼ Seataçš„Sagaæ¨¡å¼åŸºäºçŠ¶æ€æœºå¼•æ“ï¼š\n1{ 2 \u0026#34;Name\u0026#34;: \u0026#34;CreateOrderSaga\u0026#34;, 3 \u0026#34;Comment\u0026#34;: \u0026#34;åˆ›å»ºè®¢å•Saga\u0026#34;, 4 \u0026#34;StartState\u0026#34;: \u0026#34;CreateOrder\u0026#34;, 5 \u0026#34;States\u0026#34;: { 6 \u0026#34;CreateOrder\u0026#34;: { 7 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 8 \u0026#34;ServiceName\u0026#34;: \u0026#34;orderService\u0026#34;, 9 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;createOrder\u0026#34;, 10 \u0026#34;CompensateState\u0026#34;: \u0026#34;CancelOrder\u0026#34;, 11 \u0026#34;Next\u0026#34;: \u0026#34;DeductInventory\u0026#34; 12 }, 13 \u0026#34;DeductInventory\u0026#34;: { 14 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 15 \u0026#34;ServiceName\u0026#34;: \u0026#34;inventoryService\u0026#34;, 16 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;deductInventory\u0026#34;, 17 \u0026#34;CompensateState\u0026#34;: \u0026#34;RestoreInventory\u0026#34;, 18 \u0026#34;Next\u0026#34;: \u0026#34;DeductBalance\u0026#34; 19 }, 20 \u0026#34;DeductBalance\u0026#34;: { 21 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 22 \u0026#34;ServiceName\u0026#34;: \u0026#34;accountService\u0026#34;, 23 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;deductBalance\u0026#34;, 24 \u0026#34;CompensateState\u0026#34;: \u0026#34;RefundBalance\u0026#34;, 25 \u0026#34;IsEnd\u0026#34;: true 26 }, 27 \u0026#34;CancelOrder\u0026#34;: { 28 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 29 \u0026#34;ServiceName\u0026#34;: \u0026#34;orderService\u0026#34;, 30 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;cancelOrder\u0026#34;, 31 \u0026#34;IsEnd\u0026#34;: true 32 }, 33 \u0026#34;RestoreInventory\u0026#34;: { 34 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 35 \u0026#34;ServiceName\u0026#34;: \u0026#34;inventoryService\u0026#34;, 36 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;restoreInventory\u0026#34;, 37 \u0026#34;Next\u0026#34;: \u0026#34;CancelOrder\u0026#34; 38 }, 39 \u0026#34;RefundBalance\u0026#34;: { 40 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 41 \u0026#34;ServiceName\u0026#34;: \u0026#34;accountService\u0026#34;, 42 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;refundBalance\u0026#34;, 43 \u0026#34;Next\u0026#34;: \u0026#34;RestoreInventory\u0026#34; 44 } 45 } 46} XAæ¨¡å¼ Seataçš„XAæ¨¡å¼æ˜¯å¯¹ä¼ ç»ŸXAåè®®çš„å°è£…ï¼š\n1@GlobalTransactional 2public void createOrderXA(OrderDTO orderDTO) { 3 // XAæ¨¡å¼ä¸‹ï¼ŒSeataä¼šè‡ªåŠ¨ç®¡ç†XAäº‹åŠ¡ 4 // ä¸šåŠ¡ä»£ç ä¸ATæ¨¡å¼ç›¸åŒ 5 orderService.createOrder(orderDTO); 6 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 7 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 8} XA vs ATï¼š\nXAï¼šå¼ºä¸€è‡´æ€§ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œéœ€è¦æ•°æ®åº“æ”¯æŒXAåè®® ATï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½è¾ƒå¥½ï¼ŒåŸºäºæœ¬åœ°äº‹åŠ¡ æ–¹æ¡ˆå¯¹æ¯” æ–¹æ¡ˆ ä¸€è‡´æ€§ æ€§èƒ½ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ 2PC/3PC å¼ºä¸€è‡´ ä½ ä¸­ çŸ­äº‹åŠ¡ï¼Œå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜ TCC æœ€ç»ˆä¸€è‡´ é«˜ é«˜ å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œå¯æ¥å—æœ€ç»ˆä¸€è‡´ Saga æœ€ç»ˆä¸€è‡´ é«˜ ä¸­ é•¿äº‹åŠ¡ï¼Œä¸šåŠ¡æµç¨‹å¤æ‚ Seata AT æœ€ç»ˆä¸€è‡´ ä¸­ ä½ ä¸šåŠ¡ä¾µå…¥å°ï¼Œå¿«é€Ÿæ¥å…¥ Seata TCC æœ€ç»ˆä¸€è‡´ é«˜ é«˜ å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶ Seata XA å¼ºä¸€è‡´ ä½ ä½ éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œæ•°æ®åº“æ”¯æŒXA ç”Ÿäº§å®è·µ 1. å¹‚ç­‰æ€§è®¾è®¡ 1@Service 2public class OrderService { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 6 7 @GlobalTransactional 8 public void createOrder(OrderDTO orderDTO) { 9 String idempotentKey = \u0026#34;order:create:\u0026#34; + orderDTO.getRequestId(); 10 11 // æ£€æŸ¥å¹‚ç­‰æ€§ 12 Boolean success = redisTemplate.opsForValue().setIfAbsent( 13 idempotentKey, \u0026#34;1\u0026#34;, 10, TimeUnit.MINUTES 14 ); 15 16 if (!success) { 17 throw new BusinessException(\u0026#34;é‡å¤è¯·æ±‚\u0026#34;); 18 } 19 20 try { 21 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 22 doCreateOrder(orderDTO); 23 } catch (Exception e) { 24 // åˆ é™¤å¹‚ç­‰é”®ï¼Œå…è®¸é‡è¯• 25 redisTemplate.delete(idempotentKey); 26 throw e; 27 } 28 } 29} 2. è¶…æ—¶æ§åˆ¶ 1@GlobalTransactional( 2 name = \u0026#34;create-order\u0026#34;, 3 timeoutMills = 30000, // 30ç§’è¶…æ—¶ 4 rollbackFor = Exception.class 5) 6public void createOrder(OrderDTO orderDTO) { 7 // ä¸šåŠ¡é€»è¾‘ 8} 3. å¼‚å¸¸å¤„ç† 1@Service 2public class OrderService { 3 4 @GlobalTransactional(rollbackFor = Exception.class) 5 public void createOrder(OrderDTO orderDTO) { 6 try { 7 // ä¸šåŠ¡é€»è¾‘ 8 doCreateOrder(orderDTO); 9 } catch (BusinessException e) { 10 // ä¸šåŠ¡å¼‚å¸¸ï¼Œå›æ»š 11 log.error(\u0026#34;åˆ›å»ºè®¢å•å¤±è´¥ï¼š{}\u0026#34;, e.getMessage()); 12 throw e; 13 } catch (Exception e) { 14 // ç³»ç»Ÿå¼‚å¸¸ï¼Œå›æ»š 15 log.error(\u0026#34;ç³»ç»Ÿå¼‚å¸¸\u0026#34;, e); 16 throw new SystemException(\u0026#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); 17 } 18 } 19} 4. ç›‘æ§å‘Šè­¦ 1@Aspect 2@Component 3public class SeataMonitorAspect { 4 5 @Around(\u0026#34;@annotation(globalTransactional)\u0026#34;) 6 public Object monitor(ProceedingJoinPoint pjp, GlobalTransactional globalTransactional) throws Throwable { 7 String txName = globalTransactional.name(); 8 long startTime = System.currentTimeMillis(); 9 10 try { 11 Object result = pjp.proceed(); 12 long duration = System.currentTimeMillis() - startTime; 13 14 // è®°å½•æˆåŠŸæŒ‡æ ‡ 15 Metrics.counter(\u0026#34;seata.transaction.success\u0026#34;, \u0026#34;name\u0026#34;, txName).increment(); 16 Metrics.timer(\u0026#34;seata.transaction.duration\u0026#34;, \u0026#34;name\u0026#34;, txName).record(duration, TimeUnit.MILLISECONDS); 17 18 return result; 19 } catch (Exception e) { 20 // è®°å½•å¤±è´¥æŒ‡æ ‡ 21 Metrics.counter(\u0026#34;seata.transaction.failure\u0026#34;, \u0026#34;name\u0026#34;, txName).increment(); 22 throw e; 23 } 24 } 25} é¿å‘æç¤ºï¼š åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼ŒåŠ¡å¿…æ³¨æ„ï¼š1) è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼›2) å®ç°å¹‚ç­‰æ€§ï¼›3) åšå¥½ç›‘æ§å‘Šè­¦ï¼›4) å‡†å¤‡é™çº§æ–¹æ¡ˆï¼›5) å®šæœŸæ¸…ç†undo_logè¡¨ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼š\n2PC/3PCï¼šå¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½å·®ï¼Œé€‚åˆçŸ­äº‹åŠ¡ TCCï¼šæ€§èƒ½å¥½ï¼Œä½†å®ç°å¤æ‚ï¼Œé€‚åˆå¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ Sagaï¼šé€‚åˆé•¿äº‹åŠ¡ï¼Œè¡¥å¿æœºåˆ¶çµæ´» Seata ATï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸šåŠ¡ä¾µå…¥å°ï¼Œé€‚åˆå¿«é€Ÿæ¥å…¥ Seata TCCï¼šæ€§èƒ½å¥½ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶ Seata XAï¼šå¼ºä¸€è‡´æ€§ï¼Œå®ç°ç®€å•ï¼Œä½†æ€§èƒ½è¾ƒå·® é€‰æ‹©åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆæ—¶ï¼Œéœ€è¦è€ƒè™‘ï¼š\nä¸€è‡´æ€§è¦æ±‚ï¼šå¼ºä¸€è‡´è¿˜æ˜¯æœ€ç»ˆä¸€è‡´ æ€§èƒ½è¦æ±‚ï¼šèƒ½å¦æ¥å—é˜»å¡å’Œé”å®š ä¸šåŠ¡å¤æ‚åº¦ï¼šäº‹åŠ¡é“¾è·¯é•¿åº¦å’Œå¤æ‚åº¦ å¼€å‘æˆæœ¬ï¼šå®ç°å’Œç»´æŠ¤çš„å¤æ‚åº¦ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå»ºè®®ï¼š\nä¼˜å…ˆè€ƒè™‘ä¸šåŠ¡è®¾è®¡ï¼Œé¿å…åˆ†å¸ƒå¼äº‹åŠ¡ èƒ½ç”¨æœ€ç»ˆä¸€è‡´æ€§å°±ä¸ç”¨å¼ºä¸€è‡´æ€§ Seata ATæ¨¡å¼é€‚åˆå¿«é€Ÿæ¥å…¥ å¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ä½¿ç”¨TCCæˆ–Saga éœ€è¦å¼ºä¸€è‡´æ€§ä¸”æ•°æ®åº“æ”¯æŒXAæ—¶ä½¿ç”¨XAæ¨¡å¼ ä¸‹æ¬¡å½“ä½ éœ€è¦å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œä¸å¦¨æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\n","permalink":"http://localhost:1313/posts/2025/12/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%BB%8E-2pc-%E5%88%B0-seata-%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B8%8E%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œå¾€å¾€éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯è¿™äº›æ“ä½œçš„ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªç»å…¸éš¾é¢˜ã€‚æœ¬æ–‡å°†ç³»ç»Ÿè®²è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒé—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡2PCã€3PCã€TCCã€Sagaç­‰æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨Seataæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜\"\u003eåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"ä¸šåŠ¡åœºæ™¯\"\u003eä¸šåŠ¡åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eç”µå•†ä¸‹å•åœºæ™¯ï¼Œæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eç”¨æˆ·ä¸‹å•\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003eè®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003eåº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003eè´¦æˆ·æœåŠ¡ï¼šæ‰£å‡ä½™é¢\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003eç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ†\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eé—®é¢˜\u003c/strong\u003eï¼šå¦‚æœæŸä¸ªæœåŠ¡å¤±è´¥ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\u003c/p\u003e\n\u003ch3 id=\"capç†è®º\"\u003eCAPç†è®º\u003c/h3\u003e\n\u003cp\u003eåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸‰ä¸ªç‰¹æ€§ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eC (Consistency)\u003c/strong\u003eï¼šä¸€è‡´æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eA (Availability)\u003c/strong\u003eï¼šå¯ç”¨æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eP (Partition Tolerance)\u003c/strong\u003eï¼šåˆ†åŒºå®¹é”™æ€§\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eCAPå®šç†\u003c/strong\u003eï¼šä¸‰è€…æœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤ä¸ª\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå®é™…é€‰æ‹©\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCPï¼šç‰ºç‰²å¯ç”¨æ€§ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ˆå¦‚ZooKeeperï¼‰\u003c/li\u003e\n\u003cli\u003eAPï¼šç‰ºç‰²ä¸€è‡´æ€§ï¼Œä¿è¯å¯ç”¨æ€§ï¼ˆå¦‚Eurekaï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"baseç†è®º\"\u003eBASEç†è®º\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eBA (Basically Available)\u003c/strong\u003eï¼šåŸºæœ¬å¯ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eS (Soft State)\u003c/strong\u003eï¼šè½¯çŠ¶æ€\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eE (Eventually Consistent)\u003c/strong\u003eï¼šæœ€ç»ˆä¸€è‡´æ€§\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¼ºä¸€è‡´æ€§å¾€å¾€éš¾ä»¥å®ç°ä¸”ä»£ä»·é«˜æ˜‚ã€‚å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼Œè¿™ä¹Ÿæ˜¯ç°ä»£åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆçš„åŸºç¡€ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"2pcä¸¤é˜¶æ®µæäº¤\"\u003e2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰\u003c/h2\u003e\n\u003ch3 id=\"åŸç†\"\u003eåŸç†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€Prepareè¯·æ±‚\u003c/li\u003e\n\u003cli\u003eå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤\u003c/li\u003e\n\u003cli\u003eå‚ä¸è€…è¿”å›Yesæˆ–No\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eç¬¬äºŒé˜¶æ®µï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›Yesï¼Œåè°ƒè€…å‘é€Commitè¯·æ±‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœæœ‰å‚ä¸è€…è¿”å›Noï¼Œåè°ƒè€…å‘é€Rollbackè¯·æ±‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"æµç¨‹å›¾\"\u003eæµç¨‹å›¾\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003eåè°ƒè€…                å‚ä¸è€…1              å‚ä¸è€…2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Prepare----------\u0026gt;|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Prepare----------------------------\u0026gt;|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |\u0026lt;--Yes/No------------|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |\u0026lt;--Yes/No-------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Commit/Rollback--\u0026gt;|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Commit/Rollback----------------------\u0026gt;|\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ä»£ç ç¤ºä¾‹\"\u003eä»£ç ç¤ºä¾‹\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eTwoPhaseCommitCoordinator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eexecuteTransaction\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecanCommit\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¬¬äºŒé˜¶æ®µï¼šæäº¤æˆ–å›æ»š\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecanCommit\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e                \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e35\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e36\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e37\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e38\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e39\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e40\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e41\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e42\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e43\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e44\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e45\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ä¼˜ç¼ºç‚¹\"\u003eä¼˜ç¼ºç‚¹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¼˜ç‚¹\u003c/strong\u003eï¼š\u003c/p\u003e","title":"åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼šä» 2PC åˆ° Seata çš„æ¼”è¿›ä¸å®æˆ˜"},{"content":"é˜…è¯»ä¼˜ç§€çš„å¼€æºé¡¹ç›®æºç æ˜¯æå‡æŠ€æœ¯èƒ½åŠ›çš„æœ€ä½³é€”å¾„ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œé¢å¯¹åŠ¨è¾„å‡ åä¸‡è¡Œçš„ä»£ç ï¼Œå¾ˆå¤šäººä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹ã€‚æœ¬æ–‡å°†ä»¥Spring Bootä¸ºä¾‹ï¼Œç³»ç»Ÿè®²è§£å¦‚ä½•é«˜æ•ˆåœ°é˜…è¯»å’Œå­¦ä¹ å¼€æºé¡¹ç›®æºç ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æºç é˜…è¯»çš„ç³»ç»Ÿæ–¹æ³•è®º å­¦ä¼šä½¿ç”¨å·¥å…·è¾…åŠ©æºç é˜…è¯» ç†è§£Spring Bootçš„æ ¸å¿ƒè®¾è®¡æ€æƒ³ æŒæ¡ä»å®è§‚åˆ°å¾®è§‚çš„é˜…è¯»ç­–ç•¥ å»ºç«‹æºç å­¦ä¹ çš„é•¿æ•ˆæœºåˆ¶ ä¸ºä»€ä¹ˆè¦è¯»æºç  æºç é˜…è¯»çš„ä»·å€¼ æ·±å…¥ç†è§£åŸç†ï¼šçŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶ å­¦ä¹ è®¾è®¡æ¨¡å¼ï¼šçœ‹å¤§å¸ˆå¦‚ä½•è®¾è®¡æ¶æ„ æå‡ç¼–ç èƒ½åŠ›ï¼šå­¦ä¹ ä¼˜ç§€çš„ä»£ç é£æ ¼ è§£å†³ç–‘éš¾é—®é¢˜ï¼šé‡åˆ°é—®é¢˜èƒ½å¿«é€Ÿå®šä½ å‚ä¸å¼€æºè´¡çŒ®ï¼šä¸ºå¼€æºç¤¾åŒºåšè´¡çŒ® å¸¸è§è¯¯åŒº âŒ ä»ç¬¬ä¸€è¡Œå¼€å§‹è¯»ï¼šå®¹æ˜“è¿·å¤±åœ¨ç»†èŠ‚ä¸­ âŒ è¿½æ±‚å®Œå…¨ç†è§£ï¼šè¯•å›¾ç†è§£æ¯ä¸€è¡Œä»£ç  âŒ æ²¡æœ‰ç›®æ ‡ï¼šæ¼«æ— ç›®çš„åœ°æµè§ˆä»£ç  âŒ åªçœ‹ä¸ç»ƒï¼šåªçœ‹ä¸å†™ï¼Œæ— æ³•çœŸæ­£æŒæ¡\nâœ… å¸¦ç€é—®é¢˜è¯»ï¼šå›´ç»•å…·ä½“é—®é¢˜å±•å¼€ âœ… æŠ“ä½ä¸»çº¿ï¼šç†è§£æ ¸å¿ƒæµç¨‹å’Œè®¾è®¡æ€æƒ³ âœ… å¾ªåºæ¸è¿›ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥ âœ… è¾¹è¯»è¾¹å†™ï¼šé€šè¿‡å®è·µåŠ æ·±ç†è§£\næ¶æ„æ€è€ƒï¼š é˜…è¯»æºç ä¸æ˜¯ä¸ºäº†è®°ä½æ¯ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯ç†è§£è®¾è®¡æ€æƒ³å’Œæ¶æ„æ¨¡å¼ã€‚è¦å­¦ä¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œä»æ•´ä½“åˆ°ç»†èŠ‚çš„é˜…è¯»æ–¹æ³•ã€‚\næºç é˜…è¯»æ–¹æ³•è®º 1. å‡†å¤‡é˜¶æ®µ é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼š\né€‰æ‹©ç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚Spring Boot 2.7.xï¼‰ é¿å…é€‰æ‹©æœ€æ–°çš„å¼€å‘ç‰ˆæœ¬ æŸ¥çœ‹ç‰ˆæœ¬çš„Release Notes æ­å»ºè°ƒè¯•ç¯å¢ƒï¼š\n1# 1. å…‹éš†æºç  2git clone https://github.com/spring-projects/spring-boot.git 3cd spring-boot 4 5# 2. åˆ‡æ¢åˆ°ç¨³å®šç‰ˆæœ¬ 6git checkout v2.7.18 7 8# 3. å¯¼å…¥IDEï¼ˆIDEAï¼‰ 9# File -\u0026gt; Open -\u0026gt; é€‰æ‹©spring-bootç›®å½• å‡†å¤‡ç¤ºä¾‹é¡¹ç›®ï¼š\n1\u0026lt;!-- pom.xml --\u0026gt; 2\u0026lt;parent\u0026gt; 3 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 4 \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; 5 \u0026lt;version\u0026gt;2.7.18\u0026lt;/version\u0026gt; 6\u0026lt;/parent\u0026gt; 7 8\u0026lt;dependencies\u0026gt; 9 \u0026lt;dependency\u0026gt; 10 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 11 \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; 12 \u0026lt;/dependency\u0026gt; 13\u0026lt;/dependencies\u0026gt; 2. å®è§‚é˜¶æ®µ äº†è§£é¡¹ç›®ç»“æ„ï¼š\n1spring-boot/ 2â”œâ”€â”€ spring-boot-project/ 3â”‚ â”œâ”€â”€ spring-boot/ # æ ¸å¿ƒæ¨¡å— 4â”‚ â”œâ”€â”€ spring-boot-autoconfigure/ # è‡ªåŠ¨é…ç½® 5â”‚ â”œâ”€â”€ spring-boot-starters/ # Starterä¾èµ– 6â”‚ â”œâ”€â”€ spring-boot-actuator/ # ç›‘æ§ç«¯ç‚¹ 7â”‚ â””â”€â”€ spring-boot-test/ # æµ‹è¯•æ”¯æŒ 8â”œâ”€â”€ spring-boot-samples/ # ç¤ºä¾‹é¡¹ç›® 9â””â”€â”€ spring-boot-tests/ # é›†æˆæµ‹è¯• é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼š\nSpring Boot Reference Documentation äº†è§£æ ¸å¿ƒç‰¹æ€§å’Œä½¿ç”¨æ–¹å¼ ç†è§£è®¾è®¡ç†å¿µå’Œæ¶æ„æ€æƒ³ ç»˜åˆ¶æ¶æ„å›¾ï¼š\n1åº”ç”¨å¯åŠ¨ 2 â†“ 3@SpringBootApplication 4 â†“ 5SpringApplication.run() 6 â†“ 7åˆ›å»ºApplicationContext 8 â†“ 9è‡ªåŠ¨é…ç½®ï¼ˆAutoConfigurationï¼‰ 10 â†“ 11å¯åŠ¨å†…åµŒWebæœåŠ¡å™¨ 12 â†“ 13åº”ç”¨å°±ç»ª 3. å¾®è§‚é˜¶æ®µ é€‰æ‹©åˆ‡å…¥ç‚¹ï¼š\nä»æœ€å¸¸ç”¨çš„åŠŸèƒ½å¼€å§‹ï¼ˆå¦‚å¯åŠ¨æµç¨‹ï¼‰ ä»é‡åˆ°çš„é—®é¢˜å¼€å§‹ï¼ˆå¦‚è‡ªåŠ¨é…ç½®åŸç†ï¼‰ ä»æ„Ÿå…´è¶£çš„ç‰¹æ€§å¼€å§‹ï¼ˆå¦‚æ¡ä»¶æ³¨è§£ï¼‰ ä½¿ç”¨è°ƒè¯•å·¥å…·ï¼š\næ–­ç‚¹è°ƒè¯•ï¼šè§‚å¯Ÿæ‰§è¡Œæµç¨‹ è°ƒç”¨æ ˆï¼šç†è§£æ–¹æ³•è°ƒç”¨å…³ç³» å˜é‡ç›‘è§†ï¼šæŸ¥çœ‹å¯¹è±¡çŠ¶æ€ Spring Boot å¯åŠ¨æµç¨‹åˆ†æ å…¥å£ï¼š@SpringBootApplication 1@SpringBootApplication 2public class DemoApplication { 3 public static void main(String[] args) { 4 SpringApplication.run(DemoApplication.class, args); 5 } 6} @SpringBootApplication æ³¨è§£ï¼š\n1@Target(ElementType.TYPE) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4@Inherited 5@SpringBootConfiguration // 1. é…ç½®ç±» 6@EnableAutoConfiguration // 2. è‡ªåŠ¨é…ç½® 7@ComponentScan // 3. ç»„ä»¶æ‰«æ 8public @interface SpringBootApplication { 9 // ... 10} ä¸‰ä¸ªæ ¸å¿ƒæ³¨è§£ï¼š\n@SpringBootConfigurationï¼šæ ‡è®°ä¸ºé…ç½®ç±» @EnableAutoConfigurationï¼šå¯ç”¨è‡ªåŠ¨é…ç½® @ComponentScanï¼šæ‰«æç»„ä»¶ SpringApplication.run() æµç¨‹ 1public class SpringApplication { 2 3 public static ConfigurableApplicationContext run(Class\u0026lt;?\u0026gt; primarySource, String... args) { 4 return run(new Class\u0026lt;?\u0026gt;[] { primarySource }, args); 5 } 6 7 public static ConfigurableApplicationContext run(Class\u0026lt;?\u0026gt;[] primarySources, String[] args) { 8 // åˆ›å»ºSpringApplicationå®ä¾‹å¹¶è¿è¡Œ 9 return new SpringApplication(primarySources).run(args); 10 } 11 12 public ConfigurableApplicationContext run(String... args) { 13 // 1. åˆ›å»ºStopWatchï¼Œè®°å½•å¯åŠ¨æ—¶é—´ 14 StopWatch stopWatch = new StopWatch(); 15 stopWatch.start(); 16 17 // 2. åˆ›å»ºBootstrapä¸Šä¸‹æ–‡ 18 DefaultBootstrapContext bootstrapContext = createBootstrapContext(); 19 ConfigurableApplicationContext context = null; 20 21 // 3. é…ç½®Headlesså±æ€§ 22 configureHeadlessProperty(); 23 24 // 4. è·å–SpringApplicationRunListeners 25 SpringApplicationRunListeners listeners = getRunListeners(args); 26 listeners.starting(bootstrapContext, this.mainApplicationClass); 27 28 try { 29 // 5. å‡†å¤‡ç¯å¢ƒ 30 ApplicationArguments applicationArguments = new DefaultApplicationArguments(args); 31 ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments); 32 33 // 6. æ‰“å°Banner 34 Banner printedBanner = printBanner(environment); 35 36 // 7. åˆ›å»ºApplicationContext 37 context = createApplicationContext(); 38 context.setApplicationStartup(this.applicationStartup); 39 40 // 8. å‡†å¤‡Context 41 prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner); 42 43 // 9. åˆ·æ–°Contextï¼ˆæ ¸å¿ƒï¼‰ 44 refreshContext(context); 45 46 // 10. åˆ·æ–°åå¤„ç† 47 afterRefresh(context, applicationArguments); 48 49 stopWatch.stop(); 50 51 // 11. å‘å¸ƒå¯åŠ¨å®Œæˆäº‹ä»¶ 52 listeners.started(context); 53 54 // 12. è°ƒç”¨Runners 55 callRunners(context, applicationArguments); 56 } 57 catch (Throwable ex) { 58 handleRunFailure(context, ex, listeners); 59 throw new IllegalStateException(ex); 60 } 61 62 try { 63 listeners.running(context); 64 } 65 catch (Throwable ex) { 66 handleRunFailure(context, ex, null); 67 throw new IllegalStateException(ex); 68 } 69 70 return context; 71 } 72} å¯åŠ¨æµç¨‹å›¾ï¼š\n11. åˆ›å»ºStopWatch 2 â†“ 32. åˆ›å»ºBootstrapä¸Šä¸‹æ–‡ 4 â†“ 53. è·å–RunListeners 6 â†“ 74. å‡†å¤‡Environment 8 â†“ 95. æ‰“å°Banner 10 â†“ 116. åˆ›å»ºApplicationContext 12 â†“ 137. å‡†å¤‡Context 14 â†“ 158. åˆ·æ–°Contextï¼ˆåŠ è½½Beanï¼‰ 16 â†“ 179. è°ƒç”¨Runners 18 â†“ 1910. å‘å¸ƒå¯åŠ¨å®Œæˆäº‹ä»¶ è‡ªåŠ¨é…ç½®åŸç† @EnableAutoConfiguration 1@Target(ElementType.TYPE) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4@Inherited 5@AutoConfigurationPackage 6@Import(AutoConfigurationImportSelector.class) // æ ¸å¿ƒ 7public @interface EnableAutoConfiguration { 8 // ... 9} AutoConfigurationImportSelector 1public class AutoConfigurationImportSelector implements DeferredImportSelector { 2 3 @Override 4 public String[] selectImports(AnnotationMetadata annotationMetadata) { 5 if (!isEnabled(annotationMetadata)) { 6 return NO_IMPORTS; 7 } 8 9 // 1. è·å–è‡ªåŠ¨é…ç½®ç±» 10 AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(annotationMetadata); 11 return StringUtils.toStringArray(autoConfigurationEntry.getConfigurations()); 12 } 13 14 protected AutoConfigurationEntry getAutoConfigurationEntry(AnnotationMetadata annotationMetadata) { 15 if (!isEnabled(annotationMetadata)) { 16 return EMPTY_ENTRY; 17 } 18 19 AnnotationAttributes attributes = getAttributes(annotationMetadata); 20 21 // 2. åŠ è½½å€™é€‰é…ç½®ç±» 22 List\u0026lt;String\u0026gt; configurations = getCandidateConfigurations(annotationMetadata, attributes); 23 24 // 3. å»é‡ 25 configurations = removeDuplicates(configurations); 26 27 // 4. æ’é™¤æŒ‡å®šçš„é…ç½®ç±» 28 Set\u0026lt;String\u0026gt; exclusions = getExclusions(annotationMetadata, attributes); 29 checkExcludedClasses(configurations, exclusions); 30 configurations.removeAll(exclusions); 31 32 // 5. è¿‡æ»¤ï¼ˆæ ¹æ®æ¡ä»¶æ³¨è§£ï¼‰ 33 configurations = getConfigurationClassFilter().filter(configurations); 34 35 // 6. è§¦å‘è‡ªåŠ¨é…ç½®å¯¼å…¥äº‹ä»¶ 36 fireAutoConfigurationImportEvents(configurations, exclusions); 37 38 return new AutoConfigurationEntry(configurations, exclusions); 39 } 40 41 protected List\u0026lt;String\u0026gt; getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) { 42 // ä»META-INF/spring.factoriesåŠ è½½é…ç½®ç±» 43 List\u0026lt;String\u0026gt; configurations = SpringFactoriesLoader.loadFactoryNames( 44 getSpringFactoriesLoaderFactoryClass(), 45 getBeanClassLoader() 46 ); 47 return configurations; 48 } 49} spring.factories 1# spring-boot-autoconfigure/META-INF/spring.factories 2 3org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 4org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\\ 5org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\\ 6org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\\ 7org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\\ 8org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration,\\ 9... è‡ªåŠ¨é…ç½®ç¤ºä¾‹ 1@Configuration(proxyBeanMethods = false) 2@ConditionalOnClass({ DataSource.class, EmbeddedDatabaseType.class }) 3@ConditionalOnMissingBean(type = \u0026#34;io.r2dbc.spi.ConnectionFactory\u0026#34;) 4@EnableConfigurationProperties(DataSourceProperties.class) 5@Import({ DataSourcePoolMetadataProvidersConfiguration.class }) 6public class DataSourceAutoConfiguration { 7 8 @Configuration(proxyBeanMethods = false) 9 @Conditional(EmbeddedDatabaseCondition.class) 10 @ConditionalOnMissingBean({ DataSource.class, XADataSource.class }) 11 @Import(EmbeddedDataSourceConfiguration.class) 12 protected static class EmbeddedDatabaseConfiguration { 13 } 14 15 @Configuration(proxyBeanMethods = false) 16 @Conditional(PooledDataSourceCondition.class) 17 @ConditionalOnMissingBean({ DataSource.class, XADataSource.class }) 18 @Import({ DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class, 19 DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.OracleUcp.class, 20 DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class }) 21 protected static class PooledDataSourceConfiguration { 22 } 23} æ¡ä»¶æ³¨è§£ï¼š\n@ConditionalOnClassï¼šç±»è·¯å¾„å­˜åœ¨æŒ‡å®šç±» @ConditionalOnMissingBeanï¼šå®¹å™¨ä¸­ä¸å­˜åœ¨æŒ‡å®šBean @ConditionalOnPropertyï¼šé…ç½®æ–‡ä»¶å­˜åœ¨æŒ‡å®šå±æ€§ æ¡ä»¶æ³¨è§£åŸç† @Conditional 1@Target({ ElementType.TYPE, ElementType.METHOD }) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4public @interface Conditional { 5 Class\u0026lt;? extends Condition\u0026gt;[] value(); 6} Conditionæ¥å£ 1@FunctionalInterface 2public interface Condition { 3 boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata); 4} OnClassConditionå®ç° 1@Order(Ordered.HIGHEST_PRECEDENCE) 2class OnClassCondition extends FilteringSpringBootCondition { 3 4 @Override 5 public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) { 6 ClassLoader classLoader = context.getClassLoader(); 7 ConditionMessage matchMessage = ConditionMessage.empty(); 8 9 // è·å–@ConditionalOnClassæ³¨è§£çš„value 10 List\u0026lt;String\u0026gt; onClasses = getCandidates(metadata, ConditionalOnClass.class); 11 if (onClasses != null) { 12 // æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨ 13 List\u0026lt;String\u0026gt; missing = filter(onClasses, ClassNameFilter.MISSING, classLoader); 14 if (!missing.isEmpty()) { 15 return ConditionOutcome.noMatch( 16 ConditionMessage.forCondition(ConditionalOnClass.class) 17 .didNotFind(\u0026#34;required class\u0026#34;, \u0026#34;required classes\u0026#34;) 18 .items(Style.QUOTE, missing) 19 ); 20 } 21 matchMessage = matchMessage.andCondition(ConditionalOnClass.class) 22 .found(\u0026#34;required class\u0026#34;, \u0026#34;required classes\u0026#34;) 23 .items(Style.QUOTE, filter(onClasses, ClassNameFilter.PRESENT, classLoader)); 24 } 25 26 // è·å–@ConditionalOnMissingClassæ³¨è§£çš„value 27 List\u0026lt;String\u0026gt; onMissingClasses = getCandidates(metadata, ConditionalOnMissingClass.class); 28 if (onMissingClasses != null) { 29 // æ£€æŸ¥ç±»æ˜¯å¦ä¸å­˜åœ¨ 30 List\u0026lt;String\u0026gt; present = filter(onMissingClasses, ClassNameFilter.PRESENT, classLoader); 31 if (!present.isEmpty()) { 32 return ConditionOutcome.noMatch( 33 ConditionMessage.forCondition(ConditionalOnMissingClass.class) 34 .found(\u0026#34;unwanted class\u0026#34;, \u0026#34;unwanted classes\u0026#34;) 35 .items(Style.QUOTE, present) 36 ); 37 } 38 matchMessage = matchMessage.andCondition(ConditionalOnMissingClass.class) 39 .didNotFind(\u0026#34;unwanted class\u0026#34;, \u0026#34;unwanted classes\u0026#34;) 40 .items(Style.QUOTE, filter(onMissingClasses, ClassNameFilter.MISSING, classLoader)); 41 } 42 43 return ConditionOutcome.match(matchMessage); 44 } 45} æºç é˜…è¯»æŠ€å·§ 1. ä½¿ç”¨IDEAè°ƒè¯• è®¾ç½®æ–­ç‚¹ï¼š\n1// åœ¨å…³é”®æ–¹æ³•è®¾ç½®æ–­ç‚¹ 2public ConfigurableApplicationContext run(String... args) { 3 // æ–­ç‚¹1ï¼šå¯åŠ¨å…¥å£ 4 StopWatch stopWatch = new StopWatch(); 5 stopWatch.start(); 6 7 // æ–­ç‚¹2ï¼šåˆ›å»ºContext 8 context = createApplicationContext(); 9 10 // æ–­ç‚¹3ï¼šåˆ·æ–°Context 11 refreshContext(context); 12 13 return context; 14} æŸ¥çœ‹è°ƒç”¨æ ˆï¼š\nä½¿ç”¨Ctrl+Alt+HæŸ¥çœ‹æ–¹æ³•è°ƒç”¨å±‚æ¬¡ ä½¿ç”¨Alt+F7æŸ¥æ‰¾æ–¹æ³•ä½¿ç”¨ä½ç½® æ¡ä»¶æ–­ç‚¹ï¼š\n1// åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è§¦å‘æ–­ç‚¹ 2if (beanName.equals(\u0026#34;dataSource\u0026#34;)) { 3 // æ–­ç‚¹ï¼šåªåœ¨åˆ›å»ºdataSourceæ—¶è§¦å‘ 4} 2. ç»˜åˆ¶æµç¨‹å›¾ ä½¿ç”¨å·¥å…·ç»˜åˆ¶å…³é”®æµç¨‹ï¼š\nDraw.io PlantUML Mermaid 1sequenceDiagram 2 participant Main 3 participant SpringApplication 4 participant Context 5 participant AutoConfig 6 7 Main-\u0026gt;\u0026gt;SpringApplication: run() 8 SpringApplication-\u0026gt;\u0026gt;Context: createApplicationContext() 9 SpringApplication-\u0026gt;\u0026gt;AutoConfig: loadAutoConfiguration() 10 AutoConfig-\u0026gt;\u0026gt;Context: registerBeans() 11 SpringApplication-\u0026gt;\u0026gt;Context: refresh() 12 Context--\u0026gt;\u0026gt;Main: ApplicationContext 3. åšç¬”è®° è®°å½•å…³é”®ç‚¹ï¼š\næ ¸å¿ƒç±»å’Œæ¥å£ è®¾è®¡æ¨¡å¼çš„åº”ç”¨ å·§å¦™çš„å®ç°æŠ€å·§ ç–‘é—®å’Œå¾…ç ”ç©¶çš„é—®é¢˜ ç¤ºä¾‹ç¬”è®°ï¼š\n1## SpringApplicationå¯åŠ¨æµç¨‹ 2 3### æ ¸å¿ƒæ–¹æ³• 4- `run(String... args)`: å¯åŠ¨å…¥å£ 5- `prepareEnvironment()`: å‡†å¤‡ç¯å¢ƒ 6- `createApplicationContext()`: åˆ›å»ºä¸Šä¸‹æ–‡ 7- `refreshContext()`: åˆ·æ–°ä¸Šä¸‹æ–‡ 8 9### è®¾è®¡æ¨¡å¼ 10- æ¨¡æ¿æ–¹æ³•ï¼šrun()æ–¹æ³•å®šä¹‰æµç¨‹ï¼Œå­ç±»å¯æ‰©å±• 11- ç­–ç•¥æ¨¡å¼ï¼šApplicationContextFactoryåˆ›å»ºä¸åŒç±»å‹çš„Context 12- è§‚å¯Ÿè€…æ¨¡å¼ï¼šSpringApplicationRunListenersç›‘å¬å¯åŠ¨äº‹ä»¶ 13 14### ç–‘é—® 15- [ ] Environmentæ˜¯å¦‚ä½•åŠ è½½é…ç½®æ–‡ä»¶çš„ï¼Ÿ 16- [ ] Beançš„å¾ªç¯ä¾èµ–æ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ 4. å†™æµ‹è¯•ä»£ç  éªŒè¯ç†è§£ï¼š\n1@Test 2public void testAutoConfiguration() { 3 // 1. åˆ›å»ºAnnotationConfigApplicationContext 4 AnnotationConfigApplicationContext context = 5 new AnnotationConfigApplicationContext(); 6 7 // 2. æ³¨å†Œé…ç½®ç±» 8 context.register(DataSourceAutoConfiguration.class); 9 10 // 3. åˆ·æ–°å®¹å™¨ 11 context.refresh(); 12 13 // 4. éªŒè¯Beanæ˜¯å¦åˆ›å»º 14 DataSource dataSource = context.getBean(DataSource.class); 15 assertNotNull(dataSource); 16} æ¨¡ä»¿å®ç°ï¼š\n1// æ¨¡ä»¿Spring Bootçš„æ¡ä»¶æ³¨è§£ 2@Target({ ElementType.TYPE, ElementType.METHOD }) 3@Retention(RetentionPolicy.RUNTIME) 4@Conditional(OnMyClassCondition.class) 5public @interface ConditionalOnMyClass { 6 String value(); 7} 8 9public class OnMyClassCondition implements Condition { 10 @Override 11 public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) { 12 Map\u0026lt;String, Object\u0026gt; attributes = metadata.getAnnotationAttributes( 13 ConditionalOnMyClass.class.getName() 14 ); 15 String className = (String) attributes.get(\u0026#34;value\u0026#34;); 16 17 try { 18 Class.forName(className); 19 return true; 20 } catch (ClassNotFoundException e) { 21 return false; 22 } 23 } 24} å­¦ä¹ è·¯å¾„å»ºè®® åˆçº§é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰ ç›®æ ‡ï¼šç†è§£Spring Bootçš„åŸºæœ¬ä½¿ç”¨å’Œæ ¸å¿ƒæ¦‚å¿µ\né˜…è¯»å®˜æ–¹æ–‡æ¡£ è¿è¡Œç¤ºä¾‹é¡¹ç›® ç†è§£@SpringBootApplicationæ³¨è§£ äº†è§£è‡ªåŠ¨é…ç½®çš„åŸºæœ¬åŸç† æ¨èé˜…è¯»ï¼š\nSpringApplication.java @SpringBootApplicationç›¸å…³æ³¨è§£ ç®€å•çš„AutoConfigurationç±» ä¸­çº§é˜¶æ®µï¼ˆ2-4å‘¨ï¼‰ ç›®æ ‡ï¼šæ·±å…¥ç†è§£å¯åŠ¨æµç¨‹å’Œè‡ªåŠ¨é…ç½®æœºåˆ¶\nè°ƒè¯•å¯åŠ¨æµç¨‹ åˆ†æAutoConfigurationImportSelector ç ”ç©¶æ¡ä»¶æ³¨è§£çš„å®ç° å­¦ä¹ å¸¸ç”¨çš„AutoConfiguration æ¨èé˜…è¯»ï¼š\nSpringApplication.run()å®Œæ•´æµç¨‹ AutoConfigurationImportSelector.java OnClassCondition.java DataSourceAutoConfiguration.java WebMvcAutoConfiguration.java é«˜çº§é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ ç›®æ ‡ï¼šæŒæ¡Spring Bootçš„è®¾è®¡æ€æƒ³å’Œæ‰©å±•æœºåˆ¶\nç ”ç©¶SPIæœºåˆ¶ï¼ˆSpringFactoriesLoaderï¼‰ åˆ†æApplicationContextçš„åˆ›å»ºå’Œåˆ·æ–° å­¦ä¹ Actuatorçš„å®ç° ç ”ç©¶Spring Bootçš„æµ‹è¯•æ”¯æŒ æ¨èé˜…è¯»ï¼š\nSpringFactoriesLoader.java ConfigurableApplicationContextç›¸å…³ç±» spring-boot-actuatoræ¨¡å— spring-boot-testæ¨¡å— ä¸“å®¶é˜¶æ®µï¼ˆæŒç»­å­¦ä¹ ï¼‰ ç›®æ ‡ï¼šå‚ä¸å¼€æºè´¡çŒ®ï¼Œæ·±åº¦å®šåˆ¶Spring Boot\né˜…è¯»Issueå’ŒPR å‚ä¸ç¤¾åŒºè®¨è®º æäº¤Bugä¿®å¤æˆ–æ–°ç‰¹æ€§ å¼€å‘è‡ªå®šä¹‰Starter å®æˆ˜ï¼šå¼€å‘è‡ªå®šä¹‰Starter 1. åˆ›å»ºStarteré¡¹ç›® 1\u0026lt;!-- my-spring-boot-starter/pom.xml --\u0026gt; 2\u0026lt;dependencies\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;spring-boot-autoconfigure\u0026lt;/artifactId\u0026gt; 6 \u0026lt;/dependency\u0026gt; 7 \u0026lt;dependency\u0026gt; 8 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 9 \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; 10 \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; 11 \u0026lt;/dependency\u0026gt; 12\u0026lt;/dependencies\u0026gt; 2. å®šä¹‰é…ç½®å±æ€§ 1@ConfigurationProperties(prefix = \u0026#34;my.service\u0026#34;) 2public class MyServiceProperties { 3 4 private String name = \u0026#34;default\u0026#34;; 5 private int timeout = 3000; 6 7 // getters and setters 8} 3. åˆ›å»ºè‡ªåŠ¨é…ç½®ç±» 1@Configuration 2@ConditionalOnClass(MyService.class) 3@EnableConfigurationProperties(MyServiceProperties.class) 4public class MyServiceAutoConfiguration { 5 6 @Bean 7 @ConditionalOnMissingBean 8 public MyService myService(MyServiceProperties properties) { 9 return new MyService(properties.getName(), properties.getTimeout()); 10 } 11} 4. æ³¨å†Œè‡ªåŠ¨é…ç½® 1# META-INF/spring.factories 2org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 3com.example.MyServiceAutoConfiguration 5. ä½¿ç”¨Starter 1\u0026lt;!-- åº”ç”¨é¡¹ç›®çš„pom.xml --\u0026gt; 2\u0026lt;dependency\u0026gt; 3 \u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt; 4 \u0026lt;artifactId\u0026gt;my-spring-boot-starter\u0026lt;/artifactId\u0026gt; 5 \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; 6\u0026lt;/dependency\u0026gt; 1# application.yml 2my: 3 service: 4 name: my-service 5 timeout: 5000 1@SpringBootApplication 2public class Application { 3 4 @Autowired 5 private MyService myService; // è‡ªåŠ¨æ³¨å…¥ 6 7 public static void main(String[] args) { 8 SpringApplication.run(Application.class, args); 9 } 10} æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡ç³»ç»Ÿè®²è§£äº†å¦‚ä½•é˜…è¯»å¼€æºé¡¹ç›®æºç ï¼Œä»¥Spring Bootä¸ºä¾‹ï¼š\næ–¹æ³•è®ºï¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œå¸¦ç€é—®é¢˜è¯»æºç  å¯åŠ¨æµç¨‹ï¼šç†è§£SpringApplication.run()çš„å®Œæ•´æµç¨‹ è‡ªåŠ¨é…ç½®ï¼šæŒæ¡@EnableAutoConfigurationçš„å®ç°åŸç† æ¡ä»¶æ³¨è§£ï¼šå­¦ä¹ @Conditionalçš„è®¾è®¡å’Œå®ç° å­¦ä¹ è·¯å¾„ï¼šä»åˆçº§åˆ°ä¸“å®¶çš„è¿›é˜¶è·¯çº¿ å®æˆ˜ç»ƒä¹ ï¼šå¼€å‘è‡ªå®šä¹‰Starterå·©å›ºç†è§£ é˜…è¯»æºç çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nç›®æ ‡æ˜ç¡®ï¼šå¸¦ç€é—®é¢˜å’Œç›®æ ‡å»è¯» å¾ªåºæ¸è¿›ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥ åŠ¨æ‰‹å®è·µï¼šé€šè¿‡è°ƒè¯•å’Œç¼–ç åŠ æ·±ç†è§£ æŒç»­å­¦ä¹ ï¼šæºç é˜…è¯»æ˜¯ä¸€ä¸ªé•¿æœŸè¿‡ç¨‹ æ¨èçš„å­¦ä¹ èµ„æºï¼š\nSpring Bootå®˜æ–¹æ–‡æ¡£ Spring Bootæºç  Spring Frameworkæºç  ä¸‹æ¬¡å½“ä½ æƒ³æ·±å…¥å­¦ä¹ ä¸€ä¸ªå¼€æºé¡¹ç›®æ—¶ï¼Œä¸å¦¨æŒ‰ç…§æœ¬æ–‡çš„æ–¹æ³•ï¼Œç³»ç»Ÿæ€§åœ°é˜…è¯»å’Œå­¦ä¹ ã€‚è®°ä½ï¼Œæºç é˜…è¯»ä¸æ˜¯ç›®çš„ï¼Œç†è§£è®¾è®¡æ€æƒ³å’Œæå‡ç¼–ç èƒ½åŠ›æ‰æ˜¯æœ€ç»ˆç›®æ ‡ã€‚\n","permalink":"http://localhost:1313/posts/2025/11/%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E4%BB%A5-spring-boot-%E4%B8%BA%E4%BE%8B/","summary":"\u003cp\u003eé˜…è¯»ä¼˜ç§€çš„å¼€æºé¡¹ç›®æºç æ˜¯æå‡æŠ€æœ¯èƒ½åŠ›çš„æœ€ä½³é€”å¾„ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œé¢å¯¹åŠ¨è¾„å‡ åä¸‡è¡Œçš„ä»£ç ï¼Œå¾ˆå¤šäººä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹ã€‚æœ¬æ–‡å°†ä»¥Spring Bootä¸ºä¾‹ï¼Œç³»ç»Ÿè®²è§£å¦‚ä½•é«˜æ•ˆåœ°é˜…è¯»å’Œå­¦ä¹ å¼€æºé¡¹ç›®æºç ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æºç é˜…è¯»çš„ç³»ç»Ÿæ–¹æ³•è®º\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å·¥å…·è¾…åŠ©æºç é˜…è¯»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£Spring Bootçš„æ ¸å¿ƒè®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ä»å®è§‚åˆ°å¾®è§‚çš„é˜…è¯»ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹æºç å­¦ä¹ çš„é•¿æ•ˆæœºåˆ¶\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆè¦è¯»æºç \"\u003eä¸ºä»€ä¹ˆè¦è¯»æºç \u003c/h2\u003e\n\u003ch3 id=\"æºç é˜…è¯»çš„ä»·å€¼\"\u003eæºç é˜…è¯»çš„ä»·å€¼\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæ·±å…¥ç†è§£åŸç†\u003c/strong\u003eï¼šçŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå­¦ä¹ è®¾è®¡æ¨¡å¼\u003c/strong\u003eï¼šçœ‹å¤§å¸ˆå¦‚ä½•è®¾è®¡æ¶æ„\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæå‡ç¼–ç èƒ½åŠ›\u003c/strong\u003eï¼šå­¦ä¹ ä¼˜ç§€çš„ä»£ç é£æ ¼\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè§£å†³ç–‘éš¾é—®é¢˜\u003c/strong\u003eï¼šé‡åˆ°é—®é¢˜èƒ½å¿«é€Ÿå®šä½\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå‚ä¸å¼€æºè´¡çŒ®\u003c/strong\u003eï¼šä¸ºå¼€æºç¤¾åŒºåšè´¡çŒ®\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"å¸¸è§è¯¯åŒº\"\u003eå¸¸è§è¯¯åŒº\u003c/h3\u003e\n\u003cp\u003eâŒ \u003cstrong\u003eä»ç¬¬ä¸€è¡Œå¼€å§‹è¯»\u003c/strong\u003eï¼šå®¹æ˜“è¿·å¤±åœ¨ç»†èŠ‚ä¸­\nâŒ \u003cstrong\u003eè¿½æ±‚å®Œå…¨ç†è§£\u003c/strong\u003eï¼šè¯•å›¾ç†è§£æ¯ä¸€è¡Œä»£ç \nâŒ \u003cstrong\u003eæ²¡æœ‰ç›®æ ‡\u003c/strong\u003eï¼šæ¼«æ— ç›®çš„åœ°æµè§ˆä»£ç \nâŒ \u003cstrong\u003eåªçœ‹ä¸ç»ƒ\u003c/strong\u003eï¼šåªçœ‹ä¸å†™ï¼Œæ— æ³•çœŸæ­£æŒæ¡\u003c/p\u003e\n\u003cp\u003eâœ… \u003cstrong\u003eå¸¦ç€é—®é¢˜è¯»\u003c/strong\u003eï¼šå›´ç»•å…·ä½“é—®é¢˜å±•å¼€\nâœ… \u003cstrong\u003eæŠ“ä½ä¸»çº¿\u003c/strong\u003eï¼šç†è§£æ ¸å¿ƒæµç¨‹å’Œè®¾è®¡æ€æƒ³\nâœ… \u003cstrong\u003eå¾ªåºæ¸è¿›\u003c/strong\u003eï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥\nâœ… \u003cstrong\u003eè¾¹è¯»è¾¹å†™\u003c/strong\u003eï¼šé€šè¿‡å®è·µåŠ æ·±ç†è§£\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e é˜…è¯»æºç ä¸æ˜¯ä¸ºäº†è®°ä½æ¯ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯ç†è§£è®¾è®¡æ€æƒ³å’Œæ¶æ„æ¨¡å¼ã€‚è¦å­¦ä¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œä»æ•´ä½“åˆ°ç»†èŠ‚çš„é˜…è¯»æ–¹æ³•ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"æºç é˜…è¯»æ–¹æ³•è®º\"\u003eæºç é˜…è¯»æ–¹æ³•è®º\u003c/h2\u003e\n\u003ch3 id=\"1-å‡†å¤‡é˜¶æ®µ\"\u003e1. å‡†å¤‡é˜¶æ®µ\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eé€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé€‰æ‹©ç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚Spring Boot 2.7.xï¼‰\u003c/li\u003e\n\u003cli\u003eé¿å…é€‰æ‹©æœ€æ–°çš„å¼€å‘ç‰ˆæœ¬\u003c/li\u003e\n\u003cli\u003eæŸ¥çœ‹ç‰ˆæœ¬çš„Release Notes\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eæ­å»ºè°ƒè¯•ç¯å¢ƒ\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. å…‹éš†æºç \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/spring-projects/spring-boot.git\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e spring-boot\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. åˆ‡æ¢åˆ°ç¨³å®šç‰ˆæœ¬\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout v2.7.18\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 3. å¯¼å…¥IDEï¼ˆIDEAï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# File -\u0026gt; Open -\u0026gt; é€‰æ‹©spring-bootç›®å½•\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eå‡†å¤‡ç¤ºä¾‹é¡¹ç›®\u003c/strong\u003eï¼š\u003c/p\u003e","title":"å¦‚ä½•é˜…è¯»å¼€æºé¡¹ç›®æºç ï¼šä»¥ Spring Boot ä¸ºä¾‹"},{"content":"\u0026ldquo;è¿™ä¸ªæ¥å£æ€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿ\u0026ldquo;è¿™æ˜¯æ¯ä¸ªåç«¯å¼€å‘éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å½“ç”¨æˆ·æŠ±æ€¨ç³»ç»Ÿå¡é¡¿ï¼Œå½“ç›‘æ§å‘Šè­¦é¢‘ç¹è§¦å‘ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç³»ç»Ÿæ€§åœ°å®šä½å’Œè§£å†³æ€§èƒ½é—®é¢˜ï¼Ÿ\næœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå¸¦ä½ ç»å†ä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ï¼Œä»é—®é¢˜å‘ç°åˆ°æœ€ç»ˆä¼˜åŒ–ï¼Œå°†æ¥å£å“åº”æ—¶é—´ä»3ç§’é™ä½åˆ°300msã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æ€§èƒ½é—®é¢˜çš„ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³• å­¦ä¼šä½¿ç”¨å„ç§æ€§èƒ½åˆ†æå·¥å…· ç†è§£å¸¸è§çš„æ€§èƒ½ç“¶é¢ˆåŠè§£å†³æ–¹æ¡ˆ äº†è§£æ•°æ®åº“ã€ç¼“å­˜ã€ä»£ç å±‚é¢çš„ä¼˜åŒ–æŠ€å·§ å»ºç«‹å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹ é—®é¢˜èƒŒæ™¯ ä¸šåŠ¡åœºæ™¯ æŸç”µå•†ç³»ç»Ÿçš„è®¢å•è¯¦æƒ…æ¥å£ï¼Œç”¨æˆ·åé¦ˆé¡µé¢åŠ è½½ç¼“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚\næ¥å£å®šä¹‰ï¼š\n1@GetMapping(\u0026#34;/api/orders/{orderId}\u0026#34;) 2public Result\u0026lt;OrderDetailVO\u0026gt; getOrderDetail(@PathVariable Long orderId) { 3 return Result.success(orderService.getOrderDetail(orderId)); 4} ç›‘æ§æ•°æ®ï¼š\nå¹³å‡å“åº”æ—¶é—´ï¼š2.8ç§’ P95å“åº”æ—¶é—´ï¼š3.5ç§’ P99å“åº”æ—¶é—´ï¼š5ç§’ QPSï¼š100 ä¸šåŠ¡è¦æ±‚ï¼š\nå“åº”æ—¶é—´ \u0026lt; 500ms P99 \u0026lt; 1ç§’ æ¶æ„æ€è€ƒï¼š æ€§èƒ½ä¼˜åŒ–ä¸æ˜¯ç›²ç›®åœ°ä¼˜åŒ–ï¼Œè€Œæ˜¯è¦åŸºäºæ•°æ®å’Œç›®æ ‡ã€‚é¦–å…ˆè¦æ˜ç¡®æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŒ–ç›®æ ‡ï¼Œç„¶åç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚\nç¬¬ä¸€æ­¥ï¼šé—®é¢˜å®šä½ 1. æ·»åŠ ç›‘æ§åŸ‹ç‚¹ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ—¶é—´éƒ½èŠ±åœ¨å“ªé‡Œäº†ï¼š\n1@Service 2@Slf4j 3public class OrderService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 @Autowired 9 private UserService userService; 10 11 @Autowired 12 private ProductService productService; 13 14 @Autowired 15 private LogisticsService logisticsService; 16 17 public OrderDetailVO getOrderDetail(Long orderId) { 18 long startTime = System.currentTimeMillis(); 19 20 // 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯ 21 long step1Start = System.currentTimeMillis(); 22 Order order = orderMapper.selectById(orderId); 23 log.info(\u0026#34;æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step1Start); 24 25 // 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ 26 long step2Start = System.currentTimeMillis(); 27 User user = userService.getUserById(order.getUserId()); 28 log.info(\u0026#34;æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step2Start); 29 30 // 3. æŸ¥è¯¢å•†å“ä¿¡æ¯ 31 long step3Start = System.currentTimeMillis(); 32 List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 33 List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 34 for (OrderItem item : items) { 35 Product product = productService.getProductById(item.getProductId()); 36 products.add(product); 37 } 38 log.info(\u0026#34;æŸ¥è¯¢å•†å“è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step3Start); 39 40 // 4. æŸ¥è¯¢ç‰©æµä¿¡æ¯ 41 long step4Start = System.currentTimeMillis(); 42 Logistics logistics = logisticsService.getLogisticsByOrderId(orderId); 43 log.info(\u0026#34;æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step4Start); 44 45 // 5. ç»„è£…è¿”å›æ•°æ® 46 OrderDetailVO vo = buildOrderDetailVO(order, user, products, logistics); 47 48 log.info(\u0026#34;æ€»è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - startTime); 49 return vo; 50 } 51} æ—¥å¿—è¾“å‡ºï¼š\n1æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š50ms 2æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š100ms 3æŸ¥è¯¢å•†å“è€—æ—¶ï¼š2500ms â† ç“¶é¢ˆï¼ 4æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š150ms 5æ€»è€—æ—¶ï¼š2800ms 2. åˆ†æç“¶é¢ˆ é€šè¿‡æ—¥å¿—å‘ç°ï¼ŒæŸ¥è¯¢å•†å“ä¿¡æ¯è€—æ—¶æœ€é•¿ï¼Œå æ€»è€—æ—¶çš„89%ã€‚è¿›ä¸€æ­¥åˆ†æä»£ç ï¼š\n1// é—®é¢˜ä»£ç ï¼šN+1æŸ¥è¯¢ 2List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); // 1æ¬¡æŸ¥è¯¢ 3List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 4for (OrderItem item : items) { 5 Product product = productService.getProductById(item.getProductId()); // Næ¬¡æŸ¥è¯¢ 6 products.add(product); 7} é—®é¢˜åˆ†æï¼š\nè®¢å•æœ‰10ä¸ªå•†å“ æ¯ä¸ªå•†å“æŸ¥è¯¢è€—æ—¶250ms æ€»è€—æ—¶ï¼š10 Ã— 250ms = 2500ms ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“ä¼˜åŒ– ä¼˜åŒ–1ï¼šæ‰¹é‡æŸ¥è¯¢ å°†N+1æŸ¥è¯¢æ”¹ä¸ºæ‰¹é‡æŸ¥è¯¢ï¼š\n1// ä¼˜åŒ–åçš„ä»£ç  2List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 3 4// æ”¶é›†æ‰€æœ‰å•†å“ID 5List\u0026lt;Long\u0026gt; productIds = items.stream() 6 .map(OrderItem::getProductId) 7 .collect(Collectors.toList()); 8 9// æ‰¹é‡æŸ¥è¯¢å•†å“ 10List\u0026lt;Product\u0026gt; products = productService.getProductsByIds(productIds); Mapperå®ç°ï¼š\n1@Mapper 2public interface ProductMapper { 3 4 /** 5 * æ‰¹é‡æŸ¥è¯¢å•†å“ 6 */ 7 @Select(\u0026#34;\u0026lt;script\u0026gt;\u0026#34; + 8 \u0026#34;SELECT * FROM t_product WHERE id IN \u0026#34; + 9 \u0026#34;\u0026lt;foreach collection=\u0026#39;ids\u0026#39; item=\u0026#39;id\u0026#39; open=\u0026#39;(\u0026#39; separator=\u0026#39;,\u0026#39; close=\u0026#39;)\u0026#39;\u0026gt;\u0026#34; + 10 \u0026#34;#{id}\u0026#34; + 11 \u0026#34;\u0026lt;/foreach\u0026gt;\u0026#34; + 12 \u0026#34;\u0026lt;/script\u0026gt;\u0026#34;) 13 List\u0026lt;Product\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); 14} ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢å•†å“è€—æ—¶ï¼š2500ms â†’ 300ms æ€»è€—æ—¶ï¼š2800ms â†’ 600ms ä¼˜åŒ–2ï¼šç´¢å¼•ä¼˜åŒ– åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå‘ç°è®¢å•é¡¹æŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼š\n1-- æ…¢æŸ¥è¯¢SQL 2SELECT * FROM t_order_item WHERE order_id = 123456; 3 4-- æ‰§è¡Œè®¡åˆ’ 5EXPLAIN SELECT * FROM t_order_item WHERE order_id = 123456; 6-- type: ALLï¼ˆå…¨è¡¨æ‰«æï¼‰ æ·»åŠ ç´¢å¼•ï¼š\n1CREATE INDEX idx_order_id ON t_order_item(order_id); ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢è®¢å•é¡¹è€—æ—¶ï¼š50ms â†’ 5ms æ€»è€—æ—¶ï¼š600ms â†’ 555ms ä¼˜åŒ–3ï¼šæŸ¥è¯¢å­—æ®µä¼˜åŒ– åŸæŸ¥è¯¢ä½¿ç”¨äº†SELECT *ï¼Œä½†å®é™…åªéœ€è¦éƒ¨åˆ†å­—æ®µï¼š\n1// ä¼˜åŒ–å‰ 2@Select(\u0026#34;SELECT * FROM t_product WHERE id IN (...)\u0026#34;) 3List\u0026lt;Product\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); 4 5// ä¼˜åŒ–åï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ 6@Select(\u0026#34;SELECT id, name, price, image_url FROM t_product WHERE id IN (...)\u0026#34;) 7List\u0026lt;ProductDTO\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢å•†å“è€—æ—¶ï¼š300ms â†’ 200ms æ€»è€—æ—¶ï¼š555ms â†’ 455ms ç¬¬ä¸‰æ­¥ï¼šç¼“å­˜ä¼˜åŒ– ä¼˜åŒ–4ï¼šæ·»åŠ Redisç¼“å­˜ å•†å“ä¿¡æ¯å˜åŒ–ä¸é¢‘ç¹ï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼š\n1@Service 2@Slf4j 3public class ProductService { 4 5 @Autowired 6 private ProductMapper productMapper; 7 8 @Autowired 9 private RedisTemplate\u0026lt;String, Product\u0026gt; redisTemplate; 10 11 private static final String PRODUCT_CACHE_KEY = \u0026#34;product:\u0026#34;; 12 private static final long CACHE_EXPIRE_TIME = 30; // 30åˆ†é’Ÿ 13 14 public List\u0026lt;Product\u0026gt; getProductsByIds(List\u0026lt;Long\u0026gt; productIds) { 15 List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 16 List\u0026lt;Long\u0026gt; missIds = new ArrayList\u0026lt;\u0026gt;(); 17 18 // 1. æ‰¹é‡ä»ç¼“å­˜è·å– 19 List\u0026lt;String\u0026gt; keys = productIds.stream() 20 .map(id -\u0026gt; PRODUCT_CACHE_KEY + id) 21 .collect(Collectors.toList()); 22 23 List\u0026lt;Product\u0026gt; cachedProducts = redisTemplate.opsForValue().multiGet(keys); 24 25 // 2. æ‰¾å‡ºç¼“å­˜æœªå‘½ä¸­çš„ID 26 for (int i = 0; i \u0026lt; productIds.size(); i++) { 27 Product product = cachedProducts.get(i); 28 if (product != null) { 29 products.add(product); 30 } else { 31 missIds.add(productIds.get(i)); 32 } 33 } 34 35 // 3. æŸ¥è¯¢æ•°æ®åº“ 36 if (!missIds.isEmpty()) { 37 List\u0026lt;Product\u0026gt; dbProducts = productMapper.selectByIds(missIds); 38 products.addAll(dbProducts); 39 40 // 4. å†™å…¥ç¼“å­˜ 41 for (Product product : dbProducts) { 42 redisTemplate.opsForValue().set( 43 PRODUCT_CACHE_KEY + product.getId(), 44 product, 45 CACHE_EXPIRE_TIME, 46 TimeUnit.MINUTES 47 ); 48 } 49 } 50 51 return products; 52 } 53} ä¼˜åŒ–æ•ˆæœï¼š\nç¼“å­˜å‘½ä¸­ç‡ï¼š80% æŸ¥è¯¢å•†å“è€—æ—¶ï¼š200ms â†’ 50msï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰ æ€»è€—æ—¶ï¼š455ms â†’ 305ms ä¼˜åŒ–5ï¼šæœ¬åœ°ç¼“å­˜ å¯¹äºçƒ­ç‚¹å•†å“ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š\n1@Service 2public class ProductService { 3 4 // ä½¿ç”¨Caffeineæœ¬åœ°ç¼“å­˜ 5 private final LoadingCache\u0026lt;Long, Product\u0026gt; localCache = Caffeine.newBuilder() 6 .maximumSize(1000) 7 .expireAfterWrite(5, TimeUnit.MINUTES) 8 .build(this::loadProduct); 9 10 private Product loadProduct(Long productId) { 11 // å…ˆæŸ¥Redisï¼Œå†æŸ¥æ•°æ®åº“ 12 String key = PRODUCT_CACHE_KEY + productId; 13 Product product = redisTemplate.opsForValue().get(key); 14 15 if (product == null) { 16 product = productMapper.selectById(productId); 17 if (product != null) { 18 redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES); 19 } 20 } 21 22 return product; 23 } 24 25 public Product getProductById(Long productId) { 26 return localCache.get(productId); 27 } 28} ç¼“å­˜å±‚çº§ï¼š\n1è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â†’ Redis â†’ æ•°æ®åº“ ä¼˜åŒ–æ•ˆæœï¼š\næœ¬åœ°ç¼“å­˜å‘½ä¸­ç‡ï¼š50% æŸ¥è¯¢å•†å“è€—æ—¶ï¼š50ms â†’ 20msï¼ˆæœ¬åœ°ç¼“å­˜å‘½ä¸­æ—¶ï¼‰ æ€»è€—æ—¶ï¼š305ms â†’ 275ms ç¬¬å››æ­¥ï¼šå¹¶å‘ä¼˜åŒ– ä¼˜åŒ–6ï¼šå¹¶è¡ŒæŸ¥è¯¢ ç”¨æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€ç‰©æµä¿¡æ¯ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯ä»¥å¹¶è¡ŒæŸ¥è¯¢ï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private ThreadPoolExecutor executor; 6 7 public OrderDetailVO getOrderDetail(Long orderId) { 8 // 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯ 9 Order order = orderMapper.selectById(orderId); 10 11 // 2. å¹¶è¡ŒæŸ¥è¯¢ç”¨æˆ·ã€å•†å“ã€ç‰©æµä¿¡æ¯ 12 CompletableFuture\u0026lt;User\u0026gt; userFuture = CompletableFuture.supplyAsync( 13 () -\u0026gt; userService.getUserById(order.getUserId()), 14 executor 15 ); 16 17 CompletableFuture\u0026lt;List\u0026lt;Product\u0026gt;\u0026gt; productsFuture = CompletableFuture.supplyAsync(() -\u0026gt; { 18 List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 19 List\u0026lt;Long\u0026gt; productIds = items.stream() 20 .map(OrderItem::getProductId) 21 .collect(Collectors.toList()); 22 return productService.getProductsByIds(productIds); 23 }, executor); 24 25 CompletableFuture\u0026lt;Logistics\u0026gt; logisticsFuture = CompletableFuture.supplyAsync( 26 () -\u0026gt; logisticsService.getLogisticsByOrderId(orderId), 27 executor 28 ); 29 30 // 3. ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ 31 CompletableFuture.allOf(userFuture, productsFuture, logisticsFuture).join(); 32 33 // 4. ç»„è£…è¿”å›æ•°æ® 34 User user = userFuture.join(); 35 List\u0026lt;Product\u0026gt; products = productsFuture.join(); 36 Logistics logistics = logisticsFuture.join(); 37 38 return buildOrderDetailVO(order, user, products, logistics); 39 } 40} ä¼˜åŒ–æ•ˆæœï¼š\nåŸä¸²è¡Œè€—æ—¶ï¼š50msï¼ˆè®¢å•ï¼‰+ 100msï¼ˆç”¨æˆ·ï¼‰+ 20msï¼ˆå•†å“ï¼‰+ 150msï¼ˆç‰©æµï¼‰= 320ms å¹¶è¡Œè€—æ—¶ï¼š50msï¼ˆè®¢å•ï¼‰+ max(100ms, 20ms, 150ms) = 200ms æ€»è€—æ—¶ï¼š275ms â†’ 200ms ç¬¬äº”æ­¥ï¼šä»£ç ä¼˜åŒ– ä¼˜åŒ–7ï¼šå‡å°‘å¯¹è±¡åˆ›å»º 1// ä¼˜åŒ–å‰ï¼šé¢‘ç¹åˆ›å»ºå¯¹è±¡ 2public OrderDetailVO buildOrderDetailVO(Order order, User user, 3 List\u0026lt;Product\u0026gt; products, Logistics logistics) { 4 OrderDetailVO vo = new OrderDetailVO(); 5 vo.setOrderId(order.getId()); 6 vo.setOrderNo(order.getOrderNo()); 7 // ... è®¾ç½®æ›´å¤šå­—æ®µ 8 9 UserVO userVO = new UserVO(); 10 userVO.setUserId(user.getId()); 11 userVO.setUserName(user.getName()); 12 vo.setUser(userVO); 13 14 List\u0026lt;ProductVO\u0026gt; productVOs = new ArrayList\u0026lt;\u0026gt;(); 15 for (Product product : products) { 16 ProductVO productVO = new ProductVO(); 17 productVO.setProductId(product.getId()); 18 productVO.setProductName(product.getName()); 19 productVOs.add(productVO); 20 } 21 vo.setProducts(productVOs); 22 23 return vo; 24} 25 26// ä¼˜åŒ–åï¼šä½¿ç”¨å¯¹è±¡æ˜ å°„å·¥å…· 27@Autowired 28private ModelMapper modelMapper; 29 30public OrderDetailVO buildOrderDetailVO(Order order, User user, 31 List\u0026lt;Product\u0026gt; products, Logistics logistics) { 32 OrderDetailVO vo = modelMapper.map(order, OrderDetailVO.class); 33 vo.setUser(modelMapper.map(user, UserVO.class)); 34 vo.setProducts(products.stream() 35 .map(p -\u0026gt; modelMapper.map(p, ProductVO.class)) 36 .collect(Collectors.toList())); 37 vo.setLogistics(modelMapper.map(logistics, LogisticsVO.class)); 38 return vo; 39} ä¼˜åŒ–8ï¼šé¿å…ä¸å¿…è¦çš„è®¡ç®— 1// ä¼˜åŒ–å‰ï¼šæ¯æ¬¡éƒ½è®¡ç®— 2public BigDecimal calculateTotalAmount(List\u0026lt;OrderItem\u0026gt; items) { 3 BigDecimal total = BigDecimal.ZERO; 4 for (OrderItem item : items) { 5 BigDecimal itemAmount = item.getPrice().multiply(new BigDecimal(item.getQuantity())); 6 total = total.add(itemAmount); 7 } 8 return total; 9} 10 11// ä¼˜åŒ–åï¼šä½¿ç”¨æ•°æ®åº“è®¡ç®—å¥½çš„å­—æ®µ 12public BigDecimal getTotalAmount(Order order) { 13 return order.getTotalAmount(); // ä¸‹å•æ—¶å·²è®¡ç®—å¹¶å­˜å‚¨ 14} ç¬¬å…­æ­¥ï¼šç›‘æ§ä¸éªŒè¯ æ€§èƒ½æµ‹è¯• ä½¿ç”¨JMeterè¿›è¡Œå‹æµ‹ï¼š\n1# å‹æµ‹é…ç½® 2çº¿ç¨‹æ•°ï¼š100 3æŒç»­æ—¶é—´ï¼š5åˆ†é’Ÿ ä¼˜åŒ–å‰åå¯¹æ¯”ï¼š\næŒ‡æ ‡ ä¼˜åŒ–å‰ ä¼˜åŒ–å æå‡ å¹³å‡å“åº”æ—¶é—´ 2800ms 280ms 90% P95å“åº”æ—¶é—´ 3500ms 350ms 90% P99å“åº”æ—¶é—´ 5000ms 450ms 91% QPS 100 500 400% CPUä½¿ç”¨ç‡ 80% 40% 50% ç›‘æ§å‘Šè­¦ é…ç½®Prometheuså‘Šè­¦è§„åˆ™ï¼š\n1groups: 2 - name: api_performance 3 rules: 4 - alert: HighResponseTime 5 expr: http_request_duration_seconds{quantile=\u0026#34;0.99\u0026#34;} \u0026gt; 1 6 for: 5m 7 labels: 8 severity: warning 9 annotations: 10 summary: \u0026#34;APIå“åº”æ—¶é—´è¿‡é«˜\u0026#34; 11 description: \u0026#34;{{ $labels.api }} P99å“åº”æ—¶é—´è¶…è¿‡1ç§’\u0026#34; ä¼˜åŒ–æ€»ç»“ ä¼˜åŒ–è·¯å¾„ 1åŸå§‹æ€§èƒ½ï¼š2800ms 2 â†“ æ‰¹é‡æŸ¥è¯¢ï¼ˆN+1é—®é¢˜ï¼‰ 31. 600msï¼ˆä¼˜åŒ–78%ï¼‰ 4 â†“ æ·»åŠ ç´¢å¼• 52. 555msï¼ˆä¼˜åŒ–7%ï¼‰ 6 â†“ æŸ¥è¯¢å­—æ®µä¼˜åŒ– 73. 455msï¼ˆä¼˜åŒ–18%ï¼‰ 8 â†“ Redisç¼“å­˜ 94. 305msï¼ˆä¼˜åŒ–33%ï¼‰ 10 â†“ æœ¬åœ°ç¼“å­˜ 115. 275msï¼ˆä¼˜åŒ–10%ï¼‰ 12 â†“ å¹¶è¡ŒæŸ¥è¯¢ 136. 200msï¼ˆä¼˜åŒ–27%ï¼‰ 14 â†“ ä»£ç ä¼˜åŒ– 15æœ€ç»ˆï¼š280msï¼ˆæ€»ä¼˜åŒ–90%ï¼‰ ä¼˜åŒ–åŸåˆ™ å…ˆå®šä½ï¼Œåä¼˜åŒ–ï¼šé€šè¿‡ç›‘æ§æ‰¾åˆ°çœŸæ­£çš„ç“¶é¢ˆ æŠ“å¤§æ”¾å°ï¼šä¼˜å…ˆä¼˜åŒ–å æ¯”æœ€å¤§çš„éƒ¨åˆ† åˆ†å±‚ä¼˜åŒ–ï¼šæ•°æ®åº“ â†’ ç¼“å­˜ â†’ ä»£ç  â†’ æ¶æ„ é‡åŒ–è¯„ä¼°ï¼šæ¯æ¬¡ä¼˜åŒ–éƒ½è¦æœ‰æ•°æ®æ”¯æ’‘ æŒç»­ç›‘æ§ï¼šä¼˜åŒ–åè¦æŒç»­è§‚å¯Ÿæ•ˆæœ å¸¸è§æ€§èƒ½ç“¶é¢ˆ ç“¶é¢ˆç±»å‹ å…¸å‹è¡¨ç° è§£å†³æ–¹æ¡ˆ æ•°æ®åº“æ…¢æŸ¥è¯¢ å“åº”æ—¶é—´é•¿ï¼Œæ•°æ®åº“CPUé«˜ ç´¢å¼•ä¼˜åŒ–ã€SQLä¼˜åŒ–ã€åˆ†åº“åˆ†è¡¨ N+1æŸ¥è¯¢ å¤§é‡é‡å¤æŸ¥è¯¢ æ‰¹é‡æŸ¥è¯¢ã€JOINæŸ¥è¯¢ ç¼“å­˜æœªå‘½ä¸­ æ•°æ®åº“å‹åŠ›å¤§ æ·»åŠ ç¼“å­˜ã€é¢„çƒ­ç¼“å­˜ ä¸²è¡Œè°ƒç”¨ å“åº”æ—¶é—´=å„æ­¥éª¤ä¹‹å’Œ å¹¶è¡Œè°ƒç”¨ã€å¼‚æ­¥å¤„ç† å¯¹è±¡åˆ›å»º GCé¢‘ç¹ å¯¹è±¡å¤ç”¨ã€æ± åŒ–æŠ€æœ¯ é”ç«äº‰ å¹¶å‘æ€§èƒ½å·® å‡å°é”ç²’åº¦ã€æ— é”åŒ– æ€§èƒ½ä¼˜åŒ–å·¥å…·ç®± 1. ç›‘æ§å·¥å…· APMå·¥å…·ï¼š\nSkyWalkingï¼šåˆ†å¸ƒå¼è¿½è¸ª Prometheus + Grafanaï¼šæŒ‡æ ‡ç›‘æ§ ELKï¼šæ—¥å¿—åˆ†æ æ•°æ®åº“ç›‘æ§ï¼š\nMySQLæ…¢æŸ¥è¯¢æ—¥å¿— Explainæ‰§è¡Œè®¡åˆ’ Performance Schema 2. åˆ†æå·¥å…· JVMåˆ†æï¼š\n1# æŸ¥çœ‹GCæƒ…å†µ 2jstat -gcutil \u0026lt;pid\u0026gt; 1000 3 4# ç”Ÿæˆå †è½¬å‚¨ 5jmap -dump:format=b,file=heap.hprof \u0026lt;pid\u0026gt; 6 7# çº¿ç¨‹åˆ†æ 8jstack \u0026lt;pid\u0026gt; \u0026gt; thread.txt ç«ç„°å›¾ï¼š\n1# ä½¿ç”¨async-profiler 2./profiler.sh -d 60 -f flamegraph.html \u0026lt;pid\u0026gt; 3. å‹æµ‹å·¥å…· JMeterï¼š\n1jmeter -n -t test-plan.jmx -l result.jtl -e -o report Gatlingï¼š\n1setUp( 2 scn.inject(rampUsersPerSec(10) to 1000 during (5 minutes)) 3).protocols(httpProtocol) æœ€ä½³å®è·µ 1. æ€§èƒ½ä¼˜åŒ–checklist æ·»åŠ ç›‘æ§åŸ‹ç‚¹ï¼Œé‡åŒ–æ€§èƒ½æŒ‡æ ‡ åˆ†ææ…¢æŸ¥è¯¢ï¼Œä¼˜åŒ–SQLå’Œç´¢å¼• è¯†åˆ«N+1æŸ¥è¯¢ï¼Œæ”¹ä¸ºæ‰¹é‡æŸ¥è¯¢ æ·»åŠ ç¼“å­˜ï¼Œæé«˜è¯»æ€§èƒ½ å¹¶è¡ŒåŒ–ç‹¬ç«‹æ“ä½œï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ ä¼˜åŒ–ä»£ç é€»è¾‘ï¼Œå‡å°‘ä¸å¿…è¦çš„è®¡ç®— å‹æµ‹éªŒè¯ï¼Œç¡®ä¿ä¼˜åŒ–æ•ˆæœ æŒç»­ç›‘æ§ï¼Œé˜²æ­¢æ€§èƒ½é€€åŒ– 2. æ€§èƒ½ä¼˜åŒ–è¯¯åŒº âŒ è¿‡æ—©ä¼˜åŒ–ï¼šåœ¨æ²¡æœ‰æ€§èƒ½é—®é¢˜æ—¶å°±å¼€å§‹ä¼˜åŒ– âœ… åŸºäºæ•°æ®ä¼˜åŒ–ï¼šå…ˆæµ‹é‡ï¼Œå†ä¼˜åŒ–\nâŒ ç›²ç›®ä¼˜åŒ–ï¼šä¸çŸ¥é“ç“¶é¢ˆåœ¨å“ªå°±å¼€å§‹ä¼˜åŒ– âœ… å®šä½ç“¶é¢ˆï¼šæ‰¾åˆ°çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆ\nâŒ å±€éƒ¨ä¼˜åŒ–ï¼šåªä¼˜åŒ–æŸä¸ªç‚¹ âœ… ç³»ç»Ÿä¼˜åŒ–ï¼šä»æ•´ä½“è§’åº¦ä¼˜åŒ–\nâŒ å¿½ç•¥ç›‘æ§ï¼šä¼˜åŒ–åä¸ç›‘æ§æ•ˆæœ âœ… æŒç»­ç›‘æ§ï¼šä¼˜åŒ–åæŒç»­è§‚å¯Ÿ\n3. æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹ 1å‘ç°é—®é¢˜ 2 â†“ 3æ·»åŠ ç›‘æ§ï¼ˆé‡åŒ–é—®é¢˜ï¼‰ 4 â†“ 5å®šä½ç“¶é¢ˆï¼ˆæ‰¾åˆ°æ ¹å› ï¼‰ 6 â†“ 7åˆ¶å®šæ–¹æ¡ˆï¼ˆè¯„ä¼°æ”¶ç›Šï¼‰ 8 â†“ 9å®æ–½ä¼˜åŒ–ï¼ˆå°æ­¥å¿«è·‘ï¼‰ 10 â†“ 11éªŒè¯æ•ˆæœï¼ˆå‹æµ‹éªŒè¯ï¼‰ 12 â†“ 13æŒç»­ç›‘æ§ï¼ˆé˜²æ­¢é€€åŒ–ï¼‰ é¿å‘æç¤ºï¼š æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§çš„å·¥ä½œã€‚è¦å»ºç«‹æ€§èƒ½ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³æ€§èƒ½é—®é¢˜ã€‚åŒæ—¶è¦æ³¨æ„ï¼Œè¿‡åº¦ä¼˜åŒ–å¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿå¤æ‚åº¦ï¼Œè¦åœ¨æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå±•ç¤ºäº†å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ï¼š\né—®é¢˜å®šä½ï¼šé€šè¿‡ç›‘æ§åŸ‹ç‚¹æ‰¾åˆ°ç“¶é¢ˆ æ•°æ®åº“ä¼˜åŒ–ï¼šæ‰¹é‡æŸ¥è¯¢ã€ç´¢å¼•ä¼˜åŒ–ã€å­—æ®µä¼˜åŒ– ç¼“å­˜ä¼˜åŒ–ï¼šRedisç¼“å­˜ã€æœ¬åœ°ç¼“å­˜ å¹¶å‘ä¼˜åŒ–ï¼šå¹¶è¡ŒæŸ¥è¯¢ã€å¼‚æ­¥å¤„ç† ä»£ç ä¼˜åŒ–ï¼šå‡å°‘å¯¹è±¡åˆ›å»ºã€é¿å…é‡å¤è®¡ç®— ç›‘æ§éªŒè¯ï¼šå‹æµ‹éªŒè¯ã€æŒç»­ç›‘æ§ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯ï¼š\né‡åŒ–é—®é¢˜ï¼šç”¨æ•°æ®è¯´è¯ å®šä½ç“¶é¢ˆï¼šæ‰¾åˆ°çœŸæ­£çš„é—®é¢˜ ç³»ç»Ÿä¼˜åŒ–ï¼šä»æ•´ä½“è§’åº¦æ€è€ƒ æŒç»­æ”¹è¿›ï¼šå»ºç«‹é•¿æ•ˆæœºåˆ¶ ä¸‹æ¬¡å½“ä½ é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶ï¼Œä¸å¦¨æŒ‰ç…§æœ¬æ–‡çš„æ€è·¯ï¼Œç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚è®°ä½ï¼Œæ€§èƒ½ä¼˜åŒ–ä¸æ˜¯é“¶å¼¹ï¼Œè€Œæ˜¯ä¸€ä¸ªæŒç»­æ”¹è¿›çš„è¿‡ç¨‹ã€‚\n","permalink":"http://localhost:1313/posts/2025/10/%E6%8E%A5%E5%8F%A3%E5%93%8D%E5%BA%94%E6%85%A2%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8B%E6%97%85/","summary":"\u003cp\u003e\u0026ldquo;è¿™ä¸ªæ¥å£æ€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿ\u0026ldquo;è¿™æ˜¯æ¯ä¸ªåç«¯å¼€å‘éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å½“ç”¨æˆ·æŠ±æ€¨ç³»ç»Ÿå¡é¡¿ï¼Œå½“ç›‘æ§å‘Šè­¦é¢‘ç¹è§¦å‘ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç³»ç»Ÿæ€§åœ°å®šä½å’Œè§£å†³æ€§èƒ½é—®é¢˜ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå¸¦ä½ ç»å†ä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ï¼Œä»é—®é¢˜å‘ç°åˆ°æœ€ç»ˆä¼˜åŒ–ï¼Œå°†æ¥å£å“åº”æ—¶é—´ä»3ç§’é™ä½åˆ°300msã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ€§èƒ½é—®é¢˜çš„ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å„ç§æ€§èƒ½åˆ†æå·¥å…·\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å¸¸è§çš„æ€§èƒ½ç“¶é¢ˆåŠè§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£æ•°æ®åº“ã€ç¼“å­˜ã€ä»£ç å±‚é¢çš„ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"é—®é¢˜èƒŒæ™¯\"\u003eé—®é¢˜èƒŒæ™¯\u003c/h2\u003e\n\u003ch3 id=\"ä¸šåŠ¡åœºæ™¯\"\u003eä¸šåŠ¡åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿçš„è®¢å•è¯¦æƒ…æ¥å£ï¼Œç”¨æˆ·åé¦ˆé¡µé¢åŠ è½½ç¼“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ¥å£å®šä¹‰\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@GetMapping\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/api/orders/{orderId}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nd\"\u003e@PathVariable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esuccess\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eç›‘æ§æ•°æ®\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¹³å‡å“åº”æ—¶é—´ï¼š2.8ç§’\u003c/li\u003e\n\u003cli\u003eP95å“åº”æ—¶é—´ï¼š3.5ç§’\u003c/li\u003e\n\u003cli\u003eP99å“åº”æ—¶é—´ï¼š5ç§’\u003c/li\u003e\n\u003cli\u003eQPSï¼š100\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡è¦æ±‚\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå“åº”æ—¶é—´ \u0026lt; 500ms\u003c/li\u003e\n\u003cli\u003eP99 \u0026lt; 1ç§’\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e æ€§èƒ½ä¼˜åŒ–ä¸æ˜¯ç›²ç›®åœ°ä¼˜åŒ–ï¼Œè€Œæ˜¯è¦åŸºäºæ•°æ®å’Œç›®æ ‡ã€‚é¦–å…ˆè¦æ˜ç¡®æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŒ–ç›®æ ‡ï¼Œç„¶åç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥é—®é¢˜å®šä½\"\u003eç¬¬ä¸€æ­¥ï¼šé—®é¢˜å®šä½\u003c/h2\u003e\n\u003ch3 id=\"1-æ·»åŠ ç›‘æ§åŸ‹ç‚¹\"\u003e1. æ·»åŠ ç›‘æ§åŸ‹ç‚¹\u003c/h3\u003e\n\u003cp\u003eé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ—¶é—´éƒ½èŠ±åœ¨å“ªé‡Œäº†ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Slf4j\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrderService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderMapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eProductService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLogisticsService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogisticsService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estartTime\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep1Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep1Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep2Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep2Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. æŸ¥è¯¢å•†å“ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep3Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectItemsByOrderId\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eProduct\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eArrayList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e35\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eProduct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproduct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e36\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eproduct\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e37\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e38\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢å•†å“è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep3Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e39\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e40\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. æŸ¥è¯¢ç‰©æµä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e41\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep4Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e42\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eLogistics\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogistics\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogisticsService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetLogisticsByOrderId\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e43\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep4Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e44\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e45\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 5. ç»„è£…è¿”å›æ•°æ®\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e46\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003evo\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebuildOrderDetailVO\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogistics\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e47\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e48\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æ€»è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estartTime\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e49\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003evo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e50\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e51\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ—¥å¿—è¾“å‡º\u003c/strong\u003eï¼š\u003c/p\u003e","title":"æ¥å£å“åº”æ…¢ï¼Ÿä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…"},{"content":"åœ¨å¤§ä¿ƒã€ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œç³»ç»Ÿèƒ½å¦æ‰›ä½æµé‡å†²å‡»æ˜¯æ¯ä¸ªæŠ€æœ¯å›¢é˜Ÿæœ€å…³å¿ƒçš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„å•æ¥å£å‹æµ‹æ— æ³•çœŸå®åæ˜ ç³»ç»Ÿçš„æ•´ä½“æ‰¿è½½èƒ½åŠ›ï¼Œè€Œå…¨é“¾è·¯å‹æµ‹é€šè¿‡æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºï¼Œå¯ä»¥å…¨é¢éªŒè¯ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºå®Œæ•´çš„å‹æµ‹ä½“ç³»ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£å…¨é“¾è·¯å‹æµ‹çš„æ ¸å¿ƒä»·å€¼ æŒæ¡å‹æµ‹ç¯å¢ƒçš„æ­å»ºæ–¹æ¡ˆ å­¦ä¼šæ•°æ®éš”ç¦»ä¸æµé‡æ ‡è®° äº†è§£å‹æµ‹å·¥å…·çš„é€‰å‹ä¸ä½¿ç”¨ æŒæ¡æ€§èƒ½ç“¶é¢ˆçš„åˆ†æä¸ä¼˜åŒ– ä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹ ä¼ ç»Ÿå‹æµ‹ vs å…¨é“¾è·¯å‹æµ‹ ä¼ ç»Ÿå‹æµ‹ï¼š\né’ˆå¯¹å•ä¸ªæ¥å£æˆ–æœåŠ¡è¿›è¡Œå‹æµ‹ ä½¿ç”¨æµ‹è¯•ç¯å¢ƒæˆ–é¢„å‘å¸ƒç¯å¢ƒ æ•°æ®é‡å°ï¼Œæ— æ³•åæ˜ çœŸå®æƒ…å†µ å…¨é“¾è·¯å‹æµ‹ï¼š\nåœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå‹æµ‹ æ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„å®Œæ•´ä¸šåŠ¡æµç¨‹ ä½¿ç”¨çœŸå®çš„æ•°æ®é‡å’Œç³»ç»Ÿé…ç½® å…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼ çœŸå®æ€§ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œç»“æœæœ€å¯ä¿¡ å…¨é¢æ€§ï¼šè¦†ç›–æ‰€æœ‰ç³»ç»Ÿç»„ä»¶å’Œä¾èµ– åŠæ—¶æ€§ï¼šæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ æŒ‡å¯¼æ€§ï¼šä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æŒ å‹æµ‹åœºæ™¯ 1ç”¨æˆ·è®¿é—® â†’ ç½‘å…³ â†’ åº”ç”¨æœåŠ¡ â†’ ç¼“å­˜ â†’ æ•°æ®åº“ 2 â†“ 3 æ¶ˆæ¯é˜Ÿåˆ— â†’ å¼‚æ­¥æœåŠ¡ 4 â†“ 5 ç¬¬ä¸‰æ–¹æœåŠ¡ æ¶æ„æ€è€ƒï¼š å…¨é“¾è·¯å‹æµ‹ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯ä¸šåŠ¡é—®é¢˜ã€‚éœ€è¦äº§å“ã€è¿è¥ã€æŠ€æœ¯å›¢é˜Ÿå…±åŒå‚ä¸ï¼Œåˆ¶å®šåˆç†çš„å‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡†ã€‚\nå‹æµ‹æ–¹æ¡ˆè®¾è®¡ 1. å‹æµ‹ç›®æ ‡è®¾å®š æ€§èƒ½æŒ‡æ ‡ï¼š\nTPS/QPSï¼šæ¯ç§’äº‹åŠ¡æ•°/æŸ¥è¯¢æ•° å“åº”æ—¶é—´ï¼šP50ã€P95ã€P99 æˆåŠŸç‡ï¼šè¯·æ±‚æˆåŠŸçš„æ¯”ä¾‹ èµ„æºä½¿ç”¨ç‡ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ ä¸šåŠ¡æŒ‡æ ‡ï¼š\nè®¢å•åˆ›å»ºæˆåŠŸç‡ æ”¯ä»˜æˆåŠŸç‡ åº“å­˜æ‰£å‡å‡†ç¡®æ€§ ç¤ºä¾‹ç›®æ ‡ï¼š\n1å¤§ä¿ƒåœºæ™¯ï¼š 2- å³°å€¼ TPSï¼š10000 3- P99 å“åº”æ—¶é—´ï¼š\u0026lt; 500ms 4- æˆåŠŸç‡ï¼š\u0026gt; 99.9% 5- CPU ä½¿ç”¨ç‡ï¼š\u0026lt; 70% 2. å‹æµ‹æµé‡æ¨¡å‹ æµé‡ç‰¹å¾ï¼š\næµé‡æ›²çº¿ï¼šæ¨¡æ‹ŸçœŸå®çš„æµé‡æ³¢åŠ¨ ç”¨æˆ·è¡Œä¸ºï¼šæµè§ˆã€æœç´¢ã€ä¸‹å•ã€æ”¯ä»˜ ä¸šåŠ¡æ¯”ä¾‹ï¼šè¯»å†™æ¯”ä¾‹ã€çƒ­ç‚¹æ•°æ®åˆ†å¸ƒ å‹æµ‹è„šæœ¬ç¤ºä¾‹ï¼ˆJMeterï¼‰ï¼š\n1\u0026lt;TestPlan\u0026gt; 2 \u0026lt;ThreadGroup\u0026gt; 3 \u0026lt;stringProp name=\u0026#34;ThreadGroup.num_threads\u0026#34;\u0026gt;1000\u0026lt;/stringProp\u0026gt; 4 \u0026lt;stringProp name=\u0026#34;ThreadGroup.ramp_time\u0026#34;\u0026gt;60\u0026lt;/stringProp\u0026gt; 5 \u0026lt;stringProp name=\u0026#34;ThreadGroup.duration\u0026#34;\u0026gt;600\u0026lt;/stringProp\u0026gt; 6 7 \u0026lt;!-- æµè§ˆå•†å“ 60% --\u0026gt; 8 \u0026lt;HTTPSamplerProxy name=\u0026#34;æµè§ˆå•†å“\u0026#34;\u0026gt; 9 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/products/${productId}\u0026lt;/stringProp\u0026gt; 10 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;GET\u0026lt;/stringProp\u0026gt; 11 \u0026lt;/HTTPSamplerProxy\u0026gt; 12 13 \u0026lt;!-- åŠ å…¥è´­ç‰©è½¦ 30% --\u0026gt; 14 \u0026lt;HTTPSamplerProxy name=\u0026#34;åŠ å…¥è´­ç‰©è½¦\u0026#34;\u0026gt; 15 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/cart\u0026lt;/stringProp\u0026gt; 16 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;POST\u0026lt;/stringProp\u0026gt; 17 \u0026lt;/HTTPSamplerProxy\u0026gt; 18 19 \u0026lt;!-- ä¸‹å• 10% --\u0026gt; 20 \u0026lt;HTTPSamplerProxy name=\u0026#34;åˆ›å»ºè®¢å•\u0026#34;\u0026gt; 21 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/orders\u0026lt;/stringProp\u0026gt; 22 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;POST\u0026lt;/stringProp\u0026gt; 23 \u0026lt;/HTTPSamplerProxy\u0026gt; 24 \u0026lt;/ThreadGroup\u0026gt; 25\u0026lt;/TestPlan\u0026gt; 3. æ•°æ®éš”ç¦»æ–¹æ¡ˆ åœ¨ç”Ÿäº§ç¯å¢ƒå‹æµ‹ï¼Œå¿…é¡»åšå¥½æ•°æ®éš”ç¦»ï¼Œé¿å…å½±å“çœŸå®ç”¨æˆ·ï¼š\næ–¹æ¡ˆä¸€ï¼šå½±å­è¡¨\n1-- çœŸå®è¡¨ 2CREATE TABLE t_order ( 3 id BIGINT PRIMARY KEY, 4 user_id BIGINT, 5 amount DECIMAL(10,2), 6 status INT, 7 create_time DATETIME 8); 9 10-- å½±å­è¡¨ï¼ˆå‹æµ‹æ•°æ®ï¼‰ 11CREATE TABLE t_order_shadow ( 12 id BIGINT PRIMARY KEY, 13 user_id BIGINT, 14 amount DECIMAL(10,2), 15 status INT, 16 create_time DATETIME 17); æ–¹æ¡ˆäºŒï¼šå½±å­åº“\n1ç”Ÿäº§åº“ï¼šprod_db 2å½±å­åº“ï¼šprod_db_shadow æ–¹æ¡ˆä¸‰ï¼šæ•°æ®æ ‡è®°\n1// åœ¨æ•°æ®ä¸­æ·»åŠ å‹æµ‹æ ‡è®° 2@Data 3public class Order { 4 private Long id; 5 private Long userId; 6 private BigDecimal amount; 7 private Boolean isStressTest; // å‹æµ‹æ ‡è®° 8} æµé‡æ ‡è®°ä¸è·¯ç”± 1. æµé‡æ ‡è®° åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ å‹æµ‹æ ‡è®°ï¼š\n1public class StressTestFilter implements Filter { 2 3 private static final String STRESS_TEST_HEADER = \u0026#34;X-Stress-Test\u0026#34;; 4 5 @Override 6 public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) { 7 HttpServletRequest httpRequest = (HttpServletRequest) request; 8 9 // æ£€æŸ¥æ˜¯å¦ä¸ºå‹æµ‹æµé‡ 10 String stressTest = httpRequest.getHeader(STRESS_TEST_HEADER); 11 if (\u0026#34;true\u0026#34;.equals(stressTest)) { 12 // è®¾ç½®åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡ 13 StressTestContext.setStressTest(true); 14 } 15 16 try { 17 chain.doFilter(request, response); 18 } finally { 19 StressTestContext.clear(); 20 } 21 } 22} 2. æ•°æ®è·¯ç”± æ ¹æ®å‹æµ‹æ ‡è®°è·¯ç”±åˆ°å½±å­è¡¨/å½±å­åº“ï¼š\n1@Component 2public class StressTestDataSourceRouter extends AbstractRoutingDataSource { 3 4 @Override 5 protected Object determineCurrentLookupKey() { 6 // å¦‚æœæ˜¯å‹æµ‹æµé‡ï¼Œè·¯ç”±åˆ°å½±å­åº“ 7 if (StressTestContext.isStressTest()) { 8 return \u0026#34;shadow\u0026#34;; 9 } 10 return \u0026#34;master\u0026#34;; 11 } 12} 13 14@Configuration 15public class DataSourceConfig { 16 17 @Bean 18 public DataSource dataSource() { 19 StressTestDataSourceRouter router = new StressTestDataSourceRouter(); 20 21 Map\u0026lt;Object, Object\u0026gt; targetDataSources = new HashMap\u0026lt;\u0026gt;(); 22 targetDataSources.put(\u0026#34;master\u0026#34;, masterDataSource()); 23 targetDataSources.put(\u0026#34;shadow\u0026#34;, shadowDataSource()); 24 25 router.setTargetDataSources(targetDataSources); 26 router.setDefaultTargetDataSource(masterDataSource()); 27 28 return router; 29 } 30} 3. MyBatis æ‹¦æˆªå™¨ è‡ªåŠ¨åˆ‡æ¢è¡¨åï¼š\n1@Intercepts({ 2 @Signature(type = StatementHandler.class, method = \u0026#34;prepare\u0026#34;, args = {Connection.class, Integer.class}) 3}) 4public class StressTestInterceptor implements Interceptor { 5 6 @Override 7 public Object intercept(Invocation invocation) throws Throwable { 8 StatementHandler statementHandler = (StatementHandler) invocation.getTarget(); 9 BoundSql boundSql = statementHandler.getBoundSql(); 10 String sql = boundSql.getSql(); 11 12 // å¦‚æœæ˜¯å‹æµ‹æµé‡ï¼Œæ›¿æ¢è¡¨å 13 if (StressTestContext.isStressTest()) { 14 sql = sql.replaceAll(\u0026#34;t_(\\\\w+)\u0026#34;, \u0026#34;t_$1_shadow\u0026#34;); 15 16 // åå°„ä¿®æ”¹ SQL 17 Field field = boundSql.getClass().getDeclaredField(\u0026#34;sql\u0026#34;); 18 field.setAccessible(true); 19 field.set(boundSql, sql); 20 } 21 22 return invocation.proceed(); 23 } 24} å‹æµ‹å·¥å…·é€‰å‹ 1. JMeter ä¼˜ç‚¹ï¼š\nåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå¤šç§åè®® å›¾å½¢åŒ–ç•Œé¢ï¼Œæ˜“äºä½¿ç”¨ æ’ä»¶ä¸°å¯Œ ç¼ºç‚¹ï¼š\nå•æœºæ€§èƒ½æœ‰é™ èµ„æºæ¶ˆè€—è¾ƒå¤§ ä½¿ç”¨ç¤ºä¾‹ï¼š\n1# å‘½ä»¤è¡Œæ¨¡å¼è¿è¡Œ 2jmeter -n -t test-plan.jmx -l result.jtl -e -o report 3 4# åˆ†å¸ƒå¼å‹æµ‹ 5jmeter -n -t test-plan.jmx -R 192.168.1.101,192.168.1.102,192.168.1.103 2. Gatling ä¼˜ç‚¹ï¼š\nåŸºäº Scalaï¼Œæ€§èƒ½ä¼˜ç§€ DSL è„šæœ¬ï¼Œæ˜“äºç»´æŠ¤ æŠ¥å‘Šç¾è§‚ ç¤ºä¾‹è„šæœ¬ï¼š\n1import io.gatling.core.Predef._ 2import io.gatling.http.Predef._ 3import scala.concurrent.duration._ 4 5class OrderSimulation extends Simulation { 6 7 val httpProtocol = http 8 .baseUrl(\u0026#34;https://api.example.com\u0026#34;) 9 .header(\u0026#34;X-Stress-Test\u0026#34;, \u0026#34;true\u0026#34;) 10 11 val scn = scenario(\u0026#34;è®¢å•åœºæ™¯\u0026#34;) 12 .exec(http(\u0026#34;æµè§ˆå•†å“\u0026#34;) 13 .get(\u0026#34;/api/products/${productId}\u0026#34;) 14 .check(status.is(200))) 15 .pause(2) 16 .exec(http(\u0026#34;åŠ å…¥è´­ç‰©è½¦\u0026#34;) 17 .post(\u0026#34;/api/cart\u0026#34;) 18 .body(StringBody(\u0026#34;\u0026#34;\u0026#34;{\u0026#34;productId\u0026#34;: \u0026#34;${productId}\u0026#34;, \u0026#34;quantity\u0026#34;: 1}\u0026#34;\u0026#34;\u0026#34;)) 19 .check(status.is(200))) 20 .pause(3) 21 .exec(http(\u0026#34;åˆ›å»ºè®¢å•\u0026#34;) 22 .post(\u0026#34;/api/orders\u0026#34;) 23 .body(StringBody(\u0026#34;\u0026#34;\u0026#34;{\u0026#34;items\u0026#34;: [{\u0026#34;productId\u0026#34;: \u0026#34;${productId}\u0026#34;, \u0026#34;quantity\u0026#34;: 1}]}\u0026#34;\u0026#34;\u0026#34;)) 24 .check(status.is(200))) 25 26 setUp( 27 scn.inject( 28 rampUsersPerSec(10) to 1000 during (5 minutes), 29 constantUsersPerSec(1000) during (10 minutes) 30 ) 31 ).protocols(httpProtocol) 32} 3. é˜¿é‡Œäº‘ PTS ä¼˜ç‚¹ï¼š\näº‘ç«¯å‹æµ‹ï¼Œæ— éœ€æ­å»ºç¯å¢ƒ æ”¯æŒå¤§è§„æ¨¡å¹¶å‘ é›†æˆç›‘æ§å’ŒæŠ¥å‘Š é€‚ç”¨åœºæ™¯ï¼š\nå¤§è§„æ¨¡å‹æµ‹ï¼ˆä¸‡çº§å¹¶å‘ï¼‰ å¿«é€ŸéªŒè¯ æ— å‹æµ‹ç¯å¢ƒ å·¥å…·å¯¹æ¯” å·¥å…· æ€§èƒ½ æ˜“ç”¨æ€§ æˆæœ¬ é€‚ç”¨åœºæ™¯ JMeter ä¸­ é«˜ å…è´¹ ä¸­å°è§„æ¨¡å‹æµ‹ Gatling é«˜ ä¸­ å…è´¹ å¤§è§„æ¨¡å‹æµ‹ é˜¿é‡Œäº‘ PTS å¾ˆé«˜ é«˜ ä»˜è´¹ è¶…å¤§è§„æ¨¡å‹æµ‹ ç›‘æ§ä¸åˆ†æ 1. åº”ç”¨ç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nQPS/TPSï¼šæ¯ç§’è¯·æ±‚æ•° å“åº”æ—¶é—´ï¼šP50ã€P95ã€P99 é”™è¯¯ç‡ï¼š4xxã€5xx é”™è¯¯ çº¿ç¨‹æ± ï¼šæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ Prometheus + Grafanaï¼š\n1# prometheus.yml 2scrape_configs: 3 - job_name: \u0026#39;spring-boot\u0026#39; 4 metrics_path: \u0026#39;/actuator/prometheus\u0026#39; 5 static_configs: 6 - targets: [\u0026#39;192.168.1.101:8080\u0026#39;, \u0026#39;192.168.1.102:8080\u0026#39;] 2. ç³»ç»Ÿç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nCPUï¼šä½¿ç”¨ç‡ã€è´Ÿè½½ å†…å­˜ï¼šä½¿ç”¨ç‡ã€GC é¢‘ç‡ ç£ç›˜ï¼šIOPSã€ååé‡ ç½‘ç»œï¼šå¸¦å®½ã€è¿æ¥æ•° ä½¿ç”¨ Node Exporterï¼š\n1# å¯åŠ¨ Node Exporter 2docker run -d \\ 3 --name=node-exporter \\ 4 -p 9100:9100 \\ 5 prom/node-exporter 3. æ•°æ®åº“ç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nQPSï¼šæŸ¥è¯¢æ•° æ…¢æŸ¥è¯¢ï¼šæ‰§è¡Œæ—¶é—´ \u0026gt; 1s è¿æ¥æ•°ï¼šæ´»è·ƒè¿æ¥ é”ç­‰å¾…ï¼šè¡Œé”ã€è¡¨é” MySQL æ…¢æŸ¥è¯¢åˆ†æï¼š\n1-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— 2SET GLOBAL slow_query_log = \u0026#39;ON\u0026#39;; 3SET GLOBAL long_query_time = 1; 4 5-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ 6SELECT * FROM mysql.slow_log ORDER BY query_time DESC LIMIT 10; 4. æ€§èƒ½åˆ†æ ç«ç„°å›¾ï¼š\n1# ä½¿ç”¨ async-profiler 2./profiler.sh -d 60 -f flamegraph.html \u0026lt;pid\u0026gt; JVM åˆ†æï¼š\n1# æŸ¥çœ‹ GC æƒ…å†µ 2jstat -gcutil \u0026lt;pid\u0026gt; 1000 3 4# ç”Ÿæˆå †è½¬å‚¨ 5jmap -dump:format=b,file=heap.hprof \u0026lt;pid\u0026gt; 6 7# åˆ†æå †è½¬å‚¨ 8jhat heap.hprof æ€§èƒ½ä¼˜åŒ–å®æˆ˜ æ¡ˆä¾‹ä¸€ï¼šæ•°æ®åº“æ…¢æŸ¥è¯¢ é—®é¢˜ï¼šè®¢å•æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´ P99 è¾¾åˆ° 2 ç§’\nåˆ†æï¼š\n1-- æ…¢æŸ¥è¯¢ SQL 2SELECT * FROM t_order 3WHERE user_id = 123 AND status = 1 4ORDER BY create_time DESC 5LIMIT 10; 6 7-- æ‰§è¡Œè®¡åˆ’ 8EXPLAIN SELECT * FROM t_order 9WHERE user_id = 123 AND status = 1 10ORDER BY create_time DESC 11LIMIT 10; 12 13-- ç»“æœï¼štype=ALLï¼Œå…¨è¡¨æ‰«æ ä¼˜åŒ–ï¼š\n1-- æ·»åŠ å¤åˆç´¢å¼• 2CREATE INDEX idx_user_status_time ON t_order(user_id, status, create_time); 3 4-- ä¼˜åŒ–åï¼štype=refï¼Œä½¿ç”¨ç´¢å¼• æ•ˆæœï¼šå“åº”æ—¶é—´é™ä½åˆ° 50ms\næ¡ˆä¾‹äºŒï¼šç¼“å­˜ç©¿é€ é—®é¢˜ï¼šRedis ç¼“å­˜æœªå‘½ä¸­ï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“\nåˆ†æï¼š\n1// åŸä»£ç  2public Order getOrder(Long orderId) { 3 // æŸ¥è¯¢ç¼“å­˜ 4 Order order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 5 if (order == null) { 6 // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ 7 order = orderMapper.selectById(orderId); 8 if (order != null) { 9 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, order, 30, TimeUnit.MINUTES); 10 } 11 } 12 return order; 13} ä¼˜åŒ–ï¼š\n1// ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ 2@Autowired 3private BloomFilter\u0026lt;Long\u0026gt; orderBloomFilter; 4 5public Order getOrder(Long orderId) { 6 // å…ˆæ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨ 7 if (!orderBloomFilter.mightContain(orderId)) { 8 return null; // è®¢å•ä¸å­˜åœ¨ 9 } 10 11 // æŸ¥è¯¢ç¼“å­˜ 12 Order order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 13 if (order == null) { 14 // ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿ 15 String lockKey = \u0026#34;lock:order:\u0026#34; + orderId; 16 if (redisTemplate.opsForValue().setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS)) { 17 try { 18 // å†æ¬¡æ£€æŸ¥ç¼“å­˜ 19 order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 20 if (order == null) { 21 // æŸ¥è¯¢æ•°æ®åº“ 22 order = orderMapper.selectById(orderId); 23 if (order != null) { 24 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, order, 30, TimeUnit.MINUTES); 25 } else { 26 // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç©¿é€ 27 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, new Order(), 5, TimeUnit.MINUTES); 28 } 29 } 30 } finally { 31 redisTemplate.delete(lockKey); 32 } 33 } 34 } 35 return order; 36} æ¡ˆä¾‹ä¸‰ï¼šçº¿ç¨‹æ± æ»¡ é—®é¢˜ï¼šçº¿ç¨‹æ± é˜Ÿåˆ—æ»¡ï¼Œè¯·æ±‚è¢«æ‹’ç»\nåˆ†æï¼š\n1// åŸé…ç½® 2@Bean 3public ThreadPoolExecutor executor() { 4 return new ThreadPoolExecutor( 5 10, // æ ¸å¿ƒçº¿ç¨‹æ•° 6 20, // æœ€å¤§çº¿ç¨‹æ•° 7 60L, TimeUnit.SECONDS, 8 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), // é˜Ÿåˆ—å®¹é‡ 100 9 new ThreadPoolExecutor.AbortPolicy() // æ‹’ç»ç­–ç•¥ï¼šæŠ›å¼‚å¸¸ 10 ); 11} ä¼˜åŒ–ï¼š\n1@Bean 2public ThreadPoolExecutor executor() { 3 return new ThreadPoolExecutor( 4 50, // å¢åŠ æ ¸å¿ƒçº¿ç¨‹æ•° 5 100, // å¢åŠ æœ€å¤§çº¿ç¨‹æ•° 6 60L, TimeUnit.SECONDS, 7 new LinkedBlockingQueue\u0026lt;\u0026gt;(1000), // å¢åŠ é˜Ÿåˆ—å®¹é‡ 8 new ThreadFactoryBuilder() 9 .setNameFormat(\u0026#34;business-thread-%d\u0026#34;) 10 .build(), 11 new ThreadPoolExecutor.CallerRunsPolicy() // æ”¹ä¸ºè°ƒç”¨è€…è¿è¡Œç­–ç•¥ 12 ); 13} 14 15// æ·»åŠ ç›‘æ§ 16@Scheduled(fixedRate = 5000) 17public void monitorThreadPool() { 18 ThreadPoolExecutor executor = (ThreadPoolExecutor) this.executor; 19 log.info(\u0026#34;çº¿ç¨‹æ± çŠ¶æ€ - æ´»è·ƒçº¿ç¨‹ï¼š{}ï¼Œé˜Ÿåˆ—å¤§å°ï¼š{}ï¼Œå®Œæˆä»»åŠ¡ï¼š{}\u0026#34;, 20 executor.getActiveCount(), 21 executor.getQueue().size(), 22 executor.getCompletedTaskCount()); 23} å‹æµ‹æµç¨‹ 1. å‡†å¤‡é˜¶æ®µ ç¡®å®šå‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡† å‡†å¤‡å‹æµ‹ç¯å¢ƒå’Œæ•°æ® é…ç½®æµé‡æ ‡è®°å’Œæ•°æ®éš”ç¦» ç¼–å†™å‹æµ‹è„šæœ¬ æ­å»ºç›‘æ§ç³»ç»Ÿ 2. é¢„æ¼”é˜¶æ®µ å°æµé‡å‹æµ‹ï¼ˆ10% ç›®æ ‡æµé‡ï¼‰ éªŒè¯æ•°æ®éš”ç¦»æ˜¯å¦ç”Ÿæ•ˆ æ£€æŸ¥ç›‘æ§æŒ‡æ ‡æ˜¯å¦æ­£å¸¸ ç¡®è®¤æ— çœŸå®ç”¨æˆ·å½±å“ 3. æ­£å¼å‹æµ‹ é€æ­¥å¢åŠ å‹åŠ›ï¼ˆæ¢¯åº¦å‹æµ‹ï¼‰ å®æ—¶ç›‘æ§ç³»ç»ŸæŒ‡æ ‡ è®°å½•æ€§èƒ½ç“¶é¢ˆ è¾¾åˆ°ç›®æ ‡åæŒç»­ 10-30 åˆ†é’Ÿ 4. åˆ†æé˜¶æ®µ æ±‡æ€»å‹æµ‹æ•°æ® åˆ†ææ€§èƒ½ç“¶é¢ˆ åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ è¯„ä¼°å®¹é‡è§„åˆ’ 5. ä¼˜åŒ–é˜¶æ®µ å®æ–½ä¼˜åŒ–æ–¹æ¡ˆ å›å½’å‹æµ‹éªŒè¯ æŒç»­è¿­ä»£ä¼˜åŒ– æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼š\nå‹æµ‹ä»·å€¼ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ç³»ç»ŸçœŸå®æ‰¿è½½èƒ½åŠ› æ–¹æ¡ˆè®¾è®¡ï¼šç›®æ ‡è®¾å®šã€æµé‡æ¨¡å‹ã€æ•°æ®éš”ç¦» æµé‡æ ‡è®°ï¼šè¯·æ±‚æ ‡è®°ã€æ•°æ®è·¯ç”±ã€è¡¨ååˆ‡æ¢ å·¥å…·é€‰å‹ï¼šJMeterã€Gatlingã€é˜¿é‡Œäº‘ PTS ç›‘æ§åˆ†æï¼šåº”ç”¨ç›‘æ§ã€ç³»ç»Ÿç›‘æ§ã€æ•°æ®åº“ç›‘æ§ æ€§èƒ½ä¼˜åŒ–ï¼šæ…¢æŸ¥è¯¢ã€ç¼“å­˜ç©¿é€ã€çº¿ç¨‹æ±  å‹æµ‹æµç¨‹ï¼šå‡†å¤‡ã€é¢„æ¼”ã€æ­£å¼ã€åˆ†æã€ä¼˜åŒ– åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå…¨é“¾è·¯å‹æµ‹æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦ï¼š\nå®šæœŸå‹æµ‹ï¼šæ¯æ¬¡å¤§ä¿ƒå‰ã€é‡å¤§åŠŸèƒ½ä¸Šçº¿å‰ æŒç»­ä¼˜åŒ–ï¼šæ ¹æ®å‹æµ‹ç»“æœä¸æ–­ä¼˜åŒ– å®¹é‡è§„åˆ’ï¼šä¸ºä¸šåŠ¡å¢é•¿é¢„ç•™èµ„æº åº”æ€¥é¢„æ¡ˆï¼šåˆ¶å®šé™çº§ã€é™æµã€ç†”æ–­ç­–ç•¥ ä¸‹æ¬¡å½“ä½ éœ€è¦éªŒè¯ç³»ç»Ÿæ‰¿è½½èƒ½åŠ›æ—¶ï¼Œä¸å¦¨è¯•è¯•å…¨é“¾è·¯å‹æµ‹è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ã€‚\n","permalink":"http://localhost:1313/posts/2025/09/%E5%85%A8%E9%93%BE%E8%B7%AF%E5%8E%8B%E6%B5%8B%E5%A6%82%E4%BD%95%E9%AA%8C%E8%AF%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%9C%9F%E5%AE%9E%E6%89%BF%E8%BD%BD%E8%83%BD%E5%8A%9B/","summary":"\u003cp\u003eåœ¨å¤§ä¿ƒã€ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œç³»ç»Ÿèƒ½å¦æ‰›ä½æµé‡å†²å‡»æ˜¯æ¯ä¸ªæŠ€æœ¯å›¢é˜Ÿæœ€å…³å¿ƒçš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„å•æ¥å£å‹æµ‹æ— æ³•çœŸå®åæ˜ ç³»ç»Ÿçš„æ•´ä½“æ‰¿è½½èƒ½åŠ›ï¼Œè€Œå…¨é“¾è·¯å‹æµ‹é€šè¿‡æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºï¼Œå¯ä»¥å…¨é¢éªŒè¯ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†æ·±å…¥è®²è§£å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºå®Œæ•´çš„å‹æµ‹ä½“ç³»ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å…¨é“¾è·¯å‹æµ‹çš„æ ¸å¿ƒä»·å€¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å‹æµ‹ç¯å¢ƒçš„æ­å»ºæ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šæ•°æ®éš”ç¦»ä¸æµé‡æ ‡è®°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å‹æµ‹å·¥å…·çš„é€‰å‹ä¸ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ€§èƒ½ç“¶é¢ˆçš„åˆ†æä¸ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹\"\u003eä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹\u003c/h2\u003e\n\u003ch3 id=\"ä¼ ç»Ÿå‹æµ‹-vs-å…¨é“¾è·¯å‹æµ‹\"\u003eä¼ ç»Ÿå‹æµ‹ vs å…¨é“¾è·¯å‹æµ‹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿå‹æµ‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé’ˆå¯¹å•ä¸ªæ¥å£æˆ–æœåŠ¡è¿›è¡Œå‹æµ‹\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨æµ‹è¯•ç¯å¢ƒæˆ–é¢„å‘å¸ƒç¯å¢ƒ\u003c/li\u003e\n\u003cli\u003eæ•°æ®é‡å°ï¼Œæ— æ³•åæ˜ çœŸå®æƒ…å†µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå…¨é“¾è·¯å‹æµ‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå‹æµ‹\u003c/li\u003e\n\u003cli\u003eæ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„å®Œæ•´ä¸šåŠ¡æµç¨‹\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨çœŸå®çš„æ•°æ®é‡å’Œç³»ç»Ÿé…ç½®\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"å…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼\"\u003eå…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eçœŸå®æ€§\u003c/strong\u003eï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œç»“æœæœ€å¯ä¿¡\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå…¨é¢æ€§\u003c/strong\u003eï¼šè¦†ç›–æ‰€æœ‰ç³»ç»Ÿç»„ä»¶å’Œä¾èµ–\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåŠæ—¶æ€§\u003c/strong\u003eï¼šæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæŒ‡å¯¼æ€§\u003c/strong\u003eï¼šä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æŒ\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"å‹æµ‹åœºæ™¯\"\u003eå‹æµ‹åœºæ™¯\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eç”¨æˆ·è®¿é—® â†’ ç½‘å…³ â†’ åº”ç”¨æœåŠ¡ â†’ ç¼“å­˜ â†’ æ•°æ®åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e                â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e            æ¶ˆæ¯é˜Ÿåˆ— â†’ å¼‚æ­¥æœåŠ¡\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e                â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e            ç¬¬ä¸‰æ–¹æœåŠ¡\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e å…¨é“¾è·¯å‹æµ‹ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯ä¸šåŠ¡é—®é¢˜ã€‚éœ€è¦äº§å“ã€è¿è¥ã€æŠ€æœ¯å›¢é˜Ÿå…±åŒå‚ä¸ï¼Œåˆ¶å®šåˆç†çš„å‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡†ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"å‹æµ‹æ–¹æ¡ˆè®¾è®¡\"\u003eå‹æµ‹æ–¹æ¡ˆè®¾è®¡\u003c/h2\u003e\n\u003ch3 id=\"1-å‹æµ‹ç›®æ ‡è®¾å®š\"\u003e1. å‹æµ‹ç›®æ ‡è®¾å®š\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæ€§èƒ½æŒ‡æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eTPS/QPS\u003c/strong\u003eï¼šæ¯ç§’äº‹åŠ¡æ•°/æŸ¥è¯¢æ•°\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå“åº”æ—¶é—´\u003c/strong\u003eï¼šP50ã€P95ã€P99\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæˆåŠŸç‡\u003c/strong\u003eï¼šè¯·æ±‚æˆåŠŸçš„æ¯”ä¾‹\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eèµ„æºä½¿ç”¨ç‡\u003c/strong\u003eï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡æŒ‡æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eè®¢å•åˆ›å»ºæˆåŠŸç‡\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ”¯ä»˜æˆåŠŸç‡\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåº“å­˜æ‰£å‡å‡†ç¡®æ€§\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eç¤ºä¾‹ç›®æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå¤§ä¿ƒåœºæ™¯ï¼š\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e- å³°å€¼ TPSï¼š10000\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e- P99 å“åº”æ—¶é—´ï¼š\u0026lt; 500ms\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e- æˆåŠŸç‡ï¼š\u0026gt; 99.9%\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e- CPU ä½¿ç”¨ç‡ï¼š\u0026lt; 70%\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"2-å‹æµ‹æµé‡æ¨¡å‹\"\u003e2. å‹æµ‹æµé‡æ¨¡å‹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæµé‡ç‰¹å¾\u003c/strong\u003eï¼š\u003c/p\u003e","title":"å…¨é“¾è·¯å‹æµ‹ï¼šå¦‚ä½•éªŒè¯ç³»ç»Ÿçš„çœŸå®æ‰¿è½½èƒ½åŠ›"},{"content":"Git å·²ç»æˆä¸ºç°ä»£è½¯ä»¶å¼€å‘çš„æ ‡å‡†ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚ç„¶è€Œï¼Œä»…ä»…ä¼šç”¨ Git å‘½ä»¤æ˜¯ä¸å¤Ÿçš„ï¼Œå¦‚ä½•åœ¨å›¢é˜Ÿä¸­å»ºç«‹é«˜æ•ˆçš„ Git å·¥ä½œæµï¼Œæ‰æ˜¯æå‡å¼€å‘æ•ˆç‡çš„å…³é”®ã€‚\næœ¬æ–‡å°†ä»å®é™…å›¢é˜Ÿåä½œå‡ºå‘ï¼Œæ·±å…¥è®²è§£ Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ å’Œå›¢é˜Ÿå»ºç«‹è§„èŒƒã€é«˜æ•ˆçš„å¼€å‘æµç¨‹ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ä¸»æµ Git å·¥ä½œæµæ¨¡å‹ æŒæ¡åˆ†æ”¯ç®¡ç†çš„æœ€ä½³å®è·µ å­¦ä¼šè§„èŒƒçš„æäº¤ä¿¡æ¯ç¼–å†™ äº†è§£ä»£ç å®¡æŸ¥çš„æµç¨‹ä¸æŠ€å·§ æŒæ¡å†²çªè§£å†³ä¸å›æ»šç­–ç•¥ ä¸»æµ Git å·¥ä½œæµæ¨¡å‹ 1. Git Flow æœ€ç»å…¸çš„åˆ†æ”¯æ¨¡å‹ï¼Œé€‚åˆç‰ˆæœ¬å‘å¸ƒå‘¨æœŸè¾ƒé•¿çš„é¡¹ç›®ï¼š\n1master (ç”Ÿäº§ç¯å¢ƒ) 2 â†“ 3develop (å¼€å‘ç¯å¢ƒ) 4 â†“ 5feature/* (åŠŸèƒ½åˆ†æ”¯) 6release/* (å‘å¸ƒåˆ†æ”¯) 7hotfix/* (çƒ­ä¿®å¤åˆ†æ”¯) åˆ†æ”¯è¯´æ˜ï¼š\nmasterï¼šç”Ÿäº§ç¯å¢ƒä»£ç ï¼Œæ¯ä¸ªæäº¤éƒ½æ˜¯ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬ developï¼šå¼€å‘ç¯å¢ƒä»£ç ï¼Œé›†æˆæ‰€æœ‰åŠŸèƒ½ feature/*ï¼šåŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œå®Œæˆååˆå¹¶å› develop release/*ï¼šå‘å¸ƒå‡†å¤‡åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œæµ‹è¯•é€šè¿‡ååˆå¹¶åˆ° master å’Œ develop hotfix/*ï¼šç´§æ€¥ä¿®å¤åˆ†æ”¯ï¼Œä» master åˆ†å‡ºï¼Œä¿®å¤ååˆå¹¶åˆ° master å’Œ develop å·¥ä½œæµç¨‹ï¼š\n1# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ 2git checkout -b feature/user-login develop 3 4# 2. å¼€å‘åŠŸèƒ½ 5git add . 6git commit -m \u0026#34;feat: å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34; 7 8# 3. åˆå¹¶åˆ° develop 9git checkout develop 10git merge --no-ff feature/user-login 11git branch -d feature/user-login 12 13# 4. åˆ›å»ºå‘å¸ƒåˆ†æ”¯ 14git checkout -b release/1.0.0 develop 15 16# 5. å‘å¸ƒåˆ°ç”Ÿäº§ 17git checkout master 18git merge --no-ff release/1.0.0 19git tag -a v1.0.0 -m \u0026#34;Release version 1.0.0\u0026#34; 20 21# 6. åˆå¹¶å› develop 22git checkout develop 23git merge --no-ff release/1.0.0 24git branch -d release/1.0.0 2. GitHub Flow ç®€åŒ–ç‰ˆå·¥ä½œæµï¼Œé€‚åˆæŒç»­éƒ¨ç½²çš„é¡¹ç›®ï¼š\n1master (ç”Ÿäº§ç¯å¢ƒ) 2 â†“ 3feature/* (åŠŸèƒ½åˆ†æ”¯) å·¥ä½œæµç¨‹ï¼š\n1# 1. ä» master åˆ›å»ºåˆ†æ”¯ 2git checkout -b feature/add-payment master 3 4# 2. å¼€å‘å¹¶æäº¤ 5git add . 6git commit -m \u0026#34;feat: æ·»åŠ æ”¯ä»˜åŠŸèƒ½\u0026#34; 7 8# 3. æ¨é€åˆ°è¿œç¨‹ 9git push origin feature/add-payment 10 11# 4. åˆ›å»º Pull Request 12# åœ¨ GitHub ä¸Šåˆ›å»º PRï¼Œè¿›è¡Œä»£ç å®¡æŸ¥ 13 14# 5. åˆå¹¶åˆ° master 15# å®¡æŸ¥é€šè¿‡åï¼Œåœ¨ GitHub ä¸Šåˆå¹¶ PR 16 17# 6. éƒ¨ç½²åˆ°ç”Ÿäº§ 18# CI/CD è‡ªåŠ¨éƒ¨ç½² 3. GitLab Flow ç»“åˆäº† Git Flow å’Œ GitHub Flow çš„ä¼˜ç‚¹ï¼š\n1master (å¼€å‘ç¯å¢ƒ) 2 â†“ 3pre-production (é¢„å‘å¸ƒç¯å¢ƒ) 4 â†“ 5production (ç”Ÿäº§ç¯å¢ƒ) ç‰¹ç‚¹ï¼š\nä»¥ç¯å¢ƒä¸ºå¯¼å‘çš„åˆ†æ”¯ç­–ç•¥ ä»£ç ä»ä¸Šæ¸¸ç¯å¢ƒæµå‘ä¸‹æ¸¸ç¯å¢ƒ é€‚åˆå¤šç¯å¢ƒéƒ¨ç½²çš„é¡¹ç›® å·¥ä½œæµå¯¹æ¯” å·¥ä½œæµ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ ä¼˜ç‚¹ ç¼ºç‚¹ Git Flow é«˜ ç‰ˆæœ¬å‘å¸ƒå‘¨æœŸé•¿ æµç¨‹æ¸…æ™°ï¼Œé€‚åˆå¤§å›¢é˜Ÿ åˆ†æ”¯å¤šï¼Œæ“ä½œå¤æ‚ GitHub Flow ä½ æŒç»­éƒ¨ç½² ç®€å•ï¼Œå¿«é€Ÿè¿­ä»£ ä¸é€‚åˆå¤šç‰ˆæœ¬ç»´æŠ¤ GitLab Flow ä¸­ å¤šç¯å¢ƒéƒ¨ç½² çµæ´»ï¼Œç¯å¢ƒéš”ç¦» éœ€è¦ CI/CD æ”¯æŒ æ¶æ„æ€è€ƒï¼š é€‰æ‹©å·¥ä½œæµæ—¶ï¼Œè¦è€ƒè™‘å›¢é˜Ÿè§„æ¨¡ã€å‘å¸ƒé¢‘ç‡ã€ç¯å¢ƒæ•°é‡ç­‰å› ç´ ã€‚å°å›¢é˜Ÿæˆ–å¿«é€Ÿè¿­ä»£çš„é¡¹ç›®ï¼Œæ¨è GitHub Flowï¼›å¤§å›¢é˜Ÿæˆ–éœ€è¦å¤šç‰ˆæœ¬ç»´æŠ¤çš„é¡¹ç›®ï¼Œæ¨è Git Flowã€‚\nåˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ åˆ†æ”¯å‘½åè§„èŒƒ 1# åŠŸèƒ½åˆ†æ”¯ 2feature/user-authentication 3feature/payment-integration 4 5# ä¿®å¤åˆ†æ”¯ 6bugfix/login-error 7bugfix/payment-timeout 8 9# çƒ­ä¿®å¤åˆ†æ”¯ 10hotfix/critical-security-issue 11 12# å‘å¸ƒåˆ†æ”¯ 13release/v1.2.0 14 15# æ–‡æ¡£åˆ†æ”¯ 16docs/api-documentation åˆ†æ”¯ä¿æŠ¤è§„åˆ™ åœ¨ GitHub/GitLab ä¸­è®¾ç½®åˆ†æ”¯ä¿æŠ¤ï¼š\nç¦æ­¢ç›´æ¥æ¨é€åˆ° master/main è¦æ±‚ Pull Request å®¡æŸ¥ï¼šè‡³å°‘ 1-2 äººå®¡æŸ¥ è¦æ±‚çŠ¶æ€æ£€æŸ¥é€šè¿‡ï¼šCI/CD æ„å»ºæˆåŠŸ è¦æ±‚åˆ†æ”¯æ˜¯æœ€æ–°çš„ï¼šåˆå¹¶å‰å¿…é¡» rebase è¦æ±‚ç­¾åæäº¤ï¼šä½¿ç”¨ GPG ç­¾å åˆ†æ”¯æ¸…ç† 1# æŸ¥çœ‹å·²åˆå¹¶çš„åˆ†æ”¯ 2git branch --merged 3 4# åˆ é™¤å·²åˆå¹¶çš„æœ¬åœ°åˆ†æ”¯ 5git branch -d feature/user-login 6 7# åˆ é™¤è¿œç¨‹åˆ†æ”¯ 8git push origin --delete feature/user-login 9 10# æ‰¹é‡åˆ é™¤å·²åˆå¹¶çš„æœ¬åœ°åˆ†æ”¯ 11git branch --merged | grep -v \u0026#34;\\*\u0026#34; | grep -v \u0026#34;master\u0026#34; | grep -v \u0026#34;develop\u0026#34; | xargs -n 1 git branch -d æäº¤ä¿¡æ¯è§„èŒƒ Conventional Commits éµå¾ªçº¦å®šå¼æäº¤è§„èŒƒï¼š\n1\u0026lt;type\u0026gt;(\u0026lt;scope\u0026gt;): \u0026lt;subject\u0026gt; 2 3\u0026lt;body\u0026gt; 4 5\u0026lt;footer\u0026gt; Type ç±»å‹ï¼š\nfeatï¼šæ–°åŠŸèƒ½ fixï¼šä¿®å¤ Bug docsï¼šæ–‡æ¡£å˜æ›´ styleï¼šä»£ç æ ¼å¼ï¼ˆä¸å½±å“ä»£ç è¿è¡Œï¼‰ refactorï¼šé‡æ„ï¼ˆæ—¢ä¸æ˜¯æ–°åŠŸèƒ½ä¹Ÿä¸æ˜¯ä¿®å¤ï¼‰ perfï¼šæ€§èƒ½ä¼˜åŒ– testï¼šæµ‹è¯•ç›¸å…³ choreï¼šæ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨ ç¤ºä¾‹ï¼š\n1# æ–°åŠŸèƒ½ 2git commit -m \u0026#34;feat(auth): æ·»åŠ  JWT è®¤è¯åŠŸèƒ½\u0026#34; 3 4# ä¿®å¤ Bug 5git commit -m \u0026#34;fix(payment): ä¿®å¤æ”¯ä»˜é‡‘é¢è®¡ç®—é”™è¯¯ 6 7æ”¯ä»˜é‡‘é¢åœ¨è®¡ç®—æŠ˜æ‰£æ—¶å‡ºç°ç²¾åº¦é—®é¢˜ï¼Œå¯¼è‡´å®é™…æ”¯ä»˜é‡‘é¢ä¸æ­£ç¡®ã€‚ 8æœ¬æ¬¡ä¿®å¤ä½¿ç”¨ BigDecimal è¿›è¡Œç²¾ç¡®è®¡ç®—ã€‚ 9 10Closes #123\u0026#34; 11 12# ç ´åæ€§å˜æ›´ 13git commit -m \u0026#34;feat(api): é‡æ„ç”¨æˆ· API æ¥å£ 14 15BREAKING CHANGE: ç”¨æˆ· API æ¥å£è·¯å¾„ä» /api/user æ”¹ä¸º /api/v2/users\u0026#34; æäº¤æœ€ä½³å®è·µ åŸå­æ€§æäº¤ï¼šæ¯æ¬¡æäº¤åªåšä¸€ä»¶äº‹ æœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯ï¼šæ¸…æ¥šæè¿°åšäº†ä»€ä¹ˆå’Œä¸ºä»€ä¹ˆ é¢‘ç¹æäº¤ï¼šå°æ­¥å¿«è·‘ï¼Œä¾¿äºå›æ»š æäº¤å‰æ£€æŸ¥ï¼šä½¿ç”¨ git diff æ£€æŸ¥å˜æ›´ 1# æŸ¥çœ‹æš‚å­˜åŒºçš„å˜æ›´ 2git diff --staged 3 4# äº¤äº’å¼æš‚å­˜ 5git add -p 6 7# ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤ 8git commit --amend 9 10# ä¿®æ”¹æäº¤ä¿¡æ¯ 11git commit --amend -m \u0026#34;æ–°çš„æäº¤ä¿¡æ¯\u0026#34; ä½¿ç”¨ Commitizen è‡ªåŠ¨ç”Ÿæˆè§„èŒƒçš„æäº¤ä¿¡æ¯ï¼š\n1# å®‰è£… 2npm install -g commitizen cz-conventional-changelog 3 4# åˆå§‹åŒ– 5commitizen init cz-conventional-changelog --save-dev --save-exact 6 7# ä½¿ç”¨ 8git cz ä»£ç å®¡æŸ¥æµç¨‹ Pull Request æ¨¡æ¿ åˆ›å»º .github/pull_request_template.mdï¼š\n1## å˜æ›´è¯´æ˜ 2\u0026lt;!-- ç®€è¦æè¿°æœ¬æ¬¡å˜æ›´çš„å†…å®¹ --\u0026gt; 3 4## å˜æ›´ç±»å‹ 5- [ ] æ–°åŠŸèƒ½ 6- [ ] Bug ä¿®å¤ 7- [ ] é‡æ„ 8- [ ] æ–‡æ¡£æ›´æ–° 9- [ ] æ€§èƒ½ä¼˜åŒ– 10 11## ç›¸å…³ Issue 12\u0026lt;!-- å…³è”çš„ Issue ç¼–å·ï¼Œå¦‚ #123 --\u0026gt; 13 14## æµ‹è¯•è¯´æ˜ 15\u0026lt;!-- å¦‚ä½•æµ‹è¯•æœ¬æ¬¡å˜æ›´ --\u0026gt; 16 17## æˆªå›¾ï¼ˆå¦‚æœé€‚ç”¨ï¼‰ 18\u0026lt;!-- æ·»åŠ æˆªå›¾è¯´æ˜å˜æ›´æ•ˆæœ --\u0026gt; 19 20## æ£€æŸ¥æ¸…å• 21- [ ] ä»£ç éµå¾ªé¡¹ç›®è§„èŒƒ 22- [ ] å·²æ·»åŠ å¿…è¦çš„æµ‹è¯• 23- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ 24- [ ] å·²æ›´æ–°ç›¸å…³æ–‡æ¡£ 25- [ ] æ— æ–°å¢çš„ lint è­¦å‘Š ä»£ç å®¡æŸ¥è¦ç‚¹ åŠŸèƒ½æ€§ï¼š\nä»£ç æ˜¯å¦å®ç°äº†é¢„æœŸåŠŸèƒ½ æ˜¯å¦æœ‰é—æ¼çš„è¾¹ç•Œæƒ…å†µ é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„ å¯è¯»æ€§ï¼š\nå‘½åæ˜¯å¦æ¸…æ™° é€»è¾‘æ˜¯å¦æ˜“æ‡‚ æ˜¯å¦æœ‰å¿…è¦çš„æ³¨é‡Š æ€§èƒ½ï¼š\næ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜ æ•°æ®åº“æŸ¥è¯¢æ˜¯å¦ä¼˜åŒ– æ˜¯å¦æœ‰å†…å­˜æ³„æ¼é£é™© å®‰å…¨æ€§ï¼š\næ˜¯å¦æœ‰å®‰å…¨æ¼æ´ è¾“å…¥éªŒè¯æ˜¯å¦å……åˆ† æ•æ„Ÿä¿¡æ¯æ˜¯å¦æ³„éœ² å¯ç»´æŠ¤æ€§ï¼š\nä»£ç æ˜¯å¦ç¬¦åˆ SOLID åŸåˆ™ æ˜¯å¦æœ‰é‡å¤ä»£ç  æ˜¯å¦æ˜“äºæµ‹è¯• å®¡æŸ¥åé¦ˆæŠ€å·§ å¥½çš„åé¦ˆï¼š\n1å»ºè®®ï¼šè¿™é‡Œå¯ä»¥ä½¿ç”¨ Stream API ç®€åŒ–ä»£ç ï¼Œæé«˜å¯è¯»æ€§ã€‚ 2 3Optional\u0026lt;User\u0026gt; user = users.stream() 4 .filter(u -\u0026gt; u.getId().equals(userId)) 5 .findFirst(); ä¸å¥½çš„åé¦ˆï¼š\n1è¿™æ®µä»£ç å†™å¾—å¤ªçƒ‚äº†ï¼Œé‡å†™å§ã€‚ åŸåˆ™ï¼š\nå¯¹äº‹ä¸å¯¹äºº æä¾›å…·ä½“å»ºè®® è§£é‡ŠåŸå›  ä¿æŒå‹å¥½ å†²çªè§£å†³ é¢„é˜²å†²çª é¢‘ç¹åŒæ­¥ï¼šå®šæœŸä»ä¸»åˆ†æ”¯æ‹‰å–æœ€æ–°ä»£ç  å°æ­¥æäº¤ï¼šå‡å°‘å•æ¬¡å˜æ›´çš„èŒƒå›´ æ¨¡å—åŒ–å¼€å‘ï¼šå‡å°‘å¤šäººä¿®æ”¹åŒä¸€æ–‡ä»¶ 1# å®šæœŸåŒæ­¥ä¸»åˆ†æ”¯ 2git checkout feature/my-feature 3git fetch origin 4git rebase origin/develop è§£å†³å†²çª 1# 1. æ‹‰å–æœ€æ–°ä»£ç  2git fetch origin 3 4# 2. Rebase åˆ°æœ€æ–°çš„ develop 5git rebase origin/develop 6 7# 3. å¦‚æœæœ‰å†²çªï¼ŒGit ä¼šæç¤º 8# æ‰‹åŠ¨è§£å†³å†²çªåï¼š 9git add \u0026lt;å†²çªæ–‡ä»¶\u0026gt; 10git rebase --continue 11 12# 4. å¦‚æœæƒ³æ”¾å¼ƒ rebase 13git rebase --abort Merge vs Rebase Mergeï¼š\n1git checkout develop 2git merge feature/my-feature ä¼˜ç‚¹ï¼šä¿ç•™å®Œæ•´çš„å†å²è®°å½• ç¼ºç‚¹ï¼šäº§ç”Ÿé¢å¤–çš„åˆå¹¶æäº¤ï¼Œå†å²è®°å½•å¤æ‚\nRebaseï¼š\n1git checkout feature/my-feature 2git rebase develop ä¼˜ç‚¹ï¼šä¿æŒçº¿æ€§çš„å†å²è®°å½•ï¼Œæ›´æ¸…æ™° ç¼ºç‚¹ï¼šæ”¹å†™å†å²ï¼Œä¸é€‚åˆå·²æ¨é€çš„åˆ†æ”¯\næ¨èç­–ç•¥ï¼š\nåŠŸèƒ½åˆ†æ”¯å¼€å‘æ—¶ä½¿ç”¨ rebase ä¿æŒåŒæ­¥ åˆå¹¶åˆ°ä¸»åˆ†æ”¯æ—¶ä½¿ç”¨ merge ä¿ç•™å†å² é¿å‘æç¤ºï¼š æ°¸è¿œä¸è¦ rebase å·²ç»æ¨é€åˆ°è¿œç¨‹çš„å…¬å…±åˆ†æ”¯ï¼è¿™ä¼šå¯¼è‡´å…¶ä»–äººçš„å†å²è®°å½•æ··ä¹±ã€‚åªåœ¨æœ¬åœ°åˆ†æ”¯æˆ–ä¸ªäººåˆ†æ”¯ä¸Šä½¿ç”¨ rebaseã€‚\nå›æ»šç­–ç•¥ æ’¤é”€æœ¬åœ°ä¿®æ”¹ 1# æ’¤é”€å·¥ä½œåŒºçš„ä¿®æ”¹ 2git checkout -- \u0026lt;file\u0026gt; 3 4# æ’¤é”€æš‚å­˜åŒºçš„ä¿®æ”¹ 5git reset HEAD \u0026lt;file\u0026gt; 6 7# æ’¤é”€æœ€åä¸€æ¬¡æäº¤ï¼ˆä¿ç•™ä¿®æ”¹ï¼‰ 8git reset --soft HEAD^ 9 10# æ’¤é”€æœ€åä¸€æ¬¡æäº¤ï¼ˆä¸¢å¼ƒä¿®æ”¹ï¼‰ 11git reset --hard HEAD^ æ’¤é”€å·²æ¨é€çš„æäº¤ 1# æ–¹æ³• 1ï¼šRevertï¼ˆæ¨èï¼‰ 2# åˆ›å»ºä¸€ä¸ªæ–°æäº¤æ¥æ’¤é”€ä¹‹å‰çš„æäº¤ 3git revert \u0026lt;commit-hash\u0026gt; 4git push origin master 5 6# æ–¹æ³• 2ï¼šReset + Force Pushï¼ˆå±é™©ï¼‰ 7# åªåœ¨ä¸ªäººåˆ†æ”¯æˆ–ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨ 8git reset --hard \u0026lt;commit-hash\u0026gt; 9git push origin master --force æ¢å¤å·²åˆ é™¤çš„åˆ†æ”¯ 1# æŸ¥çœ‹æ‰€æœ‰æ“ä½œè®°å½• 2git reflog 3 4# æ¢å¤åˆ†æ”¯ 5git checkout -b \u0026lt;branch-name\u0026gt; \u0026lt;commit-hash\u0026gt; ç´§æ€¥å›æ»šç”Ÿäº§ç¯å¢ƒ 1# 1. åˆ›å»º hotfix åˆ†æ”¯ 2git checkout -b hotfix/rollback-v1.2.0 master 3 4# 2. å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ 5git revert \u0026lt;bad-commit-hash\u0026gt; 6 7# 3. æ¨é€å¹¶éƒ¨ç½² 8git push origin hotfix/rollback-v1.2.0 9 10# 4. åˆå¹¶åˆ° master 11git checkout master 12git merge hotfix/rollback-v1.2.0 13git tag -a v1.2.1 -m \u0026#34;Rollback to stable version\u0026#34; 14git push origin master --tags Git Hooks è‡ªåŠ¨åŒ– Pre-commit Hook åœ¨æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ä»£ç ï¼š\n1# .git/hooks/pre-commit 2 3#!/bin/sh 4 5# è¿è¡Œ lint æ£€æŸ¥ 6npm run lint 7if [ $? -ne 0 ]; then 8 echo \u0026#34;Lint æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤\u0026#34; 9 exit 1 10fi 11 12# è¿è¡Œå•å…ƒæµ‹è¯• 13npm run test 14if [ $? -ne 0 ]; then 15 echo \u0026#34;å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤\u0026#34; 16 exit 1 17fi 18 19echo \u0026#34;æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸æäº¤\u0026#34; 20exit 0 Commit-msg Hook æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ï¼š\n1# .git/hooks/commit-msg 2 3#!/bin/sh 4 5commit_msg=$(cat $1) 6 7# æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ 8if ! echo \u0026#34;$commit_msg\u0026#34; | grep -qE \u0026#34;^(feat|fix|docs|style|refactor|perf|test|chore)(\\(.+\\))?: .{1,50}\u0026#34;; then 9 echo \u0026#34;é”™è¯¯ï¼šæäº¤ä¿¡æ¯ä¸ç¬¦åˆè§„èŒƒ\u0026#34; 10 echo \u0026#34;æ ¼å¼ï¼š\u0026lt;type\u0026gt;(\u0026lt;scope\u0026gt;): \u0026lt;subject\u0026gt;\u0026#34; 11 echo \u0026#34;ç¤ºä¾‹ï¼šfeat(auth): æ·»åŠ ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34; 12 exit 1 13fi 14 15exit 0 ä½¿ç”¨ Husky æ›´æ–¹ä¾¿åœ°ç®¡ç† Git Hooksï¼š\n1# å®‰è£… 2npm install husky --save-dev 3 4# åˆå§‹åŒ– 5npx husky install 6 7# æ·»åŠ  pre-commit hook 8npx husky add .husky/pre-commit \u0026#34;npm run lint \u0026amp;\u0026amp; npm run test\u0026#34; 9 10# æ·»åŠ  commit-msg hook 11npx husky add .husky/commit-msg \u0026#39;npx --no -- commitlint --edit \u0026#34;$1\u0026#34;\u0026#39; å›¢é˜Ÿåä½œæŠ€å·§ 1. ä»£ç æ‰€æœ‰æƒ ä½¿ç”¨ CODEOWNERS æ–‡ä»¶ï¼š\n1# .github/CODEOWNERS 2 3# é»˜è®¤æ‰€æœ‰è€… 4* @team-lead 5 6# å‰ç«¯ä»£ç  7/frontend/** @frontend-team 8 9# åç«¯ä»£ç  10/backend/** @backend-team 11 12# æ•°æ®åº“è¿ç§» 13/migrations/** @dba-team @backend-lead 14 15# æ–‡æ¡£ 16/docs/** @tech-writer 2. Issue æ¨¡æ¿ åˆ›å»º .github/ISSUE_TEMPLATE/bug_report.mdï¼š\n1--- 2name: Bug æŠ¥å‘Š 3about: åˆ›å»º Bug æŠ¥å‘Šå¸®åŠ©æˆ‘ä»¬æ”¹è¿› 4title: \u0026#39;[BUG] \u0026#39; 5labels: bug 6assignees: \u0026#39;\u0026#39; 7--- 8 9## Bug æè¿° 10\u0026lt;!-- æ¸…æ™°ç®€æ´åœ°æè¿° Bug --\u0026gt; 11 12## å¤ç°æ­¥éª¤ 131. è®¿é—® \u0026#39;...\u0026#39; 142. ç‚¹å‡» \u0026#39;...\u0026#39; 153. æ»šåŠ¨åˆ° \u0026#39;...\u0026#39; 164. çœ‹åˆ°é”™è¯¯ 17 18## é¢„æœŸè¡Œä¸º 19\u0026lt;!-- æè¿°ä½ æœŸæœ›å‘ç”Ÿä»€ä¹ˆ --\u0026gt; 20 21## å®é™…è¡Œä¸º 22\u0026lt;!-- æè¿°å®é™…å‘ç”Ÿäº†ä»€ä¹ˆ --\u0026gt; 23 24## æˆªå›¾ 25\u0026lt;!-- å¦‚æœé€‚ç”¨ï¼Œæ·»åŠ æˆªå›¾ --\u0026gt; 26 27## ç¯å¢ƒä¿¡æ¯ 28- OS: [e.g. macOS 12.0] 29- Browser: [e.g. Chrome 96] 30- Version: [e.g. 1.2.0] 3. å‘å¸ƒæµç¨‹ 1# 1. æ›´æ–°ç‰ˆæœ¬å· 2npm version patch # 1.0.0 -\u0026gt; 1.0.1 3npm version minor # 1.0.0 -\u0026gt; 1.1.0 4npm version major # 1.0.0 -\u0026gt; 2.0.0 5 6# 2. ç”Ÿæˆ CHANGELOG 7npx conventional-changelog -p angular -i CHANGELOG.md -s 8 9# 3. æäº¤å¹¶æ‰“æ ‡ç­¾ 10git add . 11git commit -m \u0026#34;chore(release): v1.2.0\u0026#34; 12git tag -a v1.2.0 -m \u0026#34;Release version 1.2.0\u0026#34; 13 14# 4. æ¨é€ 15git push origin develop --tags æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº† Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œä»å·¥ä½œæµæ¨¡å‹åˆ°å›¢é˜Ÿåä½œï¼š\nå·¥ä½œæµæ¨¡å‹ï¼šGit Flowã€GitHub Flowã€GitLab Flow çš„é€‰æ‹© åˆ†æ”¯ç®¡ç†ï¼šå‘½åè§„èŒƒã€ä¿æŠ¤è§„åˆ™ã€æ¸…ç†ç­–ç•¥ æäº¤è§„èŒƒï¼šConventional Commitsã€åŸå­æ€§æäº¤ ä»£ç å®¡æŸ¥ï¼šPR æ¨¡æ¿ã€å®¡æŸ¥è¦ç‚¹ã€åé¦ˆæŠ€å·§ å†²çªè§£å†³ï¼šé¢„é˜²ç­–ç•¥ã€Merge vs Rebase å›æ»šç­–ç•¥ï¼šæœ¬åœ°æ’¤é”€ã€è¿œç¨‹å›æ»šã€ç´§æ€¥å¤„ç† è‡ªåŠ¨åŒ–ï¼šGit Hooksã€Husky å›¢é˜Ÿåä½œï¼šCODEOWNERSã€Issue æ¨¡æ¿ã€å‘å¸ƒæµç¨‹ åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒGit å·¥ä½œæµä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œéœ€è¦æ ¹æ®å›¢é˜Ÿè§„æ¨¡ã€é¡¹ç›®ç‰¹ç‚¹ã€å‘å¸ƒé¢‘ç‡ç­‰å› ç´ çµæ´»è°ƒæ•´ã€‚å…³é”®æ˜¯å»ºç«‹è§„èŒƒã€ä¿æŒä¸€è‡´ã€æŒç»­æ”¹è¿›ã€‚\nä¸‹æ¬¡å½“ä½ åœ¨å›¢é˜Ÿä¸­æ¨å¹¿ Git æœ€ä½³å®è·µæ—¶ï¼Œä¸å¦¨ä»æœ¬æ–‡çš„å»ºè®®å¼€å§‹ï¼Œé€æ­¥å»ºç«‹é€‚åˆä½ ä»¬å›¢é˜Ÿçš„å·¥ä½œæµã€‚\n","permalink":"http://localhost:1313/posts/2025/07/git-%E5%B7%A5%E4%BD%9C%E6%B5%81%E4%BB%8E%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86%E5%88%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/","summary":"\u003cp\u003eGit å·²ç»æˆä¸ºç°ä»£è½¯ä»¶å¼€å‘çš„æ ‡å‡†ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚ç„¶è€Œï¼Œä»…ä»…ä¼šç”¨ Git å‘½ä»¤æ˜¯ä¸å¤Ÿçš„ï¼Œå¦‚ä½•åœ¨å›¢é˜Ÿä¸­å»ºç«‹é«˜æ•ˆçš„ Git å·¥ä½œæµï¼Œæ‰æ˜¯æå‡å¼€å‘æ•ˆç‡çš„å…³é”®ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…å›¢é˜Ÿåä½œå‡ºå‘ï¼Œæ·±å…¥è®²è§£ Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ å’Œå›¢é˜Ÿå»ºç«‹è§„èŒƒã€é«˜æ•ˆçš„å¼€å‘æµç¨‹ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¸»æµ Git å·¥ä½œæµæ¨¡å‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡åˆ†æ”¯ç®¡ç†çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§„èŒƒçš„æäº¤ä¿¡æ¯ç¼–å†™\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ä»£ç å®¡æŸ¥çš„æµç¨‹ä¸æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å†²çªè§£å†³ä¸å›æ»šç­–ç•¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸»æµ-git-å·¥ä½œæµæ¨¡å‹\"\u003eä¸»æµ Git å·¥ä½œæµæ¨¡å‹\u003c/h2\u003e\n\u003ch3 id=\"1-git-flow\"\u003e1. Git Flow\u003c/h3\u003e\n\u003cp\u003eæœ€ç»å…¸çš„åˆ†æ”¯æ¨¡å‹ï¼Œé€‚åˆç‰ˆæœ¬å‘å¸ƒå‘¨æœŸè¾ƒé•¿çš„é¡¹ç›®ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003emaster (ç”Ÿäº§ç¯å¢ƒ)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003edevelop (å¼€å‘ç¯å¢ƒ)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003efeature/* (åŠŸèƒ½åˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003erelease/* (å‘å¸ƒåˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003ehotfix/* (çƒ­ä¿®å¤åˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ†æ”¯è¯´æ˜\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003emaster\u003c/code\u003eï¼šç”Ÿäº§ç¯å¢ƒä»£ç ï¼Œæ¯ä¸ªæäº¤éƒ½æ˜¯ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edevelop\u003c/code\u003eï¼šå¼€å‘ç¯å¢ƒä»£ç ï¼Œé›†æˆæ‰€æœ‰åŠŸèƒ½\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003efeature/*\u003c/code\u003eï¼šåŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œå®Œæˆååˆå¹¶å› develop\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003erelease/*\u003c/code\u003eï¼šå‘å¸ƒå‡†å¤‡åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œæµ‹è¯•é€šè¿‡ååˆå¹¶åˆ° master å’Œ develop\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ehotfix/*\u003c/code\u003eï¼šç´§æ€¥ä¿®å¤åˆ†æ”¯ï¼Œä» master åˆ†å‡ºï¼Œä¿®å¤ååˆå¹¶åˆ° master å’Œ develop\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå·¥ä½œæµç¨‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout -b feature/user-login develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. å¼€å‘åŠŸèƒ½\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003egit add .\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003egit commit -m \u003cspan class=\"s2\"\u003e\u0026#34;feat: å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 3. åˆå¹¶åˆ° develop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff feature/user-login\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003egit branch -d feature/user-login\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 4. åˆ›å»ºå‘å¸ƒåˆ†æ”¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout -b release/1.0.0 develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 5. å‘å¸ƒåˆ°ç”Ÿäº§\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout master\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003egit tag -a v1.0.0 -m \u003cspan class=\"s2\"\u003e\u0026#34;Release version 1.0.0\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 6. åˆå¹¶å› develop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003egit branch -d release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"2-github-flow\"\u003e2. GitHub Flow\u003c/h3\u003e\n\u003cp\u003eç®€åŒ–ç‰ˆå·¥ä½œæµï¼Œé€‚åˆæŒç»­éƒ¨ç½²çš„é¡¹ç›®ï¼š\u003c/p\u003e","title":"Git å·¥ä½œæµï¼šä»åˆ†æ”¯ç®¡ç†åˆ°ä»£ç å®¡æŸ¥çš„æœ€ä½³å®è·µ"},{"content":"Nginx ä½œä¸ºé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå·²ç»æˆä¸ºäº’è”ç½‘æ¶æ„ä¸­çš„æ ‡é…ç»„ä»¶ã€‚æ— è®ºæ˜¯é™æ€èµ„æºæœåŠ¡ã€åå‘ä»£ç†è¿˜æ˜¯è´Ÿè½½å‡è¡¡ï¼ŒNginx éƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚\næœ¬æ–‡å°†ä»å®é™…åœºæ™¯å‡ºå‘ï¼Œæ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œå¸®åŠ©ä½ æ„å»ºé«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åå‘ä»£ç†ä¸æ­£å‘ä»£ç†çš„åŒºåˆ« æŒæ¡ Nginx è´Ÿè½½å‡è¡¡çš„å¤šç§ç­–ç•¥ å­¦ä¼šé…ç½®å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» äº†è§£ä¼šè¯ä¿æŒçš„å®ç°æ–¹æ¡ˆ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§ åå‘ä»£ç†åŸºç¡€ æ­£å‘ä»£ç† vs åå‘ä»£ç† æ­£å‘ä»£ç†ï¼šå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®\n1å®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨ 2ï¼ˆå®¢æˆ·ç«¯é…ç½®ä»£ç†ï¼‰ åå‘ä»£ç†ï¼šå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å†³å®šè½¬å‘åˆ°å“ªå°æœåŠ¡å™¨\n1å®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨é›†ç¾¤ 2ï¼ˆæœåŠ¡ç«¯é…ç½®ä»£ç†ï¼‰ åå‘ä»£ç†çš„ä¼˜åŠ¿ è´Ÿè½½å‡è¡¡ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨ éšè—çœŸå®æœåŠ¡å™¨ï¼šæé«˜å®‰å…¨æ€§ SSL å¸è½½ï¼šåœ¨ä»£ç†å±‚å¤„ç† HTTPS ç¼“å­˜é™æ€èµ„æºï¼šå‡è½»åç«¯å‹åŠ› ç»Ÿä¸€å…¥å£ï¼šä¾¿äºç®¡ç†å’Œç›‘æ§ æ¶æ„æ€è€ƒï¼š åå‘ä»£ç†ä¸ä»…æ˜¯æµé‡åˆ†å‘å™¨ï¼Œæ›´æ˜¯æ¶æ„ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•ã€æµé‡æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚\nNginx åå‘ä»£ç†é…ç½® åŸºç¡€é…ç½® 1# /etc/nginx/nginx.conf 2 3user nginx; 4worker_processes auto; # è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° 5error_log /var/log/nginx/error.log warn; 6pid /var/run/nginx.pid; 7 8events { 9 worker_connections 1024; # æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° 10 use epoll; # Linux ä¸‹ä½¿ç”¨ epoll 11} 12 13http { 14 include /etc/nginx/mime.types; 15 default_type application/octet-stream; 16 17 # æ—¥å¿—æ ¼å¼ 18 log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; \u0026#39; 19 \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#39; 20 \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34; \u0026#39; 21 \u0026#39;$request_time $upstream_response_time\u0026#39;; 22 23 access_log /var/log/nginx/access.log main; 24 25 sendfile on; 26 tcp_nopush on; 27 tcp_nodelay on; 28 keepalive_timeout 65; 29 types_hash_max_size 2048; 30 31 # åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶ 32 include /etc/nginx/conf.d/*.conf; 33} ç®€å•åå‘ä»£ç† 1# /etc/nginx/conf.d/api.conf 2 3server { 4 listen 80; 5 server_name api.example.com; 6 7 location / { 8 # ä»£ç†åˆ°åç«¯æœåŠ¡å™¨ 9 proxy_pass http://192.168.1.100:8080; 10 11 # è®¾ç½®è¯·æ±‚å¤´ 12 proxy_set_header Host $host; 13 proxy_set_header X-Real-IP $remote_addr; 14 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 15 proxy_set_header X-Forwarded-Proto $scheme; 16 17 # è¶…æ—¶è®¾ç½® 18 proxy_connect_timeout 60s; 19 proxy_send_timeout 60s; 20 proxy_read_timeout 60s; 21 } 22} è·¯å¾„é‡å†™ 1server { 2 listen 80; 3 server_name api.example.com; 4 5 # å°† /api/v1/users ä»£ç†åˆ° http://backend/users 6 location /api/v1/ { 7 proxy_pass http://backend/; # æ³¨æ„æœ«å°¾çš„ / 8 proxy_set_header Host $host; 9 } 10 11 # å°† /old-api é‡å†™ä¸º /new-api 12 location /old-api { 13 rewrite ^/old-api/(.*)$ /new-api/$1 break; 14 proxy_pass http://backend; 15 } 16} è´Ÿè½½å‡è¡¡ç­–ç•¥ 1. è½®è¯¢ï¼ˆRound Robinï¼‰ é»˜è®¤ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†é…è¯·æ±‚ï¼š\n1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5} 6 7server { 8 listen 80; 9 server_name api.example.com; 10 11 location / { 12 proxy_pass http://backend; 13 } 14} 2. åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰ æ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…ä¸åŒæƒé‡ï¼š\n1upstream backend { 2 server 192.168.1.101:8080 weight=3; # æƒé‡ 3 3 server 192.168.1.102:8080 weight=2; # æƒé‡ 2 4 server 192.168.1.103:8080 weight=1; # æƒé‡ 1 5} æƒé‡ä¸º 3:2:1ï¼Œæ„å‘³ç€æ¯ 6 ä¸ªè¯·æ±‚ä¸­ï¼Œ101 æœåŠ¡å™¨å¤„ç† 3 ä¸ªï¼Œ102 å¤„ç† 2 ä¸ªï¼Œ103 å¤„ç† 1 ä¸ªã€‚\n3. IP Hash æ ¹æ®å®¢æˆ·ç«¯ IP è¿›è¡Œå“ˆå¸Œï¼ŒåŒä¸€ IP çš„è¯·æ±‚æ€»æ˜¯åˆ†é…åˆ°åŒä¸€å°æœåŠ¡å™¨ï¼š\n1upstream backend { 2 ip_hash; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šéœ€è¦ä¼šè¯ä¿æŒçš„åº”ç”¨ï¼ˆå¦‚è´­ç‰©è½¦ã€ç™»å½•çŠ¶æ€ï¼‰\nç¼ºç‚¹ï¼š\nè´Ÿè½½å¯èƒ½ä¸å‡è¡¡ï¼ˆIP åˆ†å¸ƒä¸å‡ï¼‰ æ— æ³•åº”å¯¹æœåŠ¡å™¨æ•…éšœï¼ˆIP é‡æ–°å“ˆå¸Œï¼‰ 4. æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰ å°†è¯·æ±‚åˆ†é…ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ï¼š\n1upstream backend { 2 least_conn; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šè¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚è¾ƒå¤§çš„åº”ç”¨\n5. ä¸€è‡´æ€§å“ˆå¸Œï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ 1upstream backend { 2 hash $request_uri consistent; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šç¼“å­˜æœåŠ¡å™¨é›†ç¾¤\nè´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯” ç­–ç•¥ ä¼˜ç‚¹ ç¼ºç‚¹ é€‚ç”¨åœºæ™¯ è½®è¯¢ ç®€å•ã€å‡è¡¡ æ— ä¼šè¯ä¿æŒ æ— çŠ¶æ€æœåŠ¡ åŠ æƒè½®è¯¢ è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½ æ— ä¼šè¯ä¿æŒ æœåŠ¡å™¨æ€§èƒ½ä¸åŒ IP Hash ä¼šè¯ä¿æŒ è´Ÿè½½å¯èƒ½ä¸å‡ æœ‰çŠ¶æ€æœåŠ¡ æœ€å°‘è¿æ¥ åŠ¨æ€å‡è¡¡ è®¡ç®—å¼€é”€å¤§ é•¿è¿æ¥æœåŠ¡ ä¸€è‡´æ€§å“ˆå¸Œ ç¼“å­˜å‘½ä¸­ç‡é«˜ å®ç°å¤æ‚ ç¼“å­˜é›†ç¾¤ å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» è¢«åŠ¨å¥åº·æ£€æŸ¥ Nginx é»˜è®¤çš„å¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œå½“è¯·æ±‚å¤±è´¥æ—¶æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¯ç”¨ï¼š\n1upstream backend { 2 server 192.168.1.101:8080 max_fails=3 fail_timeout=30s; 3 server 192.168.1.102:8080 max_fails=3 fail_timeout=30s; 4 server 192.168.1.103:8080 max_fails=3 fail_timeout=30s; 5} å‚æ•°è¯´æ˜ï¼š\nmax_fails=3ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡åæ ‡è®°ä¸ºä¸å¯ç”¨ fail_timeout=30sï¼šæ ‡è®°ä¸ºä¸å¯ç”¨åï¼Œ30 ç§’å†…ä¸å†åˆ†é…è¯·æ±‚ ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆNginx Plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ ä½¿ç”¨ nginx_upstream_check_module æ¨¡å—ï¼š\n1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5 6 check interval=3000 rise=2 fall=3 timeout=1000 type=http; 7 check_http_send \u0026#34;HEAD /health HTTP/1.0\\r\\n\\r\\n\u0026#34;; 8 check_http_expect_alive http_2xx http_3xx; 9} 10 11server { 12 listen 80; 13 14 location /status { 15 check_status; 16 access_log off; 17 } 18} å‚æ•°è¯´æ˜ï¼š\ninterval=3000ï¼šæ¯ 3 ç§’æ£€æŸ¥ä¸€æ¬¡ rise=2ï¼šè¿ç»­æˆåŠŸ 2 æ¬¡æ ‡è®°ä¸ºå¯ç”¨ fall=3ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡æ ‡è®°ä¸ºä¸å¯ç”¨ timeout=1000ï¼šè¶…æ—¶æ—¶é—´ 1 ç§’ type=httpï¼šä½¿ç”¨ HTTP åè®®æ£€æŸ¥ å¤‡ç”¨æœåŠ¡å™¨ 1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5 server 192.168.1.104:8080 backup; # å¤‡ç”¨æœåŠ¡å™¨ 6} åªæœ‰å½“æ‰€æœ‰ä¸»æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶ï¼Œæ‰ä¼šä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨ã€‚\næ•…éšœè½¬ç§»é…ç½® 1location / { 2 proxy_pass http://backend; 3 proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504; 4 proxy_next_upstream_tries 2; # æœ€å¤šå°è¯• 2 æ¬¡ 5 proxy_next_upstream_timeout 10s; # æ€»è¶…æ—¶æ—¶é—´ 10 ç§’ 6} ä¼šè¯ä¿æŒæ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šIP Hash 1upstream backend { 2 ip_hash; 3 server 192.168.1.101:8080; 4 server 192.168.1.102:8080; 5} ä¼˜ç‚¹ï¼šé…ç½®ç®€å• ç¼ºç‚¹ï¼šè´Ÿè½½å¯èƒ½ä¸å‡è¡¡\næ–¹æ¡ˆäºŒï¼šCookie ç»‘å®š 1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 5 sticky cookie srv_id expires=1h domain=.example.com path=/; 6} Nginx ä¼šåœ¨å“åº”ä¸­è®¾ç½®ä¸€ä¸ª Cookieï¼Œåç»­è¯·æ±‚æ ¹æ® Cookie è·¯ç”±åˆ°åŒä¸€å°æœåŠ¡å™¨ã€‚\næ–¹æ¡ˆä¸‰ï¼šSession å…±äº«ï¼ˆæ¨èï¼‰ ä¸ä¾èµ– Nginxï¼Œåœ¨åº”ç”¨å±‚å®ç° Session å…±äº«ï¼š\nä½¿ç”¨ Redis å­˜å‚¨ Sessionï¼š\n1@Configuration 2@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800) 3public class SessionConfig { 4 5 @Bean 6 public LettuceConnectionFactory connectionFactory() { 7 return new LettuceConnectionFactory(); 8 } 9} ä½¿ç”¨ JWT Tokenï¼š\n1@RestController 2public class AuthController { 3 4 @PostMapping(\u0026#34;/login\u0026#34;) 5 public Result login(@RequestBody LoginRequest request) { 6 // éªŒè¯ç”¨æˆ·åå¯†ç  7 User user = userService.authenticate(request.getUsername(), request.getPassword()); 8 9 // ç”Ÿæˆ JWT Token 10 String token = JwtUtil.generateToken(user.getId()); 11 12 return Result.success(token); 13 } 14} æ¶æ„æ€è€ƒï¼š ä¼šè¯ä¿æŒçš„æœ€ä½³å®è·µæ˜¯åœ¨åº”ç”¨å±‚å®ç°æ— çŠ¶æ€åŒ–ã€‚é€šè¿‡ Redis å…±äº« Session æˆ–ä½¿ç”¨ JWT Tokenï¼Œå¯ä»¥å®ç°çœŸæ­£çš„æ°´å¹³æ‰©å±•ï¼Œè€Œä¸ä¾èµ–äºè´Ÿè½½å‡è¡¡å™¨çš„ç‰¹å®šåŠŸèƒ½ã€‚\nHTTPS é…ç½® SSL è¯ä¹¦é…ç½® 1server { 2 listen 443 ssl http2; 3 server_name api.example.com; 4 5 # SSL è¯ä¹¦ 6 ssl_certificate /etc/nginx/ssl/api.example.com.crt; 7 ssl_certificate_key /etc/nginx/ssl/api.example.com.key; 8 9 # SSL åè®®å’ŒåŠ å¯†å¥—ä»¶ 10 ssl_protocols TLSv1.2 TLSv1.3; 11 ssl_ciphers \u0026#39;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256\u0026#39;; 12 ssl_prefer_server_ciphers on; 13 14 # SSL ä¼šè¯ç¼“å­˜ 15 ssl_session_cache shared:SSL:10m; 16 ssl_session_timeout 10m; 17 18 # HSTS 19 add_header Strict-Transport-Security \u0026#34;max-age=31536000\u0026#34; always; 20 21 location / { 22 proxy_pass http://backend; 23 proxy_set_header Host $host; 24 proxy_set_header X-Real-IP $remote_addr; 25 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 26 proxy_set_header X-Forwarded-Proto $scheme; 27 } 28} 29 30# HTTP é‡å®šå‘åˆ° HTTPS 31server { 32 listen 80; 33 server_name api.example.com; 34 return 301 https://$server_name$request_uri; 35} å…è´¹ SSL è¯ä¹¦ï¼ˆLet\u0026rsquo;s Encryptï¼‰ 1# å®‰è£… Certbot 2sudo yum install certbot python3-certbot-nginx 3 4# è·å–è¯ä¹¦ 5sudo certbot --nginx -d api.example.com 6 7# è‡ªåŠ¨ç»­æœŸ 8sudo certbot renew --dry-run æ€§èƒ½ä¼˜åŒ– 1. è¿æ¥ä¼˜åŒ– 1http { 2 # é•¿è¿æ¥é…ç½® 3 keepalive_timeout 65; 4 keepalive_requests 100; 5 6 # ä¸Šæ¸¸æœåŠ¡å™¨é•¿è¿æ¥ 7 upstream backend { 8 server 192.168.1.101:8080; 9 server 192.168.1.102:8080; 10 11 keepalive 32; # ä¿æŒ 32 ä¸ªç©ºé—²è¿æ¥ 12 } 13 14 server { 15 location / { 16 proxy_pass http://backend; 17 proxy_http_version 1.1; 18 proxy_set_header Connection \u0026#34;\u0026#34;; 19 } 20 } 21} 2. ç¼“å­˜é…ç½® 1# å®šä¹‰ç¼“å­˜è·¯å¾„ 2proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m; 3 4server { 5 location / { 6 proxy_pass http://backend; 7 8 # å¯ç”¨ç¼“å­˜ 9 proxy_cache my_cache; 10 proxy_cache_valid 200 304 10m; 11 proxy_cache_valid 404 1m; 12 proxy_cache_key $scheme$proxy_host$request_uri; 13 14 # ç¼“å­˜å¤´ä¿¡æ¯ 15 add_header X-Cache-Status $upstream_cache_status; 16 } 17 18 # é™æ€èµ„æºç¼“å­˜ 19 location ~* \\.(jpg|jpeg|png|gif|ico|css|js)$ { 20 proxy_pass http://backend; 21 proxy_cache my_cache; 22 proxy_cache_valid 200 30d; 23 expires 30d; 24 } 25} 3. Gzip å‹ç¼© 1http { 2 gzip on; 3 gzip_vary on; 4 gzip_proxied any; 5 gzip_comp_level 6; 6 gzip_types text/plain text/css text/xml text/javascript 7 application/json application/javascript application/xml+rss 8 application/rss+xml font/truetype font/opentype 9 application/vnd.ms-fontobject image/svg+xml; 10 gzip_disable \u0026#34;msie6\u0026#34;; 11} 4. é™æµé…ç½® 1http { 2 # å®šä¹‰é™æµåŒºåŸŸ 3 limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s; 4 limit_conn_zone $binary_remote_addr zone=conn_limit:10m; 5 6 server { 7 location /api/ { 8 # é™åˆ¶è¯·æ±‚é€Ÿç‡ï¼šæ¯ç§’ 10 ä¸ªè¯·æ±‚ï¼Œçªå‘ 20 ä¸ª 9 limit_req zone=api_limit burst=20 nodelay; 10 11 # é™åˆ¶å¹¶å‘è¿æ¥æ•°ï¼šæ¯ä¸ª IP æœ€å¤š 10 ä¸ªè¿æ¥ 12 limit_conn conn_limit 10; 13 14 proxy_pass http://backend; 15 } 16 } 17} 5. Worker è¿›ç¨‹ä¼˜åŒ– 1# è‡ªåŠ¨è®¾ç½® worker è¿›ç¨‹æ•°ä¸º CPU æ ¸å¿ƒæ•° 2worker_processes auto; 3 4# ç»‘å®š worker è¿›ç¨‹åˆ° CPU æ ¸å¿ƒ 5worker_cpu_affinity auto; 6 7# æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•° 8worker_rlimit_nofile 65535; 9 10events { 11 # æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° 12 worker_connections 10240; 13 14 # ä½¿ç”¨ epoll äº‹ä»¶æ¨¡å‹ 15 use epoll; 16 17 # å°½å¯èƒ½å¤šåœ°æ¥å—è¿æ¥ 18 multi_accept on; 19} ç›‘æ§ä¸æ—¥å¿— è®¿é—®æ—¥å¿—åˆ†æ 1# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ 2log_format detailed \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#39; 3 \u0026#39;\u0026#34;$request\u0026#34; $status $body_bytes_sent \u0026#39; 4 \u0026#39;\u0026#34;$http_referer\u0026#34; \u0026#34;$http_user_agent\u0026#34; \u0026#39; 5 \u0026#39;$request_time $upstream_response_time \u0026#39; 6 \u0026#39;$upstream_addr $upstream_status\u0026#39;; 7 8access_log /var/log/nginx/access.log detailed; ä½¿ç”¨ GoAccess åˆ†ææ—¥å¿— 1# å®‰è£… GoAccess 2sudo yum install goaccess 3 4# å®æ—¶åˆ†ææ—¥å¿— 5goaccess /var/log/nginx/access.log -o /var/www/html/report.html --log-format=COMBINED --real-time-html Nginx çŠ¶æ€ç›‘æ§ 1server { 2 listen 8080; 3 server_name localhost; 4 5 location /nginx_status { 6 stub_status on; 7 access_log off; 8 allow 127.0.0.1; 9 deny all; 10 } 11} è®¿é—® http://localhost:8080/nginx_status æŸ¥çœ‹çŠ¶æ€ï¼š\n1Active connections: 291 2server accepts handled requests 3 16630948 16630948 31070465 4Reading: 6 Writing: 179 Waiting: 106 Prometheus ç›‘æ§ ä½¿ç”¨ nginx-prometheus-exporterï¼š\n1# ä¸‹è½½å¹¶è¿è¡Œ exporter 2docker run -p 9113:9113 nginx/nginx-prometheus-exporter:latest \\ 3 -nginx.scrape-uri=http://nginx:8080/nginx_status ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ 1. é…ç½®æ–‡ä»¶ç»„ç»‡ 1/etc/nginx/ 2â”œâ”€â”€ nginx.conf # ä¸»é…ç½®æ–‡ä»¶ 3â”œâ”€â”€ conf.d/ 4â”‚ â”œâ”€â”€ api.conf # API æœåŠ¡é…ç½® 5â”‚ â”œâ”€â”€ web.conf # Web æœåŠ¡é…ç½® 6â”‚ â””â”€â”€ admin.conf # ç®¡ç†åå°é…ç½® 7â”œâ”€â”€ upstream/ 8â”‚ â”œâ”€â”€ api-backend.conf # API åç«¯æœåŠ¡å™¨åˆ—è¡¨ 9â”‚ â””â”€â”€ web-backend.conf # Web åç«¯æœåŠ¡å™¨åˆ—è¡¨ 10â””â”€â”€ ssl/ 11 â”œâ”€â”€ api.example.com.crt 12 â””â”€â”€ api.example.com.key 2. é…ç½®æ£€æŸ¥ä¸é‡è½½ 1# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³• 2sudo nginx -t 3 4# é‡è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰ 5sudo nginx -s reload 6 7# æŸ¥çœ‹ Nginx ç‰ˆæœ¬å’Œç¼–è¯‘å‚æ•° 8nginx -V 3. å®‰å…¨åŠ å›º 1# éšè— Nginx ç‰ˆæœ¬å· 2server_tokens off; 3 4# é™åˆ¶è¯·æ±‚æ–¹æ³• 5if ($request_method !~ ^(GET|POST|PUT|DELETE|HEAD)$) { 6 return 405; 7} 8 9# é˜²æ­¢ç‚¹å‡»åŠ«æŒ 10add_header X-Frame-Options \u0026#34;SAMEORIGIN\u0026#34; always; 11 12# XSS é˜²æŠ¤ 13add_header X-XSS-Protection \u0026#34;1; mode=block\u0026#34; always; 14 15# å†…å®¹ç±»å‹å—…æ¢é˜²æŠ¤ 16add_header X-Content-Type-Options \u0026#34;nosniff\u0026#34; always; 17 18# CSP ç­–ç•¥ 19add_header Content-Security-Policy \u0026#34;default-src \u0026#39;self\u0026#39;\u0026#34; always; 4. æ—¥å¿—è½®è½¬ 1# /etc/logrotate.d/nginx 2 3/var/log/nginx/*.log { 4 daily 5 missingok 6 rotate 14 7 compress 8 delaycompress 9 notifempty 10 create 0640 nginx adm 11 sharedscripts 12 postrotate 13 [ -f /var/run/nginx.pid ] \u0026amp;\u0026amp; kill -USR1 `cat /var/run/nginx.pid` 14 endscript 15} é¿å‘æç¤ºï¼š ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒåŠ¡å¿…åšå¥½ä»¥ä¸‹å‡ ç‚¹ï¼š1) å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶ï¼›2) ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®ï¼›3) é…ç½®å˜æ›´å‰å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼›4) è®¾ç½®ç›‘æ§å‘Šè­¦ï¼›5) å‡†å¤‡å›æ»šæ–¹æ¡ˆã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº† Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§å®è·µï¼š\nåå‘ä»£ç†ï¼šç†è§£åŸç†ï¼ŒæŒæ¡åŸºç¡€é…ç½®å’Œè·¯å¾„é‡å†™ è´Ÿè½½å‡è¡¡ï¼šæŒæ¡å¤šç§ç­–ç•¥ï¼Œæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ å¥åº·æ£€æŸ¥ï¼šå®ç°æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨è½¬ç§» ä¼šè¯ä¿æŒï¼šäº†è§£å¤šç§æ–¹æ¡ˆï¼Œæ¨èåº”ç”¨å±‚æ— çŠ¶æ€åŒ– HTTPS é…ç½®ï¼šSSL è¯ä¹¦é…ç½®å’Œå®‰å…¨åŠ å›º æ€§èƒ½ä¼˜åŒ–ï¼šè¿æ¥ä¼˜åŒ–ã€ç¼“å­˜ã€å‹ç¼©ã€é™æµç­‰ ç›‘æ§æ—¥å¿—ï¼šæ—¥å¿—åˆ†æå’ŒçŠ¶æ€ç›‘æ§ åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒNginx çš„ä½œç”¨è¿œä¸æ­¢äºæ­¤ã€‚é€šè¿‡åˆç†é…ç½®ï¼Œè¿˜å¯ä»¥å®ç°ï¼š\nç°åº¦å‘å¸ƒï¼šæ ¹æ®æ¡ä»¶å°†éƒ¨åˆ†æµé‡å¯¼å‘æ–°ç‰ˆæœ¬ A/B æµ‹è¯•ï¼šå°†ä¸åŒç”¨æˆ·å¯¼å‘ä¸åŒç‰ˆæœ¬ æµé‡æ§åˆ¶ï¼šé™æµã€ç†”æ–­ã€é™çº§ å®‰å…¨é˜²æŠ¤ï¼šWAFã€DDoS é˜²æŠ¤ ä¸‹æ¬¡å½“ä½ éœ€è¦æ­å»ºé«˜å¯ç”¨æœåŠ¡æ¶æ„æ—¶ï¼ŒNginx å°†æ˜¯ä½ çš„å¾—åŠ›åŠ©æ‰‹ã€‚\n","permalink":"http://localhost:1313/posts/2025/06/nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E6%88%98%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E4%BC%98%E5%8C%96/","summary":"\u003cp\u003eNginx ä½œä¸ºé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå·²ç»æˆä¸ºäº’è”ç½‘æ¶æ„ä¸­çš„æ ‡é…ç»„ä»¶ã€‚æ— è®ºæ˜¯é™æ€èµ„æºæœåŠ¡ã€åå‘ä»£ç†è¿˜æ˜¯è´Ÿè½½å‡è¡¡ï¼ŒNginx éƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…åœºæ™¯å‡ºå‘ï¼Œæ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œå¸®åŠ©ä½ æ„å»ºé«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åå‘ä»£ç†ä¸æ­£å‘ä»£ç†çš„åŒºåˆ«\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Nginx è´Ÿè½½å‡è¡¡çš„å¤šç§ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé…ç½®å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ä¼šè¯ä¿æŒçš„å®ç°æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åå‘ä»£ç†åŸºç¡€\"\u003eåå‘ä»£ç†åŸºç¡€\u003c/h2\u003e\n\u003ch3 id=\"æ­£å‘ä»£ç†-vs-åå‘ä»£ç†\"\u003eæ­£å‘ä»£ç† vs åå‘ä»£ç†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæ­£å‘ä»£ç†\u003c/strong\u003eï¼šå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eï¼ˆå®¢æˆ·ç«¯é…ç½®ä»£ç†ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåå‘ä»£ç†\u003c/strong\u003eï¼šå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å†³å®šè½¬å‘åˆ°å“ªå°æœåŠ¡å™¨\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨é›†ç¾¤\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eï¼ˆæœåŠ¡ç«¯é…ç½®ä»£ç†ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"åå‘ä»£ç†çš„ä¼˜åŠ¿\"\u003eåå‘ä»£ç†çš„ä¼˜åŠ¿\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eè´Ÿè½½å‡è¡¡\u003c/strong\u003eï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eéšè—çœŸå®æœåŠ¡å™¨\u003c/strong\u003eï¼šæé«˜å®‰å…¨æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSSL å¸è½½\u003c/strong\u003eï¼šåœ¨ä»£ç†å±‚å¤„ç† HTTPS\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç¼“å­˜é™æ€èµ„æº\u003c/strong\u003eï¼šå‡è½»åç«¯å‹åŠ›\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç»Ÿä¸€å…¥å£\u003c/strong\u003eï¼šä¾¿äºç®¡ç†å’Œç›‘æ§\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e åå‘ä»£ç†ä¸ä»…æ˜¯æµé‡åˆ†å‘å™¨ï¼Œæ›´æ˜¯æ¶æ„ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•ã€æµé‡æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"nginx-åå‘ä»£ç†é…ç½®\"\u003eNginx åå‘ä»£ç†é…ç½®\u003c/h2\u003e\n\u003ch3 id=\"åŸºç¡€é…ç½®\"\u003eåŸºç¡€é…ç½®\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /etc/nginx/nginx.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euser\u003c/span\u003e \u003cspan class=\"s\"\u003enginx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eworker_processes\u003c/span\u003e \u003cspan class=\"s\"\u003eauto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eerror_log\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/nginx/error.log\u003c/span\u003e \u003cspan class=\"s\"\u003ewarn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003epid\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/nginx.pid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eevents\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eworker_connections\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003euse\u003c/span\u003e \u003cspan class=\"s\"\u003eepoll\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# Linux ä¸‹ä½¿ç”¨ epoll\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ehttp\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003einclude\u003c/span\u003e \u003cspan class=\"s\"\u003e/etc/nginx/mime.types\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003edefault_type\u003c/span\u003e \u003cspan class=\"s\"\u003eapplication/octet-stream\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# æ—¥å¿—æ ¼å¼\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elog_format\u003c/span\u003e \u003cspan class=\"s\"\u003emain\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e \u003cspan class=\"s\"\u003e-\u003c/span\u003e \u003cspan class=\"nv\"\u003e$remote_user\u003c/span\u003e \u003cspan class=\"s\"\u003e[\u003c/span\u003e\u003cspan class=\"nv\"\u003e$time_local]\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$request\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$status\u003c/span\u003e \u003cspan class=\"nv\"\u003e$body_bytes_sent\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_referer\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_user_agent\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_x_forwarded_for\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$request_time\u003c/span\u003e \u003cspan class=\"nv\"\u003e$upstream_response_time\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eaccess_log\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/nginx/access.log\u003c/span\u003e \u003cspan class=\"s\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003esendfile\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etcp_nopush\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etcp_nodelay\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003ekeepalive_timeout\u003c/span\u003e \u003cspan class=\"mi\"\u003e65\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etypes_hash_max_size\u003c/span\u003e \u003cspan class=\"mi\"\u003e2048\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003einclude\u003c/span\u003e \u003cspan class=\"s\"\u003e/etc/nginx/conf.d/*.conf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ç®€å•åå‘ä»£ç†\"\u003eç®€å•åå‘ä»£ç†\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /etc/nginx/conf.d/api.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eserver\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elisten\u003c/span\u003e \u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eserver_name\u003c/span\u003e \u003cspan class=\"s\"\u003eapi.example.com\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# ä»£ç†åˆ°åç«¯æœåŠ¡å™¨\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://192.168.1.100:8080\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# è®¾ç½®è¯·æ±‚å¤´\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eHost\u003c/span\u003e \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Real-IP\u003c/span\u003e \u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Forwarded-For\u003c/span\u003e \u003cspan class=\"nv\"\u003e$proxy_add_x_forwarded_for\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Forwarded-Proto\u003c/span\u003e \u003cspan class=\"nv\"\u003e$scheme\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# è¶…æ—¶è®¾ç½®\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_connect_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_send_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_read_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"è·¯å¾„é‡å†™\"\u003eè·¯å¾„é‡å†™\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eserver\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elisten\u003c/span\u003e \u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eserver_name\u003c/span\u003e \u003cspan class=\"s\"\u003eapi.example.com\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# å°† /api/v1/users ä»£ç†åˆ° http://backend/users\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/api/v1/\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://backend/\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# æ³¨æ„æœ«å°¾çš„ /\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eHost\u003c/span\u003e \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# å°† /old-api é‡å†™ä¸º /new-api\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/old-api\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003erewrite\u003c/span\u003e \u003cspan class=\"s\"\u003e^/old-api/(.*)\u003c/span\u003e$ \u003cspan class=\"s\"\u003e/new-api/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e \u003cspan class=\"s\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://backend\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"è´Ÿè½½å‡è¡¡ç­–ç•¥\"\u003eè´Ÿè½½å‡è¡¡ç­–ç•¥\u003c/h2\u003e\n\u003ch3 id=\"1-è½®è¯¢round-robin\"\u003e1. è½®è¯¢ï¼ˆRound Robinï¼‰\u003c/h3\u003e\n\u003cp\u003eé»˜è®¤ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†é…è¯·æ±‚ï¼š\u003c/p\u003e","title":"Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ–"},{"content":"åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¤§æ•°æ®é‡å¯¼å‡ºæ˜¯ä¸€ä¸ªå¸¸è§ä½†æ£˜æ‰‹çš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„ Apache POI åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºï¼Œè€Œé˜¿é‡Œå¼€æºçš„ EasyExcel é€šè¿‡ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œå¯ä»¥è½»æ¾å¤„ç†ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€‚\næœ¬æ–‡å°†ä»å®é™…é—®é¢˜å‡ºå‘ï¼Œæ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°é«˜æ€§èƒ½çš„å¤§æ•°æ®é‡å¯¼å‡ºï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¼˜åŒ–ç»éªŒã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜ æŒæ¡ EasyExcel çš„æ ¸å¿ƒåŸç† å­¦ä¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„æœ€ä½³å®è·µ äº†è§£å¼‚æ­¥å¯¼å‡ºä¸è¿›åº¦åé¦ˆæ–¹æ¡ˆ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§ ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜ é—®é¢˜åœºæ™¯ æŸç”µå•†ç³»ç»Ÿéœ€è¦å¯¼å‡ºè®¢å•æ•°æ®ï¼Œæ•°æ®é‡è¾¾åˆ° 100 ä¸‡æ¡ã€‚ä½¿ç”¨ä¼ ç»Ÿçš„ Apache POI å®ç°ï¼š\n1// ä¼ ç»Ÿ POI å®ç°ï¼ˆæœ‰é—®é¢˜çš„ä»£ç ï¼‰ 2public void exportOrders() { 3 Workbook workbook = new XSSFWorkbook(); 4 Sheet sheet = workbook.createSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;); 5 6 // æŸ¥è¯¢ 100 ä¸‡æ¡æ•°æ® 7 List\u0026lt;Order\u0026gt; orders = orderMapper.selectAll(); 8 9 // å†™å…¥ Excel 10 for (int i = 0; i \u0026lt; orders.size(); i++) { 11 Row row = sheet.createRow(i); 12 Order order = orders.get(i); 13 row.createCell(0).setCellValue(order.getOrderNo()); 14 row.createCell(1).setCellValue(order.getUserName()); 15 // ... æ›´å¤šå­—æ®µ 16 } 17 18 // è¾“å‡ºæ–‡ä»¶ 19 FileOutputStream fos = new FileOutputStream(\u0026#34;orders.xlsx\u0026#34;); 20 workbook.write(fos); 21 fos.close(); 22} å†…å­˜åˆ†æ è¿™æ®µä»£ç å­˜åœ¨ä¸¥é‡çš„å†…å­˜é—®é¢˜ï¼š\nä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®ï¼š100 ä¸‡æ¡æ•°æ®å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ POI å¯¹è±¡å ç”¨å¤§ï¼šæ¯ä¸ª Cellã€Rowã€Sheet éƒ½æ˜¯ Java å¯¹è±¡ å†…å­˜æ— æ³•é‡Šæ”¾ï¼šæ•°æ®å†™å…¥å‰å¿…é¡»å…¨éƒ¨ä¿å­˜åœ¨å†…å­˜ä¸­ å†…å­˜å ç”¨ä¼°ç®—ï¼š\næ¯æ¡è®¢å•æ•°æ®ï¼šçº¦ 1KB 100 ä¸‡æ¡æ•°æ®ï¼šçº¦ 1GB POI å¯¹è±¡å¼€é”€ï¼šçº¦ 3-5 å€ æ€»å†…å­˜å ç”¨ï¼š3-5GB æ¶æ„æ€è€ƒï¼š ä¼ ç»Ÿ POI é‡‡ç”¨ DOM æ¨¡å¼ï¼Œéœ€è¦åœ¨å†…å­˜ä¸­æ„å»ºå®Œæ•´çš„æ–‡æ¡£å¯¹è±¡æ¨¡å‹ã€‚è¿™ç§æ–¹å¼è™½ç„¶çµæ´»ï¼Œä½†åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚EasyExcel é‡‡ç”¨ SAX æ¨¡å¼ï¼Œè¾¹è¯»è¾¹å†™ï¼Œå¤§å¤§é™ä½äº†å†…å­˜å ç”¨ã€‚\nEasyExcel æ ¸å¿ƒåŸç† å†…å­˜ä¼˜åŒ–ç­–ç•¥ EasyExcel é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¼˜åŒ–å†…å­˜ï¼š\næµå¼å†™å…¥ï¼šä¸åœ¨å†…å­˜ä¸­ä¿å­˜å®Œæ•´çš„ Excel å¯¹è±¡ åˆ†æ‰¹å¤„ç†ï¼šæ”¯æŒåˆ†æ‰¹æŸ¥è¯¢å’Œå†™å…¥ ä¸´æ—¶æ–‡ä»¶ï¼šä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ç¼“å­˜æ•°æ® å¯¹è±¡å¤ç”¨ï¼šå¤ç”¨ Java å¯¹è±¡ï¼Œå‡å°‘ GC å‹åŠ› å†…å­˜å ç”¨å¯¹æ¯” æ–¹æ¡ˆ 10ä¸‡æ¡ 50ä¸‡æ¡ 100ä¸‡æ¡ Apache POI 300MB 1.5GB OOM EasyExcel 20MB 50MB 100MB EasyExcel åŸºç¡€ä½¿ç”¨ é¡¹ç›®ä¾èµ– 1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;easyexcel\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;3.3.2\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; å®šä¹‰æ•°æ®æ¨¡å‹ 1@Data 2public class OrderExportDTO { 3 4 @ExcelProperty(value = \u0026#34;è®¢å•å·\u0026#34;, index = 0) 5 private String orderNo; 6 7 @ExcelProperty(value = \u0026#34;ç”¨æˆ·å\u0026#34;, index = 1) 8 private String userName; 9 10 @ExcelProperty(value = \u0026#34;å•†å“åç§°\u0026#34;, index = 2) 11 private String productName; 12 13 @ExcelProperty(value = \u0026#34;è®¢å•é‡‘é¢\u0026#34;, index = 3) 14 @NumberFormat(\u0026#34;#.##\u0026#34;) 15 private BigDecimal amount; 16 17 @ExcelProperty(value = \u0026#34;è®¢å•çŠ¶æ€\u0026#34;, index = 4) 18 @ExcelProperty(converter = OrderStatusConverter.class) 19 private Integer status; 20 21 @ExcelProperty(value = \u0026#34;åˆ›å»ºæ—¶é—´\u0026#34;, index = 5) 22 @DateTimeFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;) 23 private Date createTime; 24} ç®€å•å¯¼å‡ºç¤ºä¾‹ 1@Service 2public class OrderExportService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 /** 8 * ç®€å•å¯¼å‡ºï¼ˆé€‚ç”¨äºå°æ•°æ®é‡ï¼‰ 9 */ 10 public void simpleExport(HttpServletResponse response) throws IOException { 11 // æŸ¥è¯¢æ•°æ® 12 List\u0026lt;OrderExportDTO\u0026gt; data = orderMapper.selectForExport(); 13 14 // è®¾ç½®å“åº”å¤´ 15 response.setContentType(\u0026#34;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\u0026#34;); 16 response.setCharacterEncoding(\u0026#34;utf-8\u0026#34;); 17 String fileName = URLEncoder.encode(\u0026#34;è®¢å•æ•°æ®\u0026#34;, \u0026#34;UTF-8\u0026#34;); 18 response.setHeader(\u0026#34;Content-disposition\u0026#34;, \u0026#34;attachment;filename=\u0026#34; + fileName + \u0026#34;.xlsx\u0026#34;); 19 20 // å†™å…¥ Excel 21 EasyExcel.write(response.getOutputStream(), OrderExportDTO.class) 22 .sheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;) 23 .doWrite(data); 24 } 25} ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºæ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šåˆ†é¡µæŸ¥è¯¢ + æµå¼å†™å…¥ 1@Service 2@Slf4j 3public class LargeDataExportService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 private static final int PAGE_SIZE = 10000; // æ¯é¡µ 1 ä¸‡æ¡ 9 10 /** 11 * åˆ†é¡µå¯¼å‡ºå¤§æ•°æ®é‡ 12 */ 13 public void exportLargeData(HttpServletResponse response) throws IOException { 14 // è®¾ç½®å“åº”å¤´ 15 setResponseHeader(response, \u0026#34;è®¢å•æ•°æ®\u0026#34;); 16 17 // ä½¿ç”¨ EasyExcel çš„æµå¼å†™å…¥ 18 ExcelWriter excelWriter = null; 19 try { 20 excelWriter = EasyExcel.write(response.getOutputStream(), OrderExportDTO.class).build(); 21 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 22 23 // åˆ†é¡µæŸ¥è¯¢å¹¶å†™å…¥ 24 int pageNum = 1; 25 while (true) { 26 log.info(\u0026#34;å¼€å§‹å¯¼å‡ºç¬¬ {} é¡µæ•°æ®\u0026#34;, pageNum); 27 28 // åˆ†é¡µæŸ¥è¯¢ 29 PageHelper.startPage(pageNum, PAGE_SIZE); 30 List\u0026lt;OrderExportDTO\u0026gt; data = orderMapper.selectForExport(); 31 32 if (CollectionUtils.isEmpty(data)) { 33 break; 34 } 35 36 // å†™å…¥å½“å‰é¡µæ•°æ® 37 excelWriter.write(data, writeSheet); 38 39 log.info(\u0026#34;ç¬¬ {} é¡µæ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} æ¡\u0026#34;, pageNum, data.size()); 40 41 // å¦‚æœå½“å‰é¡µæ•°æ®ä¸è¶³ä¸€é¡µï¼Œè¯´æ˜å·²ç»æ˜¯æœ€åä¸€é¡µ 42 if (data.size() \u0026lt; PAGE_SIZE) { 43 break; 44 } 45 46 pageNum++; 47 } 48 49 log.info(\u0026#34;æ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} é¡µ\u0026#34;, pageNum); 50 } finally { 51 if (excelWriter != null) { 52 excelWriter.finish(); 53 } 54 } 55 } 56 57 private void setResponseHeader(HttpServletResponse response, String fileName) throws UnsupportedEncodingException { 58 response.setContentType(\u0026#34;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\u0026#34;); 59 response.setCharacterEncoding(\u0026#34;utf-8\u0026#34;); 60 String encodedFileName = URLEncoder.encode(fileName, \u0026#34;UTF-8\u0026#34;); 61 response.setHeader(\u0026#34;Content-disposition\u0026#34;, \u0026#34;attachment;filename=\u0026#34; + encodedFileName + \u0026#34;.xlsx\u0026#34;); 62 } 63} æ–¹æ¡ˆäºŒï¼šæ¸¸æ ‡æŸ¥è¯¢ + æµå¼å†™å…¥ å¯¹äº MyBatisï¼Œå¯ä»¥ä½¿ç”¨æ¸¸æ ‡ï¼ˆCursorï¼‰è¿›ä¸€æ­¥ä¼˜åŒ–å†…å­˜ï¼š\n1/** 2 * Mapper æ¥å£ 3 */ 4public interface OrderMapper { 5 /** 6 * ä½¿ç”¨æ¸¸æ ‡æŸ¥è¯¢ï¼ˆæµå¼æŸ¥è¯¢ï¼‰ 7 */ 8 @Options(resultSetType = ResultSetType.FORWARD_ONLY, fetchSize = 1000) 9 @Select(\u0026#34;SELECT * FROM t_order WHERE status = #{status}\u0026#34;) 10 Cursor\u0026lt;OrderExportDTO\u0026gt; selectByCursor(@Param(\u0026#34;status\u0026#34;) Integer status); 11} 12 13/** 14 * ä½¿ç”¨æ¸¸æ ‡å¯¼å‡º 15 */ 16public void exportWithCursor(HttpServletResponse response) throws IOException { 17 setResponseHeader(response, \u0026#34;è®¢å•æ•°æ®\u0026#34;); 18 19 ExcelWriter excelWriter = null; 20 Cursor\u0026lt;OrderExportDTO\u0026gt; cursor = null; 21 22 try { 23 excelWriter = EasyExcel.write(response.getOutputStream(), OrderExportDTO.class).build(); 24 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 25 26 // æ‰“å¼€æ¸¸æ ‡ 27 cursor = orderMapper.selectByCursor(1); 28 29 List\u0026lt;OrderExportDTO\u0026gt; batch = new ArrayList\u0026lt;\u0026gt;(PAGE_SIZE); 30 int count = 0; 31 32 // éå†æ¸¸æ ‡ 33 for (OrderExportDTO order : cursor) { 34 batch.add(order); 35 count++; 36 37 // æ¯ 1 ä¸‡æ¡å†™å…¥ä¸€æ¬¡ 38 if (batch.size() \u0026gt;= PAGE_SIZE) { 39 excelWriter.write(batch, writeSheet); 40 log.info(\u0026#34;å·²å¯¼å‡º {} æ¡æ•°æ®\u0026#34;, count); 41 batch.clear(); 42 } 43 } 44 45 // å†™å…¥å‰©ä½™æ•°æ® 46 if (!batch.isEmpty()) { 47 excelWriter.write(batch, writeSheet); 48 log.info(\u0026#34;æ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} æ¡\u0026#34;, count); 49 } 50 51 } finally { 52 if (cursor != null) { 53 cursor.close(); 54 } 55 if (excelWriter != null) { 56 excelWriter.finish(); 57 } 58 } 59} é¿å‘æç¤ºï¼š ä½¿ç”¨æ¸¸æ ‡æŸ¥è¯¢æ—¶ï¼Œéœ€è¦æ³¨æ„ï¼š1) å¿…é¡»åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆï¼›2) ä¸èƒ½ä½¿ç”¨åˆ†é¡µæ’ä»¶ï¼›3) éœ€è¦è®¾ç½® fetchSize æ§åˆ¶æ¯æ¬¡ä»æ•°æ®åº“è·å–çš„è®°å½•æ•°ã€‚\nå¼‚æ­¥å¯¼å‡ºæ–¹æ¡ˆ å¯¹äºè¶…å¤§æ•°æ®é‡ï¼ˆç™¾ä¸‡çº§ä»¥ä¸Šï¼‰ï¼ŒåŒæ­¥å¯¼å‡ºä¼šå¯¼è‡´è¯·æ±‚è¶…æ—¶ã€‚æ¨èä½¿ç”¨å¼‚æ­¥å¯¼å‡ºæ–¹æ¡ˆï¼š\næ•´ä½“æ¶æ„ 1ç”¨æˆ·å‘èµ·å¯¼å‡ºè¯·æ±‚ 2 â†“ 3åˆ›å»ºå¯¼å‡ºä»»åŠ¡ï¼ˆè¿”å›ä»»åŠ¡IDï¼‰ 4 â†“ 5å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå¯¼å‡º 6 â†“ 7å¯¼å‡ºå®Œæˆåä¸Šä¼ åˆ° OSS 8 â†“ 9é€šçŸ¥ç”¨æˆ·ä¸‹è½½ å¯¼å‡ºä»»åŠ¡è¡¨ 1CREATE TABLE export_task ( 2 id BIGINT PRIMARY KEY AUTO_INCREMENT, 3 task_id VARCHAR(64) NOT NULL COMMENT \u0026#39;ä»»åŠ¡ID\u0026#39;, 4 file_name VARCHAR(255) NOT NULL COMMENT \u0026#39;æ–‡ä»¶å\u0026#39;, 5 status TINYINT NOT NULL COMMENT \u0026#39;çŠ¶æ€ï¼š0-å¾…å¤„ç†ï¼Œ1-å¤„ç†ä¸­ï¼Œ2-æˆåŠŸï¼Œ3-å¤±è´¥\u0026#39;, 6 total_count INT COMMENT \u0026#39;æ€»è®°å½•æ•°\u0026#39;, 7 exported_count INT COMMENT \u0026#39;å·²å¯¼å‡ºè®°å½•æ•°\u0026#39;, 8 file_url VARCHAR(512) COMMENT \u0026#39;æ–‡ä»¶ä¸‹è½½åœ°å€\u0026#39;, 9 error_msg VARCHAR(1000) COMMENT \u0026#39;é”™è¯¯ä¿¡æ¯\u0026#39;, 10 create_by VARCHAR(64) COMMENT \u0026#39;åˆ›å»ºäºº\u0026#39;, 11 create_time DATETIME NOT NULL, 12 update_time DATETIME NOT NULL, 13 INDEX idx_task_id (task_id), 14 INDEX idx_create_by (create_by) 15) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;å¯¼å‡ºä»»åŠ¡è¡¨\u0026#39;; å¼‚æ­¥å¯¼å‡ºå®ç° 1@Service 2@Slf4j 3public class AsyncExportService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 @Autowired 9 private ExportTaskMapper exportTaskMapper; 10 11 @Autowired 12 private OssService ossService; 13 14 @Autowired 15 private ThreadPoolExecutor exportExecutor; 16 17 /** 18 * åˆ›å»ºå¯¼å‡ºä»»åŠ¡ 19 */ 20 public String createExportTask(String userId) { 21 // ç”Ÿæˆä»»åŠ¡ ID 22 String taskId = UUID.randomUUID().toString().replace(\u0026#34;-\u0026#34;, \u0026#34;\u0026#34;); 23 24 // åˆ›å»ºä»»åŠ¡è®°å½• 25 ExportTask task = new ExportTask(); 26 task.setTaskId(taskId); 27 task.setFileName(\u0026#34;è®¢å•æ•°æ®_\u0026#34; + DateUtil.format(new Date(), \u0026#34;yyyyMMddHHmmss\u0026#34;) + \u0026#34;.xlsx\u0026#34;); 28 task.setStatus(0); // å¾…å¤„ç† 29 task.setCreateBy(userId); 30 task.setCreateTime(new Date()); 31 task.setUpdateTime(new Date()); 32 exportTaskMapper.insert(task); 33 34 // æäº¤å¼‚æ­¥ä»»åŠ¡ 35 exportExecutor.execute(() -\u0026gt; executeExport(taskId)); 36 37 return taskId; 38 } 39 40 /** 41 * æ‰§è¡Œå¯¼å‡º 42 */ 43 private void executeExport(String taskId) { 44 ExportTask task = exportTaskMapper.selectByTaskId(taskId); 45 46 try { 47 // æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­ 48 task.setStatus(1); 49 exportTaskMapper.updateById(task); 50 51 // åˆ›å»ºä¸´æ—¶æ–‡ä»¶ 52 String tempFilePath = \u0026#34;/tmp/\u0026#34; + task.getFileName(); 53 File tempFile = new File(tempFilePath); 54 55 // å¯¼å‡ºæ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶ 56 exportToFile(tempFile, task); 57 58 // ä¸Šä¼ åˆ° OSS 59 String fileUrl = ossService.upload(tempFile, \u0026#34;export/\u0026#34; + task.getFileName()); 60 61 // æ›´æ–°ä»»åŠ¡çŠ¶æ€ 62 task.setStatus(2); // æˆåŠŸ 63 task.setFileUrl(fileUrl); 64 task.setUpdateTime(new Date()); 65 exportTaskMapper.updateById(task); 66 67 // åˆ é™¤ä¸´æ—¶æ–‡ä»¶ 68 tempFile.delete(); 69 70 // å‘é€é€šçŸ¥ï¼ˆé‚®ä»¶ã€ç«™å†…ä¿¡ç­‰ï¼‰ 71 sendNotification(task); 72 73 log.info(\u0026#34;å¯¼å‡ºä»»åŠ¡ {} å®Œæˆ\u0026#34;, taskId); 74 75 } catch (Exception e) { 76 log.error(\u0026#34;å¯¼å‡ºä»»åŠ¡ {} å¤±è´¥\u0026#34;, taskId, e); 77 78 // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥ 79 task.setStatus(3); 80 task.setErrorMsg(e.getMessage()); 81 task.setUpdateTime(new Date()); 82 exportTaskMapper.updateById(task); 83 } 84 } 85 86 /** 87 * å¯¼å‡ºæ•°æ®åˆ°æ–‡ä»¶ 88 */ 89 private void exportToFile(File file, ExportTask task) throws IOException { 90 ExcelWriter excelWriter = null; 91 Cursor\u0026lt;OrderExportDTO\u0026gt; cursor = null; 92 93 try { 94 excelWriter = EasyExcel.write(file, OrderExportDTO.class).build(); 95 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 96 97 cursor = orderMapper.selectByCursor(1); 98 99 List\u0026lt;OrderExportDTO\u0026gt; batch = new ArrayList\u0026lt;\u0026gt;(10000); 100 int totalCount = 0; 101 int exportedCount = 0; 102 103 for (OrderExportDTO order : cursor) { 104 batch.add(order); 105 totalCount++; 106 107 if (batch.size() \u0026gt;= 10000) { 108 excelWriter.write(batch, writeSheet); 109 exportedCount += batch.size(); 110 batch.clear(); 111 112 // æ›´æ–°è¿›åº¦ 113 task.setTotalCount(totalCount); 114 task.setExportedCount(exportedCount); 115 task.setUpdateTime(new Date()); 116 exportTaskMapper.updateById(task); 117 118 log.info(\u0026#34;ä»»åŠ¡ {} å·²å¯¼å‡º {} æ¡æ•°æ®\u0026#34;, task.getTaskId(), exportedCount); 119 } 120 } 121 122 // å†™å…¥å‰©ä½™æ•°æ® 123 if (!batch.isEmpty()) { 124 excelWriter.write(batch, writeSheet); 125 exportedCount += batch.size(); 126 } 127 128 // æ›´æ–°æœ€ç»ˆè®¡æ•° 129 task.setTotalCount(totalCount); 130 task.setExportedCount(exportedCount); 131 task.setUpdateTime(new Date()); 132 exportTaskMapper.updateById(task); 133 134 } finally { 135 if (cursor != null) { 136 cursor.close(); 137 } 138 if (excelWriter != null) { 139 excelWriter.finish(); 140 } 141 } 142 } 143 144 /** 145 * æŸ¥è¯¢ä»»åŠ¡è¿›åº¦ 146 */ 147 public ExportTask queryProgress(String taskId) { 148 return exportTaskMapper.selectByTaskId(taskId); 149 } 150 151 /** 152 * å‘é€é€šçŸ¥ 153 */ 154 private void sendNotification(ExportTask task) { 155 // å‘é€é‚®ä»¶ã€ç«™å†…ä¿¡ç­‰ 156 log.info(\u0026#34;å‘é€å¯¼å‡ºå®Œæˆé€šçŸ¥ç»™ç”¨æˆ· {}\u0026#34;, task.getCreateBy()); 157 } 158} å‰ç«¯è½®è¯¢è¿›åº¦ 1// åˆ›å»ºå¯¼å‡ºä»»åŠ¡ 2async function createExportTask() { 3 const response = await fetch(\u0026#39;/api/export/create\u0026#39;, { 4 method: \u0026#39;POST\u0026#39; 5 }); 6 const data = await response.json(); 7 const taskId = data.taskId; 8 9 // å¼€å§‹è½®è¯¢è¿›åº¦ 10 pollProgress(taskId); 11} 12 13// è½®è¯¢è¿›åº¦ 14function pollProgress(taskId) { 15 const timer = setInterval(async () =\u0026gt; { 16 const response = await fetch(`/api/export/progress/${taskId}`); 17 const task = await response.json(); 18 19 // æ›´æ–°è¿›åº¦æ¡ 20 const progress = task.totalCount \u0026gt; 0 21 ? (task.exportedCount / task.totalCount * 100).toFixed(2) 22 : 0; 23 updateProgressBar(progress); 24 25 // æ£€æŸ¥çŠ¶æ€ 26 if (task.status === 2) { 27 // å¯¼å‡ºæˆåŠŸ 28 clearInterval(timer); 29 showDownloadLink(task.fileUrl); 30 } else if (task.status === 3) { 31 // å¯¼å‡ºå¤±è´¥ 32 clearInterval(timer); 33 showError(task.errorMsg); 34 } 35 }, 2000); // æ¯ 2 ç§’è½®è¯¢ä¸€æ¬¡ 36} æ€§èƒ½ä¼˜åŒ–æŠ€å·§ 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– 1/** 2 * åªæŸ¥è¯¢éœ€è¦å¯¼å‡ºçš„å­—æ®µ 3 */ 4@Select(\u0026#34;SELECT order_no, user_name, product_name, amount, status, create_time \u0026#34; + 5 \u0026#34;FROM t_order WHERE status = #{status}\u0026#34;) 6List\u0026lt;OrderExportDTO\u0026gt; selectForExport(@Param(\u0026#34;status\u0026#34;) Integer status); 7 8/** 9 * æ·»åŠ ç´¢å¼• 10 */ 11CREATE INDEX idx_status_create_time ON t_order(status, create_time); 2. çº¿ç¨‹æ± é…ç½® 1@Configuration 2public class ThreadPoolConfig { 3 4 @Bean(\u0026#34;exportExecutor\u0026#34;) 5 public ThreadPoolExecutor exportExecutor() { 6 return new ThreadPoolExecutor( 7 2, // æ ¸å¿ƒçº¿ç¨‹æ•° 8 5, // æœ€å¤§çº¿ç¨‹æ•° 9 60L, TimeUnit.SECONDS, 10 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 11 new ThreadFactoryBuilder() 12 .setNameFormat(\u0026#34;export-thread-%d\u0026#34;) 13 .build(), 14 new ThreadPoolExecutor.CallerRunsPolicy() 15 ); 16 } 17} 3. è‡ªå®šä¹‰æ ·å¼ 1/** 2 * è‡ªå®šä¹‰è¡¨å¤´æ ·å¼ 3 */ 4public class CustomCellWriteHandler implements CellWriteHandler { 5 6 @Override 7 public void afterCellDispose(WriteSheetHolder writeSheetHolder, 8 WriteTableHolder writeTableHolder, 9 List\u0026lt;WriteCellData\u0026lt;?\u0026gt;\u0026gt; cellDataList, 10 Cell cell, 11 Head head, 12 Integer relativeRowIndex, 13 Boolean isHead) { 14 if (isHead) { 15 // è®¾ç½®è¡¨å¤´æ ·å¼ 16 CellStyle cellStyle = cell.getSheet().getWorkbook().createCellStyle(); 17 cellStyle.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex()); 18 cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND); 19 20 Font font = cell.getSheet().getWorkbook().createFont(); 21 font.setBold(true); 22 font.setFontHeightInPoints((short) 12); 23 cellStyle.setFont(font); 24 25 cell.setCellStyle(cellStyle); 26 } 27 } 28} 29 30// ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼ 31EasyExcel.write(file, OrderExportDTO.class) 32 .registerWriteHandler(new CustomCellWriteHandler()) 33 .sheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;) 34 .doWrite(data); 4. æ•°æ®è½¬æ¢å™¨ 1/** 2 * è®¢å•çŠ¶æ€è½¬æ¢å™¨ 3 */ 4public class OrderStatusConverter implements Converter\u0026lt;Integer\u0026gt; { 5 6 private static final Map\u0026lt;Integer, String\u0026gt; STATUS_MAP = new HashMap\u0026lt;\u0026gt;(); 7 8 static { 9 STATUS_MAP.put(0, \u0026#34;å¾…æ”¯ä»˜\u0026#34;); 10 STATUS_MAP.put(1, \u0026#34;å·²æ”¯ä»˜\u0026#34;); 11 STATUS_MAP.put(2, \u0026#34;å·²å‘è´§\u0026#34;); 12 STATUS_MAP.put(3, \u0026#34;å·²å®Œæˆ\u0026#34;); 13 STATUS_MAP.put(4, \u0026#34;å·²å–æ¶ˆ\u0026#34;); 14 } 15 16 @Override 17 public Class\u0026lt;Integer\u0026gt; supportJavaTypeKey() { 18 return Integer.class; 19 } 20 21 @Override 22 public CellDataTypeEnum supportExcelTypeKey() { 23 return CellDataTypeEnum.STRING; 24 } 25 26 @Override 27 public WriteCellData\u0026lt;?\u0026gt; convertToExcelData(Integer value, ExcelContentProperty contentProperty, 28 GlobalConfiguration globalConfiguration) { 29 return new WriteCellData\u0026lt;\u0026gt;(STATUS_MAP.getOrDefault(value, \u0026#34;æœªçŸ¥\u0026#34;)); 30 } 31} 5. å†…å­˜ç›‘æ§ 1@Component 2@Slf4j 3public class MemoryMonitor { 4 5 @Scheduled(fixedRate = 5000) 6 public void monitorMemory() { 7 Runtime runtime = Runtime.getRuntime(); 8 long totalMemory = runtime.totalMemory(); 9 long freeMemory = runtime.freeMemory(); 10 long usedMemory = totalMemory - freeMemory; 11 long maxMemory = runtime.maxMemory(); 12 13 double usedPercent = (double) usedMemory / maxMemory * 100; 14 15 if (usedPercent \u0026gt; 80) { 16 log.warn(\u0026#34;å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼š{:.2f}%ï¼Œå·²ä½¿ç”¨ï¼š{}MBï¼Œæœ€å¤§ï¼š{}MB\u0026#34;, 17 usedPercent, 18 usedMemory / 1024 / 1024, 19 maxMemory / 1024 / 1024); 20 } 21 } 22} é¿å‘æç¤ºï¼š åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ï¼š1) é™åˆ¶å•æ¬¡å¯¼å‡ºçš„æœ€å¤§è®°å½•æ•°ï¼ˆå¦‚ 100 ä¸‡æ¡ï¼‰ï¼›2) è®¾ç½®å¯¼å‡ºä»»åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼›3) å®šæœŸæ¸…ç†è¿‡æœŸçš„å¯¼å‡ºæ–‡ä»¶ï¼›4) ç›‘æ§å¯¼å‡ºä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºï¼Œä»å†…å­˜é—®é¢˜åˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œæä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼š\nå†…å­˜ä¼˜åŒ–ï¼šä½¿ç”¨ EasyExcel æ›¿ä»£ä¼ ç»Ÿ POIï¼Œå†…å­˜å ç”¨é™ä½ 90% åˆ†æ‰¹å¤„ç†ï¼šé€šè¿‡åˆ†é¡µæŸ¥è¯¢æˆ–æ¸¸æ ‡æŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ® å¼‚æ­¥å¯¼å‡ºï¼šå¯¹äºè¶…å¤§æ•°æ®é‡ï¼Œä½¿ç”¨å¼‚æ­¥ä»»åŠ¡ + è¿›åº¦åé¦ˆ æ€§èƒ½è°ƒä¼˜ï¼šæ•°æ®åº“ä¼˜åŒ–ã€çº¿ç¨‹æ± é…ç½®ã€æ ·å¼å®šåˆ¶ç­‰ ç”Ÿäº§å®è·µï¼šä»»åŠ¡ç®¡ç†ã€æ–‡ä»¶å­˜å‚¨ã€é€šçŸ¥æœºåˆ¶ç­‰ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦è€ƒè™‘ï¼š\næ•°æ®å®‰å…¨ï¼šå¯¼å‡ºæ–‡ä»¶çš„è®¿é—®æƒé™æ§åˆ¶ å¹¶å‘æ§åˆ¶ï¼šé™åˆ¶åŒæ—¶æ‰§è¡Œçš„å¯¼å‡ºä»»åŠ¡æ•°é‡ èµ„æºéš”ç¦»ï¼šå¯¼å‡ºä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥æ±  ç›‘æ§å‘Šè­¦ï¼šå¯¼å‡ºå¤±è´¥ç‡ã€å¹³å‡è€—æ—¶ç­‰æŒ‡æ ‡ ä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°å¤§æ•°æ®é‡å¯¼å‡ºåŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯• EasyExcel è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ã€‚\n","permalink":"http://localhost:1313/posts/2025/05/easyexcel-%E7%99%BE%E4%B8%87%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E7%9A%84%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¤§æ•°æ®é‡å¯¼å‡ºæ˜¯ä¸€ä¸ªå¸¸è§ä½†æ£˜æ‰‹çš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„ Apache POI åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºï¼Œè€Œé˜¿é‡Œå¼€æºçš„ EasyExcel é€šè¿‡ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œå¯ä»¥è½»æ¾å¤„ç†ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…é—®é¢˜å‡ºå‘ï¼Œæ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°é«˜æ€§èƒ½çš„å¤§æ•°æ®é‡å¯¼å‡ºï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¼˜åŒ–ç»éªŒã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ EasyExcel çš„æ ¸å¿ƒåŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¼‚æ­¥å¯¼å‡ºä¸è¿›åº¦åé¦ˆæ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¼ ç»Ÿ-poi-çš„å†…å­˜é—®é¢˜\"\u003eä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜åœºæ™¯\"\u003eé—®é¢˜åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿéœ€è¦å¯¼å‡ºè®¢å•æ•°æ®ï¼Œæ•°æ®é‡è¾¾åˆ° 100 ä¸‡æ¡ã€‚ä½¿ç”¨ä¼ ç»Ÿçš„ Apache POI å®ç°ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// ä¼ ç»Ÿ POI å®ç°ï¼ˆæœ‰é—®é¢˜çš„ä»£ç ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eexportOrders\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eWorkbook\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eXSSFWorkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eSheet\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003esheet\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateSheet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;è®¢å•æ•°æ®\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æŸ¥è¯¢ 100 ä¸‡æ¡æ•°æ®\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectAll\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å†™å…¥ Excel\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eRow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003esheet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateRow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateCell\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003esetCellValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetOrderNo\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateCell\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003esetCellValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserName\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ... æ›´å¤šå­—æ®µ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è¾“å‡ºæ–‡ä»¶\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eFileOutputStream\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eFileOutputStream\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;orders.xlsx\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"å†…å­˜åˆ†æ\"\u003eå†…å­˜åˆ†æ\u003c/h3\u003e\n\u003cp\u003eè¿™æ®µä»£ç å­˜åœ¨ä¸¥é‡çš„å†…å­˜é—®é¢˜ï¼š\u003c/p\u003e","title":"EasyExcel ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„å†…å­˜ä¼˜åŒ–å®æˆ˜"},{"content":"åœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå®æ—¶æ¶ˆæ¯æ¨é€å·²æˆä¸ºæ ‡é…åŠŸèƒ½ã€‚ä»å³æ—¶é€šè®¯ã€åœ¨çº¿å®¢æœåˆ°å®æ—¶ç›‘æ§å¤§å±ï¼Œéƒ½ç¦»ä¸å¼€é«˜æ€§èƒ½çš„æ¶ˆæ¯æ¨é€èƒ½åŠ›ã€‚ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼å­˜åœ¨å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹ç­‰é—®é¢˜ï¼Œè€Œ WebSocket åè®®çš„å‡ºç°å®Œç¾è§£å†³äº†è¿™äº›ç—›ç‚¹ã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty æ¡†æ¶å®ç°åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜ï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¨é€æœåŠ¡ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ WebSocket åè®®åŸç†ä¸æ¡æ‰‹æµç¨‹ å­¦ä¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨ ç†è§£å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ç®¡ç†ç­–ç•¥ æŒæ¡é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±æ–¹æ¡ˆ äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§ ä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket WebSocket åè®®ä¼˜åŠ¿ ç›¸æ¯”ä¼ ç»Ÿçš„ HTTP è½®è¯¢ï¼ŒWebSocket å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\nç‰¹æ€§ HTTP è½®è¯¢ WebSocket é€šä¿¡æ–¹å¼ åŠåŒå·¥ å…¨åŒå·¥ è¿æ¥å¼€é”€ æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥ ä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥ å®æ—¶æ€§ å–å†³äºè½®è¯¢é—´éš”ï¼ˆç§’çº§ï¼‰ æ¯«ç§’çº§ æœåŠ¡å™¨å‹åŠ› é«˜ï¼ˆé¢‘ç¹çš„ HTTP è¯·æ±‚ï¼‰ ä½ï¼ˆé•¿è¿æ¥ï¼‰ å¸¦å®½æ¶ˆè€— é«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰ HTTP å¤´ï¼‰ ä½ï¼ˆåªä¼ è¾“æ•°æ®å¸§ï¼‰ Netty æ¡†æ¶ä¼˜åŠ¿ Netty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\né«˜æ€§èƒ½ï¼šåŸºäº NIOï¼Œæ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥ æ˜“ç”¨æ€§ï¼šæä¾›äº†ä¸°å¯Œçš„ç¼–è§£ç å™¨å’Œå¤„ç†å™¨ ç¨³å®šæ€§ï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯ æ‰©å±•æ€§ï¼šçµæ´»çš„ Pipeline æœºåˆ¶ æ¶æ„æ€è€ƒï¼š é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œä¸ä»…è¦çœ‹æŠ€æœ¯æœ¬èº«çš„ä¼˜åŠ¿ï¼Œæ›´è¦è€ƒè™‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€è¿ç»´æˆæœ¬å’Œç¤¾åŒºç”Ÿæ€ã€‚Netty åœ¨ Java ç”Ÿæ€ä¸­å·²ç»æˆä¸ºäº‹å®æ ‡å‡†ï¼ŒDubboã€RocketMQã€Elasticsearch ç­‰çŸ¥åé¡¹ç›®éƒ½åœ¨ä½¿ç”¨ã€‚\nWebSocket åè®®åŸç† æ¡æ‰‹æµç¨‹ WebSocket åŸºäº HTTP åè®®è¿›è¡Œæ¡æ‰‹ï¼Œç„¶åå‡çº§ä¸º WebSocket åè®®ï¼š\n1å®¢æˆ·ç«¯è¯·æ±‚ï¼š 2GET /chat HTTP/1.1 3Host: server.example.com 4Upgrade: websocket 5Connection: Upgrade 6Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ== 7Sec-WebSocket-Version: 13 8 9æœåŠ¡ç«¯å“åº”ï¼š 10HTTP/1.1 101 Switching Protocols 11Upgrade: websocket 12Connection: Upgrade 13Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo= æ•°æ®å¸§æ ¼å¼ WebSocket ä½¿ç”¨å¸§ï¼ˆFrameï¼‰æ¥ä¼ è¾“æ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ï¼š\næ–‡æœ¬å¸§ï¼šä¼ è¾“ UTF-8 ç¼–ç çš„æ–‡æœ¬ äºŒè¿›åˆ¶å¸§ï¼šä¼ è¾“äºŒè¿›åˆ¶æ•°æ® æ§åˆ¶å¸§ï¼šPingã€Pongã€Close Netty WebSocket æœåŠ¡å™¨å®ç° é¡¹ç›®ä¾èµ– 1\u0026lt;dependencies\u0026gt; 2 \u0026lt;!-- Netty --\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;io.netty\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;netty-all\u0026lt;/artifactId\u0026gt; 6 \u0026lt;version\u0026gt;4.1.100.Final\u0026lt;/version\u0026gt; 7 \u0026lt;/dependency\u0026gt; 8 9 \u0026lt;!-- JSON å¤„ç† --\u0026gt; 10 \u0026lt;dependency\u0026gt; 11 \u0026lt;groupId\u0026gt;com.alibaba.fastjson2\u0026lt;/groupId\u0026gt; 12 \u0026lt;artifactId\u0026gt;fastjson2\u0026lt;/artifactId\u0026gt; 13 \u0026lt;version\u0026gt;2.0.43\u0026lt;/version\u0026gt; 14 \u0026lt;/dependency\u0026gt; 15\u0026lt;/dependencies\u0026gt; æœåŠ¡å™¨å¯åŠ¨ç±» 1@Slf4j 2@Component 3public class WebSocketServer { 4 5 private final int port = 8888; 6 private EventLoopGroup bossGroup; 7 private EventLoopGroup workerGroup; 8 9 @PostConstruct 10 public void start() throws InterruptedException { 11 bossGroup = new NioEventLoopGroup(1); 12 workerGroup = new NioEventLoopGroup(); 13 14 try { 15 ServerBootstrap bootstrap = new ServerBootstrap(); 16 bootstrap.group(bossGroup, workerGroup) 17 .channel(NioServerSocketChannel.class) 18 .childHandler(new WebSocketChannelInitializer()) 19 .option(ChannelOption.SO_BACKLOG, 128) 20 .childOption(ChannelOption.SO_KEEPALIVE, true); 21 22 ChannelFuture future = bootstrap.bind(port).sync(); 23 log.info(\u0026#34;WebSocket æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç«¯å£ï¼š{}\u0026#34;, port); 24 25 // ç­‰å¾…æœåŠ¡å™¨å…³é—­ 26 future.channel().closeFuture().sync(); 27 } finally { 28 shutdown(); 29 } 30 } 31 32 @PreDestroy 33 public void shutdown() { 34 if (bossGroup != null) { 35 bossGroup.shutdownGracefully(); 36 } 37 if (workerGroup != null) { 38 workerGroup.shutdownGracefully(); 39 } 40 log.info(\u0026#34;WebSocket æœåŠ¡å™¨å·²å…³é—­\u0026#34;); 41 } 42} Channel åˆå§‹åŒ–å™¨ 1public class WebSocketChannelInitializer extends ChannelInitializer\u0026lt;SocketChannel\u0026gt; { 2 3 @Override 4 protected void initChannel(SocketChannel ch) { 5 ChannelPipeline pipeline = ch.pipeline(); 6 7 // HTTP ç¼–è§£ç å™¨ 8 pipeline.addLast(new HttpServerCodec()); 9 // HTTP èšåˆå™¨ï¼ˆå°†å¤šä¸ª HTTP æ¶ˆæ¯èšåˆæˆä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼‰ 10 pipeline.addLast(new HttpObjectAggregator(65536)); 11 // HTTP å‹ç¼© 12 pipeline.addLast(new HttpContentCompressor()); 13 14 // WebSocket åè®®å¤„ç†å™¨ï¼ˆå¤„ç†æ¡æ‰‹ã€Closeã€Pingã€Pongï¼‰ 15 pipeline.addLast(new WebSocketServerProtocolHandler(\u0026#34;/ws\u0026#34;, null, true)); 16 17 // å¿ƒè·³æ£€æµ‹ï¼ˆè¯»ç©ºé—² 60 ç§’ï¼Œå†™ç©ºé—² 0 ç§’ï¼Œè¯»å†™ç©ºé—² 0 ç§’ï¼‰ 18 pipeline.addLast(new IdleStateHandler(60, 0, 0, TimeUnit.SECONDS)); 19 20 // è‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†å™¨ 21 pipeline.addLast(new WebSocketHandler()); 22 } 23} ä¸šåŠ¡å¤„ç†å™¨ 1@Slf4j 2@ChannelHandler.Sharable 3public class WebSocketHandler extends SimpleChannelInboundHandler\u0026lt;TextWebSocketFrame\u0026gt; { 4 5 @Override 6 public void channelActive(ChannelHandlerContext ctx) { 7 // è¿æ¥å»ºç«‹æ—¶ 8 Channel channel = ctx.channel(); 9 log.info(\u0026#34;å®¢æˆ·ç«¯è¿æ¥ï¼š{}\u0026#34;, channel.id().asShortText()); 10 11 // å°† Channel åŠ å…¥ç®¡ç†å™¨ 12 ChannelManager.addChannel(channel); 13 } 14 15 @Override 16 protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) { 17 // æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ 18 String content = msg.text(); 19 log.info(\u0026#34;æ”¶åˆ°æ¶ˆæ¯ï¼š{}\u0026#34;, content); 20 21 // è§£ææ¶ˆæ¯ 22 Message message = JSON.parseObject(content, Message.class); 23 24 // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ 25 switch (message.getType()) { 26 case \u0026#34;auth\u0026#34;: 27 handleAuth(ctx, message); 28 break; 29 case \u0026#34;heartbeat\u0026#34;: 30 handleHeartbeat(ctx); 31 break; 32 case \u0026#34;message\u0026#34;: 33 handleMessage(ctx, message); 34 break; 35 default: 36 log.warn(\u0026#34;æœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼š{}\u0026#34;, message.getType()); 37 } 38 } 39 40 @Override 41 public void channelInactive(ChannelHandlerContext ctx) { 42 // è¿æ¥æ–­å¼€æ—¶ 43 Channel channel = ctx.channel(); 44 log.info(\u0026#34;å®¢æˆ·ç«¯æ–­å¼€ï¼š{}\u0026#34;, channel.id().asShortText()); 45 46 // ä»ç®¡ç†å™¨ä¸­ç§»é™¤ 47 ChannelManager.removeChannel(channel); 48 } 49 50 @Override 51 public void userEventTriggered(ChannelHandlerContext ctx, Object evt) { 52 // å¤„ç†ç©ºé—²äº‹ä»¶ 53 if (evt instanceof IdleStateEvent) { 54 IdleStateEvent event = (IdleStateEvent) evt; 55 if (event.state() == IdleState.READER_IDLE) { 56 log.warn(\u0026#34;å®¢æˆ·ç«¯ {} è¯»ç©ºé—²ï¼Œå…³é—­è¿æ¥\u0026#34;, ctx.channel().id().asShortText()); 57 ctx.close(); 58 } 59 } 60 } 61 62 @Override 63 public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) { 64 log.error(\u0026#34;è¿æ¥å¼‚å¸¸ï¼š{}\u0026#34;, cause.getMessage(), cause); 65 ctx.close(); 66 } 67 68 /** 69 * å¤„ç†è®¤è¯æ¶ˆæ¯ 70 */ 71 private void handleAuth(ChannelHandlerContext ctx, Message message) { 72 String userId = message.getUserId(); 73 Channel channel = ctx.channel(); 74 75 // ç»‘å®šç”¨æˆ· ID å’Œ Channel 76 ChannelManager.bindUser(userId, channel); 77 78 // å‘é€è®¤è¯æˆåŠŸæ¶ˆæ¯ 79 Message response = Message.builder() 80 .type(\u0026#34;auth_response\u0026#34;) 81 .content(\u0026#34;è®¤è¯æˆåŠŸ\u0026#34;) 82 .build(); 83 ctx.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(response))); 84 85 log.info(\u0026#34;ç”¨æˆ· {} è®¤è¯æˆåŠŸ\u0026#34;, userId); 86 } 87 88 /** 89 * å¤„ç†å¿ƒè·³æ¶ˆæ¯ 90 */ 91 private void handleHeartbeat(ChannelHandlerContext ctx) { 92 Message response = Message.builder() 93 .type(\u0026#34;heartbeat_response\u0026#34;) 94 .content(\u0026#34;pong\u0026#34;) 95 .build(); 96 ctx.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(response))); 97 } 98 99 /** 100 * å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ 101 */ 102 private void handleMessage(ChannelHandlerContext ctx, Message message) { 103 // æ ¹æ®ä¸šåŠ¡é€»è¾‘å¤„ç†æ¶ˆæ¯ 104 log.info(\u0026#34;å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ï¼š{}\u0026#34;, message.getContent()); 105 106 // ç¤ºä¾‹ï¼šå¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ· 107 ChannelManager.broadcast(message); 108 } 109} è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯æ¨é€ Channel ç®¡ç†å™¨ 1@Slf4j 2public class ChannelManager { 3 4 // æ‰€æœ‰è¿æ¥çš„ Channel 5 private static final ChannelGroup CHANNELS = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE); 6 7 // ç”¨æˆ· ID ä¸ Channel çš„æ˜ å°„ 8 private static final ConcurrentHashMap\u0026lt;String, Channel\u0026gt; USER_CHANNELS = new ConcurrentHashMap\u0026lt;\u0026gt;(); 9 10 /** 11 * æ·»åŠ  Channel 12 */ 13 public static void addChannel(Channel channel) { 14 CHANNELS.add(channel); 15 log.info(\u0026#34;å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}\u0026#34;, CHANNELS.size()); 16 } 17 18 /** 19 * ç§»é™¤ Channel 20 */ 21 public static void removeChannel(Channel channel) { 22 CHANNELS.remove(channel); 23 24 // ç§»é™¤ç”¨æˆ·ç»‘å®š 25 USER_CHANNELS.entrySet().removeIf(entry -\u0026gt; entry.getValue().equals(channel)); 26 27 log.info(\u0026#34;å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}\u0026#34;, CHANNELS.size()); 28 } 29 30 /** 31 * ç»‘å®šç”¨æˆ·å’Œ Channel 32 */ 33 public static void bindUser(String userId, Channel channel) { 34 USER_CHANNELS.put(userId, channel); 35 log.info(\u0026#34;ç”¨æˆ· {} ç»‘å®šæˆåŠŸï¼Œå½“å‰åœ¨çº¿ç”¨æˆ·æ•°ï¼š{}\u0026#34;, userId, USER_CHANNELS.size()); 36 } 37 38 /** 39 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ· 40 */ 41 public static void pushToUser(String userId, Message message) { 42 Channel channel = USER_CHANNELS.get(userId); 43 if (channel != null \u0026amp;\u0026amp; channel.isActive()) { 44 channel.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(message))); 45 log.info(\u0026#34;æ¨é€æ¶ˆæ¯ç»™ç”¨æˆ· {}ï¼š{}\u0026#34;, userId, message.getContent()); 46 } else { 47 log.warn(\u0026#34;ç”¨æˆ· {} ä¸åœ¨çº¿æˆ–è¿æ¥å·²æ–­å¼€\u0026#34;, userId); 48 } 49 } 50 51 /** 52 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ· 53 */ 54 public static void broadcast(Message message) { 55 TextWebSocketFrame frame = new TextWebSocketFrame(JSON.toJSONString(message)); 56 CHANNELS.writeAndFlush(frame); 57 log.info(\u0026#34;å¹¿æ’­æ¶ˆæ¯ç»™ {} ä¸ªç”¨æˆ·ï¼š{}\u0026#34;, CHANNELS.size(), message.getContent()); 58 } 59 60 /** 61 * è·å–åœ¨çº¿ç”¨æˆ·æ•° 62 */ 63 public static int getOnlineUserCount() { 64 return USER_CHANNELS.size(); 65 } 66} æ¶ˆæ¯æ¨é€æœåŠ¡ 1@Slf4j 2@Service 3public class MessagePushService { 4 5 /** 6 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ· 7 */ 8 public void pushToUser(String userId, String content) { 9 Message message = Message.builder() 10 .type(\u0026#34;push\u0026#34;) 11 .content(content) 12 .timestamp(System.currentTimeMillis()) 13 .build(); 14 15 ChannelManager.pushToUser(userId, message); 16 } 17 18 /** 19 * æ¨é€æ¶ˆæ¯ç»™å¤šä¸ªç”¨æˆ· 20 */ 21 public void pushToUsers(List\u0026lt;String\u0026gt; userIds, String content) { 22 Message message = Message.builder() 23 .type(\u0026#34;push\u0026#34;) 24 .content(content) 25 .timestamp(System.currentTimeMillis()) 26 .build(); 27 28 userIds.forEach(userId -\u0026gt; ChannelManager.pushToUser(userId, message)); 29 } 30 31 /** 32 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ· 33 */ 34 public void broadcast(String content) { 35 Message message = Message.builder() 36 .type(\u0026#34;broadcast\u0026#34;) 37 .content(content) 38 .timestamp(System.currentTimeMillis()) 39 .build(); 40 41 ChannelManager.broadcast(message); 42 } 43} å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ä¿æ´» ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³ åœ¨é•¿è¿æ¥åœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nç½‘ç»œä¸­æ–­æ£€æµ‹ï¼šç½‘ç»œå¼‚å¸¸æ—¶ï¼ŒTCP è¿æ¥ä¸ä¼šç«‹å³æ–­å¼€ NAT è¶…æ—¶ï¼šNAT è®¾å¤‡ä¼šæ¸…ç†é•¿æ—¶é—´æ— æ•°æ®ä¼ è¾“çš„è¿æ¥ è´Ÿè½½å‡è¡¡è¶…æ—¶ï¼šè´Ÿè½½å‡è¡¡å™¨å¯èƒ½ä¼šå…³é—­ç©ºé—²è¿æ¥ å¿ƒè·³å®ç°æ–¹æ¡ˆ æœåŠ¡ç«¯å¿ƒè·³æ£€æµ‹ï¼š\n1// åœ¨ ChannelInitializer ä¸­æ·»åŠ  2pipeline.addLast(new IdleStateHandler(60, 0, 0, TimeUnit.SECONDS)); å®¢æˆ·ç«¯å¿ƒè·³å‘é€ï¼ˆJavaScript ç¤ºä¾‹ï¼‰ï¼š\n1class WebSocketClient { 2 constructor(url) { 3 this.url = url; 4 this.ws = null; 5 this.heartbeatTimer = null; 6 this.reconnectTimer = null; 7 } 8 9 connect() { 10 this.ws = new WebSocket(this.url); 11 12 this.ws.onopen = () =\u0026gt; { 13 console.log(\u0026#39;WebSocket è¿æ¥æˆåŠŸ\u0026#39;); 14 this.startHeartbeat(); 15 16 // å‘é€è®¤è¯æ¶ˆæ¯ 17 this.send({ 18 type: \u0026#39;auth\u0026#39;, 19 userId: \u0026#39;user123\u0026#39;, 20 token: \u0026#39;xxx\u0026#39; 21 }); 22 }; 23 24 this.ws.onmessage = (event) =\u0026gt; { 25 const message = JSON.parse(event.data); 26 console.log(\u0026#39;æ”¶åˆ°æ¶ˆæ¯ï¼š\u0026#39;, message); 27 28 // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ 29 switch (message.type) { 30 case \u0026#39;auth_response\u0026#39;: 31 console.log(\u0026#39;è®¤è¯æˆåŠŸ\u0026#39;); 32 break; 33 case \u0026#39;push\u0026#39;: 34 this.handlePush(message); 35 break; 36 case \u0026#39;heartbeat_response\u0026#39;: 37 // æ”¶åˆ°å¿ƒè·³å“åº” 38 break; 39 } 40 }; 41 42 this.ws.onclose = () =\u0026gt; { 43 console.log(\u0026#39;WebSocket è¿æ¥å…³é—­\u0026#39;); 44 this.stopHeartbeat(); 45 this.reconnect(); 46 }; 47 48 this.ws.onerror = (error) =\u0026gt; { 49 console.error(\u0026#39;WebSocket é”™è¯¯ï¼š\u0026#39;, error); 50 }; 51 } 52 53 send(message) { 54 if (this.ws \u0026amp;\u0026amp; this.ws.readyState === WebSocket.OPEN) { 55 this.ws.send(JSON.stringify(message)); 56 } 57 } 58 59 startHeartbeat() { 60 this.heartbeatTimer = setInterval(() =\u0026gt; { 61 this.send({ 62 type: \u0026#39;heartbeat\u0026#39;, 63 timestamp: Date.now() 64 }); 65 }, 30000); // æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ 66 } 67 68 stopHeartbeat() { 69 if (this.heartbeatTimer) { 70 clearInterval(this.heartbeatTimer); 71 this.heartbeatTimer = null; 72 } 73 } 74 75 reconnect() { 76 if (this.reconnectTimer) { 77 return; 78 } 79 80 this.reconnectTimer = setTimeout(() =\u0026gt; { 81 console.log(\u0026#39;å°è¯•é‡æ–°è¿æ¥...\u0026#39;); 82 this.reconnectTimer = null; 83 this.connect(); 84 }, 5000); // 5 ç§’åé‡è¿ 85 } 86 87 handlePush(message) { 88 // å¤„ç†æ¨é€æ¶ˆæ¯ 89 console.log(\u0026#39;æ”¶åˆ°æ¨é€ï¼š\u0026#39;, message.content); 90 } 91 92 close() { 93 this.stopHeartbeat(); 94 if (this.ws) { 95 this.ws.close(); 96 } 97 } 98} 99 100// ä½¿ç”¨ç¤ºä¾‹ 101const client = new WebSocketClient(\u0026#39;ws://localhost:8888/ws\u0026#39;); 102client.connect(); é¿å‘æç¤ºï¼š å¿ƒè·³é—´éš”çš„è®¾ç½®éœ€è¦æƒè¡¡ï¼šé—´éš”å¤ªçŸ­ä¼šå¢åŠ æœåŠ¡å™¨å‹åŠ›ï¼Œé—´éš”å¤ªé•¿å¯èƒ½æ— æ³•åŠæ—¶å‘ç°è¿æ¥æ–­å¼€ã€‚å»ºè®®å®¢æˆ·ç«¯å¿ƒè·³é—´éš”ä¸º 30 ç§’ï¼ŒæœåŠ¡ç«¯è¶…æ—¶æ—¶é—´ä¸º 60 ç§’ã€‚\né›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”± å•æœºæ¶æ„çš„å±€é™ å•æœº WebSocket æœåŠ¡å™¨å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nè¿æ¥æ•°é™åˆ¶ï¼šå•æœºæœ€å¤šæ”¯æŒå‡ ä¸‡åˆ°åå‡ ä¸‡è¿æ¥ å•ç‚¹æ•…éšœï¼šæœåŠ¡å™¨å®•æœºå¯¼è‡´æ‰€æœ‰è¿æ¥æ–­å¼€ æ¶ˆæ¯è·¯ç”±ï¼šæ— æ³•æ¨é€æ¶ˆæ¯ç»™å…¶ä»–æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ· é›†ç¾¤æ¶æ„æ–¹æ¡ˆ 1 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2 â”‚ Nginx â”‚ 3 â”‚ (è´Ÿè½½å‡è¡¡) â”‚ 4 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ 5 â”‚ 6 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 7 â”‚ â”‚ â”‚ 8 â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” 9 â”‚ WS Serverâ”‚ â”‚ WS Serverâ”‚ â”‚ WS Serverâ”‚ 10 â”‚ Node1 â”‚ â”‚ Node2 â”‚ â”‚ Node3 â”‚ 11 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ 12 â”‚ â”‚ â”‚ 13 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 14 â”‚ 15 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” 16 â”‚ Redis â”‚ 17 â”‚ (æ¶ˆæ¯è·¯ç”±) â”‚ 18 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Nginx é…ç½® 1upstream websocket { 2 # IP Hash ç­–ç•¥ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·è¿æ¥åˆ°åŒä¸€å°æœåŠ¡å™¨ 3 ip_hash; 4 5 server 192.168.1.101:8888; 6 server 192.168.1.102:8888; 7 server 192.168.1.103:8888; 8} 9 10server { 11 listen 80; 12 server_name ws.example.com; 13 14 location /ws { 15 proxy_pass http://websocket; 16 proxy_http_version 1.1; 17 proxy_set_header Upgrade $http_upgrade; 18 proxy_set_header Connection \u0026#34;upgrade\u0026#34;; 19 proxy_set_header Host $host; 20 proxy_set_header X-Real-IP $remote_addr; 21 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 22 23 # è¶…æ—¶è®¾ç½® 24 proxy_connect_timeout 60s; 25 proxy_send_timeout 60s; 26 proxy_read_timeout 60s; 27 } 28} Redis æ¶ˆæ¯è·¯ç”± 1@Slf4j 2@Component 3public class RedisMessageRouter { 4 5 @Autowired 6 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 7 8 private static final String CHANNEL_PREFIX = \u0026#34;ws:message:\u0026#34;; 9 10 @PostConstruct 11 public void init() { 12 // è®¢é˜… Redis é¢‘é“ 13 redisTemplate.getConnectionFactory().getConnection() 14 .subscribe((message, pattern) -\u0026gt; { 15 String msg = new String(message.getBody()); 16 handleMessage(msg); 17 }, (CHANNEL_PREFIX + \u0026#34;*\u0026#34;).getBytes()); 18 } 19 20 /** 21 * å‘å¸ƒæ¶ˆæ¯åˆ° Redis 22 */ 23 public void publish(String userId, Message message) { 24 String channel = CHANNEL_PREFIX + userId; 25 redisTemplate.convertAndSend(channel, JSON.toJSONString(message)); 26 } 27 28 /** 29 * å¤„ç†ä» Redis æ¥æ”¶åˆ°çš„æ¶ˆæ¯ 30 */ 31 private void handleMessage(String msg) { 32 Message message = JSON.parseObject(msg, Message.class); 33 String userId = message.getUserId(); 34 35 // å¦‚æœç”¨æˆ·åœ¨æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥æ¨é€ 36 ChannelManager.pushToUser(userId, message); 37 } 38} æ”¹è¿›çš„æ¨é€æœåŠ¡ 1@Slf4j 2@Service 3public class ClusterMessagePushService { 4 5 @Autowired 6 private RedisMessageRouter redisMessageRouter; 7 8 @Autowired 9 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 10 11 /** 12 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰ 13 */ 14 public void pushToUser(String userId, String content) { 15 Message message = Message.builder() 16 .type(\u0026#34;push\u0026#34;) 17 .userId(userId) 18 .content(content) 19 .timestamp(System.currentTimeMillis()) 20 .build(); 21 22 // å…ˆå°è¯•æœ¬åœ°æ¨é€ 23 Channel channel = ChannelManager.getUserChannel(userId); 24 if (channel != null \u0026amp;\u0026amp; channel.isActive()) { 25 ChannelManager.pushToUser(userId, message); 26 } else { 27 // ç”¨æˆ·ä¸åœ¨æœ¬èŠ‚ç‚¹ï¼Œé€šè¿‡ Redis è·¯ç”± 28 redisMessageRouter.publish(userId, message); 29 } 30 } 31 32 /** 33 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰ 34 */ 35 public void broadcast(String content) { 36 Message message = Message.builder() 37 .type(\u0026#34;broadcast\u0026#34;) 38 .content(content) 39 .timestamp(System.currentTimeMillis()) 40 .build(); 41 42 // å‘å¸ƒåˆ° Redis å¹¿æ’­é¢‘é“ 43 redisTemplate.convertAndSend(\u0026#34;ws:broadcast\u0026#34;, JSON.toJSONString(message)); 44 } 45} æ¶æ„æ€è€ƒï¼š åœ¨é›†ç¾¤æ¶æ„ä¸­ï¼Œæ¶ˆæ¯è·¯ç”±æ˜¯æ ¸å¿ƒé—®é¢˜ã€‚é™¤äº† Redis Pub/Subï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ RocketMQã€Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—ã€‚é€‰æ‹©æ—¶éœ€è¦è€ƒè™‘ï¼š1) æ¶ˆæ¯å¯é æ€§è¦æ±‚ï¼›2) æ¶ˆæ¯é¡ºåºæ€§è¦æ±‚ï¼›3) ç³»ç»Ÿå¤æ‚åº¦ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜ä½†å¯é æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼ŒRedis Pub/Sub æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚\nç”Ÿäº§ç¯å¢ƒä¼˜åŒ– æ€§èƒ½ä¼˜åŒ– 1. çº¿ç¨‹æ± é…ç½®\n1// Boss çº¿ç¨‹ç»„ï¼šå¤„ç†è¿æ¥è¯·æ±‚ 2EventLoopGroup bossGroup = new NioEventLoopGroup(1); 3 4// Worker çº¿ç¨‹ç»„ï¼šå¤„ç† I/O æ“ä½œ 5// é»˜è®¤çº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2 6EventLoopGroup workerGroup = new NioEventLoopGroup(); 7 8// ä¸šåŠ¡çº¿ç¨‹æ± ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ 9ThreadPoolExecutor businessExecutor = new ThreadPoolExecutor( 10 10, 50, 60L, TimeUnit.SECONDS, 11 new LinkedBlockingQueue\u0026lt;\u0026gt;(1000), 12 new ThreadFactoryBuilder().setNameFormat(\u0026#34;business-%d\u0026#34;).build(), 13 new ThreadPoolExecutor.CallerRunsPolicy() 14); 2. å†…å­˜ä¼˜åŒ–\n1// ä½¿ç”¨æ± åŒ–çš„ ByteBuf 2bootstrap.option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); 3bootstrap.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); 4 5// è®¾ç½®æ¥æ”¶ç¼“å†²åŒºå¤§å° 6bootstrap.childOption(ChannelOption.RCVBUF_ALLOCATOR, 7 new AdaptiveRecvByteBufAllocator(64, 1024, 65536)); 3. è¿æ¥æ•°ä¼˜åŒ–\n1// å¢åŠ  TCP è¿æ¥é˜Ÿåˆ—é•¿åº¦ 2bootstrap.option(ChannelOption.SO_BACKLOG, 1024); 3 4// å¯ç”¨ TCP_NODELAYï¼ˆç¦ç”¨ Nagle ç®—æ³•ï¼‰ 5bootstrap.childOption(ChannelOption.TCP_NODELAY, true); 6 7// å¯ç”¨ SO_KEEPALIVE 8bootstrap.childOption(ChannelOption.SO_KEEPALIVE, true); ç›‘æ§æŒ‡æ ‡ 1@Component 2public class WebSocketMetrics { 3 4 private final AtomicLong totalConnections = new AtomicLong(0); 5 private final AtomicLong activeConnections = new AtomicLong(0); 6 private final AtomicLong totalMessages = new AtomicLong(0); 7 8 /** 9 * è®°å½•è¿æ¥å»ºç«‹ 10 */ 11 public void recordConnect() { 12 totalConnections.incrementAndGet(); 13 activeConnections.incrementAndGet(); 14 } 15 16 /** 17 * è®°å½•è¿æ¥æ–­å¼€ 18 */ 19 public void recordDisconnect() { 20 activeConnections.decrementAndGet(); 21 } 22 23 /** 24 * è®°å½•æ¶ˆæ¯å‘é€ 25 */ 26 public void recordMessage() { 27 totalMessages.incrementAndGet(); 28 } 29 30 /** 31 * è·å–ç›‘æ§æ•°æ® 32 */ 33 public Map\u0026lt;String, Object\u0026gt; getMetrics() { 34 Map\u0026lt;String, Object\u0026gt; metrics = new HashMap\u0026lt;\u0026gt;(); 35 metrics.put(\u0026#34;totalConnections\u0026#34;, totalConnections.get()); 36 metrics.put(\u0026#34;activeConnections\u0026#34;, activeConnections.get()); 37 metrics.put(\u0026#34;totalMessages\u0026#34;, totalMessages.get()); 38 metrics.put(\u0026#34;onlineUsers\u0026#34;, ChannelManager.getOnlineUserCount()); 39 return metrics; 40 } 41} å®‰å…¨åŠ å›º 1. è®¤è¯é‰´æƒ\n1private void handleAuth(ChannelHandlerContext ctx, Message message) { 2 String token = message.getToken(); 3 4 // éªŒè¯ Token 5 if (!validateToken(token)) { 6 ctx.writeAndFlush(new TextWebSocketFrame( 7 JSON.toJSONString(Message.builder() 8 .type(\u0026#34;auth_response\u0026#34;) 9 .code(401) 10 .content(\u0026#34;è®¤è¯å¤±è´¥\u0026#34;) 11 .build()) 12 )); 13 ctx.close(); 14 return; 15 } 16 17 // è®¤è¯æˆåŠŸï¼Œç»‘å®šç”¨æˆ· 18 String userId = getUserIdFromToken(token); 19 ChannelManager.bindUser(userId, ctx.channel()); 20} 2. æ¶ˆæ¯é™æµ\n1@Component 2public class MessageRateLimiter { 3 4 private final LoadingCache\u0026lt;String, RateLimiter\u0026gt; limiters = CacheBuilder.newBuilder() 5 .maximumSize(10000) 6 .expireAfterAccess(1, TimeUnit.HOURS) 7 .build(new CacheLoader\u0026lt;String, RateLimiter\u0026gt;() { 8 @Override 9 public RateLimiter load(String key) { 10 // æ¯ç§’æœ€å¤š 10 æ¡æ¶ˆæ¯ 11 return RateLimiter.create(10.0); 12 } 13 }); 14 15 public boolean tryAcquire(String userId) { 16 try { 17 RateLimiter limiter = limiters.get(userId); 18 return limiter.tryAcquire(); 19 } catch (ExecutionException e) { 20 return false; 21 } 22 } 23} 3. XSS é˜²æŠ¤\n1private String sanitizeContent(String content) { 2 // è¿‡æ»¤ HTML æ ‡ç­¾å’Œè„šæœ¬ 3 return content.replaceAll(\u0026#34;\u0026lt;[^\u0026gt;]*\u0026gt;\u0026#34;, \u0026#34;\u0026#34;) 4 .replaceAll(\u0026#34;javascript:\u0026#34;, \u0026#34;\u0026#34;) 5 .replaceAll(\u0026#34;on\\\\w+\\\\s*=\u0026#34;, \u0026#34;\u0026#34;); 6} é¿å‘æç¤ºï¼š ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå®‰å…¨æ€§è‡³å…³é‡è¦ã€‚é™¤äº†ä¸Šè¿°æªæ–½ï¼Œè¿˜éœ€è¦ï¼š1) ä½¿ç”¨ WSSï¼ˆWebSocket over TLSï¼‰åŠ å¯†ä¼ è¾“ï¼›2) è®¾ç½®åˆç†çš„æ¶ˆæ¯å¤§å°é™åˆ¶ï¼›3) å®æ–½ IP é»‘ç™½åå•ï¼›4) è®°å½•å®¡è®¡æ—¥å¿—ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–äº†ä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜çš„å®Œæ•´å†…å®¹ï¼š\nåè®®åŸç†ï¼šç†è§£ WebSocket æ¡æ‰‹æµç¨‹å’Œæ•°æ®å¸§æ ¼å¼ æœåŠ¡å™¨å®ç°ï¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨ è¿æ¥ç®¡ç†ï¼šå®ç° Channel ç®¡ç†å’Œæ¶ˆæ¯æ¨é€ å¿ƒè·³æœºåˆ¶ï¼šä¿è¯è¿æ¥å¯é æ€§å’ŒåŠæ—¶æ£€æµ‹æ–­çº¿ é›†ç¾¤éƒ¨ç½²ï¼šé€šè¿‡ Redis å®ç°è·¨èŠ‚ç‚¹æ¶ˆæ¯è·¯ç”± æ€§èƒ½ä¼˜åŒ–ï¼šçº¿ç¨‹æ± ã€å†…å­˜ã€è¿æ¥æ•°ç­‰å¤šæ–¹é¢ä¼˜åŒ– å®‰å…¨åŠ å›ºï¼šè®¤è¯é‰´æƒã€é™æµã€XSS é˜²æŠ¤ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯è¿›è¡Œè°ƒæ•´ã€‚ä¾‹å¦‚ï¼š\nå³æ—¶é€šè®¯ï¼šéœ€è¦è€ƒè™‘æ¶ˆæ¯å¯é æ€§ã€ç¦»çº¿æ¶ˆæ¯ã€æ¶ˆæ¯é¡ºåº åœ¨çº¿å®¢æœï¼šéœ€è¦è€ƒè™‘ä¼šè¯ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±ã€å®¢æœåˆ†é… å®æ—¶ç›‘æ§ï¼šéœ€è¦è€ƒè™‘æ•°æ®èšåˆã€å‘Šè­¦æ¨é€ã€å¤§å±å±•ç¤º ä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°å®æ—¶æ¶ˆæ¯æ¨é€åŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯• Netty + WebSocket è¿™ä¸ªå¼ºå¤§çš„ç»„åˆã€‚\n","permalink":"http://localhost:1313/posts/2025/04/netty--websocket-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå®æ—¶æ¶ˆæ¯æ¨é€å·²æˆä¸ºæ ‡é…åŠŸèƒ½ã€‚ä»å³æ—¶é€šè®¯ã€åœ¨çº¿å®¢æœåˆ°å®æ—¶ç›‘æ§å¤§å±ï¼Œéƒ½ç¦»ä¸å¼€é«˜æ€§èƒ½çš„æ¶ˆæ¯æ¨é€èƒ½åŠ›ã€‚ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼å­˜åœ¨å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹ç­‰é—®é¢˜ï¼Œè€Œ WebSocket åè®®çš„å‡ºç°å®Œç¾è§£å†³äº†è¿™äº›ç—›ç‚¹ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty æ¡†æ¶å®ç°åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜ï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¨é€æœåŠ¡ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ WebSocket åè®®åŸç†ä¸æ¡æ‰‹æµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ç®¡ç†ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆé€‰æ‹©-netty--websocket\"\u003eä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket\u003c/h2\u003e\n\u003ch3 id=\"websocket-åè®®ä¼˜åŠ¿\"\u003eWebSocket åè®®ä¼˜åŠ¿\u003c/h3\u003e\n\u003cp\u003eç›¸æ¯”ä¼ ç»Ÿçš„ HTTP è½®è¯¢ï¼ŒWebSocket å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eç‰¹æ€§\u003c/th\u003e\n          \u003cth\u003eHTTP è½®è¯¢\u003c/th\u003e\n          \u003cth\u003eWebSocket\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eé€šä¿¡æ–¹å¼\u003c/td\u003e\n          \u003ctd\u003eåŠåŒå·¥\u003c/td\u003e\n          \u003ctd\u003eå…¨åŒå·¥\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eè¿æ¥å¼€é”€\u003c/td\u003e\n          \u003ctd\u003eæ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥\u003c/td\u003e\n          \u003ctd\u003eä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå®æ—¶æ€§\u003c/td\u003e\n          \u003ctd\u003eå–å†³äºè½®è¯¢é—´éš”ï¼ˆç§’çº§ï¼‰\u003c/td\u003e\n          \u003ctd\u003eæ¯«ç§’çº§\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eæœåŠ¡å™¨å‹åŠ›\u003c/td\u003e\n          \u003ctd\u003eé«˜ï¼ˆé¢‘ç¹çš„ HTTP è¯·æ±‚ï¼‰\u003c/td\u003e\n          \u003ctd\u003eä½ï¼ˆé•¿è¿æ¥ï¼‰\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå¸¦å®½æ¶ˆè€—\u003c/td\u003e\n          \u003ctd\u003eé«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰ HTTP å¤´ï¼‰\u003c/td\u003e\n          \u003ctd\u003eä½ï¼ˆåªä¼ è¾“æ•°æ®å¸§ï¼‰\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"netty-æ¡†æ¶ä¼˜åŠ¿\"\u003eNetty æ¡†æ¶ä¼˜åŠ¿\u003c/h3\u003e\n\u003cp\u003eNetty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eé«˜æ€§èƒ½\u003c/strong\u003eï¼šåŸºäº NIOï¼Œæ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ˜“ç”¨æ€§\u003c/strong\u003eï¼šæä¾›äº†ä¸°å¯Œçš„ç¼–è§£ç å™¨å’Œå¤„ç†å™¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç¨³å®šæ€§\u003c/strong\u003eï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ‰©å±•æ€§\u003c/strong\u003eï¼šçµæ´»çš„ Pipeline æœºåˆ¶\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œä¸ä»…è¦çœ‹æŠ€æœ¯æœ¬èº«çš„ä¼˜åŠ¿ï¼Œæ›´è¦è€ƒè™‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€è¿ç»´æˆæœ¬å’Œç¤¾åŒºç”Ÿæ€ã€‚Netty åœ¨ Java ç”Ÿæ€ä¸­å·²ç»æˆä¸ºäº‹å®æ ‡å‡†ï¼ŒDubboã€RocketMQã€Elasticsearch ç­‰çŸ¥åé¡¹ç›®éƒ½åœ¨ä½¿ç”¨ã€‚\u003c/p\u003e","title":"Netty + WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜"},{"content":"åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚ä½†ç¼“å­˜ä½¿ç”¨ä¸å½“ä¼šå¼•å‘ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æè¿™äº›é—®é¢˜çš„åŸç†ï¼Œå¹¶æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„æœ¬è´¨åŒºåˆ« æŒæ¡å¸ƒéš†è¿‡æ»¤å™¨ã€äº’æ–¥é”ç­‰é˜²æŠ¤æ‰‹æ®µ å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„ç¼“å­˜æ¶æ„ äº†è§£ç¼“å­˜é¢„çƒ­ã€é™çº§ç­‰æœ€ä½³å®è·µ ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜ é—®é¢˜å¯¹æ¯” é—®é¢˜ åŸå›  å½±å“ è§£å†³æ–¹æ¡ˆ ç¼“å­˜ç©¿é€ æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® å¤§é‡è¯·æ±‚æ‰“åˆ°DB å¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜ ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹keyè¿‡æœŸ ç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°DB äº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ ç¼“å­˜é›ªå´© å¤§é‡keyåŒæ—¶è¿‡æœŸ DBå‹åŠ›éª¤å¢ è¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜ ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® é—®é¢˜åœºæ™¯ 1// æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID 2for (int i = -1000000; i \u0026lt; 0; i--) { 3 User user = getUser(i); // ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æŸ¥DB 4} æµç¨‹ï¼š\n1è¯·æ±‚ â†’ æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ æŸ¥æ•°æ®åº“ï¼ˆæœªå‘½ä¸­ï¼‰â†’ è¿”å›null æ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\nè§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨ åŸç†ï¼š ç”¨ä½æ•°ç»„åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚\n1@Configuration 2public class BloomFilterConfig { 3 4 @Bean 5 public BloomFilter\u0026lt;Long\u0026gt; userBloomFilter() { 6 // é¢„æœŸå…ƒç´ æ•°é‡ï¼š1000ä¸‡ï¼Œè¯¯åˆ¤ç‡ï¼š0.01% 7 BloomFilter\u0026lt;Long\u0026gt; bloomFilter = BloomFilter.create( 8 Funnels.longFunnel(), 9 10000000, 10 0.0001 11 ); 12 13 // åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ 14 List\u0026lt;Long\u0026gt; userIds = userMapper.selectAllIds(); 15 userIds.forEach(bloomFilter::put); 16 17 return bloomFilter; 18 } 19} 1@Service 2public class UserService { 3 4 @Autowired 5 private BloomFilter\u0026lt;Long\u0026gt; userBloomFilter; 6 7 @Autowired 8 private RedisTemplate\u0026lt;String, User\u0026gt; redisTemplate; 9 10 @Autowired 11 private UserMapper userMapper; 12 13 public User getUser(Long userId) { 14 // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ 15 if (!userBloomFilter.mightContain(userId)) { 16 return null; // ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å› 17 } 18 19 // 2. æŸ¥ç¼“å­˜ 20 String key = \u0026#34;user:\u0026#34; + userId; 21 User user = redisTemplate.opsForValue().get(key); 22 if (user != null) { 23 return user; 24 } 25 26 // 3. æŸ¥æ•°æ®åº“ 27 user = userMapper.selectById(userId); 28 if (user != null) { 29 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 30 } 31 32 return user; 33 } 34} ä¼˜ç‚¹ï¼š\nå†…å­˜å ç”¨å°ï¼ˆ1000ä¸‡æ•°æ®åªéœ€çº¦12MBï¼‰ æŸ¥è¯¢é€Ÿåº¦å¿«ï¼ˆO(k)ï¼Œkä¸ºå“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼‰ ç¼ºç‚¹ï¼š\nå­˜åœ¨è¯¯åˆ¤ï¼ˆå¯èƒ½åˆ¤æ–­å­˜åœ¨ä½†å®é™…ä¸å­˜åœ¨ï¼‰ æ— æ³•åˆ é™¤å…ƒç´  è§£å†³æ–¹æ¡ˆ2ï¼šç¼“å­˜ç©ºå€¼ 1public User getUser(Long userId) { 2 String key = \u0026#34;user:\u0026#34; + userId; 3 4 // 1. æŸ¥ç¼“å­˜ 5 User user = redisTemplate.opsForValue().get(key); 6 if (user != null) { 7 // ç©ºå¯¹è±¡æ ‡è®° 8 if (user.getId() == null) { 9 return null; 10 } 11 return user; 12 } 13 14 // 2. æŸ¥æ•°æ®åº“ 15 user = userMapper.selectById(userId); 16 17 // 3. ç¼“å­˜ç»“æœï¼ˆåŒ…æ‹¬nullï¼‰ 18 if (user == null) { 19 // ç¼“å­˜ç©ºå¯¹è±¡ï¼Œè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ 20 User emptyUser = new User(); 21 redisTemplate.opsForValue().set(key, emptyUser, 5, TimeUnit.MINUTES); 22 } else { 23 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 24 } 25 26 return user; 27} ä¼˜ç‚¹ï¼š\nå®ç°ç®€å• å¯ä»¥é˜²æ­¢åŒä¸€ä¸ªä¸å­˜åœ¨çš„keyåå¤æŸ¥è¯¢ ç¼ºç‚¹ï¼š\nå ç”¨ç¼“å­˜ç©ºé—´ å¯èƒ½ç¼“å­˜å¤§é‡æ— æ•ˆæ•°æ® è§£å†³æ–¹æ¡ˆ3ï¼šå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜ 1public User getUser(Long userId) { 2 // 1. å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­ 3 if (!userBloomFilter.mightContain(userId)) { 4 return null; 5 } 6 7 String key = \u0026#34;user:\u0026#34; + userId; 8 9 // 2. æŸ¥ç¼“å­˜ï¼ˆåŒ…æ‹¬ç©ºå€¼ï¼‰ 10 User user = redisTemplate.opsForValue().get(key); 11 if (user != null) { 12 return user.getId() == null ? null : user; 13 } 14 15 // 3. æŸ¥æ•°æ®åº“ 16 user = userMapper.selectById(userId); 17 18 // 4. ç¼“å­˜ç»“æœ 19 if (user == null) { 20 User emptyUser = new User(); 21 redisTemplate.opsForValue().set(key, emptyUser, 5, TimeUnit.MINUTES); 22 } else { 23 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 24 } 25 26 return user; 27} æ¶æ„æ€è€ƒï¼š å¸ƒéš†è¿‡æ»¤å™¨é€‚åˆè¿‡æ»¤å¤§éƒ¨åˆ†ä¸å­˜åœ¨çš„è¯·æ±‚ï¼Œç©ºå€¼ç¼“å­˜é€‚åˆå¤„ç†å°‘é‡ä¸å­˜åœ¨ä½†è¢«é¢‘ç¹æŸ¥è¯¢çš„keyã€‚ä¸¤è€…ç»“åˆä½¿ç”¨ï¼Œå¯ä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœã€‚\nç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyè¿‡æœŸ é—®é¢˜åœºæ™¯ 1çƒ­ç‚¹å•†å“è¯¦æƒ…é¡µï¼Œç¼“å­˜è¿‡æœŸç¬é—´ï¼Œ1000ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“ æµç¨‹ï¼š\n1æ—¶åˆ»Tï¼šç¼“å­˜è¿‡æœŸ 2æ—¶åˆ»T+1msï¼š1000ä¸ªè¯·æ±‚åŒæ—¶æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ åŒæ—¶æŸ¥æ•°æ®åº“ è§£å†³æ–¹æ¡ˆ1ï¼šäº’æ–¥é” 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // 1. æŸ¥ç¼“å­˜ 5 Product product = redisTemplate.opsForValue().get(key); 6 if (product != null) { 7 return product; 8 } 9 10 // 2. è·å–äº’æ–¥é” 11 String lockKey = \u0026#34;lock:product:\u0026#34; + productId; 12 Boolean locked = redisTemplate.opsForValue() 13 .setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS); 14 15 if (locked) { 16 try { 17 // 3. åŒé‡æ£€æŸ¥ 18 product = redisTemplate.opsForValue().get(key); 19 if (product != null) { 20 return product; 21 } 22 23 // 4. æŸ¥æ•°æ®åº“ 24 product = productMapper.selectById(productId); 25 26 // 5. å†™å…¥ç¼“å­˜ 27 if (product != null) { 28 redisTemplate.opsForValue().set(key, product, 1, TimeUnit.HOURS); 29 } 30 31 return product; 32 } finally { 33 // 6. é‡Šæ”¾é” 34 redisTemplate.delete(lockKey); 35 } 36 } else { 37 // 7. æœªè·å–åˆ°é”ï¼Œç­‰å¾…åé‡è¯• 38 try { 39 Thread.sleep(50); 40 } catch (InterruptedException e) { 41 Thread.currentThread().interrupt(); 42 } 43 return getProduct(productId); // é€’å½’é‡è¯• 44 } 45} ä¼˜ç‚¹ï¼š\nä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®åº“ å®ç°ç®€å• ç¼ºç‚¹ï¼š\nå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾… å¯èƒ½å¯¼è‡´è¯·æ±‚å †ç§¯ è§£å†³æ–¹æ¡ˆ2ï¼šé€»è¾‘è¿‡æœŸ 1@Data 2public class CacheData\u0026lt;T\u0026gt; { 3 private T data; 4 private LocalDateTime expireTime; 5} 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // 1. æŸ¥ç¼“å­˜ï¼ˆæ°¸ä¸è¿‡æœŸï¼‰ 5 CacheData\u0026lt;Product\u0026gt; cacheData = redisTemplate.opsForValue().get(key); 6 7 if (cacheData == null) { 8 // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ 9 return loadAndCache(productId); 10 } 11 12 // 2. åˆ¤æ–­é€»è¾‘è¿‡æœŸ 13 if (cacheData.getExpireTime().isBefore(LocalDateTime.now())) { 14 // 3. å¼‚æ­¥æ›´æ–°ç¼“å­˜ 15 String lockKey = \u0026#34;lock:product:\u0026#34; + productId; 16 Boolean locked = redisTemplate.opsForValue() 17 .setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS); 18 19 if (locked) { 20 CompletableFuture.runAsync(() -\u0026gt; { 21 try { 22 loadAndCache(productId); 23 } finally { 24 redisTemplate.delete(lockKey); 25 } 26 }); 27 } 28 } 29 30 // 4. è¿”å›æ—§æ•°æ® 31 return cacheData.getData(); 32} 33 34private Product loadAndCache(Long productId) { 35 Product product = productMapper.selectById(productId); 36 if (product != null) { 37 CacheData\u0026lt;Product\u0026gt; cacheData = new CacheData\u0026lt;\u0026gt;(); 38 cacheData.setData(product); 39 cacheData.setExpireTime(LocalDateTime.now().plusHours(1)); 40 41 redisTemplate.opsForValue().set(\u0026#34;product:\u0026#34; + productId, cacheData); 42 } 43 return product; 44} ä¼˜ç‚¹ï¼š\nä¸ä¼šé˜»å¡è¯·æ±‚ å§‹ç»ˆè¿”å›æ•°æ®ï¼ˆå³ä½¿æ˜¯æ—§æ•°æ®ï¼‰ ç¼ºç‚¹ï¼š\nå¯èƒ½è¿”å›è¿‡æœŸæ•°æ® å®ç°å¤æ‚ è§£å†³æ–¹æ¡ˆ3ï¼šçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // çƒ­ç‚¹å•†å“æ°¸ä¸è¿‡æœŸ 5 Product product = redisTemplate.opsForValue().get(key); 6 if (product != null) { 7 return product; 8 } 9 10 // æŸ¥æ•°æ®åº“å¹¶ç¼“å­˜ï¼ˆä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰ 11 product = productMapper.selectById(productId); 12 if (product != null) { 13 redisTemplate.opsForValue().set(key, product); 14 } 15 16 return product; 17} 18 19// é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ›´æ–°ç¼“å­˜ 20@RabbitListener(queues = \u0026#34;product.update\u0026#34;) 21public void updateProductCache(Long productId) { 22 Product product = productMapper.selectById(productId); 23 redisTemplate.opsForValue().set(\u0026#34;product:\u0026#34; + productId, product); 24} ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸ é—®é¢˜åœºæ™¯ 1å‡Œæ™¨2ç‚¹ï¼Œç³»ç»Ÿé‡å¯ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶åŠ è½½ï¼Œè®¾ç½®1å°æ—¶è¿‡æœŸ 2å‡Œæ™¨3ç‚¹ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ è§£å†³æ–¹æ¡ˆ1ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ– 1public void setCache(String key, Object value, long baseExpireSeconds) { 2 // åœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¸Šå¢åŠ éšæœºå€¼ 3 long randomSeconds = ThreadLocalRandom.current().nextLong(0, 300); 4 long expireSeconds = baseExpireSeconds + randomSeconds; 5 6 redisTemplate.opsForValue().set(key, value, expireSeconds, TimeUnit.SECONDS); 7} 1// ä½¿ç”¨ç¤ºä¾‹ 2setCache(\u0026#34;user:1\u0026#34;, user, 3600); // 3600 ~ 3900ç§’ 3setCache(\u0026#34;user:2\u0026#34;, user, 3600); // 3600 ~ 3900ç§’ è§£å†³æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜ 1è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â†’ Redis â†’ æ•°æ®åº“ 1@Configuration 2public class CacheConfig { 3 4 @Bean 5 public Cache\u0026lt;String, Object\u0026gt; localCache() { 6 return Caffeine.newBuilder() 7 .maximumSize(10000) 8 .expireAfterWrite(5, TimeUnit.MINUTES) 9 .build(); 10 } 11} 1@Service 2public class UserService { 3 4 @Autowired 5 private Cache\u0026lt;String, Object\u0026gt; localCache; 6 7 @Autowired 8 private RedisTemplate\u0026lt;String, User\u0026gt; redisTemplate; 9 10 @Autowired 11 private UserMapper userMapper; 12 13 public User getUser(Long userId) { 14 String key = \u0026#34;user:\u0026#34; + userId; 15 16 // 1. æŸ¥æœ¬åœ°ç¼“å­˜ 17 User user = (User) localCache.getIfPresent(key); 18 if (user != null) { 19 return user; 20 } 21 22 // 2. æŸ¥Redis 23 user = redisTemplate.opsForValue().get(key); 24 if (user != null) { 25 localCache.put(key, user); 26 return user; 27 } 28 29 // 3. æŸ¥æ•°æ®åº“ 30 user = userMapper.selectById(userId); 31 if (user != null) { 32 // å†™å…¥Rediså’Œæœ¬åœ°ç¼“å­˜ 33 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 34 localCache.put(key, user); 35 } 36 37 return user; 38 } 39} è§£å†³æ–¹æ¡ˆ3ï¼šç¼“å­˜é¢„çƒ­ 1@Component 2public class CacheWarmUp implements ApplicationRunner { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; 6 7 @Autowired 8 private ProductMapper productMapper; 9 10 @Override 11 public void run(ApplicationArguments args) { 12 log.info(\u0026#34;å¼€å§‹ç¼“å­˜é¢„çƒ­...\u0026#34;); 13 14 // åŠ è½½çƒ­ç‚¹å•†å“ 15 List\u0026lt;Product\u0026gt; hotProducts = productMapper.selectHotProducts(100); 16 for (Product product : hotProducts) { 17 String key = \u0026#34;product:\u0026#34; + product.getId(); 18 long expireSeconds = 3600 + ThreadLocalRandom.current().nextLong(0, 300); 19 redisTemplate.opsForValue().set(key, product, expireSeconds, TimeUnit.SECONDS); 20 } 21 22 log.info(\u0026#34;ç¼“å­˜é¢„çƒ­å®Œæˆï¼Œå…±åŠ è½½ {} ä¸ªå•†å“\u0026#34;, hotProducts.size()); 23 } 24} è§£å†³æ–¹æ¡ˆ4ï¼šé™æµé™çº§ 1@Service 2public class ProductService { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Product\u0026gt; redisTemplate; 6 7 @Autowired 8 private ProductMapper productMapper; 9 10 /** 11 * ä½¿ç”¨ Sentinel é™æµ 12 */ 13 @SentinelResource( 14 value = \u0026#34;getProduct\u0026#34;, 15 blockHandler = \u0026#34;getProductBlockHandler\u0026#34;, 16 fallback = \u0026#34;getProductFallback\u0026#34; 17 ) 18 public Product getProduct(Long productId) { 19 String key = \u0026#34;product:\u0026#34; + productId; 20 21 // æŸ¥ç¼“å­˜ 22 Product product = redisTemplate.opsForValue().get(key); 23 if (product != null) { 24 return product; 25 } 26 27 // æŸ¥æ•°æ®åº“ 28 product = productMapper.selectById(productId); 29 if (product != null) { 30 redisTemplate.opsForValue().set(key, product, 1, TimeUnit.HOURS); 31 } 32 33 return product; 34 } 35 36 /** 37 * é™æµé™çº§å¤„ç† 38 */ 39 public Product getProductBlockHandler(Long productId, BlockException ex) { 40 log.warn(\u0026#34;è§¦å‘é™æµ: productId={}\u0026#34;, productId); 41 // è¿”å›é»˜è®¤å•†å“æˆ–æç¤ºä¿¡æ¯ 42 return getDefaultProduct(); 43 } 44 45 /** 46 * å¼‚å¸¸é™çº§å¤„ç† 47 */ 48 public Product getProductFallback(Long productId, Throwable ex) { 49 log.error(\u0026#34;æŸ¥è¯¢å¼‚å¸¸: productId={}\u0026#34;, productId, ex); 50 // è¿”å›é»˜è®¤å•†å“ 51 return getDefaultProduct(); 52 } 53} ç¼“å­˜æ›´æ–°ç­–ç•¥ ç­–ç•¥å¯¹æ¯” ç­–ç•¥ ä¸€è‡´æ€§ å®ç°å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ Cache Aside å¼±ä¸€è‡´æ€§ ç®€å• è¯»å¤šå†™å°‘ Read/Write Through å¼ºä¸€è‡´æ€§ å¤æ‚ è¯»å†™å‡è¡¡ Write Behind æœ€ç»ˆä¸€è‡´æ€§ å¤æ‚ å†™å¤šè¯»å°‘ Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰ 1// è¯»æ“ä½œ 2public User getUser(Long userId) { 3 String key = \u0026#34;user:\u0026#34; + userId; 4 5 // 1. æŸ¥ç¼“å­˜ 6 User user = redisTemplate.opsForValue().get(key); 7 if (user != null) { 8 return user; 9 } 10 11 // 2. æŸ¥æ•°æ®åº“ 12 user = userMapper.selectById(userId); 13 14 // 3. å†™å…¥ç¼“å­˜ 15 if (user != null) { 16 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 17 } 18 19 return user; 20} 21 22// å†™æ“ä½œ 23public void updateUser(User user) { 24 // 1. æ›´æ–°æ•°æ®åº“ 25 userMapper.updateById(user); 26 27 // 2. åˆ é™¤ç¼“å­˜ 28 String key = \u0026#34;user:\u0026#34; + user.getId(); 29 redisTemplate.delete(key); 30} ä¸ºä»€ä¹ˆæ˜¯åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ\næ›´æ–°ç¼“å­˜å¯èƒ½æµªè´¹ï¼ˆæ›´æ–°åå¯èƒ½æ²¡äººæŸ¥è¯¢ï¼‰ å¹¶å‘æ›´æ–°å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ å»¶è¿ŸåŒåˆ  1public void updateUser(User user) { 2 String key = \u0026#34;user:\u0026#34; + user.getId(); 3 4 // 1. åˆ é™¤ç¼“å­˜ 5 redisTemplate.delete(key); 6 7 // 2. æ›´æ–°æ•°æ®åº“ 8 userMapper.updateById(user); 9 10 // 3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜ 11 CompletableFuture.runAsync(() -\u0026gt; { 12 try { 13 Thread.sleep(500); // å»¶è¿Ÿ500ms 14 redisTemplate.delete(key); 15 } catch (InterruptedException e) { 16 Thread.currentThread().interrupt(); 17 } 18 }); 19} ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿ŸåŒåˆ ï¼Ÿ\né˜²æ­¢ä»¥ä¸‹åœºæ™¯çš„æ•°æ®ä¸ä¸€è‡´ï¼š\n1æ—¶åˆ»1ï¼šçº¿ç¨‹Aåˆ é™¤ç¼“å­˜ 2æ—¶åˆ»2ï¼šçº¿ç¨‹BæŸ¥è¯¢ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰ 3æ—¶åˆ»3ï¼šçº¿ç¨‹BæŸ¥è¯¢æ•°æ®åº“ï¼ˆæ—§æ•°æ®ï¼‰ 4æ—¶åˆ»4ï¼šçº¿ç¨‹Aæ›´æ–°æ•°æ®åº“ 5æ—¶åˆ»5ï¼šçº¿ç¨‹Bå†™å…¥ç¼“å­˜ï¼ˆæ—§æ•°æ®ï¼‰ å»¶è¿ŸåŒåˆ å¯ä»¥åˆ é™¤çº¿ç¨‹Bå†™å…¥çš„æ—§æ•°æ®ã€‚\nç¼“å­˜ç›‘æ§ å…³é”®æŒ‡æ ‡ 1@Component 2public class CacheMonitor { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; 6 7 @Scheduled(fixedDelay = 60000) 8 public void monitor() { 9 RedisConnection connection = redisTemplate.getConnectionFactory().getConnection(); 10 Properties info = connection.info(); 11 12 // 1. å†…å­˜ä½¿ç”¨ 13 long usedMemory = Long.parseLong(info.getProperty(\u0026#34;used_memory\u0026#34;)); 14 long maxMemory = Long.parseLong(info.getProperty(\u0026#34;maxmemory\u0026#34;)); 15 double memoryUsageRate = (double) usedMemory / maxMemory * 100; 16 17 // 2. å‘½ä¸­ç‡ 18 long hits = Long.parseLong(info.getProperty(\u0026#34;keyspace_hits\u0026#34;)); 19 long misses = Long.parseLong(info.getProperty(\u0026#34;keyspace_misses\u0026#34;)); 20 double hitRate = (double) hits / (hits + misses) * 100; 21 22 // 3. è¿æ¥æ•° 23 int connectedClients = Integer.parseInt(info.getProperty(\u0026#34;connected_clients\u0026#34;)); 24 25 log.info(\u0026#34;Redisç›‘æ§ - å†…å­˜ä½¿ç”¨ç‡: {}%, å‘½ä¸­ç‡: {}%, è¿æ¥æ•°: {}\u0026#34;, 26 memoryUsageRate, hitRate, connectedClients); 27 28 // 4. å‘Šè­¦ 29 if (memoryUsageRate \u0026gt; 80) { 30 log.warn(\u0026#34;Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, memoryUsageRate); 31 } 32 if (hitRate \u0026lt; 80) { 33 log.warn(\u0026#34;Rediså‘½ä¸­ç‡è¿‡ä½: {}%\u0026#34;, hitRate); 34 } 35 } 36} æœ€ä½³å®è·µ 1. åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´\nçƒ­ç‚¹æ•°æ®ï¼š1-2å°æ—¶ æ™®é€šæ•°æ®ï¼š30åˆ†é’Ÿ-1å°æ—¶ å†·æ•°æ®ï¼š5-10åˆ†é’Ÿ 2. ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„\nStringï¼šç®€å•key-value Hashï¼šå¯¹è±¡å­˜å‚¨ Listï¼šåˆ—è¡¨ã€é˜Ÿåˆ— Setï¼šå»é‡ã€äº¤é›† ZSetï¼šæ’è¡Œæ¦œ 3. é¿å…å¤§key\nå•ä¸ªkeyä¸è¶…è¿‡10KB é›†åˆå…ƒç´ ä¸è¶…è¿‡5000ä¸ª ä½¿ç”¨SCANä»£æ›¿KEYS 4. è®¾ç½®å†…å­˜æ·˜æ±°ç­–ç•¥\n1# redis.conf 2maxmemory 2gb 3maxmemory-policy allkeys-lru 5. ç›‘æ§å‘Šè­¦\nå†…å­˜ä½¿ç”¨ç‡ \u0026gt; 80% å‘½ä¸­ç‡ \u0026lt; 80% æ…¢æŸ¥è¯¢ \u0026gt; 10ms é¿å‘æç¤ºï¼š ç¼“å­˜ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¸è¦ä¸ºäº†ç¼“å­˜è€Œç¼“å­˜ã€‚åªæœ‰é«˜é¢‘è®¿é—®ã€å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®æ‰é€‚åˆç¼“å­˜ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜çš„æ•°æ®ï¼Œç›´æ¥æŸ¥æ•°æ®åº“å¯èƒ½æ›´åˆé€‚ã€‚\næ€»ç»“ä¸æ€è€ƒ Redis ç¼“å­˜æ¶æ„çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€ ä½¿ç”¨äº’æ–¥é”æˆ–é€»è¾‘è¿‡æœŸé˜²æ­¢ç¼“å­˜å‡»ç©¿ ä½¿ç”¨è¿‡æœŸæ—¶é—´éšæœºåŒ–å’Œå¤šçº§ç¼“å­˜é˜²æ­¢ç¼“å­˜é›ªå´© ä½¿ç”¨ Cache Aside æ¨¡å¼æ›´æ–°ç¼“å­˜ ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œå†…å­˜ä½¿ç”¨ç‡ ç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„åˆ©å™¨ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¤æ‚åº¦ã€‚åœ¨è®¾è®¡ç¼“å­˜æ¶æ„æ—¶è¦æƒè¡¡ï¼š\næ˜¯å¦çœŸçš„éœ€è¦ç¼“å­˜ï¼Ÿ ç¼“å­˜ä»€ä¹ˆæ•°æ®ï¼Ÿ å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ å¦‚ä½•åº”å¯¹ç¼“å­˜å¤±æ•ˆï¼Ÿ ä¸‹æ¬¡å½“ä½ çš„ç³»ç»Ÿé¢ä¸´é«˜å¹¶å‘æŒ‘æˆ˜æ—¶ï¼Œä¸å¦¨è¯•è¯•æœ¬æ–‡ä»‹ç»çš„ç¼“å­˜æ¶æ„æ–¹æ¡ˆï¼Œè®©ç³»ç»Ÿæ€§èƒ½æ›´ä¸Šä¸€å±‚æ¥¼ã€‚\n","permalink":"http://localhost:1313/posts/2025/03/redis-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E4%BB%8E%E7%A9%BF%E9%80%8F%E5%88%B0%E9%9B%AA%E5%B4%A9%E7%9A%84%E5%85%A8%E9%93%BE%E8%B7%AF%E9%98%B2%E6%8A%A4/","summary":"\u003cp\u003eåœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚ä½†ç¼“å­˜ä½¿ç”¨ä¸å½“ä¼šå¼•å‘ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æè¿™äº›é—®é¢˜çš„åŸç†ï¼Œå¹¶æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„æœ¬è´¨åŒºåˆ«\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å¸ƒéš†è¿‡æ»¤å™¨ã€äº’æ–¥é”ç­‰é˜²æŠ¤æ‰‹æ®µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„ç¼“å­˜æ¶æ„\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç¼“å­˜é¢„çƒ­ã€é™çº§ç­‰æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜\"\u003eç¼“å­˜çš„ä¸‰å¤§é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜å¯¹æ¯”\"\u003eé—®é¢˜å¯¹æ¯”\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eé—®é¢˜\u003c/th\u003e\n          \u003cth\u003eåŸå› \u003c/th\u003e\n          \u003cth\u003eå½±å“\u003c/th\u003e\n          \u003cth\u003eè§£å†³æ–¹æ¡ˆ\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜ç©¿é€\u003c/td\u003e\n          \u003ctd\u003eæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\u003c/td\u003e\n          \u003ctd\u003eå¤§é‡è¯·æ±‚æ‰“åˆ°DB\u003c/td\u003e\n          \u003ctd\u003eå¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜å‡»ç©¿\u003c/td\u003e\n          \u003ctd\u003eçƒ­ç‚¹keyè¿‡æœŸ\u003c/td\u003e\n          \u003ctd\u003eç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°DB\u003c/td\u003e\n          \u003ctd\u003eäº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜é›ªå´©\u003c/td\u003e\n          \u003ctd\u003eå¤§é‡keyåŒæ—¶è¿‡æœŸ\u003c/td\u003e\n          \u003ctd\u003eDBå‹åŠ›éª¤å¢\u003c/td\u003e\n          \u003ctd\u003eè¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¼“å­˜ç©¿é€æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\"\u003eç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜åœºæ™¯\"\u003eé—®é¢˜åœºæ™¯\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003e1000000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æŸ¥DB\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæµç¨‹ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eè¯·æ±‚ â†’ æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ æŸ¥æ•°æ®åº“ï¼ˆæœªå‘½ä¸­ï¼‰â†’ è¿”å›null\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\u003c/p\u003e\n\u003ch3 id=\"è§£å†³æ–¹æ¡ˆ1å¸ƒéš†è¿‡æ»¤å™¨\"\u003eè§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eåŸç†ï¼š\u003c/strong\u003e ç”¨ä½æ•°ç»„åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBloomFilterConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// é¢„æœŸå…ƒç´ æ•°é‡ï¼š1000ä¸‡ï¼Œè¯¯åˆ¤ç‡ï¼š0.01%\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eFunnels\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003elongFunnel\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10000000\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003e0001\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserIds\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectAllIds\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003euserIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eforEach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eput\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRedisTemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserMapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emightContain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æŸ¥ç¼“å­˜\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;user:\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. æŸ¥æ•°æ®åº“\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eHOURS\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eä¼˜ç‚¹ï¼š\u003c/strong\u003e\u003c/p\u003e","title":"Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤"},{"content":"å½“å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§åˆ«æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆã€‚æœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ ShardingSphere å®ç°åˆ†åº“åˆ†è¡¨ï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒçš„å®æˆ˜ç»éªŒã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒæ¦‚å¿µå’Œåº”ç”¨åœºæ™¯ æŒæ¡ ShardingSphere çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³• å­¦ä¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡ç­–ç•¥ äº†è§£åˆ†åº“åˆ†è¡¨çš„æœ€ä½³å®è·µå’Œå¸¸è§é—®é¢˜ ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ åœºæ™¯ï¼šè®¢å•è¡¨æ•°æ®çˆ†ç‚¸\nç”µå•†ç³»ç»Ÿçš„è®¢å•è¡¨ï¼Œæ¯å¤©æ–°å¢10ä¸‡æ¡æ•°æ®ï¼Œä¸€å¹´å°±æ˜¯3600ä¸‡æ¡ã€‚éšç€æ•°æ®é‡å¢é•¿ï¼š\næŸ¥è¯¢å˜æ…¢ï¼šå•è¡¨æŸ¥è¯¢ä»æ¯«ç§’çº§å˜æˆç§’çº§ ç´¢å¼•å¤±æ•ˆï¼šB+æ ‘å±‚çº§å¢åŠ ï¼Œç´¢å¼•æ•ˆç‡ä¸‹é™ é”ç«äº‰ï¼šå¤§è¡¨çš„é”ç²’åº¦å¤§ï¼Œå¹¶å‘æ€§èƒ½å·® å¤‡ä»½å›°éš¾ï¼šå•è¡¨å¤‡ä»½æ—¶é—´è¿‡é•¿ ä¼ ç»Ÿä¼˜åŒ–æ–¹æ¡ˆçš„å±€é™\n1-- ä¼˜åŒ–ç´¢å¼• 2CREATE INDEX idx_user_id_create_time ON orders(user_id, create_time); 3 4-- åˆ†åŒºè¡¨ 5ALTER TABLE orders PARTITION BY RANGE (YEAR(create_time)) ( 6 PARTITION p2023 VALUES LESS THAN (2024), 7 PARTITION p2024 VALUES LESS THAN (2025) 8); è¿™äº›æ–¹æ¡ˆåªèƒ½ç¼“è§£é—®é¢˜ï¼Œæ— æ³•æ ¹æœ¬è§£å†³ã€‚å½“æ•°æ®é‡è¾¾åˆ°äº¿çº§æ—¶ï¼Œåˆ†åº“åˆ†è¡¨æ˜¯å¿…ç„¶é€‰æ‹©ã€‚\nåˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ å‚ç›´æ‹†åˆ† vs æ°´å¹³æ‹†åˆ† å‚ç›´æ‹†åˆ†ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†\n1åŸå§‹æ•°æ®åº“ 2â”œâ”€â”€ ç”¨æˆ·è¡¨ 3â”œâ”€â”€ è®¢å•è¡¨ 4â”œâ”€â”€ å•†å“è¡¨ 5â””â”€â”€ æ”¯ä»˜è¡¨ 6 7æ‹†åˆ†å 8â”œâ”€â”€ ç”¨æˆ·åº“ 9â”‚ â””â”€â”€ ç”¨æˆ·è¡¨ 10â”œâ”€â”€ è®¢å•åº“ 11â”‚ â””â”€â”€ è®¢å•è¡¨ 12â”œâ”€â”€ å•†å“åº“ 13â”‚ â””â”€â”€ å•†å“è¡¨ 14â””â”€â”€ æ”¯ä»˜åº“ 15 â””â”€â”€ æ”¯ä»˜è¡¨ æ°´å¹³æ‹†åˆ†ï¼šæŒ‰æ•°æ®è¡Œæ‹†åˆ†\n1è®¢å•è¡¨ï¼ˆ1äº¿æ¡æ•°æ®ï¼‰ 2 3æ‹†åˆ†å 4â”œâ”€â”€ orders_0ï¼ˆ2500ä¸‡æ¡ï¼‰ 5â”œâ”€â”€ orders_1ï¼ˆ2500ä¸‡æ¡ï¼‰ 6â”œâ”€â”€ orders_2ï¼ˆ2500ä¸‡æ¡ï¼‰ 7â””â”€â”€ orders_3ï¼ˆ2500ä¸‡æ¡ï¼‰ åˆ†ç‰‡é”®çš„é€‰æ‹© åˆ†ç‰‡é”®å†³å®šäº†æ•°æ®å¦‚ä½•åˆ†å¸ƒï¼Œé€‰æ‹©ä¸å½“ä¼šå¯¼è‡´æ•°æ®å€¾æ–œã€‚\nå¸¸è§åˆ†ç‰‡é”®ï¼š\nç”¨æˆ·IDï¼šé€‚åˆç”¨æˆ·ç»´åº¦æŸ¥è¯¢ è®¢å•IDï¼šé€‚åˆè®¢å•ç»´åº¦æŸ¥è¯¢ æ—¶é—´ï¼šé€‚åˆæ—¶é—´èŒƒå›´æŸ¥è¯¢ é€‰æ‹©åŸåˆ™ï¼š\né«˜é¢‘æŸ¥è¯¢å­—æ®µ æ•°æ®åˆ†å¸ƒå‡åŒ€ é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ ShardingSphere å¿«é€Ÿå…¥é—¨ å¼•å…¥ä¾èµ– 1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;org.apache.shardingsphere\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;shardingsphere-jdbc-core-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;5.3.2\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; åŸºç¡€é…ç½® 1spring: 2 shardingsphere: 3 # æ•°æ®æºé…ç½® 4 datasource: 5 names: ds0,ds1 6 ds0: 7 type: com.zaxxer.hikari.HikariDataSource 8 driver-class-name: com.mysql.cj.jdbc.Driver 9 jdbc-url: jdbc:mysql://localhost:3306/order_db_0 10 username: root 11 password: root 12 ds1: 13 type: com.zaxxer.hikari.HikariDataSource 14 driver-class-name: com.mysql.cj.jdbc.Driver 15 jdbc-url: jdbc:mysql://localhost:3306/order_db_1 16 username: root 17 password: root 18 19 # åˆ†ç‰‡è§„åˆ™ 20 rules: 21 sharding: 22 tables: 23 orders: 24 # å®é™…èŠ‚ç‚¹ 25 actual-data-nodes: ds$-\u0026gt;{0..1}.orders_$-\u0026gt;{0..3} 26 # åˆ†åº“ç­–ç•¥ 27 database-strategy: 28 standard: 29 sharding-column: user_id 30 sharding-algorithm-name: database-inline 31 # åˆ†è¡¨ç­–ç•¥ 32 table-strategy: 33 standard: 34 sharding-column: order_id 35 sharding-algorithm-name: table-inline 36 37 # åˆ†ç‰‡ç®—æ³• 38 sharding-algorithms: 39 database-inline: 40 type: INLINE 41 props: 42 algorithm-expression: ds$-\u0026gt;{user_id % 2} 43 table-inline: 44 type: INLINE 45 props: 46 algorithm-expression: orders_$-\u0026gt;{order_id % 4} 47 48 # å±æ€§é…ç½® 49 props: 50 sql-show: true å®ä½“ç±» 1@Data 2@TableName(\u0026#34;orders\u0026#34;) 3public class Order { 4 private Long orderId; 5 private Long userId; 6 private BigDecimal amount; 7 private Integer status; 8 private LocalDateTime createTime; 9} ä½¿ç”¨ç¤ºä¾‹ 1@Service 2public class OrderService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 /** 8 * æ’å…¥è®¢å• 9 * ShardingSphere ä¼šæ ¹æ® user_id å’Œ order_id è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”çš„åº“è¡¨ 10 */ 11 public void createOrder(Order order) { 12 orderMapper.insert(order); 13 } 14 15 /** 16 * æ ¹æ®è®¢å•IDæŸ¥è¯¢ 17 * å•åˆ†ç‰‡æŸ¥è¯¢ï¼Œæ€§èƒ½æœ€ä¼˜ 18 */ 19 public Order getById(Long orderId) { 20 return orderMapper.selectById(orderId); 21 } 22 23 /** 24 * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è®¢å•åˆ—è¡¨ 25 * å•åº“å¤šè¡¨æŸ¥è¯¢ï¼Œéœ€è¦åˆå¹¶ç»“æœ 26 */ 27 public List\u0026lt;Order\u0026gt; listByUserId(Long userId) { 28 return orderMapper.selectList( 29 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 30 .eq(Order::getUserId, userId) 31 .orderByDesc(Order::getCreateTime) 32 ); 33 } 34} åˆ†ç‰‡ç­–ç•¥è¯¦è§£ 1. æ ‡å‡†åˆ†ç‰‡ç­–ç•¥ï¼ˆStandardï¼‰ é€‚ç”¨äºå•ä¸€åˆ†ç‰‡é”®çš„åœºæ™¯ã€‚\n1database-strategy: 2 standard: 3 sharding-column: user_id 4 sharding-algorithm-name: database-mod å–æ¨¡ç®—æ³•\n1sharding-algorithms: 2 database-mod: 3 type: MOD 4 props: 5 sharding-count: 2 å“ˆå¸Œå–æ¨¡ç®—æ³•\n1sharding-algorithms: 2 database-hash-mod: 3 type: HASH_MOD 4 props: 5 sharding-count: 2 2. å¤åˆåˆ†ç‰‡ç­–ç•¥ï¼ˆComplexï¼‰ é€‚ç”¨äºå¤šä¸ªåˆ†ç‰‡é”®çš„åœºæ™¯ã€‚\n1database-strategy: 2 complex: 3 sharding-columns: user_id,order_id 4 sharding-algorithm-name: complex-inline 1sharding-algorithms: 2 complex-inline: 3 type: CLASS_BASED 4 props: 5 strategy: COMPLEX 6 algorithm-class-name: com.example.ComplexShardingAlgorithm è‡ªå®šä¹‰å¤åˆç®—æ³•\n1public class ComplexShardingAlgorithm implements ComplexKeysShardingAlgorithm\u0026lt;Long\u0026gt; { 2 3 @Override 4 public Collection\u0026lt;String\u0026gt; doSharding( 5 Collection\u0026lt;String\u0026gt; availableTargetNames, 6 ComplexKeysShardingValue\u0026lt;Long\u0026gt; shardingValue) { 7 8 // è·å–åˆ†ç‰‡é”®å€¼ 9 Map\u0026lt;String, Collection\u0026lt;Long\u0026gt;\u0026gt; columnNameAndShardingValuesMap = 10 shardingValue.getColumnNameAndShardingValuesMap(); 11 12 Collection\u0026lt;Long\u0026gt; userIds = columnNameAndShardingValuesMap.get(\u0026#34;user_id\u0026#34;); 13 Collection\u0026lt;Long\u0026gt; orderIds = columnNameAndShardingValuesMap.get(\u0026#34;order_id\u0026#34;); 14 15 // è‡ªå®šä¹‰åˆ†ç‰‡é€»è¾‘ 16 Set\u0026lt;String\u0026gt; result = new HashSet\u0026lt;\u0026gt;(); 17 for (Long userId : userIds) { 18 for (Long orderId : orderIds) { 19 String suffix = String.valueOf((userId + orderId) % 4); 20 result.addAll(availableTargetNames.stream() 21 .filter(name -\u0026gt; name.endsWith(suffix)) 22 .collect(Collectors.toList())); 23 } 24 } 25 return result; 26 } 27} 3. èŒƒå›´åˆ†ç‰‡ç­–ç•¥ï¼ˆRangeï¼‰ é€‚ç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢ã€‚\n1table-strategy: 2 standard: 3 sharding-column: create_time 4 sharding-algorithm-name: table-range 1sharding-algorithms: 2 table-range: 3 type: CLASS_BASED 4 props: 5 strategy: STANDARD 6 algorithm-class-name: com.example.RangeShardingAlgorithm æŒ‰æœˆåˆ†ç‰‡\n1public class RangeShardingAlgorithm implements StandardShardingAlgorithm\u0026lt;LocalDateTime\u0026gt; { 2 3 @Override 4 public String doSharding( 5 Collection\u0026lt;String\u0026gt; availableTargetNames, 6 PreciseShardingValue\u0026lt;LocalDateTime\u0026gt; shardingValue) { 7 8 LocalDateTime createTime = shardingValue.getValue(); 9 int month = createTime.getMonthValue(); 10 String suffix = String.format(\u0026#34;%02d\u0026#34;, month); 11 12 return availableTargetNames.stream() 13 .filter(name -\u0026gt; name.endsWith(suffix)) 14 .findFirst() 15 .orElseThrow(() -\u0026gt; new IllegalArgumentException(\u0026#34;æ‰¾ä¸åˆ°å¯¹åº”çš„åˆ†ç‰‡è¡¨\u0026#34;)); 16 } 17 18 @Override 19 public Collection\u0026lt;String\u0026gt; doSharding( 20 Collection\u0026lt;String\u0026gt; availableTargetNames, 21 RangeShardingValue\u0026lt;LocalDateTime\u0026gt; shardingValue) { 22 23 Range\u0026lt;LocalDateTime\u0026gt; range = shardingValue.getValueRange(); 24 LocalDateTime start = range.lowerEndpoint(); 25 LocalDateTime end = range.upperEndpoint(); 26 27 Set\u0026lt;String\u0026gt; result = new HashSet\u0026lt;\u0026gt;(); 28 for (int month = start.getMonthValue(); month \u0026lt;= end.getMonthValue(); month++) { 29 String suffix = String.format(\u0026#34;%02d\u0026#34;, month); 30 result.addAll(availableTargetNames.stream() 31 .filter(name -\u0026gt; name.endsWith(suffix)) 32 .collect(Collectors.toList())); 33 } 34 return result; 35 } 36} åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆ åˆ†åº“åˆ†è¡¨åï¼Œè‡ªå¢ä¸»é”®ä¼šå†²çªï¼Œéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®ã€‚\nSnowflake ç®—æ³• 1rules: 2 sharding: 3 tables: 4 orders: 5 key-generate-strategy: 6 column: order_id 7 key-generator-name: snowflake 8 9 key-generators: 10 snowflake: 11 type: SNOWFLAKE 12 props: 13 worker-id: 1 è‡ªå®šä¹‰ä¸»é”®ç”Ÿæˆå™¨ 1public class CustomKeyGenerator implements KeyGenerateAlgorithm { 2 3 @Override 4 public Comparable\u0026lt;?\u0026gt; generateKey() { 5 // æ—¶é—´æˆ³ï¼ˆ41ä½ï¼‰+ æœºå™¨IDï¼ˆ10ä½ï¼‰+ åºåˆ—å·ï¼ˆ12ä½ï¼‰ 6 long timestamp = System.currentTimeMillis(); 7 long workerId = getWorkerId(); 8 long sequence = getSequence(); 9 10 return (timestamp \u0026lt;\u0026lt; 22) | (workerId \u0026lt;\u0026lt; 12) | sequence; 11 } 12} è¯»å†™åˆ†ç¦» ShardingSphere æ”¯æŒä¸»ä»è¯»å†™åˆ†ç¦»ã€‚\n1rules: 2 readwrite-splitting: 3 data-sources: 4 ds0: 5 type: Static 6 props: 7 write-data-source-name: ds0-master 8 read-data-source-names: ds0-slave0,ds0-slave1 9 load-balancer-name: round-robin 10 ds1: 11 type: Static 12 props: 13 write-data-source-name: ds1-master 14 read-data-source-names: ds1-slave0,ds1-slave1 15 load-balancer-name: round-robin 16 17 load-balancers: 18 round-robin: 19 type: ROUND_ROBIN å¼ºåˆ¶ä¸»åº“æŸ¥è¯¢\n1// ä½¿ç”¨ HintManager å¼ºåˆ¶è·¯ç”±åˆ°ä¸»åº“ 2HintManager hintManager = HintManager.getInstance(); 3hintManager.setWriteRouteOnly(); 4try { 5 Order order = orderMapper.selectById(orderId); 6} finally { 7 hintManager.close(); 8} è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ï¼šå…¨è¡¨æ‰«æ 1// ä¸å¸¦åˆ†ç‰‡é”®çš„æŸ¥è¯¢ï¼Œä¼šæ‰«ææ‰€æœ‰åˆ†ç‰‡ 2List\u0026lt;Order\u0026gt; orders = orderMapper.selectList( 3 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 4 .eq(Order::getStatus, 1) 5); è§£å†³æ–¹æ¡ˆ1ï¼šå†—ä½™åˆ†ç‰‡é”® 1// åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­æ·»åŠ åˆ†ç‰‡é”® 2List\u0026lt;Order\u0026gt; orders = orderMapper.selectList( 3 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 4 .eq(Order::getUserId, userId) // åˆ†ç‰‡é”® 5 .eq(Order::getStatus, 1) 6); è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨ Hint 1// æ‰‹åŠ¨æŒ‡å®šåˆ†ç‰‡ 2HintManager hintManager = HintManager.getInstance(); 3hintManager.addDatabaseShardingValue(\u0026#34;orders\u0026#34;, \u0026#34;user_id\u0026#34;, userId); 4hintManager.addTableShardingValue(\u0026#34;orders\u0026#34;, \u0026#34;order_id\u0026#34;, orderId); 5try { 6 Order order = orderMapper.selectById(orderId); 7} finally { 8 hintManager.close(); 9} è§£å†³æ–¹æ¡ˆ3ï¼šå»ºç«‹æ˜ å°„è¡¨ 1-- è®¢å•çŠ¶æ€æ˜ å°„è¡¨ï¼ˆä¸åˆ†ç‰‡ï¼‰ 2CREATE TABLE order_status_mapping ( 3 order_id BIGINT PRIMARY KEY, 4 user_id BIGINT, 5 status INT, 6 INDEX idx_status (status) 7); 1// å…ˆæŸ¥æ˜ å°„è¡¨è·å–åˆ†ç‰‡é”® 2List\u0026lt;Long\u0026gt; orderIds = mappingMapper.selectOrderIdsByStatus(status); 3 4// å†æ ¹æ®åˆ†ç‰‡é”®æŸ¥è¯¢è¯¦æƒ… 5List\u0026lt;Order\u0026gt; orders = orderIds.stream() 6 .map(orderMapper::selectById) 7 .collect(Collectors.toList()); åˆ†å¸ƒå¼äº‹åŠ¡ ShardingSphere æ”¯æŒ XA å’Œ Saga ä¸¤ç§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nXA äº‹åŠ¡ 1rules: 2 transaction: 3 default-type: XA 4 provider-type: Atomikos 1@Transactional 2public void createOrderWithXA(Order order, OrderItem item) { 3 // è·¨åˆ†ç‰‡çš„äº‹åŠ¡æ“ä½œ 4 orderMapper.insert(order); 5 orderItemMapper.insert(item); 6} Saga äº‹åŠ¡ 1rules: 2 transaction: 3 default-type: BASE 4 provider-type: Seata æ¶æ„æ€è€ƒï¼š XA äº‹åŠ¡ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½è¾ƒå·®ï¼›Saga äº‹åŠ¡ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½æ›´å¥½ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Sagaï¼Œé€šè¿‡è¡¥å¿æœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚\næ•°æ®è¿ç§»æ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šåŒå†™ + æ•°æ®æ ¡éªŒ 1@Service 2public class OrderMigrationService { 3 4 @Autowired 5 private OrderMapper oldOrderMapper; // æ—§è¡¨ 6 7 @Autowired 8 private OrderMapper newOrderMapper; // æ–°è¡¨ï¼ˆåˆ†ç‰‡ï¼‰ 9 10 /** 11 * åŒå†™é˜¶æ®µï¼šåŒæ—¶å†™å…¥æ—§è¡¨å’Œæ–°è¡¨ 12 */ 13 public void createOrder(Order order) { 14 // å†™å…¥æ—§è¡¨ 15 oldOrderMapper.insert(order); 16 17 // å¼‚æ­¥å†™å…¥æ–°è¡¨ 18 CompletableFuture.runAsync(() -\u0026gt; { 19 try { 20 newOrderMapper.insert(order); 21 } catch (Exception e) { 22 log.error(\u0026#34;æ–°è¡¨å†™å…¥å¤±è´¥\u0026#34;, e); 23 // è®°å½•å¤±è´¥æ—¥å¿—ï¼Œåç»­è¡¥å¿ 24 } 25 }); 26 } 27 28 /** 29 * æ•°æ®æ ¡éªŒï¼šå¯¹æ¯”æ–°æ—§è¡¨æ•°æ® 30 */ 31 public void verifyData(Long orderId) { 32 Order oldOrder = oldOrderMapper.selectById(orderId); 33 Order newOrder = newOrderMapper.selectById(orderId); 34 35 if (!Objects.equals(oldOrder, newOrder)) { 36 log.error(\u0026#34;æ•°æ®ä¸ä¸€è‡´: orderId={}\u0026#34;, orderId); 37 // è§¦å‘å‘Šè­¦ 38 } 39 } 40} æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Canal åŒæ­¥ 1# Canal é…ç½® 2canal: 3 server: 127.0.0.1:11111 4 destination: example 5 username: canal 6 password: canal 7 filter: order_db\\\\.orders 1@Component 2public class CanalDataSyncListener { 3 4 @Autowired 5 private OrderMapper shardingOrderMapper; 6 7 @CanalEventListener 8 public void onEvent(CanalEntry.Entry entry) { 9 if (entry.getEntryType() == CanalEntry.EntryType.ROWDATA) { 10 RowChange rowChange = RowChange.parseFrom(entry.getStoreValue()); 11 12 for (CanalEntry.RowData rowData : rowChange.getRowDatasList()) { 13 if (rowChange.getEventType() == CanalEntry.EventType.INSERT) { 14 Order order = parseOrder(rowData.getAfterColumnsList()); 15 shardingOrderMapper.insert(order); 16 } 17 } 18 } 19 } 20} æ€§èƒ½å¯¹æ¯” æµ‹è¯•ç¯å¢ƒ æ•°æ®é‡ï¼š5000ä¸‡æ¡ åˆ†ç‰‡é…ç½®ï¼š2åº“ Ã— 4è¡¨ = 8ä¸ªåˆ†ç‰‡ æ¯ä¸ªåˆ†ç‰‡ï¼š625ä¸‡æ¡æ•°æ® æŸ¥è¯¢æ€§èƒ½å¯¹æ¯” åœºæ™¯ å•è¡¨ åˆ†åº“åˆ†è¡¨ æå‡ ä¸»é”®æŸ¥è¯¢ 150ms 15ms 10å€ ç´¢å¼•æŸ¥è¯¢ 800ms 80ms 10å€ èŒƒå›´æŸ¥è¯¢ 2000ms 250ms 8å€ èšåˆæŸ¥è¯¢ 5000ms 800ms 6å€ å†™å…¥æ€§èƒ½å¯¹æ¯” åœºæ™¯ å•è¡¨ åˆ†åº“åˆ†è¡¨ æå‡ å•æ¡æ’å…¥ 5ms 6ms æŒå¹³ æ‰¹é‡æ’å…¥ï¼ˆ1000æ¡ï¼‰ 800ms 200ms 4å€ æœ€ä½³å®è·µ 1. åˆ†ç‰‡é”®é€‰æ‹©\nä¼˜å…ˆé€‰æ‹©é«˜é¢‘æŸ¥è¯¢å­—æ®µ ç¡®ä¿æ•°æ®åˆ†å¸ƒå‡åŒ€ é¿å…çƒ­ç‚¹æ•°æ® 2. é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢\nåœ¨æŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«åˆ†ç‰‡é”® ä½¿ç”¨æ˜ å°„è¡¨è¾…åŠ©æŸ¥è¯¢ åˆç†è®¾è®¡æ•°æ®æ¨¡å‹ 3. åˆ†ç‰‡æ•°é‡è§„åˆ’\nå•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨500ä¸‡ä»¥å†… é¢„ç•™æ‰©å±•ç©ºé—´ï¼ˆ2-3å€ï¼‰ åˆ†ç‰‡æ•°é‡å»ºè®®ä¸º2çš„å¹‚æ¬¡æ–¹ 4. ç›‘æ§å‘Šè­¦\nç›‘æ§å„åˆ†ç‰‡æ•°æ®é‡ ç›‘æ§æ…¢æŸ¥è¯¢ ç›‘æ§è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹ 5. ç°åº¦å‘å¸ƒ\nå…ˆè¿ç§»å†å²æ•°æ® å†å¼€å¯åŒå†™ æœ€ååˆ‡æ¢è¯»æµé‡ é¿å‘æç¤ºï¼š åˆ†åº“åˆ†è¡¨ä¸æ˜¯é“¶å¼¹ï¼Œä¼šå¢åŠ ç³»ç»Ÿå¤æ‚åº¦ã€‚åœ¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§ä¹‹å‰ï¼Œä¼˜å…ˆè€ƒè™‘ç´¢å¼•ä¼˜åŒ–ã€ç¼“å­˜ã€è¯»å†™åˆ†ç¦»ç­‰æ–¹æ¡ˆã€‚åªæœ‰åœ¨è¿™äº›æ–¹æ¡ˆéƒ½æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå†è€ƒè™‘åˆ†åº“åˆ†è¡¨ã€‚\næ€»ç»“ä¸æ€è€ƒ ShardingSphere åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒè¦ç‚¹ï¼š\né€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®ï¼Œé¿å…æ•°æ®å€¾æ–œ ä½¿ç”¨æ ‡å‡†åˆ†ç‰‡ç­–ç•¥ï¼Œç®€åŒ–é…ç½® é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½ ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®ï¼Œé¿å…IDå†²çª ç°åº¦è¿ç§»æ•°æ®ï¼Œé™ä½é£é™© åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¤æ‚åº¦ã€‚åœ¨å®æ–½å‰è¦å……åˆ†è¯„ä¼°ï¼š\næ˜¯å¦çœŸçš„éœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ åˆ†ç‰‡é”®å¦‚ä½•é€‰æ‹©ï¼Ÿ å¦‚ä½•å¤„ç†è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼Ÿ å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ ä¸‹æ¬¡å½“ä½ çš„å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§æ—¶ï¼Œä¸å¦¨è¯•è¯• ShardingSphereï¼Œè®©æ•°æ®åº“æ€§èƒ½é‡å›å·…å³°ã€‚\n","permalink":"http://localhost:1313/posts/2025/02/shardingsphere-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9A%84%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eå½“å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§åˆ«æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆã€‚æœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ ShardingSphere å®ç°åˆ†åº“åˆ†è¡¨ï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒçš„å®æˆ˜ç»éªŒã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒæ¦‚å¿µå’Œåº”ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ ShardingSphere çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†åº“åˆ†è¡¨çš„æœ€ä½³å®è·µå’Œå¸¸è§é—®é¢˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨\"\u003eä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼šè®¢å•è¡¨æ•°æ®çˆ†ç‚¸\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç”µå•†ç³»ç»Ÿçš„è®¢å•è¡¨ï¼Œæ¯å¤©æ–°å¢10ä¸‡æ¡æ•°æ®ï¼Œä¸€å¹´å°±æ˜¯3600ä¸‡æ¡ã€‚éšç€æ•°æ®é‡å¢é•¿ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæŸ¥è¯¢å˜æ…¢\u003c/strong\u003eï¼šå•è¡¨æŸ¥è¯¢ä»æ¯«ç§’çº§å˜æˆç§’çº§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç´¢å¼•å¤±æ•ˆ\u003c/strong\u003eï¼šB+æ ‘å±‚çº§å¢åŠ ï¼Œç´¢å¼•æ•ˆç‡ä¸‹é™\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eé”ç«äº‰\u003c/strong\u003eï¼šå¤§è¡¨çš„é”ç²’åº¦å¤§ï¼Œå¹¶å‘æ€§èƒ½å·®\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå¤‡ä»½å›°éš¾\u003c/strong\u003eï¼šå•è¡¨å¤‡ä»½æ—¶é—´è¿‡é•¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿä¼˜åŒ–æ–¹æ¡ˆçš„å±€é™\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e-- ä¼˜åŒ–ç´¢å¼•\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCREATE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eINDEX\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eidx_user_id_create_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eON\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser_id\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e-- åˆ†åŒºè¡¨\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eALTER\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eBY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRANGE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eYEAR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ep2023\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eLESS\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTHAN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2024\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ep2024\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eLESS\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTHAN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2025\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™äº›æ–¹æ¡ˆåªèƒ½ç¼“è§£é—®é¢˜ï¼Œæ— æ³•æ ¹æœ¬è§£å†³ã€‚å½“æ•°æ®é‡è¾¾åˆ°äº¿çº§æ—¶ï¼Œåˆ†åº“åˆ†è¡¨æ˜¯å¿…ç„¶é€‰æ‹©ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ\"\u003eåˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003ch3 id=\"å‚ç›´æ‹†åˆ†-vs-æ°´å¹³æ‹†åˆ†\"\u003eå‚ç›´æ‹†åˆ† vs æ°´å¹³æ‹†åˆ†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eå‚ç›´æ‹†åˆ†\u003c/strong\u003eï¼šæŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003eåŸå§‹æ•°æ®åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ ç”¨æˆ·è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ è®¢å•è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ å•†å“è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ æ”¯ä»˜è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003eæ‹†åˆ†å\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ ç”¨æˆ·åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ ç”¨æˆ·è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ è®¢å•åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ è®¢å•è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ å•†å“åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ å•†å“è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ æ”¯ä»˜åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    â””â”€â”€ æ”¯ä»˜è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ°´å¹³æ‹†åˆ†\u003c/strong\u003eï¼šæŒ‰æ•°æ®è¡Œæ‹†åˆ†\u003c/p\u003e","title":"ShardingSphere åˆ†åº“åˆ†è¡¨çš„ç”Ÿäº§å®æˆ˜"},{"content":"åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°çš„é…ç½®å¾€å¾€éœ€è¦æ ¹æ®å®é™…è´Ÿè½½åŠ¨æ€è°ƒæ•´ã€‚ç¡¬ç¼–ç çš„å‚æ•°é…ç½®ç¼ºä¹çµæ´»æ€§ï¼Œé‡å¯æœåŠ¡åˆä¼šå½±å“ä¸šåŠ¡ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•è®¾è®¡ä¸€ä¸ªçº¿ç¨‹æ± ç®¡ç†åå°ï¼Œå®ç°å‚æ•°çš„åŠ¨æ€é…ç½®å’Œå®æ—¶ç›‘æ§ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£çº¿ç¨‹æ± å‚æ•°åŠ¨æ€è°ƒæ•´çš„åŸç†ä¸å®ç° æŒæ¡çº¿ç¨‹æ± ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†ä¸å±•ç¤º å­¦ä¼šè®¾è®¡ç”Ÿäº§çº§çš„çº¿ç¨‹æ± ç®¡ç†å¹³å° äº†è§£çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜çš„æœ€ä½³å®è·µ ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®ï¼Ÿ åœºæ™¯ä¸€ï¼šæµé‡çªå¢\nåŒåä¸€æœŸé—´ï¼Œè®¢å•å¤„ç†çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º 10ï¼Œæœ€å¤§çº¿ç¨‹æ•° 20ã€‚çªç„¶æµé‡æš´å¢ï¼Œé˜Ÿåˆ—å †ç§¯ä¸¥é‡ï¼Œå¯¼è‡´è®¢å•å¤„ç†å»¶è¿Ÿã€‚\nå¦‚æœèƒ½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼Œå°†æ ¸å¿ƒçº¿ç¨‹æ•°è°ƒæ•´ä¸º 50ï¼Œæœ€å¤§çº¿ç¨‹æ•°è°ƒæ•´ä¸º 100ï¼Œå°±èƒ½å¿«é€Ÿåº”å¯¹æµé‡é«˜å³°ã€‚\nåœºæ™¯äºŒï¼šèµ„æºæµªè´¹\nå‡Œæ™¨æ—¶æ®µæµé‡å¾ˆä½ï¼Œä½†çº¿ç¨‹æ± ä»ç„¶ä¿æŒé«˜å³°æœŸçš„é…ç½®ï¼Œæµªè´¹äº†å¤§é‡ç³»ç»Ÿèµ„æºã€‚\nä¼ ç»Ÿåšæ³•çš„é—®é¢˜\n1@Configuration 2public class ThreadPoolConfig { 3 @Bean(\u0026#34;orderThreadPool\u0026#34;) 4 public ThreadPoolExecutor orderThreadPool() { 5 return new ThreadPoolExecutor( 6 10, // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç  7 20, // æœ€å¤§çº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç  8 60, TimeUnit.SECONDS, 9 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 10 new ThreadFactoryBuilder().setNameFormat(\u0026#34;order-pool-%d\u0026#34;).build(), 11 new ThreadPoolExecutor.CallerRunsPolicy() 12 ); 13 } 14} é—®é¢˜ï¼š\nå‚æ•°ç¡¬ç¼–ç ï¼Œæ— æ³•åŠ¨æ€è°ƒæ•´ è°ƒæ•´å‚æ•°éœ€è¦é‡å¯æœåŠ¡ ç¼ºä¹ç›‘æ§ï¼Œæ— æ³•äº†è§£çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ ç³»ç»Ÿæ¶æ„è®¾è®¡ æ•´ä½“æ¶æ„ 1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ Admin ç®¡ç†åå° â”‚ 3â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 4â”‚ â”‚ çº¿ç¨‹æ± åˆ—è¡¨ â”‚ â”‚ å®æ—¶ç›‘æ§ â”‚ â”‚ å‚æ•°è°ƒæ•´ â”‚ â”‚ 5â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 6â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 7 â†“ HTTP API 8â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 9â”‚ Spring Boot åº”ç”¨ â”‚ 10â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 11â”‚ â”‚ ThreadPoolRegistry â”‚ â”‚ 12â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ 13â”‚ â”‚ â”‚ è®¢å•çº¿ç¨‹æ± â”‚ â”‚ æ”¯ä»˜çº¿ç¨‹æ± â”‚ â”‚ é€šçŸ¥çº¿ç¨‹æ± â”‚ â”‚ â”‚ 14â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ 15â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 16â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 17â”‚ â”‚ ThreadPoolMonitor â”‚ â”‚ 18â”‚ â”‚ (å®šæ—¶é‡‡é›†æŒ‡æ ‡ï¼Œä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ) â”‚ â”‚ 19â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 20â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒç»„ä»¶ ThreadPoolRegistryï¼šçº¿ç¨‹æ± æ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†æ‰€æœ‰çº¿ç¨‹æ± å®ä¾‹ ThreadPoolMonitorï¼šç›‘æ§ç»„ä»¶ï¼Œå®šæ—¶é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ ThreadPoolControllerï¼šREST APIï¼Œæä¾›æŸ¥è¯¢å’Œè°ƒæ•´æ¥å£ Admin ç®¡ç†åå°ï¼šå‰ç«¯é¡µé¢ï¼Œå±•ç¤ºç›‘æ§æ•°æ®å’Œå‚æ•°è°ƒæ•´ç•Œé¢ ç¬¬ä¸€æ­¥ï¼šçº¿ç¨‹æ± æ³¨å†Œä¸­å¿ƒ ThreadPoolRegistry\n1@Component 2public class ThreadPoolRegistry { 3 4 private final Map\u0026lt;String, ThreadPoolExecutor\u0026gt; executors = new ConcurrentHashMap\u0026lt;\u0026gt;(); 5 6 /** 7 * æ³¨å†Œçº¿ç¨‹æ±  8 */ 9 public void register(String name, ThreadPoolExecutor executor) { 10 executors.put(name, executor); 11 log.info(\u0026#34;æ³¨å†Œçº¿ç¨‹æ± : {}, æ ¸å¿ƒçº¿ç¨‹æ•°: {}, æœ€å¤§çº¿ç¨‹æ•°: {}\u0026#34;, 12 name, executor.getCorePoolSize(), executor.getMaximumPoolSize()); 13 } 14 15 /** 16 * è·å–æ‰€æœ‰çº¿ç¨‹æ±  17 */ 18 public Map\u0026lt;String, ThreadPoolExecutor\u0026gt; getAll() { 19 return Collections.unmodifiableMap(executors); 20 } 21 22 /** 23 * æ ¹æ®åç§°è·å–çº¿ç¨‹æ±  24 */ 25 public ThreadPoolExecutor get(String name) { 26 return executors.get(name); 27 } 28 29 /** 30 * åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 31 */ 32 public void adjust(String name, int corePoolSize, int maximumPoolSize) { 33 ThreadPoolExecutor executor = executors.get(name); 34 if (executor == null) { 35 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + name); 36 } 37 38 // å‚æ•°æ ¡éªŒ 39 if (corePoolSize \u0026lt;= 0 || maximumPoolSize \u0026lt;= 0) { 40 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± å‚æ•°å¿…é¡»å¤§äº 0\u0026#34;); 41 } 42 if (corePoolSize \u0026gt; maximumPoolSize) { 43 throw new IllegalArgumentException(\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å¤§äºæœ€å¤§çº¿ç¨‹æ•°\u0026#34;); 44 } 45 46 // è°ƒæ•´å‚æ•° 47 executor.setCorePoolSize(corePoolSize); 48 executor.setMaximumPoolSize(maximumPoolSize); 49 50 log.info(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°: {}, æ ¸å¿ƒçº¿ç¨‹æ•°: {} -\u0026gt; {}, æœ€å¤§çº¿ç¨‹æ•°: {} -\u0026gt; {}\u0026#34;, 51 name, executor.getCorePoolSize(), corePoolSize, 52 executor.getMaximumPoolSize(), maximumPoolSize); 53 } 54} è‡ªåŠ¨æ³¨å†Œçº¿ç¨‹æ± \nä½¿ç”¨ BeanPostProcessor è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰ ThreadPoolExecutorï¼š\n1@Component 2public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Override 8 public Object postProcessAfterInitialization(Object bean, String beanName) { 9 if (bean instanceof ThreadPoolExecutor) { 10 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 11 registry.register(beanName, executor); 12 } 13 return bean; 14 } 15} è¿™æ ·ï¼Œæ‰€æœ‰é€šè¿‡ Spring ç®¡ç†çš„ ThreadPoolExecutor éƒ½ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° Registry ä¸­ã€‚\nç¬¬äºŒæ­¥ï¼šç›‘æ§æŒ‡æ ‡é‡‡é›† ThreadPoolMetrics\n1@Data 2@Builder 3public class ThreadPoolMetrics { 4 private String name; // çº¿ç¨‹æ± åç§° 5 private int corePoolSize; // æ ¸å¿ƒçº¿ç¨‹æ•° 6 private int maximumPoolSize; // æœ€å¤§çº¿ç¨‹æ•° 7 private int activeCount; // æ´»è·ƒçº¿ç¨‹æ•° 8 private int poolSize; // å½“å‰çº¿ç¨‹æ•° 9 private int queueSize; // é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•° 10 private int queueRemainingCapacity; // é˜Ÿåˆ—å‰©ä½™å®¹é‡ 11 private long completedTaskCount; // å·²å®Œæˆä»»åŠ¡æ•° 12 private long taskCount; // æ€»ä»»åŠ¡æ•° 13 private String rejectedExecutionHandler; // æ‹’ç»ç­–ç•¥ 14 private long timestamp; // é‡‡é›†æ—¶é—´æˆ³ 15 16 /** 17 * è®¡ç®—çº¿ç¨‹æ± ä½¿ç”¨ç‡ 18 */ 19 public double getPoolUsageRate() { 20 return maximumPoolSize == 0 ? 0 : (double) poolSize / maximumPoolSize * 100; 21 } 22 23 /** 24 * è®¡ç®—é˜Ÿåˆ—ä½¿ç”¨ç‡ 25 */ 26 public double getQueueUsageRate() { 27 int capacity = queueSize + queueRemainingCapacity; 28 return capacity == 0 ? 0 : (double) queueSize / capacity * 100; 29 } 30} ThreadPoolMonitor\n1@Component 2@Slf4j 3public class ThreadPoolMonitor { 4 5 @Autowired 6 private ThreadPoolRegistry registry; 7 8 /** 9 * å®šæ—¶é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ 10 */ 11 @Scheduled(fixedDelay = 30000) // æ¯ 30 ç§’é‡‡é›†ä¸€æ¬¡ 12 public void collect() { 13 registry.getAll().forEach((name, executor) -\u0026gt; { 14 ThreadPoolMetrics metrics = collectMetrics(name, executor); 15 16 // æ‰“å°æ—¥å¿— 17 log.info(\u0026#34;çº¿ç¨‹æ± æŒ‡æ ‡: {}\u0026#34;, metrics); 18 19 // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€InfluxDB ç­‰ï¼‰ 20 reportToMonitor(metrics); 21 22 // æ£€æŸ¥å‘Šè­¦æ¡ä»¶ 23 checkAlert(metrics); 24 }); 25 } 26 27 /** 28 * é‡‡é›†å•ä¸ªçº¿ç¨‹æ± çš„æŒ‡æ ‡ 29 */ 30 private ThreadPoolMetrics collectMetrics(String name, ThreadPoolExecutor executor) { 31 return ThreadPoolMetrics.builder() 32 .name(name) 33 .corePoolSize(executor.getCorePoolSize()) 34 .maximumPoolSize(executor.getMaximumPoolSize()) 35 .activeCount(executor.getActiveCount()) 36 .poolSize(executor.getPoolSize()) 37 .queueSize(executor.getQueue().size()) 38 .queueRemainingCapacity(executor.getQueue().remainingCapacity()) 39 .completedTaskCount(executor.getCompletedTaskCount()) 40 .taskCount(executor.getTaskCount()) 41 .rejectedExecutionHandler(executor.getRejectedExecutionHandler().getClass().getSimpleName()) 42 .timestamp(System.currentTimeMillis()) 43 .build(); 44 } 45 46 /** 47 * ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ 48 */ 49 private void reportToMonitor(ThreadPoolMetrics metrics) { 50 // é›†æˆ Prometheusã€InfluxDB ç­‰ç›‘æ§ç³»ç»Ÿ 51 // è¿™é‡Œçœç•¥å…·ä½“å®ç° 52 } 53 54 /** 55 * æ£€æŸ¥å‘Šè­¦æ¡ä»¶ 56 */ 57 private void checkAlert(ThreadPoolMetrics metrics) { 58 // é˜Ÿåˆ—ä½¿ç”¨ç‡è¶…è¿‡ 80% 59 if (metrics.getQueueUsageRate() \u0026gt; 80) { 60 log.warn(\u0026#34;çº¿ç¨‹æ±  {} é˜Ÿåˆ—ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, 61 metrics.getName(), metrics.getQueueUsageRate()); 62 // å‘é€å‘Šè­¦ï¼ˆé’‰é’‰ã€é‚®ä»¶ç­‰ï¼‰ 63 } 64 65 // çº¿ç¨‹æ± ä½¿ç”¨ç‡è¶…è¿‡ 90% 66 if (metrics.getPoolUsageRate() \u0026gt; 90) { 67 log.warn(\u0026#34;çº¿ç¨‹æ±  {} ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, 68 metrics.getName(), metrics.getPoolUsageRate()); 69 } 70 } 71} æ¶æ„æ€è€ƒï¼š ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†é¢‘ç‡éœ€è¦æƒè¡¡ã€‚é¢‘ç‡å¤ªé«˜ä¼šå¢åŠ ç³»ç»Ÿå¼€é”€ï¼Œé¢‘ç‡å¤ªä½åˆæ— æ³•åŠæ—¶å‘ç°é—®é¢˜ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®® 30-60 ç§’é‡‡é›†ä¸€æ¬¡ï¼Œå‘Šè­¦é˜ˆå€¼å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚\nç¬¬ä¸‰æ­¥ï¼šREST API æ¥å£ ThreadPoolController\n1@RestController 2@RequestMapping(\u0026#34;/api/threadpool\u0026#34;) 3@Slf4j 4public class ThreadPoolController { 5 6 @Autowired 7 private ThreadPoolRegistry registry; 8 9 /** 10 * æŸ¥è¯¢æ‰€æœ‰çº¿ç¨‹æ±  11 */ 12 @GetMapping(\u0026#34;/list\u0026#34;) 13 public Result\u0026lt;List\u0026lt;ThreadPoolInfo\u0026gt;\u0026gt; list() { 14 List\u0026lt;ThreadPoolInfo\u0026gt; list = registry.getAll().entrySet().stream() 15 .map(entry -\u0026gt; ThreadPoolInfo.from(entry.getKey(), entry.getValue())) 16 .collect(Collectors.toList()); 17 return Result.success(list); 18 } 19 20 /** 21 * æŸ¥è¯¢å•ä¸ªçº¿ç¨‹æ± è¯¦æƒ… 22 */ 23 @GetMapping(\u0026#34;/detail/{name}\u0026#34;) 24 public Result\u0026lt;ThreadPoolInfo\u0026gt; detail(@PathVariable String name) { 25 ThreadPoolExecutor executor = registry.get(name); 26 if (executor == null) { 27 return Result.error(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + name); 28 } 29 return Result.success(ThreadPoolInfo.from(name, executor)); 30 } 31 32 /** 33 * åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 34 */ 35 @PostMapping(\u0026#34;/adjust\u0026#34;) 36 public Result\u0026lt;Void\u0026gt; adjust(@RequestBody ThreadPoolAdjustRequest request) { 37 try { 38 registry.adjust( 39 request.getName(), 40 request.getCorePoolSize(), 41 request.getMaximumPoolSize() 42 ); 43 return Result.success(); 44 } catch (Exception e) { 45 log.error(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°å¤±è´¥\u0026#34;, e); 46 return Result.error(e.getMessage()); 47 } 48 } 49} ThreadPoolInfo\n1@Data 2@Builder 3public class ThreadPoolInfo { 4 private String name; 5 private int corePoolSize; 6 private int maximumPoolSize; 7 private int activeCount; 8 private int poolSize; 9 private int queueSize; 10 private int queueCapacity; 11 private long completedTaskCount; 12 private long taskCount; 13 private String rejectedExecutionHandler; 14 private double poolUsageRate; 15 private double queueUsageRate; 16 17 public static ThreadPoolInfo from(String name, ThreadPoolExecutor executor) { 18 int queueSize = executor.getQueue().size(); 19 int queueCapacity = queueSize + executor.getQueue().remainingCapacity(); 20 21 return ThreadPoolInfo.builder() 22 .name(name) 23 .corePoolSize(executor.getCorePoolSize()) 24 .maximumPoolSize(executor.getMaximumPoolSize()) 25 .activeCount(executor.getActiveCount()) 26 .poolSize(executor.getPoolSize()) 27 .queueSize(queueSize) 28 .queueCapacity(queueCapacity) 29 .completedTaskCount(executor.getCompletedTaskCount()) 30 .taskCount(executor.getTaskCount()) 31 .rejectedExecutionHandler(executor.getRejectedExecutionHandler().getClass().getSimpleName()) 32 .poolUsageRate((double) executor.getPoolSize() / executor.getMaximumPoolSize() * 100) 33 .queueUsageRate(queueCapacity == 0 ? 0 : (double) queueSize / queueCapacity * 100) 34 .build(); 35 } 36} ThreadPoolAdjustRequest\n1@Data 2public class ThreadPoolAdjustRequest { 3 @NotBlank(message = \u0026#34;çº¿ç¨‹æ± åç§°ä¸èƒ½ä¸ºç©º\u0026#34;) 4 private String name; 5 6 @Min(value = 1, message = \u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°å¿…é¡»å¤§äº 0\u0026#34;) 7 private int corePoolSize; 8 9 @Min(value = 1, message = \u0026#34;æœ€å¤§çº¿ç¨‹æ•°å¿…é¡»å¤§äº 0\u0026#34;) 10 private int maximumPoolSize; 11} ç¬¬å››æ­¥ï¼šAdmin ç®¡ç†åå° å‰ç«¯æŠ€æœ¯æ ˆ\nVue 3 + Element Plus EChartsï¼ˆå›¾è¡¨å±•ç¤ºï¼‰ Axiosï¼ˆHTTP è¯·æ±‚ï¼‰ çº¿ç¨‹æ± åˆ—è¡¨é¡µé¢\n1\u0026lt;template\u0026gt; 2 \u0026lt;div class=\u0026#34;threadpool-list\u0026#34;\u0026gt; 3 \u0026lt;el-table :data=\u0026#34;threadPoolList\u0026#34; border\u0026gt; 4 \u0026lt;el-table-column prop=\u0026#34;name\u0026#34; label=\u0026#34;çº¿ç¨‹æ± åç§°\u0026#34; width=\u0026#34;200\u0026#34; /\u0026gt; 5 \u0026lt;el-table-column prop=\u0026#34;corePoolSize\u0026#34; label=\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 6 \u0026lt;el-table-column prop=\u0026#34;maximumPoolSize\u0026#34; label=\u0026#34;æœ€å¤§çº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 7 \u0026lt;el-table-column prop=\u0026#34;activeCount\u0026#34; label=\u0026#34;æ´»è·ƒçº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 8 \u0026lt;el-table-column prop=\u0026#34;poolSize\u0026#34; label=\u0026#34;å½“å‰çº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 9 \u0026lt;el-table-column prop=\u0026#34;queueSize\u0026#34; label=\u0026#34;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 10 \u0026lt;el-table-column label=\u0026#34;çº¿ç¨‹æ± ä½¿ç”¨ç‡\u0026#34; width=\u0026#34;150\u0026#34;\u0026gt; 11 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 12 \u0026lt;el-progress 13 :percentage=\u0026#34;row.poolUsageRate\u0026#34; 14 :color=\u0026#34;getProgressColor(row.poolUsageRate)\u0026#34; 15 /\u0026gt; 16 \u0026lt;/template\u0026gt; 17 \u0026lt;/el-table-column\u0026gt; 18 \u0026lt;el-table-column label=\u0026#34;é˜Ÿåˆ—ä½¿ç”¨ç‡\u0026#34; width=\u0026#34;150\u0026#34;\u0026gt; 19 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 20 \u0026lt;el-progress 21 :percentage=\u0026#34;row.queueUsageRate\u0026#34; 22 :color=\u0026#34;getProgressColor(row.queueUsageRate)\u0026#34; 23 /\u0026gt; 24 \u0026lt;/template\u0026gt; 25 \u0026lt;/el-table-column\u0026gt; 26 \u0026lt;el-table-column label=\u0026#34;æ“ä½œ\u0026#34; width=\u0026#34;200\u0026#34;\u0026gt; 27 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 28 \u0026lt;el-button size=\u0026#34;small\u0026#34; @click=\u0026#34;showAdjustDialog(row)\u0026#34;\u0026gt; 29 è°ƒæ•´å‚æ•° 30 \u0026lt;/el-button\u0026gt; 31 \u0026lt;el-button size=\u0026#34;small\u0026#34; @click=\u0026#34;showMonitorDialog(row)\u0026#34;\u0026gt; 32 æŸ¥çœ‹ç›‘æ§ 33 \u0026lt;/el-button\u0026gt; 34 \u0026lt;/template\u0026gt; 35 \u0026lt;/el-table-column\u0026gt; 36 \u0026lt;/el-table\u0026gt; 37 38 \u0026lt;!-- å‚æ•°è°ƒæ•´å¯¹è¯æ¡† --\u0026gt; 39 \u0026lt;el-dialog v-model=\u0026#34;adjustDialogVisible\u0026#34; title=\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°\u0026#34;\u0026gt; 40 \u0026lt;el-form :model=\u0026#34;adjustForm\u0026#34; label-width=\u0026#34;120px\u0026#34;\u0026gt; 41 \u0026lt;el-form-item label=\u0026#34;çº¿ç¨‹æ± åç§°\u0026#34;\u0026gt; 42 \u0026lt;el-input v-model=\u0026#34;adjustForm.name\u0026#34; disabled /\u0026gt; 43 \u0026lt;/el-form-item\u0026gt; 44 \u0026lt;el-form-item label=\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#34;\u0026gt; 45 \u0026lt;el-input-number v-model=\u0026#34;adjustForm.corePoolSize\u0026#34; :min=\u0026#34;1\u0026#34; /\u0026gt; 46 \u0026lt;/el-form-item\u0026gt; 47 \u0026lt;el-form-item label=\u0026#34;æœ€å¤§çº¿ç¨‹æ•°\u0026#34;\u0026gt; 48 \u0026lt;el-input-number v-model=\u0026#34;adjustForm.maximumPoolSize\u0026#34; :min=\u0026#34;1\u0026#34; /\u0026gt; 49 \u0026lt;/el-form-item\u0026gt; 50 \u0026lt;/el-form\u0026gt; 51 \u0026lt;template #footer\u0026gt; 52 \u0026lt;el-button @click=\u0026#34;adjustDialogVisible = false\u0026#34;\u0026gt;å–æ¶ˆ\u0026lt;/el-button\u0026gt; 53 \u0026lt;el-button type=\u0026#34;primary\u0026#34; @click=\u0026#34;adjustThreadPool\u0026#34;\u0026gt;ç¡®å®š\u0026lt;/el-button\u0026gt; 54 \u0026lt;/template\u0026gt; 55 \u0026lt;/el-dialog\u0026gt; 56 \u0026lt;/div\u0026gt; 57\u0026lt;/template\u0026gt; 58 59\u0026lt;script setup\u0026gt; 60import { ref, onMounted } from \u0026#39;vue\u0026#39;; 61import { ElMessage } from \u0026#39;element-plus\u0026#39;; 62import axios from \u0026#39;axios\u0026#39;; 63 64const threadPoolList = ref([]); 65const adjustDialogVisible = ref(false); 66const adjustForm = ref({ 67 name: \u0026#39;\u0026#39;, 68 corePoolSize: 0, 69 maximumPoolSize: 0 70}); 71 72// åŠ è½½çº¿ç¨‹æ± åˆ—è¡¨ 73const loadThreadPoolList = async () =\u0026gt; { 74 const { data } = await axios.get(\u0026#39;/api/threadpool/list\u0026#39;); 75 threadPoolList.value = data.data; 76}; 77 78// æ˜¾ç¤ºè°ƒæ•´å¯¹è¯æ¡† 79const showAdjustDialog = (row) =\u0026gt; { 80 adjustForm.value = { 81 name: row.name, 82 corePoolSize: row.corePoolSize, 83 maximumPoolSize: row.maximumPoolSize 84 }; 85 adjustDialogVisible.value = true; 86}; 87 88// è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 89const adjustThreadPool = async () =\u0026gt; { 90 try { 91 await axios.post(\u0026#39;/api/threadpool/adjust\u0026#39;, adjustForm.value); 92 ElMessage.success(\u0026#39;è°ƒæ•´æˆåŠŸ\u0026#39;); 93 adjustDialogVisible.value = false; 94 loadThreadPoolList(); 95 } catch (error) { 96 ElMessage.error(\u0026#39;è°ƒæ•´å¤±è´¥: \u0026#39; + error.message); 97 } 98}; 99 100// è¿›åº¦æ¡é¢œè‰² 101const getProgressColor = (percentage) =\u0026gt; { 102 if (percentage \u0026lt; 60) return \u0026#39;#67C23A\u0026#39;; 103 if (percentage \u0026lt; 80) return \u0026#39;#E6A23C\u0026#39;; 104 return \u0026#39;#F56C6C\u0026#39;; 105}; 106 107onMounted(() =\u0026gt; { 108 loadThreadPoolList(); 109 // æ¯ 30 ç§’åˆ·æ–°ä¸€æ¬¡ 110 setInterval(loadThreadPoolList, 30000); 111}); 112\u0026lt;/script\u0026gt; å®æ—¶ç›‘æ§é¡µé¢\nä½¿ç”¨ ECharts å±•ç¤ºçº¿ç¨‹æ± æŒ‡æ ‡çš„æ—¶é—´åºåˆ—å›¾ï¼š\n1// çº¿ç¨‹æ± ç›‘æ§å›¾è¡¨ 2const initChart = () =\u0026gt; { 3 const chart = echarts.init(document.getElementById(\u0026#39;chart\u0026#39;)); 4 5 const option = { 6 title: { text: \u0026#39;çº¿ç¨‹æ± ç›‘æ§\u0026#39; }, 7 tooltip: { trigger: \u0026#39;axis\u0026#39; }, 8 legend: { 9 data: [\u0026#39;æ´»è·ƒçº¿ç¨‹æ•°\u0026#39;, \u0026#39;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#39;, \u0026#39;å®Œæˆä»»åŠ¡æ•°\u0026#39;] 10 }, 11 xAxis: { 12 type: \u0026#39;category\u0026#39;, 13 data: timeLabels.value 14 }, 15 yAxis: { type: \u0026#39;value\u0026#39; }, 16 series: [ 17 { 18 name: \u0026#39;æ´»è·ƒçº¿ç¨‹æ•°\u0026#39;, 19 type: \u0026#39;line\u0026#39;, 20 data: activeCountData.value 21 }, 22 { 23 name: \u0026#39;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#39;, 24 type: \u0026#39;line\u0026#39;, 25 data: queueSizeData.value 26 }, 27 { 28 name: \u0026#39;å®Œæˆä»»åŠ¡æ•°\u0026#39;, 29 type: \u0026#39;line\u0026#39;, 30 data: completedTaskCountData.value 31 } 32 ] 33 }; 34 35 chart.setOption(option); 36}; ç¬¬äº”æ­¥ï¼šæŒä¹…åŒ–é…ç½® å°†è°ƒæ•´åçš„å‚æ•°æŒä¹…åŒ–åˆ°æ•°æ®åº“æˆ–é…ç½®ä¸­å¿ƒï¼Œé‡å¯åè‡ªåŠ¨åŠ è½½ã€‚\næ•°æ®åº“è¡¨è®¾è®¡\n1CREATE TABLE threadpool_config ( 2 id BIGINT PRIMARY KEY AUTO_INCREMENT, 3 name VARCHAR(100) NOT NULL UNIQUE COMMENT \u0026#39;çº¿ç¨‹æ± åç§°\u0026#39;, 4 core_pool_size INT NOT NULL COMMENT \u0026#39;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#39;, 5 maximum_pool_size INT NOT NULL COMMENT \u0026#39;æœ€å¤§çº¿ç¨‹æ•°\u0026#39;, 6 keep_alive_time BIGINT NOT NULL COMMENT \u0026#39;ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰\u0026#39;, 7 queue_capacity INT NOT NULL COMMENT \u0026#39;é˜Ÿåˆ—å®¹é‡\u0026#39;, 8 rejected_execution_handler VARCHAR(100) COMMENT \u0026#39;æ‹’ç»ç­–ç•¥\u0026#39;, 9 created_time DATETIME NOT NULL, 10 updated_time DATETIME NOT NULL, 11 INDEX idx_name (name) 12) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;çº¿ç¨‹æ± é…ç½®è¡¨\u0026#39;; é…ç½®åŠ è½½\n1@Component 2public class ThreadPoolConfigLoader implements ApplicationRunner { 3 4 @Autowired 5 private ThreadPoolConfigMapper configMapper; 6 7 @Autowired 8 private ThreadPoolRegistry registry; 9 10 @Override 11 public void run(ApplicationArguments args) { 12 // ä»æ•°æ®åº“åŠ è½½é…ç½® 13 List\u0026lt;ThreadPoolConfig\u0026gt; configs = configMapper.selectAll(); 14 15 for (ThreadPoolConfig config : configs) { 16 ThreadPoolExecutor executor = registry.get(config.getName()); 17 if (executor != null) { 18 // åº”ç”¨é…ç½® 19 executor.setCorePoolSize(config.getCorePoolSize()); 20 executor.setMaximumPoolSize(config.getMaximumPoolSize()); 21 22 log.info(\u0026#34;åŠ è½½çº¿ç¨‹æ± é…ç½®: {}\u0026#34;, config); 23 } 24 } 25 } 26} é…ç½®ä¿å­˜\n1@Service 2public class ThreadPoolConfigService { 3 4 @Autowired 5 private ThreadPoolConfigMapper configMapper; 6 7 @Transactional 8 public void saveConfig(String name, int corePoolSize, int maximumPoolSize) { 9 ThreadPoolConfig config = configMapper.selectByName(name); 10 11 if (config == null) { 12 config = new ThreadPoolConfig(); 13 config.setName(name); 14 config.setCreatedTime(LocalDateTime.now()); 15 } 16 17 config.setCorePoolSize(corePoolSize); 18 config.setMaximumPoolSize(maximumPoolSize); 19 config.setUpdatedTime(LocalDateTime.now()); 20 21 configMapper.insertOrUpdate(config); 22 } 23} é¿å‘æç¤ºï¼š åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°æ—¶ï¼Œè¦æ³¨æ„å‚æ•°çš„åˆæ³•æ€§æ ¡éªŒã€‚æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å¤§äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¦åˆ™ä¼šæŠ›å‡º IllegalArgumentExceptionã€‚è°ƒæ•´å‚æ•°åï¼Œå»ºè®®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œé¿å…é‡å¯åé…ç½®ä¸¢å¤±ã€‚\nå‚æ•°è°ƒä¼˜æœ€ä½³å®è·µ 1. æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®\nCPU å¯†é›†å‹ä»»åŠ¡ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° + 1 IO å¯†é›†å‹ä»»åŠ¡ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2 2. æœ€å¤§çº¿ç¨‹æ•°è®¾ç½®\næœ€å¤§çº¿ç¨‹æ•° = æ ¸å¿ƒçº¿ç¨‹æ•° * 1.5 ~ 2\n3. é˜Ÿåˆ—å®¹é‡è®¾ç½®\næœ‰ç•Œé˜Ÿåˆ—ï¼šå»ºè®® 100-1000ï¼Œé¿å…å†…å­˜æº¢å‡º æ— ç•Œé˜Ÿåˆ—ï¼šæ…ç”¨ï¼Œå¯èƒ½å¯¼è‡´ OOM 4. æ‹’ç»ç­–ç•¥é€‰æ‹©\nç­–ç•¥ è¯´æ˜ é€‚ç”¨åœºæ™¯ AbortPolicy æŠ›å‡ºå¼‚å¸¸ éœ€è¦æ„ŸçŸ¥ä»»åŠ¡è¢«æ‹’ç» CallerRunsPolicy è°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ ä»»åŠ¡ä¸èƒ½ä¸¢å¤± DiscardPolicy é™é»˜ä¸¢å¼ƒ ä»»åŠ¡å¯ä»¥ä¸¢å¤± DiscardOldestPolicy ä¸¢å¼ƒæœ€è€çš„ä»»åŠ¡ ä¼˜å…ˆæ‰§è¡Œæ–°ä»»åŠ¡ 5. ç›‘æ§å‘Šè­¦\né˜Ÿåˆ—ä½¿ç”¨ç‡ \u0026gt; 80%ï¼šå‘Šè­¦ çº¿ç¨‹æ± ä½¿ç”¨ç‡ \u0026gt; 90%ï¼šå‘Šè­¦ ä»»åŠ¡æ‹’ç»æ¬¡æ•° \u0026gt; 0ï¼šå‘Šè­¦ æ€»ç»“ä¸æ€è€ƒ çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ ThreadPoolRegistry ç»Ÿä¸€ç®¡ç†æ‰€æœ‰çº¿ç¨‹æ±  é€šè¿‡ BeanPostProcessor è‡ªåŠ¨æ³¨å†Œçº¿ç¨‹æ±  å®šæ—¶é‡‡é›†ç›‘æ§æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ æä¾› REST API å’Œç®¡ç†åå°ï¼Œæ–¹ä¾¿è¿ç»´äººå‘˜è°ƒæ•´å‚æ•° å°†é…ç½®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œé‡å¯åè‡ªåŠ¨åŠ è½½ çº¿ç¨‹æ± å‚æ•°çš„è°ƒä¼˜æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®å®é™…è´Ÿè½½ä¸æ–­è°ƒæ•´ã€‚é€šè¿‡ç›‘æ§æ•°æ®åˆ†æï¼Œæ‰¾åˆ°æœ€ä¼˜çš„å‚æ•°é…ç½®ã€‚\nä¸‹æ¬¡å½“ä½ çš„çº¿ç¨‹æ± å‡ºç°æ€§èƒ½é—®é¢˜æ—¶ï¼Œä¸å¦¨è¯•è¯•æœ¬æ–‡ä»‹ç»çš„åŠ¨æ€é…ç½®æ–¹æ¡ˆï¼Œè®©çº¿ç¨‹æ± å‚æ•°è°ƒæ•´å˜å¾—æ›´åŠ çµæ´»å’Œé«˜æ•ˆã€‚\n","permalink":"http://localhost:1313/posts/2025/01/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8F%82%E6%95%B0%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AEadmin-%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1/","summary":"\u003cp\u003eåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°çš„é…ç½®å¾€å¾€éœ€è¦æ ¹æ®å®é™…è´Ÿè½½åŠ¨æ€è°ƒæ•´ã€‚ç¡¬ç¼–ç çš„å‚æ•°é…ç½®ç¼ºä¹çµæ´»æ€§ï¼Œé‡å¯æœåŠ¡åˆä¼šå½±å“ä¸šåŠ¡ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•è®¾è®¡ä¸€ä¸ªçº¿ç¨‹æ± ç®¡ç†åå°ï¼Œå®ç°å‚æ•°çš„åŠ¨æ€é…ç½®å’Œå®æ—¶ç›‘æ§ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£çº¿ç¨‹æ± å‚æ•°åŠ¨æ€è°ƒæ•´çš„åŸç†ä¸å®ç°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡çº¿ç¨‹æ± ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†ä¸å±•ç¤º\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡ç”Ÿäº§çº§çš„çº¿ç¨‹æ± ç®¡ç†å¹³å°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®\"\u003eä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šæµé‡çªå¢\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåŒåä¸€æœŸé—´ï¼Œè®¢å•å¤„ç†çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º 10ï¼Œæœ€å¤§çº¿ç¨‹æ•° 20ã€‚çªç„¶æµé‡æš´å¢ï¼Œé˜Ÿåˆ—å †ç§¯ä¸¥é‡ï¼Œå¯¼è‡´è®¢å•å¤„ç†å»¶è¿Ÿã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœèƒ½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼Œå°†æ ¸å¿ƒçº¿ç¨‹æ•°è°ƒæ•´ä¸º 50ï¼Œæœ€å¤§çº¿ç¨‹æ•°è°ƒæ•´ä¸º 100ï¼Œå°±èƒ½å¿«é€Ÿåº”å¯¹æµé‡é«˜å³°ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šèµ„æºæµªè´¹\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå‡Œæ™¨æ—¶æ®µæµé‡å¾ˆä½ï¼Œä½†çº¿ç¨‹æ± ä»ç„¶ä¿æŒé«˜å³°æœŸçš„é…ç½®ï¼Œæµªè´¹äº†å¤§é‡ç³»ç»Ÿèµ„æºã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿåšæ³•çš„é—®é¢˜\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eThreadPoolConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;orderThreadPool\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eorderThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æœ€å¤§çº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e60\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLinkedBlockingQueue\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadFactoryBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003esetNameFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;order-pool-%d\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003ebuild\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eCallerRunsPolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e","title":"çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®ï¼šAdmin ç®¡ç†åå°è®¾è®¡"},{"content":"ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚æœ¬æ–‡é€šè¿‡çœŸå®çš„ç”Ÿäº§æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Œè®©ä½ æŒæ¡ SQL æ€§èƒ½è°ƒä¼˜çš„å®Œæ•´æ–¹æ³•è®ºã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„åˆ†ææ–¹æ³• å­¦ä¼šä½¿ç”¨ Explain å®šä½æ€§èƒ½ç“¶é¢ˆ äº†è§£å¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§ ç†è§£æ•°æ®åº“å±‚é¢çš„æ€§èƒ½ä¼˜åŒ– æ¡ˆä¾‹èƒŒæ™¯ æŸç”µå•†ç³»ç»Ÿçš„è®¢å•åˆ—è¡¨æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´è¾¾åˆ° 5 ç§’ï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚\nåŸå§‹ SQL\n1SELECT o.*, u.username, u.phone 2FROM `order` o 3LEFT JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; æ•°æ®é‡ï¼š\norder è¡¨ï¼š100 ä¸‡æ¡ user è¡¨ï¼š50 ä¸‡æ¡ ç¬¬ä¸€æ­¥ï¼šå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— é…ç½® MySQL\n1[mysqld] 2slow_query_log = 1 3slow_query_log_file = /var/log/mysql/slow.log 4long_query_time = 1 5log_queries_not_using_indexes = 1 åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—\n1# ä½¿ç”¨ mysqldumpslow åˆ†æ 2mysqldumpslow -s t -t 10 /var/log/mysql/slow.log è¾“å‡ºï¼š\n1Count: 1000 Time=5.23s (5230s) Lock=0.00s (0s) Rows=20.0 (20000) 2SELECT o.*, u.username, u.phone FROM order o LEFT JOIN user u ... ç¬¬äºŒæ­¥ï¼šExplain åˆ†ææ‰§è¡Œè®¡åˆ’ 1EXPLAIN SELECT o.*, u.username, u.phone 2FROM `order` o 3LEFT JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; æ‰§è¡Œè®¡åˆ’åˆ†æ\nid table type key rows Extra 1 o ALL NULL 1000000 Using where; Using filesort 1 u eq_ref PRIMARY 1 Using where é—®é¢˜ï¼š\norder è¡¨å…¨è¡¨æ‰«æï¼ˆtype = ALLï¼‰ æ‰«æäº† 100 ä¸‡è¡Œæ•°æ® éœ€è¦é¢å¤–çš„æ’åºæ“ä½œï¼ˆUsing filesortï¼‰ ç¬¬ä¸‰æ­¥ï¼šä¼˜åŒ–ç´¢å¼• åˆ†ææŸ¥è¯¢æ¡ä»¶\nWHEREï¼šstatusã€create_time JOINï¼šuser_id ORDER BYï¼šcreate_time åˆ›å»ºè”åˆç´¢å¼•\n1CREATE INDEX idx_status_time ON `order`(status, create_time); å†æ¬¡ Explain\nid table type key rows Extra 1 o range idx_status_time 50000 Using index condition 1 u eq_ref PRIMARY 1 Using where æ”¹è¿›ï¼š\ntype ä» ALL å˜æˆ range rows ä» 100 ä¸‡é™ä½åˆ° 5 ä¸‡ å»æ‰äº† Using filesort æ‰§è¡Œæ—¶é—´ï¼šä» 5 ç§’é™ä½åˆ° 800ms\nç¬¬å››æ­¥ï¼šä¼˜åŒ– JOIN é—®é¢˜åˆ†æ\nLEFT JOIN ä¼šå…ˆæŸ¥è¯¢ order è¡¨çš„æ‰€æœ‰æ•°æ®ï¼Œç„¶åå†å…³è” user è¡¨ã€‚ä½†å®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦ city = \u0026lsquo;Beijing\u0026rsquo; çš„ç”¨æˆ·ã€‚\nä¼˜åŒ–æ–¹æ¡ˆï¼šæ”¹ä¸º INNER JOIN\n1SELECT o.*, u.username, u.phone 2FROM `order` o 3INNER JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; ä¸º user è¡¨åˆ›å»ºç´¢å¼•\n1CREATE INDEX idx_city ON user(city); å†æ¬¡ Explain\nid table type key rows Extra 1 u ref idx_city 10000 Using where 1 o ref idx_user_status_time 100 Using where æ‰§è¡Œæ—¶é—´ï¼šä» 800ms é™ä½åˆ° 200ms\nç¬¬äº”æ­¥ï¼šé¿å… SELECT * é—®é¢˜\nSELECT * ä¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬ä¸éœ€è¦çš„å¤§å­—æ®µï¼ˆå¦‚è®¢å•è¯¦æƒ… JSONï¼‰ã€‚\nä¼˜åŒ–\n1SELECT o.id, o.order_no, o.amount, o.status, o.create_time, 2 u.username, u.phone 3FROM `order` o 4INNER JOIN user u ON o.user_id = u.id 5WHERE o.status IN (1, 2, 3) 6 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 7 AND u.city = \u0026#39;Beijing\u0026#39; 8ORDER BY o.create_time DESC 9LIMIT 20; æ‰§è¡Œæ—¶é—´ï¼šä» 200ms é™ä½åˆ° 120ms\nç¬¬å…­æ­¥ï¼šä½¿ç”¨è¦†ç›–ç´¢å¼• åˆ›å»ºè¦†ç›–ç´¢å¼•\n1CREATE INDEX idx_status_time_user ON `order`(status, create_time, user_id); ä¼˜åŒ–åçš„ Explain\nid table type key rows Extra 1 u ref idx_city 10000 Using index 1 o ref idx_status_time_user 100 Using index Extra å˜æˆäº† Using indexï¼Œè¯´æ˜ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ã€‚\næ‰§è¡Œæ—¶é—´ï¼šä» 120ms é™ä½åˆ° 50ms\nä¼˜åŒ–æ€»ç»“ ä¼˜åŒ–æ­¥éª¤ æ‰§è¡Œæ—¶é—´ ä¼˜åŒ–æ•ˆæœ åŸå§‹ SQL 5000ms - åˆ›å»ºç´¢å¼• 800ms æå‡ 6.25 å€ ä¼˜åŒ– JOIN 200ms æå‡ 4 å€ é¿å… SELECT * 120ms æå‡ 1.67 å€ ä½¿ç”¨è¦†ç›–ç´¢å¼• 50ms æå‡ 2.4 å€ æ€»ä½“æå‡ï¼š100 å€\nå¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§ 1. é¿å…åœ¨ WHERE ä¸­ä½¿ç”¨å‡½æ•°\n1-- ä¸å¥½ 2SELECT * FROM `order` WHERE DATE(create_time) = \u0026#39;2024-01-01\u0026#39;; 3 4-- å¥½ 5SELECT * FROM `order` WHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2024-01-02\u0026#39;; 2. ä½¿ç”¨ UNION ALL ä»£æ›¿ UNION\nUNION ä¼šå»é‡ï¼Œéœ€è¦é¢å¤–çš„æ’åºæ“ä½œã€‚å¦‚æœç¡®å®šæ²¡æœ‰é‡å¤æ•°æ®ï¼Œä½¿ç”¨ UNION ALLã€‚\n1-- ä¸å¥½ 2SELECT * FROM order WHERE status = 1 3UNION 4SELECT * FROM order WHERE status = 2; 5 6-- å¥½ 7SELECT * FROM order WHERE status = 1 8UNION ALL 9SELECT * FROM order WHERE status = 2; 3. ä½¿ç”¨ EXISTS ä»£æ›¿ IN\nå½“å­æŸ¥è¯¢ç»“æœé›†å¾ˆå¤§æ—¶ï¼ŒEXISTS æ€§èƒ½æ›´å¥½ã€‚\n1-- ä¸å¥½ 2SELECT * FROM user WHERE id IN (SELECT user_id FROM order); 3 4-- å¥½ 5SELECT * FROM user u WHERE EXISTS (SELECT 1 FROM order o WHERE o.user_id = u.id); 4. é¿å…ä½¿ç”¨å­æŸ¥è¯¢\nå­æŸ¥è¯¢ä¼šåˆ›å»ºä¸´æ—¶è¡¨ï¼Œæ€§èƒ½è¾ƒå·®ã€‚å¯ä»¥æ”¹ä¸º JOINã€‚\n1-- ä¸å¥½ 2SELECT * FROM user WHERE id IN (SELECT user_id FROM order WHERE status = 1); 3 4-- å¥½ 5SELECT DISTINCT u.* FROM user u 6INNER JOIN order o ON u.id = o.user_id 7WHERE o.status = 1; 5. åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é‡\n1-- ä¸å¥½ï¼šä¸€æ¬¡æ›´æ–° 100 ä¸‡æ¡æ•°æ® 2UPDATE order SET status = 2 WHERE status = 1; 3 4-- å¥½ï¼šåˆ†æ‰¹æ›´æ–° 5UPDATE order SET status = 2 WHERE status = 1 LIMIT 1000; 6. ä½¿ç”¨ LIMIT é™åˆ¶è¿”å›æ•°æ®é‡\n1-- ä¸å¥½ 2SELECT * FROM order WHERE status = 1; 3 4-- å¥½ 5SELECT * FROM order WHERE status = 1 LIMIT 100; æ•°æ®åº“å±‚é¢çš„ä¼˜åŒ– 1. è°ƒæ•´ InnoDB ç¼“å†²æ± å¤§å°\n1[mysqld] 2innodb_buffer_pool_size = 8G # è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 70-80% 2. å¼€å¯æŸ¥è¯¢ç¼“å­˜ï¼ˆMySQL 5.7 åŠä»¥ä¸‹ï¼‰\n1[mysqld] 2query_cache_type = 1 3query_cache_size = 256M æ³¨æ„ï¼šMySQL 8.0 å·²ç§»é™¤æŸ¥è¯¢ç¼“å­˜ã€‚\n3. è°ƒæ•´è¿æ¥æ•°\n1[mysqld] 2max_connections = 1000 4. å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\n1[mysqld] 2slow_query_log = 1 3long_query_time = 1 5. å®šæœŸåˆ†æè¡¨\n1ANALYZE TABLE order; æ›´æ–°è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¸®åŠ©ä¼˜åŒ–å™¨é€‰æ‹©æ›´å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚\nç›‘æ§ä¸é¢„è­¦ 1. ä½¿ç”¨ Prometheus + Grafana ç›‘æ§\nç›‘æ§æŒ‡æ ‡ï¼š\nQPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰ æ…¢æŸ¥è¯¢æ•°é‡ è¿æ¥æ•° ç¼“å†²æ± å‘½ä¸­ç‡ 2. è®¾ç½®æ…¢æŸ¥è¯¢å‘Šè­¦\nå½“æ…¢æŸ¥è¯¢æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œå‘é€å‘Šè­¦é€šçŸ¥ã€‚\n3. å®šæœŸå®¡æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—\næ¯å‘¨åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæ‰¾å‡ºéœ€è¦ä¼˜åŒ–çš„ SQLã€‚\næ€»ç»“ä¸æ€è€ƒ SQL æ€§èƒ½ä¼˜åŒ–çš„æ–¹æ³•è®ºï¼š\nå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå®šä½é—®é¢˜ SQL ä½¿ç”¨ Explain åˆ†ææ‰§è¡Œè®¡åˆ’ åˆ›å»ºåˆé€‚çš„ç´¢å¼• ä¼˜åŒ– SQL è¯­å¥ï¼ˆé¿å… SELECT *ã€ä¼˜åŒ– JOINï¼‰ æ•°æ®åº“å±‚é¢ä¼˜åŒ–ï¼ˆè°ƒæ•´å‚æ•°ã€ç›‘æ§ï¼‰ æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡å˜åŒ–ä¸æ–­è°ƒæ•´ã€‚\nè®°ä½ï¼šè¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚å…ˆä¿è¯åŠŸèƒ½æ­£ç¡®ï¼Œå†æ ¹æ®ç›‘æ§æ•°æ®ä¼˜åŒ–æ€§èƒ½ã€‚\nä¸‹æ¬¡å½“ä½ çš„ SQL æŸ¥è¯¢å¾ˆæ…¢æ—¶ï¼ŒæŒ‰ç…§è¿™ä¸ªæ–¹æ³•è®ºä¸€æ­¥æ­¥æ’æŸ¥ï¼Œä¸€å®šèƒ½æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚\n","permalink":"http://localhost:1313/posts/2024/12/mysql-%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/","summary":"\u003cp\u003eä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚æœ¬æ–‡é€šè¿‡çœŸå®çš„ç”Ÿäº§æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Œè®©ä½ æŒæ¡ SQL æ€§èƒ½è°ƒä¼˜çš„å®Œæ•´æ–¹æ³•è®ºã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ Explain å®šä½æ€§èƒ½ç“¶é¢ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£æ•°æ®åº“å±‚é¢çš„æ€§èƒ½ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¡ˆä¾‹èƒŒæ™¯\"\u003eæ¡ˆä¾‹èƒŒæ™¯\u003c/h2\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿçš„è®¢å•åˆ—è¡¨æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´è¾¾åˆ° 5 ç§’ï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåŸå§‹ SQL\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eusername\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ephone\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e`\u003c/span\u003e\u003cspan class=\"k\"\u003eorder\u003c/span\u003e\u003cspan class=\"o\"\u003e`\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eLEFT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eJOIN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eON\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003euser_id\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eWHERE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eIN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003eAND\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;2024-01-01\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003eAND\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecity\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Beijing\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eORDER\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eBY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eDESC\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eLIMIT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ•°æ®é‡ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eorder è¡¨ï¼š100 ä¸‡æ¡\u003c/li\u003e\n\u003cli\u003euser è¡¨ï¼š50 ä¸‡æ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\"\u003eç¬¬ä¸€æ­¥ï¼šå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eé…ç½® MySQL\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[mysqld]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eslow_query_log\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eslow_query_log_file\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/mysql/slow.log\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elong_query_time\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elog_queries_not_using_indexes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—\u003c/strong\u003e\u003c/p\u003e","title":"MySQL æ…¢æŸ¥è¯¢ä¼˜åŒ–å®æˆ˜æ¡ˆä¾‹"},{"content":"åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŸMySQL é€šè¿‡äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œ MVCC æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡æ·±å…¥å‰–æ MySQL çš„å¹¶å‘æ§åˆ¶åŸç†ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯ æŒæ¡ MVCC çš„ ReadView æœºåˆ¶ å­¦ä¼šè§£å†³å¹»è¯»é—®é¢˜çš„æ–¹æ³• äº†è§£é”æœºåˆ¶ä¸ MVCC çš„é…åˆ äº‹åŠ¡çš„å¹¶å‘é—®é¢˜ è„è¯»ï¼ˆDirty Readï¼‰\näº‹åŠ¡ A è¯»å–äº†äº‹åŠ¡ B æœªæäº¤çš„æ•°æ®ï¼Œäº‹åŠ¡ B å›æ»šåï¼Œäº‹åŠ¡ A è¯»åˆ°çš„æ•°æ®æ˜¯æ— æ•ˆçš„ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ 3T2: äº‹åŠ¡ B å¼€å§‹ï¼Œå°† balance ä» 100 æ”¹ä¸º 200 4T3: äº‹åŠ¡ A è¯»å– balance = 200ï¼ˆè„è¯»ï¼‰ 5T4: äº‹åŠ¡ B å›æ»šï¼Œbalance æ¢å¤ä¸º 100 6T5: äº‹åŠ¡ A æäº¤ ä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readï¼‰\näº‹åŠ¡ A ä¸¤æ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸ä¸€è‡´ï¼ˆå› ä¸ºäº‹åŠ¡ B ä¿®æ”¹å¹¶æäº¤äº†æ•°æ®ï¼‰ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A è¯»å– balance = 100 3T2: äº‹åŠ¡ B å°† balance æ”¹ä¸º 200 å¹¶æäº¤ 4T3: äº‹åŠ¡ A å†æ¬¡è¯»å– balance = 200ï¼ˆä¸å¯é‡å¤è¯»ï¼‰ å¹»è¯»ï¼ˆPhantom Readï¼‰\näº‹åŠ¡ A ä¸¤æ¬¡æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢å¤šå‡ºäº†æ–°çš„è¡Œï¼ˆå› ä¸ºäº‹åŠ¡ B æ’å…¥äº†æ–°æ•°æ®ï¼‰ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A æŸ¥è¯¢ age \u0026gt; 20 çš„ç”¨æˆ·ï¼Œç»“æœ 2 æ¡ 3T2: äº‹åŠ¡ B æ’å…¥ä¸€æ¡ age = 25 çš„ç”¨æˆ·å¹¶æäº¤ 4T3: äº‹åŠ¡ A å†æ¬¡æŸ¥è¯¢ age \u0026gt; 20 çš„ç”¨æˆ·ï¼Œç»“æœ 3 æ¡ï¼ˆå¹»è¯»ï¼‰ å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ« éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» READ UNCOMMITTED å¯èƒ½ å¯èƒ½ å¯èƒ½ READ COMMITTED ä¸å¯èƒ½ å¯èƒ½ å¯èƒ½ REPEATABLE READï¼ˆé»˜è®¤ï¼‰ ä¸å¯èƒ½ ä¸å¯èƒ½ å¯èƒ½ SERIALIZABLE ä¸å¯èƒ½ ä¸å¯èƒ½ ä¸å¯èƒ½ æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«\n1SELECT @@transaction_isolation; è®¾ç½®éš”ç¦»çº§åˆ«\n1-- ä¼šè¯çº§åˆ« 2SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; 3 4-- å…¨å±€çº§åˆ« 5SET GLOBAL TRANSACTION ISOLATION LEVEL REPEATABLE READ; READ UNCOMMITTEDï¼šè¯»æœªæäº¤ ç‰¹ç‚¹ï¼š äº‹åŠ¡å¯ä»¥è¯»å–å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚\né—®é¢˜ï¼š ä¼šå‡ºç°è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€‚\né€‚ç”¨åœºæ™¯ï¼š å‡ ä¹ä¸ä½¿ç”¨ï¼Œæ•°æ®ä¸€è‡´æ€§æ— æ³•ä¿è¯ã€‚\næ¼”ç¤ºè„è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9 10-- äº‹åŠ¡ A 11SELECT balance FROM account WHERE id = 1; -- 200ï¼ˆè„è¯»ï¼‰ 12 13-- äº‹åŠ¡ B 14ROLLBACK; 15 16-- äº‹åŠ¡ A 17SELECT balance FROM account WHERE id = 1; -- 100 18COMMIT; READ COMMITTEDï¼šè¯»å·²æäº¤ ç‰¹ç‚¹ï¼š äº‹åŠ¡åªèƒ½è¯»å–å…¶ä»–äº‹åŠ¡å·²æäº¤çš„æ•°æ®ã€‚\né—®é¢˜ï¼š ä¼šå‡ºç°ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€‚\né€‚ç”¨åœºæ™¯ï¼š Oracleã€PostgreSQL çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚\næ¼”ç¤ºä¸å¯é‡å¤è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9COMMIT; 10 11-- äº‹åŠ¡ A 12SELECT balance FROM account WHERE id = 1; -- 200ï¼ˆä¸å¯é‡å¤è¯»ï¼‰ 13COMMIT; REPEATABLE READï¼šå¯é‡å¤è¯» ç‰¹ç‚¹ï¼š äº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸€è‡´ã€‚\né—®é¢˜ï¼š ç†è®ºä¸Šä¼šå‡ºç°å¹»è¯»ï¼Œä½† MySQL é€šè¿‡ MVCC + Next-Key Lock è§£å†³äº†å¤§éƒ¨åˆ†å¹»è¯»é—®é¢˜ã€‚\né€‚ç”¨åœºæ™¯ï¼š MySQL çš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ã€‚\næ¼”ç¤ºå¯é‡å¤è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9COMMIT; 10 11-- äº‹åŠ¡ A 12SELECT balance FROM account WHERE id = 1; -- 100ï¼ˆå¯é‡å¤è¯»ï¼‰ 13COMMIT; SERIALIZABLEï¼šä¸²è¡ŒåŒ– ç‰¹ç‚¹ï¼š äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œå®Œå…¨é¿å…å¹¶å‘é—®é¢˜ã€‚\né—®é¢˜ï¼š æ€§èƒ½æœ€å·®ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚\né€‚ç”¨åœºæ™¯ï¼š å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼ˆå¦‚é‡‘èç³»ç»Ÿï¼‰ã€‚\nå®ç°æ–¹å¼ï¼š å¯¹è¯»å–çš„æ¯ä¸€è¡Œæ•°æ®éƒ½åŠ é”ã€‚\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE; 3START TRANSACTION; 4SELECT * FROM account WHERE id = 1; -- åŠ å…±äº«é” 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; -- ç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é” MVCCï¼šå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ æ ¸å¿ƒæ€æƒ³ï¼š ä¸ºæ¯ä¸ªäº‹åŠ¡æä¾›æ•°æ®çš„å¿«ç…§ï¼Œä¸åŒäº‹åŠ¡çœ‹åˆ°ä¸åŒç‰ˆæœ¬çš„æ•°æ®ã€‚\nä¼˜åŠ¿ï¼š\nè¯»ä¸åŠ é”ï¼Œå†™ä¸é˜»å¡è¯» æå‡å¹¶å‘æ€§èƒ½ å®ç°æœºåˆ¶ï¼š\néšè—å­—æ®µï¼šDB_TRX_IDã€DB_ROLL_PTRã€DB_ROW_ID Undo Logï¼šè®°å½•æ•°æ®çš„å†å²ç‰ˆæœ¬ ReadViewï¼šåˆ¤æ–­æ•°æ®ç‰ˆæœ¬çš„å¯è§æ€§ éšè—å­—æ®µ InnoDB ä¸ºæ¯ä¸€è¡Œæ•°æ®æ·»åŠ äº†ä¸‰ä¸ªéšè—å­—æ®µï¼š\nå­—æ®µ è¯´æ˜ DB_TRX_ID æœ€åä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡ ID DB_ROLL_PTR æŒ‡å‘ Undo Log çš„æŒ‡é’ˆ DB_ROW_ID è¡Œ IDï¼ˆå¦‚æœæ²¡æœ‰ä¸»é”®ï¼‰ ç¤ºä¾‹\n1åŸå§‹æ•°æ®ï¼š 2id | name | age | DB_TRX_ID | DB_ROLL_PTR 31 | Alice | 20 | 100 | NULL 4 5äº‹åŠ¡ 101 ä¿®æ”¹ï¼š 6id | name | age | DB_TRX_ID | DB_ROLL_PTR 71 | Alice | 25 | 101 | â†’ Undo Log (age=20, TRX_ID=100) 8 9äº‹åŠ¡ 102 ä¿®æ”¹ï¼š 10id | name | age | DB_TRX_ID | DB_ROLL_PTR 111 | Alice | 30 | 102 | â†’ Undo Log (age=25, TRX_ID=101) é€šè¿‡ Undo Logï¼Œå¯ä»¥æ„å»ºç‰ˆæœ¬é“¾ï¼Œå›æº¯åˆ°ä»»æ„å†å²ç‰ˆæœ¬ã€‚\nReadViewï¼šå¯è§æ€§åˆ¤æ–­ ReadView æ˜¯äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºçš„å¿«ç…§ï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š\nå­—æ®µ è¯´æ˜ m_ids å½“å‰æ´»è·ƒçš„äº‹åŠ¡ ID åˆ—è¡¨ min_trx_id æœ€å°çš„æ´»è·ƒäº‹åŠ¡ ID max_trx_id ä¸‹ä¸€ä¸ªè¦åˆ†é…çš„äº‹åŠ¡ ID creator_trx_id åˆ›å»º ReadView çš„äº‹åŠ¡ ID å¯è§æ€§è§„åˆ™\nå¯¹äºæ•°æ®è¡Œçš„ DB_TRX_IDï¼š\nå¦‚æœ DB_TRX_ID \u0026lt; min_trx_idï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬åœ¨ ReadView åˆ›å»ºå‰å·²æäº¤ï¼Œå¯è§ å¦‚æœ DB_TRX_ID \u0026gt;= max_trx_idï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬åœ¨ ReadView åˆ›å»ºåæ‰å¼€å§‹ï¼Œä¸å¯è§ å¦‚æœ min_trx_id \u0026lt;= DB_TRX_ID \u0026lt; max_trx_idï¼š å¦‚æœ DB_TRX_ID åœ¨ m_ids ä¸­ï¼Œè¯´æ˜è¯¥äº‹åŠ¡è¿˜æœªæäº¤ï¼Œä¸å¯è§ å¦‚æœ DB_TRX_ID ä¸åœ¨ m_ids ä¸­ï¼Œè¯´æ˜è¯¥äº‹åŠ¡å·²æäº¤ï¼Œå¯è§ å¦‚æœ DB_TRX_ID == creator_trx_idï¼Œè¯´æ˜æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ä¿®æ”¹çš„ï¼Œå¯è§ å¦‚æœå½“å‰ç‰ˆæœ¬ä¸å¯è§ï¼Œé€šè¿‡ DB_ROLL_PTR æ‰¾åˆ° Undo Log ä¸­çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œç»§ç»­åˆ¤æ–­ã€‚\nREAD COMMITTED ä¸ REPEATABLE READ çš„åŒºåˆ« READ COMMITTED\næ¯æ¬¡ SELECT éƒ½åˆ›å»ºæ–°çš„ ReadViewã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ï¼ˆTRX_ID=100ï¼‰ 3T2: äº‹åŠ¡ A ç¬¬ä¸€æ¬¡ SELECTï¼Œåˆ›å»º ReadView1ï¼ˆm_ids=[100]ï¼‰ 4T3: äº‹åŠ¡ Bï¼ˆTRX_ID=101ï¼‰ä¿®æ”¹æ•°æ®å¹¶æäº¤ 5T4: äº‹åŠ¡ A ç¬¬äºŒæ¬¡ SELECTï¼Œåˆ›å»º ReadView2ï¼ˆm_ids=[100]ï¼‰ 6 æ­¤æ—¶äº‹åŠ¡ 101 å·²æäº¤ï¼Œä¸åœ¨ m_ids ä¸­ï¼Œå¯è§ ç»“æœï¼šä¸¤æ¬¡ SELECT ç»“æœä¸åŒï¼ˆä¸å¯é‡å¤è¯»ï¼‰ã€‚\nREPEATABLE READ\näº‹åŠ¡å¼€å§‹æ—¶åˆ›å»º ReadViewï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´å¤ç”¨ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ï¼ˆTRX_ID=100ï¼‰ï¼Œåˆ›å»º ReadViewï¼ˆm_ids=[100]ï¼‰ 3T2: äº‹åŠ¡ A ç¬¬ä¸€æ¬¡ SELECT 4T3: äº‹åŠ¡ Bï¼ˆTRX_ID=101ï¼‰ä¿®æ”¹æ•°æ®å¹¶æäº¤ 5T4: äº‹åŠ¡ A ç¬¬äºŒæ¬¡ SELECTï¼Œå¤ç”¨ ReadViewï¼ˆm_ids=[100]ï¼‰ 6 äº‹åŠ¡ 101 åœ¨ ReadView åˆ›å»ºåæ‰æäº¤ï¼Œä¸å¯è§ ç»“æœï¼šä¸¤æ¬¡ SELECT ç»“æœç›¸åŒï¼ˆå¯é‡å¤è¯»ï¼‰ã€‚\næ¶æ„æ€è€ƒï¼š MVCC çš„è®¾è®¡ä½“ç°äº†\u0026quot;ç©ºé—´æ¢æ—¶é—´\u0026quot;çš„æ€æƒ³ã€‚é€šè¿‡ Undo Log ä¿å­˜å†å²ç‰ˆæœ¬ï¼Œç‰ºç‰²äº†å­˜å‚¨ç©ºé—´ï¼Œæ¢å–äº†è¯»å†™å¹¶å‘çš„æ€§èƒ½æå‡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ Git çš„ç‰ˆæœ¬æ§åˆ¶ã€Redis çš„ RDB å¿«ç…§ã€‚\nå¹»è¯»é—®é¢˜ ä»€ä¹ˆæ˜¯å¹»è¯»ï¼Ÿ\näº‹åŠ¡ A ä¸¤æ¬¡æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢å¤šå‡ºäº†æ–°çš„è¡Œã€‚\nMVCC èƒ½è§£å†³å¹»è¯»å—ï¼Ÿ\néƒ¨åˆ†è§£å†³ã€‚å¯¹äºå¿«ç…§è¯»ï¼ˆæ™®é€š SELECTï¼‰ï¼ŒMVCC å¯ä»¥è§£å†³å¹»è¯»ã€‚ä½†å¯¹äºå½“å‰è¯»ï¼ˆSELECT FOR UPDATEã€UPDATEã€DELETEï¼‰ï¼ŒMVCC æ— æ³•è§£å†³å¹»è¯»ã€‚\næ¼”ç¤ºå¹»è¯»\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3SELECT * FROM user WHERE age \u0026gt; 20; -- 2 æ¡è®°å½• 4 5-- äº‹åŠ¡ B 6START TRANSACTION; 7INSERT INTO user (name, age) VALUES (\u0026#39;Charlie\u0026#39;, 25); 8COMMIT; 9 10-- äº‹åŠ¡ A 11SELECT * FROM user WHERE age \u0026gt; 20; -- ä»ç„¶ 2 æ¡ï¼ˆMVCC è§£å†³äº†å¿«ç…§è¯»çš„å¹»è¯»ï¼‰ 12 13-- ä½†æ˜¯ 14SELECT * FROM user WHERE age \u0026gt; 20 FOR UPDATE; -- 3 æ¡ï¼ˆå½“å‰è¯»å‡ºç°å¹»è¯»ï¼‰ è§£å†³æ–¹æ¡ˆï¼šNext-Key Lock\nNext-Key Lock = Record Lockï¼ˆè¡Œé”ï¼‰ + Gap Lockï¼ˆé—´éš™é”ï¼‰\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3SELECT * FROM user WHERE age \u0026gt; 20 FOR UPDATE; -- é”å®š age \u0026gt; 20 çš„æ‰€æœ‰è¡Œå’Œé—´éš™ 4 5-- äº‹åŠ¡ B 6INSERT INTO user (name, age) VALUES (\u0026#39;Charlie\u0026#39;, 25); -- ç­‰å¾…ï¼ˆè¢«é—´éš™é”é˜»å¡ï¼‰ é—´éš™é”é”å®šçš„æ˜¯ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥æ•°æ®ã€‚\né”æœºåˆ¶ å…±äº«é”ï¼ˆS Lockï¼‰\nè¯»é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ã€‚\n1SELECT * FROM user WHERE id = 1 LOCK IN SHARE MODE; æ’ä»–é”ï¼ˆX Lockï¼‰\nå†™é”ï¼Œåªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥æŒæœ‰ã€‚\n1SELECT * FROM user WHERE id = 1 FOR UPDATE; 2UPDATE user SET age = 25 WHERE id = 1; 3DELETE FROM user WHERE id = 1; è¡Œé”ï¼ˆRecord Lockï¼‰\né”å®šå•ä¸ªç´¢å¼•è®°å½•ã€‚\né—´éš™é”ï¼ˆGap Lockï¼‰\né”å®šç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ï¼Œé˜²æ­¢æ’å…¥ã€‚\nNext-Key Lock\nè¡Œé” + é—´éš™é”ï¼Œé”å®šç´¢å¼•è®°å½•åŠå…¶å‰é¢çš„é—´éš™ã€‚\né”çš„å…¼å®¹æ€§\nS Lock X Lock S Lock å…¼å®¹ å†²çª X Lock å†²çª å†²çª æ­»é” åœºæ™¯\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3UPDATE user SET age = 25 WHERE id = 1; -- é”å®š id=1 4 5-- äº‹åŠ¡ B 6START TRANSACTION; 7UPDATE user SET age = 30 WHERE id = 2; -- é”å®š id=2 8 9-- äº‹åŠ¡ A 10UPDATE user SET age = 26 WHERE id = 2; -- ç­‰å¾…äº‹åŠ¡ B é‡Šæ”¾é” 11 12-- äº‹åŠ¡ B 13UPDATE user SET age = 31 WHERE id = 1; -- ç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é”ï¼ˆæ­»é”ï¼‰ æ£€æµ‹ä¸è§£å†³\nMySQL ä¼šè‡ªåŠ¨æ£€æµ‹æ­»é”ï¼Œå¹¶å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡ã€‚\né¿å…æ­»é”\næŒ‰ç›¸åŒé¡ºåºè®¿é—®èµ„æº ç¼©çŸ­äº‹åŠ¡æ—¶é—´ é™ä½éš”ç¦»çº§åˆ« ä½¿ç”¨ä¹è§‚é” å®æˆ˜æ¡ˆä¾‹ï¼šç§’æ€ç³»ç»Ÿçš„åº“å­˜æ‰£å‡ æ–¹æ¡ˆä¸€ï¼šæ‚²è§‚é”\n1START TRANSACTION; 2SELECT stock FROM product WHERE id = 1 FOR UPDATE; -- åŠ æ’ä»–é” 3UPDATE product SET stock = stock - 1 WHERE id = 1; 4COMMIT; ä¼˜ç‚¹ï¼šæ•°æ®ä¸€è‡´æ€§å¼º ç¼ºç‚¹ï¼šå¹¶å‘æ€§èƒ½å·®\næ–¹æ¡ˆäºŒï¼šä¹è§‚é”\n1-- æŸ¥è¯¢åº“å­˜å’Œç‰ˆæœ¬å· 2SELECT stock, version FROM product WHERE id = 1; 3 4-- æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å· 5UPDATE product SET stock = stock - 1, version = version + 1 6WHERE id = 1 AND version = #{oldVersion}; ä¼˜ç‚¹ï¼šå¹¶å‘æ€§èƒ½å¥½ ç¼ºç‚¹ï¼šé«˜å¹¶å‘ä¸‹æ›´æ–°å¤±è´¥ç‡é«˜\næ–¹æ¡ˆä¸‰ï¼šRedis + æ•°æ®åº“\n1// 1. Redis é¢„æ‰£å‡ 2Long stock = redisTemplate.opsForValue().decrement(\u0026#34;stock:1\u0026#34;); 3if (stock \u0026lt; 0) { 4 redisTemplate.opsForValue().increment(\u0026#34;stock:1\u0026#34;); 5 return \u0026#34;åº“å­˜ä¸è¶³\u0026#34;; 6} 7 8// 2. å¼‚æ­¥æ›´æ–°æ•°æ®åº“ 9rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, orderId); ä¼˜ç‚¹ï¼šæ€§èƒ½æœ€å¥½ ç¼ºç‚¹ï¼šå®ç°å¤æ‚ï¼Œéœ€è¦ä¿è¯æœ€ç»ˆä¸€è‡´æ€§\næ€»ç»“ä¸æ€è€ƒ MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ MVCC çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nå››ç§éš”ç¦»çº§åˆ«è§£å†³ä¸åŒçš„å¹¶å‘é—®é¢˜ MVCC é€šè¿‡ ReadView å’Œ Undo Log å®ç°å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ READ COMMITTED æ¯æ¬¡ SELECT åˆ›å»ºæ–° ReadView REPEATABLE READ äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»º ReadView å¹¶å¤ç”¨ Next-Key Lock è§£å†³å½“å‰è¯»çš„å¹»è¯»é—®é¢˜ ç†è§£è¿™äº›æœºåˆ¶ï¼Œæ‰èƒ½åœ¨å®é™…å¼€å‘ä¸­é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«å’Œé”ç­–ç•¥ã€‚\nä¸‹æ¬¡å½“ä½ é‡åˆ°å¹¶å‘é—®é¢˜æ—¶ï¼Œä¸å¦¨æƒ³æƒ³ï¼šè¿™æ˜¯è„è¯»ã€ä¸å¯é‡å¤è¯»è¿˜æ˜¯å¹»è¯»ï¼Ÿåº”è¯¥ç”¨ä»€ä¹ˆéš”ç¦»çº§åˆ«å’Œé”æœºåˆ¶ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/11/mysql-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8E-mvcc-%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŸMySQL é€šè¿‡äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œ MVCC æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡æ·±å…¥å‰–æ MySQL çš„å¹¶å‘æ§åˆ¶åŸç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ MVCC çš„ ReadView æœºåˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§£å†³å¹»è¯»é—®é¢˜çš„æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£é”æœºåˆ¶ä¸ MVCC çš„é…åˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"äº‹åŠ¡çš„å¹¶å‘é—®é¢˜\"\u003eäº‹åŠ¡çš„å¹¶å‘é—®é¢˜\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eè„è¯»ï¼ˆDirty Readï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eäº‹åŠ¡ A è¯»å–äº†äº‹åŠ¡ B æœªæäº¤çš„æ•°æ®ï¼Œäº‹åŠ¡ B å›æ»šåï¼Œäº‹åŠ¡ A è¯»åˆ°çš„æ•°æ®æ˜¯æ— æ•ˆçš„ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eæ—¶é—´çº¿ï¼š\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eT1: äº‹åŠ¡ A å¼€å§‹\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003eT2: äº‹åŠ¡ B å¼€å§‹ï¼Œå°† balance ä» 100 æ”¹ä¸º 200\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003eT3: äº‹åŠ¡ A è¯»å– balance = 200ï¼ˆè„è¯»ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003eT4: äº‹åŠ¡ B å›æ»šï¼Œbalance æ¢å¤ä¸º 100\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003eT5: äº‹åŠ¡ A æäº¤\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eäº‹åŠ¡ A ä¸¤æ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸ä¸€è‡´ï¼ˆå› ä¸ºäº‹åŠ¡ B ä¿®æ”¹å¹¶æäº¤äº†æ•°æ®ï¼‰ã€‚\u003c/p\u003e","title":"MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ MVCC æœºåˆ¶æ·±åº¦è§£æ"},{"content":"SQL æ€§èƒ½ä¼˜åŒ–æ˜¯åç«¯å¼€å‘çš„å¿…å¤‡æŠ€èƒ½ã€‚ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿï¼Œè€Œåˆç†çš„ç´¢å¼•è®¾è®¡èƒ½è®©æŸ¥è¯¢é€Ÿåº¦æå‡ç™¾å€ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ–¹æ³•è®ºã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ B+ æ ‘ç´¢å¼•çš„åº•å±‚åŸç† æŒæ¡ Explain æ‰§è¡Œè®¡åˆ’çš„åˆ†ææ–¹æ³• å­¦ä¼šè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é…è§„åˆ™ äº†è§£è¦†ç›–ç´¢å¼•ä¸ç´¢å¼•ä¸‹æ¨ä¼˜åŒ– B+ æ ‘ç´¢å¼•åŸç† ä¸ºä»€ä¹ˆé€‰æ‹© B+ æ ‘ï¼Ÿ\nå¸¸è§çš„æ•°æ®ç»“æ„å¯¹æ¯”ï¼š\næ•°æ®ç»“æ„ æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ é—®é¢˜ æ•°ç»„ O(n) æŸ¥è¯¢æ…¢ äºŒå‰æœç´¢æ ‘ O(log n) å¯èƒ½é€€åŒ–ä¸ºé“¾è¡¨ å¹³è¡¡äºŒå‰æ ‘ O(log n) æ ‘é«˜å¤ªé«˜ï¼ŒIO æ¬¡æ•°å¤š B æ ‘ O(log n) éå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œæµªè´¹ç©ºé—´ B+ æ ‘ O(log n) å¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜ç´¢å¼• B+ æ ‘çš„ç‰¹ç‚¹\næ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ å¶å­èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢ éå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šçš„é”®å€¼ æ ‘çš„é«˜åº¦ä½ï¼ŒIO æ¬¡æ•°å°‘ InnoDB çš„èšç°‡ç´¢å¼•\nInnoDB çš„ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨å®Œæ•´çš„è¡Œæ•°æ®ã€‚\n1ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰ 2 10 3 / \\ 4 5 15 5 / \\ / \\ 6 1 7 12 18 7 | | | | 8 [å®Œæ•´è¡Œæ•°æ®] äºŒçº§ç´¢å¼•ï¼ˆéä¸»é”®ç´¢å¼•ï¼‰çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼Œéœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\n1äºŒçº§ç´¢å¼•ï¼ˆname ç´¢å¼•ï¼‰ 2 \u0026#34;Bob\u0026#34; 3 / \\ 4 \u0026#34;Alice\u0026#34; \u0026#34;Charlie\u0026#34; 5 | | 6 [ä¸»é”®1] [ä¸»é”®3] 7 â†“ â†“ 8 å›è¡¨æŸ¥è¯¢å®Œæ•´æ•°æ® æ¶æ„æ€è€ƒï¼š èšç°‡ç´¢å¼•çš„è®¾è®¡ä½“ç°äº†\u0026quot;å±€éƒ¨æ€§åŸç†\u0026quot;ã€‚ç›¸é‚»çš„ä¸»é”®å€¼å­˜å‚¨åœ¨ç›¸é‚»çš„ç£ç›˜ä½ç½®ï¼ŒèŒƒå›´æŸ¥è¯¢æ—¶å¯ä»¥é¡ºåºè¯»å–ï¼Œå‡å°‘éšæœº IOã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨è‡ªå¢ä¸»é”®çš„åŸå› ã€‚\nExplain æ‰§è¡Œè®¡åˆ’åˆ†æ åŸºæœ¬ç”¨æ³•\n1EXPLAIN SELECT * FROM user WHERE age = 25; å…³é”®å­—æ®µè§£æ\n1. typeï¼ˆè®¿é—®ç±»å‹ï¼‰\næ€§èƒ½ä»å¥½åˆ°åï¼š\nsystemï¼šè¡¨åªæœ‰ä¸€è¡Œæ•°æ®ï¼ˆç³»ç»Ÿè¡¨ï¼‰ constï¼šé€šè¿‡ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æŸ¥è¯¢ï¼Œæœ€å¤šè¿”å›ä¸€è¡Œ eq_refï¼šå”¯ä¸€ç´¢å¼•æ‰«æï¼Œå¯¹äºæ¯ä¸ªç´¢å¼•é”®ï¼Œè¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•åŒ¹é… refï¼šéå”¯ä¸€ç´¢å¼•æ‰«æï¼Œè¿”å›åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„æ‰€æœ‰è¡Œ rangeï¼šç´¢å¼•èŒƒå›´æ‰«æï¼ˆBETWEENã€\u0026gt;ã€\u0026lt;ï¼‰ indexï¼šå…¨ç´¢å¼•æ‰«æ ALLï¼šå…¨è¡¨æ‰«æï¼ˆæœ€å·®ï¼‰ 1-- const 2EXPLAIN SELECT * FROM user WHERE id = 1; 3 4-- ref 5EXPLAIN SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6 7-- range 8EXPLAIN SELECT * FROM user WHERE age BETWEEN 20 AND 30; 9 10-- ALL 11EXPLAIN SELECT * FROM user WHERE email LIKE \u0026#39;%@gmail.com\u0026#39;; 2. keyï¼ˆå®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼‰\nå¦‚æœä¸º NULLï¼Œè¯´æ˜æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚\n3. rowsï¼ˆæ‰«æçš„è¡Œæ•°ï¼‰\né¢„ä¼°éœ€è¦æ‰«æçš„è¡Œæ•°ï¼Œè¶Šå°‘è¶Šå¥½ã€‚\n4. Extraï¼ˆé¢å¤–ä¿¡æ¯ï¼‰\nUsing indexï¼šä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ Using whereï¼šä½¿ç”¨äº† WHERE è¿‡æ»¤ Using filesortï¼šéœ€è¦é¢å¤–çš„æ’åºæ“ä½œï¼ˆæ€§èƒ½å·®ï¼‰ Using temporaryï¼šéœ€è¦åˆ›å»ºä¸´æ—¶è¡¨ï¼ˆæ€§èƒ½å·®ï¼‰ ç´¢å¼•å¤±æ•ˆçš„ 10 ç§åœºæ™¯ 1. ä½¿ç”¨å‡½æ•°æˆ–è¡¨è¾¾å¼\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE YEAR(create_time) = 2024; 3 4-- ä¼˜åŒ– 5SELECT * FROM user WHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2025-01-01\u0026#39;; 2. éšå¼ç±»å‹è½¬æ¢\n1-- phone æ˜¯ VARCHAR ç±»å‹ï¼Œç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE phone = 13800138000; 3 4-- ä¼˜åŒ– 5SELECT * FROM user WHERE phone = \u0026#39;13800138000\u0026#39;; 3. ä½¿ç”¨ OR è¿æ¥\n1-- å¦‚æœ age æ²¡æœ‰ç´¢å¼•ï¼Œæ•´ä¸ªæŸ¥è¯¢ä¸èµ°ç´¢å¼• 2SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; OR age = 25; 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨ UNION 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; 6UNION 7SELECT * FROM user WHERE age = 25; 4. LIKE ä»¥ % å¼€å¤´\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE name LIKE \u0026#39;%Alice\u0026#39;; 3 4-- ä¼˜åŒ–ï¼š% æ”¾åœ¨åé¢ 5SELECT * FROM user WHERE name LIKE \u0026#39;Alice%\u0026#39;; 5. ä¸ç­‰äºï¼ˆ!= æˆ– \u0026lt;\u0026gt;ï¼‰\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE age != 25; 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨èŒƒå›´æŸ¥è¯¢ 5SELECT * FROM user WHERE age \u0026lt; 25 OR age \u0026gt; 25; 6. IS NULL æˆ– IS NOT NULL\n1-- å¯èƒ½ç´¢å¼•å¤±æ•ˆï¼ˆå–å†³äº NULL å€¼çš„æ¯”ä¾‹ï¼‰ 2SELECT * FROM user WHERE age IS NULL; 3 4-- ä¼˜åŒ–ï¼šé¿å…å­—æ®µä¸º NULLï¼Œä½¿ç”¨é»˜è®¤å€¼ 7. NOT IN å’Œ NOT EXISTS\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE id NOT IN (1, 2, 3); 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨ LEFT JOIN 5SELECT u.* FROM user u 6LEFT JOIN (SELECT 1 AS id UNION SELECT 2 UNION SELECT 3) t ON u.id = t.id 7WHERE t.id IS NULL; 8. è”åˆç´¢å¼•ä¸æ»¡è¶³æœ€å·¦å‰ç¼€\n1-- è”åˆç´¢å¼• (name, age, city) 2 3-- èµ°ç´¢å¼• 4SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25; 6 7-- ä¸èµ°ç´¢å¼• 8SELECT * FROM user WHERE age = 25; 9SELECT * FROM user WHERE city = \u0026#39;Beijing\u0026#39;; 9. èŒƒå›´æŸ¥è¯¢åçš„å­—æ®µä¸èµ°ç´¢å¼•\n1-- è”åˆç´¢å¼• (name, age, city) 2 3-- age èµ°ç´¢å¼•ï¼Œcity ä¸èµ°ç´¢å¼• 4SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age \u0026gt; 20 AND city = \u0026#39;Beijing\u0026#39;; 10. æ•°æ®é‡å¤ªå°\nå¦‚æœè¡¨çš„æ•°æ®é‡å¾ˆå°ï¼ˆå‡ ç™¾è¡Œï¼‰ï¼ŒMySQL å¯èƒ½é€‰æ‹©å…¨è¡¨æ‰«æè€Œä¸æ˜¯ç´¢å¼•ã€‚\nè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é… è§„åˆ™\nè”åˆç´¢å¼• (a, b, c) ç›¸å½“äºåˆ›å»ºäº†ä¸‰ä¸ªç´¢å¼•ï¼š\n(a) (a, b) (a, b, c) æ¡ˆä¾‹åˆ†æ\n1-- åˆ›å»ºè”åˆç´¢å¼• 2CREATE INDEX idx_name_age_city ON user(name, age, city); 3 4-- èµ°ç´¢å¼• 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25; 7SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25 AND city = \u0026#39;Beijing\u0026#39;; 8SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND city = \u0026#39;Beijing\u0026#39;; -- name èµ°ç´¢å¼•ï¼Œcity ä¸èµ° 9 10-- ä¸èµ°ç´¢å¼• 11SELECT * FROM user WHERE age = 25; 12SELECT * FROM user WHERE city = \u0026#39;Beijing\u0026#39;; 13SELECT * FROM user WHERE age = 25 AND city = \u0026#39;Beijing\u0026#39;; ç´¢å¼•é¡ºåºçš„é€‰æ‹©\nåŒºåˆ†åº¦é«˜çš„å­—æ®µæ”¾åœ¨å‰é¢ã€‚\n1-- å‡è®¾ name æœ‰ 1000 ä¸ªä¸åŒå€¼ï¼Œage æœ‰ 50 ä¸ªä¸åŒå€¼ï¼Œcity æœ‰ 10 ä¸ªä¸åŒå€¼ 2-- åº”è¯¥åˆ›å»º (name, age, city)ï¼Œè€Œä¸æ˜¯ (city, age, name) è¦†ç›–ç´¢å¼• è¦†ç›–ç´¢å¼•æ˜¯æŒ‡æŸ¥è¯¢çš„å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­ï¼Œä¸éœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\næ¡ˆä¾‹\n1-- åˆ›å»ºç´¢å¼• 2CREATE INDEX idx_name_age ON user(name, age); 3 4-- è¦†ç›–ç´¢å¼•ï¼ˆä¸éœ€è¦å›è¡¨ï¼‰ 5SELECT name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6 7-- éœ€è¦å›è¡¨ 8SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; ä¼˜åŒ–å»ºè®®\nå¦‚æœæŸ¥è¯¢åªéœ€è¦å°‘æ•°å‡ ä¸ªå­—æ®µï¼Œå¯ä»¥åˆ›å»ºè”åˆç´¢å¼•è¦†ç›–è¿™äº›å­—æ®µã€‚\n1-- ä¼˜åŒ–å‰ 2SELECT id, name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; 3 4-- åˆ›å»ºè¦†ç›–ç´¢å¼• 5CREATE INDEX idx_name_age ON user(name, age); 6 7-- ä¼˜åŒ–åï¼ˆä¸éœ€è¦å›è¡¨ï¼‰ 8SELECT id, name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; ç´¢å¼•ä¸‹æ¨ï¼ˆICPï¼‰ MySQL 5.6 å¼•å…¥çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œå°†éƒ¨åˆ† WHERE æ¡ä»¶ä¸‹æ¨åˆ°å­˜å‚¨å¼•æ“å±‚è¿‡æ»¤ã€‚\næ¡ˆä¾‹\n1-- è”åˆç´¢å¼• (name, age) 2SELECT * FROM user WHERE name LIKE \u0026#39;A%\u0026#39; AND age = 25; æ²¡æœ‰ç´¢å¼•ä¸‹æ¨\nå­˜å‚¨å¼•æ“æ ¹æ® name LIKE \u0026lsquo;A%\u0026rsquo; æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„è®°å½• è¿”å›ç»™ Server å±‚ Server å±‚è¿‡æ»¤ age = 25 æœ‰ç´¢å¼•ä¸‹æ¨\nå­˜å‚¨å¼•æ“æ ¹æ® name LIKE \u0026lsquo;A%\u0026rsquo; æ‰¾åˆ°åŒ¹é…çš„è®°å½• åœ¨å­˜å‚¨å¼•æ“å±‚ç›´æ¥è¿‡æ»¤ age = 25 åªè¿”å›ç¬¦åˆæ¡ä»¶çš„è®°å½•ç»™ Server å±‚ å‡å°‘äº†å›è¡¨æ¬¡æ•°ï¼Œæå‡äº†æ€§èƒ½ã€‚\nåˆ†é¡µæŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ï¼šæ·±åº¦åˆ†é¡µ\n1-- æŸ¥è¯¢ç¬¬ 100 ä¸‡æ¡æ•°æ® 2SELECT * FROM user ORDER BY id LIMIT 1000000, 10; MySQL éœ€è¦æ‰«æ 100 ä¸‡ + 10 æ¡æ•°æ®ï¼Œç„¶åä¸¢å¼ƒå‰ 100 ä¸‡æ¡ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\nä¼˜åŒ–æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨å­æŸ¥è¯¢\n1SELECT * FROM user 2WHERE id \u0026gt;= (SELECT id FROM user ORDER BY id LIMIT 1000000, 1) 3LIMIT 10; å­æŸ¥è¯¢ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œåªè¿”å› idï¼Œç„¶åé€šè¿‡ id æŸ¥è¯¢å®Œæ•´æ•°æ®ã€‚\nä¼˜åŒ–æ–¹æ¡ˆäºŒï¼šè®°å½•ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§ ID\n1-- ç¬¬ä¸€æ¬¡æŸ¥è¯¢ 2SELECT * FROM user ORDER BY id LIMIT 10; 3 4-- ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ˆå‡è®¾ä¸Šæ¬¡æœ€å¤§ ID æ˜¯ 10ï¼‰ 5SELECT * FROM user WHERE id \u0026gt; 10 ORDER BY id LIMIT 10; è¿™ç§æ–¹å¼åªé€‚ç”¨äº ID è¿ç»­çš„åœºæ™¯ã€‚\nç´¢å¼•è®¾è®¡çš„æœ€ä½³å®è·µ 1. é€‰æ‹©åˆé€‚çš„å­—æ®µåˆ›å»ºç´¢å¼•\nWHEREã€ORDER BYã€GROUP BYã€JOIN çš„å­—æ®µ åŒºåˆ†åº¦é«˜çš„å­—æ®µï¼ˆä¸è¦ç»™æ€§åˆ«åˆ›å»ºç´¢å¼•ï¼‰ å­—æ®µé•¿åº¦å°çš„å­—æ®µ 2. ä½¿ç”¨å‰ç¼€ç´¢å¼•\nå¯¹äºé•¿å­—ç¬¦ä¸²å­—æ®µï¼Œå¯ä»¥åªç´¢å¼•å‰å‡ ä¸ªå­—ç¬¦ã€‚\n1CREATE INDEX idx_email ON user(email(10)); 3. é¿å…å†—ä½™ç´¢å¼•\nå¦‚æœå·²ç»æœ‰è”åˆç´¢å¼• (name, age)ï¼Œå°±ä¸éœ€è¦å•ç‹¬åˆ›å»º (name) ç´¢å¼•ã€‚\n4. å®šæœŸåˆ†æå’Œä¼˜åŒ–ç´¢å¼•\n1-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ 2SHOW INDEX FROM user; 3 4-- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼• 5DROP INDEX idx_unused ON user; 5. ä½¿ç”¨è‡ªå¢ä¸»é”®\né¿å…é¡µåˆ†è£‚ï¼Œæå‡æ’å…¥æ€§èƒ½ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šæ…¢æŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ SQL\n1SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; æ‰§è¡Œæ—¶é—´ï¼š3 ç§’\nåˆ†æ\n1EXPLAIN SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; ç»“æœï¼štype = ALLï¼Œrows = 1000000ï¼ŒExtra = Using filesort\nä¼˜åŒ–æ­¥éª¤\nåˆ›å»ºè”åˆç´¢å¼• 1CREATE INDEX idx_user_status_time ON order(user_id, status, create_time); å†æ¬¡åˆ†æ 1EXPLAIN SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; ç»“æœï¼štype = rangeï¼Œrows = 100ï¼ŒExtra = Using index condition\næ‰§è¡Œæ—¶é—´ï¼š50ms\næ€§èƒ½æå‡ï¼š60 å€\næ€»ç»“ä¸æ€è€ƒ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nç†è§£ B+ æ ‘çš„åŸç†ï¼ŒçŸ¥é“ä¸ºä»€ä¹ˆç´¢å¼•èƒ½æå‡æ€§èƒ½ æŒæ¡ Explain çš„ä½¿ç”¨ï¼Œèƒ½å¤Ÿåˆ†ææ‰§è¡Œè®¡åˆ’ é¿å…ç´¢å¼•å¤±æ•ˆçš„ 10 ç§åœºæ™¯ åˆç†è®¾è®¡è”åˆç´¢å¼•ï¼Œåˆ©ç”¨æœ€å·¦å‰ç¼€åŒ¹é… ä½¿ç”¨è¦†ç›–ç´¢å¼•å’Œç´¢å¼•ä¸‹æ¨ä¼˜åŒ–æŸ¥è¯¢ ç´¢å¼•ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œæ¯ä¸ªç´¢å¼•éƒ½ä¼šå ç”¨å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”å½±å“å†™å…¥æ€§èƒ½ã€‚è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯åˆç†è®¾è®¡ç´¢å¼•ã€‚\nä¸‹æ¬¡å½“ä½ çš„ SQL æŸ¥è¯¢å¾ˆæ…¢æ—¶ï¼Œä¸å¦¨ç”¨ Explain åˆ†æä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦èµ°äº†ç´¢å¼•ã€‚\n","permalink":"http://localhost:1313/posts/2024/11/mysql-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E4%BB%8E-explain-%E5%88%B0%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/","summary":"\u003cp\u003eSQL æ€§èƒ½ä¼˜åŒ–æ˜¯åç«¯å¼€å‘çš„å¿…å¤‡æŠ€èƒ½ã€‚ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿï¼Œè€Œåˆç†çš„ç´¢å¼•è®¾è®¡èƒ½è®©æŸ¥è¯¢é€Ÿåº¦æå‡ç™¾å€ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ–¹æ³•è®ºã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ B+ æ ‘ç´¢å¼•çš„åº•å±‚åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Explain æ‰§è¡Œè®¡åˆ’çš„åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é…è§„åˆ™\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£è¦†ç›–ç´¢å¼•ä¸ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"b-æ ‘ç´¢å¼•åŸç†\"\u003eB+ æ ‘ç´¢å¼•åŸç†\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eä¸ºä»€ä¹ˆé€‰æ‹© B+ æ ‘ï¼Ÿ\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¸¸è§çš„æ•°æ®ç»“æ„å¯¹æ¯”ï¼š\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eæ•°æ®ç»“æ„\u003c/th\u003e\n          \u003cth\u003eæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦\u003c/th\u003e\n          \u003cth\u003eé—®é¢˜\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eæ•°ç»„\u003c/td\u003e\n          \u003ctd\u003eO(n)\u003c/td\u003e\n          \u003ctd\u003eæŸ¥è¯¢æ…¢\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eäºŒå‰æœç´¢æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eå¯èƒ½é€€åŒ–ä¸ºé“¾è¡¨\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå¹³è¡¡äºŒå‰æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eæ ‘é«˜å¤ªé«˜ï¼ŒIO æ¬¡æ•°å¤š\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eB æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eéå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œæµªè´¹ç©ºé—´\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eB+ æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜ç´¢å¼•\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003eB+ æ ‘çš„ç‰¹ç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹\u003c/li\u003e\n\u003cli\u003eå¶å­èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢\u003c/li\u003e\n\u003cli\u003eéå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šçš„é”®å€¼\u003c/li\u003e\n\u003cli\u003eæ ‘çš„é«˜åº¦ä½ï¼ŒIO æ¬¡æ•°å°‘\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eInnoDB çš„èšç°‡ç´¢å¼•\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eInnoDB çš„ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨å®Œæ•´çš„è¡Œæ•°æ®ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e       10\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e      /  \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e     5    15\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    / \\   / \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e   1  7  12 18\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e   |  |  |  |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  [å®Œæ•´è¡Œæ•°æ®]\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eäºŒçº§ç´¢å¼•ï¼ˆéä¸»é”®ç´¢å¼•ï¼‰çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼Œéœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\u003c/p\u003e","title":"MySQL ç´¢å¼•ä¼˜åŒ–ï¼šä» Explain åˆ°æ‰§è¡Œè®¡åˆ’"},{"content":"ç”Ÿäº§ç¯å¢ƒçš„ OOMï¼ˆOut Of Memoryï¼‰æ˜¯åç«¯å¼€å‘æœ€å¤´ç–¼çš„é—®é¢˜ä¹‹ä¸€ã€‚æœ¬æ–‡é€šè¿‡çœŸå®æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œè§£å†³ JVM å†…å­˜é—®é¢˜ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ JVM å†…å­˜æ¨¡å‹ä¸ GC æœºåˆ¶ æŒæ¡ Heap Dump çš„ç”Ÿæˆä¸åˆ†ææ–¹æ³• å­¦ä¼šä½¿ç”¨ MAT å·¥å…·å®šä½å†…å­˜æ³„æ¼ äº†è§£å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ JVM å†…å­˜æ¨¡å‹ å †å†…å­˜ï¼ˆHeapï¼‰\nå¹´è½»ä»£ï¼ˆYoung Generationï¼‰ Eden åŒºï¼šæ–°å¯¹è±¡åˆ†é…çš„åŒºåŸŸ Survivor åŒºï¼šS0 å’Œ S1ï¼Œå­˜æ”¾ç»è¿‡ä¸€æ¬¡ GC åå­˜æ´»çš„å¯¹è±¡ è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡ éå †å†…å­˜\næ–¹æ³•åŒºï¼ˆMetaspaceï¼‰ï¼šå­˜æ”¾ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ æ ˆï¼ˆStackï¼‰ï¼šå­˜æ”¾å±€éƒ¨å˜é‡ã€æ–¹æ³•è°ƒç”¨ ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ï¼šNIO ä½¿ç”¨çš„å †å¤–å†…å­˜ GC æœºåˆ¶\nMinor GCï¼šæ¸…ç†å¹´è½»ä»£ Major GCï¼šæ¸…ç†è€å¹´ä»£ Full GCï¼šæ¸…ç†æ•´ä¸ªå †å†…å­˜ å¯¹è±¡æ™‹å‡\næ–°å¯¹è±¡åœ¨ Eden åŒºåˆ†é… Eden åŒºæ»¡äº†ï¼Œè§¦å‘ Minor GC å­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ° Survivor åŒº ç»è¿‡å¤šæ¬¡ GC åï¼Œå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ æ¶æ„æ€è€ƒï¼š JVM çš„åˆ†ä»£æ”¶é›†ä½“ç°äº†\u0026quot;å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•æ­»\u0026quot;çš„ç‰¹ç‚¹ã€‚å¹´è½»ä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¿«é€Ÿå›æ”¶çŸ­å‘½å¯¹è±¡ï¼›è€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå¤„ç†é•¿æœŸå­˜æ´»çš„å¯¹è±¡ã€‚è¿™ç§è®¾è®¡åœ¨æ€§èƒ½å’Œå†…å­˜åˆ©ç”¨ç‡ä¹‹é—´æ‰¾åˆ°äº†å¹³è¡¡ã€‚\nOOM çš„å¸¸è§ç±»å‹ 1. java.lang.OutOfMemoryError: Java heap space\nå †å†…å­˜ä¸è¶³ï¼Œæœ€å¸¸è§çš„ OOMã€‚\nåŸå› ï¼š\nå†…å­˜æ³„æ¼ï¼šå¯¹è±¡æ— æ³•è¢« GC å›æ”¶ å†…å­˜æº¢å‡ºï¼šå¯¹è±¡å¤ªå¤šï¼Œè¶…è¿‡å †å†…å­˜å¤§å° 2. java.lang.OutOfMemoryError: GC overhead limit exceeded\nGC å ç”¨äº† 98% çš„æ—¶é—´ï¼Œä½†åªå›æ”¶äº†ä¸åˆ° 2% çš„å†…å­˜ã€‚\n3. java.lang.OutOfMemoryError: Metaspace\næ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰å†…å­˜ä¸è¶³ã€‚\nåŸå› ï¼š\nåŠ è½½äº†å¤ªå¤šçš„ç±» åŠ¨æ€ç”Ÿæˆç±»ï¼ˆå¦‚ CGLIB ä»£ç†ï¼‰ 4. java.lang.OutOfMemoryError: Direct buffer memory\nç›´æ¥å†…å­˜ä¸è¶³ï¼Œé€šå¸¸æ˜¯ NIO ä½¿ç”¨ä¸å½“ã€‚\næ¡ˆä¾‹ä¸€ï¼šThreadLocal å¯¼è‡´çš„å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOMã€‚\næ’æŸ¥æ­¥éª¤\n1. ç”Ÿæˆ Heap Dump\n1# æ–¹å¼ä¸€ï¼šOOM æ—¶è‡ªåŠ¨ç”Ÿæˆ 2java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/heapdump.hprof -jar app.jar 3 4# æ–¹å¼äºŒï¼šæ‰‹åŠ¨ç”Ÿæˆ 5jmap -dump:format=b,file=/tmp/heapdump.hprof \u0026lt;pid\u0026gt; 2. ä½¿ç”¨ MAT åˆ†æ\nä¸‹è½½ Eclipse Memory Analyzerï¼ˆMATï¼‰å·¥å…·ï¼Œæ‰“å¼€ Heap Dump æ–‡ä»¶ã€‚\n3. æŸ¥çœ‹ Dominator Tree\nDominator Tree æ˜¾ç¤ºå ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡ã€‚\nå‘ç°ï¼šThread å¯¹è±¡å ç”¨äº† 2GB å†…å­˜ã€‚\n4. æŸ¥çœ‹ Thread å¯¹è±¡çš„å¼•ç”¨é“¾\nå±•å¼€ Thread å¯¹è±¡ï¼Œå‘ç° threadLocals å­—æ®µä¸­æœ‰å¤§é‡ Entry å¯¹è±¡ã€‚\n5. æŸ¥çœ‹ Entry çš„ value\nå‘ç° value æ˜¯ä¸šåŠ¡å¯¹è±¡ï¼ˆUser Listï¼‰ï¼ŒåŒ…å« 10 ä¸‡æ¡æ•°æ®ã€‚\næ ¹å› \nä»£ç ä¸­ä½¿ç”¨äº† ThreadLocalï¼Œä½†æ²¡æœ‰è°ƒç”¨ remove()ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 8 cache.set(users); 9 10 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 11 doSomething(users); 12 13 // å¿˜è®°è°ƒç”¨ remove() 14 } 15} è§£å†³æ–¹æ¡ˆ\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 try { 8 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 9 cache.set(users); 10 doSomething(users); 11 } finally { 12 cache.remove(); // å¿…é¡»åœ¨ finally ä¸­æ¸…ç† 13 } 14 } 15} æ¡ˆä¾‹äºŒï¼šå¤§å¯¹è±¡å¯¼è‡´çš„ OOM é—®é¢˜ç°è±¡\nå¯¼å‡º Excel æ—¶ï¼Œåº”ç”¨ OOMã€‚\næ’æŸ¥æ­¥éª¤\n1. æŸ¥çœ‹ GC æ—¥å¿—\n1java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/tmp/gc.log -jar app.jar GC æ—¥å¿—æ˜¾ç¤ºï¼šFull GC é¢‘ç¹ï¼Œä½†å›æ”¶æ•ˆæœä¸æ˜æ˜¾ã€‚\n2. åˆ†æ Heap Dump\nå‘ç°å¤§é‡çš„ ArrayList å¯¹è±¡ï¼Œæ¯ä¸ªåŒ…å« 10 ä¸‡æ¡æ•°æ®ã€‚\næ ¹å› \nä½¿ç”¨ä¼ ç»Ÿçš„ POI å¯¼å‡º Excelï¼Œä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ã€‚\n1public void exportExcel() { 2 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); // æŸ¥è¯¢ 10 ä¸‡æ¡æ•°æ® 3 4 Workbook workbook = new XSSFWorkbook(); 5 Sheet sheet = workbook.createSheet(); 6 7 for (int i = 0; i \u0026lt; users.size(); i++) { 8 Row row = sheet.createRow(i); 9 // å¡«å……æ•°æ® 10 } 11 12 workbook.write(outputStream); 13} è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ EasyExcel æµå¼å†™å…¥\n1public void exportExcel() { 2 EasyExcel.write(outputStream, User.class) 3 .registerWriteHandler(new LongestMatchColumnWidthStyleStrategy()) 4 .sheet(\u0026#34;ç”¨æˆ·åˆ—è¡¨\u0026#34;) 5 .doWrite(() -\u0026gt; { 6 // åˆ†æ‰¹æŸ¥è¯¢ 7 int pageSize = 1000; 8 int pageNum = 1; 9 List\u0026lt;User\u0026gt; users; 10 List\u0026lt;User\u0026gt; allUsers = new ArrayList\u0026lt;\u0026gt;(); 11 12 do { 13 users = userMapper.selectPage(pageNum, pageSize); 14 allUsers.addAll(users); 15 pageNum++; 16 } while (users.size() == pageSize); 17 18 return allUsers; 19 }); 20} æ›´å¥½çš„æ–¹æ¡ˆï¼šä½¿ç”¨ EasyExcel çš„åˆ†æ‰¹å†™å…¥\n1public void exportExcel() { 2 ExcelWriter excelWriter = EasyExcel.write(outputStream, User.class).build(); 3 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;ç”¨æˆ·åˆ—è¡¨\u0026#34;).build(); 4 5 int pageSize = 1000; 6 int pageNum = 1; 7 List\u0026lt;User\u0026gt; users; 8 9 do { 10 users = userMapper.selectPage(pageNum, pageSize); 11 excelWriter.write(users, writeSheet); 12 pageNum++; 13 } while (users.size() == pageSize); 14 15 excelWriter.finish(); 16} æ¡ˆä¾‹ä¸‰ï¼šé™æ€é›†åˆå¯¼è‡´çš„å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nåº”ç”¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå†…å­˜æŒç»­å¢é•¿ã€‚\næ ¹å› \nä½¿ç”¨é™æ€é›†åˆç¼“å­˜æ•°æ®ï¼Œä½†æ²¡æœ‰æ¸…ç†æœºåˆ¶ã€‚\n1public class CacheManager { 2 3 private static final Map\u0026lt;String, Object\u0026gt; cache = new HashMap\u0026lt;\u0026gt;(); 4 5 public static void put(String key, Object value) { 6 cache.put(key, value); 7 } 8 9 public static Object get(String key) { 10 return cache.get(key); 11 } 12} è§£å†³æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ WeakHashMap\n1private static final Map\u0026lt;String, Object\u0026gt; cache = new WeakHashMap\u0026lt;\u0026gt;(); WeakHashMap çš„ key æ˜¯å¼±å¼•ç”¨ï¼Œå½“ key æ²¡æœ‰å¼ºå¼•ç”¨æ—¶ï¼Œä¼šè¢« GC å›æ”¶ã€‚\nè§£å†³æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Guava Cache\n1private static final Cache\u0026lt;String, Object\u0026gt; cache = CacheBuilder.newBuilder() 2 .maximumSize(10000) // æœ€å¤§ç¼“å­˜æ•°é‡ 3 .expireAfterWrite(10, TimeUnit.MINUTES) // å†™å…¥å 10 åˆ†é’Ÿè¿‡æœŸ 4 .build(); è§£å†³æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨ Redis\nå°†ç¼“å­˜æ”¾åˆ° Redisï¼Œé¿å…å ç”¨ JVM å†…å­˜ã€‚\nå¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ 1. ThreadLocal æœªæ¸…ç†\nåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹ï¼ŒThreadLocal å¿…é¡»è°ƒç”¨ remove()ã€‚\n2. é™æ€é›†åˆ\né™æ€é›†åˆçš„ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç›¸åŒï¼Œå®¹æ˜“å¯¼è‡´å†…å­˜æ³„æ¼ã€‚\n3. ç›‘å¬å™¨æœªæ³¨é”€\n1// æ³¨å†Œç›‘å¬å™¨ 2eventBus.register(listener); 3 4// å¿˜è®°æ³¨é”€ 5// eventBus.unregister(listener); 4. æ•°æ®åº“è¿æ¥æœªå…³é—­\n1Connection conn = DriverManager.getConnection(url); 2// å¿˜è®°å…³é—­ 3// conn.close(); 5. IO æµæœªå…³é—­\n1FileInputStream fis = new FileInputStream(file); 2// å¿˜è®°å…³é—­ 3// fis.close(); ä½¿ç”¨ try-with-resources è‡ªåŠ¨å…³é—­èµ„æºï¼š\n1try (FileInputStream fis = new FileInputStream(file)) { 2 // ä½¿ç”¨æµ 3} JVM å‚æ•°è°ƒä¼˜ å †å†…å­˜è®¾ç½®\n1-Xms4g # åˆå§‹å †å†…å­˜ 2-Xmx4g # æœ€å¤§å †å†…å­˜ï¼ˆå»ºè®®ä¸ Xms ç›¸åŒï¼Œé¿å…åŠ¨æ€æ‰©å®¹ï¼‰ å¹´è½»ä»£è®¾ç½®\n1-Xmn2g # å¹´è½»ä»£å¤§å°ï¼ˆå»ºè®®ä¸ºå †å†…å­˜çš„ 1/3 åˆ° 1/2ï¼‰ å…ƒç©ºé—´è®¾ç½®\n1-XX:MetaspaceSize=256m # åˆå§‹å…ƒç©ºé—´å¤§å° 2-XX:MaxMetaspaceSize=512m # æœ€å¤§å…ƒç©ºé—´å¤§å° GC æ—¥å¿—\n1-XX:+PrintGCDetails # æ‰“å° GC è¯¦ç»†ä¿¡æ¯ 2-XX:+PrintGCDateStamps # æ‰“å° GC æ—¶é—´æˆ³ 3-Xloggc:/tmp/gc.log # GC æ—¥å¿—æ–‡ä»¶ OOM æ—¶ç”Ÿæˆ Heap Dump\n1-XX:+HeapDumpOnOutOfMemoryError 2-XX:HeapDumpPath=/tmp/heapdump.hprof GC æ”¶é›†å™¨é€‰æ‹©\n1# G1 æ”¶é›†å™¨ï¼ˆæ¨èï¼‰ 2-XX:+UseG1GC 3-XX:MaxGCPauseMillis=200 # æœ€å¤§ GC åœé¡¿æ—¶é—´ 4 5# ZGCï¼ˆJDK 11+ï¼‰ 6-XX:+UseZGC ç›‘æ§ä¸é¢„è­¦ 1. ä½¿ç”¨ JVM ç›‘æ§å·¥å…·\nJConsoleï¼šJDK è‡ªå¸¦çš„ç›‘æ§å·¥å…· VisualVMï¼šå¯è§†åŒ–ç›‘æ§å·¥å…· Arthasï¼šé˜¿é‡Œå¼€æºçš„è¯Šæ–­å·¥å…· 2. ä½¿ç”¨ APM å·¥å…·\nSkyWalkingï¼šåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ Prometheus + Grafanaï¼šç›‘æ§ä¸å¯è§†åŒ– 3. è®¾ç½®å†…å­˜å‘Šè­¦\nå½“å †å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 80% æ—¶ï¼Œå‘é€å‘Šè­¦é€šçŸ¥ã€‚\næ€»ç»“ä¸æ€è€ƒ JVM OOM æ’æŸ¥çš„æ–¹æ³•è®ºï¼š\nç”Ÿæˆ Heap Dump ä½¿ç”¨ MAT åˆ†æå†…å­˜å ç”¨ æŸ¥çœ‹ Dominator Treeï¼Œæ‰¾åˆ°å ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡ åˆ†æå¼•ç”¨é“¾ï¼Œæ‰¾åˆ°æ ¹å›  ä¿®å¤ä»£ç ï¼Œé¿å…å†…å­˜æ³„æ¼ å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ï¼š\nThreadLocal æœªæ¸…ç† é™æ€é›†åˆæ— é™å¢é•¿ ç›‘å¬å™¨æœªæ³¨é”€ èµ„æºæœªå…³é—­ é¢„é˜²æªæ–½ï¼š\nCode Review é‡ç‚¹å…³æ³¨èµ„æºç®¡ç† ä½¿ç”¨ try-with-resources è‡ªåŠ¨å…³é—­èµ„æº å®šæœŸåˆ†æ Heap Dumpï¼Œæå‰å‘ç°é—®é¢˜ è®¾ç½®åˆç†çš„ JVM å‚æ•°å’Œç›‘æ§å‘Šè­¦ ä¸‹æ¬¡å½“ä½ çš„åº”ç”¨ OOM æ—¶ï¼ŒæŒ‰ç…§è¿™ä¸ªæ–¹æ³•è®ºä¸€æ­¥æ­¥æ’æŸ¥ï¼Œä¸€å®šèƒ½æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚\n","permalink":"http://localhost:1313/posts/2024/10/jvm-oom-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98%E4%BB%8E-heap-dump-%E5%88%B0%E6%A0%B9%E5%9B%A0%E5%88%86%E6%9E%90/","summary":"\u003cp\u003eç”Ÿäº§ç¯å¢ƒçš„ OOMï¼ˆOut Of Memoryï¼‰æ˜¯åç«¯å¼€å‘æœ€å¤´ç–¼çš„é—®é¢˜ä¹‹ä¸€ã€‚æœ¬æ–‡é€šè¿‡çœŸå®æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œè§£å†³ JVM å†…å­˜é—®é¢˜ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ JVM å†…å­˜æ¨¡å‹ä¸ GC æœºåˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Heap Dump çš„ç”Ÿæˆä¸åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ MAT å·¥å…·å®šä½å†…å­˜æ³„æ¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"jvm-å†…å­˜æ¨¡å‹\"\u003eJVM å†…å­˜æ¨¡å‹\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå †å†…å­˜ï¼ˆHeapï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¹´è½»ä»£ï¼ˆYoung Generationï¼‰\n\u003cul\u003e\n\u003cli\u003eEden åŒºï¼šæ–°å¯¹è±¡åˆ†é…çš„åŒºåŸŸ\u003c/li\u003e\n\u003cli\u003eSurvivor åŒºï¼šS0 å’Œ S1ï¼Œå­˜æ”¾ç»è¿‡ä¸€æ¬¡ GC åå­˜æ´»çš„å¯¹è±¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eè€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eéå †å†…å­˜\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ–¹æ³•åŒºï¼ˆMetaspaceï¼‰ï¼šå­˜æ”¾ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡\u003c/li\u003e\n\u003cli\u003eæ ˆï¼ˆStackï¼‰ï¼šå­˜æ”¾å±€éƒ¨å˜é‡ã€æ–¹æ³•è°ƒç”¨\u003c/li\u003e\n\u003cli\u003eç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ï¼šNIO ä½¿ç”¨çš„å †å¤–å†…å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eGC æœºåˆ¶\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMinor GCï¼šæ¸…ç†å¹´è½»ä»£\u003c/li\u003e\n\u003cli\u003eMajor GCï¼šæ¸…ç†è€å¹´ä»£\u003c/li\u003e\n\u003cli\u003eFull GCï¼šæ¸…ç†æ•´ä¸ªå †å†…å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå¯¹è±¡æ™‹å‡\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ–°å¯¹è±¡åœ¨ Eden åŒºåˆ†é…\u003c/li\u003e\n\u003cli\u003eEden åŒºæ»¡äº†ï¼Œè§¦å‘ Minor GC\u003c/li\u003e\n\u003cli\u003eå­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ° Survivor åŒº\u003c/li\u003e\n\u003cli\u003eç»è¿‡å¤šæ¬¡ GC åï¼Œå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e JVM çš„åˆ†ä»£æ”¶é›†ä½“ç°äº†\u0026quot;å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•æ­»\u0026quot;çš„ç‰¹ç‚¹ã€‚å¹´è½»ä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¿«é€Ÿå›æ”¶çŸ­å‘½å¯¹è±¡ï¼›è€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå¤„ç†é•¿æœŸå­˜æ´»çš„å¯¹è±¡ã€‚è¿™ç§è®¾è®¡åœ¨æ€§èƒ½å’Œå†…å­˜åˆ©ç”¨ç‡ä¹‹é—´æ‰¾åˆ°äº†å¹³è¡¡ã€‚\u003c/p\u003e","title":"JVM OOM é—®é¢˜æ’æŸ¥å®æˆ˜ï¼šä» Heap Dump åˆ°æ ¹å› åˆ†æ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´çš„åŒæ­¥è°ƒç”¨ä¼šå¯¼è‡´å¼ºè€¦åˆå’Œæ€§èƒ½ç“¶é¢ˆã€‚æ¶ˆæ¯é˜Ÿåˆ—é€šè¿‡å¼‚æ­¥è§£è€¦ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚æœ¬æ–‡è®²è§£ RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å®æˆ˜åº”ç”¨ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒä»·å€¼ä¸é€‰å‹æ ‡å‡† æŒæ¡ RabbitMQ çš„æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæ¨¡å¼ å­¦ä¼šä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆ äº†è§£æ¶ˆæ¯å¹‚ç­‰æ€§ä¸é¡ºåºæ€§çš„å¤„ç† ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ åœºæ™¯ï¼šè®¢å•åˆ›å»ºæµç¨‹\nåŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private InventoryService inventoryService; 6 7 @Autowired 8 private PaymentService paymentService; 9 10 @Autowired 11 private NotificationService notificationService; 12 13 public void createOrder(Order order) { 14 // 1. ä¿å­˜è®¢å• 15 orderMapper.insert(order); 16 17 // 2. æ‰£å‡åº“å­˜ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 18 inventoryService.deduct(order.getProductId(), order.getQuantity()); 19 20 // 3. åˆ›å»ºæ”¯ä»˜å•ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 21 paymentService.createPayment(order.getId()); 22 23 // 4. å‘é€é€šçŸ¥ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 24 notificationService.sendOrderCreatedNotification(order.getUserId()); 25 } 26} é—®é¢˜ï¼š\nå“åº”æ—¶é—´é•¿ï¼šæ€»è€—æ—¶ = ä¿å­˜è®¢å• + æ‰£å‡åº“å­˜ + åˆ›å»ºæ”¯ä»˜å• + å‘é€é€šçŸ¥ å¼ºè€¦åˆï¼šä»»ä½•ä¸€ä¸ªæœåŠ¡ä¸å¯ç”¨ï¼Œæ•´ä¸ªæµç¨‹å¤±è´¥ æ€§èƒ½ç“¶é¢ˆï¼šä¸‹æ¸¸æœåŠ¡çš„æ€§èƒ½å½±å“ä¸Šæ¸¸æœåŠ¡ å¼‚æ­¥è§£è€¦çš„æ–¹æ¡ˆ\n1@Service 2public class OrderService { 3 4 @Autowired 5 private RabbitTemplate rabbitTemplate; 6 7 public void createOrder(Order order) { 8 // 1. ä¿å­˜è®¢å• 9 orderMapper.insert(order); 10 11 // 2. å‘é€æ¶ˆæ¯åˆ° MQ 12 OrderCreatedEvent event = new OrderCreatedEvent(order.getId(), order.getUserId()); 13 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, event); 14 } 15} 16 17// åº“å­˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ 18@Component 19public class InventoryListener { 20 21 @RabbitListener(queues = \u0026#34;inventory.queue\u0026#34;) 22 public void handleOrderCreated(OrderCreatedEvent event) { 23 inventoryService.deduct(event.getOrderId()); 24 } 25} å¥½å¤„ï¼š\nå“åº”æ—¶é—´çŸ­ï¼šåªéœ€è¦ä¿å­˜è®¢å• + å‘é€æ¶ˆæ¯ æ¾è€¦åˆï¼šä¸‹æ¸¸æœåŠ¡ä¸å¯ç”¨ä¸å½±å“è®¢å•åˆ›å»º å‰Šå³°å¡«è°·ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²æµé‡é«˜å³° æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹ï¼šRabbitMQ vs Kafka ç‰¹æ€§ RabbitMQ Kafka æ¶ˆæ¯æ¨¡å‹ æ¨æ¨¡å¼ï¼ˆPushï¼‰ æ‹‰æ¨¡å¼ï¼ˆPullï¼‰ ååé‡ ä¸‡çº§ ç™¾ä¸‡çº§ å»¶è¿Ÿ å¾®ç§’çº§ æ¯«ç§’çº§ æ¶ˆæ¯é¡ºåº é˜Ÿåˆ—çº§åˆ« åˆ†åŒºçº§åˆ« æ¶ˆæ¯æŒä¹…åŒ– æ”¯æŒ æ”¯æŒ é€‚ç”¨åœºæ™¯ ä¸šåŠ¡è§£è€¦ã€ä»»åŠ¡é˜Ÿåˆ— æ—¥å¿—æ”¶é›†ã€æµå¤„ç† é€‰æ‹© RabbitMQ çš„ç†ç”±\nä¸šåŠ¡åœºæ™¯éœ€è¦å¤æ‚çš„è·¯ç”±è§„åˆ™ï¼ˆExchange + Routing Keyï¼‰ éœ€è¦æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆACKï¼‰ æ¶ˆæ¯é‡ä¸å¤§ï¼Œæ›´å…³æ³¨å¯é æ€§ é€‰æ‹© Kafka çš„ç†ç”±\næµ·é‡æ—¥å¿—æ”¶é›† å®æ—¶æµå¤„ç† éœ€è¦æ¶ˆæ¯å›æº¯ RabbitMQ æ ¸å¿ƒæ¦‚å¿µ æ¶æ„å›¾\n1Producer â†’ Exchange â†’ Queue â†’ Consumer Exchangeï¼ˆäº¤æ¢æœºï¼‰\næ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œæ ¹æ®è·¯ç”±è§„åˆ™åˆ†å‘åˆ°é˜Ÿåˆ—ã€‚\nå››ç§ç±»å‹ï¼š\nDirectï¼šç²¾ç¡®åŒ¹é… Routing Key Topicï¼šæ¨¡ç³ŠåŒ¹é… Routing Keyï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰ Fanoutï¼šå¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ— Headersï¼šæ ¹æ®æ¶ˆæ¯å¤´åŒ¹é… Queueï¼ˆé˜Ÿåˆ—ï¼‰\nå­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚\nBindingï¼ˆç»‘å®šï¼‰\nExchange å’Œ Queue ä¹‹é—´çš„è·¯ç”±è§„åˆ™ã€‚\nå·¥ä½œæ¨¡å¼ 1. Simple æ¨¡å¼ï¼ˆç®€å•é˜Ÿåˆ—ï¼‰\nä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ã€‚\n1// ç”Ÿäº§è€… 2rabbitTemplate.convertAndSend(\u0026#34;simple.queue\u0026#34;, \u0026#34;Hello\u0026#34;); 3 4// æ¶ˆè´¹è€… 5@RabbitListener(queues = \u0026#34;simple.queue\u0026#34;) 6public void receive(String message) { 7 System.out.println(\u0026#34;æ”¶åˆ°æ¶ˆæ¯: \u0026#34; + message); 8} 2. Work æ¨¡å¼ï¼ˆå·¥ä½œé˜Ÿåˆ—ï¼‰\nä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯è½®è¯¢åˆ†å‘ã€‚\n1@RabbitListener(queues = \u0026#34;work.queue\u0026#34;) 2public void worker1(String message) { 3 System.out.println(\u0026#34;Worker1: \u0026#34; + message); 4} 5 6@RabbitListener(queues = \u0026#34;work.queue\u0026#34;) 7public void worker2(String message) { 8 System.out.println(\u0026#34;Worker2: \u0026#34; + message); 9} 3. Publish/Subscribe æ¨¡å¼ï¼ˆå‘å¸ƒè®¢é˜…ï¼‰\nä½¿ç”¨ Fanout Exchangeï¼Œæ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰é˜Ÿåˆ—ã€‚\n1// é…ç½® 2@Bean 3public FanoutExchange fanoutExchange() { 4 return new FanoutExchange(\u0026#34;fanout.exchange\u0026#34;); 5} 6 7@Bean 8public Queue queue1() { 9 return new Queue(\u0026#34;queue1\u0026#34;); 10} 11 12@Bean 13public Binding binding1(FanoutExchange fanoutExchange, Queue queue1) { 14 return BindingBuilder.bind(queue1).to(fanoutExchange); 15} 16 17// ç”Ÿäº§è€… 18rabbitTemplate.convertAndSend(\u0026#34;fanout.exchange\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;Hello\u0026#34;); 4. Routing æ¨¡å¼ï¼ˆè·¯ç”±ï¼‰\nä½¿ç”¨ Direct Exchangeï¼Œæ ¹æ® Routing Key ç²¾ç¡®åŒ¹é…ã€‚\n1// é…ç½® 2@Bean 3public DirectExchange directExchange() { 4 return new DirectExchange(\u0026#34;direct.exchange\u0026#34;); 5} 6 7@Bean 8public Binding bindingError(Queue errorQueue, DirectExchange directExchange) { 9 return BindingBuilder.bind(errorQueue).to(directExchange).with(\u0026#34;error\u0026#34;); 10} 11 12// ç”Ÿäº§è€… 13rabbitTemplate.convertAndSend(\u0026#34;direct.exchange\u0026#34;, \u0026#34;error\u0026#34;, \u0026#34;Error message\u0026#34;); 5. Topic æ¨¡å¼ï¼ˆä¸»é¢˜ï¼‰\nä½¿ç”¨ Topic Exchangeï¼Œæ”¯æŒé€šé…ç¬¦åŒ¹é…ã€‚\n*ï¼šåŒ¹é…ä¸€ä¸ªå•è¯ #ï¼šåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå•è¯ 1// é…ç½® 2@Bean 3public TopicExchange topicExchange() { 4 return new TopicExchange(\u0026#34;topic.exchange\u0026#34;); 5} 6 7@Bean 8public Binding bindingOrder(Queue orderQueue, TopicExchange topicExchange) { 9 return BindingBuilder.bind(orderQueue).to(topicExchange).with(\u0026#34;order.*\u0026#34;); 10} 11 12// ç”Ÿäº§è€… 13rabbitTemplate.convertAndSend(\u0026#34;topic.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, \u0026#34;Order created\u0026#34;); 14rabbitTemplate.convertAndSend(\u0026#34;topic.exchange\u0026#34;, \u0026#34;order.paid\u0026#34;, \u0026#34;Order paid\u0026#34;); æ¶æ„æ€è€ƒï¼š RabbitMQ çš„ Exchange æœºåˆ¶ä½“ç°äº†\u0026quot;ç­–ç•¥æ¨¡å¼\u0026quot;çš„æ€æƒ³ã€‚ä¸åŒç±»å‹çš„ Exchange å®ç°ä¸åŒçš„è·¯ç”±ç­–ç•¥ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸éœ€è¦å…³å¿ƒè·¯ç”±ç»†èŠ‚ã€‚è¿™ç§è®¾è®¡è®©ç³»ç»Ÿæ›´åŠ çµæ´»ï¼Œæ˜“äºæ‰©å±•ã€‚\næ¶ˆæ¯å¯é æ€§ä¿éšœ é—®é¢˜ä¸€ï¼šç”Ÿäº§è€…æ¶ˆæ¯ä¸¢å¤±\nç”Ÿäº§è€…å‘é€æ¶ˆæ¯åï¼ŒRabbitMQ å®•æœºï¼Œæ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼ˆPublisher Confirmï¼‰\n1spring: 2 rabbitmq: 3 publisher-confirm-type: correlated 4 publisher-returns: true 1@Configuration 2public class RabbitConfig { 3 4 @Bean 5 public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) { 6 RabbitTemplate template = new RabbitTemplate(connectionFactory); 7 8 // æ¶ˆæ¯å‘é€åˆ° Exchange çš„ç¡®è®¤ 9 template.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { 10 if (ack) { 11 log.info(\u0026#34;æ¶ˆæ¯å‘é€æˆåŠŸ\u0026#34;); 12 } else { 13 log.error(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥: {}\u0026#34;, cause); 14 // é‡è¯•æˆ–è®°å½•åˆ°æ•°æ®åº“ 15 } 16 }); 17 18 // æ¶ˆæ¯ä» Exchange è·¯ç”±åˆ° Queue çš„ç¡®è®¤ 19 template.setReturnsCallback(returned -\u0026gt; { 20 log.error(\u0026#34;æ¶ˆæ¯è·¯ç”±å¤±è´¥: {}\u0026#34;, returned.getMessage()); 21 }); 22 23 return template; 24 } 25} é—®é¢˜äºŒï¼šæ¶ˆæ¯åœ¨ RabbitMQ ä¸­ä¸¢å¤±\nRabbitMQ å®•æœºï¼Œå†…å­˜ä¸­çš„æ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ¶ˆæ¯æŒä¹…åŒ–\n1// 1. Exchange æŒä¹…åŒ– 2@Bean 3public DirectExchange directExchange() { 4 return new DirectExchange(\u0026#34;direct.exchange\u0026#34;, true, false); 5} 6 7// 2. Queue æŒä¹…åŒ– 8@Bean 9public Queue queue() { 10 return new Queue(\u0026#34;my.queue\u0026#34;, true); 11} 12 13// 3. æ¶ˆæ¯æŒä¹…åŒ– 14rabbitTemplate.convertAndSend(\u0026#34;direct.exchange\u0026#34;, \u0026#34;routing.key\u0026#34;, message, msg -\u0026gt; { 15 msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); 16 return msg; 17}); é—®é¢˜ä¸‰ï¼šæ¶ˆè´¹è€…æ¶ˆæ¯ä¸¢å¤±\næ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯åï¼Œè¿˜æ²¡å¤„ç†å®Œå°±å®•æœºï¼Œæ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨ ACK\n1spring: 2 rabbitmq: 3 listener: 4 simple: 5 acknowledge-mode: manual 1@RabbitListener(queues = \u0026#34;my.queue\u0026#34;) 2public void receive(String message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag) { 3 try { 4 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 5 processMessage(message); 6 7 // æ‰‹åŠ¨ç¡®è®¤ 8 channel.basicAck(tag, false); 9 } catch (Exception e) { 10 log.error(\u0026#34;æ¶ˆæ¯å¤„ç†å¤±è´¥\u0026#34;, e); 11 12 // æ‹’ç»æ¶ˆæ¯ï¼Œé‡æ–°å…¥é˜Ÿ 13 channel.basicNack(tag, false, true); 14 } 15} é¿å‘æç¤ºï¼š æ‰‹åŠ¨ ACK æ—¶ï¼Œå¦‚æœå¿˜è®°è°ƒç”¨ basicAck æˆ– basicNackï¼Œæ¶ˆæ¯ä¼šä¸€ç›´å¤„äº Unacked çŠ¶æ€ï¼Œå ç”¨å†…å­˜ã€‚å»ºè®®åœ¨ finally å—ä¸­ç¡®ä¿æ¶ˆæ¯è¢«ç¡®è®¤ã€‚\næ¶ˆæ¯å¹‚ç­‰æ€§ æ¶ˆæ¯å¯èƒ½è¢«é‡å¤æ¶ˆè´¹ï¼ˆç½‘ç»œæŠ–åŠ¨ã€æ¶ˆè´¹è€…é‡å¯ï¼‰ï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§ã€‚\næ–¹æ¡ˆä¸€ï¼šå”¯ä¸€ ID + æ•°æ®åº“å»é‡\n1@RabbitListener(queues = \u0026#34;order.queue\u0026#34;) 2public void handleOrder(OrderMessage message) { 3 String messageId = message.getMessageId(); 4 5 // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç† 6 if (messageLogMapper.exists(messageId)) { 7 log.info(\u0026#34;æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: {}\u0026#34;, messageId); 8 return; 9 } 10 11 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 12 processOrder(message); 13 14 // è®°å½•æ¶ˆæ¯ ID 15 messageLogMapper.insert(new MessageLog(messageId)); 16} æ–¹æ¡ˆäºŒï¼šRedis å»é‡\n1@RabbitListener(queues = \u0026#34;order.queue\u0026#34;) 2public void handleOrder(OrderMessage message) { 3 String messageId = message.getMessageId(); 4 String key = \u0026#34;message:processed:\u0026#34; + messageId; 5 6 // ä½¿ç”¨ SETNX ä¿è¯åŸå­æ€§ 7 Boolean success = redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;, 1, TimeUnit.HOURS); 8 if (!success) { 9 log.info(\u0026#34;æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: {}\u0026#34;, messageId); 10 return; 11 } 12 13 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 14 processOrder(message); 15} æ¶ˆæ¯é¡ºåºæ€§ RabbitMQ ä¸ä¿è¯å…¨å±€é¡ºåºï¼Œåªä¿è¯å•ä¸ªé˜Ÿåˆ—çš„é¡ºåºã€‚\næ–¹æ¡ˆï¼šæŒ‰ä¸šåŠ¡ ID è·¯ç”±åˆ°åŒä¸€é˜Ÿåˆ—\n1// ç”Ÿäº§è€…ï¼šæ ¹æ®è®¢å• ID è®¡ç®— Routing Key 2public void sendMessage(OrderMessage message) { 3 String routingKey = \u0026#34;order.\u0026#34; + (message.getOrderId() % 10); 4 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, routingKey, message); 5} 6 7// æ¶ˆè´¹è€…ï¼šæ¯ä¸ªé˜Ÿåˆ—åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€… 8@RabbitListener(queues = \u0026#34;order.queue.0\u0026#34;, concurrency = \u0026#34;1\u0026#34;) 9public void handleOrder0(OrderMessage message) { 10 processOrder(message); 11} æ­»ä¿¡é˜Ÿåˆ— æ¶ˆæ¯å¤„ç†å¤±è´¥åï¼Œå¯ä»¥å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Œé¿å…é˜»å¡æ­£å¸¸æ¶ˆæ¯ã€‚\né…ç½®æ­»ä¿¡é˜Ÿåˆ—\n1@Bean 2public Queue normalQueue() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-dead-letter-exchange\u0026#34;, \u0026#34;dlx.exchange\u0026#34;); 5 args.put(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;dlx.routing.key\u0026#34;); 6 return new Queue(\u0026#34;normal.queue\u0026#34;, true, false, false, args); 7} 8 9@Bean 10public Queue deadLetterQueue() { 11 return new Queue(\u0026#34;dead.letter.queue\u0026#34;); 12} 13 14@Bean 15public DirectExchange dlxExchange() { 16 return new DirectExchange(\u0026#34;dlx.exchange\u0026#34;); 17} 18 19@Bean 20public Binding dlxBinding() { 21 return BindingBuilder.bind(deadLetterQueue()).to(dlxExchange()).with(\u0026#34;dlx.routing.key\u0026#34;); 22} æ¶ˆè´¹è€…æ‹’ç»æ¶ˆæ¯\n1@RabbitListener(queues = \u0026#34;normal.queue\u0026#34;) 2public void receive(String message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag) { 3 try { 4 processMessage(message); 5 channel.basicAck(tag, false); 6 } catch (Exception e) { 7 // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ— 8 channel.basicNack(tag, false, false); 9 } 10} å»¶è¿Ÿé˜Ÿåˆ— å®ç°å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆã€‚\næ–¹æ¡ˆä¸€ï¼šTTL + æ­»ä¿¡é˜Ÿåˆ—\n1@Bean 2public Queue delayQueue() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-message-ttl\u0026#34;, 30000); // 30 ç§’åè¿‡æœŸ 5 args.put(\u0026#34;x-dead-letter-exchange\u0026#34;, \u0026#34;order.exchange\u0026#34;); 6 args.put(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;order.timeout\u0026#34;); 7 return new Queue(\u0026#34;delay.queue\u0026#34;, true, false, false, args); 8} æ–¹æ¡ˆäºŒï¼šRabbitMQ å»¶è¿Ÿæ’ä»¶\n1rabbitmq-plugins enable rabbitmq_delayed_message_exchange 1@Bean 2public CustomExchange delayExchange() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-delayed-type\u0026#34;, \u0026#34;direct\u0026#34;); 5 return new CustomExchange(\u0026#34;delay.exchange\u0026#34;, \u0026#34;x-delayed-message\u0026#34;, true, false, args); 6} 7 8// å‘é€å»¶è¿Ÿæ¶ˆæ¯ 9rabbitTemplate.convertAndSend(\u0026#34;delay.exchange\u0026#34;, \u0026#34;routing.key\u0026#34;, message, msg -\u0026gt; { 10 msg.getMessageProperties().setDelay(30000); // å»¶è¿Ÿ 30 ç§’ 11 return msg; 12}); æ€»ç»“ä¸æ€è€ƒ RabbitMQ çš„æ ¸å¿ƒä»·å€¼æ˜¯å¼‚æ­¥è§£è€¦ï¼Œæå‡ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚\nä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆï¼š\nç”Ÿäº§è€…ç¡®è®¤ï¼šPublisher Confirm æ¶ˆæ¯æŒä¹…åŒ–ï¼šExchangeã€Queueã€Message éƒ½æŒä¹…åŒ– æ¶ˆè´¹è€…ç¡®è®¤ï¼šæ‰‹åŠ¨ ACK å¹‚ç­‰æ€§ï¼šå”¯ä¸€ ID + å»é‡ æ­»ä¿¡é˜Ÿåˆ—ï¼šå¤„ç†å¤±è´¥æ¶ˆæ¯ ä¸‹æ¬¡å½“ä½ çš„ç³»ç»Ÿéœ€è¦å¼‚æ­¥è§£è€¦æ—¶ï¼Œä¸å¦¨è¯•è¯• RabbitMQï¼Œä½“éªŒæ¶ˆæ¯é˜Ÿåˆ—çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/10/rabbitmq-%E5%9C%A8%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E8%A7%A3%E8%80%A6%E5%AE%9E%E8%B7%B5/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´çš„åŒæ­¥è°ƒç”¨ä¼šå¯¼è‡´å¼ºè€¦åˆå’Œæ€§èƒ½ç“¶é¢ˆã€‚æ¶ˆæ¯é˜Ÿåˆ—é€šè¿‡å¼‚æ­¥è§£è€¦ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚æœ¬æ–‡è®²è§£ RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å®æˆ˜åº”ç”¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒä»·å€¼ä¸é€‰å‹æ ‡å‡†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ RabbitMQ çš„æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæ¨¡å¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£æ¶ˆæ¯å¹‚ç­‰æ€§ä¸é¡ºåºæ€§çš„å¤„ç†\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—\"\u003eä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼šè®¢å•åˆ›å»ºæµç¨‹\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrderService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eInventoryService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einventoryService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epaymentService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eNotificationService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enotificationService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecreateOrder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. ä¿å­˜è®¢å•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einsert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æ‰£å‡åº“å­˜ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003einventoryService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ededuct\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductId\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆ›å»ºæ”¯ä»˜å•ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003epaymentService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreatePayment\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. å‘é€é€šçŸ¥ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003enotificationService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esendOrderCreatedNotification\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e","title":"RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å¼‚æ­¥è§£è€¦å®è·µ"},{"content":"DDDï¼ˆDomain-Driven Designï¼‰æ˜¯ä¸€å¥—å¤æ‚ä¸šåŠ¡ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•è®ºã€‚ä½†å¾ˆå¤šäººå­¦äº† DDD çš„æ¦‚å¿µï¼Œå´ä¸çŸ¥é“å¦‚ä½•è½åœ°ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªç”µå•†è®¢å•ç³»ç»Ÿçš„æ¡ˆä¾‹ï¼Œè®²è§£ DDD çš„å®æˆ˜åº”ç”¨ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ DDD çš„æ ¸å¿ƒæ¦‚å¿µï¼šå®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡ æŒæ¡é™ç•Œä¸Šä¸‹æ–‡çš„åˆ’åˆ†æ–¹æ³• å­¦ä¼šç”¨é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦ äº†è§£ DDD åˆ†å±‚æ¶æ„çš„ä»£ç ç»„ç»‡ ä¸ºä»€ä¹ˆéœ€è¦ DDDï¼Ÿ ä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨ç®€å•ä¸šåŠ¡åœºæ™¯ä¸‹å¤Ÿç”¨ï¼Œä½†å½“ä¸šåŠ¡å¤æ‚åº¦å¢åŠ æ—¶ï¼Œä¼šå‡ºç°å‡ ä¸ªé—®é¢˜ï¼š\nService å±‚é€»è¾‘è‡ƒè‚¿\næ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å †åœ¨ Service å±‚ï¼Œä¸€ä¸ª OrderService å¯èƒ½æœ‰å‡ åƒè¡Œä»£ç ã€‚\nä¸šåŠ¡è§„åˆ™æ•£è½å„å¤„\nè®¢å•çš„çŠ¶æ€æµè½¬è§„åˆ™å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ª Service æ–¹æ³•ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚\né¢†åŸŸçŸ¥è¯†æµå¤±\nä»£ç ä¸­å……æ–¥ç€ updateStatus(orderId, 3)ï¼Œæ²¡äººçŸ¥é“ 3 ä»£è¡¨ä»€ä¹ˆçŠ¶æ€ã€‚\nDDD é€šè¿‡é¢†åŸŸå»ºæ¨¡ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ï¼Œæå‡å¯ç»´æŠ¤æ€§ã€‚\nDDD æ ¸å¿ƒæ¦‚å¿µ å®ä½“ï¼ˆEntityï¼‰\næœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå†…æ ‡è¯†ä¸å˜ã€‚æ¯”å¦‚è®¢å•ã€ç”¨æˆ·ã€‚\n1public class Order { 2 private OrderId id; // å”¯ä¸€æ ‡è¯† 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 // ä¸šåŠ¡æ–¹æ³• 8 public void pay() { 9 if (this.status != OrderStatus.PENDING_PAYMENT) { 10 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 11 } 12 this.status = OrderStatus.PAID; 13 } 14} å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰\næ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œé€šè¿‡å±æ€§å€¼åˆ¤æ–­ç›¸ç­‰æ€§ã€‚æ¯”å¦‚åœ°å€ã€é‡‘é¢ã€‚\n1public class Money { 2 private final BigDecimal amount; 3 private final Currency currency; 4 5 public Money(BigDecimal amount, Currency currency) { 6 if (amount.compareTo(BigDecimal.ZERO) \u0026lt; 0) { 7 throw new IllegalArgumentException(\u0026#34;é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°\u0026#34;); 8 } 9 this.amount = amount; 10 this.currency = currency; 11 } 12 13 public Money add(Money other) { 14 if (!this.currency.equals(other.currency)) { 15 throw new IllegalArgumentException(\u0026#34;è´§å¸ç±»å‹ä¸ä¸€è‡´\u0026#34;); 16 } 17 return new Money(this.amount.add(other.amount), this.currency); 18 } 19} å€¼å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€æœ‰æ“ä½œéƒ½è¿”å›æ–°å¯¹è±¡ã€‚\nèšåˆæ ¹ï¼ˆAggregate Rootï¼‰\nèšåˆæ˜¯ä¸€ç»„ç›¸å…³å¯¹è±¡çš„é›†åˆï¼Œèšåˆæ ¹æ˜¯èšåˆçš„å…¥å£ã€‚å¤–éƒ¨åªèƒ½é€šè¿‡èšåˆæ ¹è®¿é—®èšåˆå†…çš„å¯¹è±¡ã€‚\n1public class Order { // èšåˆæ ¹ 2 private OrderId id; 3 private List\u0026lt;OrderItem\u0026gt; items; // èšåˆå†…çš„å®ä½“ 4 5 // å¤–éƒ¨ä¸èƒ½ç›´æ¥ä¿®æ”¹ itemsï¼Œå¿…é¡»é€šè¿‡èšåˆæ ¹çš„æ–¹æ³• 6 public void addItem(Product product, int quantity) { 7 OrderItem item = new OrderItem(product, quantity); 8 this.items.add(item); 9 } 10} èšåˆæ ¹çš„ä½œç”¨æ˜¯ä¿æŠ¤èšåˆçš„ä¸å˜æ€§ï¼ˆInvariantï¼‰ã€‚\né¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰\nä¸å±äºä»»ä½•å®ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ”¾åœ¨é¢†åŸŸæœåŠ¡ä¸­ã€‚\n1public class PricingService { 2 3 public Money calculateTotalPrice(Order order) { 4 Money total = Money.zero(); 5 for (OrderItem item : order.getItems()) { 6 Money itemPrice = item.getProduct().getPrice().multiply(item.getQuantity()); 7 total = total.add(itemPrice); 8 } 9 return total; 10 } 11} æ¶æ„æ€è€ƒï¼š å®ä½“å’Œå€¼å¯¹è±¡çš„åŒºåˆ«åœ¨äºæ˜¯å¦æœ‰å”¯ä¸€æ ‡è¯†ã€‚è®¢å•æœ‰è®¢å•å·ï¼Œæ˜¯å®ä½“ï¼›é‡‘é¢æ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œæ˜¯å€¼å¯¹è±¡ã€‚åˆ¤æ–­æ ‡å‡†æ˜¯ï¼šå¦‚æœä¸¤ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§éƒ½ç›¸åŒï¼Œå®ƒä»¬æ˜¯å¦åº”è¯¥è¢«è§†ä¸ºåŒä¸€ä¸ªå¯¹è±¡ï¼Ÿ\né™ç•Œä¸Šä¸‹æ–‡ï¼šåˆ’åˆ†é¢†åŸŸè¾¹ç•Œ ä¸€ä¸ªå¤æ‚ç³»ç»ŸåŒ…å«å¤šä¸ªå­åŸŸï¼Œæ¯ä¸ªå­åŸŸæœ‰è‡ªå·±çš„é¢†åŸŸæ¨¡å‹ã€‚é™ç•Œä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰å®šä¹‰äº†é¢†åŸŸæ¨¡å‹çš„è¾¹ç•Œã€‚\næ¡ˆä¾‹ï¼šç”µå•†ç³»ç»Ÿçš„é™ç•Œä¸Šä¸‹æ–‡\nè®¢å•ä¸Šä¸‹æ–‡ï¼š è®¢å•ã€è®¢å•é¡¹ã€è®¢å•çŠ¶æ€ åº“å­˜ä¸Šä¸‹æ–‡ï¼š å•†å“ã€åº“å­˜ã€åº“å­˜æ‰£å‡ æ”¯ä»˜ä¸Šä¸‹æ–‡ï¼š æ”¯ä»˜å•ã€æ”¯ä»˜æ–¹å¼ã€æ”¯ä»˜çŠ¶æ€ ç‰©æµä¸Šä¸‹æ–‡ï¼š ç‰©æµå•ã€ç‰©æµçŠ¶æ€ã€ç‰©æµå…¬å¸ æ¯ä¸ªä¸Šä¸‹æ–‡æœ‰è‡ªå·±çš„é¢†åŸŸæ¨¡å‹ã€‚æ¯”å¦‚\u0026quot;å•†å“\u0026quot;åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„å«ä¹‰ä¸åŒï¼š\nè®¢å•ä¸Šä¸‹æ–‡ï¼šå•†å“æ˜¯è®¢å•é¡¹çš„ä¸€éƒ¨åˆ†ï¼Œå…³æ³¨å•†å“åç§°ã€ä»·æ ¼ åº“å­˜ä¸Šä¸‹æ–‡ï¼šå•†å“æ˜¯åº“å­˜ç®¡ç†çš„å¯¹è±¡ï¼Œå…³æ³¨åº“å­˜æ•°é‡ã€ä»“åº“ä½ç½® ä¸Šä¸‹æ–‡æ˜ å°„ï¼ˆContext Mappingï¼‰\nä¸åŒä¸Šä¸‹æ–‡ä¹‹é—´éœ€è¦åä½œï¼Œé€šè¿‡ä¸Šä¸‹æ–‡æ˜ å°„å®šä¹‰åä½œæ–¹å¼ï¼š\nå…±äº«å†…æ ¸ï¼ˆShared Kernelï¼‰ï¼š ä¸¤ä¸ªä¸Šä¸‹æ–‡å…±äº«éƒ¨åˆ†é¢†åŸŸæ¨¡å‹ å®¢æˆ·-ä¾›åº”å•†ï¼ˆCustomer-Supplierï¼‰ï¼š ä¸€ä¸ªä¸Šä¸‹æ–‡ä¾èµ–å¦ä¸€ä¸ªä¸Šä¸‹æ–‡ é˜²è…å±‚ï¼ˆAnti-Corruption Layerï¼‰ï¼š é€šè¿‡é€‚é…å™¨éš”ç¦»å¤–éƒ¨ç³»ç»Ÿ æ¡ˆä¾‹ï¼šè®¢å•ä¸Šä¸‹æ–‡ä¾èµ–åº“å­˜ä¸Šä¸‹æ–‡\n1// è®¢å•ä¸Šä¸‹æ–‡ä¸­çš„é˜²è…å±‚ 2public class InventoryAdapter { 3 4 @Autowired 5 private InventoryClient inventoryClient; 6 7 public boolean checkStock(ProductId productId, int quantity) { 8 // è°ƒç”¨åº“å­˜ä¸Šä¸‹æ–‡çš„æ¥å£ 9 InventoryDTO inventory = inventoryClient.getInventory(productId.getValue()); 10 return inventory.getStock() \u0026gt;= quantity; 11 } 12} é˜²è…å±‚çš„ä½œç”¨æ˜¯ï¼šéš”ç¦»å¤–éƒ¨ç³»ç»Ÿçš„å˜åŒ–ï¼Œä¿æŠ¤æœ¬ä¸Šä¸‹æ–‡çš„é¢†åŸŸæ¨¡å‹ã€‚\né¢†åŸŸäº‹ä»¶ï¼šå®ç°æœåŠ¡è§£è€¦ é¢†åŸŸäº‹ä»¶æ˜¯é¢†åŸŸä¸­å‘ç”Ÿçš„é‡è¦äº‹æƒ…ï¼Œæ¯”å¦‚\u0026quot;è®¢å•å·²åˆ›å»º\u0026quot;ã€\u0026ldquo;è®¢å•å·²æ”¯ä»˜\u0026rdquo;ã€‚\nå‘å¸ƒé¢†åŸŸäº‹ä»¶\n1public class Order { 2 3 public void pay() { 4 if (this.status != OrderStatus.PENDING_PAYMENT) { 5 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 6 } 7 this.status = OrderStatus.PAID; 8 9 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ 10 DomainEventPublisher.publish(new OrderPaidEvent(this.id, this.userId)); 11 } 12} ç›‘å¬é¢†åŸŸäº‹ä»¶\n1@Component 2public class OrderEventListener { 3 4 @Autowired 5 private InventoryService inventoryService; 6 7 @EventListener 8 public void handleOrderPaid(OrderPaidEvent event) { 9 // è®¢å•æ”¯ä»˜åï¼Œæ‰£å‡åº“å­˜ 10 inventoryService.deduct(event.getOrderId()); 11 } 12} é¢†åŸŸäº‹ä»¶çš„å¥½å¤„ï¼š\nè§£è€¦ï¼šè®¢å•ä¸Šä¸‹æ–‡ä¸éœ€è¦çŸ¥é“åº“å­˜ä¸Šä¸‹æ–‡çš„å­˜åœ¨ æ‰©å±•æ€§ï¼šæ–°å¢ç›‘å¬å™¨ä¸éœ€è¦ä¿®æ”¹è®¢å•ä»£ç  å®¡è®¡ï¼šäº‹ä»¶æµè®°å½•äº†ç³»ç»Ÿçš„æ‰€æœ‰å˜åŒ– æ¶æ„æ€è€ƒï¼š é¢†åŸŸäº‹ä»¶æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEDAï¼‰çš„åŸºç¡€ã€‚å®ƒè®©ç³»ç»Ÿä»\u0026quot;è°ƒç”¨é©±åŠ¨\u0026quot;å˜æˆ\u0026quot;äº‹ä»¶é©±åŠ¨\u0026quot;ï¼Œæå‡äº†ç³»ç»Ÿçš„æ¾è€¦åˆæ€§ã€‚ç±»ä¼¼çš„æ€æƒ³è¿˜æœ‰ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€å‘å¸ƒè®¢é˜…æ¨¡å¼ã€CQRSã€‚\nDDD åˆ†å±‚æ¶æ„ DDD æ¨èçš„åˆ†å±‚æ¶æ„ï¼š\n1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ ç”¨æˆ·æ¥å£å±‚ï¼ˆUser Interfaceï¼‰ â”‚ Controllerã€DTO 3â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 4â”‚ åº”ç”¨å±‚ï¼ˆApplicationï¼‰ â”‚ ApplicationServiceã€äº‹ä»¶å‘å¸ƒ 5â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 6â”‚ é¢†åŸŸå±‚ï¼ˆDomainï¼‰ â”‚ Entityã€ValueObjectã€DomainService 7â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 8â”‚ åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰ â”‚ Repositoryã€MQã€ç¼“å­˜ 9â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ç”¨æˆ·æ¥å£å±‚\nå¤„ç† HTTP è¯·æ±‚ï¼Œè°ƒç”¨åº”ç”¨å±‚æœåŠ¡ã€‚\n1@RestController 2@RequestMapping(\u0026#34;/orders\u0026#34;) 3public class OrderController { 4 5 @Autowired 6 private OrderApplicationService orderApplicationService; 7 8 @PostMapping 9 public OrderDTO createOrder(@RequestBody CreateOrderRequest request) { 10 OrderId orderId = orderApplicationService.createOrder(request); 11 return orderApplicationService.getOrder(orderId); 12 } 13} åº”ç”¨å±‚\nç¼–æ’é¢†åŸŸå¯¹è±¡ï¼Œå¤„ç†äº‹åŠ¡å’Œäº‹ä»¶å‘å¸ƒã€‚\n1@Service 2public class OrderApplicationService { 3 4 @Autowired 5 private OrderRepository orderRepository; 6 7 @Autowired 8 private DomainEventPublisher eventPublisher; 9 10 @Transactional 11 public OrderId createOrder(CreateOrderRequest request) { 12 // åˆ›å»ºè®¢å•èšåˆ 13 Order order = Order.create(request.getUserId(), request.getItems()); 14 15 // ä¿å­˜è®¢å• 16 orderRepository.save(order); 17 18 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ 19 eventPublisher.publish(new OrderCreatedEvent(order.getId())); 20 21 return order.getId(); 22 } 23} é¢†åŸŸå±‚\næ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨æ¡†æ¶ã€‚\n1public class Order { 2 private OrderId id; 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 public static Order create(UserId userId, List\u0026lt;OrderItem\u0026gt; items) { 8 if (items.isEmpty()) { 9 throw new IllegalArgumentException(\u0026#34;è®¢å•é¡¹ä¸èƒ½ä¸ºç©º\u0026#34;); 10 } 11 Order order = new Order(); 12 order.id = OrderId.generate(); 13 order.userId = userId; 14 order.status = OrderStatus.PENDING_PAYMENT; 15 order.items = items; 16 return order; 17 } 18 19 public void pay() { 20 if (this.status != OrderStatus.PENDING_PAYMENT) { 21 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 22 } 23 this.status = OrderStatus.PAID; 24 } 25} åŸºç¡€è®¾æ–½å±‚\nå®ç°é¢†åŸŸå±‚å®šä¹‰çš„æ¥å£ï¼Œå¤„ç†æŒä¹…åŒ–ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ã€‚\n1@Repository 2public class OrderRepositoryImpl implements OrderRepository { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 @Override 8 public void save(Order order) { 9 OrderPO po = OrderConverter.toPO(order); 10 orderMapper.insert(po); 11 } 12 13 @Override 14 public Order findById(OrderId id) { 15 OrderPO po = orderMapper.selectById(id.getValue()); 16 return OrderConverter.toDomain(po); 17 } 18} é¿å‘æç¤ºï¼š é¢†åŸŸå±‚ä¸åº”è¯¥ä¾èµ–åŸºç¡€è®¾æ–½å±‚ã€‚Repository æ¥å£å®šä¹‰åœ¨é¢†åŸŸå±‚ï¼Œå®ç°åœ¨åŸºç¡€è®¾æ–½å±‚ã€‚è¿™æ˜¯ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰çš„ä½“ç°ã€‚\nDDD çš„é€‚ç”¨åœºæ™¯ DDD ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒé€‚åˆå¤æ‚ä¸šåŠ¡ç³»ç»Ÿï¼Œä¸é€‚åˆç®€å•çš„ CRUD åº”ç”¨ã€‚\né€‚åˆ DDD çš„åœºæ™¯ï¼š\nä¸šåŠ¡è§„åˆ™å¤æ‚ï¼Œéœ€è¦é¢‘ç¹å˜æ›´ å¤šä¸ªå›¢é˜Ÿåä½œå¼€å‘ ç³»ç»Ÿéœ€è¦é•¿æœŸæ¼”è¿› ä¸é€‚åˆ DDD çš„åœºæ™¯ï¼š\nç®€å•çš„å¢åˆ æ”¹æŸ¥ ä¸šåŠ¡é€»è¾‘å¾ˆå°‘ é¡¹ç›®å‘¨æœŸçŸ­ï¼Œä¸éœ€è¦é•¿æœŸç»´æŠ¤ æ€»ç»“ä¸æ€è€ƒ DDD çš„æ ¸å¿ƒæ˜¯ï¼šç”¨ä»£ç è¡¨è¾¾ä¸šåŠ¡è¯­è¨€ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ã€‚\né€šè¿‡å®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹å»ºæ¨¡é¢†åŸŸå¯¹è±¡ é€šè¿‡é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†é¢†åŸŸè¾¹ç•Œ é€šè¿‡é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦ é€šè¿‡åˆ†å±‚æ¶æ„éš”ç¦»ä¸šåŠ¡é€»è¾‘å’ŒæŠ€æœ¯å®ç° DDD ä¸æ˜¯æŠ€æœ¯ï¼Œè€Œæ˜¯æ€ç»´æ–¹å¼ã€‚å®ƒè¦æ±‚å¼€å‘è€…æ·±å…¥ç†è§£ä¸šåŠ¡ï¼Œä¸ä¸šåŠ¡ä¸“å®¶å…±åŒå»ºæ¨¡ã€‚è¿™æ˜¯ä¸€ä¸ªæŒç»­è¿­ä»£çš„è¿‡ç¨‹ã€‚\nä¸‹æ¬¡å½“ä½ çš„ Service å±‚ä»£ç è¶…è¿‡ 500 è¡Œæ—¶ï¼Œä¸å¦¨è¯•è¯• DDDï¼Œé‡æ–°å®¡è§†ä½ çš„é¢†åŸŸæ¨¡å‹ã€‚\n","permalink":"http://localhost:1313/posts/2024/09/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1ddd%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E4%BB%A3%E7%A0%81/","summary":"\u003cp\u003eDDDï¼ˆDomain-Driven Designï¼‰æ˜¯ä¸€å¥—å¤æ‚ä¸šåŠ¡ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•è®ºã€‚ä½†å¾ˆå¤šäººå­¦äº† DDD çš„æ¦‚å¿µï¼Œå´ä¸çŸ¥é“å¦‚ä½•è½åœ°ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªç”µå•†è®¢å•ç³»ç»Ÿçš„æ¡ˆä¾‹ï¼Œè®²è§£ DDD çš„å®æˆ˜åº”ç”¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ DDD çš„æ ¸å¿ƒæ¦‚å¿µï¼šå®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é™ç•Œä¸Šä¸‹æ–‡çš„åˆ’åˆ†æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç”¨é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ DDD åˆ†å±‚æ¶æ„çš„ä»£ç ç»„ç»‡\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦-ddd\"\u003eä¸ºä»€ä¹ˆéœ€è¦ DDDï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨ç®€å•ä¸šåŠ¡åœºæ™¯ä¸‹å¤Ÿç”¨ï¼Œä½†å½“ä¸šåŠ¡å¤æ‚åº¦å¢åŠ æ—¶ï¼Œä¼šå‡ºç°å‡ ä¸ªé—®é¢˜ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eService å±‚é€»è¾‘è‡ƒè‚¿\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å †åœ¨ Service å±‚ï¼Œä¸€ä¸ª OrderService å¯èƒ½æœ‰å‡ åƒè¡Œä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡è§„åˆ™æ•£è½å„å¤„\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eè®¢å•çš„çŠ¶æ€æµè½¬è§„åˆ™å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ª Service æ–¹æ³•ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé¢†åŸŸçŸ¥è¯†æµå¤±\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eä»£ç ä¸­å……æ–¥ç€ \u003ccode\u003eupdateStatus(orderId, 3)\u003c/code\u003eï¼Œæ²¡äººçŸ¥é“ 3 ä»£è¡¨ä»€ä¹ˆçŠ¶æ€ã€‚\u003c/p\u003e\n\u003cp\u003eDDD é€šè¿‡é¢†åŸŸå»ºæ¨¡ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ï¼Œæå‡å¯ç»´æŠ¤æ€§ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"ddd-æ ¸å¿ƒæ¦‚å¿µ\"\u003eDDD æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå®ä½“ï¼ˆEntityï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå†…æ ‡è¯†ä¸å˜ã€‚æ¯”å¦‚è®¢å•ã€ç”¨æˆ·ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å”¯ä¸€æ ‡è¯†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸šåŠ¡æ–¹æ³•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epay\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePENDING_PAYMENT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ethrow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eIllegalStateException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePAID\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eå€¼å¯¹è±¡ï¼ˆValue Objectï¼‰\u003c/strong\u003e\u003c/p\u003e","title":"é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰è½åœ°å®è·µï¼šä»ç†è®ºåˆ°ä»£ç "},{"content":"å®¹å™¨åŒ–å·²ç»æˆä¸ºç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†æ–¹å¼ã€‚Docker è®©åº”ç”¨éƒ¨ç½²å˜å¾—ç®€å•ã€å¯é ã€å¯ç§»æ¤ã€‚æœ¬æ–‡è®²è§£ Docker åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ Dockerfile çš„ç¼–å†™æŠ€å·§ä¸ä¼˜åŒ–æ–¹æ³• ç†è§£ Docker é•œåƒçš„åˆ†å±‚æ„å»ºåŸç† å­¦ä¼šä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒä½“ç§¯ äº†è§£ Docker Compose ç¼–æ’å¤šæœåŠ¡ç¯å¢ƒ ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–ï¼Ÿ ä¼ ç»Ÿéƒ¨ç½²çš„ç—›ç‚¹\nç¯å¢ƒä¸ä¸€è‡´ï¼š\u0026ldquo;åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘\u0026rdquo; ä¾èµ–ç®¡ç†å¤æ‚ï¼šJDKã€Tomcatã€MySQL ç‰ˆæœ¬ä¸ä¸€è‡´ éƒ¨ç½²æµç¨‹ç¹çï¼šæ‰‹åŠ¨ä¸Šä¼ ã€è§£å‹ã€é…ç½®ã€å¯åŠ¨ èµ„æºåˆ©ç”¨ç‡ä½ï¼šä¸€å°æœåŠ¡å™¨åªè·‘ä¸€ä¸ªåº”ç”¨ å®¹å™¨åŒ–çš„ä¼˜åŠ¿\nç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´ å¿«é€Ÿéƒ¨ç½²ï¼šç§’çº§å¯åŠ¨ï¼Œä¸€é”®éƒ¨ç½² èµ„æºéš”ç¦»ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“ æ˜“äºæ‰©å±•ï¼šæ°´å¹³æ‰©å±•åªéœ€å¯åŠ¨æ›´å¤šå®¹å™¨ Dockerfile åŸºç¡€ æœ€ç®€å•çš„ Dockerfile\n1FROM openjdk:11-jre-slim 2COPY app.jar /app.jar 3ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] æ„å»ºé•œåƒ\n1docker build -t myapp:1.0 . è¿è¡Œå®¹å™¨\n1docker run -d -p 8080:8080 myapp:1.0 Dockerfile æœ€ä½³å®è·µ 1. é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ ä¸å¥½çš„åšæ³•\n1FROM ubuntu:20.04 2RUN apt-get update \u0026amp;\u0026amp; apt-get install -y openjdk-11-jdk é•œåƒå¤§å°ï¼š600MB+\nå¥½çš„åšæ³•\n1FROM openjdk:11-jre-slim é•œåƒå¤§å°ï¼š200MB\næ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨ Alpine\n1FROM openjdk:11-jre-alpine é•œåƒå¤§å°ï¼š150MB\né€‰æ‹©åŸåˆ™ï¼š ä¼˜å…ˆä½¿ç”¨å®˜æ–¹é•œåƒï¼Œé€‰æ‹©æœ€å°çš„æ»¡è¶³éœ€æ±‚çš„ç‰ˆæœ¬ï¼ˆslim \u0026gt; alpineï¼‰\n2. åˆ©ç”¨æ„å»ºç¼“å­˜ Docker æ„å»ºé•œåƒæ—¶ï¼Œä¼šç¼“å­˜æ¯ä¸€å±‚ã€‚å¦‚æœæŸä¸€å±‚æ²¡æœ‰å˜åŒ–ï¼Œä¼šç›´æ¥ä½¿ç”¨ç¼“å­˜ã€‚\nä¸å¥½çš„åšæ³•\n1FROM openjdk:11-jre-slim 2COPY . /app 3RUN cd /app \u0026amp;\u0026amp; ./mvnw clean package æ¯æ¬¡ä»£ç å˜åŒ–ï¼Œéƒ½è¦é‡æ–°ä¸‹è½½ä¾èµ–ã€‚\nå¥½çš„åšæ³•ï¼šåˆ†ç¦»ä¾èµ–å’Œä»£ç \n1FROM openjdk:11-jre-slim 2 3# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ 4COPY pom.xml /app/ 5COPY mvnw /app/ 6COPY .mvn /app/.mvn 7WORKDIR /app 8RUN ./mvnw dependency:go-offline 9 10# å†å¤åˆ¶ä»£ç  11COPY src /app/src 12RUN ./mvnw clean package -DskipTests 13 14ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app/target/app.jar\u0026#34;] è¿™æ ·ï¼Œåªæœ‰ pom.xml å˜åŒ–æ—¶æ‰ä¼šé‡æ–°ä¸‹è½½ä¾èµ–ã€‚\n3. å¤šé˜¶æ®µæ„å»º é—®é¢˜ï¼š æ„å»ºå·¥å…·ï¼ˆMavenã€Gradleï¼‰ä¼šå¢åŠ é•œåƒä½“ç§¯ã€‚\nè§£å†³æ–¹æ¡ˆï¼š ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œåªä¿ç•™è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶ã€‚\n1# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º 2FROM maven:3.8-openjdk-11 AS builder 3WORKDIR /app 4COPY pom.xml . 5RUN mvn dependency:go-offline 6COPY src ./src 7RUN mvn clean package -DskipTests 8 9# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ 10FROM openjdk:11-jre-slim 11WORKDIR /app 12COPY --from=builder /app/target/app.jar . 13EXPOSE 8080 14ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;app.jar\u0026#34;] æ•ˆæœï¼š\næ„å»ºé˜¶æ®µé•œåƒï¼š800MB æœ€ç»ˆé•œåƒï¼š200MB 4. å‡å°‘é•œåƒå±‚æ•° ä¸å¥½çš„åšæ³•\n1RUN apt-get update 2RUN apt-get install -y curl 3RUN apt-get install -y vim 4RUN apt-get clean æ¯ä¸ª RUN éƒ½ä¼šåˆ›å»ºä¸€å±‚ï¼Œå¢åŠ é•œåƒä½“ç§¯ã€‚\nå¥½çš„åšæ³•ï¼šåˆå¹¶å‘½ä»¤\n1RUN apt-get update \u0026amp;\u0026amp; \\ 2 apt-get install -y curl vim \u0026amp;\u0026amp; \\ 3 apt-get clean \u0026amp;\u0026amp; \\ 4 rm -rf /var/lib/apt/lists/* 5. ä½¿ç”¨ .dockerignore ç±»ä¼¼ .gitignoreï¼Œé¿å…å°†ä¸å¿…è¦çš„æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­ã€‚\n1# .dockerignore 2target/ 3*.log 4.git/ 5.idea/ 6*.md 6. ä¸è¦åœ¨å®¹å™¨ä¸­å­˜å‚¨æ•°æ® å®¹å™¨æ˜¯ä¸´æ—¶çš„ï¼Œæ•°æ®åº”è¯¥å­˜å‚¨åœ¨å¤–éƒ¨ã€‚\nä½¿ç”¨ Volume æŒ‚è½½æ•°æ®\n1docker run -d -v /data/mysql:/var/lib/mysql mysql:8.0 ä½¿ç”¨å‘½åå·\n1docker volume create mysql-data 2docker run -d -v mysql-data:/var/lib/mysql mysql:8.0 7. å¥åº·æ£€æŸ¥ 1FROM openjdk:11-jre-slim 2COPY app.jar /app.jar 3 4HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \\ 5 CMD curl -f http://localhost:8080/actuator/health || exit 1 6 7ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] Docker ä¼šå®šæœŸæ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€ï¼Œä¸å¥åº·çš„å®¹å™¨ä¼šè¢«é‡å¯ã€‚\n8. ä½¿ç”¨é root ç”¨æˆ· å®‰å…¨é£é™©ï¼š é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨å†…çš„è¿›ç¨‹ä»¥ root ç”¨æˆ·è¿è¡Œã€‚\nè§£å†³æ–¹æ¡ˆï¼š åˆ›å»ºæ™®é€šç”¨æˆ·\n1FROM openjdk:11-jre-slim 2 3# åˆ›å»ºç”¨æˆ· 4RUN groupadd -r appuser \u0026amp;\u0026amp; useradd -r -g appuser appuser 5 6# å¤åˆ¶æ–‡ä»¶ 7COPY app.jar /app.jar 8RUN chown appuser:appuser /app.jar 9 10# åˆ‡æ¢ç”¨æˆ· 11USER appuser 12 13ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] ä¼˜åŒ– Spring Boot åº”ç”¨çš„ Dockerfile å®Œæ•´ç¤ºä¾‹\n1# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º 2FROM maven:3.8-openjdk-11-slim AS builder 3WORKDIR /build 4 5# å¤åˆ¶ä¾èµ–æ–‡ä»¶ 6COPY pom.xml . 7COPY .mvn .mvn 8COPY mvnw . 9RUN ./mvnw dependency:go-offline -B 10 11# å¤åˆ¶æºç å¹¶æ„å»º 12COPY src src 13RUN ./mvnw package -DskipTests -B 14 15# è§£å‹ jar åŒ…ï¼ˆåˆ©ç”¨ Spring Boot çš„åˆ†å±‚ç‰¹æ€§ï¼‰ 16RUN mkdir -p target/dependency \u0026amp;\u0026amp; \\ 17 cd target/dependency \u0026amp;\u0026amp; \\ 18 jar -xf ../*.jar 19 20# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ 21FROM openjdk:11-jre-slim 22WORKDIR /app 23 24# åˆ›å»ºé root ç”¨æˆ· 25RUN groupadd -r spring \u0026amp;\u0026amp; useradd -r -g spring spring 26 27# åˆ†å±‚å¤åˆ¶ï¼ˆåˆ©ç”¨ Docker ç¼“å­˜ï¼‰ 28COPY --from=builder /build/target/dependency/BOOT-INF/lib /app/lib 29COPY --from=builder /build/target/dependency/META-INF /app/META-INF 30COPY --from=builder /build/target/dependency/BOOT-INF/classes /app 31 32# ä¿®æ”¹æ‰€æœ‰è€… 33RUN chown -R spring:spring /app 34 35# åˆ‡æ¢ç”¨æˆ· 36USER spring 37 38# å¥åº·æ£€æŸ¥ 39HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \\ 40 CMD curl -f http://localhost:8080/actuator/health || exit 1 41 42# å¯åŠ¨åº”ç”¨ 43ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-cp\u0026#34;, \u0026#34;/app:/app/lib/*\u0026#34;, \u0026#34;com.example.Application\u0026#34;] ä¼˜åŒ–æ•ˆæœï¼š\nåˆ©ç”¨åˆ†å±‚ç¼“å­˜ï¼Œä¾èµ–å˜åŒ–æ—¶ä¸éœ€è¦é‡æ–°æ„å»ºæ•´ä¸ªåº”ç”¨ ä½¿ç”¨é root ç”¨æˆ·ï¼Œæå‡å®‰å…¨æ€§ æ·»åŠ å¥åº·æ£€æŸ¥ï¼Œæå‡å¯é æ€§ Docker Composeï¼šç¼–æ’å¤šæœåŠ¡ åœºæ™¯ï¼š åº”ç”¨éœ€è¦ MySQLã€Redisã€Nginx\ndocker-compose.yml\n1version: \u0026#39;3.8\u0026#39; 2 3services: 4 # MySQL æ•°æ®åº“ 5 mysql: 6 image: mysql:8.0 7 container_name: mysql 8 environment: 9 MYSQL_ROOT_PASSWORD: root123 10 MYSQL_DATABASE: myapp 11 volumes: 12 - mysql-data:/var/lib/mysql 13 ports: 14 - \u0026#34;3306:3306\u0026#34; 15 networks: 16 - app-network 17 healthcheck: 18 test: [\u0026#34;CMD\u0026#34;, \u0026#34;mysqladmin\u0026#34;, \u0026#34;ping\u0026#34;, \u0026#34;-h\u0026#34;, \u0026#34;localhost\u0026#34;] 19 interval: 10s 20 timeout: 5s 21 retries: 5 22 23 # Redis ç¼“å­˜ 24 redis: 25 image: redis:7-alpine 26 container_name: redis 27 ports: 28 - \u0026#34;6379:6379\u0026#34; 29 networks: 30 - app-network 31 healthcheck: 32 test: [\u0026#34;CMD\u0026#34;, \u0026#34;redis-cli\u0026#34;, \u0026#34;ping\u0026#34;] 33 interval: 10s 34 timeout: 3s 35 retries: 5 36 37 # Spring Boot åº”ç”¨ 38 app: 39 build: 40 context: . 41 dockerfile: Dockerfile 42 container_name: myapp 43 environment: 44 SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/myapp 45 SPRING_REDIS_HOST: redis 46 ports: 47 - \u0026#34;8080:8080\u0026#34; 48 depends_on: 49 mysql: 50 condition: service_healthy 51 redis: 52 condition: service_healthy 53 networks: 54 - app-network 55 restart: unless-stopped 56 57 # Nginx åå‘ä»£ç† 58 nginx: 59 image: nginx:alpine 60 container_name: nginx 61 volumes: 62 - ./nginx.conf:/etc/nginx/nginx.conf:ro 63 ports: 64 - \u0026#34;80:80\u0026#34; 65 depends_on: 66 - app 67 networks: 68 - app-network 69 70volumes: 71 mysql-data: 72 73networks: 74 app-network: 75 driver: bridge å¯åŠ¨æ‰€æœ‰æœåŠ¡\n1docker-compose up -d æŸ¥çœ‹æ—¥å¿—\n1docker-compose logs -f app åœæ­¢æ‰€æœ‰æœåŠ¡\n1docker-compose down ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² 1. ä½¿ç”¨ç¯å¢ƒå˜é‡ ä¸è¦åœ¨é•œåƒä¸­ç¡¬ç¼–ç é…ç½®\n1# ä¸å¥½ 2ENV SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/myapp ä½¿ç”¨ç¯å¢ƒå˜é‡\n1docker run -d \\ 2 -e SPRING_DATASOURCE_URL=jdbc:mysql://prod-mysql:3306/myapp \\ 3 -e SPRING_DATASOURCE_PASSWORD=prod_password \\ 4 myapp:1.0 2. èµ„æºé™åˆ¶ 1docker run -d \\ 2 --memory=\u0026#34;512m\u0026#34; \\ 3 --cpus=\u0026#34;1.0\u0026#34; \\ 4 myapp:1.0 3. æ—¥å¿—ç®¡ç† ä½¿ç”¨æ—¥å¿—é©±åŠ¨\n1docker run -d \\ 2 --log-driver=json-file \\ 3 --log-opt max-size=10m \\ 4 --log-opt max-file=3 \\ 5 myapp:1.0 4. è‡ªåŠ¨é‡å¯ 1docker run -d --restart=unless-stopped myapp:1.0 é‡å¯ç­–ç•¥ï¼š\nnoï¼šä¸è‡ªåŠ¨é‡å¯ï¼ˆé»˜è®¤ï¼‰ on-failureï¼šå¤±è´¥æ—¶é‡å¯ alwaysï¼šæ€»æ˜¯é‡å¯ unless-stoppedï¼šé™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™æ€»æ˜¯é‡å¯ CI/CD é›†æˆ GitLab CI ç¤ºä¾‹\n1# .gitlab-ci.yml 2stages: 3 - build 4 - deploy 5 6build: 7 stage: build 8 script: 9 - docker build -t myapp:$CI_COMMIT_SHA . 10 - docker tag myapp:$CI_COMMIT_SHA myapp:latest 11 - docker push myapp:$CI_COMMIT_SHA 12 - docker push myapp:latest 13 14deploy: 15 stage: deploy 16 script: 17 - docker pull myapp:$CI_COMMIT_SHA 18 - docker stop myapp || true 19 - docker rm myapp || true 20 - docker run -d --name myapp -p 8080:8080 myapp:$CI_COMMIT_SHA 21 only: 22 - main å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ 1. å®¹å™¨æ—¶åŒºé—®é¢˜ 1FROM openjdk:11-jre-slim 2ENV TZ=Asia/Shanghai 3RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \u0026amp;\u0026amp; echo $TZ \u0026gt; /etc/timezone 2. å®¹å™¨å†…æ— æ³•è®¿é—®å®¿ä¸»æœºæœåŠ¡ ä½¿ç”¨ host.docker.internalï¼ˆMac/Windowsï¼‰æˆ– 172.17.0.1ï¼ˆLinuxï¼‰\n1environment: 2 SPRING_DATASOURCE_URL: jdbc:mysql://host.docker.internal:3306/myapp 3. é•œåƒæ„å»ºæ…¢ ä½¿ç”¨å›½å†…é•œåƒæº åˆ©ç”¨æ„å»ºç¼“å­˜ ä½¿ç”¨å¤šé˜¶æ®µæ„å»º 4. å®¹å™¨å†…å­˜æº¢å‡º è®¾ç½® JVM å‚æ•°ï¼š\n1ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-Xmx512m\u0026#34;, \u0026#34;-Xms512m\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] æ€»ç»“ä¸æ€è€ƒ Docker å®¹å™¨åŒ–çš„æ ¸å¿ƒè¦ç‚¹ï¼š\né€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒï¼Œå‡å°‘é•œåƒä½“ç§¯ åˆ©ç”¨æ„å»ºç¼“å­˜å’Œå¤šé˜¶æ®µæ„å»ºï¼Œæå‡æ„å»ºé€Ÿåº¦ ä½¿ç”¨é root ç”¨æˆ·ï¼Œæå‡å®‰å…¨æ€§ ä½¿ç”¨ Docker Compose ç¼–æ’å¤šæœåŠ¡ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾ç½®èµ„æºé™åˆ¶å’Œå¥åº·æ£€æŸ¥ å®¹å™¨åŒ–ä¸ä»…ä»…æ˜¯æŠ€æœ¯ï¼Œæ›´æ˜¯ä¸€ç§æ€ç»´æ–¹å¼ã€‚å®ƒè®©æˆ‘ä»¬é‡æ–°æ€è€ƒåº”ç”¨çš„éƒ¨ç½²å’Œè¿ç»´æ–¹å¼ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦éƒ¨ç½²åº”ç”¨æ—¶ï¼Œä¸å¦¨è¯•è¯• Dockerï¼Œä½“éªŒå®¹å™¨åŒ–å¸¦æ¥çš„ä¾¿åˆ©ã€‚\n","permalink":"http://localhost:1313/posts/2024/09/docker-%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%BB%8E-dockerfile-%E5%88%B0%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83/","summary":"\u003cp\u003eå®¹å™¨åŒ–å·²ç»æˆä¸ºç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†æ–¹å¼ã€‚Docker è®©åº”ç”¨éƒ¨ç½²å˜å¾—ç®€å•ã€å¯é ã€å¯ç§»æ¤ã€‚æœ¬æ–‡è®²è§£ Docker åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Dockerfile çš„ç¼–å†™æŠ€å·§ä¸ä¼˜åŒ–æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Docker é•œåƒçš„åˆ†å±‚æ„å»ºåŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒä½“ç§¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ Docker Compose ç¼–æ’å¤šæœåŠ¡ç¯å¢ƒ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–\"\u003eä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿéƒ¨ç½²çš„ç—›ç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eç¯å¢ƒä¸ä¸€è‡´ï¼š\u0026ldquo;åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘\u0026rdquo;\u003c/li\u003e\n\u003cli\u003eä¾èµ–ç®¡ç†å¤æ‚ï¼šJDKã€Tomcatã€MySQL ç‰ˆæœ¬ä¸ä¸€è‡´\u003c/li\u003e\n\u003cli\u003eéƒ¨ç½²æµç¨‹ç¹çï¼šæ‰‹åŠ¨ä¸Šä¼ ã€è§£å‹ã€é…ç½®ã€å¯åŠ¨\u003c/li\u003e\n\u003cli\u003eèµ„æºåˆ©ç”¨ç‡ä½ï¼šä¸€å°æœåŠ¡å™¨åªè·‘ä¸€ä¸ªåº”ç”¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eå®¹å™¨åŒ–çš„ä¼˜åŠ¿\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´\u003c/li\u003e\n\u003cli\u003eå¿«é€Ÿéƒ¨ç½²ï¼šç§’çº§å¯åŠ¨ï¼Œä¸€é”®éƒ¨ç½²\u003c/li\u003e\n\u003cli\u003eèµ„æºéš”ç¦»ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“\u003c/li\u003e\n\u003cli\u003eæ˜“äºæ‰©å±•ï¼šæ°´å¹³æ‰©å±•åªéœ€å¯åŠ¨æ›´å¤šå®¹å™¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"dockerfile-åŸºç¡€\"\u003eDockerfile åŸºç¡€\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eæœ€ç®€å•çš„ Dockerfile\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dockerfile\" data-lang=\"dockerfile\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eopenjdk:11-jre-slim\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCOPY\u003c/span\u003e app.jar /app.jar\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eENTRYPOINT\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;java\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;-jar\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/app.jar\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ„å»ºé•œåƒ\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003edocker build -t myapp:1.0 .\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eè¿è¡Œå®¹å™¨\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003edocker run -d -p 8080:8080 myapp:1.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"dockerfile-æœ€ä½³å®è·µ\"\u003eDockerfile æœ€ä½³å®è·µ\u003c/h2\u003e\n\u003ch3 id=\"1-é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ\"\u003e1. é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¸å¥½çš„åšæ³•\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dockerfile\" data-lang=\"dockerfile\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eubuntu:20.04\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eRUN\u003c/span\u003e apt-get update \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e apt-get install -y openjdk-11-jdk\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé•œåƒå¤§å°ï¼š600MB+\u003c/p\u003e","title":"Docker å®¹å™¨åŒ–éƒ¨ç½²æœ€ä½³å®è·µï¼šä» Dockerfile åˆ°ç”Ÿäº§ç¯å¢ƒ"},{"content":"åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å®ä¾‹å¯èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œéœ€è¦åˆ†å¸ƒå¼é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚Redis æ˜¯å®ç°åˆ†å¸ƒå¼é”çš„å¸¸ç”¨æ–¹æ¡ˆï¼Œä½†å¾ˆå¤šäººåªä¼šç”¨ SETNXï¼Œä¸çŸ¥é“å…¶ä¸­çš„å‘ã€‚æœ¬æ–‡æ·±å…¥å‰–æ Redis åˆ†å¸ƒå¼é”çš„å®ç°ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Redis åˆ†å¸ƒå¼é”çš„å®ç°åŸç†ä¸å¸¸è§é—®é¢˜ æŒæ¡ Redisson çœ‹é—¨ç‹—æœºåˆ¶çš„è®¾è®¡æ€æƒ³ å­¦ä¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„é”ä¼˜åŒ–æ–¹æ¡ˆ äº†è§£åˆ†å¸ƒå¼é”çš„æœ€ä½³å®è·µ ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ åœºæ™¯ä¸€ï¼šåº“å­˜æ‰£å‡\n1// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰åŠ é” 2public void deductStock(Long productId, int quantity) { 3 Stock stock = stockMapper.selectById(productId); 4 if (stock.getQuantity() \u0026gt;= quantity) { 5 stock.setQuantity(stock.getQuantity() - quantity); 6 stockMapper.updateById(stock); 7 } 8} åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–åº“å­˜ï¼Œå¯èƒ½å¯¼è‡´è¶…å–ã€‚\nåœºæ™¯äºŒï¼šå®šæ—¶ä»»åŠ¡å»é‡\nå¤šä¸ªæœåŠ¡å®ä¾‹éƒ¨ç½²æ—¶ï¼Œå®šæ—¶ä»»åŠ¡ä¼šé‡å¤æ‰§è¡Œï¼Œéœ€è¦åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œã€‚\nåŸºç¡€å®ç°ï¼šSETNX + EXPIRE ç‰ˆæœ¬ä¸€ï¼šæœ€ç®€å•çš„å®ç°\n1public boolean tryLock(String key) { 2 return redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;); 3} 4 5public void unlock(String key) { 6 redisTemplate.delete(key); 7} é—®é¢˜ï¼šå¦‚æœè·å–é”åï¼ŒæœåŠ¡å®•æœºï¼Œé”æ°¸è¿œä¸ä¼šé‡Šæ”¾ï¼Œå¯¼è‡´æ­»é”ã€‚\nç‰ˆæœ¬äºŒï¼šåŠ ä¸Šè¿‡æœŸæ—¶é—´\n1public boolean tryLock(String key, long expireTime) { 2 Boolean result = redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;); 3 if (result) { 4 redisTemplate.expire(key, expireTime, TimeUnit.SECONDS); 5 } 6 return result; 7} é—®é¢˜ï¼šSETNX å’Œ EXPIRE ä¸æ˜¯åŸå­æ“ä½œï¼Œå¦‚æœåœ¨ä¸¤è€…ä¹‹é—´å®•æœºï¼Œä»ç„¶ä¼šæ­»é”ã€‚\nç‰ˆæœ¬ä¸‰ï¼šåŸå­æ“ä½œ\n1public boolean tryLock(String key, long expireTime) { 2 return redisTemplate.opsForValue() 3 .setIfAbsent(key, \u0026#34;1\u0026#34;, expireTime, TimeUnit.SECONDS); 4} Redis 2.6.12 ä¹‹åï¼ŒSET å‘½ä»¤æ”¯æŒ NX å’Œ EX å‚æ•°ï¼Œä¿è¯åŸå­æ€§ã€‚\n1SET lock_key unique_value NX EX 30 NXï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶è®¾ç½® EXï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ è¿›é˜¶é—®é¢˜ï¼šé”è¯¯åˆ  é—®é¢˜åœºæ™¯\n11. çº¿ç¨‹ A è·å–é”ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ 30 ç§’ 22. çº¿ç¨‹ A æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œè€—æ—¶ 35 ç§’ 33. 30 ç§’åï¼Œé”è‡ªåŠ¨è¿‡æœŸï¼Œçº¿ç¨‹ B è·å–é” 44. çº¿ç¨‹ A æ‰§è¡Œå®Œæ¯•ï¼Œåˆ é™¤é”ï¼ˆè¯¯åˆ äº†çº¿ç¨‹ B çš„é”ï¼‰ è§£å†³æ–¹æ¡ˆï¼šé”çš„å”¯ä¸€æ ‡è¯†\n1public boolean tryLock(String key, String requestId, long expireTime) { 2 return redisTemplate.opsForValue() 3 .setIfAbsent(key, requestId, expireTime, TimeUnit.SECONDS); 4} 5 6public void unlock(String key, String requestId) { 7 String value = redisTemplate.opsForValue().get(key); 8 if (requestId.equals(value)) { 9 redisTemplate.delete(key); 10 } 11} æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å”¯ä¸€çš„ requestIdï¼ˆå¦‚ UUIDï¼‰ï¼Œé‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„é”ã€‚\nä½†è¿™é‡Œä»æœ‰é—®é¢˜ï¼šGET å’Œ DELETE ä¸æ˜¯åŸå­æ“ä½œã€‚\nLua è„šæœ¬ä¿è¯åŸå­æ€§\n1public void unlock(String key, String requestId) { 2 String script = 3 \u0026#34;if redis.call(\u0026#39;get\u0026#39;, KEYS[1]) == ARGV[1] then \u0026#34; + 4 \u0026#34; return redis.call(\u0026#39;del\u0026#39;, KEYS[1]) \u0026#34; + 5 \u0026#34;else \u0026#34; + 6 \u0026#34; return 0 \u0026#34; + 7 \u0026#34;end\u0026#34;; 8 9 redisTemplate.execute( 10 new DefaultRedisScript\u0026lt;\u0026gt;(script, Long.class), 11 Collections.singletonList(key), 12 requestId 13 ); 14} Lua è„šæœ¬åœ¨ Redis ä¸­æ˜¯åŸå­æ‰§è¡Œçš„ï¼Œä¿è¯äº†åˆ¤æ–­å’Œåˆ é™¤çš„åŸå­æ€§ã€‚\næ¶æ„æ€è€ƒï¼š åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒé—®é¢˜æ˜¯\u0026quot;åŸå­æ€§\u0026quot;ã€‚SETNX + EXPIRE ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦ç”¨ SET NX EXï¼›GET + DELETE ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦ç”¨ Lua è„šæœ¬ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šåœºæ™¯éƒ½é€‚ç”¨ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚\nRedissonï¼šç”Ÿäº§çº§çš„åˆ†å¸ƒå¼é” Redisson æ˜¯ Redis å®˜æ–¹æ¨èçš„ Java å®¢æˆ·ç«¯ï¼Œæä¾›äº†å¼€ç®±å³ç”¨çš„åˆ†å¸ƒå¼é”ã€‚\nåŸºæœ¬ä½¿ç”¨\n1@Autowired 2private RedissonClient redissonClient; 3 4public void doSomething() { 5 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 6 try { 7 // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾… 10 ç§’ï¼Œé”è‡ªåŠ¨è¿‡æœŸæ—¶é—´ 30 ç§’ 8 boolean isLocked = lock.tryLock(10, 30, TimeUnit.SECONDS); 9 if (isLocked) { 10 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 11 } 12 } catch (InterruptedException e) { 13 Thread.currentThread().interrupt(); 14 } finally { 15 lock.unlock(); 16 } 17} çœ‹é—¨ç‹—æœºåˆ¶ï¼ˆWatchdogï¼‰\nå¦‚æœä¸æŒ‡å®šé”çš„è¿‡æœŸæ—¶é—´ï¼ŒRedisson ä¼šå¯åŠ¨çœ‹é—¨ç‹—æœºåˆ¶ï¼š\n1lock.lock(); // é»˜è®¤è¿‡æœŸæ—¶é—´ 30 ç§’ çœ‹é—¨ç‹—ä¼šæ¯éš” 10 ç§’ï¼ˆè¿‡æœŸæ—¶é—´çš„ 1/3ï¼‰æ£€æŸ¥é”æ˜¯å¦è¿˜è¢«æŒæœ‰ï¼Œå¦‚æœæ˜¯ï¼Œè‡ªåŠ¨ç»­æœŸ 30 ç§’ã€‚\nçœ‹é—¨ç‹—çš„å®ç°åŸç†\n1private void scheduleExpirationRenewal(long threadId) { 2 ExpirationEntry entry = new ExpirationEntry(); 3 ExpirationEntry oldEntry = EXPIRATION_RENEWAL_MAP.putIfAbsent(getEntryName(), entry); 4 5 if (oldEntry != null) { 6 oldEntry.addThreadId(threadId); 7 } else { 8 entry.addThreadId(threadId); 9 renewExpiration(); 10 } 11} 12 13private void renewExpiration() { 14 ExpirationEntry ee = EXPIRATION_RENEWAL_MAP.get(getEntryName()); 15 if (ee == null) { 16 return; 17 } 18 19 Timeout task = commandExecutor.getConnectionManager().newTimeout(timeout -\u0026gt; { 20 // ç»­æœŸé” 21 RFuture\u0026lt;Boolean\u0026gt; future = renewExpirationAsync(threadId); 22 future.onComplete((res, e) -\u0026gt; { 23 if (e != null) { 24 return; 25 } 26 if (res) { 27 // ç»­æœŸæˆåŠŸï¼Œç»§ç»­è°ƒåº¦ä¸‹ä¸€æ¬¡ç»­æœŸ 28 renewExpiration(); 29 } 30 }); 31 }, internalLockLeaseTime / 3, TimeUnit.MILLISECONDS); 32 33 ee.setTimeout(task); 34} çœ‹é—¨ç‹—çš„å¥½å¤„ï¼š\né¿å…ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”è¿‡æœŸ é¿å…æ‰‹åŠ¨è®¾ç½®è¿‡æœŸæ—¶é—´ä¸å‡†ç¡® é¿å‘æç¤ºï¼š çœ‹é—¨ç‹—åªåœ¨æœªæŒ‡å®šè¿‡æœŸæ—¶é—´æ—¶ç”Ÿæ•ˆã€‚å¦‚æœä½ è°ƒç”¨ lock.tryLock(10, 30, TimeUnit.SECONDS)ï¼Œçœ‹é—¨ç‹—ä¸ä¼šå¯åŠ¨ï¼Œé”ä¼šåœ¨ 30 ç§’åè‡ªåŠ¨è¿‡æœŸã€‚\nå¯é‡å…¥é” Redisson çš„é”æ˜¯å¯é‡å…¥çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”ã€‚\n1public void methodA() { 2 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 3 lock.lock(); 4 try { 5 methodB(); // å¯ä»¥å†æ¬¡è·å–é” 6 } finally { 7 lock.unlock(); 8 } 9} 10 11public void methodB() { 12 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 13 lock.lock(); 14 try { 15 // ä¸šåŠ¡é€»è¾‘ 16 } finally { 17 lock.unlock(); 18 } 19} å®ç°åŸç†ï¼šHash ç»“æ„\n1HSET myLock thread-1 1 # ç¬¬ä¸€æ¬¡åŠ é” 2HINCRBY myLock thread-1 1 # ç¬¬äºŒæ¬¡åŠ é”ï¼Œè®¡æ•°å™¨ +1 é‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°å™¨ -1ï¼Œåªæœ‰è®¡æ•°å™¨ä¸º 0 æ—¶æ‰çœŸæ­£é‡Šæ”¾é”ã€‚\né«˜å¹¶å‘ä¼˜åŒ–ï¼šåˆ†æ®µé” åœ¨ç§’æ€åœºæ™¯ä¸‹ï¼Œæ‰€æœ‰è¯·æ±‚ç«äº‰åŒä¸€æŠŠé”ï¼Œæ€§èƒ½å¾ˆå·®ã€‚å¯ä»¥ä½¿ç”¨åˆ†æ®µé”ä¼˜åŒ–ã€‚\nåœºæ™¯ï¼šåº“å­˜æ‰£å‡\n1public void deductStock(Long productId, int quantity) { 2 // æ ¹æ®å•†å“ ID åˆ†æ®µ 3 int segment = (int) (productId % 10); 4 String lockKey = \u0026#34;stock_lock:\u0026#34; + productId + \u0026#34;:\u0026#34; + segment; 5 6 RLock lock = redissonClient.getLock(lockKey); 7 lock.lock(); 8 try { 9 // æ‰£å‡åº“å­˜ 10 Stock stock = stockMapper.selectById(productId); 11 if (stock.getQuantity() \u0026gt;= quantity) { 12 stock.setQuantity(stock.getQuantity() - quantity); 13 stockMapper.updateById(stock); 14 } 15 } finally { 16 lock.unlock(); 17 } 18} å°†åº“å­˜åˆ†æˆ 10 æ®µï¼Œæ¯æ®µç‹¬ç«‹åŠ é”ï¼Œæå‡å¹¶å‘åº¦ã€‚\nè¯»å†™é”\nå¦‚æœè¯»å¤šå†™å°‘ï¼Œå¯ä»¥ä½¿ç”¨è¯»å†™é”ï¼š\n1RReadWriteLock rwLock = redissonClient.getReadWriteLock(\u0026#34;myLock\u0026#34;); 2 3// è¯»é”ï¼ˆå…±äº«é”ï¼‰ 4RLock readLock = rwLock.readLock(); 5readLock.lock(); 6try { 7 // è¯»æ“ä½œ 8} finally { 9 readLock.unlock(); 10} 11 12// å†™é”ï¼ˆæ’ä»–é”ï¼‰ 13RLock writeLock = rwLock.writeLock(); 14writeLock.lock(); 15try { 16 // å†™æ“ä½œ 17} finally { 18 writeLock.unlock(); 19} å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰è¯»é”ï¼Œä½†å†™é”æ˜¯æ’ä»–çš„ã€‚\nçº¢é”ï¼ˆRedLockï¼‰ï¼šå¤šèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é” å•èŠ‚ç‚¹ Redis å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ï¼ŒRedLock é€šè¿‡å¤šä¸ªç‹¬ç«‹çš„ Redis èŠ‚ç‚¹å®ç°é«˜å¯ç”¨ã€‚\nRedLock ç®—æ³•\nè·å–å½“å‰æ—¶é—´æˆ³ ä¾æ¬¡å‘ N ä¸ª Redis èŠ‚ç‚¹è¯·æ±‚åŠ é” å¦‚æœè¶…è¿‡åŠæ•°èŠ‚ç‚¹åŠ é”æˆåŠŸï¼Œä¸”æ€»è€—æ—¶å°äºé”çš„è¿‡æœŸæ—¶é—´ï¼Œåˆ™è®¤ä¸ºåŠ é”æˆåŠŸ å¦‚æœåŠ é”å¤±è´¥ï¼Œå‘æ‰€æœ‰èŠ‚ç‚¹é‡Šæ”¾é” Redisson å®ç°\n1RLock lock1 = redissonClient1.getLock(\u0026#34;myLock\u0026#34;); 2RLock lock2 = redissonClient2.getLock(\u0026#34;myLock\u0026#34;); 3RLock lock3 = redissonClient3.getLock(\u0026#34;myLock\u0026#34;); 4 5RedissonRedLock redLock = new RedissonRedLock(lock1, lock2, lock3); 6redLock.lock(); 7try { 8 // ä¸šåŠ¡é€»è¾‘ 9} finally { 10 redLock.unlock(); 11} RedLock çš„äº‰è®®ï¼š\nMartin Kleppmann è®¤ä¸º RedLock ä¸å®‰å…¨ï¼ˆæ—¶é’Ÿæ¼‚ç§»é—®é¢˜ï¼‰ Redis ä½œè€… Antirez è®¤ä¸º RedLock åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹å¤Ÿç”¨ å®é™…ç”Ÿäº§ä¸­ï¼Œå•èŠ‚ç‚¹ + ä¸»ä»å¤åˆ¶ + å“¨å…µæ¨¡å¼å·²ç»è¶³å¤Ÿã€‚\næœ€ä½³å®è·µ 1. è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´\nè¿‡æœŸæ—¶é—´å¤ªçŸ­ï¼Œä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œé”å°±è¿‡æœŸäº†ï¼›è¿‡æœŸæ—¶é—´å¤ªé•¿ï¼Œå®•æœºåé”é•¿æ—¶é—´ä¸é‡Šæ”¾ã€‚\nå»ºè®®ï¼šæ ¹æ®ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è®¾ç½®ï¼Œæˆ–ä½¿ç”¨ Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶ã€‚\n2. ä½¿ç”¨ try-finally é‡Šæ”¾é”\n1lock.lock(); 2try { 3 // ä¸šåŠ¡é€»è¾‘ 4} finally { 5 lock.unlock(); 6} 3. é¿å…é•¿æ—¶é—´æŒæœ‰é”\né”çš„ç²’åº¦è¦å°½é‡å°ï¼Œåªé”å¿…è¦çš„ä»£ç å—ã€‚\n1// ä¸å¥½ï¼šé”çš„ç²’åº¦å¤ªå¤§ 2lock.lock(); 3try { 4 queryDatabase(); // è€—æ—¶æ“ä½œ 5 updateCache(); 6 sendMessage(); 7} finally { 8 lock.unlock(); 9} 10 11// å¥½ï¼šåªé”å¿…è¦çš„ä»£ç  12queryDatabase(); 13lock.lock(); 14try { 15 updateCache(); 16} finally { 17 lock.unlock(); 18} 19sendMessage(); 4. é”é™çº§\nå¦‚æœ Redis ä¸å¯ç”¨ï¼Œå¯ä»¥é™çº§ä¸ºæœ¬åœ°é”æˆ–ç›´æ¥æ”¾è¡Œã€‚\n1RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 2try { 3 boolean isLocked = lock.tryLock(1, 30, TimeUnit.SECONDS); 4 if (!isLocked) { 5 // é™çº§å¤„ç† 6 log.warn(\u0026#34;è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼Œé™çº§ä¸ºæœ¬åœ°é”\u0026#34;); 7 synchronized (this) { 8 // ä¸šåŠ¡é€»è¾‘ 9 } 10 } 11} catch (Exception e) { 12 log.error(\u0026#34;åˆ†å¸ƒå¼é”å¼‚å¸¸\u0026#34;, e); 13 // é™çº§å¤„ç† 14} æ€»ç»“ä¸æ€è€ƒ Redis åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ SET NX EX ä¿è¯åŠ é”çš„åŸå­æ€§ ä½¿ç”¨ Lua è„šæœ¬ä¿è¯è§£é”çš„åŸå­æ€§ ä½¿ç”¨å”¯ä¸€æ ‡è¯†é¿å…é”è¯¯åˆ  ä½¿ç”¨ Redisson ç®€åŒ–å®ç°ï¼Œåˆ©ç”¨çœ‹é—¨ç‹—æœºåˆ¶è‡ªåŠ¨ç»­æœŸ åˆ†å¸ƒå¼é”ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚åœ¨è®¾è®¡æ—¶è¦æƒè¡¡ï¼š\næ˜¯å¦çœŸçš„éœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿèƒ½å¦é€šè¿‡æ•°æ®åº“çš„ä¹è§‚é”è§£å†³ï¼Ÿ é”çš„ç²’åº¦æ˜¯å¦åˆç†ï¼Ÿèƒ½å¦é€šè¿‡åˆ†æ®µé”æå‡å¹¶å‘åº¦ï¼Ÿ æ˜¯å¦éœ€è¦é«˜å¯ç”¨ï¼Ÿå•èŠ‚ç‚¹æ˜¯å¦å¤Ÿç”¨ï¼Ÿ ä¸‹æ¬¡å½“ä½ éœ€è¦åˆ†å¸ƒå¼é”æ—¶ï¼Œä¸å¦¨å…ˆé—®é—®è‡ªå·±ï¼šè¿™ä¸ªåœºæ™¯çœŸçš„éœ€è¦å¼ºä¸€è‡´æ€§å—ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/08/redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E7%94%9F%E4%BA%A7%E7%BA%A7%E5%AE%9E%E8%B7%B5%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0-redisson/","summary":"\u003cp\u003eåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å®ä¾‹å¯èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œéœ€è¦åˆ†å¸ƒå¼é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚Redis æ˜¯å®ç°åˆ†å¸ƒå¼é”çš„å¸¸ç”¨æ–¹æ¡ˆï¼Œä½†å¾ˆå¤šäººåªä¼šç”¨ SETNXï¼Œä¸çŸ¥é“å…¶ä¸­çš„å‘ã€‚æœ¬æ–‡æ·±å…¥å‰–æ Redis åˆ†å¸ƒå¼é”çš„å®ç°ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Redis åˆ†å¸ƒå¼é”çš„å®ç°åŸç†ä¸å¸¸è§é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Redisson çœ‹é—¨ç‹—æœºåˆ¶çš„è®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„é”ä¼˜åŒ–æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†å¸ƒå¼é”çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”\"\u003eä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šåº“å­˜æ‰£å‡\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰åŠ é”\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003edeductStock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eStock\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estockMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eproductId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003estockMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eupdateById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–åº“å­˜ï¼Œå¯èƒ½å¯¼è‡´è¶…å–ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šå®šæ—¶ä»»åŠ¡å»é‡\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¤šä¸ªæœåŠ¡å®ä¾‹éƒ¨ç½²æ—¶ï¼Œå®šæ—¶ä»»åŠ¡ä¼šé‡å¤æ‰§è¡Œï¼Œéœ€è¦åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"åŸºç¡€å®ç°setnx--expire\"\u003eåŸºç¡€å®ç°ï¼šSETNX + EXPIRE\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eç‰ˆæœ¬ä¸€ï¼šæœ€ç®€å•çš„å®ç°\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003etryLock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003esetIfAbsent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eunlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edelete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼šå¦‚æœè·å–é”åï¼ŒæœåŠ¡å®•æœºï¼Œé”æ°¸è¿œä¸ä¼šé‡Šæ”¾ï¼Œå¯¼è‡´æ­»é”ã€‚\u003c/p\u003e","title":"Redis åˆ†å¸ƒå¼é”çš„ç”Ÿäº§çº§å®è·µï¼šä»åŸç†åˆ° Redisson"},{"content":"Spring Boot çš„æ ¸å¿ƒé­…åŠ›åœ¨äº\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;ï¼Œè€Œ Starter æœºåˆ¶æ˜¯å®ç°è¿™ä¸€ç†å¿µçš„å…³é”®ã€‚æœ¬æ–‡é€šè¿‡å®æˆ˜æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å¼€å‘ä¸€ä¸ªç”Ÿäº§çº§çš„è‡ªå®šä¹‰ Starterã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Spring Boot è‡ªåŠ¨è£…é…çš„åº•å±‚åŸç† æŒæ¡ BeanPostProcessor çš„ä½¿ç”¨åœºæ™¯ å­¦ä¼šè®¾è®¡é›¶ä¾µå…¥å¼çš„åŸºç¡€ç»„ä»¶ äº†è§£ Starter çš„æœ€ä½³å®è·µä¸è§„èŒƒ ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ Starterï¼Ÿ åœºæ™¯ï¼š å…¬å¸æœ‰å¤šä¸ª Spring Boot é¡¹ç›®ï¼Œéƒ½éœ€è¦é›†æˆçº¿ç¨‹æ± ç›‘æ§åŠŸèƒ½ã€‚\nä¼ ç»Ÿåšæ³•ï¼š æ¯ä¸ªé¡¹ç›®éƒ½å¤åˆ¶ä¸€éé…ç½®ä»£ç ã€‚\né—®é¢˜ï¼š\nä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜ é…ç½®ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“å‡ºé”™ å‡çº§å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æ‰€æœ‰é¡¹ç›® Starter çš„ä¼˜åŠ¿ï¼š\nä¸€æ¬¡å¼€å‘ï¼Œå¤šå¤„å¤ç”¨ é›¶ä¾µå…¥ï¼Œå¼•å…¥ä¾èµ–å³å¯ä½¿ç”¨ ç»Ÿä¸€ç®¡ç†ï¼Œå‡çº§æ–¹ä¾¿ æ¡ˆä¾‹ï¼šå¼€å‘çº¿ç¨‹æ± ç›‘æ§ Starter åŠŸèƒ½éœ€æ±‚ï¼š\nè‡ªåŠ¨æ‰«æé¡¹ç›®ä¸­çš„ ThreadPoolExecutor å®šæ—¶ä¸ŠæŠ¥çº¿ç¨‹æ± æŒ‡æ ‡ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰ æä¾›ç®¡ç†åå°æŸ¥çœ‹å’Œè°ƒæ•´çº¿ç¨‹æ± å‚æ•° ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Starter é¡¹ç›® é¡¹ç›®ç»“æ„\n1threadpool-spring-boot-starter 2â”œâ”€â”€ src/main/java 3â”‚ â””â”€â”€ com/example/threadpool 4â”‚ â”œâ”€â”€ autoconfigure 5â”‚ â”‚ â”œâ”€â”€ ThreadPoolAutoConfiguration.java 6â”‚ â”‚ â””â”€â”€ ThreadPoolProperties.java 7â”‚ â”œâ”€â”€ core 8â”‚ â”‚ â”œâ”€â”€ ThreadPoolMonitor.java 9â”‚ â”‚ â””â”€â”€ ThreadPoolRegistry.java 10â”‚ â””â”€â”€ processor 11â”‚ â””â”€â”€ ThreadPoolBeanPostProcessor.java 12â”œâ”€â”€ src/main/resources 13â”‚ â””â”€â”€ META-INF 14â”‚ â””â”€â”€ spring.factories 15â””â”€â”€ pom.xml pom.xml\n1\u0026lt;dependencies\u0026gt; 2 \u0026lt;!-- Spring Boot è‡ªåŠ¨é…ç½® --\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;spring-boot-autoconfigure\u0026lt;/artifactId\u0026gt; 6 \u0026lt;/dependency\u0026gt; 7 8 \u0026lt;!-- é…ç½®æç¤º --\u0026gt; 9 \u0026lt;dependency\u0026gt; 10 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 11 \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; 12 \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; 13 \u0026lt;/dependency\u0026gt; 14\u0026lt;/dependencies\u0026gt; ç¬¬äºŒæ­¥ï¼šå®šä¹‰é…ç½®å±æ€§ 1@ConfigurationProperties(prefix = \u0026#34;threadpool.monitor\u0026#34;) 2public class ThreadPoolProperties { 3 4 /** 5 * æ˜¯å¦å¯ç”¨çº¿ç¨‹æ± ç›‘æ§ 6 */ 7 private boolean enabled = true; 8 9 /** 10 * ä¸ŠæŠ¥é—´éš”ï¼ˆç§’ï¼‰ 11 */ 12 private int reportInterval = 60; 13 14 /** 15 * æ˜¯å¦å¯ç”¨åŠ¨æ€è°ƒæ•´ 16 */ 17 private boolean dynamicAdjust = false; 18 19 // getter/setter 20} é…ç½®æç¤º\nåˆ›å»º src/main/resources/META-INF/spring-configuration-metadata.jsonï¼š\n1{ 2 \u0026#34;properties\u0026#34;: [ 3 { 4 \u0026#34;name\u0026#34;: \u0026#34;threadpool.monitor.enabled\u0026#34;, 5 \u0026#34;type\u0026#34;: \u0026#34;java.lang.Boolean\u0026#34;, 6 \u0026#34;description\u0026#34;: \u0026#34;æ˜¯å¦å¯ç”¨çº¿ç¨‹æ± ç›‘æ§\u0026#34;, 7 \u0026#34;defaultValue\u0026#34;: true 8 }, 9 { 10 \u0026#34;name\u0026#34;: \u0026#34;threadpool.monitor.report-interval\u0026#34;, 11 \u0026#34;type\u0026#34;: \u0026#34;java.lang.Integer\u0026#34;, 12 \u0026#34;description\u0026#34;: \u0026#34;ä¸ŠæŠ¥é—´éš”ï¼ˆç§’ï¼‰\u0026#34;, 13 \u0026#34;defaultValue\u0026#34;: 60 14 } 15 ] 16} è¿™æ ·åœ¨ application.yml ä¸­é…ç½®æ—¶ï¼ŒIDE ä¼šæœ‰æ™ºèƒ½æç¤ºã€‚\nç¬¬ä¸‰æ­¥ï¼šå®ç° BeanPostProcessor æ ¸å¿ƒæ€æƒ³ï¼š åœ¨ Bean åˆå§‹åŒ–åï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ ThreadPoolExecutorï¼Œå¦‚æœæ˜¯ï¼Œæ³¨å†Œåˆ°ç›‘æ§ä¸­å¿ƒã€‚\n1@Component 2public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Override 8 public Object postProcessAfterInitialization(Object bean, String beanName) { 9 if (bean instanceof ThreadPoolExecutor) { 10 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 11 registry.register(beanName, executor); 12 log.info(\u0026#34;æ³¨å†Œçº¿ç¨‹æ± : {}\u0026#34;, beanName); 13 } 14 return bean; 15 } 16} ThreadPoolRegistry\n1@Component 2public class ThreadPoolRegistry { 3 4 private final Map\u0026lt;String, ThreadPoolExecutor\u0026gt; executors = new ConcurrentHashMap\u0026lt;\u0026gt;(); 5 6 public void register(String name, ThreadPoolExecutor executor) { 7 executors.put(name, executor); 8 } 9 10 public Map\u0026lt;String, ThreadPoolExecutor\u0026gt; getAll() { 11 return Collections.unmodifiableMap(executors); 12 } 13 14 public ThreadPoolExecutor get(String name) { 15 return executors.get(name); 16 } 17} ç¬¬å››æ­¥ï¼šå®ç°ç›‘æ§é€»è¾‘ 1@Component 2public class ThreadPoolMonitor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Autowired 8 private ThreadPoolProperties properties; 9 10 @Scheduled(fixedDelayString = \u0026#34;${threadpool.monitor.report-interval:60}000\u0026#34;) 11 public void report() { 12 if (!properties.isEnabled()) { 13 return; 14 } 15 16 registry.getAll().forEach((name, executor) -\u0026gt; { 17 ThreadPoolMetrics metrics = collectMetrics(name, executor); 18 log.info(\u0026#34;çº¿ç¨‹æ± æŒ‡æ ‡: {}\u0026#34;, metrics); 19 20 // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€InfluxDB ç­‰ï¼‰ 21 reportToMonitor(metrics); 22 }); 23 } 24 25 private ThreadPoolMetrics collectMetrics(String name, ThreadPoolExecutor executor) { 26 return ThreadPoolMetrics.builder() 27 .name(name) 28 .corePoolSize(executor.getCorePoolSize()) 29 .maximumPoolSize(executor.getMaximumPoolSize()) 30 .activeCount(executor.getActiveCount()) 31 .poolSize(executor.getPoolSize()) 32 .queueSize(executor.getQueue().size()) 33 .queueRemainingCapacity(executor.getQueue().remainingCapacity()) 34 .completedTaskCount(executor.getCompletedTaskCount()) 35 .taskCount(executor.getTaskCount()) 36 .build(); 37 } 38 39 private void reportToMonitor(ThreadPoolMetrics metrics) { 40 // å®ç°ä¸ŠæŠ¥é€»è¾‘ 41 } 42} ç¬¬äº”æ­¥ï¼šè‡ªåŠ¨é…ç½®ç±» 1@Configuration 2@EnableConfigurationProperties(ThreadPoolProperties.class) 3@ConditionalOnProperty(prefix = \u0026#34;threadpool.monitor\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;, matchIfMissing = true) 4@EnableScheduling 5public class ThreadPoolAutoConfiguration { 6 7 @Bean 8 public ThreadPoolRegistry threadPoolRegistry() { 9 return new ThreadPoolRegistry(); 10 } 11 12 @Bean 13 public ThreadPoolBeanPostProcessor threadPoolBeanPostProcessor() { 14 return new ThreadPoolBeanPostProcessor(); 15 } 16 17 @Bean 18 public ThreadPoolMonitor threadPoolMonitor() { 19 return new ThreadPoolMonitor(); 20 } 21} æ³¨è§£è¯´æ˜ï¼š\n@EnableConfigurationPropertiesï¼šå¯ç”¨é…ç½®å±æ€§ @ConditionalOnPropertyï¼šæ¡ä»¶è£…é…ï¼Œåªæœ‰é…ç½®å¯ç”¨æ—¶æ‰ç”Ÿæ•ˆ @EnableSchedulingï¼šå¯ç”¨å®šæ—¶ä»»åŠ¡ ç¬¬å…­æ­¥ï¼šæ³¨å†Œè‡ªåŠ¨é…ç½® åˆ›å»º src/main/resources/META-INF/spring.factoriesï¼š\n1org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 2com.example.threadpool.autoconfigure.ThreadPoolAutoConfiguration Spring Boot å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½è¿™ä¸ªé…ç½®ç±»ã€‚\nç¬¬ä¸ƒæ­¥ï¼šä½¿ç”¨ Starter 1. å¼•å…¥ä¾èµ–\n1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;threadpool-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; 2. é…ç½®ï¼ˆå¯é€‰ï¼‰\n1threadpool: 2 monitor: 3 enabled: true 4 report-interval: 30 3. å®šä¹‰çº¿ç¨‹æ± \n1@Configuration 2public class ThreadPoolConfig { 3 4 @Bean(\u0026#34;orderThreadPool\u0026#34;) 5 public ThreadPoolExecutor orderThreadPool() { 6 return new ThreadPoolExecutor( 7 10, 20, 60, TimeUnit.SECONDS, 8 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 9 new ThreadFactoryBuilder().setNameFormat(\u0026#34;order-pool-%d\u0026#34;).build(), 10 new ThreadPoolExecutor.CallerRunsPolicy() 11 ); 12 } 13} 4. è‡ªåŠ¨ç›‘æ§\næ— éœ€ä»»ä½•é¢å¤–ä»£ç ï¼ŒStarter ä¼šè‡ªåŠ¨æ‰«æå¹¶ç›‘æ§æ‰€æœ‰ ThreadPoolExecutorã€‚\nè¿›é˜¶ï¼šåŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° æä¾› REST API\n1@RestController 2@RequestMapping(\u0026#34;/threadpool\u0026#34;) 3public class ThreadPoolController { 4 5 @Autowired 6 private ThreadPoolRegistry registry; 7 8 @GetMapping(\u0026#34;/list\u0026#34;) 9 public List\u0026lt;ThreadPoolInfo\u0026gt; list() { 10 return registry.getAll().entrySet().stream() 11 .map(entry -\u0026gt; ThreadPoolInfo.from(entry.getKey(), entry.getValue())) 12 .collect(Collectors.toList()); 13 } 14 15 @PostMapping(\u0026#34;/adjust\u0026#34;) 16 public void adjust(@RequestBody ThreadPoolAdjustRequest request) { 17 ThreadPoolExecutor executor = registry.get(request.getName()); 18 if (executor == null) { 19 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + request.getName()); 20 } 21 22 executor.setCorePoolSize(request.getCorePoolSize()); 23 executor.setMaximumPoolSize(request.getMaximumPoolSize()); 24 25 log.info(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°: {}\u0026#34;, request); 26 } 27} è‡ªåŠ¨è£…é…åŸç† @SpringBootApplication æ³¨è§£\n1@SpringBootConfiguration 2@EnableAutoConfiguration // å…³é”®æ³¨è§£ 3@ComponentScan 4public @interface SpringBootApplication { 5} @EnableAutoConfiguration æ³¨è§£\n1@Import(AutoConfigurationImportSelector.class) 2public @interface EnableAutoConfiguration { 3} AutoConfigurationImportSelector\n1public class AutoConfigurationImportSelector { 2 3 protected List\u0026lt;String\u0026gt; getCandidateConfigurations() { 4 // è¯»å– META-INF/spring.factories 5 return SpringFactoriesLoader.loadFactoryNames( 6 EnableAutoConfiguration.class, 7 getBeanClassLoader() 8 ); 9 } 10} æµç¨‹ï¼š\nSpring Boot å¯åŠ¨æ—¶ï¼Œæ‰«ææ‰€æœ‰ jar åŒ…çš„ META-INF/spring.factories åŠ è½½ EnableAutoConfiguration å¯¹åº”çš„é…ç½®ç±» æ ¹æ® @Conditional æ³¨è§£åˆ¤æ–­æ˜¯å¦ç”Ÿæ•ˆ æ³¨å†Œ Bean åˆ° Spring å®¹å™¨ æ¶æ„æ€è€ƒï¼š Spring Boot çš„è‡ªåŠ¨è£…é…ä½“ç°äº†\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;çš„æ€æƒ³ã€‚é€šè¿‡ SPI æœºåˆ¶ï¼ˆspring.factoriesï¼‰å’Œæ¡ä»¶è£…é…ï¼ˆ@Conditionalï¼‰ï¼Œå®ç°äº†çµæ´»çš„æ¨¡å—åŒ–è®¾è®¡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šæ¡†æ¶ä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ Dubbo çš„ SPIã€Java çš„ ServiceLoaderã€‚\nStarter å¼€å‘è§„èŒƒ 1. å‘½åè§„èŒƒ\nå®˜æ–¹ Starterï¼šspring-boot-starter-{name} ç¬¬ä¸‰æ–¹ Starterï¼š{name}-spring-boot-starter 2. æ¨¡å—æ‹†åˆ†\n1{name}-spring-boot-starter # ä¾èµ–ç®¡ç†ï¼Œä¸åŒ…å«ä»£ç  2â””â”€â”€ {name}-spring-boot-autoconfigure # è‡ªåŠ¨é…ç½®ä»£ç  3. é…ç½®å‰ç¼€\nä½¿ç”¨ç»Ÿä¸€çš„é…ç½®å‰ç¼€ï¼Œé¿å…å†²çªã€‚\n1mycompany: 2 threadpool: 3 enabled: true 4. æ¡ä»¶è£…é…\nä½¿ç”¨ @ConditionalOnClassã€@ConditionalOnProperty ç­‰æ³¨è§£ï¼Œé¿å…å¼ºä¾èµ–ã€‚\n1@ConditionalOnClass(RedisTemplate.class) 2@ConditionalOnProperty(prefix = \u0026#34;redis.cache\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) 5. æä¾›é»˜è®¤é…ç½®\n1@ConfigurationProperties(prefix = \u0026#34;threadpool.monitor\u0026#34;) 2public class ThreadPoolProperties { 3 private boolean enabled = true; // é»˜è®¤å¯ç”¨ 4 private int reportInterval = 60; // é»˜è®¤ 60 ç§’ 5} 6. æ–‡æ¡£å®Œå–„\næä¾› README.mdï¼Œè¯´æ˜ï¼š\nåŠŸèƒ½ä»‹ç» å¿«é€Ÿå¼€å§‹ é…ç½®è¯´æ˜ ç¤ºä¾‹ä»£ç  æ€»ç»“ä¸æ€è€ƒ è‡ªå®šä¹‰ Starter çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼æ‰«æ é€šè¿‡ @ConfigurationProperties æä¾›çµæ´»çš„é…ç½® ä½¿ç”¨ @Conditional æ³¨è§£å®ç°æ¡ä»¶è£…é… åœ¨ spring.factories ä¸­æ³¨å†Œè‡ªåŠ¨é…ç½®ç±» Starter ä¸ä»…ä»…æ˜¯ä»£ç å¤ç”¨ï¼Œæ›´æ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ã€‚å®ƒè®©æˆ‘ä»¬é‡æ–°æ€è€ƒå¦‚ä½•è®¾è®¡å¯å¤ç”¨çš„åŸºç¡€ç»„ä»¶ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åœ¨å¤šä¸ªé¡¹ç›®ä¸­å¤ç”¨åŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯•å¼€å‘ä¸€ä¸ª Starterï¼Œä½“éªŒ\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/08/spring-boot-starter-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%80%E5%8F%91%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eSpring Boot çš„æ ¸å¿ƒé­…åŠ›åœ¨äº\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;ï¼Œè€Œ Starter æœºåˆ¶æ˜¯å®ç°è¿™ä¸€ç†å¿µçš„å…³é”®ã€‚æœ¬æ–‡é€šè¿‡å®æˆ˜æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å¼€å‘ä¸€ä¸ªç”Ÿäº§çº§çš„è‡ªå®šä¹‰ Starterã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Spring Boot è‡ªåŠ¨è£…é…çš„åº•å±‚åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ BeanPostProcessor çš„ä½¿ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡é›¶ä¾µå…¥å¼çš„åŸºç¡€ç»„ä»¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ Starter çš„æœ€ä½³å®è·µä¸è§„èŒƒ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰-starter\"\u003eä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ Starterï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼š\u003c/strong\u003e å…¬å¸æœ‰å¤šä¸ª Spring Boot é¡¹ç›®ï¼Œéƒ½éœ€è¦é›†æˆçº¿ç¨‹æ± ç›‘æ§åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿåšæ³•ï¼š\u003c/strong\u003e æ¯ä¸ªé¡¹ç›®éƒ½å¤åˆ¶ä¸€éé…ç½®ä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé—®é¢˜ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜\u003c/li\u003e\n\u003cli\u003eé…ç½®ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“å‡ºé”™\u003c/li\u003e\n\u003cli\u003eå‡çº§å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æ‰€æœ‰é¡¹ç›®\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eStarter çš„ä¼˜åŠ¿ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eä¸€æ¬¡å¼€å‘ï¼Œå¤šå¤„å¤ç”¨\u003c/li\u003e\n\u003cli\u003eé›¶ä¾µå…¥ï¼Œå¼•å…¥ä¾èµ–å³å¯ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eç»Ÿä¸€ç®¡ç†ï¼Œå‡çº§æ–¹ä¾¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¡ˆä¾‹å¼€å‘çº¿ç¨‹æ± ç›‘æ§-starter\"\u003eæ¡ˆä¾‹ï¼šå¼€å‘çº¿ç¨‹æ± ç›‘æ§ Starter\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåŠŸèƒ½éœ€æ±‚ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eè‡ªåŠ¨æ‰«æé¡¹ç›®ä¸­çš„ ThreadPoolExecutor\u003c/li\u003e\n\u003cli\u003eå®šæ—¶ä¸ŠæŠ¥çº¿ç¨‹æ± æŒ‡æ ‡ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰\u003c/li\u003e\n\u003cli\u003eæä¾›ç®¡ç†åå°æŸ¥çœ‹å’Œè°ƒæ•´çº¿ç¨‹æ± å‚æ•°\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥åˆ›å»º-starter-é¡¹ç›®\"\u003eç¬¬ä¸€æ­¥ï¼šåˆ›å»º Starter é¡¹ç›®\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eé¡¹ç›®ç»“æ„\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003ethreadpool-spring-boot-starter\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ src/main/java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ com/example/threadpool\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”œâ”€â”€ autoconfigure\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â”œâ”€â”€ ThreadPoolAutoConfiguration.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â””â”€â”€ ThreadPoolProperties.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”œâ”€â”€ core\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â”œâ”€â”€ ThreadPoolMonitor.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â””â”€â”€ ThreadPoolRegistry.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â””â”€â”€ processor\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚           â””â”€â”€ ThreadPoolBeanPostProcessor.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ src/main/resources\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ META-INF\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â””â”€â”€ spring.factories\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ pom.xml\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003epom.xml\u003c/strong\u003e\u003c/p\u003e","title":"Spring Boot Starter è‡ªå®šä¹‰å¼€å‘ï¼šä»åŸç†åˆ°å®æˆ˜"},{"content":"åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”Ÿæˆå…¨å±€å”¯ä¸€ ID æ˜¯ä¸€ä¸ªåŸºç¡€éœ€æ±‚ã€‚æ•°æ®åº“è‡ªå¢ ID åœ¨åˆ†åº“åˆ†è¡¨åæ— æ³•ä½¿ç”¨ï¼ŒUUID è™½ç„¶ç®€å•ä½†ä¸é€‚åˆä½œä¸ºä¸»é”®ã€‚æœ¬æ–‡å¯¹æ¯”ä¸»æµçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚ æŒæ¡é›ªèŠ±ç®—æ³•çš„å®ç°ä¸æ—¶é’Ÿå›æ‹¨é—®é¢˜ äº†è§£ç¾å›¢ Leaf æ–¹æ¡ˆçš„è®¾è®¡æ€æƒ³ å­¦ä¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚ å…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½é‡å¤ è¶‹åŠ¿é€’å¢ï¼šæ–¹ä¾¿æ’åºå’Œç´¢å¼• é«˜æ€§èƒ½ï¼šç”Ÿæˆé€Ÿåº¦å¿« é«˜å¯ç”¨ï¼šæœåŠ¡ä¸èƒ½æŒ‚ ä¿¡æ¯å®‰å…¨ï¼šä¸èƒ½æ³„éœ²ä¸šåŠ¡ä¿¡æ¯ æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“è‡ªå¢ ID 1CREATE TABLE id_generator ( 2 id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY, 3 stub CHAR(1) NOT NULL DEFAULT \u0026#39;\u0026#39;, 4 UNIQUE KEY stub (stub) 5); 6 7INSERT INTO id_generator (stub) VALUES (\u0026#39;a\u0026#39;); 8SELECT LAST_INSERT_ID(); ä¼˜ç‚¹ï¼šç®€å•ï¼Œè¶‹åŠ¿é€’å¢\nç¼ºç‚¹ï¼š\næ€§èƒ½ç“¶é¢ˆï¼šæ•°æ®åº“å‹åŠ›å¤§ å•ç‚¹æ•…éšœï¼šæ•°æ®åº“æŒ‚äº†å°±æ— æ³•ç”Ÿæˆ ID æ‰©å±•æ€§å·®ï¼šåˆ†åº“åˆ†è¡¨åéœ€è¦è®¾ç½®ä¸åŒçš„æ­¥é•¿ æ–¹æ¡ˆäºŒï¼šUUID 1String id = UUID.randomUUID().toString(); ä¼˜ç‚¹ï¼šç®€å•ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ€§èƒ½é«˜\nç¼ºç‚¹ï¼š\næ— åºï¼šä¸åˆ©äºæ•°æ®åº“ç´¢å¼• é•¿åº¦é•¿ï¼š36 ä¸ªå­—ç¬¦ï¼Œå ç”¨ç©ºé—´å¤§ ä¸é€‚åˆä½œä¸ºä¸»é”®ï¼šB+ æ ‘ç´¢å¼•æ€§èƒ½å·® æ–¹æ¡ˆä¸‰ï¼šé›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰ Twitter å¼€æºçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆç®—æ³•ï¼Œç”Ÿæˆ 64 ä½ long å‹ IDã€‚\nID ç»“æ„\n10 - 41ä½æ—¶é—´æˆ³ - 10ä½æœºå™¨ID - 12ä½åºåˆ—å· 1 ä½ï¼šç¬¦å·ä½ï¼Œå›ºå®šä¸º 0 41 ä½ï¼šæ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼Œå¯ç”¨ 69 å¹´ 10 ä½ï¼šæœºå™¨ IDï¼ˆ5 ä½æ•°æ®ä¸­å¿ƒ ID + 5 ä½æœºå™¨ IDï¼‰ï¼Œæ”¯æŒ 1024 å°æœºå™¨ 12 ä½ï¼šåºåˆ—å·ï¼ŒåŒä¸€æ¯«ç§’å†…å¯ç”Ÿæˆ 4096 ä¸ª ID å®ç°ä»£ç \n1public class SnowflakeIdGenerator { 2 3 private final long twepoch = 1288834974657L; // èµ·å§‹æ—¶é—´æˆ³ 4 private final long workerIdBits = 5L; 5 private final long datacenterIdBits = 5L; 6 private final long sequenceBits = 12L; 7 8 private final long workerIdShift = sequenceBits; 9 private final long datacenterIdShift = sequenceBits + workerIdBits; 10 private final long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits; 11 private final long sequenceMask = -1L ^ (-1L \u0026lt;\u0026lt; sequenceBits); 12 13 private long workerId; 14 private long datacenterId; 15 private long sequence = 0L; 16 private long lastTimestamp = -1L; 17 18 public synchronized long nextId() { 19 long timestamp = System.currentTimeMillis(); 20 21 // æ—¶é’Ÿå›æ‹¨æ£€æµ‹ 22 if (timestamp \u0026lt; lastTimestamp) { 23 throw new RuntimeException(\u0026#34;Clock moved backwards\u0026#34;); 24 } 25 26 // åŒä¸€æ¯«ç§’å†…ï¼Œåºåˆ—å·è‡ªå¢ 27 if (lastTimestamp == timestamp) { 28 sequence = (sequence + 1) \u0026amp; sequenceMask; 29 if (sequence == 0) { 30 // åºåˆ—å·ç”¨å®Œï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’ 31 timestamp = tilNextMillis(lastTimestamp); 32 } 33 } else { 34 sequence = 0L; 35 } 36 37 lastTimestamp = timestamp; 38 39 // ç»„è£… ID 40 return ((timestamp - twepoch) \u0026lt;\u0026lt; timestampLeftShift) 41 | (datacenterId \u0026lt;\u0026lt; datacenterIdShift) 42 | (workerId \u0026lt;\u0026lt; workerIdShift) 43 | sequence; 44 } 45 46 private long tilNextMillis(long lastTimestamp) { 47 long timestamp = System.currentTimeMillis(); 48 while (timestamp \u0026lt;= lastTimestamp) { 49 timestamp = System.currentTimeMillis(); 50 } 51 return timestamp; 52 } 53} æ—¶é’Ÿå›æ‹¨é—®é¢˜\nå¦‚æœç³»ç»Ÿæ—¶é—´è¢«å›æ‹¨ï¼Œä¼šå¯¼è‡´ ID é‡å¤ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\næ‹’ç»ç”Ÿæˆ IDï¼ŒæŠ›å‡ºå¼‚å¸¸ ç­‰å¾…æ—¶é’Ÿè¿½ä¸Š ä½¿ç”¨æ‰©å±•ä½è®°å½•æ—¶é’Ÿå›æ‹¨æ¬¡æ•° æ–¹æ¡ˆå››ï¼šç¾å›¢ Leaf ç¾å›¢å¼€æºçš„åˆ†å¸ƒå¼ ID ç”ŸæˆæœåŠ¡ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š\nLeaf-segmentï¼šå·æ®µæ¨¡å¼\nä»æ•°æ®åº“æ‰¹é‡è·å– ID å·æ®µï¼Œç¼“å­˜åœ¨å†…å­˜ä¸­åˆ†é…ã€‚\n1CREATE TABLE leaf_alloc ( 2 biz_tag VARCHAR(128) NOT NULL, 3 max_id BIGINT NOT NULL, 4 step INT NOT NULL, 5 PRIMARY KEY (biz_tag) 6); æµç¨‹ï¼š\næœåŠ¡å¯åŠ¨æ—¶ï¼Œä»æ•°æ®åº“è·å–å·æ®µï¼ˆå¦‚ 1-1000ï¼‰ åœ¨å†…å­˜ä¸­åˆ†é… ID å·æ®µç”¨å®Œåï¼Œå†æ¬¡ä»æ•°æ®åº“è·å–ä¸‹ä¸€ä¸ªå·æ®µ ä¼˜ç‚¹ï¼š\nå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•° æ”¯æŒåŠ¨æ€è°ƒæ•´æ­¥é•¿ Leaf-snowflakeï¼šé›ªèŠ±æ¨¡å¼\nåŸºäº Zookeeper ç”Ÿæˆæœºå™¨ IDï¼Œè§£å†³äº†é›ªèŠ±ç®—æ³•çš„æœºå™¨ ID åˆ†é…é—®é¢˜ã€‚\næ–¹æ¡ˆå¯¹æ¯” æ–¹æ¡ˆ æ€§èƒ½ å¯ç”¨æ€§ è¶‹åŠ¿é€’å¢ å¤æ‚åº¦ æ•°æ®åº“è‡ªå¢ ä½ ä½ æ˜¯ ä½ UUID é«˜ é«˜ å¦ ä½ é›ªèŠ±ç®—æ³• é«˜ é«˜ æ˜¯ ä¸­ Leaf-segment ä¸­ ä¸­ æ˜¯ ä¸­ Leaf-snowflake é«˜ é«˜ æ˜¯ é«˜ é€‰å‹å»ºè®® å°å‹é¡¹ç›®ï¼šæ•°æ®åº“è‡ªå¢ ID å¯¹é¡ºåºæ— è¦æ±‚ï¼šUUID é«˜æ€§èƒ½è¦æ±‚ï¼šé›ªèŠ±ç®—æ³• éœ€è¦é›†ä¸­ç®¡ç†ï¼šLeaf æ€»ç»“ä¸æ€è€ƒ åˆ†å¸ƒå¼ ID ç”Ÿæˆæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€é—®é¢˜ï¼Œä¸åŒæ–¹æ¡ˆé€‚ç”¨äºä¸åŒåœºæ™¯ã€‚\né›ªèŠ±ç®—æ³•æ€§èƒ½é«˜ï¼Œä½†éœ€è¦è§£å†³æ—¶é’Ÿå›æ‹¨å’Œæœºå™¨ ID åˆ†é…é—®é¢˜ Leaf æä¾›äº†æ›´å®Œå–„çš„è§£å†³æ–¹æ¡ˆï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ ä¸‹æ¬¡å½“ä½ éœ€è¦ç”Ÿæˆåˆ†å¸ƒå¼ ID æ—¶ï¼Œæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\n","permalink":"http://localhost:1313/posts/2024/07/%E5%88%86%E5%B8%83%E5%BC%8F-id-%E7%94%9F%E6%88%90%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94%E4%B8%8E%E9%80%89%E5%9E%8B%E6%8C%87%E5%8D%97/","summary":"\u003cp\u003eåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”Ÿæˆå…¨å±€å”¯ä¸€ ID æ˜¯ä¸€ä¸ªåŸºç¡€éœ€æ±‚ã€‚æ•°æ®åº“è‡ªå¢ ID åœ¨åˆ†åº“åˆ†è¡¨åæ— æ³•ä½¿ç”¨ï¼ŒUUID è™½ç„¶ç®€å•ä½†ä¸é€‚åˆä½œä¸ºä¸»é”®ã€‚æœ¬æ–‡å¯¹æ¯”ä¸»æµçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é›ªèŠ±ç®—æ³•çš„å®ç°ä¸æ—¶é’Ÿå›æ‹¨é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç¾å›¢ Leaf æ–¹æ¡ˆçš„è®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†å¸ƒå¼-id-çš„æ ¸å¿ƒè¦æ±‚\"\u003eåˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eå…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½é‡å¤\u003c/li\u003e\n\u003cli\u003eè¶‹åŠ¿é€’å¢ï¼šæ–¹ä¾¿æ’åºå’Œç´¢å¼•\u003c/li\u003e\n\u003cli\u003eé«˜æ€§èƒ½ï¼šç”Ÿæˆé€Ÿåº¦å¿«\u003c/li\u003e\n\u003cli\u003eé«˜å¯ç”¨ï¼šæœåŠ¡ä¸èƒ½æŒ‚\u003c/li\u003e\n\u003cli\u003eä¿¡æ¯å®‰å…¨ï¼šä¸èƒ½æ³„éœ²ä¸šåŠ¡ä¿¡æ¯\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ–¹æ¡ˆä¸€æ•°æ®åº“è‡ªå¢-id\"\u003eæ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“è‡ªå¢ ID\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCREATE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid_generator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003eBIGINT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTO_INCREMENT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ePRIMARY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003eCHAR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eDEFAULT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eUNIQUE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eINSERT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eINTO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid_generator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;a\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLAST_INSERT_ID\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¼˜ç‚¹ï¼šç®€å•ï¼Œè¶‹åŠ¿é€’å¢\u003c/p\u003e\n\u003cp\u003eç¼ºç‚¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ€§èƒ½ç“¶é¢ˆï¼šæ•°æ®åº“å‹åŠ›å¤§\u003c/li\u003e\n\u003cli\u003eå•ç‚¹æ•…éšœï¼šæ•°æ®åº“æŒ‚äº†å°±æ— æ³•ç”Ÿæˆ ID\u003c/li\u003e\n\u003cli\u003eæ‰©å±•æ€§å·®ï¼šåˆ†åº“åˆ†è¡¨åéœ€è¦è®¾ç½®ä¸åŒçš„æ­¥é•¿\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ–¹æ¡ˆäºŒuuid\"\u003eæ–¹æ¡ˆäºŒï¼šUUID\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUUID\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erandomUUID\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003etoString\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¼˜ç‚¹ï¼šç®€å•ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ€§èƒ½é«˜\u003c/p\u003e","title":"åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹æŒ‡å—"},{"content":"ç†è§£ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯æŒæ¡ Spring æ¡†æ¶çš„å…³é”®ã€‚æœ¬æ–‡ä»æºç å±‚é¢å‰–æ Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ Spring çš„æ ¸å¿ƒæœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ Bean ç”Ÿå‘½å‘¨æœŸçš„å®Œæ•´æµç¨‹ ç†è§£ BeanPostProcessor çš„æ‰§è¡Œæ—¶æœº å­¦ä¼šè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ äº†è§£ InitializingBean vs @PostConstruct çš„åŒºåˆ« Bean ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ 1å®ä¾‹åŒ– â†’ å±æ€§å¡«å…… â†’ åˆå§‹åŒ–å‰ â†’ åˆå§‹åŒ– â†’ åˆå§‹åŒ–å â†’ ä½¿ç”¨ â†’ é”€æ¯ è¯¦ç»†æµç¨‹ï¼š\nå®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ï¼šé€šè¿‡åå°„åˆ›å»º Bean å®ä¾‹ å±æ€§å¡«å……ï¼ˆPopulateï¼‰ï¼šæ³¨å…¥ä¾èµ–çš„ Bean Aware æ¥å£å›è°ƒï¼šBeanNameAwareã€BeanFactoryAware ç­‰ BeanPostProcessor.postProcessBeforeInitialization InitializingBean.afterPropertiesSet è‡ªå®šä¹‰ init-method BeanPostProcessor.postProcessAfterInitialization Bean å¯ä»¥ä½¿ç”¨ DisposableBean.destroy è‡ªå®šä¹‰ destroy-method å®ä¾‹åŒ–ï¼šåå°„åˆ›å»ºå¯¹è±¡ 1protected Object doCreateBean(String beanName, RootBeanDefinition mbd, Object[] args) { 2 // 1. å®ä¾‹åŒ– Bean 3 BeanWrapper instanceWrapper = createBeanInstance(beanName, mbd, args); 4 Object bean = instanceWrapper.getWrappedInstance(); 5 6 // 2. å±æ€§å¡«å…… 7 populateBean(beanName, mbd, instanceWrapper); 8 9 // 3. åˆå§‹åŒ– 10 Object exposedObject = initializeBean(beanName, bean, mbd); 11 12 return exposedObject; 13} å±æ€§å¡«å……ï¼šä¾èµ–æ³¨å…¥ 1protected void populateBean(String beanName, RootBeanDefinition mbd, BeanWrapper bw) { 2 // è·å–å±æ€§å€¼ 3 PropertyValues pvs = mbd.getPropertyValues(); 4 5 // è‡ªåŠ¨è£…é…ï¼ˆbyNameã€byTypeï¼‰ 6 if (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_NAME) { 7 autowireByName(beanName, mbd, bw, newPvs); 8 } 9 if (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_TYPE) { 10 autowireByType(beanName, mbd, bw, newPvs); 11 } 12 13 // åº”ç”¨å±æ€§å€¼ 14 applyPropertyValues(beanName, mbd, bw, pvs); 15} åˆå§‹åŒ–ï¼šå›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘ 1protected Object initializeBean(String beanName, Object bean, RootBeanDefinition mbd) { 2 // 1. Aware æ¥å£å›è°ƒ 3 invokeAwareMethods(beanName, bean); 4 5 // 2. BeanPostProcessor å‰ç½®å¤„ç† 6 Object wrappedBean = applyBeanPostProcessorsBeforeInitialization(bean, beanName); 7 8 // 3. åˆå§‹åŒ–æ–¹æ³• 9 invokeInitMethods(beanName, wrappedBean, mbd); 10 11 // 4. BeanPostProcessor åç½®å¤„ç† 12 wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); 13 14 return wrappedBean; 15} BeanPostProcessorï¼šæ‰©å±•ç‚¹ 1public interface BeanPostProcessor { 2 3 // åˆå§‹åŒ–å‰å›è°ƒ 4 default Object postProcessBeforeInitialization(Object bean, String beanName) { 5 return bean; 6 } 7 8 // åˆå§‹åŒ–åå›è°ƒ 9 default Object postProcessAfterInitialization(Object bean, String beanName) { 10 return bean; 11 } 12} åº”ç”¨åœºæ™¯ï¼š\n@Autowired æ³¨è§£çš„å¤„ç†ï¼ˆAutowiredAnnotationBeanPostProcessorï¼‰ AOP ä»£ç†çš„åˆ›å»ºï¼ˆAbstractAutoProxyCreatorï¼‰ @PostConstruct æ³¨è§£çš„å¤„ç†ï¼ˆCommonAnnotationBeanPostProcessorï¼‰ å¾ªç¯ä¾èµ–ï¼šä¸‰çº§ç¼“å­˜ 1@Service 2public class A { 3 @Autowired 4 private B b; 5} 6 7@Service 8public class B { 9 @Autowired 10 private A a; 11} Spring é€šè¿‡ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼š\n1// ä¸€çº§ç¼“å­˜ï¼šå®Œæ•´çš„ Bean 2private final Map\u0026lt;String, Object\u0026gt; singletonObjects = new ConcurrentHashMap\u0026lt;\u0026gt;(); 3 4// äºŒçº§ç¼“å­˜ï¼šæ—©æœŸçš„ Beanï¼ˆå·²å®ä¾‹åŒ–ï¼Œæœªåˆå§‹åŒ–ï¼‰ 5private final Map\u0026lt;String, Object\u0026gt; earlySingletonObjects = new HashMap\u0026lt;\u0026gt;(); 6 7// ä¸‰çº§ç¼“å­˜ï¼šBean å·¥å‚ 8private final Map\u0026lt;String, ObjectFactory\u0026lt;?\u0026gt;\u0026gt; singletonFactories = new HashMap\u0026lt;\u0026gt;(); è§£å†³æµç¨‹ï¼š\nåˆ›å»º Aï¼Œå®ä¾‹åŒ–åæ”¾å…¥ä¸‰çº§ç¼“å­˜ å¡«å…… A çš„å±æ€§ï¼Œå‘ç°ä¾èµ– B åˆ›å»º Bï¼Œå®ä¾‹åŒ–åæ”¾å…¥ä¸‰çº§ç¼“å­˜ å¡«å…… B çš„å±æ€§ï¼Œå‘ç°ä¾èµ– A ä»ä¸‰çº§ç¼“å­˜è·å– A çš„æ—©æœŸå¼•ç”¨ï¼Œæ³¨å…¥åˆ° B B åˆå§‹åŒ–å®Œæˆï¼Œæ³¨å…¥åˆ° A A åˆå§‹åŒ–å®Œæˆ é¿å‘æç¤ºï¼š æ„é€ å™¨æ³¨å…¥æ— æ³•è§£å†³å¾ªç¯ä¾èµ–ï¼Œå› ä¸ºå®ä¾‹åŒ–æ—¶å°±éœ€è¦ä¾èµ–å¯¹è±¡ã€‚åªæœ‰ setter æ³¨å…¥å’Œå­—æ®µæ³¨å…¥å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–ã€‚\nInitializingBean vs @PostConstruct ä¸‰ç§åˆå§‹åŒ–æ–¹å¼çš„æ‰§è¡Œé¡ºåºï¼š\n1@Component 2public class MyBean implements InitializingBean { 3 4 @PostConstruct 5 public void postConstruct() { 6 System.out.println(\u0026#34;1. @PostConstruct\u0026#34;); 7 } 8 9 @Override 10 public void afterPropertiesSet() { 11 System.out.println(\u0026#34;2. InitializingBean.afterPropertiesSet\u0026#34;); 12 } 13 14 public void initMethod() { 15 System.out.println(\u0026#34;3. init-method\u0026#34;); 16 } 17} æ¨èä½¿ç”¨ @PostConstructï¼Œå› ä¸ºå®ƒæ˜¯ JSR-250 æ ‡å‡†ï¼Œä¸ä¾èµ– Springã€‚\næ€»ç»“ä¸æ€è€ƒ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸä½“ç°äº†\u0026quot;æ¨¡æ¿æ–¹æ³•æ¨¡å¼\u0026quot;å’Œ\u0026quot;è´£ä»»é“¾æ¨¡å¼\u0026quot;çš„è®¾è®¡æ€æƒ³ã€‚\næ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰äº† Bean åˆ›å»ºçš„éª¨æ¶æµç¨‹ è´£ä»»é“¾ï¼šBeanPostProcessor å½¢æˆå¤„ç†é“¾ ç†è§£ Bean ç”Ÿå‘½å‘¨æœŸï¼Œæ‰èƒ½æ›´å¥½åœ°æ‰©å±• Spring æ¡†æ¶ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åœ¨ Bean åˆå§‹åŒ–æ—¶æ‰§è¡Œé€»è¾‘ï¼Œä¸å¦¨è¯•è¯• @PostConstruct æˆ– BeanPostProcessorã€‚\n","permalink":"http://localhost:1313/posts/2024/06/spring-bean-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eç†è§£ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯æŒæ¡ Spring æ¡†æ¶çš„å…³é”®ã€‚æœ¬æ–‡ä»æºç å±‚é¢å‰–æ Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ Spring çš„æ ¸å¿ƒæœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Bean ç”Ÿå‘½å‘¨æœŸçš„å®Œæ•´æµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ BeanPostProcessor çš„æ‰§è¡Œæ—¶æœº\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ InitializingBean vs @PostConstruct çš„åŒºåˆ«\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"bean-ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ\"\u003eBean ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®ä¾‹åŒ– â†’ å±æ€§å¡«å…… â†’ åˆå§‹åŒ–å‰ â†’ åˆå§‹åŒ– â†’ åˆå§‹åŒ–å â†’ ä½¿ç”¨ â†’ é”€æ¯\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¯¦ç»†æµç¨‹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ï¼šé€šè¿‡åå°„åˆ›å»º Bean å®ä¾‹\u003c/li\u003e\n\u003cli\u003eå±æ€§å¡«å……ï¼ˆPopulateï¼‰ï¼šæ³¨å…¥ä¾èµ–çš„ Bean\u003c/li\u003e\n\u003cli\u003eAware æ¥å£å›è°ƒï¼šBeanNameAwareã€BeanFactoryAware ç­‰\u003c/li\u003e\n\u003cli\u003eBeanPostProcessor.postProcessBeforeInitialization\u003c/li\u003e\n\u003cli\u003eInitializingBean.afterPropertiesSet\u003c/li\u003e\n\u003cli\u003eè‡ªå®šä¹‰ init-method\u003c/li\u003e\n\u003cli\u003eBeanPostProcessor.postProcessAfterInitialization\u003c/li\u003e\n\u003cli\u003eBean å¯ä»¥ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eDisposableBean.destroy\u003c/li\u003e\n\u003cli\u003eè‡ªå®šä¹‰ destroy-method\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"å®ä¾‹åŒ–åå°„åˆ›å»ºå¯¹è±¡\"\u003eå®ä¾‹åŒ–ï¼šåå°„åˆ›å»ºå¯¹è±¡\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003edoCreateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. å®ä¾‹åŒ– Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eBeanWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecreateBeanInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetWrappedInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. å±æ€§å¡«å……\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003epopulateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆå§‹åŒ–\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexposedObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einitializeBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexposedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"å±æ€§å¡«å……ä¾èµ–æ³¨å…¥\"\u003eå±æ€§å¡«å……ï¼šä¾èµ–æ³¨å…¥\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epopulateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBeanWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è·å–å±æ€§å€¼\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePropertyValues\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epvs\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetPropertyValues\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è‡ªåŠ¨è£…é…ï¼ˆbyNameã€byTypeï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetResolvedAutowireMode\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTOWIRE_BY_NAME\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eautowireByName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enewPvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetResolvedAutowireMode\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTOWIRE_BY_TYPE\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eautowireByType\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enewPvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åº”ç”¨å±æ€§å€¼\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyPropertyValues\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"åˆå§‹åŒ–å›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘\"\u003eåˆå§‹åŒ–ï¼šå›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003einitializeBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. Aware æ¥å£å›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003einvokeAwareMethods\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. BeanPostProcessor å‰ç½®å¤„ç†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyBeanPostProcessorsBeforeInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆå§‹åŒ–æ–¹æ³•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003einvokeInitMethods\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. BeanPostProcessor åç½®å¤„ç†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyBeanPostProcessorsAfterInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"beanpostprocessoræ‰©å±•ç‚¹\"\u003eBeanPostProcessorï¼šæ‰©å±•ç‚¹\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eBeanPostProcessor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–å‰å›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epostProcessBeforeInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–åå›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epostProcessAfterInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåº”ç”¨åœºæ™¯ï¼š\u003c/p\u003e","title":"Spring Bean ç”Ÿå‘½å‘¨æœŸå®Œå…¨è§£æ"},{"content":"Spring äº‹åŠ¡ç®¡ç†æ˜¯åç«¯å¼€å‘çš„åŸºç¡€æŠ€èƒ½ï¼Œä½†å¾ˆå¤šäººåªä¼šåœ¨æ–¹æ³•ä¸ŠåŠ  @Transactionalï¼Œå´ä¸çŸ¥é“äº‹åŠ¡ä¼ æ’­æœºåˆ¶å’Œå¤±æ•ˆåœºæ™¯ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ Spring äº‹åŠ¡çš„æ ¸å¿ƒåŸç†ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯ æŒæ¡äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§å¸¸è§åœºæ™¯ å­¦ä¼šç¼–ç¨‹å¼äº‹åŠ¡çš„ä½¿ç”¨æ–¹æ³• äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ äº‹åŠ¡çš„ ACID ç‰¹æ€§ Atomicityï¼ˆåŸå­æ€§ï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€ Isolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¹¶å‘äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰° Durabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º REQUIREDï¼ˆé»˜è®¤ï¼‰\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°äº‹åŠ¡ã€‚\n1@Transactional(propagation = Propagation.REQUIRED) 2public void methodA() { 3 // æ“ä½œ 1 4 methodB(); // åŠ å…¥ methodA çš„äº‹åŠ¡ 5} 6 7@Transactional(propagation = Propagation.REQUIRED) 8public void methodB() { 9 // æ“ä½œ 2 10} å¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼ŒmethodA å’Œ methodB çš„æ“ä½œéƒ½ä¼šå›æ»šã€‚\nREQUIRES_NEW\næ— è®ºå½“å‰æ˜¯å¦å­˜åœ¨äº‹åŠ¡ï¼Œéƒ½åˆ›å»ºæ–°äº‹åŠ¡ã€‚å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚\n1@Transactional 2public void methodA() { 3 // æ“ä½œ 1 4 methodB(); // åˆ›å»ºæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ· methodA çš„äº‹åŠ¡ 5 // æ“ä½œ 3 6} 7 8@Transactional(propagation = Propagation.REQUIRES_NEW) 9public void methodB() { 10 // æ“ä½œ 2 11} å¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼Œåªå›æ»šæ“ä½œ 2ï¼Œæ“ä½œ 1 å’Œæ“ä½œ 3 ä¸å—å½±å“ã€‚\nNESTED\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ›å»ºåµŒå¥—äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œç­‰åŒäº REQUIREDã€‚\n1@Transactional 2public void methodA() { 3 // æ“ä½œ 1 4 try { 5 methodB(); // åˆ›å»ºåµŒå¥—äº‹åŠ¡ï¼ˆä¿å­˜ç‚¹ï¼‰ 6 } catch (Exception e) { 7 // methodB å›æ»šï¼Œä½† methodA å¯ä»¥ç»§ç»­ 8 } 9 // æ“ä½œ 3 10} 11 12@Transactional(propagation = Propagation.NESTED) 13public void methodB() { 14 // æ“ä½œ 2 15} åµŒå¥—äº‹åŠ¡åŸºäºæ•°æ®åº“çš„ Savepoint æœºåˆ¶å®ç°ã€‚\nSUPPORTS\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚\né€‚ç”¨äºæŸ¥è¯¢æ–¹æ³•ã€‚\nNOT_SUPPORTED\nä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚\nMANDATORY\nå¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦‚æœå½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\nNEVER\nå¿…é¡»åœ¨éäº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\næ¶æ„æ€è€ƒï¼š äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„è®¾è®¡ä½“ç°äº†\u0026quot;çµæ´»æ€§ä¸å®‰å…¨æ€§çš„å¹³è¡¡\u0026quot;ã€‚REQUIRED ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§ï¼ŒREQUIRES_NEW æä¾›äº†äº‹åŠ¡éš”ç¦»ï¼ŒNESTED æ”¯æŒéƒ¨åˆ†å›æ»šã€‚ä¸åŒçš„ä¸šåŠ¡åœºæ™¯éœ€è¦ä¸åŒçš„ä¼ æ’­è¡Œä¸ºã€‚\näº‹åŠ¡å¤±æ•ˆçš„ 5 ç§åœºæ™¯ åœºæ™¯ä¸€ï¼šæ–¹æ³•ä¸æ˜¯ public\n@Transactional åªå¯¹ public æ–¹æ³•ç”Ÿæ•ˆã€‚\n1@Service 2public class UserService { 3 4 @Transactional 5 private void addUser(User user) { // äº‹åŠ¡å¤±æ•ˆ 6 userMapper.insert(user); 7 } 8} åŸå› ï¼šSpring AOP åŸºäºä»£ç†ï¼Œåªèƒ½ä»£ç† public æ–¹æ³•ã€‚\nåœºæ™¯äºŒï¼šæ–¹æ³•å†…éƒ¨è°ƒç”¨\nåŒä¸€ä¸ªç±»ä¸­ï¼Œæ–¹æ³• A è°ƒç”¨æ–¹æ³• Bï¼Œæ–¹æ³• B çš„äº‹åŠ¡å¤±æ•ˆã€‚\n1@Service 2public class UserService { 3 4 public void methodA() { 5 methodB(); // ç›´æ¥è°ƒç”¨ï¼Œä¸èµ°ä»£ç† 6 } 7 8 @Transactional 9 public void methodB() { // äº‹åŠ¡å¤±æ•ˆ 10 userMapper.insert(user); 11 } 12} åŸå› ï¼šå†…éƒ¨è°ƒç”¨ä¸èµ°ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ this.methodB()ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\n1@Service 2public class UserService { 3 4 @Autowired 5 private UserService self; // æ³¨å…¥è‡ªå·± 6 7 public void methodA() { 8 self.methodB(); // é€šè¿‡ä»£ç†è°ƒç”¨ 9 } 10 11 @Transactional 12 public void methodB() { 13 userMapper.insert(user); 14 } 15} åœºæ™¯ä¸‰ï¼šå¼‚å¸¸è¢«æ•è·\n1@Transactional 2public void addUser(User user) { 3 try { 4 userMapper.insert(user); 5 int i = 1 / 0; // æŠ›å‡ºå¼‚å¸¸ 6 } catch (Exception e) { 7 log.error(\u0026#34;å¼‚å¸¸\u0026#34;, e); // å¼‚å¸¸è¢«æ•è·ï¼Œäº‹åŠ¡ä¸å›æ»š 8 } 9} è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨å›æ»š\n1@Transactional 2public void addUser(User user) { 3 try { 4 userMapper.insert(user); 5 int i = 1 / 0; 6 } catch (Exception e) { 7 log.error(\u0026#34;å¼‚å¸¸\u0026#34;, e); 8 TransactionAspectSupport.currentTransactionStatus().setRollbackOnly(); 9 } 10} åœºæ™¯å››ï¼šå¼‚å¸¸ç±»å‹ä¸åŒ¹é…\n@Transactional é»˜è®¤åªå›æ»š RuntimeException å’Œ Errorã€‚\n1@Transactional 2public void addUser(User user) throws Exception { 3 userMapper.insert(user); 4 throw new Exception(\u0026#34;checked exception\u0026#34;); // äº‹åŠ¡ä¸å›æ»š 5} è§£å†³æ–¹æ¡ˆï¼šæŒ‡å®šå›æ»šçš„å¼‚å¸¸ç±»å‹\n1@Transactional(rollbackFor = Exception.class) 2public void addUser(User user) throws Exception { 3 userMapper.insert(user); 4 throw new Exception(\u0026#34;checked exception\u0026#34;); 5} åœºæ™¯äº”ï¼šæ•°æ®åº“ä¸æ”¯æŒäº‹åŠ¡\nMyISAM å¼•æ“ä¸æ”¯æŒäº‹åŠ¡ï¼Œåªæœ‰ InnoDB æ”¯æŒã€‚\nç¼–ç¨‹å¼äº‹åŠ¡ å£°æ˜å¼äº‹åŠ¡ï¼ˆ@Transactionalï¼‰ç®€å•æ˜“ç”¨ï¼Œä½†ä¸å¤Ÿçµæ´»ã€‚ç¼–ç¨‹å¼äº‹åŠ¡æä¾›äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚\n1@Service 2public class UserService { 3 4 @Autowired 5 private TransactionTemplate transactionTemplate; 6 7 public void addUser(User user) { 8 transactionTemplate.execute(status -\u0026gt; { 9 try { 10 userMapper.insert(user); 11 // å…¶ä»–æ“ä½œ 12 return true; 13 } catch (Exception e) { 14 status.setRollbackOnly(); 15 return false; 16 } 17 }); 18 } 19} åˆ†å¸ƒå¼äº‹åŠ¡ å•ä½“åº”ç”¨çš„äº‹åŠ¡ç”±æ•°æ®åº“ä¿è¯ï¼Œä½†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡å¯èƒ½æ¶‰åŠå¤šä¸ªæœåŠ¡å’Œæ•°æ®åº“ï¼Œéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nè§£å†³æ–¹æ¡ˆä¸€ï¼šä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰\nåè°ƒè€…å…ˆè¯¢é—®æ‰€æœ‰å‚ä¸è€…æ˜¯å¦å¯ä»¥æäº¤ï¼Œå¦‚æœéƒ½åŒæ„ï¼Œå†é€šçŸ¥æäº¤ã€‚\nç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œå­˜åœ¨å•ç‚¹æ•…éšœã€‚\nè§£å†³æ–¹æ¡ˆäºŒï¼šTCC\nTry-Confirm-Cancelï¼Œä¸šåŠ¡å±‚é¢çš„ä¸¤é˜¶æ®µæäº¤ã€‚\nTryï¼šé¢„ç•™èµ„æº Confirmï¼šç¡®è®¤æäº¤ Cancelï¼šå–æ¶ˆå›æ»š è§£å†³æ–¹æ¡ˆä¸‰ï¼šSeata AT æ¨¡å¼\nè‡ªåŠ¨è®°å½• SQL çš„å‰åé•œåƒï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›æ»šã€‚\nè§£å†³æ–¹æ¡ˆå››ï¼šæœ€ç»ˆä¸€è‡´æ€§\né€šè¿‡æ¶ˆæ¯é˜Ÿåˆ— + è¡¥å¿æœºåˆ¶å®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚\næ€»ç»“ä¸æ€è€ƒ Spring äº‹åŠ¡çš„æ ¸å¿ƒæ˜¯ AOP ä»£ç†ï¼Œç†è§£ä»£ç†æœºåˆ¶æ‰èƒ½é¿å…äº‹åŠ¡å¤±æ•ˆã€‚\n7 ç§ä¼ æ’­è¡Œä¸ºé€‚ç”¨äºä¸åŒåœºæ™¯ äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§åœºæ™¯è¦ç‰¢è®° åˆ†å¸ƒå¼äº‹åŠ¡è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©æ–¹æ¡ˆ ä¸‹æ¬¡å½“ä½ çš„äº‹åŠ¡ä¸ç”Ÿæ•ˆæ—¶ï¼Œæ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯è¸©äº†è¿™äº›å‘ã€‚\n","permalink":"http://localhost:1313/posts/2024/05/spring-%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eSpring äº‹åŠ¡ç®¡ç†æ˜¯åç«¯å¼€å‘çš„åŸºç¡€æŠ€èƒ½ï¼Œä½†å¾ˆå¤šäººåªä¼šåœ¨æ–¹æ³•ä¸ŠåŠ  @Transactionalï¼Œå´ä¸çŸ¥é“äº‹åŠ¡ä¼ æ’­æœºåˆ¶å’Œå¤±æ•ˆåœºæ™¯ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ Spring äº‹åŠ¡çš„æ ¸å¿ƒåŸç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§å¸¸è§åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç¼–ç¨‹å¼äº‹åŠ¡çš„ä½¿ç”¨æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"äº‹åŠ¡çš„-acid-ç‰¹æ€§\"\u003eäº‹åŠ¡çš„ ACID ç‰¹æ€§\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eAtomicityï¼ˆåŸå­æ€§ï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥\u003c/li\u003e\n\u003cli\u003eConsistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€\u003c/li\u003e\n\u003cli\u003eIsolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¹¶å‘äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°\u003c/li\u003e\n\u003cli\u003eDurabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"7-ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º\"\u003e7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eREQUIREDï¼ˆé»˜è®¤ï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°äº‹åŠ¡ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Transactional\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epropagation\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePropagation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eREQUIRED\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003emethodA\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ“ä½œ 1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003emethodB\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åŠ å…¥ methodA çš„äº‹åŠ¡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Transactional\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epropagation\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePropagation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eREQUIRED\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003emethodB\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ“ä½œ 2\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼ŒmethodA å’Œ methodB çš„æ“ä½œéƒ½ä¼šå›æ»šã€‚\u003c/p\u003e","title":"Spring äº‹åŠ¡ä¼ æ’­æœºåˆ¶ä¸å¤±æ•ˆåœºæ™¯å®Œå…¨è§£æ"},{"content":"åœ¨ä¼ ç»Ÿ Java åº”ç”¨ä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°ä¸€æ—¦åœ¨ä»£ç ä¸­å†™æ­»ï¼Œå°±åªèƒ½é€šè¿‡é‡å¯åº”ç”¨æ¥è°ƒæ•´ã€‚å½“çº¿ä¸Šæµé‡çªå¢å¯¼è‡´çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯æ—¶ï¼Œå¼€å‘è€…åªèƒ½çœ¼çççœ‹ç€ç³»ç»Ÿå´©æºƒã€‚æœ¬é¡¹ç›®é€šè¿‡è‡ªå®šä¹‰ Spring Boot Starterï¼Œå®ç°äº†çº¿ç¨‹æ± å‚æ•°çš„åŠ¨æ€è°ƒæ•´ã€å®æ—¶ç›‘æ§å’Œå¯è§†åŒ–ç®¡ç†ã€‚\né¡¹ç›®äº®ç‚¹ æ·±å…¥ç ”ç©¶ Spring Boot Starter åŸç†ï¼Œåˆ©ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼ SDK åŸºäº Redisson Pub/Sub æœºåˆ¶å®ç°é…ç½®å®æ—¶æ¨é€ï¼Œæ— éœ€é‡å¯åº”ç”¨ è®¾è®¡ ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ä¸ŠæŠ¥ Redis å¼€å‘ Admin ç®¡ç†åå°ï¼Œæä¾›å¯è§†åŒ–çš„å‚æ•°é…ç½®å’Œç›‘æ§ç•Œé¢ é—®é¢˜èƒŒæ™¯ï¼šçº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹ åœ¨ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œçº¿ç¨‹æ± çš„åˆ›å»ºæ–¹å¼é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š\n1@Configuration 2public class ThreadPoolConfig { 3 @Bean 4 public ThreadPoolExecutor bizThreadPool() { 5 return new ThreadPoolExecutor( 6 10, // æ ¸å¿ƒçº¿ç¨‹æ•° 7 20, // æœ€å¤§çº¿ç¨‹æ•° 8 60, TimeUnit.SECONDS, 9 new LinkedBlockingQueue\u0026lt;\u0026gt;(100) 10 ); 11 } 12} è¿™ç§ç¡¬ç¼–ç æ–¹å¼æœ‰ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\nå‚æ•°è°ƒæ•´éœ€è¦é‡å¯ï¼š å½“å‘ç°çº¿ç¨‹æ± é…ç½®ä¸åˆç†æ—¶ï¼Œå¿…é¡»ä¿®æ”¹ä»£ç ã€é‡æ–°æ‰“åŒ…ã€é‡å¯åº”ç”¨ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé‡å¯æ„å‘³ç€æœåŠ¡ä¸­æ–­ã€‚\nç¼ºä¹ç›‘æ§æ‰‹æ®µï¼š æ— æ³•å®æ—¶æŸ¥çœ‹çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰ï¼Œåªèƒ½ç­‰åˆ°å‡ºé—®é¢˜åé€šè¿‡æ—¥å¿—æ’æŸ¥ã€‚\né…ç½®åˆ†æ•£ç®¡ç†ï¼š ä¸åŒæœåŠ¡çš„çº¿ç¨‹æ± é…ç½®æ•£è½åœ¨å„è‡ªçš„ä»£ç ä¸­ï¼Œç¼ºä¹ç»Ÿä¸€çš„ç®¡ç†å¹³å°ã€‚\nè¿™äº›ç—›ç‚¹å€’é€¼æˆ‘ä»¬å¿…é¡»è®¾è®¡ä¸€å¥—åŠ¨æ€çº¿ç¨‹æ± ç®¡ç†æ–¹æ¡ˆã€‚\næ¶æ„è®¾è®¡ï¼šé›¶ä¾µå…¥å¼ SDK æ ¸å¿ƒè®¾è®¡æ€è·¯æ˜¯ï¼šé€šè¿‡ Spring Boot Starter æœºåˆ¶ï¼Œè®©ä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥åœ°æ¥å…¥åŠ¨æ€çº¿ç¨‹æ± èƒ½åŠ›ã€‚å¼€å‘è€…åªéœ€è¦å¼•å…¥ä¾èµ–ï¼Œçº¿ç¨‹æ± å°±è‡ªåŠ¨å…·å¤‡äº†åŠ¨æ€è°ƒæ•´å’Œç›‘æ§èƒ½åŠ›ã€‚\næŠ€æœ¯é€‰å‹ï¼š\nBeanPostProcessorï¼š æ‹¦æˆª Spring å®¹å™¨ä¸­çš„ ThreadPoolExecutor Beanï¼Œæ›¿æ¢ä¸ºå¯åŠ¨æ€è°ƒæ•´çš„ä»£ç†å¯¹è±¡ Redisson Pub/Subï¼š å®ç°é…ç½®ä¸­å¿ƒåˆ°åº”ç”¨å®ä¾‹çš„å®æ—¶æ¨é€ å®šæ—¶ä»»åŠ¡ï¼š æ¯ 20 ç§’é‡‡é›†ä¸€æ¬¡çº¿ç¨‹æ± æŒ‡æ ‡ï¼Œä¸ŠæŠ¥åˆ° Redis Admin åå°ï¼š æä¾› Web ç•Œé¢ï¼Œç®¡ç†æ‰€æœ‰æœåŠ¡çš„çº¿ç¨‹æ± é…ç½® æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š\n1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” é…ç½®å˜æ›´ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ Admin åå° â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\u0026gt; â”‚ Redis â”‚ 3â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 4 â”‚ 5 â”‚ Pub/Sub æ¨é€ 6 â†“ 7 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 8 â”‚ åº”ç”¨å®ä¾‹ A/B/C â”‚ 9 â”‚ (SDK è‡ªåŠ¨æ¥å…¥) â”‚ 10 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 11 â”‚ 12 â”‚ å®šæ—¶ä¸ŠæŠ¥æŒ‡æ ‡ 13 â†“ 14 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 15 â”‚ Redis â”‚ 16 â”‚ (ç›‘æ§æ•°æ®å­˜å‚¨) â”‚ 17 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒå®ç°ï¼šBeanPostProcessor æ‹¦æˆªä¸æ›¿æ¢ Spring Boot Starter çš„æ ¸å¿ƒæ˜¯è‡ªåŠ¨è£…é…æœºåˆ¶ã€‚æˆ‘ä»¬é€šè¿‡ spring.factories æ–‡ä»¶å£°æ˜è‡ªåŠ¨é…ç½®ç±»ï¼š\n1# META-INF/spring.factories 2org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 3com.example.threadpool.autoconfigure.ThreadPoolAutoConfiguration åœ¨è‡ªåŠ¨é…ç½®ç±»ä¸­ï¼Œæ³¨å†Œ BeanPostProcessorï¼š\n1@Configuration 2public class ThreadPoolAutoConfiguration { 3 4 @Bean 5 public ThreadPoolBeanPostProcessor threadPoolBeanPostProcessor() { 6 return new ThreadPoolBeanPostProcessor(); 7 } 8} BeanPostProcessor ä¼šåœ¨ Spring å®¹å™¨åˆå§‹åŒ–æ¯ä¸ª Bean åæ‰§è¡Œå›è°ƒï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ‹¦æˆª ThreadPoolExecutorï¼š\n1public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 2 3 @Override 4 public Object postProcessAfterInitialization(Object bean, String beanName) { 5 if (bean instanceof ThreadPoolExecutor) { 6 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 7 // å°†åŸå§‹çº¿ç¨‹æ± åŒ…è£…ä¸ºåŠ¨æ€çº¿ç¨‹æ±  8 return new DynamicThreadPoolExecutor(executor, beanName); 9 } 10 return bean; 11 } 12} DynamicThreadPoolExecutor æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„çº¿ç¨‹æ± åŒ…è£…ç±»ï¼Œå®ƒæŒæœ‰åŸå§‹ ThreadPoolExecutor çš„å¼•ç”¨ï¼Œå¹¶æä¾›åŠ¨æ€è°ƒæ•´èƒ½åŠ›ï¼š\n1public class DynamicThreadPoolExecutor extends ThreadPoolExecutor { 2 3 private final String poolName; 4 5 public void updateConfig(ThreadPoolConfig config) { 6 // åŠ¨æ€è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•° 7 this.setCorePoolSize(config.getCorePoolSize()); 8 // åŠ¨æ€è°ƒæ•´æœ€å¤§çº¿ç¨‹æ•° 9 this.setMaximumPoolSize(config.getMaxPoolSize()); 10 // åŠ¨æ€è°ƒæ•´é˜Ÿåˆ—å®¹é‡ï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰ 11 this.setQueue(new ResizableLinkedBlockingQueue\u0026lt;\u0026gt;(config.getQueueCapacity())); 12 } 13} æ¶æ„æ€è€ƒï¼š BeanPostProcessor æ˜¯ Spring æ¡†æ¶çš„æ‰©å±•ç‚¹ä¹‹ä¸€ï¼Œå¾ˆå¤šä¸­é—´ä»¶ï¼ˆå¦‚ MyBatisã€Dubboï¼‰éƒ½é€šè¿‡å®ƒå®ç°é›¶ä¾µå…¥å¼æ¥å…¥ã€‚ç†è§£è¿™ä¸ªæœºåˆ¶ï¼Œå°±èƒ½è®¾è®¡å‡ºå¯¹ä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥çš„åŸºç¡€ç»„ä»¶ã€‚\nåŠ¨æ€å‚æ•°è°ƒæ•´ï¼šRedisson Pub/Sub å®æ—¶æ¨é€ å½“ç®¡ç†å‘˜åœ¨ Admin åå°ä¿®æ”¹çº¿ç¨‹æ± é…ç½®åï¼Œå¦‚ä½•å®æ—¶é€šçŸ¥åˆ°æ‰€æœ‰åº”ç”¨å®ä¾‹ï¼Ÿæˆ‘ä»¬ä½¿ç”¨ Redisson çš„ Pub/Sub æœºåˆ¶ã€‚\nå‘å¸ƒç«¯ï¼ˆAdmin åå°ï¼‰ï¼š\n1@Service 2public class ThreadPoolConfigService { 3 4 @Autowired 5 private RedissonClient redisson; 6 7 public void updateConfig(String appName, String poolName, ThreadPoolConfig config) { 8 // ä¿å­˜é…ç½®åˆ° Redis 9 String key = \u0026#34;threadpool:config:\u0026#34; + appName + \u0026#34;:\u0026#34; + poolName; 10 redisson.getBucket(key).set(config); 11 12 // å‘å¸ƒé…ç½®å˜æ›´æ¶ˆæ¯ 13 RTopic topic = redisson.getTopic(\u0026#34;threadpool:config:update\u0026#34;); 14 topic.publish(new ConfigUpdateMessage(appName, poolName, config)); 15 } 16} è®¢é˜…ç«¯ï¼ˆåº”ç”¨å®ä¾‹ï¼‰ï¼š\n1@Component 2public class ThreadPoolConfigListener implements ApplicationListener\u0026lt;ContextRefreshedEvent\u0026gt; { 3 4 @Autowired 5 private RedissonClient redisson; 6 7 @Autowired 8 private Map\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; threadPoolMap; 9 10 @Override 11 public void onApplicationEvent(ContextRefreshedEvent event) { 12 // è®¢é˜…é…ç½®å˜æ›´æ¶ˆæ¯ 13 RTopic topic = redisson.getTopic(\u0026#34;threadpool:config:update\u0026#34;); 14 topic.addListener(ConfigUpdateMessage.class, (channel, msg) -\u0026gt; { 15 // åªå¤„ç†æœ¬åº”ç”¨çš„é…ç½® 16 if (!msg.getAppName().equals(appName)) { 17 return; 18 } 19 // åŠ¨æ€æ›´æ–°çº¿ç¨‹æ± é…ç½® 20 DynamicThreadPoolExecutor executor = threadPoolMap.get(msg.getPoolName()); 21 if (executor != null) { 22 executor.updateConfig(msg.getConfig()); 23 log.info(\u0026#34;çº¿ç¨‹æ±  {} é…ç½®å·²æ›´æ–°: {}\u0026#34;, msg.getPoolName(), msg.getConfig()); 24 } 25 }); 26 } 27} è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šé…ç½®å˜æ›´å¯ä»¥åœ¨ç§’çº§å†…æ¨é€åˆ°æ‰€æœ‰å®ä¾‹ï¼Œæ— éœ€é‡å¯åº”ç”¨ã€‚å³ä½¿æœ‰ä¸Šç™¾ä¸ªå®ä¾‹ï¼Œä¹Ÿèƒ½ä¿è¯é…ç½®çš„ä¸€è‡´æ€§ã€‚\né¿å‘æç¤ºï¼š Redisson çš„ Pub/Sub æ˜¯åŸºäº Redis çš„å‘å¸ƒè®¢é˜…æœºåˆ¶ï¼Œæ¶ˆæ¯ä¸ä¼šæŒä¹…åŒ–ã€‚å¦‚æœåº”ç”¨å®ä¾‹åœ¨é…ç½®å˜æ›´æ—¶å¤„äºç¦»çº¿çŠ¶æ€ï¼Œé‡æ–°ä¸Šçº¿åéœ€è¦ä¸»åŠ¨ä» Redis æ‹‰å–æœ€æ–°é…ç½®ã€‚\nç›‘æ§æŒ‡æ ‡é‡‡é›†ï¼šå®šæ—¶ä»»åŠ¡ä¸ŠæŠ¥ åŠ¨æ€è°ƒæ•´åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œæ›´é‡è¦çš„æ˜¯å®æ—¶ç›‘æ§çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ã€‚æˆ‘ä»¬è®¾è®¡äº† ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œæ¯ 20 ç§’é‡‡é›†ä¸€æ¬¡æŒ‡æ ‡ï¼š\n1@Component 2public class ThreadPoolDataReportJob { 3 4 @Autowired 5 private Map\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; threadPoolMap; 6 7 @Autowired 8 private RedissonClient redisson; 9 10 @Scheduled(fixedRate = 20000) 11 public void reportMetrics() { 12 for (Map.Entry\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; entry : threadPoolMap.entrySet()) { 13 String poolName = entry.getKey(); 14 ThreadPoolExecutor executor = entry.getValue(); 15 16 // é‡‡é›†æŒ‡æ ‡ 17 ThreadPoolMetrics metrics = ThreadPoolMetrics.builder() 18 .poolName(poolName) 19 .corePoolSize(executor.getCorePoolSize()) 20 .maximumPoolSize(executor.getMaximumPoolSize()) 21 .activeCount(executor.getActiveCount()) // æ´»è·ƒçº¿ç¨‹æ•° 22 .queueSize(executor.getQueue().size()) // é˜Ÿåˆ—é•¿åº¦ 23 .completedTaskCount(executor.getCompletedTaskCount()) 24 .rejectedCount(getRejectedCount(executor)) // æ‹’ç»æ¬¡æ•° 25 .timestamp(System.currentTimeMillis()) 26 .build(); 27 28 // ä¸ŠæŠ¥åˆ° Redisï¼ˆä½¿ç”¨ List ç»“æ„ï¼Œä¿ç•™æœ€è¿‘ 100 æ¡è®°å½•ï¼‰ 29 String key = \u0026#34;threadpool:metrics:\u0026#34; + appName + \u0026#34;:\u0026#34; + poolName; 30 RList\u0026lt;ThreadPoolMetrics\u0026gt; list = redisson.getList(key); 31 list.add(metrics); 32 if (list.size() \u0026gt; 100) { 33 list.remove(0); // ç§»é™¤æœ€æ—§çš„è®°å½• 34 } 35 } 36 } 37} ä¸ºäº†ç»Ÿè®¡æ‹’ç»æ¬¡æ•°ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ RejectedExecutionHandlerï¼š\n1public class MonitorableRejectedHandler implements RejectedExecutionHandler { 2 3 private final AtomicLong rejectedCount = new AtomicLong(0); 4 5 @Override 6 public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) { 7 rejectedCount.incrementAndGet(); 8 // é™çº§ç­–ç•¥ï¼šè°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ 9 new ThreadPoolExecutor.CallerRunsPolicy().rejectedExecution(r, executor); 10 } 11 12 public long getRejectedCount() { 13 return rejectedCount.get(); 14 } 15} å¯è§†åŒ–ç®¡ç†ï¼šAdmin åå°è®¾è®¡ Admin åå°æä¾›ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š\n1. é…ç½®ç®¡ç†ç•Œé¢\nå±•ç¤ºæ‰€æœ‰åº”ç”¨çš„çº¿ç¨‹æ± åˆ—è¡¨ï¼Œæ”¯æŒåœ¨çº¿ä¿®æ”¹å‚æ•°ï¼š\n1@RestController 2@RequestMapping(\u0026#34;/api/threadpool\u0026#34;) 3public class ThreadPoolController { 4 5 @GetMapping(\u0026#34;/list\u0026#34;) 6 public List\u0026lt;ThreadPoolInfo\u0026gt; listThreadPools(@RequestParam String appName) { 7 // ä» Redis æŸ¥è¯¢æ‰€æœ‰çº¿ç¨‹æ± é…ç½® 8 String pattern = \u0026#34;threadpool:config:\u0026#34; + appName + \u0026#34;:*\u0026#34;; 9 return redisson.getKeys().getKeysByPattern(pattern).stream() 10 .map(key -\u0026gt; redisson.getBucket(key).get()) 11 .collect(Collectors.toList()); 12 } 13 14 @PostMapping(\u0026#34;/update\u0026#34;) 15 public void updateConfig(@RequestBody ThreadPoolUpdateRequest request) { 16 threadPoolConfigService.updateConfig( 17 request.getAppName(), 18 request.getPoolName(), 19 request.getConfig() 20 ); 21 } 22} 2. ç›‘æ§å¤§ç›˜\nå®æ—¶å±•ç¤ºçº¿ç¨‹æ± çš„è¿è¡ŒæŒ‡æ ‡ï¼Œæ”¯æŒå›¾è¡¨å¯è§†åŒ–ï¼š\næ´»è·ƒçº¿ç¨‹æ•°è¶‹åŠ¿å›¾ é˜Ÿåˆ—é•¿åº¦å˜åŒ–æ›²çº¿ ä»»åŠ¡æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ ä»»åŠ¡å®Œæˆé€Ÿç‡ å‰ç«¯ä½¿ç”¨ ECharts æ¸²æŸ“å›¾è¡¨ï¼Œæ¯ 5 ç§’è½®è¯¢ä¸€æ¬¡åç«¯æ¥å£è·å–æœ€æ–°æ•°æ®ã€‚\næ¶æ„æ€è€ƒï¼š ç›‘æ§æ•°æ®çš„å­˜å‚¨æ–¹å¼æœ‰å¤šç§é€‰æ‹©ï¼šRedisã€InfluxDBã€Prometheusã€‚æˆ‘ä»¬é€‰æ‹© Redis æ˜¯å› ä¸ºå®ƒéƒ¨ç½²ç®€å•ï¼Œä¸”æˆ‘ä»¬çš„ç›‘æ§æ•°æ®é‡ä¸å¤§ï¼ˆæ¯ä¸ªçº¿ç¨‹æ± æ¯ 20 ç§’ä¸€æ¡è®°å½•ï¼‰ã€‚å¦‚æœéœ€è¦é•¿æœŸå­˜å‚¨å’Œå¤æ‚æŸ¥è¯¢ï¼Œå»ºè®®ä½¿ç”¨æ—¶åºæ•°æ®åº“ã€‚\né¡¹ç›®æˆæœä¸åæ€ è¿™ä¸ª SDK åœ¨å…¬å¸å†…éƒ¨æ¨å¹¿åï¼Œæ¥å…¥äº† 20+ ä¸ªæœåŠ¡ï¼Œç´¯è®¡ç®¡ç† 50+ ä¸ªçº¿ç¨‹æ± ã€‚æ ¸å¿ƒæ”¶ç›Šï¼š\nçº¿ä¸Šé—®é¢˜å“åº”æ—¶é—´ä»\u0026quot;å°æ—¶çº§\u0026quot;é™ä½åˆ°\u0026quot;åˆ†é’Ÿçº§\u0026quot;ï¼ˆæ— éœ€é‡å¯è°ƒæ•´å‚æ•°ï¼‰ é€šè¿‡ç›‘æ§å¤§ç›˜æå‰å‘ç° 3 æ¬¡æ½œåœ¨çš„çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯é—®é¢˜ ç»Ÿä¸€çš„é…ç½®ç®¡ç†é™ä½äº†è¿ç»´æˆæœ¬ å¦‚æœé‡æ–°è®¾è®¡ï¼Œæˆ‘ä¼šè€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–ï¼š\næ”¯æŒæ›´å¤šçº¿ç¨‹æ± ç±»å‹ï¼š ç›®å‰åªæ”¯æŒ ThreadPoolExecutorï¼Œæœªæ¥å¯ä»¥æ‰©å±•åˆ° ScheduledThreadPoolExecutorã€ForkJoinPool ç­‰ã€‚\nå‘Šè­¦æœºåˆ¶ï¼š å½“é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼æˆ–æ‹’ç»æ¬¡æ•°æ¿€å¢æ—¶ï¼Œè‡ªåŠ¨å‘é€é’‰é’‰/é‚®ä»¶å‘Šè­¦ã€‚\nå†å²é…ç½®å›æ»šï¼š è®°å½•æ¯æ¬¡é…ç½®å˜æ›´çš„å†å²ï¼Œæ”¯æŒä¸€é”®å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚\nè¿™ä¸ªé¡¹ç›®æœ€å¤§çš„æ”¶è·æ˜¯ï¼šç†è§£äº† Spring Boot Starter çš„è®¾è®¡å“²å­¦â€”â€”é€šè¿‡çº¦å®šå’Œè‡ªåŠ¨åŒ–ï¼Œè®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯åŸºç¡€è®¾æ–½çš„æ­å»ºã€‚è¿™ç§\u0026quot;é›¶ä¾µå…¥å¼\u0026quot;çš„è®¾è®¡æ€æƒ³ï¼Œå€¼å¾—åœ¨å…¶ä»–åŸºç¡€ç»„ä»¶ä¸­æ¨å¹¿ã€‚\n","permalink":"http://localhost:1313/projects/thread-pool-sdk/","summary":"\u003cp\u003eåœ¨ä¼ ç»Ÿ Java åº”ç”¨ä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°ä¸€æ—¦åœ¨ä»£ç ä¸­å†™æ­»ï¼Œå°±åªèƒ½é€šè¿‡é‡å¯åº”ç”¨æ¥è°ƒæ•´ã€‚å½“çº¿ä¸Šæµé‡çªå¢å¯¼è‡´çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯æ—¶ï¼Œå¼€å‘è€…åªèƒ½çœ¼çççœ‹ç€ç³»ç»Ÿå´©æºƒã€‚æœ¬é¡¹ç›®é€šè¿‡è‡ªå®šä¹‰ Spring Boot Starterï¼Œå®ç°äº†çº¿ç¨‹æ± å‚æ•°çš„åŠ¨æ€è°ƒæ•´ã€å®æ—¶ç›‘æ§å’Œå¯è§†åŒ–ç®¡ç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"é¡¹ç›®äº®ç‚¹\"\u003eé¡¹ç›®äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æ·±å…¥ç ”ç©¶ Spring Boot Starter åŸç†ï¼Œåˆ©ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼ SDK\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e åŸºäº Redisson Pub/Sub æœºåˆ¶å®ç°é…ç½®å®æ—¶æ¨é€ï¼Œæ— éœ€é‡å¯åº”ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è®¾è®¡ ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ä¸ŠæŠ¥ Redis\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å¼€å‘ Admin ç®¡ç†åå°ï¼Œæä¾›å¯è§†åŒ–çš„å‚æ•°é…ç½®å’Œç›‘æ§ç•Œé¢\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"é—®é¢˜èƒŒæ™¯çº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹\"\u003eé—®é¢˜èƒŒæ™¯ï¼šçº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹\u003c/h2\u003e\n\u003cp\u003eåœ¨ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œçº¿ç¨‹æ± çš„åˆ›å»ºæ–¹å¼é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eThreadPoolConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ebizThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ ¸å¿ƒçº¿ç¨‹æ•°\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æœ€å¤§çº¿ç¨‹æ•°\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e60\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLinkedBlockingQueue\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™ç§ç¡¬ç¼–ç æ–¹å¼æœ‰ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\u003c/p\u003e","title":"åŠ¨æ€çº¿ç¨‹æ±  SDKï¼šä»é›¶å®ç° Spring Boot Starter"},{"content":"AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡ AOPï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰ä»ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ä½† AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæœ¬æ–‡æ·±å…¥å‰–æ Spring AOP çš„åº•å±‚æœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ AOP çš„æ ¸å¿ƒæ¦‚å¿µï¼šåˆ‡é¢ã€åˆ‡ç‚¹ã€é€šçŸ¥ã€è¿æ¥ç‚¹ æŒæ¡ JDK åŠ¨æ€ä»£ç†ä¸ CGLIB ä»£ç†çš„å®ç°åŸç† å­¦ä¼š ProxyFactory çš„åˆ›å»ºæµç¨‹ äº†è§£åˆ‡é¢æ‰§è¡Œé¡ºåºä¸è´£ä»»é“¾æ¨¡å¼ AOP æ ¸å¿ƒæ¦‚å¿µ åˆ‡é¢ï¼ˆAspectï¼‰\næ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–ï¼Œæ¯”å¦‚æ—¥å¿—åˆ‡é¢ã€äº‹åŠ¡åˆ‡é¢ã€‚\n1@Aspect 2@Component 3public class LogAspect { 4 5 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 6 public void logBefore(JoinPoint joinPoint) { 7 log.info(\u0026#34;æ–¹æ³•æ‰§è¡Œå‰: {}\u0026#34;, joinPoint.getSignature().getName()); 8 } 9} åˆ‡ç‚¹ï¼ˆPointcutï¼‰\nå®šä¹‰åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨é€šçŸ¥ï¼Œé€šè¿‡è¡¨è¾¾å¼åŒ¹é…ã€‚\n1@Pointcut(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 2public void serviceLayer() {} é€šçŸ¥ï¼ˆAdviceï¼‰\nåœ¨åˆ‡ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼Œåˆ†ä¸ºäº”ç§ç±»å‹ï¼š\n@Beforeï¼šå‰ç½®é€šçŸ¥ @Afterï¼šåç½®é€šçŸ¥ @AfterReturningï¼šè¿”å›é€šçŸ¥ @AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥ @Aroundï¼šç¯ç»•é€šçŸ¥ è¿æ¥ç‚¹ï¼ˆJoinPointï¼‰\nç¨‹åºæ‰§è¡Œçš„æŸä¸ªç‚¹ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºã€‚\nJDK åŠ¨æ€ä»£ç† vs CGLIB ä»£ç† Spring AOP ä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼š\nJDK åŠ¨æ€ä»£ç†\nåŸºäºæ¥å£çš„ä»£ç†ï¼Œè¦æ±‚ç›®æ ‡ç±»å®ç°æ¥å£ã€‚\n1public interface UserService { 2 void addUser(User user); 3} 4 5@Service 6public class UserServiceImpl implements UserService { 7 @Override 8 public void addUser(User user) { 9 // ä¸šåŠ¡é€»è¾‘ 10 } 11} JDK åŠ¨æ€ä»£ç†çš„å®ç°ï¼š\n1public class JdkProxyFactory implements InvocationHandler { 2 3 private Object target; 4 5 public Object createProxy(Object target) { 6 this.target = target; 7 return Proxy.newProxyInstance( 8 target.getClass().getClassLoader(), 9 target.getClass().getInterfaces(), 10 this 11 ); 12 } 13 14 @Override 15 public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { 16 System.out.println(\u0026#34;Before method\u0026#34;); 17 Object result = method.invoke(target, args); 18 System.out.println(\u0026#34;After method\u0026#34;); 19 return result; 20 } 21} CGLIB ä»£ç†\nåŸºäºç»§æ‰¿çš„ä»£ç†ï¼Œé€šè¿‡ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»å®ç°ã€‚\n1@Service 2public class UserService { // æ²¡æœ‰å®ç°æ¥å£ 3 public void addUser(User user) { 4 // ä¸šåŠ¡é€»è¾‘ 5 } 6} CGLIB ä»£ç†çš„å®ç°ï¼š\n1public class CglibProxyFactory implements MethodInterceptor { 2 3 public Object createProxy(Object target) { 4 Enhancer enhancer = new Enhancer(); 5 enhancer.setSuperclass(target.getClass()); 6 enhancer.setCallback(this); 7 return enhancer.create(); 8 } 9 10 @Override 11 public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable { 12 System.out.println(\u0026#34;Before method\u0026#34;); 13 Object result = proxy.invokeSuper(obj, args); 14 System.out.println(\u0026#34;After method\u0026#34;); 15 return result; 16 } 17} é€‰æ‹©è§„åˆ™\nå¦‚æœç›®æ ‡ç±»å®ç°äº†æ¥å£ï¼Œé»˜è®¤ä½¿ç”¨ JDK åŠ¨æ€ä»£ç† å¦‚æœç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œä½¿ç”¨ CGLIB ä»£ç† å¯ä»¥é€šè¿‡é…ç½®å¼ºåˆ¶ä½¿ç”¨ CGLIBï¼š@EnableAspectJAutoProxy(proxyTargetClass = true) æ¶æ„æ€è€ƒï¼š JDK åŠ¨æ€ä»£ç†å’Œ CGLIB ä»£ç†ä½“ç°äº†\u0026quot;ç­–ç•¥æ¨¡å¼\u0026quot;çš„æ€æƒ³ã€‚Spring æ ¹æ®ç›®æ ‡ç±»çš„ç‰¹å¾ï¼Œé€‰æ‹©åˆé€‚çš„ä»£ç†ç­–ç•¥ã€‚è¿™ç§è®¾è®¡è®©æ¡†æ¶æ›´åŠ çµæ´»ï¼Œèƒ½å¤Ÿé€‚åº”ä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚\nProxyFactory åˆ›å»ºæµç¨‹ Spring AOP é€šè¿‡ ProxyFactory åˆ›å»ºä»£ç†å¯¹è±¡ï¼š\n1@Component 2public class AopProxyCreator { 3 4 public Object createProxy(Object target) { 5 ProxyFactory proxyFactory = new ProxyFactory(); 6 proxyFactory.setTarget(target); 7 8 // æ·»åŠ é€šçŸ¥ 9 proxyFactory.addAdvice(new MethodBeforeAdvice() { 10 @Override 11 public void before(Method method, Object[] args, Object target) { 12 System.out.println(\u0026#34;Before: \u0026#34; + method.getName()); 13 } 14 }); 15 16 return proxyFactory.getProxy(); 17 } 18} ProxyFactory çš„åˆ›å»ºæµç¨‹ï¼š\nåˆ›å»º AopProxyFactoryï¼ˆé»˜è®¤æ˜¯ DefaultAopProxyFactoryï¼‰ æ ¹æ®ç›®æ ‡ç±»é€‰æ‹©ä»£ç†æ–¹å¼ï¼ˆJDK æˆ– CGLIBï¼‰ åˆ›å»º AopProxy å¯¹è±¡ï¼ˆJdkDynamicAopProxy æˆ– CglibAopProxyï¼‰ ç”Ÿæˆä»£ç†å¯¹è±¡ åˆ‡é¢æ‰§è¡Œé¡ºåº å½“æœ‰å¤šä¸ªåˆ‡é¢æ—¶ï¼Œæ‰§è¡Œé¡ºåºç”± @Order æ³¨è§£æ§åˆ¶ï¼š\n1@Aspect 2@Component 3@Order(1) 4public class LogAspect { 5 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 6 public void logBefore() { 7 System.out.println(\u0026#34;Log Before\u0026#34;); 8 } 9} 10 11@Aspect 12@Component 13@Order(2) 14public class TransactionAspect { 15 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 16 public void transactionBefore() { 17 System.out.println(\u0026#34;Transaction Before\u0026#34;); 18 } 19} æ‰§è¡Œé¡ºåºï¼š\n1Log Before 2Transaction Before 3ç›®æ ‡æ–¹æ³•æ‰§è¡Œ 4Transaction After 5Log After è¿™æ˜¯è´£ä»»é“¾æ¨¡å¼çš„å…¸å‹åº”ç”¨ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šè‡ªå®šä¹‰æ³¨è§£å®ç°æƒé™æ ¡éªŒ 1@Target(ElementType.METHOD) 2@Retention(RetentionPolicy.RUNTIME) 3public @interface RequirePermission { 4 String value(); 5} 6 7@Aspect 8@Component 9public class PermissionAspect { 10 11 @Around(\u0026#34;@annotation(requirePermission)\u0026#34;) 12 public Object checkPermission(ProceedingJoinPoint joinPoint, RequirePermission requirePermission) throws Throwable { 13 String permission = requirePermission.value(); 14 User user = UserContext.getUser(); 15 16 if (!user.hasPermission(permission)) { 17 throw new PermissionDeniedException(\u0026#34;æ— æƒé™è®¿é—®\u0026#34;); 18 } 19 20 return joinPoint.proceed(); 21 } 22} 23 24// ä½¿ç”¨ 25@Service 26public class UserService { 27 28 @RequirePermission(\u0026#34;user:delete\u0026#34;) 29 public void deleteUser(Long userId) { 30 // ä¸šåŠ¡é€»è¾‘ 31 } 32} æ€»ç»“ä¸æ€è€ƒ Spring AOP çš„æ ¸å¿ƒæ˜¯åŠ¨æ€ä»£ç†ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡åœ¨ç›®æ ‡æ–¹æ³•å‰åæ’å…¥æ¨ªåˆ‡é€»è¾‘ã€‚\nJDK åŠ¨æ€ä»£ç†åŸºäºæ¥å£ï¼ŒCGLIB ä»£ç†åŸºäºç»§æ‰¿ ProxyFactory è´Ÿè´£åˆ›å»ºä»£ç†å¯¹è±¡ å¤šä¸ªåˆ‡é¢é€šè¿‡è´£ä»»é“¾æ¨¡å¼ä¸²è”æ‰§è¡Œ ç†è§£ AOP çš„å®ç°åŸç†ï¼Œæ‰èƒ½æ›´å¥½åœ°ä½¿ç”¨å®ƒï¼Œé¿å…è¸©å‘ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹æ—¶ï¼Œä¸å¦¨è¯•è¯• AOPï¼Œè®©ä»£ç æ›´åŠ ä¼˜é›…ã€‚\n","permalink":"http://localhost:1313/posts/2024/04/spring-aop-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eAOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡ AOPï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰ä»ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ä½† AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæœ¬æ–‡æ·±å…¥å‰–æ Spring AOP çš„åº•å±‚æœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ AOP çš„æ ¸å¿ƒæ¦‚å¿µï¼šåˆ‡é¢ã€åˆ‡ç‚¹ã€é€šçŸ¥ã€è¿æ¥ç‚¹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ JDK åŠ¨æ€ä»£ç†ä¸ CGLIB ä»£ç†çš„å®ç°åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼š ProxyFactory çš„åˆ›å»ºæµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ‡é¢æ‰§è¡Œé¡ºåºä¸è´£ä»»é“¾æ¨¡å¼\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"aop-æ ¸å¿ƒæ¦‚å¿µ\"\u003eAOP æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ‡é¢ï¼ˆAspectï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–ï¼Œæ¯”å¦‚æ—¥å¿—åˆ‡é¢ã€äº‹åŠ¡åˆ‡é¢ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Aspect\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Component\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eLogAspect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Before\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003elogBefore\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eJoinPoint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ejoinPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æ–¹æ³•æ‰§è¡Œå‰: {}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ejoinPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetSignature\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003egetName\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ‡ç‚¹ï¼ˆPointcutï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå®šä¹‰åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨é€šçŸ¥ï¼Œé€šè¿‡è¡¨è¾¾å¼åŒ¹é…ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Pointcut\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eserviceLayer\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eé€šçŸ¥ï¼ˆAdviceï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨åˆ‡ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼Œåˆ†ä¸ºäº”ç§ç±»å‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e@Beforeï¼šå‰ç½®é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@Afterï¼šåç½®é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@AfterReturningï¼šè¿”å›é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@Aroundï¼šç¯ç»•é€šçŸ¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eè¿æ¥ç‚¹ï¼ˆJoinPointï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç¨‹åºæ‰§è¡Œçš„æŸä¸ªç‚¹ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"jdk-åŠ¨æ€ä»£ç†-vs-cglib-ä»£ç†\"\u003eJDK åŠ¨æ€ä»£ç† vs CGLIB ä»£ç†\u003c/h2\u003e\n\u003cp\u003eSpring AOP ä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼š\u003c/p\u003e","title":"Spring AOP åŸç†ä¸åŠ¨æ€ä»£ç†å®ç°æ·±åº¦è§£æ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªæ¥å£å¾€å¾€éœ€è¦è°ƒç”¨å¤šä¸ªä¸‹æ¸¸æœåŠ¡ã€‚å¦‚æœä¸²è¡Œè°ƒç”¨ï¼Œå“åº”æ—¶é—´ä¼šç´¯åŠ ï¼›å¦‚æœç”¨ä¼ ç»Ÿçš„ Futureï¼Œä»£ç ä¼šå˜å¾—å¤æ‚éš¾ç»´æŠ¤ã€‚CompletableFuture æä¾›äº†ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ CompletableFuture çš„é“¾å¼è°ƒç”¨ä¸ç»„åˆæ“ä½œ å­¦ä¼šå¼‚å¸¸å¤„ç†ä¸è¶…æ—¶æ§åˆ¶ ç†è§£ä¸çº¿ç¨‹æ± çš„é…åˆä½¿ç”¨ äº†è§£å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ ä¼ ç»Ÿ Future çš„ç—›ç‚¹ JDK 1.5 å¼•å…¥çš„ Future æ¥å£åªèƒ½é€šè¿‡ get() æ–¹æ³•é˜»å¡ç­‰å¾…ç»“æœï¼š\n1ExecutorService executor = Executors.newFixedThreadPool(10); 2 3Future\u0026lt;String\u0026gt; future = executor.submit(() -\u0026gt; { 4 Thread.sleep(1000); 5 return \u0026#34;Hello\u0026#34;; 6}); 7 8// é˜»å¡ç­‰å¾…ç»“æœ 9String result = future.get(); é—®é¢˜ï¼š\nget() ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ— æ³•å¼‚æ­¥å¤„ç†ç»“æœ æ— æ³•ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ å¼‚å¸¸å¤„ç†ä¸æ–¹ä¾¿ CompletableFuture è§£å†³äº†è¿™äº›é—®é¢˜ã€‚\nCompletableFuture åŸºç¡€ç”¨æ³• åˆ›å»º CompletableFuture\n1// æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨å®Œæˆ 2CompletableFuture\u0026lt;String\u0026gt; future = new CompletableFuture\u0026lt;\u0026gt;(); 3future.complete(\u0026#34;Hello\u0026#34;); 4 5// æ–¹å¼äºŒï¼šå¼‚æ­¥æ‰§è¡Œ 6CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 7 return \u0026#34;Hello\u0026#34;; 8}); 9 10// æ–¹å¼ä¸‰ï¼šæ— è¿”å›å€¼çš„å¼‚æ­¥æ‰§è¡Œ 11CompletableFuture\u0026lt;Void\u0026gt; future = CompletableFuture.runAsync(() -\u0026gt; { 12 System.out.println(\u0026#34;Hello\u0026#34;); 13}); è·å–ç»“æœ\n1// é˜»å¡ç­‰å¾…ï¼ˆä¸æ¨èï¼‰ 2String result = future.get(); 3 4// é˜»å¡ç­‰å¾…ï¼Œå¸¦è¶…æ—¶ 5String result = future.get(1, TimeUnit.SECONDS); 6 7// éé˜»å¡è·å–ï¼Œå¦‚æœæœªå®Œæˆè¿”å›é»˜è®¤å€¼ 8String result = future.getNow(\u0026#34;default\u0026#34;); 9 10// é˜»å¡ç­‰å¾…ï¼Œä¸æŠ›å‡ºå—æ£€å¼‚å¸¸ 11String result = future.join(); é“¾å¼è°ƒç”¨ï¼šä¼˜é›…çš„å¼‚æ­¥æµæ°´çº¿ thenApplyï¼šè½¬æ¢ç»“æœ\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenApply(s -\u0026gt; { 4 return s + \u0026#34; World\u0026#34;; 5}).thenApply(s -\u0026gt; { 6 return s.toUpperCase(); 7}); 8 9System.out.println(future.join()); // HELLO WORLD thenAcceptï¼šæ¶ˆè´¹ç»“æœ\n1CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenAccept(s -\u0026gt; { 4 System.out.println(s); // ä¸è¿”å›ç»“æœ 5}); thenRunï¼šæ‰§è¡Œåç»­æ“ä½œ\n1CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenRun(() -\u0026gt; { 4 System.out.println(\u0026#34;Done\u0026#34;); // ä¸å…³å¿ƒå‰é¢çš„ç»“æœ 5}); thenComposeï¼šæ‰å¹³åŒ–åµŒå¥—çš„ CompletableFuture\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;user123\u0026#34;; 3}).thenCompose(userId -\u0026gt; { 4 // æ ¹æ® userId æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆè¿”å› CompletableFutureï¼‰ 5 return getUserInfo(userId); 6}); 7 8CompletableFuture\u0026lt;User\u0026gt; getUserInfo(String userId) { 9 return CompletableFuture.supplyAsync(() -\u0026gt; { 10 return userMapper.selectById(userId); 11 }); 12} æ¶æ„æ€è€ƒï¼š thenApply å’Œ thenCompose çš„åŒºåˆ«ç±»ä¼¼äº Stream çš„ map å’Œ flatMapã€‚thenApply ç”¨äºç®€å•çš„è½¬æ¢ï¼ŒthenCompose ç”¨äºæ‰å¹³åŒ–åµŒå¥—çš„å¼‚æ­¥æ“ä½œã€‚\nç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ thenCombineï¼šåˆå¹¶ä¸¤ä¸ªä»»åŠ¡çš„ç»“æœ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}); 4 5CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; { 6 return \u0026#34;World\u0026#34;; 7}); 8 9CompletableFuture\u0026lt;String\u0026gt; result = future1.thenCombine(future2, (s1, s2) -\u0026gt; { 10 return s1 + \u0026#34; \u0026#34; + s2; 11}); 12 13System.out.println(result.join()); // Hello World allOfï¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task1\u0026#34;); 2CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task2\u0026#34;); 3CompletableFuture\u0026lt;String\u0026gt; future3 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task3\u0026#34;); 4 5CompletableFuture\u0026lt;Void\u0026gt; allFutures = CompletableFuture.allOf(future1, future2, future3); 6 7// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ 8allFutures.join(); 9 10// è·å–æ‰€æœ‰ç»“æœ 11List\u0026lt;String\u0026gt; results = Stream.of(future1, future2, future3) 12 .map(CompletableFuture::join) 13 .collect(Collectors.toList()); anyOfï¼šç­‰å¾…ä»»æ„ä¸€ä¸ªä»»åŠ¡å®Œæˆ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(1000); 3 return \u0026#34;Task1\u0026#34;; 4}); 5 6CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; { 7 Thread.sleep(500); 8 return \u0026#34;Task2\u0026#34;; 9}); 10 11CompletableFuture\u0026lt;Object\u0026gt; anyFuture = CompletableFuture.anyOf(future1, future2); 12 13System.out.println(anyFuture.join()); // Task2ï¼ˆå…ˆå®Œæˆçš„ï¼‰ å®æˆ˜æ¡ˆä¾‹ï¼šå¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡ å‡è®¾ä¸€ä¸ªå•†å“è¯¦æƒ…é¡µéœ€è¦è°ƒç”¨ä¸‰ä¸ªæœåŠ¡ï¼š\nå•†å“æœåŠ¡ï¼šæŸ¥è¯¢å•†å“ä¿¡æ¯ åº“å­˜æœåŠ¡ï¼šæŸ¥è¯¢åº“å­˜ è¯„è®ºæœåŠ¡ï¼šæŸ¥è¯¢è¯„è®º ä¸²è¡Œè°ƒç”¨ï¼ˆæ…¢ï¼‰\n1public ProductDetailDTO getProductDetail(Long productId) { 2 Product product = productService.getProduct(productId); // 100ms 3 Stock stock = stockService.getStock(productId); // 100ms 4 List\u0026lt;Comment\u0026gt; comments = commentService.getComments(productId); // 100ms 5 6 return ProductDetailDTO.builder() 7 .product(product) 8 .stock(stock) 9 .comments(comments) 10 .build(); 11} 12// æ€»è€—æ—¶ï¼š300ms å¹¶è¡Œè°ƒç”¨ï¼ˆå¿«ï¼‰\n1public ProductDetailDTO getProductDetail(Long productId) { 2 CompletableFuture\u0026lt;Product\u0026gt; productFuture = CompletableFuture.supplyAsync(() -\u0026gt; 3 productService.getProduct(productId) 4 ); 5 6 CompletableFuture\u0026lt;Stock\u0026gt; stockFuture = CompletableFuture.supplyAsync(() -\u0026gt; 7 stockService.getStock(productId) 8 ); 9 10 CompletableFuture\u0026lt;List\u0026lt;Comment\u0026gt;\u0026gt; commentsFuture = CompletableFuture.supplyAsync(() -\u0026gt; 11 commentService.getComments(productId) 12 ); 13 14 // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ 15 CompletableFuture.allOf(productFuture, stockFuture, commentsFuture).join(); 16 17 return ProductDetailDTO.builder() 18 .product(productFuture.join()) 19 .stock(stockFuture.join()) 20 .comments(commentsFuture.join()) 21 .build(); 22} 23// æ€»è€—æ—¶ï¼š100msï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰ æ€§èƒ½æå‡ï¼šä» 300ms é™ä½åˆ° 100msã€‚\nå¼‚å¸¸å¤„ç† exceptionallyï¼šæ•è·å¼‚å¸¸å¹¶è¿”å›é»˜è®¤å€¼\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 if (Math.random() \u0026gt; 0.5) { 3 throw new RuntimeException(\u0026#34;Error\u0026#34;); 4 } 5 return \u0026#34;Success\u0026#34;; 6}).exceptionally(ex -\u0026gt; { 7 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 8 return \u0026#34;Default\u0026#34;; 9}); handleï¼šåŒæ—¶å¤„ç†æ­£å¸¸ç»“æœå’Œå¼‚å¸¸\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 if (Math.random() \u0026gt; 0.5) { 3 throw new RuntimeException(\u0026#34;Error\u0026#34;); 4 } 5 return \u0026#34;Success\u0026#34;; 6}).handle((result, ex) -\u0026gt; { 7 if (ex != null) { 8 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 9 return \u0026#34;Default\u0026#34;; 10 } 11 return result; 12}); whenCompleteï¼šä¸æ”¹å˜ç»“æœï¼Œåªåšå‰¯ä½œç”¨æ“ä½œ\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Success\u0026#34;; 3}).whenComplete((result, ex) -\u0026gt; { 4 if (ex != null) { 5 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 6 } else { 7 log.info(\u0026#34;ç»“æœ: {}\u0026#34;, result); 8 } 9}); é¿å‘æç¤ºï¼š exceptionally å’Œ handle ä¼šæ”¹å˜ CompletableFuture çš„ç»“æœï¼Œè€Œ whenComplete ä¸ä¼šã€‚é€‰æ‹©å“ªä¸ªå–å†³äºä½ æ˜¯å¦éœ€è¦æ”¹å˜ç»“æœã€‚\nè¶…æ—¶æ§åˆ¶ JDK 9 å¼•å…¥äº†è¶…æ—¶æ§åˆ¶æ–¹æ³•ï¼š\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(2000); 3 return \u0026#34;Success\u0026#34;; 4}).orTimeout(1, TimeUnit.SECONDS) // è¶…æ—¶æŠ›å‡º TimeoutException 5 .exceptionally(ex -\u0026gt; { 6 return \u0026#34;Timeout\u0026#34;; 7 }); JDK 8 å¯ä»¥é€šè¿‡ CompletableFuture.anyOf å®ç°ï¼š\n1CompletableFuture\u0026lt;String\u0026gt; taskFuture = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(2000); 3 return \u0026#34;Success\u0026#34;; 4}); 5 6CompletableFuture\u0026lt;String\u0026gt; timeoutFuture = new CompletableFuture\u0026lt;\u0026gt;(); 7scheduler.schedule(() -\u0026gt; { 8 timeoutFuture.completeExceptionally(new TimeoutException()); 9}, 1, TimeUnit.SECONDS); 10 11CompletableFuture\u0026lt;String\u0026gt; result = (CompletableFuture\u0026lt;String\u0026gt;) CompletableFuture.anyOf( 12 taskFuture, timeoutFuture 13); ä¸çº¿ç¨‹æ± çš„é…åˆ é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompletableFuture ä½¿ç”¨ ForkJoinPool.commonPool()ï¼Œçº¿ç¨‹æ•°ç­‰äº CPU æ ¸å¿ƒæ•°ã€‚\nå¯¹äº IO å¯†é›†å‹ä»»åŠ¡ï¼Œåº”è¯¥ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š\n1ExecutorService executor = Executors.newFixedThreadPool(20); 2 3CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 4 // IO å¯†é›†å‹ä»»åŠ¡ 5 return httpClient.get(url); 6}, executor); æ³¨æ„äº‹é¡¹\nä¸åŒç±»å‹çš„ä»»åŠ¡ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼ˆCPU å¯†é›†å‹ vs IO å¯†é›†å‹ï¼‰ çº¿ç¨‹æ± è¦åˆç†é…ç½®å¤§å°ï¼Œé¿å…èµ„æºè€—å°½ åº”ç”¨å…³é—­æ—¶è¦ä¼˜é›…åœ°å…³é—­çº¿ç¨‹æ±  1@PreDestroy 2public void shutdown() { 3 executor.shutdown(); 4 try { 5 if (!executor.awaitTermination(60, TimeUnit.SECONDS)) { 6 executor.shutdownNow(); 7 } 8 } catch (InterruptedException e) { 9 executor.shutdownNow(); 10 } 11} æœ€ä½³å®è·µ 1. é¿å…é˜»å¡æ“ä½œ\nä¸è¦åœ¨ CompletableFuture çš„å›è°ƒä¸­æ‰§è¡Œé˜»å¡æ“ä½œï¼Œä¼šå ç”¨çº¿ç¨‹æ± èµ„æºã€‚\n1// ä¸å¥½ï¼šé˜»å¡æ“ä½œ 2CompletableFuture.supplyAsync(() -\u0026gt; { 3 Thread.sleep(1000); // é˜»å¡çº¿ç¨‹ 4 return \u0026#34;Result\u0026#34;; 5}); 6 7// å¥½ï¼šä½¿ç”¨å¼‚æ­¥ API 8CompletableFuture.supplyAsync(() -\u0026gt; { 9 return asyncHttpClient.get(url).join(); 10}); 2. åˆç†è®¾ç½®è¶…æ—¶\né¿å…ä»»åŠ¡æ— é™ç­‰å¾…ï¼Œå¯¼è‡´èµ„æºæ³„æ¼ã€‚\n3. å¼‚å¸¸å¤„ç†è¦å®Œå–„\nç¡®ä¿æ¯ä¸ª CompletableFuture éƒ½æœ‰å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œé¿å…å¼‚å¸¸è¢«åæ‰ã€‚\n4. é¿å…è¿‡åº¦å¹¶è¡Œ\nå¹¶è¡Œä»»åŠ¡æ•°ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè¦æ ¹æ®ç³»ç»Ÿèµ„æºå’Œä¸‹æ¸¸æœåŠ¡çš„æ‰¿è½½èƒ½åŠ›è°ƒæ•´ã€‚\næ€»ç»“ä¸æ€è€ƒ CompletableFuture æ˜¯ Java å¼‚æ­¥ç¼–ç¨‹çš„åˆ©å™¨ï¼Œå®ƒæä¾›äº†ï¼š\né“¾å¼è°ƒç”¨ï¼šä¼˜é›…çš„å¼‚æ­¥æµæ°´çº¿ ç»„åˆæ“ä½œï¼šçµæ´»çš„ä»»åŠ¡ç¼–æ’ å¼‚å¸¸å¤„ç†ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ çº¿ç¨‹æ± é›†æˆï¼šé«˜æ•ˆçš„èµ„æºåˆ©ç”¨ æŒæ¡ CompletableFutureï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å’Œä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡æ—¶ï¼Œä¸å¦¨è¯•è¯• CompletableFutureï¼Œä½“éªŒå¼‚æ­¥ç¼–ç¨‹çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/03/completablefuture-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªæ¥å£å¾€å¾€éœ€è¦è°ƒç”¨å¤šä¸ªä¸‹æ¸¸æœåŠ¡ã€‚å¦‚æœä¸²è¡Œè°ƒç”¨ï¼Œå“åº”æ—¶é—´ä¼šç´¯åŠ ï¼›å¦‚æœç”¨ä¼ ç»Ÿçš„ Futureï¼Œä»£ç ä¼šå˜å¾—å¤æ‚éš¾ç»´æŠ¤ã€‚CompletableFuture æä¾›äº†ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ CompletableFuture çš„é“¾å¼è°ƒç”¨ä¸ç»„åˆæ“ä½œ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šå¼‚å¸¸å¤„ç†ä¸è¶…æ—¶æ§åˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¸çº¿ç¨‹æ± çš„é…åˆä½¿ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¼ ç»Ÿ-future-çš„ç—›ç‚¹\"\u003eä¼ ç»Ÿ Future çš„ç—›ç‚¹\u003c/h2\u003e\n\u003cp\u003eJDK 1.5 å¼•å…¥çš„ Future æ¥å£åªèƒ½é€šè¿‡ get() æ–¹æ³•é˜»å¡ç­‰å¾…ç»“æœï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eExecutorService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eExecutors\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003enewFixedThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esubmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// é˜»å¡ç­‰å¾…ç»“æœ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eget() ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ— æ³•å¼‚æ­¥å¤„ç†ç»“æœ\u003c/li\u003e\n\u003cli\u003eæ— æ³•ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡\u003c/li\u003e\n\u003cli\u003eå¼‚å¸¸å¤„ç†ä¸æ–¹ä¾¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eCompletableFuture è§£å†³äº†è¿™äº›é—®é¢˜ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"completablefuture-åŸºç¡€ç”¨æ³•\"\u003eCompletableFuture åŸºç¡€ç”¨æ³•\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ›å»º CompletableFuture\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨å®Œæˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecomplete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼äºŒï¼šå¼‚æ­¥æ‰§è¡Œ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esupplyAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼ä¸‰ï¼šæ— è¿”å›å€¼çš„å¼‚æ­¥æ‰§è¡Œ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eVoid\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erunAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eè·å–ç»“æœ\u003c/strong\u003e\u003c/p\u003e","title":"CompletableFuture å¼‚æ­¥ç¼–ç¨‹å®æˆ˜æŒ‡å—"},{"content":"åœ¨ç”µå•†ä¸šåŠ¡é«˜é€Ÿå‘å±•çš„èƒŒæ™¯ä¸‹ï¼Œæ‹¼å›¢æ¨¡å¼å› å…¶ç¤¾äº¤è£‚å˜å±æ€§æˆä¸ºæµé‡å¢é•¿çš„åˆ©å™¨ã€‚ä½†çœ‹ä¼¼ç®€å•çš„\u0026quot;å‡‘å¤Ÿ N äººæˆå›¢\u0026quot;èƒŒåï¼Œéšè—ç€åº“å­˜è¶…å–ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€æµ·é‡æ•°æ®å­˜å‚¨ç­‰ä¸€ç³»åˆ—æŠ€æœ¯æŒ‘æˆ˜ã€‚æœ¬æ–‡å¤ç›˜æˆ‘åœ¨æ‹¼å›¢äº¤æ˜“å¹³å°é¡¹ç›®ä¸­çš„æ¶æ„è®¾è®¡ä¸æŠ€æœ¯é€‰å‹æ€è€ƒã€‚\né¡¹ç›®äº®ç‚¹ åŸºäº DDD æ€æƒ³çš„é¢†åŸŸæ¨¡å‹è®¾è®¡ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦ Redis åˆ†å¸ƒå¼é” + åˆ†åº“åˆ†è¡¨è§£å†³é«˜å¹¶å‘åº“å­˜æ‰£å‡é—®é¢˜ RabbitMQ å¼‚æ­¥è§£è€¦å®ç°å•æ­¥æµæ°´çº¿ï¼Œæå‡ç³»ç»Ÿååé‡ ShardingSphere åˆ†åº“åˆ†è¡¨æ”¯æ’‘æµ·é‡è®¢å•æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢ ä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜ æ‹¼å›¢äº¤æ˜“çš„æ ¸å¿ƒæµç¨‹çœ‹ä¼¼ç®€å•ï¼šç”¨æˆ·å‘èµ·æ‹¼å›¢ â†’ å…¶ä»–ç”¨æˆ·å‚å›¢ â†’ è¾¾åˆ°äººæ•°åæˆå›¢ â†’ æ‰£å‡åº“å­˜ â†’ é€šçŸ¥æ”¯ä»˜ã€‚ä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªæµç¨‹ä¼šé‡åˆ°ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\nåº“å­˜è¶…å–ï¼š 100 ä»¶å•†å“ï¼Œ1000 äººåŒæ—¶ä¸‹å•ï¼Œå¦‚ä½•ä¿è¯ä¸ä¼šè¶…å–ï¼Ÿä¼ ç»Ÿçš„æ•°æ®åº“è¡Œé”åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤±æ•ˆã€‚\nåˆ†å¸ƒå¼äº‹åŠ¡ï¼š è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡ã€æ”¯ä»˜é€šçŸ¥åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\næµ·é‡æ•°æ®ï¼š è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚ä½•ä¿è¯æŸ¥è¯¢æ€§èƒ½ä¸éšæ•°æ®é‡å¢é•¿è€ŒåŠ£åŒ–ï¼Ÿ\nè¿™äº›é—®é¢˜å€’é€¼æˆ‘ä»¬å¿…é¡»ä»æ¶æ„å±‚é¢é‡æ–°æ€è€ƒç³»ç»Ÿè®¾è®¡ã€‚\næ¶æ„è®¾è®¡ï¼šDDD æ€æƒ³çš„è½åœ°å®è·µ ä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹ä¼šå¯¼è‡´ Service å±‚é€»è¾‘è‡ƒè‚¿ï¼Œä¸šåŠ¡è§„åˆ™æ•£è½åœ¨å„å¤„ã€‚æˆ‘ä»¬é‡‡ç”¨ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ€æƒ³ï¼Œå°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒé¢†åŸŸï¼š\nè®¢å•åŸŸï¼ˆOrderï¼‰ï¼š è´Ÿè´£æ‹¼å›¢è®¢å•çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€çŠ¶æ€æµè½¬ã€è¶…æ—¶å–æ¶ˆç­‰ã€‚\nåº“å­˜åŸŸï¼ˆInventoryï¼‰ï¼š è´Ÿè´£å•†å“åº“å­˜çš„æ‰£å‡ã€å›æ»šã€é¢„å ç­‰æ“ä½œï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒç“¶é¢ˆã€‚\næ”¯ä»˜åŸŸï¼ˆPaymentï¼‰ï¼š è´Ÿè´£æ”¯ä»˜æµç¨‹çš„ç¼–æ’ï¼ŒåŒ…æ‹¬æ”¯ä»˜é€šçŸ¥ã€é€€æ¬¾å¤„ç†ç­‰ã€‚\næ¯ä¸ªé¢†åŸŸéƒ½æœ‰è‡ªå·±çš„èšåˆæ ¹ï¼ˆAggregate Rootï¼‰å’Œé¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰ã€‚æ¯”å¦‚è®¢å•åŸŸçš„èšåˆæ ¹æ˜¯ Orderï¼Œå®ƒå°è£…äº†è®¢å•çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™ï¼š\n1public class Order { 2 private OrderId id; 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 // ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰å¾…æ”¯ä»˜çŠ¶æ€æ‰èƒ½å–æ¶ˆ 8 public void cancel() { 9 if (this.status != OrderStatus.PENDING_PAYMENT) { 10 throw new OrderCannotCancelException(); 11 } 12 this.status = OrderStatus.CANCELLED; 13 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼šè®¢å•å·²å–æ¶ˆ 14 DomainEventPublisher.publish(new OrderCancelledEvent(this.id)); 15 } 16} è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šä¸šåŠ¡è§„åˆ™å†…èšåœ¨é¢†åŸŸå¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨ Service å±‚çš„å„ç§ if-else é‡Œã€‚å½“äº§å“ç»ç†è¯´\u0026quot;å¢åŠ ä¸€ä¸ªæ‹¼å›¢å¤±è´¥è‡ªåŠ¨é€€æ¬¾çš„é€»è¾‘\u0026quot;æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç›‘å¬ OrderCancelledEvent äº‹ä»¶ï¼Œè€Œä¸éœ€è¦æ”¹åŠ¨è®¢å•å–æ¶ˆçš„æ ¸å¿ƒé€»è¾‘ã€‚\næ¶æ„æ€è€ƒï¼š DDD çš„æœ¬è´¨æ˜¯\u0026quot;ç”¨ä»£ç è¡¨è¾¾ä¸šåŠ¡è¯­è¨€\u0026quot;ã€‚å½“ä½ çš„ä»£ç ä¸­å‡ºç° Order.cancel() è€Œä¸æ˜¯ orderService.updateStatus(orderId, 3)ï¼Œä¸šåŠ¡äººå‘˜ä¹Ÿèƒ½çœ‹æ‡‚ä»£ç åœ¨åšä»€ä¹ˆã€‚è¿™ç§\u0026quot;é€šç”¨è¯­è¨€\u0026quot;ï¼ˆUbiquitous Languageï¼‰æ˜¯ DDD æœ€å¤§çš„ä»·å€¼ã€‚\næ ¸å¿ƒéš¾ç‚¹ï¼šåˆ†å¸ƒå¼é”è§£å†³åº“å­˜è¶…å– åº“å­˜æ‰£å‡æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚æœ€ç®€å•çš„æ–¹æ¡ˆæ˜¯åœ¨æ•°æ®åº“å±‚é¢åŠ è¡Œé”ï¼š\n1UPDATE inventory SET stock = stock - 1 WHERE product_id = ? AND stock \u0026gt; 0 ä½†è¿™ç§æ–¹æ¡ˆåœ¨é«˜å¹¶å‘ä¸‹ä¼šå¯¼è‡´å¤§é‡çº¿ç¨‹é˜»å¡åœ¨æ•°æ®åº“é”ä¸Šï¼ŒTPS ä¸Šä¸å»ã€‚æˆ‘ä»¬çš„ä¼˜åŒ–æ€è·¯æ˜¯ï¼šç”¨ Redis åˆ†å¸ƒå¼é” + é¢„æ‰£å‡æœºåˆ¶ã€‚\nç¬¬ä¸€æ­¥ï¼šRedis é¢„æ‰£å‡\nç”¨æˆ·ä¸‹å•æ—¶ï¼Œå…ˆåœ¨ Redis ä¸­æ‰£å‡åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰ï¼š\n1public boolean preDeductStock(String productId, int quantity) { 2 String key = \u0026#34;stock:\u0026#34; + productId; 3 Long remaining = redisTemplate.opsForValue().decrement(key, quantity); 4 return remaining != null \u0026amp;\u0026amp; remaining \u0026gt;= 0; 5} å¦‚æœ Redis æ‰£å‡æˆåŠŸï¼Œè¯´æ˜æœ‰åº“å­˜ï¼Œå…è®¸åˆ›å»ºè®¢å•ã€‚å¦‚æœå¤±è´¥ï¼Œç›´æ¥è¿”å›\u0026quot;åº“å­˜ä¸è¶³\u0026quot;ï¼Œä¸éœ€è¦è®¿é—®æ•°æ®åº“ã€‚\nç¬¬äºŒæ­¥ï¼šå¼‚æ­¥åŒæ­¥åˆ°æ•°æ®åº“\né€šè¿‡ RabbitMQ å‘é€æ¶ˆæ¯ï¼Œå¼‚æ­¥å°†åº“å­˜å˜æ›´åŒæ­¥åˆ° MySQLï¼š\n1rabbitTemplate.convertAndSend(\u0026#34;inventory.exchange\u0026#34;, \u0026#34;stock.deduct\u0026#34;, 2 new StockDeductMessage(productId, quantity, orderId)); æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯ï¼Œæ›´æ–°æ•°æ®åº“åº“å­˜ï¼š\n1@RabbitListener(queues = \u0026#34;stock.deduct.queue\u0026#34;) 2public void handleStockDeduct(StockDeductMessage msg) { 3 inventoryMapper.deductStock(msg.getProductId(), msg.getQuantity()); 4} ç¬¬ä¸‰æ­¥ï¼šRedisson çœ‹é—¨ç‹—æœºåˆ¶\nä¸ºäº†é˜²æ­¢ Redis å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬ç”¨ Redisson çš„åˆ†å¸ƒå¼é”ä¿æŠ¤æ•´ä¸ªæ‰£å‡æµç¨‹ï¼š\n1RLock lock = redisson.getLock(\u0026#34;lock:stock:\u0026#34; + productId); 2try { 3 lock.lock(10, TimeUnit.SECONDS); 4 // æ‰§è¡Œæ‰£å‡é€»è¾‘ 5} finally { 6 lock.unlock(); 7} Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶ä¼šè‡ªåŠ¨ç»­æœŸé”ï¼Œé¿å…ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”æå‰é‡Šæ”¾ã€‚\né¿å‘æç¤ºï¼š Redis é¢„æ‰£å‡æ–¹æ¡ˆæœ‰ä¸ªéšæ‚£ï¼šå¦‚æœè®¢å•è¶…æ—¶æœªæ”¯ä»˜ï¼Œéœ€è¦å›æ»šåº“å­˜ã€‚è¿™æ—¶å¿…é¡»ä¿è¯ Redis å’Œæ•°æ®åº“çš„åº“å­˜æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚æˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šå®šæ—¶ä»»åŠ¡æ‰«æè¶…æ—¶è®¢å•ï¼ŒåŒæ—¶å›æ»š Redis å’Œæ•°æ®åº“åº“å­˜ã€‚\nå¼‚æ­¥è§£è€¦ï¼šRabbitMQ å•æ­¥æµæ°´çº¿è®¾è®¡ ä¼ ç»Ÿçš„åŒæ­¥è°ƒç”¨é“¾è·¯æ˜¯ï¼šåˆ›å»ºè®¢å• â†’ æ‰£å‡åº“å­˜ â†’ å‘é€æ”¯ä»˜é€šçŸ¥ã€‚å¦‚æœæ¯ä¸€æ­¥éƒ½åŒæ­¥ç­‰å¾…ï¼Œæ•´ä¸ªæ¥å£çš„ RTï¼ˆå“åº”æ—¶é—´ï¼‰ä¼šç´¯åŠ ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå·®ã€‚\næˆ‘ä»¬ç”¨ RabbitMQ å®ç°å¼‚æ­¥è§£è€¦ï¼š\nç”¨æˆ·ä¸‹å•åï¼Œç«‹å³è¿”å›\u0026quot;è®¢å•åˆ›å»ºæˆåŠŸ\u0026quot; å‘é€æ¶ˆæ¯åˆ° order.created é˜Ÿåˆ— åº“å­˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ï¼Œæ‰£å‡åº“å­˜åå‘é€ stock.deducted æ¶ˆæ¯ æ”¯ä»˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ï¼Œå‘é€æ”¯ä»˜é€šçŸ¥ è¿™ç§å•æ­¥æµæ°´çº¿è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šæ¯ä¸ªæœåŠ¡åªå…³å¿ƒè‡ªå·±çš„èŒè´£ï¼Œé€šè¿‡æ¶ˆæ¯é©±åŠ¨å®ç°æ¾è€¦åˆã€‚å¦‚æœåº“å­˜æœåŠ¡æŒ‚äº†ï¼Œæ¶ˆæ¯ä¼šå †ç§¯åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ¢å¤åè‡ªåŠ¨æ¶ˆè´¹ï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ã€‚\n1// è®¢å•æœåŠ¡ï¼šå‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶ 2@Transactional 3public void createOrder(OrderDTO dto) { 4 Order order = orderMapper.insert(dto); 5 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, 6 new OrderCreatedEvent(order.getId())); 7} 8 9// åº“å­˜æœåŠ¡ï¼šç›‘å¬è®¢å•åˆ›å»ºäº‹ä»¶ 10@RabbitListener(queues = \u0026#34;order.created.queue\u0026#34;) 11public void handleOrderCreated(OrderCreatedEvent event) { 12 inventoryService.deductStock(event.getOrderId()); 13 rabbitTemplate.convertAndSend(\u0026#34;inventory.exchange\u0026#34;, \u0026#34;stock.deducted\u0026#34;, 14 new StockDeductedEvent(event.getOrderId())); 15} æ¶æ„æ€è€ƒï¼š å¼‚æ­¥åŒ–çš„ä»£ä»·æ˜¯è°ƒè¯•å¤æ‚åº¦å¢åŠ ã€‚å½“è®¢å•åˆ›å»ºæˆåŠŸä½†åº“å­˜æ‰£å‡å¤±è´¥æ—¶ï¼Œå¦‚ä½•æ’æŸ¥é—®é¢˜ï¼Ÿæˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šæ¯æ¡æ¶ˆæ¯éƒ½å¸¦ä¸Š traceIdï¼Œé€šè¿‡æ—¥å¿—ç³»ç»Ÿä¸²è”æ•´ä¸ªè°ƒç”¨é“¾è·¯ã€‚\næµ·é‡æ•°æ®ï¼šShardingSphere åˆ†åº“åˆ†è¡¨å®æˆ˜ è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚æœä¸åšåˆ†åº“åˆ†è¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šéšç€æ•°æ®é‡å¢é•¿è€Œæ€¥å‰§ä¸‹é™ã€‚æˆ‘ä»¬ç”¨ ShardingSphere å®ç°æ°´å¹³åˆ†è¡¨ï¼š\nåˆ†ç‰‡ç­–ç•¥ï¼š æŒ‰ user_id å–æ¨¡åˆ† 16 å¼ è¡¨ï¼ˆt_order_0 ~ t_order_15ï¼‰\n1shardingRule: 2 tables: 3 t_order: 4 actualDataNodes: ds0.t_order_${0..15} 5 tableStrategy: 6 standard: 7 shardingColumn: user_id 8 shardingAlgorithmName: order_mod 9 shardingAlgorithms: 10 order_mod: 11 type: MOD 12 props: 13 sharding-count: 16 ä¸ºä»€ä¹ˆé€‰æ‹© user_id è€Œä¸æ˜¯ order_idï¼Ÿ\nå› ä¸ºå¤§éƒ¨åˆ†æŸ¥è¯¢åœºæ™¯æ˜¯\u0026quot;æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„è®¢å•åˆ—è¡¨\u0026quot;ï¼ŒæŒ‰ user_id åˆ†ç‰‡å¯ä»¥ä¿è¯å•ä¸ªç”¨æˆ·çš„è®¢å•éƒ½åœ¨åŒä¸€å¼ è¡¨ï¼Œé¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ã€‚\nè·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–ï¼š\nå¦‚æœéœ€è¦æŒ‰ order_id æŸ¥è¯¢ï¼ˆæ¯”å¦‚è®¢å•è¯¦æƒ…é¡µï¼‰ï¼Œä¼šè§¦å‘å…¨è¡¨æ‰«æã€‚æˆ‘ä»¬çš„ä¼˜åŒ–æ–¹æ¡ˆæ˜¯ï¼šåœ¨ Redis ä¸­ç»´æŠ¤ order_id -\u0026gt; user_id çš„æ˜ å°„å…³ç³»ï¼Œå…ˆæŸ¥ Redis è·å– user_idï¼Œå†ç²¾å‡†è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡ã€‚\n1public Order getOrderById(String orderId) { 2 // å…ˆä» Redis è·å– user_id 3 String userId = redisTemplate.opsForValue().get(\u0026#34;order:user:\u0026#34; + orderId); 4 if (userId != null) { 5 // ç²¾å‡†è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡ 6 return orderMapper.selectByOrderIdAndUserId(orderId, userId); 7 } 8 // é™çº§æ–¹æ¡ˆï¼šå…¨è¡¨æ‰«æ 9 return orderMapper.selectByOrderId(orderId); 10} é¿å‘æç¤ºï¼š åˆ†åº“åˆ†è¡¨åï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¼šå˜å¾—æ›´å¤æ‚ã€‚æˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šå°½é‡é¿å…è·¨åˆ†ç‰‡äº‹åŠ¡ï¼Œé€šè¿‡ä¸šåŠ¡è®¾è®¡ä¿è¯å•ä¸ªäº‹åŠ¡åªæ“ä½œä¸€ä¸ªåˆ†ç‰‡ã€‚å¦‚æœå®åœ¨éœ€è¦è·¨åˆ†ç‰‡ï¼Œä½¿ç”¨ Seata çš„ AT æ¨¡å¼ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚\né¡¹ç›®æˆæœä¸æ€è€ƒ ç»è¿‡ä¸‰ä¸ªæœˆçš„è¿­ä»£ï¼Œæ‹¼å›¢äº¤æ˜“å¹³å°æˆåŠŸä¸Šçº¿ï¼Œæ ¸å¿ƒæŒ‡æ ‡å¦‚ä¸‹ï¼š\nè®¢å•åˆ›å»ºæ¥å£ RT ä» 800ms é™ä½åˆ° 120ms åº“å­˜æ‰£å‡ TPS ä» 500 æå‡åˆ° 3000+ æ”¯æŒå•æ—¥ç™¾ä¸‡çº§è®¢å•æ•°æ®å†™å…¥ï¼ŒæŸ¥è¯¢æ€§èƒ½ç¨³å®šåœ¨ 50ms ä»¥å†… è¿™ä¸ªé¡¹ç›®æœ€å¤§çš„æ”¶è·ä¸æ˜¯æŠ€æœ¯æ ˆçš„å †ç Œï¼Œè€Œæ˜¯å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„æ·±åº¦ç†è§£ï¼š\næ²¡æœ‰é“¶å¼¹ï¼š Redis åˆ†å¸ƒå¼é”ã€RabbitMQ å¼‚æ­¥ã€ShardingSphere åˆ†åº“åˆ†è¡¨ï¼Œæ¯ä¸ªæŠ€æœ¯æ–¹æ¡ˆéƒ½æœ‰é€‚ç”¨åœºæ™¯å’Œä»£ä»·ã€‚é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆçš„æœ¬è´¨æ˜¯åœ¨æ€§èƒ½ã€ä¸€è‡´æ€§ã€å¤æ‚åº¦ä¹‹é—´åšæƒè¡¡ã€‚\næ¶æ„æ¼”è¿›ï¼š ç³»ç»Ÿä¸æ˜¯ä¸€å¼€å§‹å°±è®¾è®¡æˆåˆ†å¸ƒå¼çš„ã€‚æˆ‘ä»¬æœ€åˆæ˜¯å•ä½“åº”ç”¨ + MySQL ä¸»ä»ï¼Œå½“ TPS åˆ°è¾¾ç“¶é¢ˆåæ‰å¼•å…¥ Redis å’Œ RabbitMQã€‚è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚\nå¯è§‚æµ‹æ€§ï¼š åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤§çš„æŒ‘æˆ˜æ˜¯æ’æŸ¥é—®é¢˜ã€‚æˆ‘ä»¬åœ¨æ¯ä¸ªå…³é”®èŠ‚ç‚¹éƒ½åŸ‹ç‚¹ä¸ŠæŠ¥ç›‘æ§æ•°æ®ï¼ˆè®¢å•åˆ›å»ºæ•°ã€åº“å­˜æ‰£å‡æ•°ã€æ¶ˆæ¯å †ç§¯æ•°ï¼‰ï¼Œé€šè¿‡ Grafana å®æ—¶ç›‘æ§ç³»ç»Ÿå¥åº·åº¦ã€‚\nå¦‚æœè®©æˆ‘é‡æ–°è®¾è®¡è¿™ä¸ªç³»ç»Ÿï¼Œæˆ‘ä¼šåœ¨é¡¹ç›®åˆæœŸå°±å¼•å…¥å…¨é“¾è·¯å‹æµ‹ï¼Œæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆï¼Œè€Œä¸æ˜¯ç­‰åˆ°ä¸Šçº¿åæ‰å‘ç°é—®é¢˜ã€‚\n","permalink":"http://localhost:1313/projects/pindan-trading-platform/","summary":"\u003cp\u003eåœ¨ç”µå•†ä¸šåŠ¡é«˜é€Ÿå‘å±•çš„èƒŒæ™¯ä¸‹ï¼Œæ‹¼å›¢æ¨¡å¼å› å…¶ç¤¾äº¤è£‚å˜å±æ€§æˆä¸ºæµé‡å¢é•¿çš„åˆ©å™¨ã€‚ä½†çœ‹ä¼¼ç®€å•çš„\u0026quot;å‡‘å¤Ÿ N äººæˆå›¢\u0026quot;èƒŒåï¼Œéšè—ç€åº“å­˜è¶…å–ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€æµ·é‡æ•°æ®å­˜å‚¨ç­‰ä¸€ç³»åˆ—æŠ€æœ¯æŒ‘æˆ˜ã€‚æœ¬æ–‡å¤ç›˜æˆ‘åœ¨æ‹¼å›¢äº¤æ˜“å¹³å°é¡¹ç›®ä¸­çš„æ¶æ„è®¾è®¡ä¸æŠ€æœ¯é€‰å‹æ€è€ƒã€‚\u003c/p\u003e\n\u003ch3 id=\"é¡¹ç›®äº®ç‚¹\"\u003eé¡¹ç›®äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e åŸºäº DDD æ€æƒ³çš„é¢†åŸŸæ¨¡å‹è®¾è®¡ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e Redis åˆ†å¸ƒå¼é” + åˆ†åº“åˆ†è¡¨è§£å†³é«˜å¹¶å‘åº“å­˜æ‰£å‡é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e RabbitMQ å¼‚æ­¥è§£è€¦å®ç°å•æ­¥æµæ°´çº¿ï¼Œæå‡ç³»ç»Ÿååé‡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ShardingSphere åˆ†åº“åˆ†è¡¨æ”¯æ’‘æµ·é‡è®¢å•æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜\"\u003eä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜\u003c/h2\u003e\n\u003cp\u003eæ‹¼å›¢äº¤æ˜“çš„æ ¸å¿ƒæµç¨‹çœ‹ä¼¼ç®€å•ï¼šç”¨æˆ·å‘èµ·æ‹¼å›¢ â†’ å…¶ä»–ç”¨æˆ·å‚å›¢ â†’ è¾¾åˆ°äººæ•°åæˆå›¢ â†’ æ‰£å‡åº“å­˜ â†’ é€šçŸ¥æ”¯ä»˜ã€‚ä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªæµç¨‹ä¼šé‡åˆ°ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåº“å­˜è¶…å–ï¼š\u003c/strong\u003e 100 ä»¶å•†å“ï¼Œ1000 äººåŒæ—¶ä¸‹å•ï¼Œå¦‚ä½•ä¿è¯ä¸ä¼šè¶…å–ï¼Ÿä¼ ç»Ÿçš„æ•°æ®åº“è¡Œé”åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤±æ•ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ†å¸ƒå¼äº‹åŠ¡ï¼š\u003c/strong\u003e è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡ã€æ”¯ä»˜é€šçŸ¥åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæµ·é‡æ•°æ®ï¼š\u003c/strong\u003e è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚ä½•ä¿è¯æŸ¥è¯¢æ€§èƒ½ä¸éšæ•°æ®é‡å¢é•¿è€ŒåŠ£åŒ–ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eè¿™äº›é—®é¢˜å€’é€¼æˆ‘ä»¬å¿…é¡»ä»æ¶æ„å±‚é¢é‡æ–°æ€è€ƒç³»ç»Ÿè®¾è®¡ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¶æ„è®¾è®¡ddd-æ€æƒ³çš„è½åœ°å®è·µ\"\u003eæ¶æ„è®¾è®¡ï¼šDDD æ€æƒ³çš„è½åœ°å®è·µ\u003c/h2\u003e\n\u003cp\u003eä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹ä¼šå¯¼è‡´ Service å±‚é€»è¾‘è‡ƒè‚¿ï¼Œä¸šåŠ¡è§„åˆ™æ•£è½åœ¨å„å¤„ã€‚æˆ‘ä»¬é‡‡ç”¨ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ€æƒ³ï¼Œå°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒé¢†åŸŸï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè®¢å•åŸŸï¼ˆOrderï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£æ‹¼å›¢è®¢å•çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€çŠ¶æ€æµè½¬ã€è¶…æ—¶å–æ¶ˆç­‰ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåº“å­˜åŸŸï¼ˆInventoryï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£å•†å“åº“å­˜çš„æ‰£å‡ã€å›æ»šã€é¢„å ç­‰æ“ä½œï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒç“¶é¢ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ”¯ä»˜åŸŸï¼ˆPaymentï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£æ”¯ä»˜æµç¨‹çš„ç¼–æ’ï¼ŒåŒ…æ‹¬æ”¯ä»˜é€šçŸ¥ã€é€€æ¬¾å¤„ç†ç­‰ã€‚\u003c/p\u003e\n\u003cp\u003eæ¯ä¸ªé¢†åŸŸéƒ½æœ‰è‡ªå·±çš„èšåˆæ ¹ï¼ˆAggregate Rootï¼‰å’Œé¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰ã€‚æ¯”å¦‚è®¢å•åŸŸçš„èšåˆæ ¹æ˜¯ \u003ccode\u003eOrder\u003c/code\u003eï¼Œå®ƒå°è£…äº†è®¢å•çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰å¾…æ”¯ä»˜çŠ¶æ€æ‰èƒ½å–æ¶ˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecancel\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePENDING_PAYMENT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ethrow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderCannotCancelException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eCANCELLED\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼šè®¢å•å·²å–æ¶ˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eDomainEventPublisher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003epublish\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderCancelledEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šä¸šåŠ¡è§„åˆ™å†…èšåœ¨é¢†åŸŸå¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨ Service å±‚çš„å„ç§ if-else é‡Œã€‚å½“äº§å“ç»ç†è¯´\u0026quot;å¢åŠ ä¸€ä¸ªæ‹¼å›¢å¤±è´¥è‡ªåŠ¨é€€æ¬¾çš„é€»è¾‘\u0026quot;æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç›‘å¬ \u003ccode\u003eOrderCancelledEvent\u003c/code\u003e äº‹ä»¶ï¼Œè€Œä¸éœ€è¦æ”¹åŠ¨è®¢å•å–æ¶ˆçš„æ ¸å¿ƒé€»è¾‘ã€‚\u003c/p\u003e","title":"æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿï¼šDDD æ¶æ„ä¸‹çš„åˆ†å¸ƒå¼å®æˆ˜"},{"content":"ThreadLocal æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦å·¥å…·ï¼Œå®ƒä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚ä½†å¾ˆå¤šäººåªçŸ¥é“æ€ä¹ˆç”¨ï¼Œä¸çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œæ›´ä¸çŸ¥é“å®ƒå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚æœ¬æ–‡æ·±å…¥å‰–æ ThreadLocal çš„åº•å±‚æœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ ThreadLocal çš„å®ç°åŸç†ä¸ ThreadLocalMap ç»“æ„ æŒæ¡å¼±å¼•ç”¨çš„è®¾è®¡æ„å›¾ä¸å†…å­˜æ³„æ¼çš„æ ¹å›  å­¦ä¼šåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹æ­£ç¡®ä½¿ç”¨ ThreadLocal äº†è§£ InheritableThreadLocal çš„ä½¿ç”¨åœºæ™¯ ThreadLocal çš„ä½¿ç”¨åœºæ™¯ ThreadLocal å¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\nåœºæ™¯ä¸€ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’\n1public class UserContext { 2 private static final ThreadLocal\u0026lt;User\u0026gt; context = new ThreadLocal\u0026lt;\u0026gt;(); 3 4 public static void setUser(User user) { 5 context.set(user); 6 } 7 8 public static User getUser() { 9 return context.get(); 10 } 11 12 public static void remove() { 13 context.remove(); 14 } 15} 16 17// åœ¨ Controller ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯ 18@RestController 19public class UserController { 20 21 @GetMapping(\u0026#34;/user/info\u0026#34;) 22 public UserDTO getUserInfo() { 23 User user = UserContext.getUser(); 24 return UserDTO.from(user); 25 } 26} åœºæ™¯äºŒï¼šæ•°æ®åº“è¿æ¥ç®¡ç†\n1public class ConnectionManager { 2 private static final ThreadLocal\u0026lt;Connection\u0026gt; connectionHolder = new ThreadLocal\u0026lt;\u0026gt;(); 3 4 public static Connection getConnection() { 5 Connection conn = connectionHolder.get(); 6 if (conn == null) { 7 conn = DriverManager.getConnection(url, user, password); 8 connectionHolder.set(conn); 9 } 10 return conn; 11 } 12 13 public static void closeConnection() { 14 Connection conn = connectionHolder.get(); 15 if (conn != null) { 16 conn.close(); 17 connectionHolder.remove(); 18 } 19 } 20} åœºæ™¯ä¸‰ï¼šSimpleDateFormat çº¿ç¨‹å®‰å…¨\nSimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥ç”¨ ThreadLocal ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºç‹¬ç«‹å®ä¾‹ï¼š\n1public class DateUtil { 2 private static final ThreadLocal\u0026lt;SimpleDateFormat\u0026gt; formatter = 3 ThreadLocal.withInitial(() -\u0026gt; new SimpleDateFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;)); 4 5 public static String format(Date date) { 6 return formatter.get().format(date); 7 } 8} ThreadLocal çš„å®ç°åŸç† ThreadLocalMapï¼šçœŸæ­£çš„å­˜å‚¨ç»“æ„\nThreadLocal æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œæ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡çš„ threadLocals å­—æ®µä¸­ï¼š\n1public class Thread { 2 ThreadLocal.ThreadLocalMap threadLocals = null; 3} ThreadLocalMap æ˜¯ ThreadLocal çš„é™æ€å†…éƒ¨ç±»ï¼Œç±»ä¼¼äº HashMapï¼Œä½†å®ç°æ›´ç®€å•ï¼š\n1static class ThreadLocalMap { 2 3 static class Entry extends WeakReference\u0026lt;ThreadLocal\u0026lt;?\u0026gt;\u0026gt; { 4 Object value; 5 6 Entry(ThreadLocal\u0026lt;?\u0026gt; k, Object v) { 7 super(k); // key æ˜¯å¼±å¼•ç”¨ 8 value = v; 9 } 10 } 11 12 private Entry[] table; 13 private int size = 0; 14 private int threshold; 15} å…³é”®ç‚¹ï¼šEntry çš„ key æ˜¯ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ã€‚\nset æ–¹æ³•çš„å®ç°\n1public void set(T value) { 2 Thread t = Thread.currentThread(); 3 ThreadLocalMap map = getMap(t); 4 if (map != null) { 5 map.set(this, value); 6 } else { 7 createMap(t, value); 8 } 9} 10 11ThreadLocalMap getMap(Thread t) { 12 return t.threadLocals; 13} 14 15void createMap(Thread t, T firstValue) { 16 t.threadLocals = new ThreadLocalMap(this, firstValue); 17} æµç¨‹ï¼š\nè·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¦‚æœ map ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ map å°† ThreadLocal ä½œä¸º keyï¼Œvalue ä½œä¸ºå€¼å­˜å…¥ map get æ–¹æ³•çš„å®ç°\n1public T get() { 2 Thread t = Thread.currentThread(); 3 ThreadLocalMap map = getMap(t); 4 if (map != null) { 5 ThreadLocalMap.Entry e = map.getEntry(this); 6 if (e != null) { 7 return (T) e.value; 8 } 9 } 10 return setInitialValue(); 11} 12 13private T setInitialValue() { 14 T value = initialValue(); // é»˜è®¤è¿”å› null 15 Thread t = Thread.currentThread(); 16 ThreadLocalMap map = getMap(t); 17 if (map != null) { 18 map.set(this, value); 19 } else { 20 createMap(t, value); 21 } 22 return value; 23} æ¶æ„æ€è€ƒï¼š ThreadLocal çš„è®¾è®¡å·§å¦™ä¹‹å¤„åœ¨äºï¼šæ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯ ThreadLocal å¯¹è±¡ä¸­ã€‚è¿™æ ·ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®è‡ªå·±çš„æ•°æ®æ—¶ï¼Œä¸éœ€è¦åŠ é”ï¼Œé¿å…äº†çº¿ç¨‹ç«äº‰ã€‚\nå¼±å¼•ç”¨ï¼šä¸ºä»€ä¹ˆ key æ˜¯å¼±å¼•ç”¨ï¼Ÿ å››ç§å¼•ç”¨ç±»å‹\nå¼ºå¼•ç”¨ï¼šæ™®é€šçš„å¯¹è±¡å¼•ç”¨ï¼Œåªè¦å¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶ è½¯å¼•ç”¨ï¼šå†…å­˜ä¸è¶³æ—¶ä¼šè¢«å›æ”¶ å¼±å¼•ç”¨ï¼šä¸‹æ¬¡ GC æ—¶ä¸€å®šä¼šè¢«å›æ”¶ è™šå¼•ç”¨ï¼šæ— æ³•é€šè¿‡å¼•ç”¨è·å–å¯¹è±¡ï¼Œåªç”¨äºè·Ÿè¸ªå¯¹è±¡è¢«å›æ”¶çš„çŠ¶æ€ ä¸ºä»€ä¹ˆ key æ˜¯å¼±å¼•ç”¨ï¼Ÿ\nå‡è®¾ key æ˜¯å¼ºå¼•ç”¨ï¼š\n1ThreadLocal\u0026lt;User\u0026gt; userThreadLocal = new ThreadLocal\u0026lt;\u0026gt;(); 2userThreadLocal.set(new User()); 3 4// ä¸šåŠ¡ä»£ç ä¸å†ä½¿ç”¨ userThreadLocal 5userThreadLocal = null; æ­¤æ—¶ï¼Œè™½ç„¶ userThreadLocal å˜é‡è¢«ç½®ä¸º nullï¼Œä½† ThreadLocalMap ä¸­çš„ Entry ä»ç„¶æŒæœ‰ ThreadLocal çš„å¼ºå¼•ç”¨ï¼Œå¯¼è‡´ ThreadLocal å¯¹è±¡æ— æ³•è¢«å›æ”¶ã€‚\nå¦‚æœ key æ˜¯å¼±å¼•ç”¨ï¼š\n1userThreadLocal = null; 2// ä¸‹æ¬¡ GC æ—¶ï¼ŒThreadLocal å¯¹è±¡ä¼šè¢«å›æ”¶ 3// ThreadLocalMap ä¸­çš„ Entry çš„ key å˜æˆ null è¿™æ ·ï¼ŒThreadLocal å¯¹è±¡å¯ä»¥è¢«åŠæ—¶å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚\nä½†æ˜¯ï¼Œvalue ä»ç„¶æ˜¯å¼ºå¼•ç”¨ï¼\nå³ä½¿ key è¢«å›æ”¶ï¼Œvalue ä»ç„¶å­˜åœ¨ï¼Œè¿™å°±æ˜¯å†…å­˜æ³„æ¼çš„æ ¹æºã€‚\nå†…å­˜æ³„æ¼ï¼šçº¿ç¨‹æ± ç¯å¢ƒä¸‹çš„é™·é˜± é—®é¢˜åœºæ™¯\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); // å‡è®¾æœ‰ 10 ä¸‡æ¡æ•°æ® 8 cache.set(users); 9 10 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 11 doSomething(users); 12 13 // å¿˜è®°è°ƒç”¨ remove() 14 } 15} åœ¨ Tomcat çº¿ç¨‹æ± ç¯å¢ƒä¸‹ï¼š\nè¯·æ±‚åˆ°è¾¾ï¼Œçº¿ç¨‹æ± åˆ†é…çº¿ç¨‹ A å¤„ç†è¯·æ±‚ çº¿ç¨‹ A æ‰§è¡Œ processUsers()ï¼Œå°† 10 ä¸‡æ¡æ•°æ®å­˜å…¥ ThreadLocal è¯·æ±‚ç»“æŸï¼Œçº¿ç¨‹ A è¿”å›çº¿ç¨‹æ± ï¼Œä½† ThreadLocal ä¸­çš„æ•°æ®æ²¡æœ‰æ¸…ç† ä¸‹æ¬¡è¯·æ±‚å¤ç”¨çº¿ç¨‹ A æ—¶ï¼ŒThreadLocal ä¸­ä»ç„¶ä¿å­˜ç€ä¸Šæ¬¡çš„æ•°æ® éšç€è¯·æ±‚å¢å¤šï¼Œæ¯ä¸ªçº¿ç¨‹çš„ ThreadLocal éƒ½ä¼šç§¯ç´¯å¤§é‡æ•°æ®ï¼Œæœ€ç»ˆå¯¼è‡´ OOMã€‚\nå†…å­˜æ³„æ¼çš„æ ¹å› \n1Thread (å¼ºå¼•ç”¨) 2 â†“ 3ThreadLocalMap (å¼ºå¼•ç”¨) 4 â†“ 5Entry[] (å¼ºå¼•ç”¨) 6 â†“ 7Entry.key (å¼±å¼•ç”¨) â†’ ThreadLocal (å¯èƒ½è¢«å›æ”¶) 8Entry.value (å¼ºå¼•ç”¨) â†’ User List (æ— æ³•è¢«å›æ”¶) å³ä½¿ ThreadLocal å¯¹è±¡è¢«å›æ”¶ï¼Œvalue ä»ç„¶è¢« Entry å¼ºå¼•ç”¨ï¼Œæ— æ³•è¢« GC å›æ”¶ã€‚\næ­£ç¡®çš„ä½¿ç”¨æ–¹å¼\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 try { 8 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 9 cache.set(users); 10 doSomething(users); 11 } finally { 12 cache.remove(); // å¿…é¡»åœ¨ finally ä¸­æ¸…ç† 13 } 14 } 15} ThreadLocal çš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶\nThreadLocalMap åœ¨ setã€getã€remove æ—¶ä¼šè§¦å‘æ¸…ç†ï¼š\n1private int expungeStaleEntry(int staleSlot) { 2 Entry[] tab = table; 3 int len = tab.length; 4 5 // æ¸…ç† key ä¸º null çš„ Entry 6 tab[staleSlot].value = null; 7 tab[staleSlot] = null; 8 size--; 9 10 // ç»§ç»­æ‰«æåç»­çš„ Entry 11 Entry e; 12 int i; 13 for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) { 14 ThreadLocal\u0026lt;?\u0026gt; k = e.get(); 15 if (k == null) { 16 e.value = null; 17 tab[i] = null; 18 size--; 19 } 20 } 21 return i; 22} ä½†è¿™ç§æ¸…ç†æ˜¯è¢«åŠ¨çš„ï¼Œä¸èƒ½å®Œå…¨ä¾èµ–ã€‚æœ€ä½³å®è·µæ˜¯æ‰‹åŠ¨è°ƒç”¨ remove()ã€‚\né¿å‘æç¤ºï¼š åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„ç¯å¢ƒä¸‹ï¼ŒThreadLocal å¿…é¡»åœ¨ finally å—ä¸­è°ƒç”¨ remove()ã€‚å¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼å’Œæ•°æ®æ··ä¹±ï¼ˆä¸‹ä¸€ä¸ªè¯·æ±‚å¯èƒ½è¯»åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚çš„æ•°æ®ï¼‰ã€‚\nInheritableThreadLocalï¼šçˆ¶å­çº¿ç¨‹ä¼ é€’ ThreadLocal çš„æ•°æ®æ— æ³•åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä¼ é€’ï¼š\n1ThreadLocal\u0026lt;String\u0026gt; threadLocal = new ThreadLocal\u0026lt;\u0026gt;(); 2threadLocal.set(\u0026#34;parent\u0026#34;); 3 4new Thread(() -\u0026gt; { 5 System.out.println(threadLocal.get()); // è¾“å‡º null 6}).start(); InheritableThreadLocal è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼š\n1InheritableThreadLocal\u0026lt;String\u0026gt; inheritableThreadLocal = new InheritableThreadLocal\u0026lt;\u0026gt;(); 2inheritableThreadLocal.set(\u0026#34;parent\u0026#34;); 3 4new Thread(() -\u0026gt; { 5 System.out.println(inheritableThreadLocal.get()); // è¾“å‡º parent 6}).start(); å®ç°åŸç†\nThread ç±»æœ‰ä¸¤ä¸ª ThreadLocalMap å­—æ®µï¼š\n1public class Thread { 2 ThreadLocal.ThreadLocalMap threadLocals = null; 3 ThreadLocal.ThreadLocalMap inheritableThreadLocals = null; 4} åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œä¼šå¤åˆ¶çˆ¶çº¿ç¨‹çš„ inheritableThreadLocalsï¼š\n1private void init(ThreadGroup g, Runnable target, String name, long stackSize) { 2 Thread parent = currentThread(); 3 4 if (parent.inheritableThreadLocals != null) { 5 this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); 6 } 7} æ³¨æ„äº‹é¡¹\nInheritableThreadLocal åªåœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶å¤åˆ¶æ•°æ®ï¼Œå¦‚æœä½¿ç”¨çº¿ç¨‹æ± ï¼Œå­çº¿ç¨‹ä¼šè¢«å¤ç”¨ï¼Œæ•°æ®ä¸ä¼šæ›´æ–°ã€‚\nè§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨é˜¿é‡Œå¼€æºçš„ TransmittableThreadLocalï¼ˆTTLï¼‰ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šæ’æŸ¥ ThreadLocal å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOMã€‚é€šè¿‡ MAT åˆ†æ Heap Dumpï¼Œå‘ç°å¤§é‡ ThreadLocalMap.Entry å¯¹è±¡ã€‚\næ’æŸ¥æ­¥éª¤\næŸ¥çœ‹ Dominator Treeï¼Œå‘ç° Thread å¯¹è±¡å ç”¨äº†å¤§é‡å†…å­˜ å±•å¼€ Thread å¯¹è±¡ï¼Œå‘ç° threadLocals å­—æ®µä¸­æœ‰å¤§é‡ Entry æŸ¥çœ‹ Entry çš„ valueï¼Œå‘ç°æ˜¯ä¸šåŠ¡å¯¹è±¡ï¼ˆUser Listï¼‰ é€šè¿‡å¼•ç”¨é“¾æ‰¾åˆ°åˆ›å»º ThreadLocal çš„ä»£ç ä½ç½® ä¿®å¤æ–¹æ¡ˆ\nåœ¨æ‰€æœ‰ä½¿ç”¨ ThreadLocal çš„åœ°æ–¹ï¼Œæ·»åŠ  finally å—è°ƒç”¨ remove()ï¼š\n1try { 2 threadLocal.set(value); 3 // ä¸šåŠ¡é€»è¾‘ 4} finally { 5 threadLocal.remove(); 6} é¢„é˜²æªæ–½\nCode Review é‡ç‚¹å…³æ³¨ ThreadLocal çš„ä½¿ç”¨ ä½¿ç”¨ Alibaba Java Coding Guidelines æ’ä»¶ï¼Œè‡ªåŠ¨æ£€æµ‹ ThreadLocal æœªè°ƒç”¨ remove() åœ¨å•å…ƒæµ‹è¯•ä¸­æ¨¡æ‹Ÿçº¿ç¨‹æ± ç¯å¢ƒï¼Œæ£€æµ‹å†…å­˜æ³„æ¼ æ€»ç»“ä¸æ€è€ƒ ThreadLocal çš„æ ¸å¿ƒåŸç†ï¼š\næ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡çš„ ThreadLocalMap ä¸­ key æ˜¯ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ å¼±å¼•ç”¨è®¾è®¡é¿å…äº† ThreadLocal å¯¹è±¡çš„å†…å­˜æ³„æ¼ï¼Œä½† value ä»å¯èƒ½æ³„æ¼ ä½¿ç”¨ ThreadLocal çš„æœ€ä½³å®è·µï¼š\nåœ¨ finally å—ä¸­è°ƒç”¨ remove() é¿å…å­˜å‚¨å¤§å¯¹è±¡ ä½¿ç”¨ try-with-resources æ¨¡å¼å°è£… ThreadLocal ä¸‹æ¬¡å½“ä½ ä½¿ç”¨ ThreadLocal æ—¶ï¼Œè®°å¾—é—®è‡ªå·±ï¼šæˆ‘åœ¨ finally ä¸­è°ƒç”¨ remove() äº†å—ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/02/threadlocal-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eThreadLocal æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦å·¥å…·ï¼Œå®ƒä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚ä½†å¾ˆå¤šäººåªçŸ¥é“æ€ä¹ˆç”¨ï¼Œä¸çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œæ›´ä¸çŸ¥é“å®ƒå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚æœ¬æ–‡æ·±å…¥å‰–æ ThreadLocal çš„åº•å±‚æœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ ThreadLocal çš„å®ç°åŸç†ä¸ ThreadLocalMap ç»“æ„\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å¼±å¼•ç”¨çš„è®¾è®¡æ„å›¾ä¸å†…å­˜æ³„æ¼çš„æ ¹å› \u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹æ­£ç¡®ä½¿ç”¨ ThreadLocal\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ InheritableThreadLocal çš„ä½¿ç”¨åœºæ™¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"threadlocal-çš„ä½¿ç”¨åœºæ™¯\"\u003eThreadLocal çš„ä½¿ç”¨åœºæ™¯\u003c/h2\u003e\n\u003cp\u003eThreadLocal å¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserContext\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efinal\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadLocal\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadLocal\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003esetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// åœ¨ Controller ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@RestController\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserController\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@GetMapping\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/user/info\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserDTO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUserInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserDTO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šæ•°æ®åº“è¿æ¥ç®¡ç†\u003c/strong\u003e\u003c/p\u003e","title":"ThreadLocal åŸç†ä¸å†…å­˜æ³„æ¼æ’æŸ¥å®æˆ˜"},{"content":"å¼€å§‹å†™åšå®¢ é‚£æ˜¯ä¸€æ¡ç¥å¥‡çš„å¤©è·¯å•Š ğŸµ\nä»Šå¤©å¼€å§‹äº†æˆ‘çš„åšå®¢ä¹‹æ—…ï¼Œå¸Œæœ›èƒ½åœ¨è¿™é‡Œè®°å½•ä¸‹ï¼š\nğŸ’¡ æŠ€æœ¯å­¦ä¹ çš„å¿ƒå¾— ğŸš€ é¡¹ç›®å¼€å‘çš„ç»éªŒ ğŸ“– è¯»ä¹¦æ€è€ƒçš„æ€»ç»“ ğŸŒŸ ç”Ÿæ´»ä¸­çš„æ„Ÿæ‚Ÿ ä¸ºä»€ä¹ˆå†™åšå®¢ å†™åšå®¢ä¸ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯ï¼š\næ•´ç†æ€è·¯ï¼šé€šè¿‡å†™ä½œæ¢³ç†çŸ¥è¯†ä½“ç³» æ·±åŒ–ç†è§£ï¼šæ•™æ˜¯æœ€å¥½çš„å­¦ åˆ†äº«äº¤æµï¼šä¸ä»–äººäº¤æµæƒ³æ³• è®°å½•æˆé•¿ï¼šè§è¯è‡ªå·±çš„è¿›æ­¥ æœªæ¥è®¡åˆ’ æ¥ä¸‹æ¥æˆ‘ä¼šåˆ†äº«æ›´å¤šå…³äºæŠ€æœ¯å’Œç”Ÿæ´»çš„å†…å®¹ï¼Œæ•¬è¯·æœŸå¾…ï¼\n\u0026ldquo;The journey of a thousand miles begins with one step.\u0026rdquo; - è€å­\n","permalink":"http://localhost:1313/posts/2024/02/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0/","summary":"\u003ch2 id=\"å¼€å§‹å†™åšå®¢\"\u003eå¼€å§‹å†™åšå®¢\u003c/h2\u003e\n\u003cp\u003eé‚£æ˜¯ä¸€æ¡ç¥å¥‡çš„å¤©è·¯å•Š ğŸµ\u003c/p\u003e\n\u003cp\u003eä»Šå¤©å¼€å§‹äº†æˆ‘çš„åšå®¢ä¹‹æ—…ï¼Œå¸Œæœ›èƒ½åœ¨è¿™é‡Œè®°å½•ä¸‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eğŸ’¡ æŠ€æœ¯å­¦ä¹ çš„å¿ƒå¾—\u003c/li\u003e\n\u003cli\u003eğŸš€ é¡¹ç›®å¼€å‘çš„ç»éªŒ\u003c/li\u003e\n\u003cli\u003eğŸ“– è¯»ä¹¦æ€è€ƒçš„æ€»ç»“\u003c/li\u003e\n\u003cli\u003eğŸŒŸ ç”Ÿæ´»ä¸­çš„æ„Ÿæ‚Ÿ\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆå†™åšå®¢\"\u003eä¸ºä»€ä¹ˆå†™åšå®¢\u003c/h2\u003e\n\u003cp\u003eå†™åšå®¢ä¸ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæ•´ç†æ€è·¯\u003c/strong\u003eï¼šé€šè¿‡å†™ä½œæ¢³ç†çŸ¥è¯†ä½“ç³»\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ·±åŒ–ç†è§£\u003c/strong\u003eï¼šæ•™æ˜¯æœ€å¥½çš„å­¦\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåˆ†äº«äº¤æµ\u003c/strong\u003eï¼šä¸ä»–äººäº¤æµæƒ³æ³•\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè®°å½•æˆé•¿\u003c/strong\u003eï¼šè§è¯è‡ªå·±çš„è¿›æ­¥\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"æœªæ¥è®¡åˆ’\"\u003eæœªæ¥è®¡åˆ’\u003c/h2\u003e\n\u003cp\u003eæ¥ä¸‹æ¥æˆ‘ä¼šåˆ†äº«æ›´å¤šå…³äºæŠ€æœ¯å’Œç”Ÿæ´»çš„å†…å®¹ï¼Œæ•¬è¯·æœŸå¾…ï¼\u003c/p\u003e\n\u003chr\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u0026ldquo;The journey of a thousand miles begins with one step.\u0026rdquo; - è€å­\u003c/p\u003e\n\u003c/blockquote\u003e","title":"æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢æ–‡ç« "},{"content":"åœ¨ Java å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ ¸å¿ƒæœºåˆ¶ã€‚ä»æœ€æ—©çš„ synchronized åˆ° JDK 1.5 å¼•å…¥çš„ AQS æ¡†æ¶ï¼ŒJava çš„é”æœºåˆ¶ç»å†äº†å·¨å¤§çš„æ¼”è¿›ã€‚ç†è§£è¿™ä¸ªæ¼”è¿›è¿‡ç¨‹ï¼Œæ˜¯æŒæ¡ Java å¹¶å‘ç¼–ç¨‹çš„å…³é”®ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ synchronized çš„é”å‡çº§è¿‡ç¨‹ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼‰ æŒæ¡ AQS çš„æ ¸å¿ƒåŸç†ä¸åº”ç”¨åœºæ™¯ å­¦ä¼šé€‰æ‹© ReentrantLock è¿˜æ˜¯ synchronized äº†è§£ CAS æ“ä½œä¸è‡ªæ—‹é”çš„å®ç° synchronizedï¼šä»é‡é‡çº§åˆ°è½»é‡çº§ åœ¨ JDK 1.6 ä¹‹å‰ï¼Œsynchronized æ˜¯é‡é‡çº§é”ï¼Œæ¯æ¬¡åŠ é”éƒ½éœ€è¦æ“ä½œç³»ç»Ÿçš„ mutex äº’æ–¥é‡ï¼Œæ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\nJDK 1.6 å¯¹ synchronized è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œå¼•å…¥äº†é”å‡çº§æœºåˆ¶ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”ã€‚\nå¯¹è±¡å¤´ï¼šé”ä¿¡æ¯çš„å­˜å‚¨ä½ç½®\nJava å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……ã€‚é”ä¿¡æ¯å­˜å‚¨åœ¨å¯¹è±¡å¤´çš„ Mark Word ä¸­ã€‚\nMark Word çš„ç»“æ„ï¼ˆ64 ä½ JVMï¼‰ï¼š\n1|--------------------------------------------------------------| 2| é”çŠ¶æ€ | 25bit | 31bit | 1bit | 4bit | 1bitåå‘é” | 2bité”æ ‡å¿— | 3|--------------------------------------------------------------| 4| æ— é” | unused | hashcode | unused | age | 0 | 01 | 5| åå‘é” | ThreadID | Epoch | unused | age | 1 | 01 | 6| è½»é‡çº§é” | æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ | 00 | 7| é‡é‡çº§é” | æŒ‡å‘äº’æ–¥é‡çš„æŒ‡é’ˆ | 10 | åå‘é”ï¼šå•çº¿ç¨‹åœºæ™¯çš„ä¼˜åŒ–\nå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–ã€‚åå‘é”çš„æ€æƒ³æ˜¯ï¼šç¬¬ä¸€æ¬¡è·å–é”æ—¶ï¼Œåœ¨å¯¹è±¡å¤´ä¸­è®°å½•çº¿ç¨‹ IDï¼Œåç»­è¯¥çº¿ç¨‹å†æ¬¡è·å–é”æ—¶ï¼Œåªéœ€è¦åˆ¤æ–­ Mark Word ä¸­çš„çº¿ç¨‹ ID æ˜¯å¦æ˜¯è‡ªå·±ï¼Œæ— éœ€ CAS æ“ä½œã€‚\n1public class BiasedLockDemo { 2 private static Object lock = new Object(); 3 4 public static void main(String[] args) { 5 // ç¬¬ä¸€æ¬¡åŠ é”ï¼šå‡çº§ä¸ºåå‘é” 6 synchronized (lock) { 7 System.out.println(\u0026#34;ç¬¬ä¸€æ¬¡åŠ é”\u0026#34;); 8 } 9 10 // ç¬¬äºŒæ¬¡åŠ é”ï¼šç›´æ¥è·å–åå‘é”ï¼Œæ— éœ€ CAS 11 synchronized (lock) { 12 System.out.println(\u0026#34;ç¬¬äºŒæ¬¡åŠ é”\u0026#34;); 13 } 14 } 15} åå‘é”çš„æ’¤é”€ï¼šå½“å…¶ä»–çº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œåå‘é”ä¼šæ’¤é”€ï¼Œå‡çº§ä¸ºè½»é‡çº§é”ã€‚\nè½»é‡çº§é”ï¼šå¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡Œçš„ä¼˜åŒ–\nå½“æœ‰ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿è·å–é”ï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä½¿ç”¨è½»é‡çº§é”ã€‚è½»é‡çº§é”é€šè¿‡ CAS æ“ä½œå°† Mark Word æ›¿æ¢ä¸ºæŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆã€‚\n1// çº¿ç¨‹ A 2synchronized (lock) { 3 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 4} 5 6// çº¿ç¨‹ Bï¼ˆåœ¨ A é‡Šæ”¾é”åæ‰è·å–ï¼‰ 7synchronized (lock) { 8 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 9} è½»é‡çº§é”çš„åŠ é”æµç¨‹ï¼š\nåœ¨æ ˆå¸§ä¸­åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰ å°†å¯¹è±¡å¤´çš„ Mark Word å¤åˆ¶åˆ°é”è®°å½•ä¸­ é€šè¿‡ CAS å°†å¯¹è±¡å¤´çš„ Mark Word æ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆ å¦‚æœ CAS æˆåŠŸï¼Œè·å–é”ï¼›å¦‚æœå¤±è´¥ï¼Œè‡ªæ—‹é‡è¯• é‡é‡çº§é”ï¼šå¤šçº¿ç¨‹ç«äº‰çš„æœ€ç»ˆæ–¹æ¡ˆ\nå½“è‡ªæ—‹æ¬¡æ•°è¿‡å¤šï¼ˆé»˜è®¤ 10 æ¬¡ï¼‰ï¼Œæˆ–è€…æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰é”ï¼Œè½»é‡çº§é”ä¼šå‡çº§ä¸ºé‡é‡çº§é”ã€‚é‡é‡çº§é”ä¼šé˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œé€šè¿‡æ“ä½œç³»ç»Ÿçš„ mutex å®ç°ã€‚\n1// å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰ 2for (int i = 0; i \u0026lt; 10; i++) { 3 new Thread(() -\u0026gt; { 4 synchronized (lock) { 5 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 6 } 7 }).start(); 8} æ¶æ„æ€è€ƒï¼š synchronized çš„é”å‡çº§ä½“ç°äº†\u0026quot;é€‚åº”æ€§ä¼˜åŒ–\u0026quot;çš„æ€æƒ³ã€‚åœ¨ä¸åŒçš„ç«äº‰åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ä¸åŒçš„é”å®ç°ï¼Œåœ¨æ€§èƒ½å’Œæ­£ç¡®æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ MySQL çš„è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ã€JVM çš„åˆ†å±‚ç¼–è¯‘ã€‚\nAQSï¼šå¹¶å‘å·¥å…·çš„åŸºçŸ³ AQSï¼ˆAbstractQueuedSynchronizerï¼‰æ˜¯ JDK 1.5 å¼•å…¥çš„å¹¶å‘æ¡†æ¶ï¼ŒReentrantLockã€Semaphoreã€CountDownLatch ç­‰å·¥å…·éƒ½åŸºäº AQS å®ç°ã€‚\nAQS çš„æ ¸å¿ƒæ€æƒ³\nAQS ç»´æŠ¤äº†ä¸€ä¸ª volatile int state å˜é‡å’Œä¸€ä¸ª FIFO é˜Ÿåˆ—ã€‚\nstateï¼šè¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼ˆ0 è¡¨ç¤ºæœªé”å®šï¼Œ1 è¡¨ç¤ºå·²é”å®šï¼‰ FIFO é˜Ÿåˆ—ï¼šå­˜å‚¨ç­‰å¾…è·å–é”çš„çº¿ç¨‹ ç‹¬å æ¨¡å¼ï¼šReentrantLock çš„å®ç°\nReentrantLock çš„åŠ é”æµç¨‹ï¼š\n1public class ReentrantLock { 2 3 private final Sync sync; 4 5 public void lock() { 6 sync.acquire(1); 7 } 8 9 abstract static class Sync extends AbstractQueuedSynchronizer { 10 11 final boolean tryAcquire(int acquires) { 12 final Thread current = Thread.currentThread(); 13 int c = getState(); 14 15 // å¦‚æœ state == 0ï¼Œè¯´æ˜é”æœªè¢«å ç”¨ 16 if (c == 0) { 17 if (compareAndSetState(0, acquires)) { 18 setExclusiveOwnerThread(current); 19 return true; 20 } 21 } 22 // å¦‚æœæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é”ï¼Œæ”¯æŒé‡å…¥ 23 else if (current == getExclusiveOwnerThread()) { 24 int nextc = c + acquires; 25 setState(nextc); 26 return true; 27 } 28 return false; 29 } 30 } 31} å¦‚æœ tryAcquire å¤±è´¥ï¼Œçº¿ç¨‹ä¼šè¢«åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼š\n1private Node addWaiter(Node mode) { 2 Node node = new Node(Thread.currentThread(), mode); 3 Node pred = tail; 4 5 // å¿«é€Ÿå°è¯•åœ¨é˜Ÿå°¾æ·»åŠ  6 if (pred != null) { 7 node.prev = pred; 8 if (compareAndSetTail(pred, node)) { 9 pred.next = node; 10 return node; 11 } 12 } 13 14 // å¦‚æœå¤±è´¥ï¼Œé€šè¿‡è‡ªæ—‹æ·»åŠ  15 enq(node); 16 return node; 17} ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å«çº¿ç¨‹å¼•ç”¨å’Œç­‰å¾…çŠ¶æ€ã€‚\nå…±äº«æ¨¡å¼ï¼šSemaphore çš„å®ç°\nSemaphore å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®èµ„æºï¼Œé€šè¿‡ state è¡¨ç¤ºå¯ç”¨è®¸å¯æ•°ã€‚\n1public class Semaphore { 2 3 private final Sync sync; 4 5 public void acquire() throws InterruptedException { 6 sync.acquireSharedInterruptibly(1); 7 } 8 9 abstract static class Sync extends AbstractQueuedSynchronizer { 10 11 final int tryAcquireShared(int acquires) { 12 for (;;) { 13 int available = getState(); 14 int remaining = available - acquires; 15 16 // å¦‚æœè®¸å¯ä¸è¶³ï¼Œè¿”å›è´Ÿæ•° 17 if (remaining \u0026lt; 0) { 18 return remaining; 19 } 20 21 // é€šè¿‡ CAS æ‰£å‡è®¸å¯ 22 if (compareAndSetState(available, remaining)) { 23 return remaining; 24 } 25 } 26 } 27 } 28} å…±äº«æ¨¡å¼ä¸‹ï¼Œé‡Šæ”¾é”æ—¶ä¼šå”¤é†’é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚\né¿å‘æç¤ºï¼š AQS çš„ state æ˜¯ volatile çš„ï¼Œä¿è¯äº†å¯è§æ€§ï¼Œä½†ä¸ä¿è¯åŸå­æ€§ã€‚æ‰€ä»¥ä¿®æ”¹ state æ—¶å¿…é¡»ä½¿ç”¨ CAS æ“ä½œã€‚\nReentrantLock vs synchronized åŠŸèƒ½å¯¹æ¯”\nç‰¹æ€§ synchronized ReentrantLock é”çš„å®ç° JVM å±‚é¢ JDK å±‚é¢ å¯é‡å…¥æ€§ æ”¯æŒ æ”¯æŒ å…¬å¹³é” ä¸æ”¯æŒ æ”¯æŒ å¯ä¸­æ–­ ä¸æ”¯æŒ æ”¯æŒ è¶…æ—¶è·å– ä¸æ”¯æŒ æ”¯æŒ æ¡ä»¶å˜é‡ å•ä¸ªï¼ˆwait/notifyï¼‰ å¤šä¸ªï¼ˆConditionï¼‰ æ€§èƒ½å¯¹æ¯”\nåœ¨ JDK 1.6 ä¹‹åï¼Œsynchronized ç»è¿‡ä¼˜åŒ–ï¼Œæ€§èƒ½å·²ç»å’Œ ReentrantLock ç›¸å½“ã€‚åœ¨ä½ç«äº‰åœºæ™¯ä¸‹ï¼Œsynchronized ç”šè‡³æ›´å¿«ï¼ˆå› ä¸ºæœ‰é”æ¶ˆé™¤å’Œé”ç²—åŒ–ä¼˜åŒ–ï¼‰ã€‚\nä½¿ç”¨å»ºè®®\nä¼˜å…ˆä½¿ç”¨ synchronizedï¼šä»£ç ç®€æ´ï¼ŒJVM ä¼šè‡ªåŠ¨ä¼˜åŒ– éœ€è¦é«˜çº§ç‰¹æ€§æ—¶ä½¿ç”¨ ReentrantLockï¼šå…¬å¹³é”ã€å¯ä¸­æ–­ã€è¶…æ—¶è·å– å®æˆ˜æ¡ˆä¾‹ï¼šå¯ä¸­æ–­é”\n1public class InterruptibleLockDemo { 2 3 private final ReentrantLock lock = new ReentrantLock(); 4 5 public void doWork() throws InterruptedException { 6 // å¯ä¸­æ–­åœ°è·å–é” 7 lock.lockInterruptibly(); 8 try { 9 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 10 Thread.sleep(10000); 11 } finally { 12 lock.unlock(); 13 } 14 } 15 16 public static void main(String[] args) throws InterruptedException { 17 InterruptibleLockDemo demo = new InterruptibleLockDemo(); 18 19 Thread t1 = new Thread(() -\u0026gt; { 20 try { 21 demo.doWork(); 22 } catch (InterruptedException e) { 23 System.out.println(\u0026#34;çº¿ç¨‹è¢«ä¸­æ–­\u0026#34;); 24 } 25 }); 26 27 t1.start(); 28 Thread.sleep(1000); 29 t1.interrupt(); // ä¸­æ–­çº¿ç¨‹ 30 } 31} å¦‚æœä½¿ç”¨ synchronizedï¼Œçº¿ç¨‹æ— æ³•è¢«ä¸­æ–­ï¼Œåªèƒ½ç­‰å¾…é”é‡Šæ”¾ã€‚\nCAS ä¸è‡ªæ—‹é” CASï¼ˆCompare And Swapï¼‰æ˜¯å®ç°æ— é”å¹¶å‘çš„åŸºç¡€ã€‚\nCAS çš„åŸç†\nCAS åŒ…å«ä¸‰ä¸ªæ“ä½œæ•°ï¼šå†…å­˜ä½ç½® Vã€é¢„æœŸå€¼ Aã€æ–°å€¼ Bã€‚åªæœ‰å½“ V çš„å€¼ç­‰äº A æ—¶ï¼Œæ‰ä¼šå°† V æ›´æ–°ä¸º Bã€‚\n1public class AtomicInteger { 2 3 private volatile int value; 4 5 public final boolean compareAndSet(int expect, int update) { 6 return unsafe.compareAndSwapInt(this, valueOffset, expect, update); 7 } 8 9 public final int incrementAndGet() { 10 for (;;) { 11 int current = get(); 12 int next = current + 1; 13 if (compareAndSet(current, next)) { 14 return next; 15 } 16 } 17 } 18} CAS çš„ä¼˜åŠ¿ï¼šæ— éœ€åŠ é”ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\nCAS çš„é—®é¢˜ï¼š\nABA é—®é¢˜ï¼šå€¼ä» A å˜æˆ Bï¼Œå†å˜å› Aï¼ŒCAS æ— æ³•æ„ŸçŸ¥ è‡ªæ—‹å¼€é”€ï¼šå¦‚æœé•¿æ—¶é—´ CAS å¤±è´¥ï¼Œä¼šæµªè´¹ CPU åªèƒ½ä¿è¯å•ä¸ªå˜é‡çš„åŸå­æ€§ è‡ªæ—‹é”çš„å®ç°\n1public class SpinLock { 2 3 private AtomicReference\u0026lt;Thread\u0026gt; owner = new AtomicReference\u0026lt;\u0026gt;(); 4 5 public void lock() { 6 Thread current = Thread.currentThread(); 7 // è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ° CAS æˆåŠŸ 8 while (!owner.compareAndSet(null, current)) { 9 } 10 } 11 12 public void unlock() { 13 Thread current = Thread.currentThread(); 14 owner.compareAndSet(current, null); 15 } 16} è‡ªæ—‹é”é€‚åˆé”æŒæœ‰æ—¶é—´å¾ˆçŸ­çš„åœºæ™¯ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡çš„å¼€é”€ã€‚\næ€»ç»“ä¸æ€è€ƒ Java é”æœºåˆ¶çš„æ¼”è¿›ä½“ç°äº†æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€æƒ³ï¼šåœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ã€‚\nsynchronizedï¼šä»é‡é‡çº§é”ä¼˜åŒ–ä¸ºé”å‡çº§æœºåˆ¶ï¼Œé€‚åº”ä¸åŒç«äº‰åœºæ™¯ AQSï¼šæä¾›äº†çµæ´»çš„å¹¶å‘å·¥å…·æ¡†æ¶ï¼Œæ”¯æŒç‹¬å å’Œå…±äº«æ¨¡å¼ CASï¼šæ— é”å¹¶å‘çš„åŸºç¡€ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡ ç†è§£è¿™äº›æœºåˆ¶ï¼Œæ‰èƒ½åœ¨å®é™…å¼€å‘ä¸­é€‰æ‹©åˆé€‚çš„å¹¶å‘å·¥å…·ï¼Œå†™å‡ºé«˜æ€§èƒ½çš„å¹¶å‘ä»£ç ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åŠ é”æ—¶ï¼Œä¸å¦¨æƒ³æƒ³ï¼šè¿™ä¸ªåœºæ™¯é€‚åˆ synchronized è¿˜æ˜¯ ReentrantLockï¼Ÿæ˜¯å¦å¯ä»¥ç”¨ CAS å®ç°æ— é”å¹¶å‘ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/01/java-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%BB%8E-synchronized-%E5%88%B0-aqs-%E7%9A%84%E6%BC%94%E8%BF%9B/","summary":"\u003cp\u003eåœ¨ Java å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ ¸å¿ƒæœºåˆ¶ã€‚ä»æœ€æ—©çš„ synchronized åˆ° JDK 1.5 å¼•å…¥çš„ AQS æ¡†æ¶ï¼ŒJava çš„é”æœºåˆ¶ç»å†äº†å·¨å¤§çš„æ¼”è¿›ã€‚ç†è§£è¿™ä¸ªæ¼”è¿›è¿‡ç¨‹ï¼Œæ˜¯æŒæ¡ Java å¹¶å‘ç¼–ç¨‹çš„å…³é”®ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ synchronized çš„é”å‡çº§è¿‡ç¨‹ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼‰\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ AQS çš„æ ¸å¿ƒåŸç†ä¸åº”ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé€‰æ‹© ReentrantLock è¿˜æ˜¯ synchronized\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ CAS æ“ä½œä¸è‡ªæ—‹é”çš„å®ç°\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"synchronizedä»é‡é‡çº§åˆ°è½»é‡çº§\"\u003esynchronizedï¼šä»é‡é‡çº§åˆ°è½»é‡çº§\u003c/h2\u003e\n\u003cp\u003eåœ¨ JDK 1.6 ä¹‹å‰ï¼Œsynchronized æ˜¯é‡é‡çº§é”ï¼Œæ¯æ¬¡åŠ é”éƒ½éœ€è¦æ“ä½œç³»ç»Ÿçš„ mutex äº’æ–¥é‡ï¼Œæ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\u003c/p\u003e\n\u003cp\u003eJDK 1.6 å¯¹ synchronized è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œå¼•å…¥äº†é”å‡çº§æœºåˆ¶ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå¯¹è±¡å¤´ï¼šé”ä¿¡æ¯çš„å­˜å‚¨ä½ç½®\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eJava å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……ã€‚é”ä¿¡æ¯å­˜å‚¨åœ¨å¯¹è±¡å¤´çš„ Mark Word ä¸­ã€‚\u003c/p\u003e\n\u003cp\u003eMark Word çš„ç»“æ„ï¼ˆ64 ä½ JVMï¼‰ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e|--------------------------------------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e| é”çŠ¶æ€   | 25bit | 31bit | 1bit | 4bit | 1bitåå‘é” | 2bité”æ ‡å¿— |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e|--------------------------------------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e| æ— é”     | unused | hashcode | unused | age | 0 | 01 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e| åå‘é”   | ThreadID | Epoch | unused | age | 1 | 01 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e| è½»é‡çº§é” | æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ | 00 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e| é‡é‡çº§é” | æŒ‡å‘äº’æ–¥é‡çš„æŒ‡é’ˆ | 10 |\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåå‘é”ï¼šå•çº¿ç¨‹åœºæ™¯çš„ä¼˜åŒ–\u003c/strong\u003e\u003c/p\u003e","title":"Java å¹¶å‘ç¼–ç¨‹ï¼šä» synchronized åˆ° AQS çš„æ¼”è¿›"},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"ä½ å¥½ï¼Œæˆ‘æ˜¯ wawayu ä¸€åä¸“æ³¨äºåˆ†å¸ƒå¼ç³»ç»Ÿå’Œé«˜å¹¶å‘æ¶æ„çš„ Java åç«¯å¼€å‘å·¥ç¨‹å¸ˆã€‚æˆ‘çƒ­è¡·äºç”¨æŠ€æœ¯è§£å†³å®é™…ä¸šåŠ¡é—®é¢˜ï¼Œæ“…é•¿ä» 0 åˆ° 1 è®¾è®¡å’Œå®ç°å¤æ‚ç³»ç»Ÿã€‚\nç›®å‰åœ¨æŸæ˜•ç½‘ç»œç§‘æŠ€å…¬å¸æ‹…ä»» Java å¼€å‘å®ä¹ ç”Ÿï¼Œè´Ÿè´£å¿«é€Ÿè¿­ä»£ä¸äº¤ä»˜ 20+ ä¸ªå®šåˆ¶åŒ–é¡¹ç›®ï¼Œç§¯ç´¯äº†ä¸°å¯Œçš„ä¸šåŠ¡å¼€å‘å’Œç³»ç»Ÿä¼˜åŒ–ç»éªŒã€‚\næˆ‘çš„æŠ€æœ¯ç†å¿µ ä»£ç æ˜¯å†™ç»™äººçœ‹çš„ï¼Œé¡ºä¾¿è®©æœºå™¨æ‰§è¡Œ æ¶æ„è®¾è®¡è¦é€‚é…ä¸šåŠ¡å¤æ‚åº¦ï¼Œé¿å…è¿‡åº¦è®¾è®¡ æ€§èƒ½ä¼˜åŒ–è¦åŸºäºæ•°æ®é©±åŠ¨ï¼Œè€Œä¸æ˜¯å‡­æ„Ÿè§‰ æŠ€æœ¯çš„æœ¬è´¨æ˜¯è§£å†³é—®é¢˜ï¼Œè€Œä¸æ˜¯ç‚«æŠ€ æ•™è‚²èƒŒæ™¯ å¤ªåŸç†å·¥å¤§å­¦ - è½¯ä»¶å·¥ç¨‹ï¼ˆåŒä¸€æµï¼‰ - æœ¬ç§‘ (2022.09 - 2026.06) å·¥ä½œç»å† æŸæ˜•ç½‘ç»œç§‘æŠ€å…¬å¸ - Java å¼€å‘å®ä¹ ç”Ÿ (2024.06 - 2024.12)\nè´Ÿè´£å¿«é€Ÿå¼€å‘ä¸äº¤ä»˜ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¸»åŠ¨æ•´ç†é€šç”¨ä»£ç æ¨¡ç‰ˆï¼Œå‡å°‘äº†é‡å¤ CRUD å·¥ä½œï¼Œé…åˆå›¢é˜Ÿé«˜æ•ˆäº¤ä»˜äº† 20+ ä¸ªå®šåˆ¶åŒ–é¡¹ç›®ã€‚\næ ¸å¿ƒæˆæœï¼š\nè®¾è®¡å¹¶å®ç°åŠ¨æ€çº¿ç¨‹æ±  SDKï¼Œæ”¯æŒå‚æ•°å®æ—¶è°ƒæ•´å’Œå¯è§†åŒ–ç›‘æ§ å‚ä¸æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿå¼€å‘ï¼Œè´Ÿè´£ DDD æ¶æ„è®¾è®¡å’Œåˆ†å¸ƒå¼é”ä¼˜åŒ– ä¼˜åŒ–æ ¸å¿ƒæ¥å£æ€§èƒ½ï¼ŒRT ä» 800ms é™ä½åˆ° 120ms æŠ€æœ¯ä¸“é•¿ è¯¦è§ æŠ€èƒ½æ ˆ\né¡¹ç›®ä½œå“ è¯¦è§ é¡¹ç›®å±•ç¤º\nå¼€æºè´¡çŒ® æ­£åœ¨ç­¹å¤‡ä¸­ï¼Œè®¡åˆ’å¼€æºåŠ¨æ€çº¿ç¨‹æ±  SDK å’Œä¸€äº›å®ç”¨å·¥å…·åº“ã€‚\nè”ç³»æ–¹å¼ Email: your-email@example.com GitHub: github.com/wawayu-dev åšå®¢: ä½ æ­£åœ¨æµè§ˆçš„è¿™ä¸ªç«™ç‚¹ å…³äºè¿™ä¸ªåšå®¢ è¿™ä¸ªåšå®¢æ˜¯æˆ‘çš„æŠ€æœ¯ç¬”è®°å’Œæ€è€ƒæ²‰æ·€çš„åœ°æ–¹ã€‚æˆ‘ä¼šåœ¨è¿™é‡Œåˆ†äº«ï¼š\né¡¹ç›®å®æˆ˜ç»éªŒå’Œè¸©å‘è®°å½• æŠ€æœ¯åŸç†çš„æ·±åº¦å‰–æ æ¶æ„è®¾è®¡çš„æ€è€ƒä¸å®è·µ å­¦ä¹ æ–¹æ³•å’Œæˆé•¿å¿ƒå¾— å¦‚æœä½ å¯¹æŸä¸ªè¯é¢˜æ„Ÿå…´è¶£ï¼Œæˆ–è€…å‘ç°æ–‡ç« ä¸­çš„é—®é¢˜ï¼Œæ¬¢è¿é€šè¿‡é‚®ä»¶æˆ– GitHub ä¸æˆ‘äº¤æµã€‚\nè¿™ä¸ªç½‘ç«™ä½¿ç”¨ Hugo + PaperMod æ­å»ºï¼Œæ‰˜ç®¡åœ¨ GitHub Pages\n","permalink":"http://localhost:1313/about/","summary":"Java åç«¯å¼€å‘å·¥ç¨‹å¸ˆ | åˆ†å¸ƒå¼ç³»ç»Ÿå®è·µè€…","title":"å…³äºæˆ‘"},{"content":"ç¼–ç¨‹è¯­è¨€ è¯­è¨€ ç†Ÿç»ƒåº¦ ä¸»è¦ç”¨é€” Java â­â­â­â­â­ åç«¯å¼€å‘ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€å¾®æœåŠ¡æ¶æ„ SQL â­â­â­â­ æ•°æ®åº“è®¾è®¡ã€æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•è°ƒä¼˜ JavaScript â­â­â­ å‰ç«¯å¼€å‘ã€Vue 3 åº”ç”¨ æ ¸å¿ƒæŠ€æœ¯æ ˆ åç«¯æ¡†æ¶ä¸ä¸­é—´ä»¶ Spring ç”Ÿæ€\nSpring Bootï¼šç†Ÿæ‚‰è‡ªåŠ¨è£…é…åŸç†ï¼Œèƒ½å¤Ÿè‡ªå®šä¹‰ Starter Spring AOP/IOCï¼šç†è§£æ ¸å¿ƒæ€æƒ³ï¼Œç†Ÿæ‚‰ Bean ç”Ÿå‘½å‘¨æœŸ MyBatis-Plusï¼šå¿«é€Ÿå¼€å‘ CRUDï¼Œç†Ÿæ‚‰ä»£ç ç”Ÿæˆå’Œé€šç”¨ Mapper åˆ†å¸ƒå¼ä¸é«˜å¹¶å‘\nRedisï¼šåˆ†å¸ƒå¼é”ï¼ˆRedissonï¼‰ã€ç¼“å­˜æ¶æ„è®¾è®¡ã€Pub/Sub æœºåˆ¶ RabbitMQï¼šæ¶ˆæ¯å¯é æ€§ä¿éšœã€å¼‚æ­¥è§£è€¦ã€æ­»ä¿¡é˜Ÿåˆ— Netty + WebSocketï¼šå®æ—¶æ¶ˆæ¯æ¨é€ã€é•¿è¿æ¥ç®¡ç† æ•°æ®åº“\nMySQLï¼šç´¢å¼•ä¼˜åŒ–ã€äº‹åŠ¡éš”ç¦»çº§åˆ«ã€MVCC æœºåˆ¶ã€B+ æ ‘ç´¢å¼•å¼•æ“ ShardingSphereï¼šåˆ†åº“åˆ†è¡¨å®æˆ˜ã€åˆ†ç‰‡ç­–ç•¥è®¾è®¡ æ¶æ„è®¾è®¡ è®¾è®¡æ¨¡å¼ä¸æ¶æ„æ€æƒ³\nDDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰ï¼šèšåˆæ ¹ã€é™ç•Œä¸Šä¸‹æ–‡ã€é¢†åŸŸäº‹ä»¶ è®¾è®¡æ¨¡å¼ï¼šç†Ÿæ‚‰ç­–ç•¥ã€æ¨¡æ¿æ–¹æ³•ã€è´£ä»»é“¾ç­‰å¸¸ç”¨æ¨¡å¼ è§„åˆ™å¼•æ“ï¼šç†è§£å¦‚ä½•é€šè¿‡è§„åˆ™å¼•æ“åˆ¤æ–­å¤æ‚ä¸šåŠ¡é€»è¾‘ æ€§èƒ½ä¼˜åŒ–\nJVM è°ƒä¼˜ï¼šç†è§£ GC æœºåˆ¶ã€å†…å­˜æ¨¡å‹ã€OOM æ’æŸ¥ æ¥å£ä¼˜åŒ–ï¼šä» 800ms ä¼˜åŒ–åˆ° 120ms çš„å®æˆ˜ç»éªŒ æ•°æ®åº“ä¼˜åŒ–ï¼šSQL è°ƒä¼˜ã€ç´¢å¼•è®¾è®¡ã€åˆ†åº“åˆ†è¡¨ å‰ç«¯æŠ€æœ¯ Vue 3ï¼šComposition APIã€å‰åç«¯åˆ†ç¦»å¼€å‘ EasyExcelï¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€å†…å­˜ä¼˜åŒ– å·¥å…·ä¸è¿ç»´ å¼€å‘å·¥å…·\nGitï¼šåˆ†æ”¯ç®¡ç†ã€ä»£ç å®¡æŸ¥ã€å›¢é˜Ÿåä½œ Mavenï¼šä¾èµ–ç®¡ç†ã€å¤šæ¨¡å—é¡¹ç›®æ„å»º Dockerï¼šå®¹å™¨åŒ–éƒ¨ç½²ã€å¤šé˜¶æ®µæ„å»ºã€Docker Compose è¿ç»´ä¸éƒ¨ç½²\nNginxï¼šåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€é™æ€èµ„æºç¼“å­˜ Linuxï¼šå¸¸ç”¨å‘½ä»¤ã€Shell è„šæœ¬ã€æœåŠ¡å™¨è¿ç»´ ä¸­é—´ä»¶ä¸å·¥å…·\nZookeeperï¼šåˆ†å¸ƒå¼åè°ƒã€æœåŠ¡æ³¨å†Œå‘ç° Dubboï¼šRPC æ¡†æ¶ã€æœåŠ¡æ²»ç† æŠ€æœ¯æ·±åº¦ æºç é˜…è¯»èƒ½åŠ› Spring Boot Starter è‡ªåŠ¨è£…é…æœºåˆ¶ Redisson çœ‹é—¨ç‹—ç»­æœŸåŸç† MyBatis åŠ¨æ€ SQL ç”Ÿæˆæµç¨‹ é—®é¢˜æ’æŸ¥èƒ½åŠ› çº¿ä¸Š OOM é—®é¢˜å®šä½ï¼ˆjmapã€MAT å·¥å…·ï¼‰ æ¥å£æ€§èƒ½ç“¶é¢ˆåˆ†æï¼ˆArthasã€JProfilerï¼‰ åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜æ’æŸ¥ æ¶æ„è®¾è®¡èƒ½åŠ› ä» 0 åˆ° 1 è®¾è®¡æ‹¼å›¢äº¤æ˜“å¹³å°ï¼ˆDDD æ¶æ„ï¼‰ è®¾è®¡åŠ¨æ€çº¿ç¨‹æ±  SDKï¼ˆé›¶ä¾µå…¥å¼ï¼‰ åˆ†å¸ƒå¼é”æ–¹æ¡ˆè®¾è®¡ï¼ˆRedis + Redissonï¼‰ å­¦ä¹ æ–¹æ³• æˆ‘ç›¸ä¿¡\u0026quot;æºç æ˜¯æœ€å¥½çš„è€å¸ˆ\u0026quot;ã€‚åœ¨å­¦ä¹ æ–°æŠ€æœ¯æ—¶ï¼Œæˆ‘ä¼šï¼š\nå…ˆç†è§£æ ¸å¿ƒæ¦‚å¿µå’Œä½¿ç”¨åœºæ™¯ é€šè¿‡å®æˆ˜é¡¹ç›®åŠ æ·±ç†è§£ é˜…è¯»æºç ç†è§£åº•å±‚å®ç° æ€»ç»“æˆåšå®¢æ–‡ç« æ²‰æ·€çŸ¥è¯† æ­£åœ¨å­¦ä¹  Kubernetesï¼šå®¹å™¨ç¼–æ’ã€æœåŠ¡ç½‘æ ¼ Elasticsearchï¼šå…¨æ–‡æœç´¢ã€æ—¥å¿—åˆ†æ Go è¯­è¨€ï¼šé«˜å¹¶å‘ç¼–ç¨‹ã€å¾®æœåŠ¡å¼€å‘ æŠ€èƒ½è®¤è¯ ç†Ÿæ‚‰ JUC å¹¶å‘å·¥å…·ã€ç†è§£ AQSã€CAS åŠé”å‡çº§è¿‡ç¨‹ ç†Ÿæ‚‰çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜å’Œç›‘æ§ ç†è§£ volatileã€synchronized çš„å†…å­˜è¯­ä¹‰ä¸å¯è§æ€§ ä»¥ä¸ŠæŠ€èƒ½å‡æ¥è‡ªå®é™…é¡¹ç›®ç»éªŒå’Œæ·±åº¦å­¦ä¹ ï¼ŒæŒç»­æ›´æ–°ä¸­\n","permalink":"http://localhost:1313/skills/","summary":"æŠ€æœ¯èƒ½åŠ›æ€»è§ˆ - ä¸“æ³¨åç«¯å¼€å‘ä¸åˆ†å¸ƒå¼ç³»ç»Ÿ","title":"æŠ€èƒ½æ ˆ"},{"content":"é¡¹ç›®ç®€ä»‹ [ç”¨ 2-3 å¥è¯è¯´æ¸…æ¥šï¼šåšäº†ä»€ä¹ˆã€è§£å†³ä»€ä¹ˆé—®é¢˜]\næºç ï¼šGitHub\næ¼”ç¤ºï¼šåœ¨çº¿åœ°å€ï¼ˆå¯é€‰ï¼‰\næŠ€æœ¯æ ˆ åç«¯ï¼š å‰ç«¯ï¼š æ•°æ®åº“ï¼š éƒ¨ç½²ï¼š æ ¸å¿ƒåŠŸèƒ½ æŠ€æœ¯äº®ç‚¹ [äº®ç‚¹1ï¼šæ¯”å¦‚æ€§èƒ½ä¼˜åŒ–] [ç®€è¿°é—®é¢˜ + è§£å†³æ–¹æ¡ˆ]\n1// å…³é”®ä»£ç ç‰‡æ®µï¼ˆå¯é€‰ï¼‰ [äº®ç‚¹2ï¼šæ¯”å¦‚æ¶æ„è®¾è®¡] [ç®€è¿°æ€è·¯]\né¡¹ç›®æˆæœ æ•°æ®æŒ‡æ ‡ï¼ˆå¦‚æœ‰ï¼‰ å­¦åˆ°äº†ä»€ä¹ˆ ğŸ’¡ å¤åˆ¶è¿™ä¸ªæ¨¡æ¿ï¼Œå¡«å…¥ä½ çš„çœŸå®é¡¹ç›®\n","permalink":"http://localhost:1313/projects/example-project/","summary":"\u003ch2 id=\"é¡¹ç›®ç®€ä»‹\"\u003eé¡¹ç›®ç®€ä»‹\u003c/h2\u003e\n\u003cp\u003e[ç”¨ 2-3 å¥è¯è¯´æ¸…æ¥šï¼šåšäº†ä»€ä¹ˆã€è§£å†³ä»€ä¹ˆé—®é¢˜]\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæºç \u003c/strong\u003eï¼š\u003ca href=\"https://github.com/%E4%BD%A0%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D/%E9%A1%B9%E7%9B%AE%E5%90%8D\"\u003eGitHub\u003c/a\u003e\u003cbr\u003e\n\u003cstrong\u003eæ¼”ç¤º\u003c/strong\u003eï¼š\u003ca href=\"#\"\u003eåœ¨çº¿åœ°å€\u003c/a\u003eï¼ˆå¯é€‰ï¼‰\u003c/p\u003e\n\u003ch2 id=\"æŠ€æœ¯æ ˆ\"\u003eæŠ€æœ¯æ ˆ\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eåç«¯ï¼š\u003c/li\u003e\n\u003cli\u003eå‰ç«¯ï¼š\u003c/li\u003e\n\u003cli\u003eæ•°æ®åº“ï¼š\u003c/li\u003e\n\u003cli\u003eéƒ¨ç½²ï¼š\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"æ ¸å¿ƒåŠŸèƒ½\"\u003eæ ¸å¿ƒåŠŸèƒ½\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"æŠ€æœ¯äº®ç‚¹\"\u003eæŠ€æœ¯äº®ç‚¹\u003c/h2\u003e\n\u003ch3 id=\"äº®ç‚¹1æ¯”å¦‚æ€§èƒ½ä¼˜åŒ–\"\u003e[äº®ç‚¹1ï¼šæ¯”å¦‚æ€§èƒ½ä¼˜åŒ–]\u003c/h3\u003e\n\u003cp\u003e[ç®€è¿°é—®é¢˜ + è§£å†³æ–¹æ¡ˆ]\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e// å…³é”®ä»£ç ç‰‡æ®µï¼ˆå¯é€‰ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"äº®ç‚¹2æ¯”å¦‚æ¶æ„è®¾è®¡\"\u003e[äº®ç‚¹2ï¼šæ¯”å¦‚æ¶æ„è®¾è®¡]\u003c/h3\u003e\n\u003cp\u003e[ç®€è¿°æ€è·¯]\u003c/p\u003e\n\u003ch2 id=\"é¡¹ç›®æˆæœ\"\u003eé¡¹ç›®æˆæœ\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eæ•°æ®æŒ‡æ ‡ï¼ˆå¦‚æœ‰ï¼‰\u003c/li\u003e\n\u003cli\u003eå­¦åˆ°äº†ä»€ä¹ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cblockquote\u003e\n\u003cp\u003eğŸ’¡ å¤åˆ¶è¿™ä¸ªæ¨¡æ¿ï¼Œå¡«å…¥ä½ çš„çœŸå®é¡¹ç›®\u003c/p\u003e\n\u003c/blockquote\u003e","title":"[é¡¹ç›®åç§°]"},{"content":"åœ¨ç¢ç‰‡åŒ–ä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œæ‹¥æœ‰ä¸€å¥—å®Œå…¨å—è‡ªå·±æŒæ§çš„æŠ€æœ¯ä¸“æ ï¼Œæ˜¯æ¯ä½å¼€å‘è€…æ²‰æ·€æ€è€ƒã€æ‰“é€ ä¸ªäººå“ç‰Œçš„æ ¸å¿ƒèµ„äº§ã€‚ç›¸æ¯”äºè¢«å¹³å°ç®—æ³•ç»‘æ¶çš„å…¬ä¼—å·ï¼Œæˆ–æ˜¯å……æ–¥å¹¿å‘Šçš„ç¬¬ä¸‰æ–¹åšå®¢ï¼ŒHugo è¿™ç±»é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ç»™äº†æˆ‘ä»¬çœŸæ­£çš„è‡ªç”±ï¼šæ¯«ç§’çº§æ„å»ºã€Markdown åŸç”Ÿæ”¯æŒã€å®Œå…¨çš„æ ·å¼æ§åˆ¶æƒã€‚\nä½†å¾ˆå¤šäººåœ¨æ­å»º Hugo åšå®¢æ—¶ï¼Œå¾€å¾€é™·å…¥\u0026quot;ç…§ç€æ–‡æ¡£æ•²å‘½ä»¤\u0026quot;çš„æœºæ¢°é‡å¤ã€‚æœ¬æ–‡ä¸æ˜¯åˆä¸€ç¯‡å®‰è£…æ•™ç¨‹ï¼Œè€Œæ˜¯ä»ç³»ç»Ÿæ¶æ„çš„è§’åº¦ï¼Œå¸¦ä½ ç†è§£ Hugo + PaperMod è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡é€»è¾‘ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Hugo Extended ä¸ PaperMod çš„ä¾èµ–å…³ç³» æŒæ¡ Git Submodule çš„ä¸»é¢˜ç®¡ç†æ–¹æ¡ˆ è®¾è®¡åŸºäº GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿ å»ºç«‹å·¥ç¨‹åŒ–æ€ç»´è€Œé\u0026quot;è·Ÿç€åš\u0026quot;çš„æ“ä½œæ€ç»´ 01. åŸºç¡€è®¾æ–½ï¼šä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ Hugo Extendedï¼Ÿ å¾ˆå¤šäººç¬¬ä¸€æ¬¡æ­å»º Hugo åšå®¢æ—¶ï¼Œä¼šé‡åˆ°ä¸€ä¸ªè¯¡å¼‚çš„æŠ¥é”™ï¼šTOCSS: failed to transform \u0026quot;css/main.css\u0026quot;ã€‚æ˜æ˜æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è£…äº† Hugoï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºé”™ï¼Ÿ\né—®é¢˜å‡ºåœ¨ç‰ˆæœ¬é€‰æ‹©ä¸Šã€‚Hugo åˆ†ä¸ºæ™®é€šç‰ˆå’Œ Extended ç‰ˆï¼Œåè€…å†…ç½®äº† LibSass ç¼–è¯‘å™¨ã€‚è€Œ PaperMod è¿™ç±»ç°ä»£ä¸»é¢˜å¤§é‡ä½¿ç”¨ SCSS/SASS æ¥å®ç°ä¸»é¢˜å˜é‡ã€æš—é»‘æ¨¡å¼åˆ‡æ¢ç­‰ç‰¹æ€§ã€‚å¦‚æœä½ ç”¨æ™®é€šç‰ˆ Hugoï¼Œç¼–è¯‘æµç¨‹ä¼šåœ¨ CSS è½¬æ¢ç¯èŠ‚ç›´æ¥å´©æºƒã€‚\nåœ¨ Windows ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ç”¨ Winget æ¥å®‰è£…ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ä¸‹è½½ zip åŒ…ï¼š\n1# ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œç¡®ä¿ç‰ˆæœ¬å¯è¿½æº¯ 2winget install Hugo.Hugo.Extended 3 4# éªŒè¯å®‰è£…ï¼šå¿…é¡»çœ‹åˆ° +extended æ ‡è¯† 5hugo version 6# é¢„æœŸè¾“å‡º: hugo v0.12x.x+extended windows/amd64 ä¸ºä»€ä¹ˆåšæŒç”¨åŒ…ç®¡ç†å™¨ï¼Ÿå› ä¸ºè¿™æ˜¯\u0026quot;å¯å¤ç°ç¯å¢ƒ\u0026quot;çš„ç¬¬ä¸€æ­¥ã€‚å½“ä½ çš„åšå®¢éœ€è¦å›¢é˜Ÿåä½œï¼Œæˆ–è€…æ¢äº†å°ç”µè„‘é‡æ–°éƒ¨ç½²æ—¶ï¼Œä¸€æ¡å‘½ä»¤å°±èƒ½æ¢å¤å®Œå…¨ä¸€è‡´çš„ç¯å¢ƒï¼Œè€Œä¸æ˜¯åœ¨\u0026quot;æˆ‘ç”µè„‘ä¸Šèƒ½è·‘\u0026quot;çš„æ³¥æ½­é‡ŒæŒ£æ‰ã€‚\næ¥ä¸‹æ¥åˆå§‹åŒ–ç«™ç‚¹éª¨æ¶ï¼š\n1hugo new site myblog 2cd myblog 3git init è¿™ä¸‰è¡Œå‘½ä»¤çœ‹ä¼¼ç®€å•ï¼Œä½†èƒŒåæ˜¯ Hugo çš„\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;å“²å­¦ï¼šcontent/ å­˜æ”¾å†…å®¹æºæ–‡ä»¶ï¼Œthemes/ ç®¡ç†è§†è§‰å±‚ï¼Œpublic/ ä½œä¸ºç¼–è¯‘äº§ç‰©è¾“å‡ºã€‚è¿™ç§æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œè®©æˆ‘ä»¬å¯ä»¥ç‹¬ç«‹ç®¡ç†å†…å®¹ã€ä¸»é¢˜å’Œæ„å»ºæµç¨‹ã€‚\næ¶æ„æ€è€ƒï¼š Hugo çš„ç›®å½•ç»“æ„æœ¬è´¨ä¸Šæ˜¯ä¸€ç§\u0026quot;å…³æ³¨ç‚¹åˆ†ç¦»\u0026quot;çš„è®¾è®¡æ¨¡å¼ã€‚å†…å®¹åˆ›ä½œè€…åªéœ€è¦å…³å¿ƒ content/ ä¸‹çš„ Markdownï¼Œä¸»é¢˜å¼€å‘è€…ä¸“æ³¨äº themes/ çš„æ¨¡æ¿é€»è¾‘ï¼Œè€Œ CI/CD æµæ°´çº¿åªéœ€è¦å¤„ç† public/ çš„éƒ¨ç½²ã€‚è¿™ç§è§£è€¦è®¾è®¡ï¼Œæ˜¯å¤§è§„æ¨¡å†…å®¹ç”Ÿäº§çš„åŸºç¡€ã€‚\n02. ä¸»é¢˜ä¾èµ–ï¼šä¸ºä»€ä¹ˆé€‰æ‹© Git Submoduleï¼Ÿ å¼•å…¥ PaperMod ä¸»é¢˜æœ‰ä¸¤ç§æ–¹å¼ï¼šç›´æ¥ä¸‹è½½ zip åŒ…è§£å‹åˆ° themes/ ç›®å½•ï¼Œæˆ–è€…ç”¨ Git Submoduleã€‚å¾ˆå¤šæ•™ç¨‹ä¼šæ¨èå‰è€…ï¼Œå› ä¸º\u0026quot;ç®€å•\u0026quot;ã€‚ä½†è¿™ç§ç®€å•æ˜¯æœ‰ä»£ä»·çš„ã€‚\næƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šPaperMod å®˜æ–¹ä¿®å¤äº†ä¸€ä¸ªæš—é»‘æ¨¡å¼çš„ Bugï¼Œæˆ–è€…æ–°å¢äº†æœç´¢åŠŸèƒ½ã€‚å¦‚æœä½ æ˜¯ç›´æ¥ä¸‹è½½çš„ä¸»é¢˜ï¼Œæ›´æ–°æµç¨‹ä¼šå˜æˆï¼šå» GitHub ä¸‹è½½æ–°ç‰ˆ â†’ åˆ é™¤æ—§æ–‡ä»¶ â†’ è§£å‹è¦†ç›– â†’ ç¥ˆç¥·æ²¡æœ‰å†²çªã€‚è€Œå¦‚æœç”¨ Submoduleï¼Œåªéœ€è¦ä¸€æ¡å‘½ä»¤ï¼š\n1# å»ºç«‹ä¸»é¢˜å­æ¨¡å—ä¾èµ– 2git submodule add --depth=1 https://github.com/adityatelange/hugo-PaperMod.git themes/PaperMod 3 4# æœªæ¥æ›´æ–°ä¸»é¢˜åªéœ€è¦ 5git submodule update --remote --merge Submodule çš„æœ¬è´¨æ˜¯\u0026quot;ä¾èµ–å¤–éƒ¨åŒ–\u0026quot;ã€‚ä¸»é¢˜ä»£ç ä¸ä¼šæ±¡æŸ“ä½ çš„ä¸»ä»“åº“æäº¤å†å²ï¼ŒåŒæ—¶åˆèƒ½é€šè¿‡ .gitmodules æ–‡ä»¶ç²¾ç¡®é”å®šä¾èµ–ç‰ˆæœ¬ã€‚è¿™ç§è®¾è®¡åœ¨å¤§å‹å¼€æºé¡¹ç›®ä¸­æä¸ºå¸¸è§ï¼ˆæ¯”å¦‚ Linux å†…æ ¸çš„é©±åŠ¨æ¨¡å—ç®¡ç†ï¼‰ã€‚\nç„¶ååœ¨ hugo.toml ä¸­æ¿€æ´»ä¸»é¢˜ï¼š\n1theme = \u0026#34;PaperMod\u0026#34; è¿™ä¸€è¡Œé…ç½®æ˜¯æ•´ä¸ªç«™ç‚¹çš„\u0026quot;æ§åˆ¶æ¢çº½\u0026quot;ï¼Œå®ƒå‘Šè¯‰ Hugo åœ¨ç¼–è¯‘æ—¶å» themes/PaperMod/ ç›®å½•å¯»æ‰¾æ¨¡æ¿æ–‡ä»¶ã€‚\né¿å‘æç¤ºï¼š å¦‚æœä½ å…‹éš†äº†åˆ«äººçš„ Hugo é¡¹ç›®ï¼Œè®°å¾—æ‰§è¡Œ git submodule update --init --recursiveï¼Œå¦åˆ™ themes/ ç›®å½•ä¼šæ˜¯ç©ºçš„ï¼Œå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚\n03. å†…å®¹ç”Ÿäº§ï¼šä»æ¨¡æ¿åˆ°å®æ—¶é¢„è§ˆ åˆ›å»ºç¬¬ä¸€ç¯‡æ–‡ç« ï¼š\n1hugo new posts/my-first-post.md è¿™æ¡å‘½ä»¤ä¼šæ ¹æ® archetypes/default.md æ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆæ–‡ç« éª¨æ¶ï¼ŒåŒ…æ‹¬ Front Matterï¼ˆæ ‡é¢˜ã€æ—¥æœŸã€æ ‡ç­¾ç­‰å…ƒæ•°æ®ï¼‰ã€‚è¿™ä¿è¯äº†å…¨ç«™æ–‡ç« æ ¼å¼çš„ä¸€è‡´æ€§ï¼Œé¿å…äº†æ‰‹åŠ¨ç¼–å†™ YAML æ—¶çš„ä½çº§é”™è¯¯ã€‚\né»˜è®¤ç”Ÿæˆçš„æ–‡ç« åŒ…å« draft: true å­—æ®µï¼Œè¿™æ˜¯ Hugo çš„\u0026quot;è‰ç¨¿æ€\u0026quot;æœºåˆ¶ã€‚åœ¨æ­£å¼æ„å»ºæ—¶ï¼Œè‰ç¨¿ä¸ä¼šè¢«ç¼–è¯‘ã€‚è¿™ä¸ªè®¾è®¡å¾ˆè´´å¿ƒï¼šä½ å¯ä»¥åœ¨æœ¬åœ°éšæ„å†™åŠæˆå“æ–‡ç« ï¼Œä¸ç”¨æ‹…å¿ƒå®ƒä»¬è¢«æ„å¤–å‘å¸ƒã€‚\nå¯åŠ¨æœ¬åœ°é¢„è§ˆæœåŠ¡å™¨ï¼š\n1hugo server -D 2# è®¿é—® http://localhost:1313 -D å‚æ•°è¡¨ç¤ºé¢„è§ˆè‰ç¨¿ã€‚Hugo çš„å®æ—¶é¢„è§ˆèƒ½åŠ›æºäºå…¶\u0026quot;å¢é‡ç¼–è¯‘\u0026quot;è®¾è®¡ï¼šå®ƒä¸ä¼šåœ¨æ¯æ¬¡æ–‡ä»¶å˜æ›´æ—¶é‡æ–°æ„å»ºæ•´ä¸ªç«™ç‚¹ï¼Œè€Œæ˜¯é€šè¿‡ä¾èµ–å›¾åˆ†æï¼Œåªé‡æ–°ç¼–è¯‘å—å½±å“çš„é¡µé¢ã€‚å³ä½¿ä½ çš„åšå®¢æœ‰ä¸Šåƒç¯‡æ–‡ç« ï¼Œé¢„è§ˆå»¶è¿Ÿä¹Ÿèƒ½æ§åˆ¶åœ¨ 100ms ä»¥å†…ã€‚\nè¿™ç§æ¯«ç§’çº§çš„åé¦ˆå¾ªç¯ï¼Œè®©å†™ä½œå˜æˆäº†ä¸€ç§\u0026quot;æ‰€è§å³æ‰€å¾—\u0026quot;çš„æµç•…ä½“éªŒã€‚ä½ æ”¹ä¸€ä¸ªæ ‡ç‚¹ï¼Œæµè§ˆå™¨ç«‹åˆ»åˆ·æ–°ï¼›ä½ è°ƒæ•´ä¸€ä¸ªæ ·å¼ï¼Œæ•ˆæœç¬é—´å‘ˆç°ã€‚è¿™ç§å³æ—¶åé¦ˆï¼Œæ˜¯ä¿æŒåˆ›ä½œå¿ƒæµçš„å…³é”®ã€‚\n04. è‡ªåŠ¨åŒ–æµæ°´çº¿ï¼šæäº¤å³å‘å¸ƒçš„é­”æ³• æ‰‹åŠ¨æ„å»ºã€æ‰‹åŠ¨ä¸Šä¼ çš„æ—¶ä»£æ—©è¯¥ç»“æŸäº†ã€‚æˆ‘ä»¬è¦çš„æ˜¯\u0026quot;git push ä¹‹åå–æ¯å’–å•¡ï¼Œå›æ¥åšå®¢å°±æ›´æ–°äº†\u0026quot;çš„ä¸æ»‘ä½“éªŒã€‚\nGitHub Actions æ˜¯å®ç°è¿™ä¸ªç›®æ ‡çš„æœ€ä½³å·¥å…·ã€‚å®ƒçš„å·¥ä½œæµç¨‹æ˜¯ï¼šä½ æ¨é€ä»£ç åˆ° GitHub â†’ Actions è‡ªåŠ¨æ‹‰å–ä»£ç  â†’ è°ƒç”¨ Hugo ç¼–è¯‘ â†’ å°†ç”Ÿæˆçš„é™æ€æ–‡ä»¶éƒ¨ç½²åˆ° GitHub Pagesã€‚\nåœ¨ .github/workflows/hugo.yml ä¸­åˆ›å»ºå·¥ä½œæµé…ç½®ï¼š\n1name: Deploy Hugo site to Pages 2 3on: 4 push: 5 branches: [\u0026#34;main\u0026#34;] 6 7permissions: 8 contents: read 9 pages: write 10 id-token: write 11 12jobs: 13 build: 14 runs-on: ubuntu-latest 15 steps: 16 - name: Checkout 17 uses: actions/checkout@v4 18 with: 19 submodules: recursive # å…³é”®ï¼šé€’å½’æ‹‰å–ä¸»é¢˜å­æ¨¡å— 20 fetch-depth: 0 21 22 - name: Setup Hugo 23 uses: peaceiris/actions-hugo@v3 24 with: 25 hugo-version: \u0026#39;latest\u0026#39; 26 extended: true # å¿…é¡»å¼€å¯ Extended æ”¯æŒ 27 28 - name: Build 29 run: hugo --minify # å‹ç¼© HTML/CSS/JS 30 31 - name: Upload artifact 32 uses: actions/upload-pages-artifact@v3 33 with: 34 path: ./public 35 36 deploy: 37 environment: 38 name: github-pages 39 runs-on: ubuntu-latest 40 needs: build 41 steps: 42 - id: deployment 43 uses: actions/deploy-pages@v4 è¿™ä¸ªé…ç½®æ–‡ä»¶çš„æ ¸å¿ƒæ˜¯ submodules: recursiveã€‚å¦‚æœæ¼æ‰è¿™ä¸€è¡Œï¼ŒActions æ‹‰å–ä»£ç æ—¶ä¸ä¼šä¸‹è½½ PaperMod ä¸»é¢˜ï¼Œå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚è¿™æ˜¯å¾ˆå¤šäººç¬¬ä¸€æ¬¡é…ç½® CI/CD æ—¶è¸©çš„å‘ã€‚\nhugo --minify ä¼šå‹ç¼©ç”Ÿæˆçš„ HTMLã€CSSã€JS æ–‡ä»¶ï¼Œå‡å°‘ä¼ è¾“ä½“ç§¯ã€‚å¯¹äºä¸€ä¸ªä¸­ç­‰è§„æ¨¡çš„åšå®¢ï¼Œè¿™èƒ½èŠ‚çœ 30-40% çš„å¸¦å®½ã€‚\næ¶æ„æ€è€ƒï¼š è¿™å¥— CI/CD æµæ°´çº¿çš„æœ¬è´¨æ˜¯\u0026quot;åŸºç¡€è®¾æ–½å³ä»£ç \u0026quot;ï¼ˆInfrastructure as Codeï¼‰ã€‚éƒ¨ç½²æµç¨‹ä¸å†æ˜¯å£å£ç›¸ä¼ çš„æ“ä½œæ‰‹å†Œï¼Œè€Œæ˜¯ç‰ˆæœ¬æ§åˆ¶çš„ YAML æ–‡ä»¶ã€‚ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°éƒ¨ç½²é€»è¾‘ï¼Œä»»ä½•ä¿®æ”¹éƒ½æœ‰å®¡è®¡è®°å½•ã€‚è¿™ç§é€æ˜æ€§å’Œå¯å¤ç°æ€§ï¼Œæ˜¯ç°ä»£ DevOps çš„æ ¸å¿ƒç†å¿µã€‚\n05. æ€»ç»“ä¸æ€è€ƒ æˆ‘ä»¬ä» Hugo Extended çš„ç‰ˆæœ¬é€‰æ‹©ï¼Œåˆ° Git Submodule çš„ä¾èµ–ç®¡ç†ï¼Œå†åˆ° GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œæ„å»ºäº†ä¸€å¥—å®Œæ•´çš„åšå®¢å·¥ç¨‹åŒ–æ–¹æ¡ˆã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸ºäº†\u0026quot;æ­ä¸ªåšå®¢\u0026quot;ï¼Œæ›´æ˜¯ä¸€æ¬¡å¯¹é™æ€ç«™ç‚¹ç¼–è¯‘æµç¨‹ã€ä¾èµ–ç®¡ç†æ€æƒ³ã€CI/CD å®è·µçš„æ·±åº¦ç†è§£ã€‚\nå¦‚æœä½ çš„åšå®¢æœªæ¥éœ€è¦æ”¯æŒå¤šè¯­è¨€ç‰ˆæœ¬ï¼Œæˆ–è€…éœ€è¦é’ˆå¯¹ä¸åŒç»ˆç«¯æä¾›å·®å¼‚åŒ–çš„æœç´¢ä½“éªŒï¼Œä½ ä¼šå¦‚ä½•ä» hugo.toml çš„é…ç½®å±‚çº§è¿›è¡Œè§£è€¦è®¾è®¡ï¼Ÿæç¤ºï¼šå¯ä»¥ç ”ç©¶ Hugo çš„ languages é…ç½®å’Œ outputFormats æœºåˆ¶ã€‚\næŠ€æœ¯çš„æœ¬è´¨ä¸æ˜¯å·¥å…·çš„å †ç Œï¼Œè€Œæ˜¯å¯¹é—®é¢˜çš„æ·±åº¦ç†è§£ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ è·³å‡º\u0026quot;ç…§ç€åš\u0026quot;çš„æ€ç»´å®šå¼ï¼ŒçœŸæ­£ç†è§£ Hugo è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡å“²å­¦ã€‚\n","permalink":"http://localhost:1313/posts/2026/02/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%9E%84%E5%BB%BA-hugo--papermod-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/","summary":"\u003cp\u003eåœ¨ç¢ç‰‡åŒ–ä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œæ‹¥æœ‰ä¸€å¥—å®Œå…¨å—è‡ªå·±æŒæ§çš„æŠ€æœ¯ä¸“æ ï¼Œæ˜¯æ¯ä½å¼€å‘è€…æ²‰æ·€æ€è€ƒã€æ‰“é€ ä¸ªäººå“ç‰Œçš„æ ¸å¿ƒèµ„äº§ã€‚ç›¸æ¯”äºè¢«å¹³å°ç®—æ³•ç»‘æ¶çš„å…¬ä¼—å·ï¼Œæˆ–æ˜¯å……æ–¥å¹¿å‘Šçš„ç¬¬ä¸‰æ–¹åšå®¢ï¼ŒHugo è¿™ç±»é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ç»™äº†æˆ‘ä»¬çœŸæ­£çš„è‡ªç”±ï¼šæ¯«ç§’çº§æ„å»ºã€Markdown åŸç”Ÿæ”¯æŒã€å®Œå…¨çš„æ ·å¼æ§åˆ¶æƒã€‚\u003c/p\u003e\n\u003cp\u003eä½†å¾ˆå¤šäººåœ¨æ­å»º Hugo åšå®¢æ—¶ï¼Œå¾€å¾€é™·å…¥\u0026quot;ç…§ç€æ–‡æ¡£æ•²å‘½ä»¤\u0026quot;çš„æœºæ¢°é‡å¤ã€‚æœ¬æ–‡ä¸æ˜¯åˆä¸€ç¯‡å®‰è£…æ•™ç¨‹ï¼Œè€Œæ˜¯ä»ç³»ç»Ÿæ¶æ„çš„è§’åº¦ï¼Œå¸¦ä½ ç†è§£ Hugo + PaperMod è¿™å¥—æ–¹æ¡ˆèƒŒåçš„è®¾è®¡é€»è¾‘ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Hugo Extended ä¸ PaperMod çš„ä¾èµ–å…³ç³»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Git Submodule çš„ä¸»é¢˜ç®¡ç†æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è®¾è®¡åŸºäº GitHub Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹å·¥ç¨‹åŒ–æ€ç»´è€Œé\u0026quot;è·Ÿç€åš\u0026quot;çš„æ“ä½œæ€ç»´\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"01-åŸºç¡€è®¾æ–½ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯-hugo-extended\"\u003e01. åŸºç¡€è®¾æ–½ï¼šä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ Hugo Extendedï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eå¾ˆå¤šäººç¬¬ä¸€æ¬¡æ­å»º Hugo åšå®¢æ—¶ï¼Œä¼šé‡åˆ°ä¸€ä¸ªè¯¡å¼‚çš„æŠ¥é”™ï¼š\u003ccode\u003eTOCSS: failed to transform \u0026quot;css/main.css\u0026quot;\u003c/code\u003eã€‚æ˜æ˜æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è£…äº† Hugoï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºé”™ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eé—®é¢˜å‡ºåœ¨ç‰ˆæœ¬é€‰æ‹©ä¸Šã€‚Hugo åˆ†ä¸ºæ™®é€šç‰ˆå’Œ Extended ç‰ˆï¼Œåè€…å†…ç½®äº† LibSass ç¼–è¯‘å™¨ã€‚è€Œ PaperMod è¿™ç±»ç°ä»£ä¸»é¢˜å¤§é‡ä½¿ç”¨ SCSS/SASS æ¥å®ç°ä¸»é¢˜å˜é‡ã€æš—é»‘æ¨¡å¼åˆ‡æ¢ç­‰ç‰¹æ€§ã€‚å¦‚æœä½ ç”¨æ™®é€šç‰ˆ Hugoï¼Œç¼–è¯‘æµç¨‹ä¼šåœ¨ CSS è½¬æ¢ç¯èŠ‚ç›´æ¥å´©æºƒã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ Windows ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ç”¨ Winget æ¥å®‰è£…ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ä¸‹è½½ zip åŒ…ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-powershell\" data-lang=\"powershell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œç¡®ä¿ç‰ˆæœ¬å¯è¿½æº¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ewinget\u003c/span\u003e \u003cspan class=\"n\"\u003einstall\u003c/span\u003e \u003cspan class=\"n\"\u003eHugo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"py\"\u003eHugo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"py\"\u003eExtended\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# éªŒè¯å®‰è£…ï¼šå¿…é¡»çœ‹åˆ° +extended æ ‡è¯†\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ehugo\u003c/span\u003e \u003cspan class=\"n\"\u003eversion\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e# é¢„æœŸè¾“å‡º: hugo v0.12x.x+extended windows/amd64\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¸ºä»€ä¹ˆåšæŒç”¨åŒ…ç®¡ç†å™¨ï¼Ÿå› ä¸ºè¿™æ˜¯\u0026quot;å¯å¤ç°ç¯å¢ƒ\u0026quot;çš„ç¬¬ä¸€æ­¥ã€‚å½“ä½ çš„åšå®¢éœ€è¦å›¢é˜Ÿåä½œï¼Œæˆ–è€…æ¢äº†å°ç”µè„‘é‡æ–°éƒ¨ç½²æ—¶ï¼Œä¸€æ¡å‘½ä»¤å°±èƒ½æ¢å¤å®Œå…¨ä¸€è‡´çš„ç¯å¢ƒï¼Œè€Œä¸æ˜¯åœ¨\u0026quot;æˆ‘ç”µè„‘ä¸Šèƒ½è·‘\u0026quot;çš„æ³¥æ½­é‡ŒæŒ£æ‰ã€‚\u003c/p\u003e","title":"ä»é›¶åˆ°ä¸€ï¼šæ„å»º Hugo + PaperMod è‡ªåŠ¨åŒ–åšå®¢ç³»ç»Ÿ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œå¾€å¾€éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯è¿™äº›æ“ä½œçš„ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªç»å…¸éš¾é¢˜ã€‚æœ¬æ–‡å°†ç³»ç»Ÿè®²è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒé—®é¢˜ æŒæ¡2PCã€3PCã€TCCã€Sagaç­‰æ–¹æ¡ˆ å­¦ä¼šä½¿ç”¨Seataæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ äº†è§£å„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ ä¸šåŠ¡åœºæ™¯ ç”µå•†ä¸‹å•åœºæ™¯ï¼Œæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼š\n1ç”¨æˆ·ä¸‹å• 2 â†“ 3è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å• 4 â†“ 5åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜ 6 â†“ 7è´¦æˆ·æœåŠ¡ï¼šæ‰£å‡ä½™é¢ 8 â†“ 9ç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ† é—®é¢˜ï¼šå¦‚æœæŸä¸ªæœåŠ¡å¤±è´¥ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\nCAPç†è®º åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸‰ä¸ªç‰¹æ€§ï¼š\nC (Consistency)ï¼šä¸€è‡´æ€§ A (Availability)ï¼šå¯ç”¨æ€§ P (Partition Tolerance)ï¼šåˆ†åŒºå®¹é”™æ€§ CAPå®šç†ï¼šä¸‰è€…æœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤ä¸ª\nå®é™…é€‰æ‹©ï¼š\nCPï¼šç‰ºç‰²å¯ç”¨æ€§ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ˆå¦‚ZooKeeperï¼‰ APï¼šç‰ºç‰²ä¸€è‡´æ€§ï¼Œä¿è¯å¯ç”¨æ€§ï¼ˆå¦‚Eurekaï¼‰ BASEç†è®º BA (Basically Available)ï¼šåŸºæœ¬å¯ç”¨ S (Soft State)ï¼šè½¯çŠ¶æ€ E (Eventually Consistent)ï¼šæœ€ç»ˆä¸€è‡´æ€§ æ¶æ„æ€è€ƒï¼š åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¼ºä¸€è‡´æ€§å¾€å¾€éš¾ä»¥å®ç°ä¸”ä»£ä»·é«˜æ˜‚ã€‚å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼Œè¿™ä¹Ÿæ˜¯ç°ä»£åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆçš„åŸºç¡€ã€‚\n2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ åŸç† ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰\nåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€Prepareè¯·æ±‚ å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤ å‚ä¸è€…è¿”å›Yesæˆ–No ç¬¬äºŒé˜¶æ®µï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰\nå¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›Yesï¼Œåè°ƒè€…å‘é€Commitè¯·æ±‚ å¦‚æœæœ‰å‚ä¸è€…è¿”å›Noï¼Œåè°ƒè€…å‘é€Rollbackè¯·æ±‚ æµç¨‹å›¾ 1åè°ƒè€… å‚ä¸è€…1 å‚ä¸è€…2 2 | | | 3 |---Prepare----------\u0026gt;| | 4 |---Prepare----------------------------\u0026gt;| 5 | | | 6 |\u0026lt;--Yes/No------------| | 7 |\u0026lt;--Yes/No-------------------------------| 8 | | | 9 |---Commit/Rollback--\u0026gt;| | 10 |---Commit/Rollback----------------------\u0026gt;| ä»£ç ç¤ºä¾‹ 1public class TwoPhaseCommitCoordinator { 2 3 private List\u0026lt;Participant\u0026gt; participants; 4 5 public boolean executeTransaction() { 6 // ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡ 7 boolean canCommit = prepare(); 8 9 // ç¬¬äºŒé˜¶æ®µï¼šæäº¤æˆ–å›æ»š 10 if (canCommit) { 11 commit(); 12 return true; 13 } else { 14 rollback(); 15 return false; 16 } 17 } 18 19 private boolean prepare() { 20 for (Participant participant : participants) { 21 if (!participant.prepare()) { 22 return false; 23 } 24 } 25 return true; 26 } 27 28 private void commit() { 29 for (Participant participant : participants) { 30 participant.commit(); 31 } 32 } 33 34 private void rollback() { 35 for (Participant participant : participants) { 36 participant.rollback(); 37 } 38 } 39} 40 41interface Participant { 42 boolean prepare(); 43 void commit(); 44 void rollback(); 45} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nå¼ºä¸€è‡´æ€§ å®ç°ç›¸å¯¹ç®€å• ç¼ºç‚¹ï¼š\nåŒæ­¥é˜»å¡ï¼šå‚ä¸è€…åœ¨ç­‰å¾…åè°ƒè€…æŒ‡ä»¤æ—¶ä¼šé˜»å¡ å•ç‚¹æ•…éšœï¼šåè°ƒè€…æ•…éšœä¼šå¯¼è‡´å‚ä¸è€…ä¸€ç›´é˜»å¡ æ•°æ®ä¸ä¸€è‡´ï¼šç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´éƒ¨åˆ†å‚ä¸è€…æäº¤ï¼Œéƒ¨åˆ†å›æ»š 3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰ åŸç† åœ¨2PCåŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶æœºåˆ¶å’ŒCanCommité˜¶æ®µï¼š\nç¬¬ä¸€é˜¶æ®µï¼šCanCommit\nåè°ƒè€…è¯¢é—®å‚ä¸è€…æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡ ç¬¬äºŒé˜¶æ®µï¼šPreCommit\nå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤ ç¬¬ä¸‰é˜¶æ®µï¼šDoCommit\nå‚ä¸è€…æäº¤æˆ–å›æ»šäº‹åŠ¡ æ”¹è¿› è¶…æ—¶æœºåˆ¶ï¼šå‚ä¸è€…ç­‰å¾…è¶…æ—¶åè‡ªåŠ¨æäº¤ å‡å°‘é˜»å¡ï¼šCanCommité˜¶æ®µä¸å ç”¨èµ„æº ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\né™ä½äº†é˜»å¡èŒƒå›´ å¢åŠ äº†è¶…æ—¶æœºåˆ¶ ç¼ºç‚¹ï¼š\nä»ç„¶å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„é£é™© å®ç°æ›´å¤æ‚ æ€§èƒ½å¼€é”€æ›´å¤§ TCCï¼ˆTry-Confirm-Cancelï¼‰ åŸç† å°†äº‹åŠ¡åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š\nTryé˜¶æ®µï¼š\nå°è¯•æ‰§è¡Œä¸šåŠ¡ å®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ é¢„ç•™å¿…é¡»çš„ä¸šåŠ¡èµ„æº Confirmé˜¶æ®µï¼š\nç¡®è®¤æ‰§è¡Œä¸šåŠ¡ ä¸åšä»»ä½•ä¸šåŠ¡æ£€æŸ¥ åªä½¿ç”¨Tryé˜¶æ®µé¢„ç•™çš„èµ„æº Cancelé˜¶æ®µï¼š\nå–æ¶ˆæ‰§è¡Œä¸šåŠ¡ é‡Šæ”¾Tryé˜¶æ®µé¢„ç•™çš„èµ„æº ä»£ç ç¤ºä¾‹ 1// è®¢å•æœåŠ¡ 2@Service 3public class OrderService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 /** 9 * Tryï¼šåˆ›å»ºè®¢å•ï¼ŒçŠ¶æ€ä¸ºINIT 10 */ 11 @Transactional 12 public Long tryCreateOrder(OrderDTO orderDTO) { 13 Order order = new Order(); 14 order.setUserId(orderDTO.getUserId()); 15 order.setAmount(orderDTO.getAmount()); 16 order.setStatus(OrderStatus.INIT); // åˆå§‹çŠ¶æ€ 17 orderMapper.insert(order); 18 return order.getId(); 19 } 20 21 /** 22 * Confirmï¼šç¡®è®¤è®¢å•ï¼ŒçŠ¶æ€æ”¹ä¸ºSUCCESS 23 */ 24 @Transactional 25 public void confirmOrder(Long orderId) { 26 Order order = orderMapper.selectById(orderId); 27 order.setStatus(OrderStatus.SUCCESS); 28 orderMapper.updateById(order); 29 } 30 31 /** 32 * Cancelï¼šå–æ¶ˆè®¢å•ï¼ŒçŠ¶æ€æ”¹ä¸ºCANCEL 33 */ 34 @Transactional 35 public void cancelOrder(Long orderId) { 36 Order order = orderMapper.selectById(orderId); 37 order.setStatus(OrderStatus.CANCEL); 38 orderMapper.updateById(order); 39 } 40} 41 42// åº“å­˜æœåŠ¡ 43@Service 44public class InventoryService { 45 46 @Autowired 47 private InventoryMapper inventoryMapper; 48 49 /** 50 * Tryï¼šå†»ç»“åº“å­˜ 51 */ 52 @Transactional 53 public void tryDeductInventory(Long productId, Integer quantity) { 54 Inventory inventory = inventoryMapper.selectByProductId(productId); 55 56 // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³ 57 if (inventory.getAvailable() \u0026lt; quantity) { 58 throw new BusinessException(\u0026#34;åº“å­˜ä¸è¶³\u0026#34;); 59 } 60 61 // å†»ç»“åº“å­˜ 62 inventory.setAvailable(inventory.getAvailable() - quantity); 63 inventory.setFrozen(inventory.getFrozen() + quantity); 64 inventoryMapper.updateById(inventory); 65 } 66 67 /** 68 * Confirmï¼šæ‰£å‡å†»ç»“åº“å­˜ 69 */ 70 @Transactional 71 public void confirmDeductInventory(Long productId, Integer quantity) { 72 Inventory inventory = inventoryMapper.selectByProductId(productId); 73 inventory.setFrozen(inventory.getFrozen() - quantity); 74 inventoryMapper.updateById(inventory); 75 } 76 77 /** 78 * Cancelï¼šé‡Šæ”¾å†»ç»“åº“å­˜ 79 */ 80 @Transactional 81 public void cancelDeductInventory(Long productId, Integer quantity) { 82 Inventory inventory = inventoryMapper.selectByProductId(productId); 83 inventory.setAvailable(inventory.getAvailable() + quantity); 84 inventory.setFrozen(inventory.getFrozen() - quantity); 85 inventoryMapper.updateById(inventory); 86 } 87} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nä¸ä¾èµ–èµ„æºç®¡ç†å™¨çš„äº‹åŠ¡æ”¯æŒ æ€§èƒ½è¾ƒå¥½ï¼Œä¸ä¼šé•¿æ—¶é—´é”å®šèµ„æº å¯ä»¥è·¨æ•°æ®åº“ã€è·¨åº”ç”¨ ç¼ºç‚¹ï¼š\nä¸šåŠ¡ä¾µå…¥æ€§å¼ºï¼Œéœ€è¦å®ç°Tryã€Confirmã€Cancelä¸‰ä¸ªæ–¹æ³• å®ç°å¤æ‚ï¼Œéœ€è¦è€ƒè™‘å¹‚ç­‰æ€§ã€ç©ºå›æ»šã€æ‚¬æŒ‚ç­‰é—®é¢˜ Sagaæ¨¡å¼ åŸç† å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°çŸ­äº‹åŠ¡ï¼Œæ¯ä¸ªçŸ­äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿äº‹åŠ¡ã€‚\næ­£å‘æµç¨‹ï¼šT1 â†’ T2 â†’ T3 â†’ \u0026hellip; â†’ Tn\nè¡¥å¿æµç¨‹ï¼šC1 â† C2 â† C3 â† \u0026hellip; â† Cn\nå®ç°æ–¹å¼ 1. äº‹ä»¶é©±åŠ¨ï¼ˆChoreographyï¼‰ï¼š\næ¯ä¸ªæœåŠ¡å®Œæˆåå‘å¸ƒäº‹ä»¶ ä¸‹ä¸€ä¸ªæœåŠ¡ç›‘å¬äº‹ä»¶å¹¶æ‰§è¡Œ 2. å‘½ä»¤åè°ƒï¼ˆOrchestrationï¼‰ï¼š\nä¸­å¤®åè°ƒå™¨æ§åˆ¶æ•´ä¸ªæµç¨‹ åè°ƒå™¨è°ƒç”¨å„ä¸ªæœåŠ¡ ä»£ç ç¤ºä¾‹ 1// Sagaåè°ƒå™¨ 2@Service 3public class OrderSagaOrchestrator { 4 5 @Autowired 6 private OrderService orderService; 7 8 @Autowired 9 private InventoryService inventoryService; 10 11 @Autowired 12 private AccountService accountService; 13 14 public void createOrder(OrderDTO orderDTO) { 15 Long orderId = null; 16 try { 17 // 1. åˆ›å»ºè®¢å• 18 orderId = orderService.createOrder(orderDTO); 19 20 // 2. æ‰£å‡åº“å­˜ 21 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 22 23 // 3. æ‰£å‡ä½™é¢ 24 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 25 26 // 4. å®Œæˆè®¢å• 27 orderService.completeOrder(orderId); 28 29 } catch (Exception e) { 30 // è¡¥å¿æµç¨‹ 31 if (orderId != null) { 32 accountService.refundBalance(orderDTO.getUserId(), orderDTO.getAmount()); 33 inventoryService.restoreInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 34 orderService.cancelOrder(orderId); 35 } 36 throw e; 37 } 38 } 39} ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š\nä¸€é˜¶æ®µæäº¤ï¼Œæ€§èƒ½å¥½ å‚ä¸è€…å¯ä»¥å¼‚æ­¥æ‰§è¡Œ è¡¥å¿æœºåˆ¶çµæ´» ç¼ºç‚¹ï¼š\nä¸ä¿è¯éš”ç¦»æ€§ éœ€è¦è®¾è®¡è¡¥å¿é€»è¾‘ å®ç°å¤æ‚åº¦é«˜ Seataæ¡†æ¶ æ¶æ„ 1åº”ç”¨å±‚ 2 â†“ 3Seata Client (RM + TM) 4 â†“ 5Seata Server (TC) 6 â†“ 7æ•°æ®åº“ ä¸‰ä¸ªè§’è‰²ï¼š\nTC (Transaction Coordinator)ï¼šäº‹åŠ¡åè°ƒå™¨ï¼Œç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ TM (Transaction Manager)ï¼šäº‹åŠ¡ç®¡ç†å™¨ï¼Œå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ RM (Resource Manager)ï¼šèµ„æºç®¡ç†å™¨ï¼Œç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æº ATæ¨¡å¼ Seataçš„é»˜è®¤æ¨¡å¼ï¼ŒåŸºäºæ”¯æŒæœ¬åœ°ACIDäº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“ã€‚\nåŸç†ï¼š\nä¸€é˜¶æ®µï¼šä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—è®°å½•åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æäº¤ äºŒé˜¶æ®µï¼š æäº¤ï¼šå¼‚æ­¥åŒ–ï¼Œå¿«é€Ÿå®Œæˆ å›æ»šï¼šé€šè¿‡å›æ»šæ—¥å¿—è¿›è¡Œåå‘è¡¥å¿ å¿«é€Ÿå¼€å§‹ 1. æ·»åŠ ä¾èµ–ï¼š\n1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;io.seata\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;seata-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;1.7.1\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; 2. é…ç½®Seataï¼š\n1seata: 2 enabled: true 3 application-id: order-service 4 tx-service-group: my_test_tx_group 5 service: 6 vgroup-mapping: 7 my_test_tx_group: default 8 grouplist: 9 default: 127.0.0.1:8091 10 registry: 11 type: nacos 12 nacos: 13 server-addr: 127.0.0.1:8848 14 namespace: public 15 group: SEATA_GROUP 3. åˆ›å»ºundo_logè¡¨ï¼š\n1CREATE TABLE `undo_log` ( 2 `id` bigint(20) NOT NULL AUTO_INCREMENT, 3 `branch_id` bigint(20) NOT NULL, 4 `xid` varchar(100) NOT NULL, 5 `context` varchar(128) NOT NULL, 6 `rollback_info` longblob NOT NULL, 7 `log_status` int(11) NOT NULL, 8 `log_created` datetime NOT NULL, 9 `log_modified` datetime NOT NULL, 10 PRIMARY KEY (`id`), 11 UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`) 12) ENGINE=InnoDB DEFAULT CHARSET=utf8; 4. ä½¿ç”¨@GlobalTransactionalï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 @Autowired 8 private InventoryServiceClient inventoryService; 9 10 @Autowired 11 private AccountServiceClient accountService; 12 13 @GlobalTransactional(name = \u0026#34;create-order\u0026#34;, rollbackFor = Exception.class) 14 public void createOrder(OrderDTO orderDTO) { 15 // 1. åˆ›å»ºè®¢å• 16 Order order = new Order(); 17 order.setUserId(orderDTO.getUserId()); 18 order.setAmount(orderDTO.getAmount()); 19 orderMapper.insert(order); 20 21 // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰ 22 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 23 24 // 3. æ‰£å‡ä½™é¢ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰ 25 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 26 } 27} TCCæ¨¡å¼ Seataä¹Ÿæ”¯æŒTCCæ¨¡å¼ï¼Œéœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š\n1@LocalTCC 2public interface InventoryTccAction { 3 4 @TwoPhaseBusinessAction(name = \u0026#34;deductInventory\u0026#34;, commitMethod = \u0026#34;commit\u0026#34;, rollbackMethod = \u0026#34;rollback\u0026#34;) 5 boolean prepare(BusinessActionContext context, 6 @BusinessActionContextParameter(paramName = \u0026#34;productId\u0026#34;) Long productId, 7 @BusinessActionContextParameter(paramName = \u0026#34;quantity\u0026#34;) Integer quantity); 8 9 boolean commit(BusinessActionContext context); 10 11 boolean rollback(BusinessActionContext context); 12} 13 14@Service 15public class InventoryTccActionImpl implements InventoryTccAction { 16 17 @Override 18 @Transactional 19 public boolean prepare(BusinessActionContext context, Long productId, Integer quantity) { 20 // Tryï¼šå†»ç»“åº“å­˜ 21 inventoryMapper.freezeInventory(productId, quantity); 22 return true; 23 } 24 25 @Override 26 @Transactional 27 public boolean commit(BusinessActionContext context) { 28 // Confirmï¼šæ‰£å‡å†»ç»“åº“å­˜ 29 Long productId = (Long) context.getActionContext(\u0026#34;productId\u0026#34;); 30 Integer quantity = (Integer) context.getActionContext(\u0026#34;quantity\u0026#34;); 31 inventoryMapper.deductFrozenInventory(productId, quantity); 32 return true; 33 } 34 35 @Override 36 @Transactional 37 public boolean rollback(BusinessActionContext context) { 38 // Cancelï¼šé‡Šæ”¾å†»ç»“åº“å­˜ 39 Long productId = (Long) context.getActionContext(\u0026#34;productId\u0026#34;); 40 Integer quantity = (Integer) context.getActionContext(\u0026#34;quantity\u0026#34;); 41 inventoryMapper.releaseFrozenInventory(productId, quantity); 42 return true; 43 } 44} Sagaæ¨¡å¼ Seataçš„Sagaæ¨¡å¼åŸºäºçŠ¶æ€æœºå¼•æ“ï¼š\n1{ 2 \u0026#34;Name\u0026#34;: \u0026#34;CreateOrderSaga\u0026#34;, 3 \u0026#34;Comment\u0026#34;: \u0026#34;åˆ›å»ºè®¢å•Saga\u0026#34;, 4 \u0026#34;StartState\u0026#34;: \u0026#34;CreateOrder\u0026#34;, 5 \u0026#34;States\u0026#34;: { 6 \u0026#34;CreateOrder\u0026#34;: { 7 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 8 \u0026#34;ServiceName\u0026#34;: \u0026#34;orderService\u0026#34;, 9 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;createOrder\u0026#34;, 10 \u0026#34;CompensateState\u0026#34;: \u0026#34;CancelOrder\u0026#34;, 11 \u0026#34;Next\u0026#34;: \u0026#34;DeductInventory\u0026#34; 12 }, 13 \u0026#34;DeductInventory\u0026#34;: { 14 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 15 \u0026#34;ServiceName\u0026#34;: \u0026#34;inventoryService\u0026#34;, 16 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;deductInventory\u0026#34;, 17 \u0026#34;CompensateState\u0026#34;: \u0026#34;RestoreInventory\u0026#34;, 18 \u0026#34;Next\u0026#34;: \u0026#34;DeductBalance\u0026#34; 19 }, 20 \u0026#34;DeductBalance\u0026#34;: { 21 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 22 \u0026#34;ServiceName\u0026#34;: \u0026#34;accountService\u0026#34;, 23 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;deductBalance\u0026#34;, 24 \u0026#34;CompensateState\u0026#34;: \u0026#34;RefundBalance\u0026#34;, 25 \u0026#34;IsEnd\u0026#34;: true 26 }, 27 \u0026#34;CancelOrder\u0026#34;: { 28 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 29 \u0026#34;ServiceName\u0026#34;: \u0026#34;orderService\u0026#34;, 30 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;cancelOrder\u0026#34;, 31 \u0026#34;IsEnd\u0026#34;: true 32 }, 33 \u0026#34;RestoreInventory\u0026#34;: { 34 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 35 \u0026#34;ServiceName\u0026#34;: \u0026#34;inventoryService\u0026#34;, 36 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;restoreInventory\u0026#34;, 37 \u0026#34;Next\u0026#34;: \u0026#34;CancelOrder\u0026#34; 38 }, 39 \u0026#34;RefundBalance\u0026#34;: { 40 \u0026#34;Type\u0026#34;: \u0026#34;ServiceTask\u0026#34;, 41 \u0026#34;ServiceName\u0026#34;: \u0026#34;accountService\u0026#34;, 42 \u0026#34;ServiceMethod\u0026#34;: \u0026#34;refundBalance\u0026#34;, 43 \u0026#34;Next\u0026#34;: \u0026#34;RestoreInventory\u0026#34; 44 } 45 } 46} XAæ¨¡å¼ Seataçš„XAæ¨¡å¼æ˜¯å¯¹ä¼ ç»ŸXAåè®®çš„å°è£…ï¼š\n1@GlobalTransactional 2public void createOrderXA(OrderDTO orderDTO) { 3 // XAæ¨¡å¼ä¸‹ï¼ŒSeataä¼šè‡ªåŠ¨ç®¡ç†XAäº‹åŠ¡ 4 // ä¸šåŠ¡ä»£ç ä¸ATæ¨¡å¼ç›¸åŒ 5 orderService.createOrder(orderDTO); 6 inventoryService.deductInventory(orderDTO.getProductId(), orderDTO.getQuantity()); 7 accountService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount()); 8} XA vs ATï¼š\nXAï¼šå¼ºä¸€è‡´æ€§ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œéœ€è¦æ•°æ®åº“æ”¯æŒXAåè®® ATï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½è¾ƒå¥½ï¼ŒåŸºäºæœ¬åœ°äº‹åŠ¡ æ–¹æ¡ˆå¯¹æ¯” æ–¹æ¡ˆ ä¸€è‡´æ€§ æ€§èƒ½ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ 2PC/3PC å¼ºä¸€è‡´ ä½ ä¸­ çŸ­äº‹åŠ¡ï¼Œå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜ TCC æœ€ç»ˆä¸€è‡´ é«˜ é«˜ å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œå¯æ¥å—æœ€ç»ˆä¸€è‡´ Saga æœ€ç»ˆä¸€è‡´ é«˜ ä¸­ é•¿äº‹åŠ¡ï¼Œä¸šåŠ¡æµç¨‹å¤æ‚ Seata AT æœ€ç»ˆä¸€è‡´ ä¸­ ä½ ä¸šåŠ¡ä¾µå…¥å°ï¼Œå¿«é€Ÿæ¥å…¥ Seata TCC æœ€ç»ˆä¸€è‡´ é«˜ é«˜ å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶ Seata XA å¼ºä¸€è‡´ ä½ ä½ éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œæ•°æ®åº“æ”¯æŒXA ç”Ÿäº§å®è·µ 1. å¹‚ç­‰æ€§è®¾è®¡ 1@Service 2public class OrderService { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 6 7 @GlobalTransactional 8 public void createOrder(OrderDTO orderDTO) { 9 String idempotentKey = \u0026#34;order:create:\u0026#34; + orderDTO.getRequestId(); 10 11 // æ£€æŸ¥å¹‚ç­‰æ€§ 12 Boolean success = redisTemplate.opsForValue().setIfAbsent( 13 idempotentKey, \u0026#34;1\u0026#34;, 10, TimeUnit.MINUTES 14 ); 15 16 if (!success) { 17 throw new BusinessException(\u0026#34;é‡å¤è¯·æ±‚\u0026#34;); 18 } 19 20 try { 21 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 22 doCreateOrder(orderDTO); 23 } catch (Exception e) { 24 // åˆ é™¤å¹‚ç­‰é”®ï¼Œå…è®¸é‡è¯• 25 redisTemplate.delete(idempotentKey); 26 throw e; 27 } 28 } 29} 2. è¶…æ—¶æ§åˆ¶ 1@GlobalTransactional( 2 name = \u0026#34;create-order\u0026#34;, 3 timeoutMills = 30000, // 30ç§’è¶…æ—¶ 4 rollbackFor = Exception.class 5) 6public void createOrder(OrderDTO orderDTO) { 7 // ä¸šåŠ¡é€»è¾‘ 8} 3. å¼‚å¸¸å¤„ç† 1@Service 2public class OrderService { 3 4 @GlobalTransactional(rollbackFor = Exception.class) 5 public void createOrder(OrderDTO orderDTO) { 6 try { 7 // ä¸šåŠ¡é€»è¾‘ 8 doCreateOrder(orderDTO); 9 } catch (BusinessException e) { 10 // ä¸šåŠ¡å¼‚å¸¸ï¼Œå›æ»š 11 log.error(\u0026#34;åˆ›å»ºè®¢å•å¤±è´¥ï¼š{}\u0026#34;, e.getMessage()); 12 throw e; 13 } catch (Exception e) { 14 // ç³»ç»Ÿå¼‚å¸¸ï¼Œå›æ»š 15 log.error(\u0026#34;ç³»ç»Ÿå¼‚å¸¸\u0026#34;, e); 16 throw new SystemException(\u0026#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); 17 } 18 } 19} 4. ç›‘æ§å‘Šè­¦ 1@Aspect 2@Component 3public class SeataMonitorAspect { 4 5 @Around(\u0026#34;@annotation(globalTransactional)\u0026#34;) 6 public Object monitor(ProceedingJoinPoint pjp, GlobalTransactional globalTransactional) throws Throwable { 7 String txName = globalTransactional.name(); 8 long startTime = System.currentTimeMillis(); 9 10 try { 11 Object result = pjp.proceed(); 12 long duration = System.currentTimeMillis() - startTime; 13 14 // è®°å½•æˆåŠŸæŒ‡æ ‡ 15 Metrics.counter(\u0026#34;seata.transaction.success\u0026#34;, \u0026#34;name\u0026#34;, txName).increment(); 16 Metrics.timer(\u0026#34;seata.transaction.duration\u0026#34;, \u0026#34;name\u0026#34;, txName).record(duration, TimeUnit.MILLISECONDS); 17 18 return result; 19 } catch (Exception e) { 20 // è®°å½•å¤±è´¥æŒ‡æ ‡ 21 Metrics.counter(\u0026#34;seata.transaction.failure\u0026#34;, \u0026#34;name\u0026#34;, txName).increment(); 22 throw e; 23 } 24 } 25} é¿å‘æç¤ºï¼š åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼ŒåŠ¡å¿…æ³¨æ„ï¼š1) è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼›2) å®ç°å¹‚ç­‰æ€§ï¼›3) åšå¥½ç›‘æ§å‘Šè­¦ï¼›4) å‡†å¤‡é™çº§æ–¹æ¡ˆï¼›5) å®šæœŸæ¸…ç†undo_logè¡¨ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼š\n2PC/3PCï¼šå¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½å·®ï¼Œé€‚åˆçŸ­äº‹åŠ¡ TCCï¼šæ€§èƒ½å¥½ï¼Œä½†å®ç°å¤æ‚ï¼Œé€‚åˆå¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ Sagaï¼šé€‚åˆé•¿äº‹åŠ¡ï¼Œè¡¥å¿æœºåˆ¶çµæ´» Seata ATï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸šåŠ¡ä¾µå…¥å°ï¼Œé€‚åˆå¿«é€Ÿæ¥å…¥ Seata TCCï¼šæ€§èƒ½å¥½ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶ Seata XAï¼šå¼ºä¸€è‡´æ€§ï¼Œå®ç°ç®€å•ï¼Œä½†æ€§èƒ½è¾ƒå·® é€‰æ‹©åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆæ—¶ï¼Œéœ€è¦è€ƒè™‘ï¼š\nä¸€è‡´æ€§è¦æ±‚ï¼šå¼ºä¸€è‡´è¿˜æ˜¯æœ€ç»ˆä¸€è‡´ æ€§èƒ½è¦æ±‚ï¼šèƒ½å¦æ¥å—é˜»å¡å’Œé”å®š ä¸šåŠ¡å¤æ‚åº¦ï¼šäº‹åŠ¡é“¾è·¯é•¿åº¦å’Œå¤æ‚åº¦ å¼€å‘æˆæœ¬ï¼šå®ç°å’Œç»´æŠ¤çš„å¤æ‚åº¦ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå»ºè®®ï¼š\nä¼˜å…ˆè€ƒè™‘ä¸šåŠ¡è®¾è®¡ï¼Œé¿å…åˆ†å¸ƒå¼äº‹åŠ¡ èƒ½ç”¨æœ€ç»ˆä¸€è‡´æ€§å°±ä¸ç”¨å¼ºä¸€è‡´æ€§ Seata ATæ¨¡å¼é€‚åˆå¿«é€Ÿæ¥å…¥ å¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ä½¿ç”¨TCCæˆ–Saga éœ€è¦å¼ºä¸€è‡´æ€§ä¸”æ•°æ®åº“æ”¯æŒXAæ—¶ä½¿ç”¨XAæ¨¡å¼ ä¸‹æ¬¡å½“ä½ éœ€è¦å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œä¸å¦¨æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\n","permalink":"http://localhost:1313/posts/2025/12/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%BB%8E-2pc-%E5%88%B0-seata-%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B8%8E%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œå¾€å¾€éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯è¿™äº›æ“ä½œçš„ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªç»å…¸éš¾é¢˜ã€‚æœ¬æ–‡å°†ç³»ç»Ÿè®²è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒé—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡2PCã€3PCã€TCCã€Sagaç­‰æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨Seataæ¡†æ¶è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜\"\u003eåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"ä¸šåŠ¡åœºæ™¯\"\u003eä¸šåŠ¡åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eç”µå•†ä¸‹å•åœºæ™¯ï¼Œæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eç”¨æˆ·ä¸‹å•\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003eè®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003eåº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003eè´¦æˆ·æœåŠ¡ï¼šæ‰£å‡ä½™é¢\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003eç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ†\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eé—®é¢˜\u003c/strong\u003eï¼šå¦‚æœæŸä¸ªæœåŠ¡å¤±è´¥ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\u003c/p\u003e\n\u003ch3 id=\"capç†è®º\"\u003eCAPç†è®º\u003c/h3\u003e\n\u003cp\u003eåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸‰ä¸ªç‰¹æ€§ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eC (Consistency)\u003c/strong\u003eï¼šä¸€è‡´æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eA (Availability)\u003c/strong\u003eï¼šå¯ç”¨æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eP (Partition Tolerance)\u003c/strong\u003eï¼šåˆ†åŒºå®¹é”™æ€§\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eCAPå®šç†\u003c/strong\u003eï¼šä¸‰è€…æœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤ä¸ª\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå®é™…é€‰æ‹©\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCPï¼šç‰ºç‰²å¯ç”¨æ€§ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ˆå¦‚ZooKeeperï¼‰\u003c/li\u003e\n\u003cli\u003eAPï¼šç‰ºç‰²ä¸€è‡´æ€§ï¼Œä¿è¯å¯ç”¨æ€§ï¼ˆå¦‚Eurekaï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"baseç†è®º\"\u003eBASEç†è®º\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eBA (Basically Available)\u003c/strong\u003eï¼šåŸºæœ¬å¯ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eS (Soft State)\u003c/strong\u003eï¼šè½¯çŠ¶æ€\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eE (Eventually Consistent)\u003c/strong\u003eï¼šæœ€ç»ˆä¸€è‡´æ€§\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¼ºä¸€è‡´æ€§å¾€å¾€éš¾ä»¥å®ç°ä¸”ä»£ä»·é«˜æ˜‚ã€‚å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼Œè¿™ä¹Ÿæ˜¯ç°ä»£åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆçš„åŸºç¡€ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"2pcä¸¤é˜¶æ®µæäº¤\"\u003e2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰\u003c/h2\u003e\n\u003ch3 id=\"åŸç†\"\u003eåŸç†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€Prepareè¯·æ±‚\u003c/li\u003e\n\u003cli\u003eå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤\u003c/li\u003e\n\u003cli\u003eå‚ä¸è€…è¿”å›Yesæˆ–No\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eç¬¬äºŒé˜¶æ®µï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›Yesï¼Œåè°ƒè€…å‘é€Commitè¯·æ±‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœæœ‰å‚ä¸è€…è¿”å›Noï¼Œåè°ƒè€…å‘é€Rollbackè¯·æ±‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"æµç¨‹å›¾\"\u003eæµç¨‹å›¾\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003eåè°ƒè€…                å‚ä¸è€…1              å‚ä¸è€…2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Prepare----------\u0026gt;|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Prepare----------------------------\u0026gt;|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |\u0026lt;--Yes/No------------|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |\u0026lt;--Yes/No-------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |                     |                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Commit/Rollback--\u0026gt;|                    |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e  |---Commit/Rollback----------------------\u0026gt;|\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ä»£ç ç¤ºä¾‹\"\u003eä»£ç ç¤ºä¾‹\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eTwoPhaseCommitCoordinator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eexecuteTransaction\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecanCommit\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¬¬äºŒé˜¶æ®µï¼šæäº¤æˆ–å›æ»š\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecanCommit\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e                \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e35\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipants\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e36\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eparticipant\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e37\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e38\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e39\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e40\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e41\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eParticipant\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e42\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eprepare\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e43\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecommit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e44\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003erollback\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e45\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ä¼˜ç¼ºç‚¹\"\u003eä¼˜ç¼ºç‚¹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¼˜ç‚¹\u003c/strong\u003eï¼š\u003c/p\u003e","title":"åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼šä» 2PC åˆ° Seata çš„æ¼”è¿›ä¸å®æˆ˜"},{"content":"é˜…è¯»ä¼˜ç§€çš„å¼€æºé¡¹ç›®æºç æ˜¯æå‡æŠ€æœ¯èƒ½åŠ›çš„æœ€ä½³é€”å¾„ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œé¢å¯¹åŠ¨è¾„å‡ åä¸‡è¡Œçš„ä»£ç ï¼Œå¾ˆå¤šäººä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹ã€‚æœ¬æ–‡å°†ä»¥Spring Bootä¸ºä¾‹ï¼Œç³»ç»Ÿè®²è§£å¦‚ä½•é«˜æ•ˆåœ°é˜…è¯»å’Œå­¦ä¹ å¼€æºé¡¹ç›®æºç ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æºç é˜…è¯»çš„ç³»ç»Ÿæ–¹æ³•è®º å­¦ä¼šä½¿ç”¨å·¥å…·è¾…åŠ©æºç é˜…è¯» ç†è§£Spring Bootçš„æ ¸å¿ƒè®¾è®¡æ€æƒ³ æŒæ¡ä»å®è§‚åˆ°å¾®è§‚çš„é˜…è¯»ç­–ç•¥ å»ºç«‹æºç å­¦ä¹ çš„é•¿æ•ˆæœºåˆ¶ ä¸ºä»€ä¹ˆè¦è¯»æºç  æºç é˜…è¯»çš„ä»·å€¼ æ·±å…¥ç†è§£åŸç†ï¼šçŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶ å­¦ä¹ è®¾è®¡æ¨¡å¼ï¼šçœ‹å¤§å¸ˆå¦‚ä½•è®¾è®¡æ¶æ„ æå‡ç¼–ç èƒ½åŠ›ï¼šå­¦ä¹ ä¼˜ç§€çš„ä»£ç é£æ ¼ è§£å†³ç–‘éš¾é—®é¢˜ï¼šé‡åˆ°é—®é¢˜èƒ½å¿«é€Ÿå®šä½ å‚ä¸å¼€æºè´¡çŒ®ï¼šä¸ºå¼€æºç¤¾åŒºåšè´¡çŒ® å¸¸è§è¯¯åŒº âŒ ä»ç¬¬ä¸€è¡Œå¼€å§‹è¯»ï¼šå®¹æ˜“è¿·å¤±åœ¨ç»†èŠ‚ä¸­ âŒ è¿½æ±‚å®Œå…¨ç†è§£ï¼šè¯•å›¾ç†è§£æ¯ä¸€è¡Œä»£ç  âŒ æ²¡æœ‰ç›®æ ‡ï¼šæ¼«æ— ç›®çš„åœ°æµè§ˆä»£ç  âŒ åªçœ‹ä¸ç»ƒï¼šåªçœ‹ä¸å†™ï¼Œæ— æ³•çœŸæ­£æŒæ¡\nâœ… å¸¦ç€é—®é¢˜è¯»ï¼šå›´ç»•å…·ä½“é—®é¢˜å±•å¼€ âœ… æŠ“ä½ä¸»çº¿ï¼šç†è§£æ ¸å¿ƒæµç¨‹å’Œè®¾è®¡æ€æƒ³ âœ… å¾ªåºæ¸è¿›ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥ âœ… è¾¹è¯»è¾¹å†™ï¼šé€šè¿‡å®è·µåŠ æ·±ç†è§£\næ¶æ„æ€è€ƒï¼š é˜…è¯»æºç ä¸æ˜¯ä¸ºäº†è®°ä½æ¯ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯ç†è§£è®¾è®¡æ€æƒ³å’Œæ¶æ„æ¨¡å¼ã€‚è¦å­¦ä¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œä»æ•´ä½“åˆ°ç»†èŠ‚çš„é˜…è¯»æ–¹æ³•ã€‚\næºç é˜…è¯»æ–¹æ³•è®º 1. å‡†å¤‡é˜¶æ®µ é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼š\né€‰æ‹©ç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚Spring Boot 2.7.xï¼‰ é¿å…é€‰æ‹©æœ€æ–°çš„å¼€å‘ç‰ˆæœ¬ æŸ¥çœ‹ç‰ˆæœ¬çš„Release Notes æ­å»ºè°ƒè¯•ç¯å¢ƒï¼š\n1# 1. å…‹éš†æºç  2git clone https://github.com/spring-projects/spring-boot.git 3cd spring-boot 4 5# 2. åˆ‡æ¢åˆ°ç¨³å®šç‰ˆæœ¬ 6git checkout v2.7.18 7 8# 3. å¯¼å…¥IDEï¼ˆIDEAï¼‰ 9# File -\u0026gt; Open -\u0026gt; é€‰æ‹©spring-bootç›®å½• å‡†å¤‡ç¤ºä¾‹é¡¹ç›®ï¼š\n1\u0026lt;!-- pom.xml --\u0026gt; 2\u0026lt;parent\u0026gt; 3 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 4 \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; 5 \u0026lt;version\u0026gt;2.7.18\u0026lt;/version\u0026gt; 6\u0026lt;/parent\u0026gt; 7 8\u0026lt;dependencies\u0026gt; 9 \u0026lt;dependency\u0026gt; 10 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 11 \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; 12 \u0026lt;/dependency\u0026gt; 13\u0026lt;/dependencies\u0026gt; 2. å®è§‚é˜¶æ®µ äº†è§£é¡¹ç›®ç»“æ„ï¼š\n1spring-boot/ 2â”œâ”€â”€ spring-boot-project/ 3â”‚ â”œâ”€â”€ spring-boot/ # æ ¸å¿ƒæ¨¡å— 4â”‚ â”œâ”€â”€ spring-boot-autoconfigure/ # è‡ªåŠ¨é…ç½® 5â”‚ â”œâ”€â”€ spring-boot-starters/ # Starterä¾èµ– 6â”‚ â”œâ”€â”€ spring-boot-actuator/ # ç›‘æ§ç«¯ç‚¹ 7â”‚ â””â”€â”€ spring-boot-test/ # æµ‹è¯•æ”¯æŒ 8â”œâ”€â”€ spring-boot-samples/ # ç¤ºä¾‹é¡¹ç›® 9â””â”€â”€ spring-boot-tests/ # é›†æˆæµ‹è¯• é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼š\nSpring Boot Reference Documentation äº†è§£æ ¸å¿ƒç‰¹æ€§å’Œä½¿ç”¨æ–¹å¼ ç†è§£è®¾è®¡ç†å¿µå’Œæ¶æ„æ€æƒ³ ç»˜åˆ¶æ¶æ„å›¾ï¼š\n1åº”ç”¨å¯åŠ¨ 2 â†“ 3@SpringBootApplication 4 â†“ 5SpringApplication.run() 6 â†“ 7åˆ›å»ºApplicationContext 8 â†“ 9è‡ªåŠ¨é…ç½®ï¼ˆAutoConfigurationï¼‰ 10 â†“ 11å¯åŠ¨å†…åµŒWebæœåŠ¡å™¨ 12 â†“ 13åº”ç”¨å°±ç»ª 3. å¾®è§‚é˜¶æ®µ é€‰æ‹©åˆ‡å…¥ç‚¹ï¼š\nä»æœ€å¸¸ç”¨çš„åŠŸèƒ½å¼€å§‹ï¼ˆå¦‚å¯åŠ¨æµç¨‹ï¼‰ ä»é‡åˆ°çš„é—®é¢˜å¼€å§‹ï¼ˆå¦‚è‡ªåŠ¨é…ç½®åŸç†ï¼‰ ä»æ„Ÿå…´è¶£çš„ç‰¹æ€§å¼€å§‹ï¼ˆå¦‚æ¡ä»¶æ³¨è§£ï¼‰ ä½¿ç”¨è°ƒè¯•å·¥å…·ï¼š\næ–­ç‚¹è°ƒè¯•ï¼šè§‚å¯Ÿæ‰§è¡Œæµç¨‹ è°ƒç”¨æ ˆï¼šç†è§£æ–¹æ³•è°ƒç”¨å…³ç³» å˜é‡ç›‘è§†ï¼šæŸ¥çœ‹å¯¹è±¡çŠ¶æ€ Spring Boot å¯åŠ¨æµç¨‹åˆ†æ å…¥å£ï¼š@SpringBootApplication 1@SpringBootApplication 2public class DemoApplication { 3 public static void main(String[] args) { 4 SpringApplication.run(DemoApplication.class, args); 5 } 6} @SpringBootApplication æ³¨è§£ï¼š\n1@Target(ElementType.TYPE) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4@Inherited 5@SpringBootConfiguration // 1. é…ç½®ç±» 6@EnableAutoConfiguration // 2. è‡ªåŠ¨é…ç½® 7@ComponentScan // 3. ç»„ä»¶æ‰«æ 8public @interface SpringBootApplication { 9 // ... 10} ä¸‰ä¸ªæ ¸å¿ƒæ³¨è§£ï¼š\n@SpringBootConfigurationï¼šæ ‡è®°ä¸ºé…ç½®ç±» @EnableAutoConfigurationï¼šå¯ç”¨è‡ªåŠ¨é…ç½® @ComponentScanï¼šæ‰«æç»„ä»¶ SpringApplication.run() æµç¨‹ 1public class SpringApplication { 2 3 public static ConfigurableApplicationContext run(Class\u0026lt;?\u0026gt; primarySource, String... args) { 4 return run(new Class\u0026lt;?\u0026gt;[] { primarySource }, args); 5 } 6 7 public static ConfigurableApplicationContext run(Class\u0026lt;?\u0026gt;[] primarySources, String[] args) { 8 // åˆ›å»ºSpringApplicationå®ä¾‹å¹¶è¿è¡Œ 9 return new SpringApplication(primarySources).run(args); 10 } 11 12 public ConfigurableApplicationContext run(String... args) { 13 // 1. åˆ›å»ºStopWatchï¼Œè®°å½•å¯åŠ¨æ—¶é—´ 14 StopWatch stopWatch = new StopWatch(); 15 stopWatch.start(); 16 17 // 2. åˆ›å»ºBootstrapä¸Šä¸‹æ–‡ 18 DefaultBootstrapContext bootstrapContext = createBootstrapContext(); 19 ConfigurableApplicationContext context = null; 20 21 // 3. é…ç½®Headlesså±æ€§ 22 configureHeadlessProperty(); 23 24 // 4. è·å–SpringApplicationRunListeners 25 SpringApplicationRunListeners listeners = getRunListeners(args); 26 listeners.starting(bootstrapContext, this.mainApplicationClass); 27 28 try { 29 // 5. å‡†å¤‡ç¯å¢ƒ 30 ApplicationArguments applicationArguments = new DefaultApplicationArguments(args); 31 ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments); 32 33 // 6. æ‰“å°Banner 34 Banner printedBanner = printBanner(environment); 35 36 // 7. åˆ›å»ºApplicationContext 37 context = createApplicationContext(); 38 context.setApplicationStartup(this.applicationStartup); 39 40 // 8. å‡†å¤‡Context 41 prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner); 42 43 // 9. åˆ·æ–°Contextï¼ˆæ ¸å¿ƒï¼‰ 44 refreshContext(context); 45 46 // 10. åˆ·æ–°åå¤„ç† 47 afterRefresh(context, applicationArguments); 48 49 stopWatch.stop(); 50 51 // 11. å‘å¸ƒå¯åŠ¨å®Œæˆäº‹ä»¶ 52 listeners.started(context); 53 54 // 12. è°ƒç”¨Runners 55 callRunners(context, applicationArguments); 56 } 57 catch (Throwable ex) { 58 handleRunFailure(context, ex, listeners); 59 throw new IllegalStateException(ex); 60 } 61 62 try { 63 listeners.running(context); 64 } 65 catch (Throwable ex) { 66 handleRunFailure(context, ex, null); 67 throw new IllegalStateException(ex); 68 } 69 70 return context; 71 } 72} å¯åŠ¨æµç¨‹å›¾ï¼š\n11. åˆ›å»ºStopWatch 2 â†“ 32. åˆ›å»ºBootstrapä¸Šä¸‹æ–‡ 4 â†“ 53. è·å–RunListeners 6 â†“ 74. å‡†å¤‡Environment 8 â†“ 95. æ‰“å°Banner 10 â†“ 116. åˆ›å»ºApplicationContext 12 â†“ 137. å‡†å¤‡Context 14 â†“ 158. åˆ·æ–°Contextï¼ˆåŠ è½½Beanï¼‰ 16 â†“ 179. è°ƒç”¨Runners 18 â†“ 1910. å‘å¸ƒå¯åŠ¨å®Œæˆäº‹ä»¶ è‡ªåŠ¨é…ç½®åŸç† @EnableAutoConfiguration 1@Target(ElementType.TYPE) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4@Inherited 5@AutoConfigurationPackage 6@Import(AutoConfigurationImportSelector.class) // æ ¸å¿ƒ 7public @interface EnableAutoConfiguration { 8 // ... 9} AutoConfigurationImportSelector 1public class AutoConfigurationImportSelector implements DeferredImportSelector { 2 3 @Override 4 public String[] selectImports(AnnotationMetadata annotationMetadata) { 5 if (!isEnabled(annotationMetadata)) { 6 return NO_IMPORTS; 7 } 8 9 // 1. è·å–è‡ªåŠ¨é…ç½®ç±» 10 AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(annotationMetadata); 11 return StringUtils.toStringArray(autoConfigurationEntry.getConfigurations()); 12 } 13 14 protected AutoConfigurationEntry getAutoConfigurationEntry(AnnotationMetadata annotationMetadata) { 15 if (!isEnabled(annotationMetadata)) { 16 return EMPTY_ENTRY; 17 } 18 19 AnnotationAttributes attributes = getAttributes(annotationMetadata); 20 21 // 2. åŠ è½½å€™é€‰é…ç½®ç±» 22 List\u0026lt;String\u0026gt; configurations = getCandidateConfigurations(annotationMetadata, attributes); 23 24 // 3. å»é‡ 25 configurations = removeDuplicates(configurations); 26 27 // 4. æ’é™¤æŒ‡å®šçš„é…ç½®ç±» 28 Set\u0026lt;String\u0026gt; exclusions = getExclusions(annotationMetadata, attributes); 29 checkExcludedClasses(configurations, exclusions); 30 configurations.removeAll(exclusions); 31 32 // 5. è¿‡æ»¤ï¼ˆæ ¹æ®æ¡ä»¶æ³¨è§£ï¼‰ 33 configurations = getConfigurationClassFilter().filter(configurations); 34 35 // 6. è§¦å‘è‡ªåŠ¨é…ç½®å¯¼å…¥äº‹ä»¶ 36 fireAutoConfigurationImportEvents(configurations, exclusions); 37 38 return new AutoConfigurationEntry(configurations, exclusions); 39 } 40 41 protected List\u0026lt;String\u0026gt; getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) { 42 // ä»META-INF/spring.factoriesåŠ è½½é…ç½®ç±» 43 List\u0026lt;String\u0026gt; configurations = SpringFactoriesLoader.loadFactoryNames( 44 getSpringFactoriesLoaderFactoryClass(), 45 getBeanClassLoader() 46 ); 47 return configurations; 48 } 49} spring.factories 1# spring-boot-autoconfigure/META-INF/spring.factories 2 3org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 4org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\\ 5org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\\ 6org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\\ 7org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\\ 8org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration,\\ 9... è‡ªåŠ¨é…ç½®ç¤ºä¾‹ 1@Configuration(proxyBeanMethods = false) 2@ConditionalOnClass({ DataSource.class, EmbeddedDatabaseType.class }) 3@ConditionalOnMissingBean(type = \u0026#34;io.r2dbc.spi.ConnectionFactory\u0026#34;) 4@EnableConfigurationProperties(DataSourceProperties.class) 5@Import({ DataSourcePoolMetadataProvidersConfiguration.class }) 6public class DataSourceAutoConfiguration { 7 8 @Configuration(proxyBeanMethods = false) 9 @Conditional(EmbeddedDatabaseCondition.class) 10 @ConditionalOnMissingBean({ DataSource.class, XADataSource.class }) 11 @Import(EmbeddedDataSourceConfiguration.class) 12 protected static class EmbeddedDatabaseConfiguration { 13 } 14 15 @Configuration(proxyBeanMethods = false) 16 @Conditional(PooledDataSourceCondition.class) 17 @ConditionalOnMissingBean({ DataSource.class, XADataSource.class }) 18 @Import({ DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class, 19 DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.OracleUcp.class, 20 DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class }) 21 protected static class PooledDataSourceConfiguration { 22 } 23} æ¡ä»¶æ³¨è§£ï¼š\n@ConditionalOnClassï¼šç±»è·¯å¾„å­˜åœ¨æŒ‡å®šç±» @ConditionalOnMissingBeanï¼šå®¹å™¨ä¸­ä¸å­˜åœ¨æŒ‡å®šBean @ConditionalOnPropertyï¼šé…ç½®æ–‡ä»¶å­˜åœ¨æŒ‡å®šå±æ€§ æ¡ä»¶æ³¨è§£åŸç† @Conditional 1@Target({ ElementType.TYPE, ElementType.METHOD }) 2@Retention(RetentionPolicy.RUNTIME) 3@Documented 4public @interface Conditional { 5 Class\u0026lt;? extends Condition\u0026gt;[] value(); 6} Conditionæ¥å£ 1@FunctionalInterface 2public interface Condition { 3 boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata); 4} OnClassConditionå®ç° 1@Order(Ordered.HIGHEST_PRECEDENCE) 2class OnClassCondition extends FilteringSpringBootCondition { 3 4 @Override 5 public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) { 6 ClassLoader classLoader = context.getClassLoader(); 7 ConditionMessage matchMessage = ConditionMessage.empty(); 8 9 // è·å–@ConditionalOnClassæ³¨è§£çš„value 10 List\u0026lt;String\u0026gt; onClasses = getCandidates(metadata, ConditionalOnClass.class); 11 if (onClasses != null) { 12 // æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨ 13 List\u0026lt;String\u0026gt; missing = filter(onClasses, ClassNameFilter.MISSING, classLoader); 14 if (!missing.isEmpty()) { 15 return ConditionOutcome.noMatch( 16 ConditionMessage.forCondition(ConditionalOnClass.class) 17 .didNotFind(\u0026#34;required class\u0026#34;, \u0026#34;required classes\u0026#34;) 18 .items(Style.QUOTE, missing) 19 ); 20 } 21 matchMessage = matchMessage.andCondition(ConditionalOnClass.class) 22 .found(\u0026#34;required class\u0026#34;, \u0026#34;required classes\u0026#34;) 23 .items(Style.QUOTE, filter(onClasses, ClassNameFilter.PRESENT, classLoader)); 24 } 25 26 // è·å–@ConditionalOnMissingClassæ³¨è§£çš„value 27 List\u0026lt;String\u0026gt; onMissingClasses = getCandidates(metadata, ConditionalOnMissingClass.class); 28 if (onMissingClasses != null) { 29 // æ£€æŸ¥ç±»æ˜¯å¦ä¸å­˜åœ¨ 30 List\u0026lt;String\u0026gt; present = filter(onMissingClasses, ClassNameFilter.PRESENT, classLoader); 31 if (!present.isEmpty()) { 32 return ConditionOutcome.noMatch( 33 ConditionMessage.forCondition(ConditionalOnMissingClass.class) 34 .found(\u0026#34;unwanted class\u0026#34;, \u0026#34;unwanted classes\u0026#34;) 35 .items(Style.QUOTE, present) 36 ); 37 } 38 matchMessage = matchMessage.andCondition(ConditionalOnMissingClass.class) 39 .didNotFind(\u0026#34;unwanted class\u0026#34;, \u0026#34;unwanted classes\u0026#34;) 40 .items(Style.QUOTE, filter(onMissingClasses, ClassNameFilter.MISSING, classLoader)); 41 } 42 43 return ConditionOutcome.match(matchMessage); 44 } 45} æºç é˜…è¯»æŠ€å·§ 1. ä½¿ç”¨IDEAè°ƒè¯• è®¾ç½®æ–­ç‚¹ï¼š\n1// åœ¨å…³é”®æ–¹æ³•è®¾ç½®æ–­ç‚¹ 2public ConfigurableApplicationContext run(String... args) { 3 // æ–­ç‚¹1ï¼šå¯åŠ¨å…¥å£ 4 StopWatch stopWatch = new StopWatch(); 5 stopWatch.start(); 6 7 // æ–­ç‚¹2ï¼šåˆ›å»ºContext 8 context = createApplicationContext(); 9 10 // æ–­ç‚¹3ï¼šåˆ·æ–°Context 11 refreshContext(context); 12 13 return context; 14} æŸ¥çœ‹è°ƒç”¨æ ˆï¼š\nä½¿ç”¨Ctrl+Alt+HæŸ¥çœ‹æ–¹æ³•è°ƒç”¨å±‚æ¬¡ ä½¿ç”¨Alt+F7æŸ¥æ‰¾æ–¹æ³•ä½¿ç”¨ä½ç½® æ¡ä»¶æ–­ç‚¹ï¼š\n1// åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è§¦å‘æ–­ç‚¹ 2if (beanName.equals(\u0026#34;dataSource\u0026#34;)) { 3 // æ–­ç‚¹ï¼šåªåœ¨åˆ›å»ºdataSourceæ—¶è§¦å‘ 4} 2. ç»˜åˆ¶æµç¨‹å›¾ ä½¿ç”¨å·¥å…·ç»˜åˆ¶å…³é”®æµç¨‹ï¼š\nDraw.io PlantUML Mermaid 1sequenceDiagram 2 participant Main 3 participant SpringApplication 4 participant Context 5 participant AutoConfig 6 7 Main-\u0026gt;\u0026gt;SpringApplication: run() 8 SpringApplication-\u0026gt;\u0026gt;Context: createApplicationContext() 9 SpringApplication-\u0026gt;\u0026gt;AutoConfig: loadAutoConfiguration() 10 AutoConfig-\u0026gt;\u0026gt;Context: registerBeans() 11 SpringApplication-\u0026gt;\u0026gt;Context: refresh() 12 Context--\u0026gt;\u0026gt;Main: ApplicationContext 3. åšç¬”è®° è®°å½•å…³é”®ç‚¹ï¼š\næ ¸å¿ƒç±»å’Œæ¥å£ è®¾è®¡æ¨¡å¼çš„åº”ç”¨ å·§å¦™çš„å®ç°æŠ€å·§ ç–‘é—®å’Œå¾…ç ”ç©¶çš„é—®é¢˜ ç¤ºä¾‹ç¬”è®°ï¼š\n1## SpringApplicationå¯åŠ¨æµç¨‹ 2 3### æ ¸å¿ƒæ–¹æ³• 4- `run(String... args)`: å¯åŠ¨å…¥å£ 5- `prepareEnvironment()`: å‡†å¤‡ç¯å¢ƒ 6- `createApplicationContext()`: åˆ›å»ºä¸Šä¸‹æ–‡ 7- `refreshContext()`: åˆ·æ–°ä¸Šä¸‹æ–‡ 8 9### è®¾è®¡æ¨¡å¼ 10- æ¨¡æ¿æ–¹æ³•ï¼šrun()æ–¹æ³•å®šä¹‰æµç¨‹ï¼Œå­ç±»å¯æ‰©å±• 11- ç­–ç•¥æ¨¡å¼ï¼šApplicationContextFactoryåˆ›å»ºä¸åŒç±»å‹çš„Context 12- è§‚å¯Ÿè€…æ¨¡å¼ï¼šSpringApplicationRunListenersç›‘å¬å¯åŠ¨äº‹ä»¶ 13 14### ç–‘é—® 15- [ ] Environmentæ˜¯å¦‚ä½•åŠ è½½é…ç½®æ–‡ä»¶çš„ï¼Ÿ 16- [ ] Beançš„å¾ªç¯ä¾èµ–æ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ 4. å†™æµ‹è¯•ä»£ç  éªŒè¯ç†è§£ï¼š\n1@Test 2public void testAutoConfiguration() { 3 // 1. åˆ›å»ºAnnotationConfigApplicationContext 4 AnnotationConfigApplicationContext context = 5 new AnnotationConfigApplicationContext(); 6 7 // 2. æ³¨å†Œé…ç½®ç±» 8 context.register(DataSourceAutoConfiguration.class); 9 10 // 3. åˆ·æ–°å®¹å™¨ 11 context.refresh(); 12 13 // 4. éªŒè¯Beanæ˜¯å¦åˆ›å»º 14 DataSource dataSource = context.getBean(DataSource.class); 15 assertNotNull(dataSource); 16} æ¨¡ä»¿å®ç°ï¼š\n1// æ¨¡ä»¿Spring Bootçš„æ¡ä»¶æ³¨è§£ 2@Target({ ElementType.TYPE, ElementType.METHOD }) 3@Retention(RetentionPolicy.RUNTIME) 4@Conditional(OnMyClassCondition.class) 5public @interface ConditionalOnMyClass { 6 String value(); 7} 8 9public class OnMyClassCondition implements Condition { 10 @Override 11 public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) { 12 Map\u0026lt;String, Object\u0026gt; attributes = metadata.getAnnotationAttributes( 13 ConditionalOnMyClass.class.getName() 14 ); 15 String className = (String) attributes.get(\u0026#34;value\u0026#34;); 16 17 try { 18 Class.forName(className); 19 return true; 20 } catch (ClassNotFoundException e) { 21 return false; 22 } 23 } 24} å­¦ä¹ è·¯å¾„å»ºè®® åˆçº§é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰ ç›®æ ‡ï¼šç†è§£Spring Bootçš„åŸºæœ¬ä½¿ç”¨å’Œæ ¸å¿ƒæ¦‚å¿µ\né˜…è¯»å®˜æ–¹æ–‡æ¡£ è¿è¡Œç¤ºä¾‹é¡¹ç›® ç†è§£@SpringBootApplicationæ³¨è§£ äº†è§£è‡ªåŠ¨é…ç½®çš„åŸºæœ¬åŸç† æ¨èé˜…è¯»ï¼š\nSpringApplication.java @SpringBootApplicationç›¸å…³æ³¨è§£ ç®€å•çš„AutoConfigurationç±» ä¸­çº§é˜¶æ®µï¼ˆ2-4å‘¨ï¼‰ ç›®æ ‡ï¼šæ·±å…¥ç†è§£å¯åŠ¨æµç¨‹å’Œè‡ªåŠ¨é…ç½®æœºåˆ¶\nè°ƒè¯•å¯åŠ¨æµç¨‹ åˆ†æAutoConfigurationImportSelector ç ”ç©¶æ¡ä»¶æ³¨è§£çš„å®ç° å­¦ä¹ å¸¸ç”¨çš„AutoConfiguration æ¨èé˜…è¯»ï¼š\nSpringApplication.run()å®Œæ•´æµç¨‹ AutoConfigurationImportSelector.java OnClassCondition.java DataSourceAutoConfiguration.java WebMvcAutoConfiguration.java é«˜çº§é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ ç›®æ ‡ï¼šæŒæ¡Spring Bootçš„è®¾è®¡æ€æƒ³å’Œæ‰©å±•æœºåˆ¶\nç ”ç©¶SPIæœºåˆ¶ï¼ˆSpringFactoriesLoaderï¼‰ åˆ†æApplicationContextçš„åˆ›å»ºå’Œåˆ·æ–° å­¦ä¹ Actuatorçš„å®ç° ç ”ç©¶Spring Bootçš„æµ‹è¯•æ”¯æŒ æ¨èé˜…è¯»ï¼š\nSpringFactoriesLoader.java ConfigurableApplicationContextç›¸å…³ç±» spring-boot-actuatoræ¨¡å— spring-boot-testæ¨¡å— ä¸“å®¶é˜¶æ®µï¼ˆæŒç»­å­¦ä¹ ï¼‰ ç›®æ ‡ï¼šå‚ä¸å¼€æºè´¡çŒ®ï¼Œæ·±åº¦å®šåˆ¶Spring Boot\né˜…è¯»Issueå’ŒPR å‚ä¸ç¤¾åŒºè®¨è®º æäº¤Bugä¿®å¤æˆ–æ–°ç‰¹æ€§ å¼€å‘è‡ªå®šä¹‰Starter å®æˆ˜ï¼šå¼€å‘è‡ªå®šä¹‰Starter 1. åˆ›å»ºStarteré¡¹ç›® 1\u0026lt;!-- my-spring-boot-starter/pom.xml --\u0026gt; 2\u0026lt;dependencies\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;spring-boot-autoconfigure\u0026lt;/artifactId\u0026gt; 6 \u0026lt;/dependency\u0026gt; 7 \u0026lt;dependency\u0026gt; 8 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 9 \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; 10 \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; 11 \u0026lt;/dependency\u0026gt; 12\u0026lt;/dependencies\u0026gt; 2. å®šä¹‰é…ç½®å±æ€§ 1@ConfigurationProperties(prefix = \u0026#34;my.service\u0026#34;) 2public class MyServiceProperties { 3 4 private String name = \u0026#34;default\u0026#34;; 5 private int timeout = 3000; 6 7 // getters and setters 8} 3. åˆ›å»ºè‡ªåŠ¨é…ç½®ç±» 1@Configuration 2@ConditionalOnClass(MyService.class) 3@EnableConfigurationProperties(MyServiceProperties.class) 4public class MyServiceAutoConfiguration { 5 6 @Bean 7 @ConditionalOnMissingBean 8 public MyService myService(MyServiceProperties properties) { 9 return new MyService(properties.getName(), properties.getTimeout()); 10 } 11} 4. æ³¨å†Œè‡ªåŠ¨é…ç½® 1# META-INF/spring.factories 2org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 3com.example.MyServiceAutoConfiguration 5. ä½¿ç”¨Starter 1\u0026lt;!-- åº”ç”¨é¡¹ç›®çš„pom.xml --\u0026gt; 2\u0026lt;dependency\u0026gt; 3 \u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt; 4 \u0026lt;artifactId\u0026gt;my-spring-boot-starter\u0026lt;/artifactId\u0026gt; 5 \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; 6\u0026lt;/dependency\u0026gt; 1# application.yml 2my: 3 service: 4 name: my-service 5 timeout: 5000 1@SpringBootApplication 2public class Application { 3 4 @Autowired 5 private MyService myService; // è‡ªåŠ¨æ³¨å…¥ 6 7 public static void main(String[] args) { 8 SpringApplication.run(Application.class, args); 9 } 10} æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡ç³»ç»Ÿè®²è§£äº†å¦‚ä½•é˜…è¯»å¼€æºé¡¹ç›®æºç ï¼Œä»¥Spring Bootä¸ºä¾‹ï¼š\næ–¹æ³•è®ºï¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œå¸¦ç€é—®é¢˜è¯»æºç  å¯åŠ¨æµç¨‹ï¼šç†è§£SpringApplication.run()çš„å®Œæ•´æµç¨‹ è‡ªåŠ¨é…ç½®ï¼šæŒæ¡@EnableAutoConfigurationçš„å®ç°åŸç† æ¡ä»¶æ³¨è§£ï¼šå­¦ä¹ @Conditionalçš„è®¾è®¡å’Œå®ç° å­¦ä¹ è·¯å¾„ï¼šä»åˆçº§åˆ°ä¸“å®¶çš„è¿›é˜¶è·¯çº¿ å®æˆ˜ç»ƒä¹ ï¼šå¼€å‘è‡ªå®šä¹‰Starterå·©å›ºç†è§£ é˜…è¯»æºç çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nç›®æ ‡æ˜ç¡®ï¼šå¸¦ç€é—®é¢˜å’Œç›®æ ‡å»è¯» å¾ªåºæ¸è¿›ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥ åŠ¨æ‰‹å®è·µï¼šé€šè¿‡è°ƒè¯•å’Œç¼–ç åŠ æ·±ç†è§£ æŒç»­å­¦ä¹ ï¼šæºç é˜…è¯»æ˜¯ä¸€ä¸ªé•¿æœŸè¿‡ç¨‹ æ¨èçš„å­¦ä¹ èµ„æºï¼š\nSpring Bootå®˜æ–¹æ–‡æ¡£ Spring Bootæºç  Spring Frameworkæºç  ä¸‹æ¬¡å½“ä½ æƒ³æ·±å…¥å­¦ä¹ ä¸€ä¸ªå¼€æºé¡¹ç›®æ—¶ï¼Œä¸å¦¨æŒ‰ç…§æœ¬æ–‡çš„æ–¹æ³•ï¼Œç³»ç»Ÿæ€§åœ°é˜…è¯»å’Œå­¦ä¹ ã€‚è®°ä½ï¼Œæºç é˜…è¯»ä¸æ˜¯ç›®çš„ï¼Œç†è§£è®¾è®¡æ€æƒ³å’Œæå‡ç¼–ç èƒ½åŠ›æ‰æ˜¯æœ€ç»ˆç›®æ ‡ã€‚\n","permalink":"http://localhost:1313/posts/2025/11/%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E4%BB%A5-spring-boot-%E4%B8%BA%E4%BE%8B/","summary":"\u003cp\u003eé˜…è¯»ä¼˜ç§€çš„å¼€æºé¡¹ç›®æºç æ˜¯æå‡æŠ€æœ¯èƒ½åŠ›çš„æœ€ä½³é€”å¾„ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œé¢å¯¹åŠ¨è¾„å‡ åä¸‡è¡Œçš„ä»£ç ï¼Œå¾ˆå¤šäººä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹ã€‚æœ¬æ–‡å°†ä»¥Spring Bootä¸ºä¾‹ï¼Œç³»ç»Ÿè®²è§£å¦‚ä½•é«˜æ•ˆåœ°é˜…è¯»å’Œå­¦ä¹ å¼€æºé¡¹ç›®æºç ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æºç é˜…è¯»çš„ç³»ç»Ÿæ–¹æ³•è®º\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å·¥å…·è¾…åŠ©æºç é˜…è¯»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£Spring Bootçš„æ ¸å¿ƒè®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ä»å®è§‚åˆ°å¾®è§‚çš„é˜…è¯»ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹æºç å­¦ä¹ çš„é•¿æ•ˆæœºåˆ¶\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆè¦è¯»æºç \"\u003eä¸ºä»€ä¹ˆè¦è¯»æºç \u003c/h2\u003e\n\u003ch3 id=\"æºç é˜…è¯»çš„ä»·å€¼\"\u003eæºç é˜…è¯»çš„ä»·å€¼\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæ·±å…¥ç†è§£åŸç†\u003c/strong\u003eï¼šçŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå­¦ä¹ è®¾è®¡æ¨¡å¼\u003c/strong\u003eï¼šçœ‹å¤§å¸ˆå¦‚ä½•è®¾è®¡æ¶æ„\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæå‡ç¼–ç èƒ½åŠ›\u003c/strong\u003eï¼šå­¦ä¹ ä¼˜ç§€çš„ä»£ç é£æ ¼\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè§£å†³ç–‘éš¾é—®é¢˜\u003c/strong\u003eï¼šé‡åˆ°é—®é¢˜èƒ½å¿«é€Ÿå®šä½\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå‚ä¸å¼€æºè´¡çŒ®\u003c/strong\u003eï¼šä¸ºå¼€æºç¤¾åŒºåšè´¡çŒ®\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"å¸¸è§è¯¯åŒº\"\u003eå¸¸è§è¯¯åŒº\u003c/h3\u003e\n\u003cp\u003eâŒ \u003cstrong\u003eä»ç¬¬ä¸€è¡Œå¼€å§‹è¯»\u003c/strong\u003eï¼šå®¹æ˜“è¿·å¤±åœ¨ç»†èŠ‚ä¸­\nâŒ \u003cstrong\u003eè¿½æ±‚å®Œå…¨ç†è§£\u003c/strong\u003eï¼šè¯•å›¾ç†è§£æ¯ä¸€è¡Œä»£ç \nâŒ \u003cstrong\u003eæ²¡æœ‰ç›®æ ‡\u003c/strong\u003eï¼šæ¼«æ— ç›®çš„åœ°æµè§ˆä»£ç \nâŒ \u003cstrong\u003eåªçœ‹ä¸ç»ƒ\u003c/strong\u003eï¼šåªçœ‹ä¸å†™ï¼Œæ— æ³•çœŸæ­£æŒæ¡\u003c/p\u003e\n\u003cp\u003eâœ… \u003cstrong\u003eå¸¦ç€é—®é¢˜è¯»\u003c/strong\u003eï¼šå›´ç»•å…·ä½“é—®é¢˜å±•å¼€\nâœ… \u003cstrong\u003eæŠ“ä½ä¸»çº¿\u003c/strong\u003eï¼šç†è§£æ ¸å¿ƒæµç¨‹å’Œè®¾è®¡æ€æƒ³\nâœ… \u003cstrong\u003eå¾ªåºæ¸è¿›\u003c/strong\u003eï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æ·±å…¥\nâœ… \u003cstrong\u003eè¾¹è¯»è¾¹å†™\u003c/strong\u003eï¼šé€šè¿‡å®è·µåŠ æ·±ç†è§£\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e é˜…è¯»æºç ä¸æ˜¯ä¸ºäº†è®°ä½æ¯ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯ç†è§£è®¾è®¡æ€æƒ³å’Œæ¶æ„æ¨¡å¼ã€‚è¦å­¦ä¼šä»å®è§‚åˆ°å¾®è§‚ï¼Œä»æ•´ä½“åˆ°ç»†èŠ‚çš„é˜…è¯»æ–¹æ³•ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"æºç é˜…è¯»æ–¹æ³•è®º\"\u003eæºç é˜…è¯»æ–¹æ³•è®º\u003c/h2\u003e\n\u003ch3 id=\"1-å‡†å¤‡é˜¶æ®µ\"\u003e1. å‡†å¤‡é˜¶æ®µ\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eé€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé€‰æ‹©ç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚Spring Boot 2.7.xï¼‰\u003c/li\u003e\n\u003cli\u003eé¿å…é€‰æ‹©æœ€æ–°çš„å¼€å‘ç‰ˆæœ¬\u003c/li\u003e\n\u003cli\u003eæŸ¥çœ‹ç‰ˆæœ¬çš„Release Notes\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eæ­å»ºè°ƒè¯•ç¯å¢ƒ\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. å…‹éš†æºç \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/spring-projects/spring-boot.git\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e spring-boot\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. åˆ‡æ¢åˆ°ç¨³å®šç‰ˆæœ¬\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout v2.7.18\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 3. å¯¼å…¥IDEï¼ˆIDEAï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# File -\u0026gt; Open -\u0026gt; é€‰æ‹©spring-bootç›®å½•\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eå‡†å¤‡ç¤ºä¾‹é¡¹ç›®\u003c/strong\u003eï¼š\u003c/p\u003e","title":"å¦‚ä½•é˜…è¯»å¼€æºé¡¹ç›®æºç ï¼šä»¥ Spring Boot ä¸ºä¾‹"},{"content":"\u0026ldquo;è¿™ä¸ªæ¥å£æ€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿ\u0026ldquo;è¿™æ˜¯æ¯ä¸ªåç«¯å¼€å‘éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å½“ç”¨æˆ·æŠ±æ€¨ç³»ç»Ÿå¡é¡¿ï¼Œå½“ç›‘æ§å‘Šè­¦é¢‘ç¹è§¦å‘ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç³»ç»Ÿæ€§åœ°å®šä½å’Œè§£å†³æ€§èƒ½é—®é¢˜ï¼Ÿ\næœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå¸¦ä½ ç»å†ä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ï¼Œä»é—®é¢˜å‘ç°åˆ°æœ€ç»ˆä¼˜åŒ–ï¼Œå°†æ¥å£å“åº”æ—¶é—´ä»3ç§’é™ä½åˆ°300msã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æ€§èƒ½é—®é¢˜çš„ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³• å­¦ä¼šä½¿ç”¨å„ç§æ€§èƒ½åˆ†æå·¥å…· ç†è§£å¸¸è§çš„æ€§èƒ½ç“¶é¢ˆåŠè§£å†³æ–¹æ¡ˆ äº†è§£æ•°æ®åº“ã€ç¼“å­˜ã€ä»£ç å±‚é¢çš„ä¼˜åŒ–æŠ€å·§ å»ºç«‹å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹ é—®é¢˜èƒŒæ™¯ ä¸šåŠ¡åœºæ™¯ æŸç”µå•†ç³»ç»Ÿçš„è®¢å•è¯¦æƒ…æ¥å£ï¼Œç”¨æˆ·åé¦ˆé¡µé¢åŠ è½½ç¼“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚\næ¥å£å®šä¹‰ï¼š\n1@GetMapping(\u0026#34;/api/orders/{orderId}\u0026#34;) 2public Result\u0026lt;OrderDetailVO\u0026gt; getOrderDetail(@PathVariable Long orderId) { 3 return Result.success(orderService.getOrderDetail(orderId)); 4} ç›‘æ§æ•°æ®ï¼š\nå¹³å‡å“åº”æ—¶é—´ï¼š2.8ç§’ P95å“åº”æ—¶é—´ï¼š3.5ç§’ P99å“åº”æ—¶é—´ï¼š5ç§’ QPSï¼š100 ä¸šåŠ¡è¦æ±‚ï¼š\nå“åº”æ—¶é—´ \u0026lt; 500ms P99 \u0026lt; 1ç§’ æ¶æ„æ€è€ƒï¼š æ€§èƒ½ä¼˜åŒ–ä¸æ˜¯ç›²ç›®åœ°ä¼˜åŒ–ï¼Œè€Œæ˜¯è¦åŸºäºæ•°æ®å’Œç›®æ ‡ã€‚é¦–å…ˆè¦æ˜ç¡®æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŒ–ç›®æ ‡ï¼Œç„¶åç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚\nç¬¬ä¸€æ­¥ï¼šé—®é¢˜å®šä½ 1. æ·»åŠ ç›‘æ§åŸ‹ç‚¹ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ—¶é—´éƒ½èŠ±åœ¨å“ªé‡Œäº†ï¼š\n1@Service 2@Slf4j 3public class OrderService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 @Autowired 9 private UserService userService; 10 11 @Autowired 12 private ProductService productService; 13 14 @Autowired 15 private LogisticsService logisticsService; 16 17 public OrderDetailVO getOrderDetail(Long orderId) { 18 long startTime = System.currentTimeMillis(); 19 20 // 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯ 21 long step1Start = System.currentTimeMillis(); 22 Order order = orderMapper.selectById(orderId); 23 log.info(\u0026#34;æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step1Start); 24 25 // 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ 26 long step2Start = System.currentTimeMillis(); 27 User user = userService.getUserById(order.getUserId()); 28 log.info(\u0026#34;æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step2Start); 29 30 // 3. æŸ¥è¯¢å•†å“ä¿¡æ¯ 31 long step3Start = System.currentTimeMillis(); 32 List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 33 List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 34 for (OrderItem item : items) { 35 Product product = productService.getProductById(item.getProductId()); 36 products.add(product); 37 } 38 log.info(\u0026#34;æŸ¥è¯¢å•†å“è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step3Start); 39 40 // 4. æŸ¥è¯¢ç‰©æµä¿¡æ¯ 41 long step4Start = System.currentTimeMillis(); 42 Logistics logistics = logisticsService.getLogisticsByOrderId(orderId); 43 log.info(\u0026#34;æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - step4Start); 44 45 // 5. ç»„è£…è¿”å›æ•°æ® 46 OrderDetailVO vo = buildOrderDetailVO(order, user, products, logistics); 47 48 log.info(\u0026#34;æ€»è€—æ—¶ï¼š{}ms\u0026#34;, System.currentTimeMillis() - startTime); 49 return vo; 50 } 51} æ—¥å¿—è¾“å‡ºï¼š\n1æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š50ms 2æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š100ms 3æŸ¥è¯¢å•†å“è€—æ—¶ï¼š2500ms â† ç“¶é¢ˆï¼ 4æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š150ms 5æ€»è€—æ—¶ï¼š2800ms 2. åˆ†æç“¶é¢ˆ é€šè¿‡æ—¥å¿—å‘ç°ï¼ŒæŸ¥è¯¢å•†å“ä¿¡æ¯è€—æ—¶æœ€é•¿ï¼Œå æ€»è€—æ—¶çš„89%ã€‚è¿›ä¸€æ­¥åˆ†æä»£ç ï¼š\n1// é—®é¢˜ä»£ç ï¼šN+1æŸ¥è¯¢ 2List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); // 1æ¬¡æŸ¥è¯¢ 3List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 4for (OrderItem item : items) { 5 Product product = productService.getProductById(item.getProductId()); // Næ¬¡æŸ¥è¯¢ 6 products.add(product); 7} é—®é¢˜åˆ†æï¼š\nè®¢å•æœ‰10ä¸ªå•†å“ æ¯ä¸ªå•†å“æŸ¥è¯¢è€—æ—¶250ms æ€»è€—æ—¶ï¼š10 Ã— 250ms = 2500ms ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“ä¼˜åŒ– ä¼˜åŒ–1ï¼šæ‰¹é‡æŸ¥è¯¢ å°†N+1æŸ¥è¯¢æ”¹ä¸ºæ‰¹é‡æŸ¥è¯¢ï¼š\n1// ä¼˜åŒ–åçš„ä»£ç  2List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 3 4// æ”¶é›†æ‰€æœ‰å•†å“ID 5List\u0026lt;Long\u0026gt; productIds = items.stream() 6 .map(OrderItem::getProductId) 7 .collect(Collectors.toList()); 8 9// æ‰¹é‡æŸ¥è¯¢å•†å“ 10List\u0026lt;Product\u0026gt; products = productService.getProductsByIds(productIds); Mapperå®ç°ï¼š\n1@Mapper 2public interface ProductMapper { 3 4 /** 5 * æ‰¹é‡æŸ¥è¯¢å•†å“ 6 */ 7 @Select(\u0026#34;\u0026lt;script\u0026gt;\u0026#34; + 8 \u0026#34;SELECT * FROM t_product WHERE id IN \u0026#34; + 9 \u0026#34;\u0026lt;foreach collection=\u0026#39;ids\u0026#39; item=\u0026#39;id\u0026#39; open=\u0026#39;(\u0026#39; separator=\u0026#39;,\u0026#39; close=\u0026#39;)\u0026#39;\u0026gt;\u0026#34; + 10 \u0026#34;#{id}\u0026#34; + 11 \u0026#34;\u0026lt;/foreach\u0026gt;\u0026#34; + 12 \u0026#34;\u0026lt;/script\u0026gt;\u0026#34;) 13 List\u0026lt;Product\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); 14} ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢å•†å“è€—æ—¶ï¼š2500ms â†’ 300ms æ€»è€—æ—¶ï¼š2800ms â†’ 600ms ä¼˜åŒ–2ï¼šç´¢å¼•ä¼˜åŒ– åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå‘ç°è®¢å•é¡¹æŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼š\n1-- æ…¢æŸ¥è¯¢SQL 2SELECT * FROM t_order_item WHERE order_id = 123456; 3 4-- æ‰§è¡Œè®¡åˆ’ 5EXPLAIN SELECT * FROM t_order_item WHERE order_id = 123456; 6-- type: ALLï¼ˆå…¨è¡¨æ‰«æï¼‰ æ·»åŠ ç´¢å¼•ï¼š\n1CREATE INDEX idx_order_id ON t_order_item(order_id); ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢è®¢å•é¡¹è€—æ—¶ï¼š50ms â†’ 5ms æ€»è€—æ—¶ï¼š600ms â†’ 555ms ä¼˜åŒ–3ï¼šæŸ¥è¯¢å­—æ®µä¼˜åŒ– åŸæŸ¥è¯¢ä½¿ç”¨äº†SELECT *ï¼Œä½†å®é™…åªéœ€è¦éƒ¨åˆ†å­—æ®µï¼š\n1// ä¼˜åŒ–å‰ 2@Select(\u0026#34;SELECT * FROM t_product WHERE id IN (...)\u0026#34;) 3List\u0026lt;Product\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); 4 5// ä¼˜åŒ–åï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ 6@Select(\u0026#34;SELECT id, name, price, image_url FROM t_product WHERE id IN (...)\u0026#34;) 7List\u0026lt;ProductDTO\u0026gt; selectByIds(@Param(\u0026#34;ids\u0026#34;) List\u0026lt;Long\u0026gt; ids); ä¼˜åŒ–æ•ˆæœï¼š\næŸ¥è¯¢å•†å“è€—æ—¶ï¼š300ms â†’ 200ms æ€»è€—æ—¶ï¼š555ms â†’ 455ms ç¬¬ä¸‰æ­¥ï¼šç¼“å­˜ä¼˜åŒ– ä¼˜åŒ–4ï¼šæ·»åŠ Redisç¼“å­˜ å•†å“ä¿¡æ¯å˜åŒ–ä¸é¢‘ç¹ï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼š\n1@Service 2@Slf4j 3public class ProductService { 4 5 @Autowired 6 private ProductMapper productMapper; 7 8 @Autowired 9 private RedisTemplate\u0026lt;String, Product\u0026gt; redisTemplate; 10 11 private static final String PRODUCT_CACHE_KEY = \u0026#34;product:\u0026#34;; 12 private static final long CACHE_EXPIRE_TIME = 30; // 30åˆ†é’Ÿ 13 14 public List\u0026lt;Product\u0026gt; getProductsByIds(List\u0026lt;Long\u0026gt; productIds) { 15 List\u0026lt;Product\u0026gt; products = new ArrayList\u0026lt;\u0026gt;(); 16 List\u0026lt;Long\u0026gt; missIds = new ArrayList\u0026lt;\u0026gt;(); 17 18 // 1. æ‰¹é‡ä»ç¼“å­˜è·å– 19 List\u0026lt;String\u0026gt; keys = productIds.stream() 20 .map(id -\u0026gt; PRODUCT_CACHE_KEY + id) 21 .collect(Collectors.toList()); 22 23 List\u0026lt;Product\u0026gt; cachedProducts = redisTemplate.opsForValue().multiGet(keys); 24 25 // 2. æ‰¾å‡ºç¼“å­˜æœªå‘½ä¸­çš„ID 26 for (int i = 0; i \u0026lt; productIds.size(); i++) { 27 Product product = cachedProducts.get(i); 28 if (product != null) { 29 products.add(product); 30 } else { 31 missIds.add(productIds.get(i)); 32 } 33 } 34 35 // 3. æŸ¥è¯¢æ•°æ®åº“ 36 if (!missIds.isEmpty()) { 37 List\u0026lt;Product\u0026gt; dbProducts = productMapper.selectByIds(missIds); 38 products.addAll(dbProducts); 39 40 // 4. å†™å…¥ç¼“å­˜ 41 for (Product product : dbProducts) { 42 redisTemplate.opsForValue().set( 43 PRODUCT_CACHE_KEY + product.getId(), 44 product, 45 CACHE_EXPIRE_TIME, 46 TimeUnit.MINUTES 47 ); 48 } 49 } 50 51 return products; 52 } 53} ä¼˜åŒ–æ•ˆæœï¼š\nç¼“å­˜å‘½ä¸­ç‡ï¼š80% æŸ¥è¯¢å•†å“è€—æ—¶ï¼š200ms â†’ 50msï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰ æ€»è€—æ—¶ï¼š455ms â†’ 305ms ä¼˜åŒ–5ï¼šæœ¬åœ°ç¼“å­˜ å¯¹äºçƒ­ç‚¹å•†å“ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š\n1@Service 2public class ProductService { 3 4 // ä½¿ç”¨Caffeineæœ¬åœ°ç¼“å­˜ 5 private final LoadingCache\u0026lt;Long, Product\u0026gt; localCache = Caffeine.newBuilder() 6 .maximumSize(1000) 7 .expireAfterWrite(5, TimeUnit.MINUTES) 8 .build(this::loadProduct); 9 10 private Product loadProduct(Long productId) { 11 // å…ˆæŸ¥Redisï¼Œå†æŸ¥æ•°æ®åº“ 12 String key = PRODUCT_CACHE_KEY + productId; 13 Product product = redisTemplate.opsForValue().get(key); 14 15 if (product == null) { 16 product = productMapper.selectById(productId); 17 if (product != null) { 18 redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES); 19 } 20 } 21 22 return product; 23 } 24 25 public Product getProductById(Long productId) { 26 return localCache.get(productId); 27 } 28} ç¼“å­˜å±‚çº§ï¼š\n1è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â†’ Redis â†’ æ•°æ®åº“ ä¼˜åŒ–æ•ˆæœï¼š\næœ¬åœ°ç¼“å­˜å‘½ä¸­ç‡ï¼š50% æŸ¥è¯¢å•†å“è€—æ—¶ï¼š50ms â†’ 20msï¼ˆæœ¬åœ°ç¼“å­˜å‘½ä¸­æ—¶ï¼‰ æ€»è€—æ—¶ï¼š305ms â†’ 275ms ç¬¬å››æ­¥ï¼šå¹¶å‘ä¼˜åŒ– ä¼˜åŒ–6ï¼šå¹¶è¡ŒæŸ¥è¯¢ ç”¨æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€ç‰©æµä¿¡æ¯ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯ä»¥å¹¶è¡ŒæŸ¥è¯¢ï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private ThreadPoolExecutor executor; 6 7 public OrderDetailVO getOrderDetail(Long orderId) { 8 // 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯ 9 Order order = orderMapper.selectById(orderId); 10 11 // 2. å¹¶è¡ŒæŸ¥è¯¢ç”¨æˆ·ã€å•†å“ã€ç‰©æµä¿¡æ¯ 12 CompletableFuture\u0026lt;User\u0026gt; userFuture = CompletableFuture.supplyAsync( 13 () -\u0026gt; userService.getUserById(order.getUserId()), 14 executor 15 ); 16 17 CompletableFuture\u0026lt;List\u0026lt;Product\u0026gt;\u0026gt; productsFuture = CompletableFuture.supplyAsync(() -\u0026gt; { 18 List\u0026lt;OrderItem\u0026gt; items = orderMapper.selectItemsByOrderId(orderId); 19 List\u0026lt;Long\u0026gt; productIds = items.stream() 20 .map(OrderItem::getProductId) 21 .collect(Collectors.toList()); 22 return productService.getProductsByIds(productIds); 23 }, executor); 24 25 CompletableFuture\u0026lt;Logistics\u0026gt; logisticsFuture = CompletableFuture.supplyAsync( 26 () -\u0026gt; logisticsService.getLogisticsByOrderId(orderId), 27 executor 28 ); 29 30 // 3. ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ 31 CompletableFuture.allOf(userFuture, productsFuture, logisticsFuture).join(); 32 33 // 4. ç»„è£…è¿”å›æ•°æ® 34 User user = userFuture.join(); 35 List\u0026lt;Product\u0026gt; products = productsFuture.join(); 36 Logistics logistics = logisticsFuture.join(); 37 38 return buildOrderDetailVO(order, user, products, logistics); 39 } 40} ä¼˜åŒ–æ•ˆæœï¼š\nåŸä¸²è¡Œè€—æ—¶ï¼š50msï¼ˆè®¢å•ï¼‰+ 100msï¼ˆç”¨æˆ·ï¼‰+ 20msï¼ˆå•†å“ï¼‰+ 150msï¼ˆç‰©æµï¼‰= 320ms å¹¶è¡Œè€—æ—¶ï¼š50msï¼ˆè®¢å•ï¼‰+ max(100ms, 20ms, 150ms) = 200ms æ€»è€—æ—¶ï¼š275ms â†’ 200ms ç¬¬äº”æ­¥ï¼šä»£ç ä¼˜åŒ– ä¼˜åŒ–7ï¼šå‡å°‘å¯¹è±¡åˆ›å»º 1// ä¼˜åŒ–å‰ï¼šé¢‘ç¹åˆ›å»ºå¯¹è±¡ 2public OrderDetailVO buildOrderDetailVO(Order order, User user, 3 List\u0026lt;Product\u0026gt; products, Logistics logistics) { 4 OrderDetailVO vo = new OrderDetailVO(); 5 vo.setOrderId(order.getId()); 6 vo.setOrderNo(order.getOrderNo()); 7 // ... è®¾ç½®æ›´å¤šå­—æ®µ 8 9 UserVO userVO = new UserVO(); 10 userVO.setUserId(user.getId()); 11 userVO.setUserName(user.getName()); 12 vo.setUser(userVO); 13 14 List\u0026lt;ProductVO\u0026gt; productVOs = new ArrayList\u0026lt;\u0026gt;(); 15 for (Product product : products) { 16 ProductVO productVO = new ProductVO(); 17 productVO.setProductId(product.getId()); 18 productVO.setProductName(product.getName()); 19 productVOs.add(productVO); 20 } 21 vo.setProducts(productVOs); 22 23 return vo; 24} 25 26// ä¼˜åŒ–åï¼šä½¿ç”¨å¯¹è±¡æ˜ å°„å·¥å…· 27@Autowired 28private ModelMapper modelMapper; 29 30public OrderDetailVO buildOrderDetailVO(Order order, User user, 31 List\u0026lt;Product\u0026gt; products, Logistics logistics) { 32 OrderDetailVO vo = modelMapper.map(order, OrderDetailVO.class); 33 vo.setUser(modelMapper.map(user, UserVO.class)); 34 vo.setProducts(products.stream() 35 .map(p -\u0026gt; modelMapper.map(p, ProductVO.class)) 36 .collect(Collectors.toList())); 37 vo.setLogistics(modelMapper.map(logistics, LogisticsVO.class)); 38 return vo; 39} ä¼˜åŒ–8ï¼šé¿å…ä¸å¿…è¦çš„è®¡ç®— 1// ä¼˜åŒ–å‰ï¼šæ¯æ¬¡éƒ½è®¡ç®— 2public BigDecimal calculateTotalAmount(List\u0026lt;OrderItem\u0026gt; items) { 3 BigDecimal total = BigDecimal.ZERO; 4 for (OrderItem item : items) { 5 BigDecimal itemAmount = item.getPrice().multiply(new BigDecimal(item.getQuantity())); 6 total = total.add(itemAmount); 7 } 8 return total; 9} 10 11// ä¼˜åŒ–åï¼šä½¿ç”¨æ•°æ®åº“è®¡ç®—å¥½çš„å­—æ®µ 12public BigDecimal getTotalAmount(Order order) { 13 return order.getTotalAmount(); // ä¸‹å•æ—¶å·²è®¡ç®—å¹¶å­˜å‚¨ 14} ç¬¬å…­æ­¥ï¼šç›‘æ§ä¸éªŒè¯ æ€§èƒ½æµ‹è¯• ä½¿ç”¨JMeterè¿›è¡Œå‹æµ‹ï¼š\n1# å‹æµ‹é…ç½® 2çº¿ç¨‹æ•°ï¼š100 3æŒç»­æ—¶é—´ï¼š5åˆ†é’Ÿ ä¼˜åŒ–å‰åå¯¹æ¯”ï¼š\næŒ‡æ ‡ ä¼˜åŒ–å‰ ä¼˜åŒ–å æå‡ å¹³å‡å“åº”æ—¶é—´ 2800ms 280ms 90% P95å“åº”æ—¶é—´ 3500ms 350ms 90% P99å“åº”æ—¶é—´ 5000ms 450ms 91% QPS 100 500 400% CPUä½¿ç”¨ç‡ 80% 40% 50% ç›‘æ§å‘Šè­¦ é…ç½®Prometheuså‘Šè­¦è§„åˆ™ï¼š\n1groups: 2 - name: api_performance 3 rules: 4 - alert: HighResponseTime 5 expr: http_request_duration_seconds{quantile=\u0026#34;0.99\u0026#34;} \u0026gt; 1 6 for: 5m 7 labels: 8 severity: warning 9 annotations: 10 summary: \u0026#34;APIå“åº”æ—¶é—´è¿‡é«˜\u0026#34; 11 description: \u0026#34;{{ $labels.api }} P99å“åº”æ—¶é—´è¶…è¿‡1ç§’\u0026#34; ä¼˜åŒ–æ€»ç»“ ä¼˜åŒ–è·¯å¾„ 1åŸå§‹æ€§èƒ½ï¼š2800ms 2 â†“ æ‰¹é‡æŸ¥è¯¢ï¼ˆN+1é—®é¢˜ï¼‰ 31. 600msï¼ˆä¼˜åŒ–78%ï¼‰ 4 â†“ æ·»åŠ ç´¢å¼• 52. 555msï¼ˆä¼˜åŒ–7%ï¼‰ 6 â†“ æŸ¥è¯¢å­—æ®µä¼˜åŒ– 73. 455msï¼ˆä¼˜åŒ–18%ï¼‰ 8 â†“ Redisç¼“å­˜ 94. 305msï¼ˆä¼˜åŒ–33%ï¼‰ 10 â†“ æœ¬åœ°ç¼“å­˜ 115. 275msï¼ˆä¼˜åŒ–10%ï¼‰ 12 â†“ å¹¶è¡ŒæŸ¥è¯¢ 136. 200msï¼ˆä¼˜åŒ–27%ï¼‰ 14 â†“ ä»£ç ä¼˜åŒ– 15æœ€ç»ˆï¼š280msï¼ˆæ€»ä¼˜åŒ–90%ï¼‰ ä¼˜åŒ–åŸåˆ™ å…ˆå®šä½ï¼Œåä¼˜åŒ–ï¼šé€šè¿‡ç›‘æ§æ‰¾åˆ°çœŸæ­£çš„ç“¶é¢ˆ æŠ“å¤§æ”¾å°ï¼šä¼˜å…ˆä¼˜åŒ–å æ¯”æœ€å¤§çš„éƒ¨åˆ† åˆ†å±‚ä¼˜åŒ–ï¼šæ•°æ®åº“ â†’ ç¼“å­˜ â†’ ä»£ç  â†’ æ¶æ„ é‡åŒ–è¯„ä¼°ï¼šæ¯æ¬¡ä¼˜åŒ–éƒ½è¦æœ‰æ•°æ®æ”¯æ’‘ æŒç»­ç›‘æ§ï¼šä¼˜åŒ–åè¦æŒç»­è§‚å¯Ÿæ•ˆæœ å¸¸è§æ€§èƒ½ç“¶é¢ˆ ç“¶é¢ˆç±»å‹ å…¸å‹è¡¨ç° è§£å†³æ–¹æ¡ˆ æ•°æ®åº“æ…¢æŸ¥è¯¢ å“åº”æ—¶é—´é•¿ï¼Œæ•°æ®åº“CPUé«˜ ç´¢å¼•ä¼˜åŒ–ã€SQLä¼˜åŒ–ã€åˆ†åº“åˆ†è¡¨ N+1æŸ¥è¯¢ å¤§é‡é‡å¤æŸ¥è¯¢ æ‰¹é‡æŸ¥è¯¢ã€JOINæŸ¥è¯¢ ç¼“å­˜æœªå‘½ä¸­ æ•°æ®åº“å‹åŠ›å¤§ æ·»åŠ ç¼“å­˜ã€é¢„çƒ­ç¼“å­˜ ä¸²è¡Œè°ƒç”¨ å“åº”æ—¶é—´=å„æ­¥éª¤ä¹‹å’Œ å¹¶è¡Œè°ƒç”¨ã€å¼‚æ­¥å¤„ç† å¯¹è±¡åˆ›å»º GCé¢‘ç¹ å¯¹è±¡å¤ç”¨ã€æ± åŒ–æŠ€æœ¯ é”ç«äº‰ å¹¶å‘æ€§èƒ½å·® å‡å°é”ç²’åº¦ã€æ— é”åŒ– æ€§èƒ½ä¼˜åŒ–å·¥å…·ç®± 1. ç›‘æ§å·¥å…· APMå·¥å…·ï¼š\nSkyWalkingï¼šåˆ†å¸ƒå¼è¿½è¸ª Prometheus + Grafanaï¼šæŒ‡æ ‡ç›‘æ§ ELKï¼šæ—¥å¿—åˆ†æ æ•°æ®åº“ç›‘æ§ï¼š\nMySQLæ…¢æŸ¥è¯¢æ—¥å¿— Explainæ‰§è¡Œè®¡åˆ’ Performance Schema 2. åˆ†æå·¥å…· JVMåˆ†æï¼š\n1# æŸ¥çœ‹GCæƒ…å†µ 2jstat -gcutil \u0026lt;pid\u0026gt; 1000 3 4# ç”Ÿæˆå †è½¬å‚¨ 5jmap -dump:format=b,file=heap.hprof \u0026lt;pid\u0026gt; 6 7# çº¿ç¨‹åˆ†æ 8jstack \u0026lt;pid\u0026gt; \u0026gt; thread.txt ç«ç„°å›¾ï¼š\n1# ä½¿ç”¨async-profiler 2./profiler.sh -d 60 -f flamegraph.html \u0026lt;pid\u0026gt; 3. å‹æµ‹å·¥å…· JMeterï¼š\n1jmeter -n -t test-plan.jmx -l result.jtl -e -o report Gatlingï¼š\n1setUp( 2 scn.inject(rampUsersPerSec(10) to 1000 during (5 minutes)) 3).protocols(httpProtocol) æœ€ä½³å®è·µ 1. æ€§èƒ½ä¼˜åŒ–checklist æ·»åŠ ç›‘æ§åŸ‹ç‚¹ï¼Œé‡åŒ–æ€§èƒ½æŒ‡æ ‡ åˆ†ææ…¢æŸ¥è¯¢ï¼Œä¼˜åŒ–SQLå’Œç´¢å¼• è¯†åˆ«N+1æŸ¥è¯¢ï¼Œæ”¹ä¸ºæ‰¹é‡æŸ¥è¯¢ æ·»åŠ ç¼“å­˜ï¼Œæé«˜è¯»æ€§èƒ½ å¹¶è¡ŒåŒ–ç‹¬ç«‹æ“ä½œï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ ä¼˜åŒ–ä»£ç é€»è¾‘ï¼Œå‡å°‘ä¸å¿…è¦çš„è®¡ç®— å‹æµ‹éªŒè¯ï¼Œç¡®ä¿ä¼˜åŒ–æ•ˆæœ æŒç»­ç›‘æ§ï¼Œé˜²æ­¢æ€§èƒ½é€€åŒ– 2. æ€§èƒ½ä¼˜åŒ–è¯¯åŒº âŒ è¿‡æ—©ä¼˜åŒ–ï¼šåœ¨æ²¡æœ‰æ€§èƒ½é—®é¢˜æ—¶å°±å¼€å§‹ä¼˜åŒ– âœ… åŸºäºæ•°æ®ä¼˜åŒ–ï¼šå…ˆæµ‹é‡ï¼Œå†ä¼˜åŒ–\nâŒ ç›²ç›®ä¼˜åŒ–ï¼šä¸çŸ¥é“ç“¶é¢ˆåœ¨å“ªå°±å¼€å§‹ä¼˜åŒ– âœ… å®šä½ç“¶é¢ˆï¼šæ‰¾åˆ°çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆ\nâŒ å±€éƒ¨ä¼˜åŒ–ï¼šåªä¼˜åŒ–æŸä¸ªç‚¹ âœ… ç³»ç»Ÿä¼˜åŒ–ï¼šä»æ•´ä½“è§’åº¦ä¼˜åŒ–\nâŒ å¿½ç•¥ç›‘æ§ï¼šä¼˜åŒ–åä¸ç›‘æ§æ•ˆæœ âœ… æŒç»­ç›‘æ§ï¼šä¼˜åŒ–åæŒç»­è§‚å¯Ÿ\n3. æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹ 1å‘ç°é—®é¢˜ 2 â†“ 3æ·»åŠ ç›‘æ§ï¼ˆé‡åŒ–é—®é¢˜ï¼‰ 4 â†“ 5å®šä½ç“¶é¢ˆï¼ˆæ‰¾åˆ°æ ¹å› ï¼‰ 6 â†“ 7åˆ¶å®šæ–¹æ¡ˆï¼ˆè¯„ä¼°æ”¶ç›Šï¼‰ 8 â†“ 9å®æ–½ä¼˜åŒ–ï¼ˆå°æ­¥å¿«è·‘ï¼‰ 10 â†“ 11éªŒè¯æ•ˆæœï¼ˆå‹æµ‹éªŒè¯ï¼‰ 12 â†“ 13æŒç»­ç›‘æ§ï¼ˆé˜²æ­¢é€€åŒ–ï¼‰ é¿å‘æç¤ºï¼š æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§çš„å·¥ä½œã€‚è¦å»ºç«‹æ€§èƒ½ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³æ€§èƒ½é—®é¢˜ã€‚åŒæ—¶è¦æ³¨æ„ï¼Œè¿‡åº¦ä¼˜åŒ–å¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿå¤æ‚åº¦ï¼Œè¦åœ¨æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå±•ç¤ºäº†å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ï¼š\né—®é¢˜å®šä½ï¼šé€šè¿‡ç›‘æ§åŸ‹ç‚¹æ‰¾åˆ°ç“¶é¢ˆ æ•°æ®åº“ä¼˜åŒ–ï¼šæ‰¹é‡æŸ¥è¯¢ã€ç´¢å¼•ä¼˜åŒ–ã€å­—æ®µä¼˜åŒ– ç¼“å­˜ä¼˜åŒ–ï¼šRedisç¼“å­˜ã€æœ¬åœ°ç¼“å­˜ å¹¶å‘ä¼˜åŒ–ï¼šå¹¶è¡ŒæŸ¥è¯¢ã€å¼‚æ­¥å¤„ç† ä»£ç ä¼˜åŒ–ï¼šå‡å°‘å¯¹è±¡åˆ›å»ºã€é¿å…é‡å¤è®¡ç®— ç›‘æ§éªŒè¯ï¼šå‹æµ‹éªŒè¯ã€æŒç»­ç›‘æ§ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯ï¼š\né‡åŒ–é—®é¢˜ï¼šç”¨æ•°æ®è¯´è¯ å®šä½ç“¶é¢ˆï¼šæ‰¾åˆ°çœŸæ­£çš„é—®é¢˜ ç³»ç»Ÿä¼˜åŒ–ï¼šä»æ•´ä½“è§’åº¦æ€è€ƒ æŒç»­æ”¹è¿›ï¼šå»ºç«‹é•¿æ•ˆæœºåˆ¶ ä¸‹æ¬¡å½“ä½ é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶ï¼Œä¸å¦¨æŒ‰ç…§æœ¬æ–‡çš„æ€è·¯ï¼Œç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚è®°ä½ï¼Œæ€§èƒ½ä¼˜åŒ–ä¸æ˜¯é“¶å¼¹ï¼Œè€Œæ˜¯ä¸€ä¸ªæŒç»­æ”¹è¿›çš„è¿‡ç¨‹ã€‚\n","permalink":"http://localhost:1313/posts/2025/10/%E6%8E%A5%E5%8F%A3%E5%93%8D%E5%BA%94%E6%85%A2%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8B%E6%97%85/","summary":"\u003cp\u003e\u0026ldquo;è¿™ä¸ªæ¥å£æ€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿ\u0026ldquo;è¿™æ˜¯æ¯ä¸ªåç«¯å¼€å‘éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚å½“ç”¨æˆ·æŠ±æ€¨ç³»ç»Ÿå¡é¡¿ï¼Œå½“ç›‘æ§å‘Šè­¦é¢‘ç¹è§¦å‘ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç³»ç»Ÿæ€§åœ°å®šä½å’Œè§£å†³æ€§èƒ½é—®é¢˜ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œå¸¦ä½ ç»å†ä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ï¼Œä»é—®é¢˜å‘ç°åˆ°æœ€ç»ˆä¼˜åŒ–ï¼Œå°†æ¥å£å“åº”æ—¶é—´ä»3ç§’é™ä½åˆ°300msã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ€§èƒ½é—®é¢˜çš„ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å„ç§æ€§èƒ½åˆ†æå·¥å…·\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å¸¸è§çš„æ€§èƒ½ç“¶é¢ˆåŠè§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£æ•°æ®åº“ã€ç¼“å­˜ã€ä»£ç å±‚é¢çš„ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å»ºç«‹å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–æ€ç»´æ¨¡å‹\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"é—®é¢˜èƒŒæ™¯\"\u003eé—®é¢˜èƒŒæ™¯\u003c/h2\u003e\n\u003ch3 id=\"ä¸šåŠ¡åœºæ™¯\"\u003eä¸šåŠ¡åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿçš„è®¢å•è¯¦æƒ…æ¥å£ï¼Œç”¨æˆ·åé¦ˆé¡µé¢åŠ è½½ç¼“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ¥å£å®šä¹‰\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@GetMapping\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/api/orders/{orderId}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nd\"\u003e@PathVariable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esuccess\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eç›‘æ§æ•°æ®\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¹³å‡å“åº”æ—¶é—´ï¼š2.8ç§’\u003c/li\u003e\n\u003cli\u003eP95å“åº”æ—¶é—´ï¼š3.5ç§’\u003c/li\u003e\n\u003cli\u003eP99å“åº”æ—¶é—´ï¼š5ç§’\u003c/li\u003e\n\u003cli\u003eQPSï¼š100\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡è¦æ±‚\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå“åº”æ—¶é—´ \u0026lt; 500ms\u003c/li\u003e\n\u003cli\u003eP99 \u0026lt; 1ç§’\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e æ€§èƒ½ä¼˜åŒ–ä¸æ˜¯ç›²ç›®åœ°ä¼˜åŒ–ï¼Œè€Œæ˜¯è¦åŸºäºæ•°æ®å’Œç›®æ ‡ã€‚é¦–å…ˆè¦æ˜ç¡®æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŒ–ç›®æ ‡ï¼Œç„¶åç³»ç»Ÿæ€§åœ°åˆ†æå’Œä¼˜åŒ–ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥é—®é¢˜å®šä½\"\u003eç¬¬ä¸€æ­¥ï¼šé—®é¢˜å®šä½\u003c/h2\u003e\n\u003ch3 id=\"1-æ·»åŠ ç›‘æ§åŸ‹ç‚¹\"\u003e1. æ·»åŠ ç›‘æ§åŸ‹ç‚¹\u003c/h3\u003e\n\u003cp\u003eé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ—¶é—´éƒ½èŠ±åœ¨å“ªé‡Œäº†ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Slf4j\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrderService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderMapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eProductService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLogisticsService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogisticsService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetOrderDetail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estartTime\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep1Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢è®¢å•è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep1Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep2Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢ç”¨æˆ·è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep2Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. æŸ¥è¯¢å•†å“ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep3Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectItemsByOrderId\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eProduct\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eArrayList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e35\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eProduct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproduct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e36\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eproduct\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e37\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e38\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢å•†å“è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep3Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e39\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e40\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. æŸ¥è¯¢ç‰©æµä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e41\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep4Start\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e42\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eLogistics\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogistics\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogisticsService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetLogisticsByOrderId\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorderId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e43\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æŸ¥è¯¢ç‰©æµè€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estep4Start\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e44\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e45\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 5. ç»„è£…è¿”å›æ•°æ®\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e46\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderDetailVO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003evo\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebuildOrderDetailVO\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproducts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003elogistics\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e47\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e48\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æ€»è€—æ—¶ï¼š{}ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecurrentTimeMillis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estartTime\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e49\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003evo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e50\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e51\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ—¥å¿—è¾“å‡º\u003c/strong\u003eï¼š\u003c/p\u003e","title":"æ¥å£å“åº”æ…¢ï¼Ÿä¸€æ¬¡å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…"},{"content":"åœ¨å¤§ä¿ƒã€ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œç³»ç»Ÿèƒ½å¦æ‰›ä½æµé‡å†²å‡»æ˜¯æ¯ä¸ªæŠ€æœ¯å›¢é˜Ÿæœ€å…³å¿ƒçš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„å•æ¥å£å‹æµ‹æ— æ³•çœŸå®åæ˜ ç³»ç»Ÿçš„æ•´ä½“æ‰¿è½½èƒ½åŠ›ï¼Œè€Œå…¨é“¾è·¯å‹æµ‹é€šè¿‡æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºï¼Œå¯ä»¥å…¨é¢éªŒè¯ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºå®Œæ•´çš„å‹æµ‹ä½“ç³»ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£å…¨é“¾è·¯å‹æµ‹çš„æ ¸å¿ƒä»·å€¼ æŒæ¡å‹æµ‹ç¯å¢ƒçš„æ­å»ºæ–¹æ¡ˆ å­¦ä¼šæ•°æ®éš”ç¦»ä¸æµé‡æ ‡è®° äº†è§£å‹æµ‹å·¥å…·çš„é€‰å‹ä¸ä½¿ç”¨ æŒæ¡æ€§èƒ½ç“¶é¢ˆçš„åˆ†æä¸ä¼˜åŒ– ä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹ ä¼ ç»Ÿå‹æµ‹ vs å…¨é“¾è·¯å‹æµ‹ ä¼ ç»Ÿå‹æµ‹ï¼š\né’ˆå¯¹å•ä¸ªæ¥å£æˆ–æœåŠ¡è¿›è¡Œå‹æµ‹ ä½¿ç”¨æµ‹è¯•ç¯å¢ƒæˆ–é¢„å‘å¸ƒç¯å¢ƒ æ•°æ®é‡å°ï¼Œæ— æ³•åæ˜ çœŸå®æƒ…å†µ å…¨é“¾è·¯å‹æµ‹ï¼š\nåœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå‹æµ‹ æ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„å®Œæ•´ä¸šåŠ¡æµç¨‹ ä½¿ç”¨çœŸå®çš„æ•°æ®é‡å’Œç³»ç»Ÿé…ç½® å…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼ çœŸå®æ€§ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œç»“æœæœ€å¯ä¿¡ å…¨é¢æ€§ï¼šè¦†ç›–æ‰€æœ‰ç³»ç»Ÿç»„ä»¶å’Œä¾èµ– åŠæ—¶æ€§ï¼šæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ æŒ‡å¯¼æ€§ï¼šä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æŒ å‹æµ‹åœºæ™¯ 1ç”¨æˆ·è®¿é—® â†’ ç½‘å…³ â†’ åº”ç”¨æœåŠ¡ â†’ ç¼“å­˜ â†’ æ•°æ®åº“ 2 â†“ 3 æ¶ˆæ¯é˜Ÿåˆ— â†’ å¼‚æ­¥æœåŠ¡ 4 â†“ 5 ç¬¬ä¸‰æ–¹æœåŠ¡ æ¶æ„æ€è€ƒï¼š å…¨é“¾è·¯å‹æµ‹ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯ä¸šåŠ¡é—®é¢˜ã€‚éœ€è¦äº§å“ã€è¿è¥ã€æŠ€æœ¯å›¢é˜Ÿå…±åŒå‚ä¸ï¼Œåˆ¶å®šåˆç†çš„å‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡†ã€‚\nå‹æµ‹æ–¹æ¡ˆè®¾è®¡ 1. å‹æµ‹ç›®æ ‡è®¾å®š æ€§èƒ½æŒ‡æ ‡ï¼š\nTPS/QPSï¼šæ¯ç§’äº‹åŠ¡æ•°/æŸ¥è¯¢æ•° å“åº”æ—¶é—´ï¼šP50ã€P95ã€P99 æˆåŠŸç‡ï¼šè¯·æ±‚æˆåŠŸçš„æ¯”ä¾‹ èµ„æºä½¿ç”¨ç‡ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ ä¸šåŠ¡æŒ‡æ ‡ï¼š\nè®¢å•åˆ›å»ºæˆåŠŸç‡ æ”¯ä»˜æˆåŠŸç‡ åº“å­˜æ‰£å‡å‡†ç¡®æ€§ ç¤ºä¾‹ç›®æ ‡ï¼š\n1å¤§ä¿ƒåœºæ™¯ï¼š 2- å³°å€¼ TPSï¼š10000 3- P99 å“åº”æ—¶é—´ï¼š\u0026lt; 500ms 4- æˆåŠŸç‡ï¼š\u0026gt; 99.9% 5- CPU ä½¿ç”¨ç‡ï¼š\u0026lt; 70% 2. å‹æµ‹æµé‡æ¨¡å‹ æµé‡ç‰¹å¾ï¼š\næµé‡æ›²çº¿ï¼šæ¨¡æ‹ŸçœŸå®çš„æµé‡æ³¢åŠ¨ ç”¨æˆ·è¡Œä¸ºï¼šæµè§ˆã€æœç´¢ã€ä¸‹å•ã€æ”¯ä»˜ ä¸šåŠ¡æ¯”ä¾‹ï¼šè¯»å†™æ¯”ä¾‹ã€çƒ­ç‚¹æ•°æ®åˆ†å¸ƒ å‹æµ‹è„šæœ¬ç¤ºä¾‹ï¼ˆJMeterï¼‰ï¼š\n1\u0026lt;TestPlan\u0026gt; 2 \u0026lt;ThreadGroup\u0026gt; 3 \u0026lt;stringProp name=\u0026#34;ThreadGroup.num_threads\u0026#34;\u0026gt;1000\u0026lt;/stringProp\u0026gt; 4 \u0026lt;stringProp name=\u0026#34;ThreadGroup.ramp_time\u0026#34;\u0026gt;60\u0026lt;/stringProp\u0026gt; 5 \u0026lt;stringProp name=\u0026#34;ThreadGroup.duration\u0026#34;\u0026gt;600\u0026lt;/stringProp\u0026gt; 6 7 \u0026lt;!-- æµè§ˆå•†å“ 60% --\u0026gt; 8 \u0026lt;HTTPSamplerProxy name=\u0026#34;æµè§ˆå•†å“\u0026#34;\u0026gt; 9 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/products/${productId}\u0026lt;/stringProp\u0026gt; 10 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;GET\u0026lt;/stringProp\u0026gt; 11 \u0026lt;/HTTPSamplerProxy\u0026gt; 12 13 \u0026lt;!-- åŠ å…¥è´­ç‰©è½¦ 30% --\u0026gt; 14 \u0026lt;HTTPSamplerProxy name=\u0026#34;åŠ å…¥è´­ç‰©è½¦\u0026#34;\u0026gt; 15 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/cart\u0026lt;/stringProp\u0026gt; 16 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;POST\u0026lt;/stringProp\u0026gt; 17 \u0026lt;/HTTPSamplerProxy\u0026gt; 18 19 \u0026lt;!-- ä¸‹å• 10% --\u0026gt; 20 \u0026lt;HTTPSamplerProxy name=\u0026#34;åˆ›å»ºè®¢å•\u0026#34;\u0026gt; 21 \u0026lt;stringProp name=\u0026#34;HTTPSampler.path\u0026#34;\u0026gt;/api/orders\u0026lt;/stringProp\u0026gt; 22 \u0026lt;stringProp name=\u0026#34;HTTPSampler.method\u0026#34;\u0026gt;POST\u0026lt;/stringProp\u0026gt; 23 \u0026lt;/HTTPSamplerProxy\u0026gt; 24 \u0026lt;/ThreadGroup\u0026gt; 25\u0026lt;/TestPlan\u0026gt; 3. æ•°æ®éš”ç¦»æ–¹æ¡ˆ åœ¨ç”Ÿäº§ç¯å¢ƒå‹æµ‹ï¼Œå¿…é¡»åšå¥½æ•°æ®éš”ç¦»ï¼Œé¿å…å½±å“çœŸå®ç”¨æˆ·ï¼š\næ–¹æ¡ˆä¸€ï¼šå½±å­è¡¨\n1-- çœŸå®è¡¨ 2CREATE TABLE t_order ( 3 id BIGINT PRIMARY KEY, 4 user_id BIGINT, 5 amount DECIMAL(10,2), 6 status INT, 7 create_time DATETIME 8); 9 10-- å½±å­è¡¨ï¼ˆå‹æµ‹æ•°æ®ï¼‰ 11CREATE TABLE t_order_shadow ( 12 id BIGINT PRIMARY KEY, 13 user_id BIGINT, 14 amount DECIMAL(10,2), 15 status INT, 16 create_time DATETIME 17); æ–¹æ¡ˆäºŒï¼šå½±å­åº“\n1ç”Ÿäº§åº“ï¼šprod_db 2å½±å­åº“ï¼šprod_db_shadow æ–¹æ¡ˆä¸‰ï¼šæ•°æ®æ ‡è®°\n1// åœ¨æ•°æ®ä¸­æ·»åŠ å‹æµ‹æ ‡è®° 2@Data 3public class Order { 4 private Long id; 5 private Long userId; 6 private BigDecimal amount; 7 private Boolean isStressTest; // å‹æµ‹æ ‡è®° 8} æµé‡æ ‡è®°ä¸è·¯ç”± 1. æµé‡æ ‡è®° åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ å‹æµ‹æ ‡è®°ï¼š\n1public class StressTestFilter implements Filter { 2 3 private static final String STRESS_TEST_HEADER = \u0026#34;X-Stress-Test\u0026#34;; 4 5 @Override 6 public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) { 7 HttpServletRequest httpRequest = (HttpServletRequest) request; 8 9 // æ£€æŸ¥æ˜¯å¦ä¸ºå‹æµ‹æµé‡ 10 String stressTest = httpRequest.getHeader(STRESS_TEST_HEADER); 11 if (\u0026#34;true\u0026#34;.equals(stressTest)) { 12 // è®¾ç½®åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡ 13 StressTestContext.setStressTest(true); 14 } 15 16 try { 17 chain.doFilter(request, response); 18 } finally { 19 StressTestContext.clear(); 20 } 21 } 22} 2. æ•°æ®è·¯ç”± æ ¹æ®å‹æµ‹æ ‡è®°è·¯ç”±åˆ°å½±å­è¡¨/å½±å­åº“ï¼š\n1@Component 2public class StressTestDataSourceRouter extends AbstractRoutingDataSource { 3 4 @Override 5 protected Object determineCurrentLookupKey() { 6 // å¦‚æœæ˜¯å‹æµ‹æµé‡ï¼Œè·¯ç”±åˆ°å½±å­åº“ 7 if (StressTestContext.isStressTest()) { 8 return \u0026#34;shadow\u0026#34;; 9 } 10 return \u0026#34;master\u0026#34;; 11 } 12} 13 14@Configuration 15public class DataSourceConfig { 16 17 @Bean 18 public DataSource dataSource() { 19 StressTestDataSourceRouter router = new StressTestDataSourceRouter(); 20 21 Map\u0026lt;Object, Object\u0026gt; targetDataSources = new HashMap\u0026lt;\u0026gt;(); 22 targetDataSources.put(\u0026#34;master\u0026#34;, masterDataSource()); 23 targetDataSources.put(\u0026#34;shadow\u0026#34;, shadowDataSource()); 24 25 router.setTargetDataSources(targetDataSources); 26 router.setDefaultTargetDataSource(masterDataSource()); 27 28 return router; 29 } 30} 3. MyBatis æ‹¦æˆªå™¨ è‡ªåŠ¨åˆ‡æ¢è¡¨åï¼š\n1@Intercepts({ 2 @Signature(type = StatementHandler.class, method = \u0026#34;prepare\u0026#34;, args = {Connection.class, Integer.class}) 3}) 4public class StressTestInterceptor implements Interceptor { 5 6 @Override 7 public Object intercept(Invocation invocation) throws Throwable { 8 StatementHandler statementHandler = (StatementHandler) invocation.getTarget(); 9 BoundSql boundSql = statementHandler.getBoundSql(); 10 String sql = boundSql.getSql(); 11 12 // å¦‚æœæ˜¯å‹æµ‹æµé‡ï¼Œæ›¿æ¢è¡¨å 13 if (StressTestContext.isStressTest()) { 14 sql = sql.replaceAll(\u0026#34;t_(\\\\w+)\u0026#34;, \u0026#34;t_$1_shadow\u0026#34;); 15 16 // åå°„ä¿®æ”¹ SQL 17 Field field = boundSql.getClass().getDeclaredField(\u0026#34;sql\u0026#34;); 18 field.setAccessible(true); 19 field.set(boundSql, sql); 20 } 21 22 return invocation.proceed(); 23 } 24} å‹æµ‹å·¥å…·é€‰å‹ 1. JMeter ä¼˜ç‚¹ï¼š\nåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå¤šç§åè®® å›¾å½¢åŒ–ç•Œé¢ï¼Œæ˜“äºä½¿ç”¨ æ’ä»¶ä¸°å¯Œ ç¼ºç‚¹ï¼š\nå•æœºæ€§èƒ½æœ‰é™ èµ„æºæ¶ˆè€—è¾ƒå¤§ ä½¿ç”¨ç¤ºä¾‹ï¼š\n1# å‘½ä»¤è¡Œæ¨¡å¼è¿è¡Œ 2jmeter -n -t test-plan.jmx -l result.jtl -e -o report 3 4# åˆ†å¸ƒå¼å‹æµ‹ 5jmeter -n -t test-plan.jmx -R 192.168.1.101,192.168.1.102,192.168.1.103 2. Gatling ä¼˜ç‚¹ï¼š\nåŸºäº Scalaï¼Œæ€§èƒ½ä¼˜ç§€ DSL è„šæœ¬ï¼Œæ˜“äºç»´æŠ¤ æŠ¥å‘Šç¾è§‚ ç¤ºä¾‹è„šæœ¬ï¼š\n1import io.gatling.core.Predef._ 2import io.gatling.http.Predef._ 3import scala.concurrent.duration._ 4 5class OrderSimulation extends Simulation { 6 7 val httpProtocol = http 8 .baseUrl(\u0026#34;https://api.example.com\u0026#34;) 9 .header(\u0026#34;X-Stress-Test\u0026#34;, \u0026#34;true\u0026#34;) 10 11 val scn = scenario(\u0026#34;è®¢å•åœºæ™¯\u0026#34;) 12 .exec(http(\u0026#34;æµè§ˆå•†å“\u0026#34;) 13 .get(\u0026#34;/api/products/${productId}\u0026#34;) 14 .check(status.is(200))) 15 .pause(2) 16 .exec(http(\u0026#34;åŠ å…¥è´­ç‰©è½¦\u0026#34;) 17 .post(\u0026#34;/api/cart\u0026#34;) 18 .body(StringBody(\u0026#34;\u0026#34;\u0026#34;{\u0026#34;productId\u0026#34;: \u0026#34;${productId}\u0026#34;, \u0026#34;quantity\u0026#34;: 1}\u0026#34;\u0026#34;\u0026#34;)) 19 .check(status.is(200))) 20 .pause(3) 21 .exec(http(\u0026#34;åˆ›å»ºè®¢å•\u0026#34;) 22 .post(\u0026#34;/api/orders\u0026#34;) 23 .body(StringBody(\u0026#34;\u0026#34;\u0026#34;{\u0026#34;items\u0026#34;: [{\u0026#34;productId\u0026#34;: \u0026#34;${productId}\u0026#34;, \u0026#34;quantity\u0026#34;: 1}]}\u0026#34;\u0026#34;\u0026#34;)) 24 .check(status.is(200))) 25 26 setUp( 27 scn.inject( 28 rampUsersPerSec(10) to 1000 during (5 minutes), 29 constantUsersPerSec(1000) during (10 minutes) 30 ) 31 ).protocols(httpProtocol) 32} 3. é˜¿é‡Œäº‘ PTS ä¼˜ç‚¹ï¼š\näº‘ç«¯å‹æµ‹ï¼Œæ— éœ€æ­å»ºç¯å¢ƒ æ”¯æŒå¤§è§„æ¨¡å¹¶å‘ é›†æˆç›‘æ§å’ŒæŠ¥å‘Š é€‚ç”¨åœºæ™¯ï¼š\nå¤§è§„æ¨¡å‹æµ‹ï¼ˆä¸‡çº§å¹¶å‘ï¼‰ å¿«é€ŸéªŒè¯ æ— å‹æµ‹ç¯å¢ƒ å·¥å…·å¯¹æ¯” å·¥å…· æ€§èƒ½ æ˜“ç”¨æ€§ æˆæœ¬ é€‚ç”¨åœºæ™¯ JMeter ä¸­ é«˜ å…è´¹ ä¸­å°è§„æ¨¡å‹æµ‹ Gatling é«˜ ä¸­ å…è´¹ å¤§è§„æ¨¡å‹æµ‹ é˜¿é‡Œäº‘ PTS å¾ˆé«˜ é«˜ ä»˜è´¹ è¶…å¤§è§„æ¨¡å‹æµ‹ ç›‘æ§ä¸åˆ†æ 1. åº”ç”¨ç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nQPS/TPSï¼šæ¯ç§’è¯·æ±‚æ•° å“åº”æ—¶é—´ï¼šP50ã€P95ã€P99 é”™è¯¯ç‡ï¼š4xxã€5xx é”™è¯¯ çº¿ç¨‹æ± ï¼šæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ Prometheus + Grafanaï¼š\n1# prometheus.yml 2scrape_configs: 3 - job_name: \u0026#39;spring-boot\u0026#39; 4 metrics_path: \u0026#39;/actuator/prometheus\u0026#39; 5 static_configs: 6 - targets: [\u0026#39;192.168.1.101:8080\u0026#39;, \u0026#39;192.168.1.102:8080\u0026#39;] 2. ç³»ç»Ÿç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nCPUï¼šä½¿ç”¨ç‡ã€è´Ÿè½½ å†…å­˜ï¼šä½¿ç”¨ç‡ã€GC é¢‘ç‡ ç£ç›˜ï¼šIOPSã€ååé‡ ç½‘ç»œï¼šå¸¦å®½ã€è¿æ¥æ•° ä½¿ç”¨ Node Exporterï¼š\n1# å¯åŠ¨ Node Exporter 2docker run -d \\ 3 --name=node-exporter \\ 4 -p 9100:9100 \\ 5 prom/node-exporter 3. æ•°æ®åº“ç›‘æ§ å…³é”®æŒ‡æ ‡ï¼š\nQPSï¼šæŸ¥è¯¢æ•° æ…¢æŸ¥è¯¢ï¼šæ‰§è¡Œæ—¶é—´ \u0026gt; 1s è¿æ¥æ•°ï¼šæ´»è·ƒè¿æ¥ é”ç­‰å¾…ï¼šè¡Œé”ã€è¡¨é” MySQL æ…¢æŸ¥è¯¢åˆ†æï¼š\n1-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— 2SET GLOBAL slow_query_log = \u0026#39;ON\u0026#39;; 3SET GLOBAL long_query_time = 1; 4 5-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ 6SELECT * FROM mysql.slow_log ORDER BY query_time DESC LIMIT 10; 4. æ€§èƒ½åˆ†æ ç«ç„°å›¾ï¼š\n1# ä½¿ç”¨ async-profiler 2./profiler.sh -d 60 -f flamegraph.html \u0026lt;pid\u0026gt; JVM åˆ†æï¼š\n1# æŸ¥çœ‹ GC æƒ…å†µ 2jstat -gcutil \u0026lt;pid\u0026gt; 1000 3 4# ç”Ÿæˆå †è½¬å‚¨ 5jmap -dump:format=b,file=heap.hprof \u0026lt;pid\u0026gt; 6 7# åˆ†æå †è½¬å‚¨ 8jhat heap.hprof æ€§èƒ½ä¼˜åŒ–å®æˆ˜ æ¡ˆä¾‹ä¸€ï¼šæ•°æ®åº“æ…¢æŸ¥è¯¢ é—®é¢˜ï¼šè®¢å•æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´ P99 è¾¾åˆ° 2 ç§’\nåˆ†æï¼š\n1-- æ…¢æŸ¥è¯¢ SQL 2SELECT * FROM t_order 3WHERE user_id = 123 AND status = 1 4ORDER BY create_time DESC 5LIMIT 10; 6 7-- æ‰§è¡Œè®¡åˆ’ 8EXPLAIN SELECT * FROM t_order 9WHERE user_id = 123 AND status = 1 10ORDER BY create_time DESC 11LIMIT 10; 12 13-- ç»“æœï¼štype=ALLï¼Œå…¨è¡¨æ‰«æ ä¼˜åŒ–ï¼š\n1-- æ·»åŠ å¤åˆç´¢å¼• 2CREATE INDEX idx_user_status_time ON t_order(user_id, status, create_time); 3 4-- ä¼˜åŒ–åï¼štype=refï¼Œä½¿ç”¨ç´¢å¼• æ•ˆæœï¼šå“åº”æ—¶é—´é™ä½åˆ° 50ms\næ¡ˆä¾‹äºŒï¼šç¼“å­˜ç©¿é€ é—®é¢˜ï¼šRedis ç¼“å­˜æœªå‘½ä¸­ï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“\nåˆ†æï¼š\n1// åŸä»£ç  2public Order getOrder(Long orderId) { 3 // æŸ¥è¯¢ç¼“å­˜ 4 Order order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 5 if (order == null) { 6 // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ 7 order = orderMapper.selectById(orderId); 8 if (order != null) { 9 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, order, 30, TimeUnit.MINUTES); 10 } 11 } 12 return order; 13} ä¼˜åŒ–ï¼š\n1// ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ 2@Autowired 3private BloomFilter\u0026lt;Long\u0026gt; orderBloomFilter; 4 5public Order getOrder(Long orderId) { 6 // å…ˆæ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨ 7 if (!orderBloomFilter.mightContain(orderId)) { 8 return null; // è®¢å•ä¸å­˜åœ¨ 9 } 10 11 // æŸ¥è¯¢ç¼“å­˜ 12 Order order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 13 if (order == null) { 14 // ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿ 15 String lockKey = \u0026#34;lock:order:\u0026#34; + orderId; 16 if (redisTemplate.opsForValue().setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS)) { 17 try { 18 // å†æ¬¡æ£€æŸ¥ç¼“å­˜ 19 order = redisTemplate.opsForValue().get(\u0026#34;order:\u0026#34; + orderId); 20 if (order == null) { 21 // æŸ¥è¯¢æ•°æ®åº“ 22 order = orderMapper.selectById(orderId); 23 if (order != null) { 24 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, order, 30, TimeUnit.MINUTES); 25 } else { 26 // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç©¿é€ 27 redisTemplate.opsForValue().set(\u0026#34;order:\u0026#34; + orderId, new Order(), 5, TimeUnit.MINUTES); 28 } 29 } 30 } finally { 31 redisTemplate.delete(lockKey); 32 } 33 } 34 } 35 return order; 36} æ¡ˆä¾‹ä¸‰ï¼šçº¿ç¨‹æ± æ»¡ é—®é¢˜ï¼šçº¿ç¨‹æ± é˜Ÿåˆ—æ»¡ï¼Œè¯·æ±‚è¢«æ‹’ç»\nåˆ†æï¼š\n1// åŸé…ç½® 2@Bean 3public ThreadPoolExecutor executor() { 4 return new ThreadPoolExecutor( 5 10, // æ ¸å¿ƒçº¿ç¨‹æ•° 6 20, // æœ€å¤§çº¿ç¨‹æ•° 7 60L, TimeUnit.SECONDS, 8 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), // é˜Ÿåˆ—å®¹é‡ 100 9 new ThreadPoolExecutor.AbortPolicy() // æ‹’ç»ç­–ç•¥ï¼šæŠ›å¼‚å¸¸ 10 ); 11} ä¼˜åŒ–ï¼š\n1@Bean 2public ThreadPoolExecutor executor() { 3 return new ThreadPoolExecutor( 4 50, // å¢åŠ æ ¸å¿ƒçº¿ç¨‹æ•° 5 100, // å¢åŠ æœ€å¤§çº¿ç¨‹æ•° 6 60L, TimeUnit.SECONDS, 7 new LinkedBlockingQueue\u0026lt;\u0026gt;(1000), // å¢åŠ é˜Ÿåˆ—å®¹é‡ 8 new ThreadFactoryBuilder() 9 .setNameFormat(\u0026#34;business-thread-%d\u0026#34;) 10 .build(), 11 new ThreadPoolExecutor.CallerRunsPolicy() // æ”¹ä¸ºè°ƒç”¨è€…è¿è¡Œç­–ç•¥ 12 ); 13} 14 15// æ·»åŠ ç›‘æ§ 16@Scheduled(fixedRate = 5000) 17public void monitorThreadPool() { 18 ThreadPoolExecutor executor = (ThreadPoolExecutor) this.executor; 19 log.info(\u0026#34;çº¿ç¨‹æ± çŠ¶æ€ - æ´»è·ƒçº¿ç¨‹ï¼š{}ï¼Œé˜Ÿåˆ—å¤§å°ï¼š{}ï¼Œå®Œæˆä»»åŠ¡ï¼š{}\u0026#34;, 20 executor.getActiveCount(), 21 executor.getQueue().size(), 22 executor.getCompletedTaskCount()); 23} å‹æµ‹æµç¨‹ 1. å‡†å¤‡é˜¶æ®µ ç¡®å®šå‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡† å‡†å¤‡å‹æµ‹ç¯å¢ƒå’Œæ•°æ® é…ç½®æµé‡æ ‡è®°å’Œæ•°æ®éš”ç¦» ç¼–å†™å‹æµ‹è„šæœ¬ æ­å»ºç›‘æ§ç³»ç»Ÿ 2. é¢„æ¼”é˜¶æ®µ å°æµé‡å‹æµ‹ï¼ˆ10% ç›®æ ‡æµé‡ï¼‰ éªŒè¯æ•°æ®éš”ç¦»æ˜¯å¦ç”Ÿæ•ˆ æ£€æŸ¥ç›‘æ§æŒ‡æ ‡æ˜¯å¦æ­£å¸¸ ç¡®è®¤æ— çœŸå®ç”¨æˆ·å½±å“ 3. æ­£å¼å‹æµ‹ é€æ­¥å¢åŠ å‹åŠ›ï¼ˆæ¢¯åº¦å‹æµ‹ï¼‰ å®æ—¶ç›‘æ§ç³»ç»ŸæŒ‡æ ‡ è®°å½•æ€§èƒ½ç“¶é¢ˆ è¾¾åˆ°ç›®æ ‡åæŒç»­ 10-30 åˆ†é’Ÿ 4. åˆ†æé˜¶æ®µ æ±‡æ€»å‹æµ‹æ•°æ® åˆ†ææ€§èƒ½ç“¶é¢ˆ åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ è¯„ä¼°å®¹é‡è§„åˆ’ 5. ä¼˜åŒ–é˜¶æ®µ å®æ–½ä¼˜åŒ–æ–¹æ¡ˆ å›å½’å‹æµ‹éªŒè¯ æŒç»­è¿­ä»£ä¼˜åŒ– æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼š\nå‹æµ‹ä»·å€¼ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ç³»ç»ŸçœŸå®æ‰¿è½½èƒ½åŠ› æ–¹æ¡ˆè®¾è®¡ï¼šç›®æ ‡è®¾å®šã€æµé‡æ¨¡å‹ã€æ•°æ®éš”ç¦» æµé‡æ ‡è®°ï¼šè¯·æ±‚æ ‡è®°ã€æ•°æ®è·¯ç”±ã€è¡¨ååˆ‡æ¢ å·¥å…·é€‰å‹ï¼šJMeterã€Gatlingã€é˜¿é‡Œäº‘ PTS ç›‘æ§åˆ†æï¼šåº”ç”¨ç›‘æ§ã€ç³»ç»Ÿç›‘æ§ã€æ•°æ®åº“ç›‘æ§ æ€§èƒ½ä¼˜åŒ–ï¼šæ…¢æŸ¥è¯¢ã€ç¼“å­˜ç©¿é€ã€çº¿ç¨‹æ±  å‹æµ‹æµç¨‹ï¼šå‡†å¤‡ã€é¢„æ¼”ã€æ­£å¼ã€åˆ†æã€ä¼˜åŒ– åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå…¨é“¾è·¯å‹æµ‹æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦ï¼š\nå®šæœŸå‹æµ‹ï¼šæ¯æ¬¡å¤§ä¿ƒå‰ã€é‡å¤§åŠŸèƒ½ä¸Šçº¿å‰ æŒç»­ä¼˜åŒ–ï¼šæ ¹æ®å‹æµ‹ç»“æœä¸æ–­ä¼˜åŒ– å®¹é‡è§„åˆ’ï¼šä¸ºä¸šåŠ¡å¢é•¿é¢„ç•™èµ„æº åº”æ€¥é¢„æ¡ˆï¼šåˆ¶å®šé™çº§ã€é™æµã€ç†”æ–­ç­–ç•¥ ä¸‹æ¬¡å½“ä½ éœ€è¦éªŒè¯ç³»ç»Ÿæ‰¿è½½èƒ½åŠ›æ—¶ï¼Œä¸å¦¨è¯•è¯•å…¨é“¾è·¯å‹æµ‹è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ã€‚\n","permalink":"http://localhost:1313/posts/2025/09/%E5%85%A8%E9%93%BE%E8%B7%AF%E5%8E%8B%E6%B5%8B%E5%A6%82%E4%BD%95%E9%AA%8C%E8%AF%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%9C%9F%E5%AE%9E%E6%89%BF%E8%BD%BD%E8%83%BD%E5%8A%9B/","summary":"\u003cp\u003eåœ¨å¤§ä¿ƒã€ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œç³»ç»Ÿèƒ½å¦æ‰›ä½æµé‡å†²å‡»æ˜¯æ¯ä¸ªæŠ€æœ¯å›¢é˜Ÿæœ€å…³å¿ƒçš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„å•æ¥å£å‹æµ‹æ— æ³•çœŸå®åæ˜ ç³»ç»Ÿçš„æ•´ä½“æ‰¿è½½èƒ½åŠ›ï¼Œè€Œå…¨é“¾è·¯å‹æµ‹é€šè¿‡æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºï¼Œå¯ä»¥å…¨é¢éªŒè¯ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†æ·±å…¥è®²è§£å…¨é“¾è·¯å‹æµ‹çš„æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½ï¼Œä»ç†è®ºåˆ°å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºå®Œæ•´çš„å‹æµ‹ä½“ç³»ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å…¨é“¾è·¯å‹æµ‹çš„æ ¸å¿ƒä»·å€¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å‹æµ‹ç¯å¢ƒçš„æ­å»ºæ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šæ•°æ®éš”ç¦»ä¸æµé‡æ ‡è®°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å‹æµ‹å·¥å…·çš„é€‰å‹ä¸ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ€§èƒ½ç“¶é¢ˆçš„åˆ†æä¸ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹\"\u003eä»€ä¹ˆæ˜¯å…¨é“¾è·¯å‹æµ‹\u003c/h2\u003e\n\u003ch3 id=\"ä¼ ç»Ÿå‹æµ‹-vs-å…¨é“¾è·¯å‹æµ‹\"\u003eä¼ ç»Ÿå‹æµ‹ vs å…¨é“¾è·¯å‹æµ‹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿå‹æµ‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé’ˆå¯¹å•ä¸ªæ¥å£æˆ–æœåŠ¡è¿›è¡Œå‹æµ‹\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨æµ‹è¯•ç¯å¢ƒæˆ–é¢„å‘å¸ƒç¯å¢ƒ\u003c/li\u003e\n\u003cli\u003eæ•°æ®é‡å°ï¼Œæ— æ³•åæ˜ çœŸå®æƒ…å†µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå…¨é“¾è·¯å‹æµ‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå‹æµ‹\u003c/li\u003e\n\u003cli\u003eæ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„å®Œæ•´ä¸šåŠ¡æµç¨‹\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨çœŸå®çš„æ•°æ®é‡å’Œç³»ç»Ÿé…ç½®\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"å…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼\"\u003eå…¨é“¾è·¯å‹æµ‹çš„ä»·å€¼\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eçœŸå®æ€§\u003c/strong\u003eï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œç»“æœæœ€å¯ä¿¡\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå…¨é¢æ€§\u003c/strong\u003eï¼šè¦†ç›–æ‰€æœ‰ç³»ç»Ÿç»„ä»¶å’Œä¾èµ–\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåŠæ—¶æ€§\u003c/strong\u003eï¼šæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæŒ‡å¯¼æ€§\u003c/strong\u003eï¼šä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æŒ\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"å‹æµ‹åœºæ™¯\"\u003eå‹æµ‹åœºæ™¯\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eç”¨æˆ·è®¿é—® â†’ ç½‘å…³ â†’ åº”ç”¨æœåŠ¡ â†’ ç¼“å­˜ â†’ æ•°æ®åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e                â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e            æ¶ˆæ¯é˜Ÿåˆ— â†’ å¼‚æ­¥æœåŠ¡\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e                â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e            ç¬¬ä¸‰æ–¹æœåŠ¡\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e å…¨é“¾è·¯å‹æµ‹ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯ä¸šåŠ¡é—®é¢˜ã€‚éœ€è¦äº§å“ã€è¿è¥ã€æŠ€æœ¯å›¢é˜Ÿå…±åŒå‚ä¸ï¼Œåˆ¶å®šåˆç†çš„å‹æµ‹ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡†ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"å‹æµ‹æ–¹æ¡ˆè®¾è®¡\"\u003eå‹æµ‹æ–¹æ¡ˆè®¾è®¡\u003c/h2\u003e\n\u003ch3 id=\"1-å‹æµ‹ç›®æ ‡è®¾å®š\"\u003e1. å‹æµ‹ç›®æ ‡è®¾å®š\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæ€§èƒ½æŒ‡æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eTPS/QPS\u003c/strong\u003eï¼šæ¯ç§’äº‹åŠ¡æ•°/æŸ¥è¯¢æ•°\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå“åº”æ—¶é—´\u003c/strong\u003eï¼šP50ã€P95ã€P99\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæˆåŠŸç‡\u003c/strong\u003eï¼šè¯·æ±‚æˆåŠŸçš„æ¯”ä¾‹\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eèµ„æºä½¿ç”¨ç‡\u003c/strong\u003eï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡æŒ‡æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eè®¢å•åˆ›å»ºæˆåŠŸç‡\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ”¯ä»˜æˆåŠŸç‡\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåº“å­˜æ‰£å‡å‡†ç¡®æ€§\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eç¤ºä¾‹ç›®æ ‡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå¤§ä¿ƒåœºæ™¯ï¼š\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e- å³°å€¼ TPSï¼š10000\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e- P99 å“åº”æ—¶é—´ï¼š\u0026lt; 500ms\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e- æˆåŠŸç‡ï¼š\u0026gt; 99.9%\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e- CPU ä½¿ç”¨ç‡ï¼š\u0026lt; 70%\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"2-å‹æµ‹æµé‡æ¨¡å‹\"\u003e2. å‹æµ‹æµé‡æ¨¡å‹\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæµé‡ç‰¹å¾\u003c/strong\u003eï¼š\u003c/p\u003e","title":"å…¨é“¾è·¯å‹æµ‹ï¼šå¦‚ä½•éªŒè¯ç³»ç»Ÿçš„çœŸå®æ‰¿è½½èƒ½åŠ›"},{"content":"Git å·²ç»æˆä¸ºç°ä»£è½¯ä»¶å¼€å‘çš„æ ‡å‡†ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚ç„¶è€Œï¼Œä»…ä»…ä¼šç”¨ Git å‘½ä»¤æ˜¯ä¸å¤Ÿçš„ï¼Œå¦‚ä½•åœ¨å›¢é˜Ÿä¸­å»ºç«‹é«˜æ•ˆçš„ Git å·¥ä½œæµï¼Œæ‰æ˜¯æå‡å¼€å‘æ•ˆç‡çš„å…³é”®ã€‚\næœ¬æ–‡å°†ä»å®é™…å›¢é˜Ÿåä½œå‡ºå‘ï¼Œæ·±å…¥è®²è§£ Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ å’Œå›¢é˜Ÿå»ºç«‹è§„èŒƒã€é«˜æ•ˆçš„å¼€å‘æµç¨‹ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ä¸»æµ Git å·¥ä½œæµæ¨¡å‹ æŒæ¡åˆ†æ”¯ç®¡ç†çš„æœ€ä½³å®è·µ å­¦ä¼šè§„èŒƒçš„æäº¤ä¿¡æ¯ç¼–å†™ äº†è§£ä»£ç å®¡æŸ¥çš„æµç¨‹ä¸æŠ€å·§ æŒæ¡å†²çªè§£å†³ä¸å›æ»šç­–ç•¥ ä¸»æµ Git å·¥ä½œæµæ¨¡å‹ 1. Git Flow æœ€ç»å…¸çš„åˆ†æ”¯æ¨¡å‹ï¼Œé€‚åˆç‰ˆæœ¬å‘å¸ƒå‘¨æœŸè¾ƒé•¿çš„é¡¹ç›®ï¼š\n1master (ç”Ÿäº§ç¯å¢ƒ) 2 â†“ 3develop (å¼€å‘ç¯å¢ƒ) 4 â†“ 5feature/* (åŠŸèƒ½åˆ†æ”¯) 6release/* (å‘å¸ƒåˆ†æ”¯) 7hotfix/* (çƒ­ä¿®å¤åˆ†æ”¯) åˆ†æ”¯è¯´æ˜ï¼š\nmasterï¼šç”Ÿäº§ç¯å¢ƒä»£ç ï¼Œæ¯ä¸ªæäº¤éƒ½æ˜¯ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬ developï¼šå¼€å‘ç¯å¢ƒä»£ç ï¼Œé›†æˆæ‰€æœ‰åŠŸèƒ½ feature/*ï¼šåŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œå®Œæˆååˆå¹¶å› develop release/*ï¼šå‘å¸ƒå‡†å¤‡åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œæµ‹è¯•é€šè¿‡ååˆå¹¶åˆ° master å’Œ develop hotfix/*ï¼šç´§æ€¥ä¿®å¤åˆ†æ”¯ï¼Œä» master åˆ†å‡ºï¼Œä¿®å¤ååˆå¹¶åˆ° master å’Œ develop å·¥ä½œæµç¨‹ï¼š\n1# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ 2git checkout -b feature/user-login develop 3 4# 2. å¼€å‘åŠŸèƒ½ 5git add . 6git commit -m \u0026#34;feat: å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34; 7 8# 3. åˆå¹¶åˆ° develop 9git checkout develop 10git merge --no-ff feature/user-login 11git branch -d feature/user-login 12 13# 4. åˆ›å»ºå‘å¸ƒåˆ†æ”¯ 14git checkout -b release/1.0.0 develop 15 16# 5. å‘å¸ƒåˆ°ç”Ÿäº§ 17git checkout master 18git merge --no-ff release/1.0.0 19git tag -a v1.0.0 -m \u0026#34;Release version 1.0.0\u0026#34; 20 21# 6. åˆå¹¶å› develop 22git checkout develop 23git merge --no-ff release/1.0.0 24git branch -d release/1.0.0 2. GitHub Flow ç®€åŒ–ç‰ˆå·¥ä½œæµï¼Œé€‚åˆæŒç»­éƒ¨ç½²çš„é¡¹ç›®ï¼š\n1master (ç”Ÿäº§ç¯å¢ƒ) 2 â†“ 3feature/* (åŠŸèƒ½åˆ†æ”¯) å·¥ä½œæµç¨‹ï¼š\n1# 1. ä» master åˆ›å»ºåˆ†æ”¯ 2git checkout -b feature/add-payment master 3 4# 2. å¼€å‘å¹¶æäº¤ 5git add . 6git commit -m \u0026#34;feat: æ·»åŠ æ”¯ä»˜åŠŸèƒ½\u0026#34; 7 8# 3. æ¨é€åˆ°è¿œç¨‹ 9git push origin feature/add-payment 10 11# 4. åˆ›å»º Pull Request 12# åœ¨ GitHub ä¸Šåˆ›å»º PRï¼Œè¿›è¡Œä»£ç å®¡æŸ¥ 13 14# 5. åˆå¹¶åˆ° master 15# å®¡æŸ¥é€šè¿‡åï¼Œåœ¨ GitHub ä¸Šåˆå¹¶ PR 16 17# 6. éƒ¨ç½²åˆ°ç”Ÿäº§ 18# CI/CD è‡ªåŠ¨éƒ¨ç½² 3. GitLab Flow ç»“åˆäº† Git Flow å’Œ GitHub Flow çš„ä¼˜ç‚¹ï¼š\n1master (å¼€å‘ç¯å¢ƒ) 2 â†“ 3pre-production (é¢„å‘å¸ƒç¯å¢ƒ) 4 â†“ 5production (ç”Ÿäº§ç¯å¢ƒ) ç‰¹ç‚¹ï¼š\nä»¥ç¯å¢ƒä¸ºå¯¼å‘çš„åˆ†æ”¯ç­–ç•¥ ä»£ç ä»ä¸Šæ¸¸ç¯å¢ƒæµå‘ä¸‹æ¸¸ç¯å¢ƒ é€‚åˆå¤šç¯å¢ƒéƒ¨ç½²çš„é¡¹ç›® å·¥ä½œæµå¯¹æ¯” å·¥ä½œæµ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ ä¼˜ç‚¹ ç¼ºç‚¹ Git Flow é«˜ ç‰ˆæœ¬å‘å¸ƒå‘¨æœŸé•¿ æµç¨‹æ¸…æ™°ï¼Œé€‚åˆå¤§å›¢é˜Ÿ åˆ†æ”¯å¤šï¼Œæ“ä½œå¤æ‚ GitHub Flow ä½ æŒç»­éƒ¨ç½² ç®€å•ï¼Œå¿«é€Ÿè¿­ä»£ ä¸é€‚åˆå¤šç‰ˆæœ¬ç»´æŠ¤ GitLab Flow ä¸­ å¤šç¯å¢ƒéƒ¨ç½² çµæ´»ï¼Œç¯å¢ƒéš”ç¦» éœ€è¦ CI/CD æ”¯æŒ æ¶æ„æ€è€ƒï¼š é€‰æ‹©å·¥ä½œæµæ—¶ï¼Œè¦è€ƒè™‘å›¢é˜Ÿè§„æ¨¡ã€å‘å¸ƒé¢‘ç‡ã€ç¯å¢ƒæ•°é‡ç­‰å› ç´ ã€‚å°å›¢é˜Ÿæˆ–å¿«é€Ÿè¿­ä»£çš„é¡¹ç›®ï¼Œæ¨è GitHub Flowï¼›å¤§å›¢é˜Ÿæˆ–éœ€è¦å¤šç‰ˆæœ¬ç»´æŠ¤çš„é¡¹ç›®ï¼Œæ¨è Git Flowã€‚\nåˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ åˆ†æ”¯å‘½åè§„èŒƒ 1# åŠŸèƒ½åˆ†æ”¯ 2feature/user-authentication 3feature/payment-integration 4 5# ä¿®å¤åˆ†æ”¯ 6bugfix/login-error 7bugfix/payment-timeout 8 9# çƒ­ä¿®å¤åˆ†æ”¯ 10hotfix/critical-security-issue 11 12# å‘å¸ƒåˆ†æ”¯ 13release/v1.2.0 14 15# æ–‡æ¡£åˆ†æ”¯ 16docs/api-documentation åˆ†æ”¯ä¿æŠ¤è§„åˆ™ åœ¨ GitHub/GitLab ä¸­è®¾ç½®åˆ†æ”¯ä¿æŠ¤ï¼š\nç¦æ­¢ç›´æ¥æ¨é€åˆ° master/main è¦æ±‚ Pull Request å®¡æŸ¥ï¼šè‡³å°‘ 1-2 äººå®¡æŸ¥ è¦æ±‚çŠ¶æ€æ£€æŸ¥é€šè¿‡ï¼šCI/CD æ„å»ºæˆåŠŸ è¦æ±‚åˆ†æ”¯æ˜¯æœ€æ–°çš„ï¼šåˆå¹¶å‰å¿…é¡» rebase è¦æ±‚ç­¾åæäº¤ï¼šä½¿ç”¨ GPG ç­¾å åˆ†æ”¯æ¸…ç† 1# æŸ¥çœ‹å·²åˆå¹¶çš„åˆ†æ”¯ 2git branch --merged 3 4# åˆ é™¤å·²åˆå¹¶çš„æœ¬åœ°åˆ†æ”¯ 5git branch -d feature/user-login 6 7# åˆ é™¤è¿œç¨‹åˆ†æ”¯ 8git push origin --delete feature/user-login 9 10# æ‰¹é‡åˆ é™¤å·²åˆå¹¶çš„æœ¬åœ°åˆ†æ”¯ 11git branch --merged | grep -v \u0026#34;\\*\u0026#34; | grep -v \u0026#34;master\u0026#34; | grep -v \u0026#34;develop\u0026#34; | xargs -n 1 git branch -d æäº¤ä¿¡æ¯è§„èŒƒ Conventional Commits éµå¾ªçº¦å®šå¼æäº¤è§„èŒƒï¼š\n1\u0026lt;type\u0026gt;(\u0026lt;scope\u0026gt;): \u0026lt;subject\u0026gt; 2 3\u0026lt;body\u0026gt; 4 5\u0026lt;footer\u0026gt; Type ç±»å‹ï¼š\nfeatï¼šæ–°åŠŸèƒ½ fixï¼šä¿®å¤ Bug docsï¼šæ–‡æ¡£å˜æ›´ styleï¼šä»£ç æ ¼å¼ï¼ˆä¸å½±å“ä»£ç è¿è¡Œï¼‰ refactorï¼šé‡æ„ï¼ˆæ—¢ä¸æ˜¯æ–°åŠŸèƒ½ä¹Ÿä¸æ˜¯ä¿®å¤ï¼‰ perfï¼šæ€§èƒ½ä¼˜åŒ– testï¼šæµ‹è¯•ç›¸å…³ choreï¼šæ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨ ç¤ºä¾‹ï¼š\n1# æ–°åŠŸèƒ½ 2git commit -m \u0026#34;feat(auth): æ·»åŠ  JWT è®¤è¯åŠŸèƒ½\u0026#34; 3 4# ä¿®å¤ Bug 5git commit -m \u0026#34;fix(payment): ä¿®å¤æ”¯ä»˜é‡‘é¢è®¡ç®—é”™è¯¯ 6 7æ”¯ä»˜é‡‘é¢åœ¨è®¡ç®—æŠ˜æ‰£æ—¶å‡ºç°ç²¾åº¦é—®é¢˜ï¼Œå¯¼è‡´å®é™…æ”¯ä»˜é‡‘é¢ä¸æ­£ç¡®ã€‚ 8æœ¬æ¬¡ä¿®å¤ä½¿ç”¨ BigDecimal è¿›è¡Œç²¾ç¡®è®¡ç®—ã€‚ 9 10Closes #123\u0026#34; 11 12# ç ´åæ€§å˜æ›´ 13git commit -m \u0026#34;feat(api): é‡æ„ç”¨æˆ· API æ¥å£ 14 15BREAKING CHANGE: ç”¨æˆ· API æ¥å£è·¯å¾„ä» /api/user æ”¹ä¸º /api/v2/users\u0026#34; æäº¤æœ€ä½³å®è·µ åŸå­æ€§æäº¤ï¼šæ¯æ¬¡æäº¤åªåšä¸€ä»¶äº‹ æœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯ï¼šæ¸…æ¥šæè¿°åšäº†ä»€ä¹ˆå’Œä¸ºä»€ä¹ˆ é¢‘ç¹æäº¤ï¼šå°æ­¥å¿«è·‘ï¼Œä¾¿äºå›æ»š æäº¤å‰æ£€æŸ¥ï¼šä½¿ç”¨ git diff æ£€æŸ¥å˜æ›´ 1# æŸ¥çœ‹æš‚å­˜åŒºçš„å˜æ›´ 2git diff --staged 3 4# äº¤äº’å¼æš‚å­˜ 5git add -p 6 7# ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤ 8git commit --amend 9 10# ä¿®æ”¹æäº¤ä¿¡æ¯ 11git commit --amend -m \u0026#34;æ–°çš„æäº¤ä¿¡æ¯\u0026#34; ä½¿ç”¨ Commitizen è‡ªåŠ¨ç”Ÿæˆè§„èŒƒçš„æäº¤ä¿¡æ¯ï¼š\n1# å®‰è£… 2npm install -g commitizen cz-conventional-changelog 3 4# åˆå§‹åŒ– 5commitizen init cz-conventional-changelog --save-dev --save-exact 6 7# ä½¿ç”¨ 8git cz ä»£ç å®¡æŸ¥æµç¨‹ Pull Request æ¨¡æ¿ åˆ›å»º .github/pull_request_template.mdï¼š\n1## å˜æ›´è¯´æ˜ 2\u0026lt;!-- ç®€è¦æè¿°æœ¬æ¬¡å˜æ›´çš„å†…å®¹ --\u0026gt; 3 4## å˜æ›´ç±»å‹ 5- [ ] æ–°åŠŸèƒ½ 6- [ ] Bug ä¿®å¤ 7- [ ] é‡æ„ 8- [ ] æ–‡æ¡£æ›´æ–° 9- [ ] æ€§èƒ½ä¼˜åŒ– 10 11## ç›¸å…³ Issue 12\u0026lt;!-- å…³è”çš„ Issue ç¼–å·ï¼Œå¦‚ #123 --\u0026gt; 13 14## æµ‹è¯•è¯´æ˜ 15\u0026lt;!-- å¦‚ä½•æµ‹è¯•æœ¬æ¬¡å˜æ›´ --\u0026gt; 16 17## æˆªå›¾ï¼ˆå¦‚æœé€‚ç”¨ï¼‰ 18\u0026lt;!-- æ·»åŠ æˆªå›¾è¯´æ˜å˜æ›´æ•ˆæœ --\u0026gt; 19 20## æ£€æŸ¥æ¸…å• 21- [ ] ä»£ç éµå¾ªé¡¹ç›®è§„èŒƒ 22- [ ] å·²æ·»åŠ å¿…è¦çš„æµ‹è¯• 23- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ 24- [ ] å·²æ›´æ–°ç›¸å…³æ–‡æ¡£ 25- [ ] æ— æ–°å¢çš„ lint è­¦å‘Š ä»£ç å®¡æŸ¥è¦ç‚¹ åŠŸèƒ½æ€§ï¼š\nä»£ç æ˜¯å¦å®ç°äº†é¢„æœŸåŠŸèƒ½ æ˜¯å¦æœ‰é—æ¼çš„è¾¹ç•Œæƒ…å†µ é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„ å¯è¯»æ€§ï¼š\nå‘½åæ˜¯å¦æ¸…æ™° é€»è¾‘æ˜¯å¦æ˜“æ‡‚ æ˜¯å¦æœ‰å¿…è¦çš„æ³¨é‡Š æ€§èƒ½ï¼š\næ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜ æ•°æ®åº“æŸ¥è¯¢æ˜¯å¦ä¼˜åŒ– æ˜¯å¦æœ‰å†…å­˜æ³„æ¼é£é™© å®‰å…¨æ€§ï¼š\næ˜¯å¦æœ‰å®‰å…¨æ¼æ´ è¾“å…¥éªŒè¯æ˜¯å¦å……åˆ† æ•æ„Ÿä¿¡æ¯æ˜¯å¦æ³„éœ² å¯ç»´æŠ¤æ€§ï¼š\nä»£ç æ˜¯å¦ç¬¦åˆ SOLID åŸåˆ™ æ˜¯å¦æœ‰é‡å¤ä»£ç  æ˜¯å¦æ˜“äºæµ‹è¯• å®¡æŸ¥åé¦ˆæŠ€å·§ å¥½çš„åé¦ˆï¼š\n1å»ºè®®ï¼šè¿™é‡Œå¯ä»¥ä½¿ç”¨ Stream API ç®€åŒ–ä»£ç ï¼Œæé«˜å¯è¯»æ€§ã€‚ 2 3Optional\u0026lt;User\u0026gt; user = users.stream() 4 .filter(u -\u0026gt; u.getId().equals(userId)) 5 .findFirst(); ä¸å¥½çš„åé¦ˆï¼š\n1è¿™æ®µä»£ç å†™å¾—å¤ªçƒ‚äº†ï¼Œé‡å†™å§ã€‚ åŸåˆ™ï¼š\nå¯¹äº‹ä¸å¯¹äºº æä¾›å…·ä½“å»ºè®® è§£é‡ŠåŸå›  ä¿æŒå‹å¥½ å†²çªè§£å†³ é¢„é˜²å†²çª é¢‘ç¹åŒæ­¥ï¼šå®šæœŸä»ä¸»åˆ†æ”¯æ‹‰å–æœ€æ–°ä»£ç  å°æ­¥æäº¤ï¼šå‡å°‘å•æ¬¡å˜æ›´çš„èŒƒå›´ æ¨¡å—åŒ–å¼€å‘ï¼šå‡å°‘å¤šäººä¿®æ”¹åŒä¸€æ–‡ä»¶ 1# å®šæœŸåŒæ­¥ä¸»åˆ†æ”¯ 2git checkout feature/my-feature 3git fetch origin 4git rebase origin/develop è§£å†³å†²çª 1# 1. æ‹‰å–æœ€æ–°ä»£ç  2git fetch origin 3 4# 2. Rebase åˆ°æœ€æ–°çš„ develop 5git rebase origin/develop 6 7# 3. å¦‚æœæœ‰å†²çªï¼ŒGit ä¼šæç¤º 8# æ‰‹åŠ¨è§£å†³å†²çªåï¼š 9git add \u0026lt;å†²çªæ–‡ä»¶\u0026gt; 10git rebase --continue 11 12# 4. å¦‚æœæƒ³æ”¾å¼ƒ rebase 13git rebase --abort Merge vs Rebase Mergeï¼š\n1git checkout develop 2git merge feature/my-feature ä¼˜ç‚¹ï¼šä¿ç•™å®Œæ•´çš„å†å²è®°å½• ç¼ºç‚¹ï¼šäº§ç”Ÿé¢å¤–çš„åˆå¹¶æäº¤ï¼Œå†å²è®°å½•å¤æ‚\nRebaseï¼š\n1git checkout feature/my-feature 2git rebase develop ä¼˜ç‚¹ï¼šä¿æŒçº¿æ€§çš„å†å²è®°å½•ï¼Œæ›´æ¸…æ™° ç¼ºç‚¹ï¼šæ”¹å†™å†å²ï¼Œä¸é€‚åˆå·²æ¨é€çš„åˆ†æ”¯\næ¨èç­–ç•¥ï¼š\nåŠŸèƒ½åˆ†æ”¯å¼€å‘æ—¶ä½¿ç”¨ rebase ä¿æŒåŒæ­¥ åˆå¹¶åˆ°ä¸»åˆ†æ”¯æ—¶ä½¿ç”¨ merge ä¿ç•™å†å² é¿å‘æç¤ºï¼š æ°¸è¿œä¸è¦ rebase å·²ç»æ¨é€åˆ°è¿œç¨‹çš„å…¬å…±åˆ†æ”¯ï¼è¿™ä¼šå¯¼è‡´å…¶ä»–äººçš„å†å²è®°å½•æ··ä¹±ã€‚åªåœ¨æœ¬åœ°åˆ†æ”¯æˆ–ä¸ªäººåˆ†æ”¯ä¸Šä½¿ç”¨ rebaseã€‚\nå›æ»šç­–ç•¥ æ’¤é”€æœ¬åœ°ä¿®æ”¹ 1# æ’¤é”€å·¥ä½œåŒºçš„ä¿®æ”¹ 2git checkout -- \u0026lt;file\u0026gt; 3 4# æ’¤é”€æš‚å­˜åŒºçš„ä¿®æ”¹ 5git reset HEAD \u0026lt;file\u0026gt; 6 7# æ’¤é”€æœ€åä¸€æ¬¡æäº¤ï¼ˆä¿ç•™ä¿®æ”¹ï¼‰ 8git reset --soft HEAD^ 9 10# æ’¤é”€æœ€åä¸€æ¬¡æäº¤ï¼ˆä¸¢å¼ƒä¿®æ”¹ï¼‰ 11git reset --hard HEAD^ æ’¤é”€å·²æ¨é€çš„æäº¤ 1# æ–¹æ³• 1ï¼šRevertï¼ˆæ¨èï¼‰ 2# åˆ›å»ºä¸€ä¸ªæ–°æäº¤æ¥æ’¤é”€ä¹‹å‰çš„æäº¤ 3git revert \u0026lt;commit-hash\u0026gt; 4git push origin master 5 6# æ–¹æ³• 2ï¼šReset + Force Pushï¼ˆå±é™©ï¼‰ 7# åªåœ¨ä¸ªäººåˆ†æ”¯æˆ–ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨ 8git reset --hard \u0026lt;commit-hash\u0026gt; 9git push origin master --force æ¢å¤å·²åˆ é™¤çš„åˆ†æ”¯ 1# æŸ¥çœ‹æ‰€æœ‰æ“ä½œè®°å½• 2git reflog 3 4# æ¢å¤åˆ†æ”¯ 5git checkout -b \u0026lt;branch-name\u0026gt; \u0026lt;commit-hash\u0026gt; ç´§æ€¥å›æ»šç”Ÿäº§ç¯å¢ƒ 1# 1. åˆ›å»º hotfix åˆ†æ”¯ 2git checkout -b hotfix/rollback-v1.2.0 master 3 4# 2. å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ 5git revert \u0026lt;bad-commit-hash\u0026gt; 6 7# 3. æ¨é€å¹¶éƒ¨ç½² 8git push origin hotfix/rollback-v1.2.0 9 10# 4. åˆå¹¶åˆ° master 11git checkout master 12git merge hotfix/rollback-v1.2.0 13git tag -a v1.2.1 -m \u0026#34;Rollback to stable version\u0026#34; 14git push origin master --tags Git Hooks è‡ªåŠ¨åŒ– Pre-commit Hook åœ¨æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ä»£ç ï¼š\n1# .git/hooks/pre-commit 2 3#!/bin/sh 4 5# è¿è¡Œ lint æ£€æŸ¥ 6npm run lint 7if [ $? -ne 0 ]; then 8 echo \u0026#34;Lint æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤\u0026#34; 9 exit 1 10fi 11 12# è¿è¡Œå•å…ƒæµ‹è¯• 13npm run test 14if [ $? -ne 0 ]; then 15 echo \u0026#34;å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤\u0026#34; 16 exit 1 17fi 18 19echo \u0026#34;æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸æäº¤\u0026#34; 20exit 0 Commit-msg Hook æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ï¼š\n1# .git/hooks/commit-msg 2 3#!/bin/sh 4 5commit_msg=$(cat $1) 6 7# æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ 8if ! echo \u0026#34;$commit_msg\u0026#34; | grep -qE \u0026#34;^(feat|fix|docs|style|refactor|perf|test|chore)(\\(.+\\))?: .{1,50}\u0026#34;; then 9 echo \u0026#34;é”™è¯¯ï¼šæäº¤ä¿¡æ¯ä¸ç¬¦åˆè§„èŒƒ\u0026#34; 10 echo \u0026#34;æ ¼å¼ï¼š\u0026lt;type\u0026gt;(\u0026lt;scope\u0026gt;): \u0026lt;subject\u0026gt;\u0026#34; 11 echo \u0026#34;ç¤ºä¾‹ï¼šfeat(auth): æ·»åŠ ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34; 12 exit 1 13fi 14 15exit 0 ä½¿ç”¨ Husky æ›´æ–¹ä¾¿åœ°ç®¡ç† Git Hooksï¼š\n1# å®‰è£… 2npm install husky --save-dev 3 4# åˆå§‹åŒ– 5npx husky install 6 7# æ·»åŠ  pre-commit hook 8npx husky add .husky/pre-commit \u0026#34;npm run lint \u0026amp;\u0026amp; npm run test\u0026#34; 9 10# æ·»åŠ  commit-msg hook 11npx husky add .husky/commit-msg \u0026#39;npx --no -- commitlint --edit \u0026#34;$1\u0026#34;\u0026#39; å›¢é˜Ÿåä½œæŠ€å·§ 1. ä»£ç æ‰€æœ‰æƒ ä½¿ç”¨ CODEOWNERS æ–‡ä»¶ï¼š\n1# .github/CODEOWNERS 2 3# é»˜è®¤æ‰€æœ‰è€… 4* @team-lead 5 6# å‰ç«¯ä»£ç  7/frontend/** @frontend-team 8 9# åç«¯ä»£ç  10/backend/** @backend-team 11 12# æ•°æ®åº“è¿ç§» 13/migrations/** @dba-team @backend-lead 14 15# æ–‡æ¡£ 16/docs/** @tech-writer 2. Issue æ¨¡æ¿ åˆ›å»º .github/ISSUE_TEMPLATE/bug_report.mdï¼š\n1--- 2name: Bug æŠ¥å‘Š 3about: åˆ›å»º Bug æŠ¥å‘Šå¸®åŠ©æˆ‘ä»¬æ”¹è¿› 4title: \u0026#39;[BUG] \u0026#39; 5labels: bug 6assignees: \u0026#39;\u0026#39; 7--- 8 9## Bug æè¿° 10\u0026lt;!-- æ¸…æ™°ç®€æ´åœ°æè¿° Bug --\u0026gt; 11 12## å¤ç°æ­¥éª¤ 131. è®¿é—® \u0026#39;...\u0026#39; 142. ç‚¹å‡» \u0026#39;...\u0026#39; 153. æ»šåŠ¨åˆ° \u0026#39;...\u0026#39; 164. çœ‹åˆ°é”™è¯¯ 17 18## é¢„æœŸè¡Œä¸º 19\u0026lt;!-- æè¿°ä½ æœŸæœ›å‘ç”Ÿä»€ä¹ˆ --\u0026gt; 20 21## å®é™…è¡Œä¸º 22\u0026lt;!-- æè¿°å®é™…å‘ç”Ÿäº†ä»€ä¹ˆ --\u0026gt; 23 24## æˆªå›¾ 25\u0026lt;!-- å¦‚æœé€‚ç”¨ï¼Œæ·»åŠ æˆªå›¾ --\u0026gt; 26 27## ç¯å¢ƒä¿¡æ¯ 28- OS: [e.g. macOS 12.0] 29- Browser: [e.g. Chrome 96] 30- Version: [e.g. 1.2.0] 3. å‘å¸ƒæµç¨‹ 1# 1. æ›´æ–°ç‰ˆæœ¬å· 2npm version patch # 1.0.0 -\u0026gt; 1.0.1 3npm version minor # 1.0.0 -\u0026gt; 1.1.0 4npm version major # 1.0.0 -\u0026gt; 2.0.0 5 6# 2. ç”Ÿæˆ CHANGELOG 7npx conventional-changelog -p angular -i CHANGELOG.md -s 8 9# 3. æäº¤å¹¶æ‰“æ ‡ç­¾ 10git add . 11git commit -m \u0026#34;chore(release): v1.2.0\u0026#34; 12git tag -a v1.2.0 -m \u0026#34;Release version 1.2.0\u0026#34; 13 14# 4. æ¨é€ 15git push origin develop --tags æ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº† Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œä»å·¥ä½œæµæ¨¡å‹åˆ°å›¢é˜Ÿåä½œï¼š\nå·¥ä½œæµæ¨¡å‹ï¼šGit Flowã€GitHub Flowã€GitLab Flow çš„é€‰æ‹© åˆ†æ”¯ç®¡ç†ï¼šå‘½åè§„èŒƒã€ä¿æŠ¤è§„åˆ™ã€æ¸…ç†ç­–ç•¥ æäº¤è§„èŒƒï¼šConventional Commitsã€åŸå­æ€§æäº¤ ä»£ç å®¡æŸ¥ï¼šPR æ¨¡æ¿ã€å®¡æŸ¥è¦ç‚¹ã€åé¦ˆæŠ€å·§ å†²çªè§£å†³ï¼šé¢„é˜²ç­–ç•¥ã€Merge vs Rebase å›æ»šç­–ç•¥ï¼šæœ¬åœ°æ’¤é”€ã€è¿œç¨‹å›æ»šã€ç´§æ€¥å¤„ç† è‡ªåŠ¨åŒ–ï¼šGit Hooksã€Husky å›¢é˜Ÿåä½œï¼šCODEOWNERSã€Issue æ¨¡æ¿ã€å‘å¸ƒæµç¨‹ åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒGit å·¥ä½œæµä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œéœ€è¦æ ¹æ®å›¢é˜Ÿè§„æ¨¡ã€é¡¹ç›®ç‰¹ç‚¹ã€å‘å¸ƒé¢‘ç‡ç­‰å› ç´ çµæ´»è°ƒæ•´ã€‚å…³é”®æ˜¯å»ºç«‹è§„èŒƒã€ä¿æŒä¸€è‡´ã€æŒç»­æ”¹è¿›ã€‚\nä¸‹æ¬¡å½“ä½ åœ¨å›¢é˜Ÿä¸­æ¨å¹¿ Git æœ€ä½³å®è·µæ—¶ï¼Œä¸å¦¨ä»æœ¬æ–‡çš„å»ºè®®å¼€å§‹ï¼Œé€æ­¥å»ºç«‹é€‚åˆä½ ä»¬å›¢é˜Ÿçš„å·¥ä½œæµã€‚\n","permalink":"http://localhost:1313/posts/2025/07/git-%E5%B7%A5%E4%BD%9C%E6%B5%81%E4%BB%8E%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86%E5%88%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/","summary":"\u003cp\u003eGit å·²ç»æˆä¸ºç°ä»£è½¯ä»¶å¼€å‘çš„æ ‡å‡†ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚ç„¶è€Œï¼Œä»…ä»…ä¼šç”¨ Git å‘½ä»¤æ˜¯ä¸å¤Ÿçš„ï¼Œå¦‚ä½•åœ¨å›¢é˜Ÿä¸­å»ºç«‹é«˜æ•ˆçš„ Git å·¥ä½œæµï¼Œæ‰æ˜¯æå‡å¼€å‘æ•ˆç‡çš„å…³é”®ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…å›¢é˜Ÿåä½œå‡ºå‘ï¼Œæ·±å…¥è®²è§£ Git å·¥ä½œæµçš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ å’Œå›¢é˜Ÿå»ºç«‹è§„èŒƒã€é«˜æ•ˆçš„å¼€å‘æµç¨‹ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¸»æµ Git å·¥ä½œæµæ¨¡å‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡åˆ†æ”¯ç®¡ç†çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§„èŒƒçš„æäº¤ä¿¡æ¯ç¼–å†™\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ä»£ç å®¡æŸ¥çš„æµç¨‹ä¸æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å†²çªè§£å†³ä¸å›æ»šç­–ç•¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸»æµ-git-å·¥ä½œæµæ¨¡å‹\"\u003eä¸»æµ Git å·¥ä½œæµæ¨¡å‹\u003c/h2\u003e\n\u003ch3 id=\"1-git-flow\"\u003e1. Git Flow\u003c/h3\u003e\n\u003cp\u003eæœ€ç»å…¸çš„åˆ†æ”¯æ¨¡å‹ï¼Œé€‚åˆç‰ˆæœ¬å‘å¸ƒå‘¨æœŸè¾ƒé•¿çš„é¡¹ç›®ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003emaster (ç”Ÿäº§ç¯å¢ƒ)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003edevelop (å¼€å‘ç¯å¢ƒ)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  â†“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003efeature/* (åŠŸèƒ½åˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003erelease/* (å‘å¸ƒåˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003ehotfix/* (çƒ­ä¿®å¤åˆ†æ”¯)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ†æ”¯è¯´æ˜\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003emaster\u003c/code\u003eï¼šç”Ÿäº§ç¯å¢ƒä»£ç ï¼Œæ¯ä¸ªæäº¤éƒ½æ˜¯ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edevelop\u003c/code\u003eï¼šå¼€å‘ç¯å¢ƒä»£ç ï¼Œé›†æˆæ‰€æœ‰åŠŸèƒ½\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003efeature/*\u003c/code\u003eï¼šåŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œå®Œæˆååˆå¹¶å› develop\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003erelease/*\u003c/code\u003eï¼šå‘å¸ƒå‡†å¤‡åˆ†æ”¯ï¼Œä» develop åˆ†å‡ºï¼Œæµ‹è¯•é€šè¿‡ååˆå¹¶åˆ° master å’Œ develop\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ehotfix/*\u003c/code\u003eï¼šç´§æ€¥ä¿®å¤åˆ†æ”¯ï¼Œä» master åˆ†å‡ºï¼Œä¿®å¤ååˆå¹¶åˆ° master å’Œ develop\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå·¥ä½œæµç¨‹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout -b feature/user-login develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. å¼€å‘åŠŸèƒ½\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003egit add .\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003egit commit -m \u003cspan class=\"s2\"\u003e\u0026#34;feat: å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 3. åˆå¹¶åˆ° develop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff feature/user-login\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003egit branch -d feature/user-login\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 4. åˆ›å»ºå‘å¸ƒåˆ†æ”¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout -b release/1.0.0 develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 5. å‘å¸ƒåˆ°ç”Ÿäº§\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout master\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003egit tag -a v1.0.0 -m \u003cspan class=\"s2\"\u003e\u0026#34;Release version 1.0.0\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 6. åˆå¹¶å› develop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003egit checkout develop\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003egit merge --no-ff release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003egit branch -d release/1.0.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"2-github-flow\"\u003e2. GitHub Flow\u003c/h3\u003e\n\u003cp\u003eç®€åŒ–ç‰ˆå·¥ä½œæµï¼Œé€‚åˆæŒç»­éƒ¨ç½²çš„é¡¹ç›®ï¼š\u003c/p\u003e","title":"Git å·¥ä½œæµï¼šä»åˆ†æ”¯ç®¡ç†åˆ°ä»£ç å®¡æŸ¥çš„æœ€ä½³å®è·µ"},{"content":"Nginx ä½œä¸ºé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå·²ç»æˆä¸ºäº’è”ç½‘æ¶æ„ä¸­çš„æ ‡é…ç»„ä»¶ã€‚æ— è®ºæ˜¯é™æ€èµ„æºæœåŠ¡ã€åå‘ä»£ç†è¿˜æ˜¯è´Ÿè½½å‡è¡¡ï¼ŒNginx éƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚\næœ¬æ–‡å°†ä»å®é™…åœºæ™¯å‡ºå‘ï¼Œæ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œå¸®åŠ©ä½ æ„å»ºé«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åå‘ä»£ç†ä¸æ­£å‘ä»£ç†çš„åŒºåˆ« æŒæ¡ Nginx è´Ÿè½½å‡è¡¡çš„å¤šç§ç­–ç•¥ å­¦ä¼šé…ç½®å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» äº†è§£ä¼šè¯ä¿æŒçš„å®ç°æ–¹æ¡ˆ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§ åå‘ä»£ç†åŸºç¡€ æ­£å‘ä»£ç† vs åå‘ä»£ç† æ­£å‘ä»£ç†ï¼šå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®\n1å®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨ 2ï¼ˆå®¢æˆ·ç«¯é…ç½®ä»£ç†ï¼‰ åå‘ä»£ç†ï¼šå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å†³å®šè½¬å‘åˆ°å“ªå°æœåŠ¡å™¨\n1å®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨é›†ç¾¤ 2ï¼ˆæœåŠ¡ç«¯é…ç½®ä»£ç†ï¼‰ åå‘ä»£ç†çš„ä¼˜åŠ¿ è´Ÿè½½å‡è¡¡ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨ éšè—çœŸå®æœåŠ¡å™¨ï¼šæé«˜å®‰å…¨æ€§ SSL å¸è½½ï¼šåœ¨ä»£ç†å±‚å¤„ç† HTTPS ç¼“å­˜é™æ€èµ„æºï¼šå‡è½»åç«¯å‹åŠ› ç»Ÿä¸€å…¥å£ï¼šä¾¿äºç®¡ç†å’Œç›‘æ§ æ¶æ„æ€è€ƒï¼š åå‘ä»£ç†ä¸ä»…æ˜¯æµé‡åˆ†å‘å™¨ï¼Œæ›´æ˜¯æ¶æ„ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•ã€æµé‡æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚\nNginx åå‘ä»£ç†é…ç½® åŸºç¡€é…ç½® 1# /etc/nginx/nginx.conf 2 3user nginx; 4worker_processes auto; # è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° 5error_log /var/log/nginx/error.log warn; 6pid /var/run/nginx.pid; 7 8events { 9 worker_connections 1024; # æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° 10 use epoll; # Linux ä¸‹ä½¿ç”¨ epoll 11} 12 13http { 14 include /etc/nginx/mime.types; 15 default_type application/octet-stream; 16 17 # æ—¥å¿—æ ¼å¼ 18 log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; \u0026#39; 19 \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#39; 20 \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34; \u0026#39; 21 \u0026#39;$request_time $upstream_response_time\u0026#39;; 22 23 access_log /var/log/nginx/access.log main; 24 25 sendfile on; 26 tcp_nopush on; 27 tcp_nodelay on; 28 keepalive_timeout 65; 29 types_hash_max_size 2048; 30 31 # åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶ 32 include /etc/nginx/conf.d/*.conf; 33} ç®€å•åå‘ä»£ç† 1# /etc/nginx/conf.d/api.conf 2 3server { 4 listen 80; 5 server_name api.example.com; 6 7 location / { 8 # ä»£ç†åˆ°åç«¯æœåŠ¡å™¨ 9 proxy_pass http://192.168.1.100:8080; 10 11 # è®¾ç½®è¯·æ±‚å¤´ 12 proxy_set_header Host $host; 13 proxy_set_header X-Real-IP $remote_addr; 14 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 15 proxy_set_header X-Forwarded-Proto $scheme; 16 17 # è¶…æ—¶è®¾ç½® 18 proxy_connect_timeout 60s; 19 proxy_send_timeout 60s; 20 proxy_read_timeout 60s; 21 } 22} è·¯å¾„é‡å†™ 1server { 2 listen 80; 3 server_name api.example.com; 4 5 # å°† /api/v1/users ä»£ç†åˆ° http://backend/users 6 location /api/v1/ { 7 proxy_pass http://backend/; # æ³¨æ„æœ«å°¾çš„ / 8 proxy_set_header Host $host; 9 } 10 11 # å°† /old-api é‡å†™ä¸º /new-api 12 location /old-api { 13 rewrite ^/old-api/(.*)$ /new-api/$1 break; 14 proxy_pass http://backend; 15 } 16} è´Ÿè½½å‡è¡¡ç­–ç•¥ 1. è½®è¯¢ï¼ˆRound Robinï¼‰ é»˜è®¤ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†é…è¯·æ±‚ï¼š\n1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5} 6 7server { 8 listen 80; 9 server_name api.example.com; 10 11 location / { 12 proxy_pass http://backend; 13 } 14} 2. åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰ æ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…ä¸åŒæƒé‡ï¼š\n1upstream backend { 2 server 192.168.1.101:8080 weight=3; # æƒé‡ 3 3 server 192.168.1.102:8080 weight=2; # æƒé‡ 2 4 server 192.168.1.103:8080 weight=1; # æƒé‡ 1 5} æƒé‡ä¸º 3:2:1ï¼Œæ„å‘³ç€æ¯ 6 ä¸ªè¯·æ±‚ä¸­ï¼Œ101 æœåŠ¡å™¨å¤„ç† 3 ä¸ªï¼Œ102 å¤„ç† 2 ä¸ªï¼Œ103 å¤„ç† 1 ä¸ªã€‚\n3. IP Hash æ ¹æ®å®¢æˆ·ç«¯ IP è¿›è¡Œå“ˆå¸Œï¼ŒåŒä¸€ IP çš„è¯·æ±‚æ€»æ˜¯åˆ†é…åˆ°åŒä¸€å°æœåŠ¡å™¨ï¼š\n1upstream backend { 2 ip_hash; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šéœ€è¦ä¼šè¯ä¿æŒçš„åº”ç”¨ï¼ˆå¦‚è´­ç‰©è½¦ã€ç™»å½•çŠ¶æ€ï¼‰\nç¼ºç‚¹ï¼š\nè´Ÿè½½å¯èƒ½ä¸å‡è¡¡ï¼ˆIP åˆ†å¸ƒä¸å‡ï¼‰ æ— æ³•åº”å¯¹æœåŠ¡å™¨æ•…éšœï¼ˆIP é‡æ–°å“ˆå¸Œï¼‰ 4. æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰ å°†è¯·æ±‚åˆ†é…ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ï¼š\n1upstream backend { 2 least_conn; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šè¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚è¾ƒå¤§çš„åº”ç”¨\n5. ä¸€è‡´æ€§å“ˆå¸Œï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ 1upstream backend { 2 hash $request_uri consistent; 3 4 server 192.168.1.101:8080; 5 server 192.168.1.102:8080; 6 server 192.168.1.103:8080; 7} é€‚ç”¨åœºæ™¯ï¼šç¼“å­˜æœåŠ¡å™¨é›†ç¾¤\nè´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯” ç­–ç•¥ ä¼˜ç‚¹ ç¼ºç‚¹ é€‚ç”¨åœºæ™¯ è½®è¯¢ ç®€å•ã€å‡è¡¡ æ— ä¼šè¯ä¿æŒ æ— çŠ¶æ€æœåŠ¡ åŠ æƒè½®è¯¢ è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½ æ— ä¼šè¯ä¿æŒ æœåŠ¡å™¨æ€§èƒ½ä¸åŒ IP Hash ä¼šè¯ä¿æŒ è´Ÿè½½å¯èƒ½ä¸å‡ æœ‰çŠ¶æ€æœåŠ¡ æœ€å°‘è¿æ¥ åŠ¨æ€å‡è¡¡ è®¡ç®—å¼€é”€å¤§ é•¿è¿æ¥æœåŠ¡ ä¸€è‡´æ€§å“ˆå¸Œ ç¼“å­˜å‘½ä¸­ç‡é«˜ å®ç°å¤æ‚ ç¼“å­˜é›†ç¾¤ å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» è¢«åŠ¨å¥åº·æ£€æŸ¥ Nginx é»˜è®¤çš„å¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œå½“è¯·æ±‚å¤±è´¥æ—¶æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¯ç”¨ï¼š\n1upstream backend { 2 server 192.168.1.101:8080 max_fails=3 fail_timeout=30s; 3 server 192.168.1.102:8080 max_fails=3 fail_timeout=30s; 4 server 192.168.1.103:8080 max_fails=3 fail_timeout=30s; 5} å‚æ•°è¯´æ˜ï¼š\nmax_fails=3ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡åæ ‡è®°ä¸ºä¸å¯ç”¨ fail_timeout=30sï¼šæ ‡è®°ä¸ºä¸å¯ç”¨åï¼Œ30 ç§’å†…ä¸å†åˆ†é…è¯·æ±‚ ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆNginx Plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ ä½¿ç”¨ nginx_upstream_check_module æ¨¡å—ï¼š\n1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5 6 check interval=3000 rise=2 fall=3 timeout=1000 type=http; 7 check_http_send \u0026#34;HEAD /health HTTP/1.0\\r\\n\\r\\n\u0026#34;; 8 check_http_expect_alive http_2xx http_3xx; 9} 10 11server { 12 listen 80; 13 14 location /status { 15 check_status; 16 access_log off; 17 } 18} å‚æ•°è¯´æ˜ï¼š\ninterval=3000ï¼šæ¯ 3 ç§’æ£€æŸ¥ä¸€æ¬¡ rise=2ï¼šè¿ç»­æˆåŠŸ 2 æ¬¡æ ‡è®°ä¸ºå¯ç”¨ fall=3ï¼šè¿ç»­å¤±è´¥ 3 æ¬¡æ ‡è®°ä¸ºä¸å¯ç”¨ timeout=1000ï¼šè¶…æ—¶æ—¶é—´ 1 ç§’ type=httpï¼šä½¿ç”¨ HTTP åè®®æ£€æŸ¥ å¤‡ç”¨æœåŠ¡å™¨ 1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 server 192.168.1.103:8080; 5 server 192.168.1.104:8080 backup; # å¤‡ç”¨æœåŠ¡å™¨ 6} åªæœ‰å½“æ‰€æœ‰ä¸»æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶ï¼Œæ‰ä¼šä½¿ç”¨å¤‡ç”¨æœåŠ¡å™¨ã€‚\næ•…éšœè½¬ç§»é…ç½® 1location / { 2 proxy_pass http://backend; 3 proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504; 4 proxy_next_upstream_tries 2; # æœ€å¤šå°è¯• 2 æ¬¡ 5 proxy_next_upstream_timeout 10s; # æ€»è¶…æ—¶æ—¶é—´ 10 ç§’ 6} ä¼šè¯ä¿æŒæ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šIP Hash 1upstream backend { 2 ip_hash; 3 server 192.168.1.101:8080; 4 server 192.168.1.102:8080; 5} ä¼˜ç‚¹ï¼šé…ç½®ç®€å• ç¼ºç‚¹ï¼šè´Ÿè½½å¯èƒ½ä¸å‡è¡¡\næ–¹æ¡ˆäºŒï¼šCookie ç»‘å®š 1upstream backend { 2 server 192.168.1.101:8080; 3 server 192.168.1.102:8080; 4 5 sticky cookie srv_id expires=1h domain=.example.com path=/; 6} Nginx ä¼šåœ¨å“åº”ä¸­è®¾ç½®ä¸€ä¸ª Cookieï¼Œåç»­è¯·æ±‚æ ¹æ® Cookie è·¯ç”±åˆ°åŒä¸€å°æœåŠ¡å™¨ã€‚\næ–¹æ¡ˆä¸‰ï¼šSession å…±äº«ï¼ˆæ¨èï¼‰ ä¸ä¾èµ– Nginxï¼Œåœ¨åº”ç”¨å±‚å®ç° Session å…±äº«ï¼š\nä½¿ç”¨ Redis å­˜å‚¨ Sessionï¼š\n1@Configuration 2@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800) 3public class SessionConfig { 4 5 @Bean 6 public LettuceConnectionFactory connectionFactory() { 7 return new LettuceConnectionFactory(); 8 } 9} ä½¿ç”¨ JWT Tokenï¼š\n1@RestController 2public class AuthController { 3 4 @PostMapping(\u0026#34;/login\u0026#34;) 5 public Result login(@RequestBody LoginRequest request) { 6 // éªŒè¯ç”¨æˆ·åå¯†ç  7 User user = userService.authenticate(request.getUsername(), request.getPassword()); 8 9 // ç”Ÿæˆ JWT Token 10 String token = JwtUtil.generateToken(user.getId()); 11 12 return Result.success(token); 13 } 14} æ¶æ„æ€è€ƒï¼š ä¼šè¯ä¿æŒçš„æœ€ä½³å®è·µæ˜¯åœ¨åº”ç”¨å±‚å®ç°æ— çŠ¶æ€åŒ–ã€‚é€šè¿‡ Redis å…±äº« Session æˆ–ä½¿ç”¨ JWT Tokenï¼Œå¯ä»¥å®ç°çœŸæ­£çš„æ°´å¹³æ‰©å±•ï¼Œè€Œä¸ä¾èµ–äºè´Ÿè½½å‡è¡¡å™¨çš„ç‰¹å®šåŠŸèƒ½ã€‚\nHTTPS é…ç½® SSL è¯ä¹¦é…ç½® 1server { 2 listen 443 ssl http2; 3 server_name api.example.com; 4 5 # SSL è¯ä¹¦ 6 ssl_certificate /etc/nginx/ssl/api.example.com.crt; 7 ssl_certificate_key /etc/nginx/ssl/api.example.com.key; 8 9 # SSL åè®®å’ŒåŠ å¯†å¥—ä»¶ 10 ssl_protocols TLSv1.2 TLSv1.3; 11 ssl_ciphers \u0026#39;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256\u0026#39;; 12 ssl_prefer_server_ciphers on; 13 14 # SSL ä¼šè¯ç¼“å­˜ 15 ssl_session_cache shared:SSL:10m; 16 ssl_session_timeout 10m; 17 18 # HSTS 19 add_header Strict-Transport-Security \u0026#34;max-age=31536000\u0026#34; always; 20 21 location / { 22 proxy_pass http://backend; 23 proxy_set_header Host $host; 24 proxy_set_header X-Real-IP $remote_addr; 25 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 26 proxy_set_header X-Forwarded-Proto $scheme; 27 } 28} 29 30# HTTP é‡å®šå‘åˆ° HTTPS 31server { 32 listen 80; 33 server_name api.example.com; 34 return 301 https://$server_name$request_uri; 35} å…è´¹ SSL è¯ä¹¦ï¼ˆLet\u0026rsquo;s Encryptï¼‰ 1# å®‰è£… Certbot 2sudo yum install certbot python3-certbot-nginx 3 4# è·å–è¯ä¹¦ 5sudo certbot --nginx -d api.example.com 6 7# è‡ªåŠ¨ç»­æœŸ 8sudo certbot renew --dry-run æ€§èƒ½ä¼˜åŒ– 1. è¿æ¥ä¼˜åŒ– 1http { 2 # é•¿è¿æ¥é…ç½® 3 keepalive_timeout 65; 4 keepalive_requests 100; 5 6 # ä¸Šæ¸¸æœåŠ¡å™¨é•¿è¿æ¥ 7 upstream backend { 8 server 192.168.1.101:8080; 9 server 192.168.1.102:8080; 10 11 keepalive 32; # ä¿æŒ 32 ä¸ªç©ºé—²è¿æ¥ 12 } 13 14 server { 15 location / { 16 proxy_pass http://backend; 17 proxy_http_version 1.1; 18 proxy_set_header Connection \u0026#34;\u0026#34;; 19 } 20 } 21} 2. ç¼“å­˜é…ç½® 1# å®šä¹‰ç¼“å­˜è·¯å¾„ 2proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m; 3 4server { 5 location / { 6 proxy_pass http://backend; 7 8 # å¯ç”¨ç¼“å­˜ 9 proxy_cache my_cache; 10 proxy_cache_valid 200 304 10m; 11 proxy_cache_valid 404 1m; 12 proxy_cache_key $scheme$proxy_host$request_uri; 13 14 # ç¼“å­˜å¤´ä¿¡æ¯ 15 add_header X-Cache-Status $upstream_cache_status; 16 } 17 18 # é™æ€èµ„æºç¼“å­˜ 19 location ~* \\.(jpg|jpeg|png|gif|ico|css|js)$ { 20 proxy_pass http://backend; 21 proxy_cache my_cache; 22 proxy_cache_valid 200 30d; 23 expires 30d; 24 } 25} 3. Gzip å‹ç¼© 1http { 2 gzip on; 3 gzip_vary on; 4 gzip_proxied any; 5 gzip_comp_level 6; 6 gzip_types text/plain text/css text/xml text/javascript 7 application/json application/javascript application/xml+rss 8 application/rss+xml font/truetype font/opentype 9 application/vnd.ms-fontobject image/svg+xml; 10 gzip_disable \u0026#34;msie6\u0026#34;; 11} 4. é™æµé…ç½® 1http { 2 # å®šä¹‰é™æµåŒºåŸŸ 3 limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s; 4 limit_conn_zone $binary_remote_addr zone=conn_limit:10m; 5 6 server { 7 location /api/ { 8 # é™åˆ¶è¯·æ±‚é€Ÿç‡ï¼šæ¯ç§’ 10 ä¸ªè¯·æ±‚ï¼Œçªå‘ 20 ä¸ª 9 limit_req zone=api_limit burst=20 nodelay; 10 11 # é™åˆ¶å¹¶å‘è¿æ¥æ•°ï¼šæ¯ä¸ª IP æœ€å¤š 10 ä¸ªè¿æ¥ 12 limit_conn conn_limit 10; 13 14 proxy_pass http://backend; 15 } 16 } 17} 5. Worker è¿›ç¨‹ä¼˜åŒ– 1# è‡ªåŠ¨è®¾ç½® worker è¿›ç¨‹æ•°ä¸º CPU æ ¸å¿ƒæ•° 2worker_processes auto; 3 4# ç»‘å®š worker è¿›ç¨‹åˆ° CPU æ ¸å¿ƒ 5worker_cpu_affinity auto; 6 7# æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•° 8worker_rlimit_nofile 65535; 9 10events { 11 # æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° 12 worker_connections 10240; 13 14 # ä½¿ç”¨ epoll äº‹ä»¶æ¨¡å‹ 15 use epoll; 16 17 # å°½å¯èƒ½å¤šåœ°æ¥å—è¿æ¥ 18 multi_accept on; 19} ç›‘æ§ä¸æ—¥å¿— è®¿é—®æ—¥å¿—åˆ†æ 1# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ 2log_format detailed \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#39; 3 \u0026#39;\u0026#34;$request\u0026#34; $status $body_bytes_sent \u0026#39; 4 \u0026#39;\u0026#34;$http_referer\u0026#34; \u0026#34;$http_user_agent\u0026#34; \u0026#39; 5 \u0026#39;$request_time $upstream_response_time \u0026#39; 6 \u0026#39;$upstream_addr $upstream_status\u0026#39;; 7 8access_log /var/log/nginx/access.log detailed; ä½¿ç”¨ GoAccess åˆ†ææ—¥å¿— 1# å®‰è£… GoAccess 2sudo yum install goaccess 3 4# å®æ—¶åˆ†ææ—¥å¿— 5goaccess /var/log/nginx/access.log -o /var/www/html/report.html --log-format=COMBINED --real-time-html Nginx çŠ¶æ€ç›‘æ§ 1server { 2 listen 8080; 3 server_name localhost; 4 5 location /nginx_status { 6 stub_status on; 7 access_log off; 8 allow 127.0.0.1; 9 deny all; 10 } 11} è®¿é—® http://localhost:8080/nginx_status æŸ¥çœ‹çŠ¶æ€ï¼š\n1Active connections: 291 2server accepts handled requests 3 16630948 16630948 31070465 4Reading: 6 Writing: 179 Waiting: 106 Prometheus ç›‘æ§ ä½¿ç”¨ nginx-prometheus-exporterï¼š\n1# ä¸‹è½½å¹¶è¿è¡Œ exporter 2docker run -p 9113:9113 nginx/nginx-prometheus-exporter:latest \\ 3 -nginx.scrape-uri=http://nginx:8080/nginx_status ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ 1. é…ç½®æ–‡ä»¶ç»„ç»‡ 1/etc/nginx/ 2â”œâ”€â”€ nginx.conf # ä¸»é…ç½®æ–‡ä»¶ 3â”œâ”€â”€ conf.d/ 4â”‚ â”œâ”€â”€ api.conf # API æœåŠ¡é…ç½® 5â”‚ â”œâ”€â”€ web.conf # Web æœåŠ¡é…ç½® 6â”‚ â””â”€â”€ admin.conf # ç®¡ç†åå°é…ç½® 7â”œâ”€â”€ upstream/ 8â”‚ â”œâ”€â”€ api-backend.conf # API åç«¯æœåŠ¡å™¨åˆ—è¡¨ 9â”‚ â””â”€â”€ web-backend.conf # Web åç«¯æœåŠ¡å™¨åˆ—è¡¨ 10â””â”€â”€ ssl/ 11 â”œâ”€â”€ api.example.com.crt 12 â””â”€â”€ api.example.com.key 2. é…ç½®æ£€æŸ¥ä¸é‡è½½ 1# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³• 2sudo nginx -t 3 4# é‡è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰ 5sudo nginx -s reload 6 7# æŸ¥çœ‹ Nginx ç‰ˆæœ¬å’Œç¼–è¯‘å‚æ•° 8nginx -V 3. å®‰å…¨åŠ å›º 1# éšè— Nginx ç‰ˆæœ¬å· 2server_tokens off; 3 4# é™åˆ¶è¯·æ±‚æ–¹æ³• 5if ($request_method !~ ^(GET|POST|PUT|DELETE|HEAD)$) { 6 return 405; 7} 8 9# é˜²æ­¢ç‚¹å‡»åŠ«æŒ 10add_header X-Frame-Options \u0026#34;SAMEORIGIN\u0026#34; always; 11 12# XSS é˜²æŠ¤ 13add_header X-XSS-Protection \u0026#34;1; mode=block\u0026#34; always; 14 15# å†…å®¹ç±»å‹å—…æ¢é˜²æŠ¤ 16add_header X-Content-Type-Options \u0026#34;nosniff\u0026#34; always; 17 18# CSP ç­–ç•¥ 19add_header Content-Security-Policy \u0026#34;default-src \u0026#39;self\u0026#39;\u0026#34; always; 4. æ—¥å¿—è½®è½¬ 1# /etc/logrotate.d/nginx 2 3/var/log/nginx/*.log { 4 daily 5 missingok 6 rotate 14 7 compress 8 delaycompress 9 notifempty 10 create 0640 nginx adm 11 sharedscripts 12 postrotate 13 [ -f /var/run/nginx.pid ] \u0026amp;\u0026amp; kill -USR1 `cat /var/run/nginx.pid` 14 endscript 15} é¿å‘æç¤ºï¼š ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒåŠ¡å¿…åšå¥½ä»¥ä¸‹å‡ ç‚¹ï¼š1) å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶ï¼›2) ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®ï¼›3) é…ç½®å˜æ›´å‰å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼›4) è®¾ç½®ç›‘æ§å‘Šè­¦ï¼›5) å‡†å¤‡å›æ»šæ–¹æ¡ˆã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº† Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§å®è·µï¼š\nåå‘ä»£ç†ï¼šç†è§£åŸç†ï¼ŒæŒæ¡åŸºç¡€é…ç½®å’Œè·¯å¾„é‡å†™ è´Ÿè½½å‡è¡¡ï¼šæŒæ¡å¤šç§ç­–ç•¥ï¼Œæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ å¥åº·æ£€æŸ¥ï¼šå®ç°æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨è½¬ç§» ä¼šè¯ä¿æŒï¼šäº†è§£å¤šç§æ–¹æ¡ˆï¼Œæ¨èåº”ç”¨å±‚æ— çŠ¶æ€åŒ– HTTPS é…ç½®ï¼šSSL è¯ä¹¦é…ç½®å’Œå®‰å…¨åŠ å›º æ€§èƒ½ä¼˜åŒ–ï¼šè¿æ¥ä¼˜åŒ–ã€ç¼“å­˜ã€å‹ç¼©ã€é™æµç­‰ ç›‘æ§æ—¥å¿—ï¼šæ—¥å¿—åˆ†æå’ŒçŠ¶æ€ç›‘æ§ åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒNginx çš„ä½œç”¨è¿œä¸æ­¢äºæ­¤ã€‚é€šè¿‡åˆç†é…ç½®ï¼Œè¿˜å¯ä»¥å®ç°ï¼š\nç°åº¦å‘å¸ƒï¼šæ ¹æ®æ¡ä»¶å°†éƒ¨åˆ†æµé‡å¯¼å‘æ–°ç‰ˆæœ¬ A/B æµ‹è¯•ï¼šå°†ä¸åŒç”¨æˆ·å¯¼å‘ä¸åŒç‰ˆæœ¬ æµé‡æ§åˆ¶ï¼šé™æµã€ç†”æ–­ã€é™çº§ å®‰å…¨é˜²æŠ¤ï¼šWAFã€DDoS é˜²æŠ¤ ä¸‹æ¬¡å½“ä½ éœ€è¦æ­å»ºé«˜å¯ç”¨æœåŠ¡æ¶æ„æ—¶ï¼ŒNginx å°†æ˜¯ä½ çš„å¾—åŠ›åŠ©æ‰‹ã€‚\n","permalink":"http://localhost:1313/posts/2025/06/nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E6%88%98%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%94%9F%E4%BA%A7%E4%BC%98%E5%8C%96/","summary":"\u003cp\u003eNginx ä½œä¸ºé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå·²ç»æˆä¸ºäº’è”ç½‘æ¶æ„ä¸­çš„æ ‡é…ç»„ä»¶ã€‚æ— è®ºæ˜¯é™æ€èµ„æºæœåŠ¡ã€åå‘ä»£ç†è¿˜æ˜¯è´Ÿè½½å‡è¡¡ï¼ŒNginx éƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…åœºæ™¯å‡ºå‘ï¼Œæ·±å…¥è®²è§£ Nginx åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„é…ç½®ä¸ä¼˜åŒ–ï¼Œå¸®åŠ©ä½ æ„å»ºé«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åå‘ä»£ç†ä¸æ­£å‘ä»£ç†çš„åŒºåˆ«\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Nginx è´Ÿè½½å‡è¡¡çš„å¤šç§ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé…ç½®å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ä¼šè¯ä¿æŒçš„å®ç°æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åå‘ä»£ç†åŸºç¡€\"\u003eåå‘ä»£ç†åŸºç¡€\u003c/h2\u003e\n\u003ch3 id=\"æ­£å‘ä»£ç†-vs-åå‘ä»£ç†\"\u003eæ­£å‘ä»£ç† vs åå‘ä»£ç†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæ­£å‘ä»£ç†\u003c/strong\u003eï¼šå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eï¼ˆå®¢æˆ·ç«¯é…ç½®ä»£ç†ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåå‘ä»£ç†\u003c/strong\u003eï¼šå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å†³å®šè½¬å‘åˆ°å“ªå°æœåŠ¡å™¨\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨é›†ç¾¤\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eï¼ˆæœåŠ¡ç«¯é…ç½®ä»£ç†ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"åå‘ä»£ç†çš„ä¼˜åŠ¿\"\u003eåå‘ä»£ç†çš„ä¼˜åŠ¿\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eè´Ÿè½½å‡è¡¡\u003c/strong\u003eï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eéšè—çœŸå®æœåŠ¡å™¨\u003c/strong\u003eï¼šæé«˜å®‰å…¨æ€§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSSL å¸è½½\u003c/strong\u003eï¼šåœ¨ä»£ç†å±‚å¤„ç† HTTPS\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç¼“å­˜é™æ€èµ„æº\u003c/strong\u003eï¼šå‡è½»åç«¯å‹åŠ›\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç»Ÿä¸€å…¥å£\u003c/strong\u003eï¼šä¾¿äºç®¡ç†å’Œç›‘æ§\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e åå‘ä»£ç†ä¸ä»…æ˜¯æµé‡åˆ†å‘å™¨ï¼Œæ›´æ˜¯æ¶æ„ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•ã€æµé‡æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"nginx-åå‘ä»£ç†é…ç½®\"\u003eNginx åå‘ä»£ç†é…ç½®\u003c/h2\u003e\n\u003ch3 id=\"åŸºç¡€é…ç½®\"\u003eåŸºç¡€é…ç½®\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /etc/nginx/nginx.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euser\u003c/span\u003e \u003cspan class=\"s\"\u003enginx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eworker_processes\u003c/span\u003e \u003cspan class=\"s\"\u003eauto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eerror_log\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/nginx/error.log\u003c/span\u003e \u003cspan class=\"s\"\u003ewarn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003epid\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/nginx.pid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eevents\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eworker_connections\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003euse\u003c/span\u003e \u003cspan class=\"s\"\u003eepoll\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# Linux ä¸‹ä½¿ç”¨ epoll\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ehttp\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003einclude\u003c/span\u003e \u003cspan class=\"s\"\u003e/etc/nginx/mime.types\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003edefault_type\u003c/span\u003e \u003cspan class=\"s\"\u003eapplication/octet-stream\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# æ—¥å¿—æ ¼å¼\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elog_format\u003c/span\u003e \u003cspan class=\"s\"\u003emain\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e \u003cspan class=\"s\"\u003e-\u003c/span\u003e \u003cspan class=\"nv\"\u003e$remote_user\u003c/span\u003e \u003cspan class=\"s\"\u003e[\u003c/span\u003e\u003cspan class=\"nv\"\u003e$time_local]\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$request\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$status\u003c/span\u003e \u003cspan class=\"nv\"\u003e$body_bytes_sent\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_referer\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_user_agent\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$http_x_forwarded_for\u0026#34;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"s\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$request_time\u003c/span\u003e \u003cspan class=\"nv\"\u003e$upstream_response_time\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eaccess_log\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/nginx/access.log\u003c/span\u003e \u003cspan class=\"s\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003esendfile\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etcp_nopush\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etcp_nodelay\u003c/span\u003e \u003cspan class=\"no\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003ekeepalive_timeout\u003c/span\u003e \u003cspan class=\"mi\"\u003e65\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003etypes_hash_max_size\u003c/span\u003e \u003cspan class=\"mi\"\u003e2048\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003einclude\u003c/span\u003e \u003cspan class=\"s\"\u003e/etc/nginx/conf.d/*.conf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ç®€å•åå‘ä»£ç†\"\u003eç®€å•åå‘ä»£ç†\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /etc/nginx/conf.d/api.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eserver\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elisten\u003c/span\u003e \u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eserver_name\u003c/span\u003e \u003cspan class=\"s\"\u003eapi.example.com\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# ä»£ç†åˆ°åç«¯æœåŠ¡å™¨\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://192.168.1.100:8080\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# è®¾ç½®è¯·æ±‚å¤´\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eHost\u003c/span\u003e \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Real-IP\u003c/span\u003e \u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Forwarded-For\u003c/span\u003e \u003cspan class=\"nv\"\u003e$proxy_add_x_forwarded_for\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eX-Forwarded-Proto\u003c/span\u003e \u003cspan class=\"nv\"\u003e$scheme\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# è¶…æ—¶è®¾ç½®\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_connect_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_send_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_read_timeout\u003c/span\u003e \u003cspan class=\"s\"\u003e60s\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"è·¯å¾„é‡å†™\"\u003eè·¯å¾„é‡å†™\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eserver\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elisten\u003c/span\u003e \u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003eserver_name\u003c/span\u003e \u003cspan class=\"s\"\u003eapi.example.com\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# å°† /api/v1/users ä»£ç†åˆ° http://backend/users\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/api/v1/\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://backend/\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# æ³¨æ„æœ«å°¾çš„ /\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_set_header\u003c/span\u003e \u003cspan class=\"s\"\u003eHost\u003c/span\u003e \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# å°† /old-api é‡å†™ä¸º /new-api\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/old-api\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003erewrite\u003c/span\u003e \u003cspan class=\"s\"\u003e^/old-api/(.*)\u003c/span\u003e$ \u003cspan class=\"s\"\u003e/new-api/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e \u003cspan class=\"s\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kn\"\u003eproxy_pass\u003c/span\u003e \u003cspan class=\"s\"\u003ehttp://backend\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"è´Ÿè½½å‡è¡¡ç­–ç•¥\"\u003eè´Ÿè½½å‡è¡¡ç­–ç•¥\u003c/h2\u003e\n\u003ch3 id=\"1-è½®è¯¢round-robin\"\u003e1. è½®è¯¢ï¼ˆRound Robinï¼‰\u003c/h3\u003e\n\u003cp\u003eé»˜è®¤ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†é…è¯·æ±‚ï¼š\u003c/p\u003e","title":"Nginx åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å®æˆ˜ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§ä¼˜åŒ–"},{"content":"åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¤§æ•°æ®é‡å¯¼å‡ºæ˜¯ä¸€ä¸ªå¸¸è§ä½†æ£˜æ‰‹çš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„ Apache POI åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºï¼Œè€Œé˜¿é‡Œå¼€æºçš„ EasyExcel é€šè¿‡ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œå¯ä»¥è½»æ¾å¤„ç†ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€‚\næœ¬æ–‡å°†ä»å®é™…é—®é¢˜å‡ºå‘ï¼Œæ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°é«˜æ€§èƒ½çš„å¤§æ•°æ®é‡å¯¼å‡ºï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¼˜åŒ–ç»éªŒã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜ æŒæ¡ EasyExcel çš„æ ¸å¿ƒåŸç† å­¦ä¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„æœ€ä½³å®è·µ äº†è§£å¼‚æ­¥å¯¼å‡ºä¸è¿›åº¦åé¦ˆæ–¹æ¡ˆ æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§ ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜ é—®é¢˜åœºæ™¯ æŸç”µå•†ç³»ç»Ÿéœ€è¦å¯¼å‡ºè®¢å•æ•°æ®ï¼Œæ•°æ®é‡è¾¾åˆ° 100 ä¸‡æ¡ã€‚ä½¿ç”¨ä¼ ç»Ÿçš„ Apache POI å®ç°ï¼š\n1// ä¼ ç»Ÿ POI å®ç°ï¼ˆæœ‰é—®é¢˜çš„ä»£ç ï¼‰ 2public void exportOrders() { 3 Workbook workbook = new XSSFWorkbook(); 4 Sheet sheet = workbook.createSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;); 5 6 // æŸ¥è¯¢ 100 ä¸‡æ¡æ•°æ® 7 List\u0026lt;Order\u0026gt; orders = orderMapper.selectAll(); 8 9 // å†™å…¥ Excel 10 for (int i = 0; i \u0026lt; orders.size(); i++) { 11 Row row = sheet.createRow(i); 12 Order order = orders.get(i); 13 row.createCell(0).setCellValue(order.getOrderNo()); 14 row.createCell(1).setCellValue(order.getUserName()); 15 // ... æ›´å¤šå­—æ®µ 16 } 17 18 // è¾“å‡ºæ–‡ä»¶ 19 FileOutputStream fos = new FileOutputStream(\u0026#34;orders.xlsx\u0026#34;); 20 workbook.write(fos); 21 fos.close(); 22} å†…å­˜åˆ†æ è¿™æ®µä»£ç å­˜åœ¨ä¸¥é‡çš„å†…å­˜é—®é¢˜ï¼š\nä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®ï¼š100 ä¸‡æ¡æ•°æ®å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ POI å¯¹è±¡å ç”¨å¤§ï¼šæ¯ä¸ª Cellã€Rowã€Sheet éƒ½æ˜¯ Java å¯¹è±¡ å†…å­˜æ— æ³•é‡Šæ”¾ï¼šæ•°æ®å†™å…¥å‰å¿…é¡»å…¨éƒ¨ä¿å­˜åœ¨å†…å­˜ä¸­ å†…å­˜å ç”¨ä¼°ç®—ï¼š\næ¯æ¡è®¢å•æ•°æ®ï¼šçº¦ 1KB 100 ä¸‡æ¡æ•°æ®ï¼šçº¦ 1GB POI å¯¹è±¡å¼€é”€ï¼šçº¦ 3-5 å€ æ€»å†…å­˜å ç”¨ï¼š3-5GB æ¶æ„æ€è€ƒï¼š ä¼ ç»Ÿ POI é‡‡ç”¨ DOM æ¨¡å¼ï¼Œéœ€è¦åœ¨å†…å­˜ä¸­æ„å»ºå®Œæ•´çš„æ–‡æ¡£å¯¹è±¡æ¨¡å‹ã€‚è¿™ç§æ–¹å¼è™½ç„¶çµæ´»ï¼Œä½†åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚EasyExcel é‡‡ç”¨ SAX æ¨¡å¼ï¼Œè¾¹è¯»è¾¹å†™ï¼Œå¤§å¤§é™ä½äº†å†…å­˜å ç”¨ã€‚\nEasyExcel æ ¸å¿ƒåŸç† å†…å­˜ä¼˜åŒ–ç­–ç•¥ EasyExcel é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¼˜åŒ–å†…å­˜ï¼š\næµå¼å†™å…¥ï¼šä¸åœ¨å†…å­˜ä¸­ä¿å­˜å®Œæ•´çš„ Excel å¯¹è±¡ åˆ†æ‰¹å¤„ç†ï¼šæ”¯æŒåˆ†æ‰¹æŸ¥è¯¢å’Œå†™å…¥ ä¸´æ—¶æ–‡ä»¶ï¼šä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ç¼“å­˜æ•°æ® å¯¹è±¡å¤ç”¨ï¼šå¤ç”¨ Java å¯¹è±¡ï¼Œå‡å°‘ GC å‹åŠ› å†…å­˜å ç”¨å¯¹æ¯” æ–¹æ¡ˆ 10ä¸‡æ¡ 50ä¸‡æ¡ 100ä¸‡æ¡ Apache POI 300MB 1.5GB OOM EasyExcel 20MB 50MB 100MB EasyExcel åŸºç¡€ä½¿ç”¨ é¡¹ç›®ä¾èµ– 1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;easyexcel\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;3.3.2\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; å®šä¹‰æ•°æ®æ¨¡å‹ 1@Data 2public class OrderExportDTO { 3 4 @ExcelProperty(value = \u0026#34;è®¢å•å·\u0026#34;, index = 0) 5 private String orderNo; 6 7 @ExcelProperty(value = \u0026#34;ç”¨æˆ·å\u0026#34;, index = 1) 8 private String userName; 9 10 @ExcelProperty(value = \u0026#34;å•†å“åç§°\u0026#34;, index = 2) 11 private String productName; 12 13 @ExcelProperty(value = \u0026#34;è®¢å•é‡‘é¢\u0026#34;, index = 3) 14 @NumberFormat(\u0026#34;#.##\u0026#34;) 15 private BigDecimal amount; 16 17 @ExcelProperty(value = \u0026#34;è®¢å•çŠ¶æ€\u0026#34;, index = 4) 18 @ExcelProperty(converter = OrderStatusConverter.class) 19 private Integer status; 20 21 @ExcelProperty(value = \u0026#34;åˆ›å»ºæ—¶é—´\u0026#34;, index = 5) 22 @DateTimeFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;) 23 private Date createTime; 24} ç®€å•å¯¼å‡ºç¤ºä¾‹ 1@Service 2public class OrderExportService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 /** 8 * ç®€å•å¯¼å‡ºï¼ˆé€‚ç”¨äºå°æ•°æ®é‡ï¼‰ 9 */ 10 public void simpleExport(HttpServletResponse response) throws IOException { 11 // æŸ¥è¯¢æ•°æ® 12 List\u0026lt;OrderExportDTO\u0026gt; data = orderMapper.selectForExport(); 13 14 // è®¾ç½®å“åº”å¤´ 15 response.setContentType(\u0026#34;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\u0026#34;); 16 response.setCharacterEncoding(\u0026#34;utf-8\u0026#34;); 17 String fileName = URLEncoder.encode(\u0026#34;è®¢å•æ•°æ®\u0026#34;, \u0026#34;UTF-8\u0026#34;); 18 response.setHeader(\u0026#34;Content-disposition\u0026#34;, \u0026#34;attachment;filename=\u0026#34; + fileName + \u0026#34;.xlsx\u0026#34;); 19 20 // å†™å…¥ Excel 21 EasyExcel.write(response.getOutputStream(), OrderExportDTO.class) 22 .sheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;) 23 .doWrite(data); 24 } 25} ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºæ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šåˆ†é¡µæŸ¥è¯¢ + æµå¼å†™å…¥ 1@Service 2@Slf4j 3public class LargeDataExportService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 private static final int PAGE_SIZE = 10000; // æ¯é¡µ 1 ä¸‡æ¡ 9 10 /** 11 * åˆ†é¡µå¯¼å‡ºå¤§æ•°æ®é‡ 12 */ 13 public void exportLargeData(HttpServletResponse response) throws IOException { 14 // è®¾ç½®å“åº”å¤´ 15 setResponseHeader(response, \u0026#34;è®¢å•æ•°æ®\u0026#34;); 16 17 // ä½¿ç”¨ EasyExcel çš„æµå¼å†™å…¥ 18 ExcelWriter excelWriter = null; 19 try { 20 excelWriter = EasyExcel.write(response.getOutputStream(), OrderExportDTO.class).build(); 21 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 22 23 // åˆ†é¡µæŸ¥è¯¢å¹¶å†™å…¥ 24 int pageNum = 1; 25 while (true) { 26 log.info(\u0026#34;å¼€å§‹å¯¼å‡ºç¬¬ {} é¡µæ•°æ®\u0026#34;, pageNum); 27 28 // åˆ†é¡µæŸ¥è¯¢ 29 PageHelper.startPage(pageNum, PAGE_SIZE); 30 List\u0026lt;OrderExportDTO\u0026gt; data = orderMapper.selectForExport(); 31 32 if (CollectionUtils.isEmpty(data)) { 33 break; 34 } 35 36 // å†™å…¥å½“å‰é¡µæ•°æ® 37 excelWriter.write(data, writeSheet); 38 39 log.info(\u0026#34;ç¬¬ {} é¡µæ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} æ¡\u0026#34;, pageNum, data.size()); 40 41 // å¦‚æœå½“å‰é¡µæ•°æ®ä¸è¶³ä¸€é¡µï¼Œè¯´æ˜å·²ç»æ˜¯æœ€åä¸€é¡µ 42 if (data.size() \u0026lt; PAGE_SIZE) { 43 break; 44 } 45 46 pageNum++; 47 } 48 49 log.info(\u0026#34;æ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} é¡µ\u0026#34;, pageNum); 50 } finally { 51 if (excelWriter != null) { 52 excelWriter.finish(); 53 } 54 } 55 } 56 57 private void setResponseHeader(HttpServletResponse response, String fileName) throws UnsupportedEncodingException { 58 response.setContentType(\u0026#34;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\u0026#34;); 59 response.setCharacterEncoding(\u0026#34;utf-8\u0026#34;); 60 String encodedFileName = URLEncoder.encode(fileName, \u0026#34;UTF-8\u0026#34;); 61 response.setHeader(\u0026#34;Content-disposition\u0026#34;, \u0026#34;attachment;filename=\u0026#34; + encodedFileName + \u0026#34;.xlsx\u0026#34;); 62 } 63} æ–¹æ¡ˆäºŒï¼šæ¸¸æ ‡æŸ¥è¯¢ + æµå¼å†™å…¥ å¯¹äº MyBatisï¼Œå¯ä»¥ä½¿ç”¨æ¸¸æ ‡ï¼ˆCursorï¼‰è¿›ä¸€æ­¥ä¼˜åŒ–å†…å­˜ï¼š\n1/** 2 * Mapper æ¥å£ 3 */ 4public interface OrderMapper { 5 /** 6 * ä½¿ç”¨æ¸¸æ ‡æŸ¥è¯¢ï¼ˆæµå¼æŸ¥è¯¢ï¼‰ 7 */ 8 @Options(resultSetType = ResultSetType.FORWARD_ONLY, fetchSize = 1000) 9 @Select(\u0026#34;SELECT * FROM t_order WHERE status = #{status}\u0026#34;) 10 Cursor\u0026lt;OrderExportDTO\u0026gt; selectByCursor(@Param(\u0026#34;status\u0026#34;) Integer status); 11} 12 13/** 14 * ä½¿ç”¨æ¸¸æ ‡å¯¼å‡º 15 */ 16public void exportWithCursor(HttpServletResponse response) throws IOException { 17 setResponseHeader(response, \u0026#34;è®¢å•æ•°æ®\u0026#34;); 18 19 ExcelWriter excelWriter = null; 20 Cursor\u0026lt;OrderExportDTO\u0026gt; cursor = null; 21 22 try { 23 excelWriter = EasyExcel.write(response.getOutputStream(), OrderExportDTO.class).build(); 24 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 25 26 // æ‰“å¼€æ¸¸æ ‡ 27 cursor = orderMapper.selectByCursor(1); 28 29 List\u0026lt;OrderExportDTO\u0026gt; batch = new ArrayList\u0026lt;\u0026gt;(PAGE_SIZE); 30 int count = 0; 31 32 // éå†æ¸¸æ ‡ 33 for (OrderExportDTO order : cursor) { 34 batch.add(order); 35 count++; 36 37 // æ¯ 1 ä¸‡æ¡å†™å…¥ä¸€æ¬¡ 38 if (batch.size() \u0026gt;= PAGE_SIZE) { 39 excelWriter.write(batch, writeSheet); 40 log.info(\u0026#34;å·²å¯¼å‡º {} æ¡æ•°æ®\u0026#34;, count); 41 batch.clear(); 42 } 43 } 44 45 // å†™å…¥å‰©ä½™æ•°æ® 46 if (!batch.isEmpty()) { 47 excelWriter.write(batch, writeSheet); 48 log.info(\u0026#34;æ•°æ®å¯¼å‡ºå®Œæˆï¼Œå…± {} æ¡\u0026#34;, count); 49 } 50 51 } finally { 52 if (cursor != null) { 53 cursor.close(); 54 } 55 if (excelWriter != null) { 56 excelWriter.finish(); 57 } 58 } 59} é¿å‘æç¤ºï¼š ä½¿ç”¨æ¸¸æ ‡æŸ¥è¯¢æ—¶ï¼Œéœ€è¦æ³¨æ„ï¼š1) å¿…é¡»åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆï¼›2) ä¸èƒ½ä½¿ç”¨åˆ†é¡µæ’ä»¶ï¼›3) éœ€è¦è®¾ç½® fetchSize æ§åˆ¶æ¯æ¬¡ä»æ•°æ®åº“è·å–çš„è®°å½•æ•°ã€‚\nå¼‚æ­¥å¯¼å‡ºæ–¹æ¡ˆ å¯¹äºè¶…å¤§æ•°æ®é‡ï¼ˆç™¾ä¸‡çº§ä»¥ä¸Šï¼‰ï¼ŒåŒæ­¥å¯¼å‡ºä¼šå¯¼è‡´è¯·æ±‚è¶…æ—¶ã€‚æ¨èä½¿ç”¨å¼‚æ­¥å¯¼å‡ºæ–¹æ¡ˆï¼š\næ•´ä½“æ¶æ„ 1ç”¨æˆ·å‘èµ·å¯¼å‡ºè¯·æ±‚ 2 â†“ 3åˆ›å»ºå¯¼å‡ºä»»åŠ¡ï¼ˆè¿”å›ä»»åŠ¡IDï¼‰ 4 â†“ 5å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå¯¼å‡º 6 â†“ 7å¯¼å‡ºå®Œæˆåä¸Šä¼ åˆ° OSS 8 â†“ 9é€šçŸ¥ç”¨æˆ·ä¸‹è½½ å¯¼å‡ºä»»åŠ¡è¡¨ 1CREATE TABLE export_task ( 2 id BIGINT PRIMARY KEY AUTO_INCREMENT, 3 task_id VARCHAR(64) NOT NULL COMMENT \u0026#39;ä»»åŠ¡ID\u0026#39;, 4 file_name VARCHAR(255) NOT NULL COMMENT \u0026#39;æ–‡ä»¶å\u0026#39;, 5 status TINYINT NOT NULL COMMENT \u0026#39;çŠ¶æ€ï¼š0-å¾…å¤„ç†ï¼Œ1-å¤„ç†ä¸­ï¼Œ2-æˆåŠŸï¼Œ3-å¤±è´¥\u0026#39;, 6 total_count INT COMMENT \u0026#39;æ€»è®°å½•æ•°\u0026#39;, 7 exported_count INT COMMENT \u0026#39;å·²å¯¼å‡ºè®°å½•æ•°\u0026#39;, 8 file_url VARCHAR(512) COMMENT \u0026#39;æ–‡ä»¶ä¸‹è½½åœ°å€\u0026#39;, 9 error_msg VARCHAR(1000) COMMENT \u0026#39;é”™è¯¯ä¿¡æ¯\u0026#39;, 10 create_by VARCHAR(64) COMMENT \u0026#39;åˆ›å»ºäºº\u0026#39;, 11 create_time DATETIME NOT NULL, 12 update_time DATETIME NOT NULL, 13 INDEX idx_task_id (task_id), 14 INDEX idx_create_by (create_by) 15) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;å¯¼å‡ºä»»åŠ¡è¡¨\u0026#39;; å¼‚æ­¥å¯¼å‡ºå®ç° 1@Service 2@Slf4j 3public class AsyncExportService { 4 5 @Autowired 6 private OrderMapper orderMapper; 7 8 @Autowired 9 private ExportTaskMapper exportTaskMapper; 10 11 @Autowired 12 private OssService ossService; 13 14 @Autowired 15 private ThreadPoolExecutor exportExecutor; 16 17 /** 18 * åˆ›å»ºå¯¼å‡ºä»»åŠ¡ 19 */ 20 public String createExportTask(String userId) { 21 // ç”Ÿæˆä»»åŠ¡ ID 22 String taskId = UUID.randomUUID().toString().replace(\u0026#34;-\u0026#34;, \u0026#34;\u0026#34;); 23 24 // åˆ›å»ºä»»åŠ¡è®°å½• 25 ExportTask task = new ExportTask(); 26 task.setTaskId(taskId); 27 task.setFileName(\u0026#34;è®¢å•æ•°æ®_\u0026#34; + DateUtil.format(new Date(), \u0026#34;yyyyMMddHHmmss\u0026#34;) + \u0026#34;.xlsx\u0026#34;); 28 task.setStatus(0); // å¾…å¤„ç† 29 task.setCreateBy(userId); 30 task.setCreateTime(new Date()); 31 task.setUpdateTime(new Date()); 32 exportTaskMapper.insert(task); 33 34 // æäº¤å¼‚æ­¥ä»»åŠ¡ 35 exportExecutor.execute(() -\u0026gt; executeExport(taskId)); 36 37 return taskId; 38 } 39 40 /** 41 * æ‰§è¡Œå¯¼å‡º 42 */ 43 private void executeExport(String taskId) { 44 ExportTask task = exportTaskMapper.selectByTaskId(taskId); 45 46 try { 47 // æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­ 48 task.setStatus(1); 49 exportTaskMapper.updateById(task); 50 51 // åˆ›å»ºä¸´æ—¶æ–‡ä»¶ 52 String tempFilePath = \u0026#34;/tmp/\u0026#34; + task.getFileName(); 53 File tempFile = new File(tempFilePath); 54 55 // å¯¼å‡ºæ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶ 56 exportToFile(tempFile, task); 57 58 // ä¸Šä¼ åˆ° OSS 59 String fileUrl = ossService.upload(tempFile, \u0026#34;export/\u0026#34; + task.getFileName()); 60 61 // æ›´æ–°ä»»åŠ¡çŠ¶æ€ 62 task.setStatus(2); // æˆåŠŸ 63 task.setFileUrl(fileUrl); 64 task.setUpdateTime(new Date()); 65 exportTaskMapper.updateById(task); 66 67 // åˆ é™¤ä¸´æ—¶æ–‡ä»¶ 68 tempFile.delete(); 69 70 // å‘é€é€šçŸ¥ï¼ˆé‚®ä»¶ã€ç«™å†…ä¿¡ç­‰ï¼‰ 71 sendNotification(task); 72 73 log.info(\u0026#34;å¯¼å‡ºä»»åŠ¡ {} å®Œæˆ\u0026#34;, taskId); 74 75 } catch (Exception e) { 76 log.error(\u0026#34;å¯¼å‡ºä»»åŠ¡ {} å¤±è´¥\u0026#34;, taskId, e); 77 78 // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥ 79 task.setStatus(3); 80 task.setErrorMsg(e.getMessage()); 81 task.setUpdateTime(new Date()); 82 exportTaskMapper.updateById(task); 83 } 84 } 85 86 /** 87 * å¯¼å‡ºæ•°æ®åˆ°æ–‡ä»¶ 88 */ 89 private void exportToFile(File file, ExportTask task) throws IOException { 90 ExcelWriter excelWriter = null; 91 Cursor\u0026lt;OrderExportDTO\u0026gt; cursor = null; 92 93 try { 94 excelWriter = EasyExcel.write(file, OrderExportDTO.class).build(); 95 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;).build(); 96 97 cursor = orderMapper.selectByCursor(1); 98 99 List\u0026lt;OrderExportDTO\u0026gt; batch = new ArrayList\u0026lt;\u0026gt;(10000); 100 int totalCount = 0; 101 int exportedCount = 0; 102 103 for (OrderExportDTO order : cursor) { 104 batch.add(order); 105 totalCount++; 106 107 if (batch.size() \u0026gt;= 10000) { 108 excelWriter.write(batch, writeSheet); 109 exportedCount += batch.size(); 110 batch.clear(); 111 112 // æ›´æ–°è¿›åº¦ 113 task.setTotalCount(totalCount); 114 task.setExportedCount(exportedCount); 115 task.setUpdateTime(new Date()); 116 exportTaskMapper.updateById(task); 117 118 log.info(\u0026#34;ä»»åŠ¡ {} å·²å¯¼å‡º {} æ¡æ•°æ®\u0026#34;, task.getTaskId(), exportedCount); 119 } 120 } 121 122 // å†™å…¥å‰©ä½™æ•°æ® 123 if (!batch.isEmpty()) { 124 excelWriter.write(batch, writeSheet); 125 exportedCount += batch.size(); 126 } 127 128 // æ›´æ–°æœ€ç»ˆè®¡æ•° 129 task.setTotalCount(totalCount); 130 task.setExportedCount(exportedCount); 131 task.setUpdateTime(new Date()); 132 exportTaskMapper.updateById(task); 133 134 } finally { 135 if (cursor != null) { 136 cursor.close(); 137 } 138 if (excelWriter != null) { 139 excelWriter.finish(); 140 } 141 } 142 } 143 144 /** 145 * æŸ¥è¯¢ä»»åŠ¡è¿›åº¦ 146 */ 147 public ExportTask queryProgress(String taskId) { 148 return exportTaskMapper.selectByTaskId(taskId); 149 } 150 151 /** 152 * å‘é€é€šçŸ¥ 153 */ 154 private void sendNotification(ExportTask task) { 155 // å‘é€é‚®ä»¶ã€ç«™å†…ä¿¡ç­‰ 156 log.info(\u0026#34;å‘é€å¯¼å‡ºå®Œæˆé€šçŸ¥ç»™ç”¨æˆ· {}\u0026#34;, task.getCreateBy()); 157 } 158} å‰ç«¯è½®è¯¢è¿›åº¦ 1// åˆ›å»ºå¯¼å‡ºä»»åŠ¡ 2async function createExportTask() { 3 const response = await fetch(\u0026#39;/api/export/create\u0026#39;, { 4 method: \u0026#39;POST\u0026#39; 5 }); 6 const data = await response.json(); 7 const taskId = data.taskId; 8 9 // å¼€å§‹è½®è¯¢è¿›åº¦ 10 pollProgress(taskId); 11} 12 13// è½®è¯¢è¿›åº¦ 14function pollProgress(taskId) { 15 const timer = setInterval(async () =\u0026gt; { 16 const response = await fetch(`/api/export/progress/${taskId}`); 17 const task = await response.json(); 18 19 // æ›´æ–°è¿›åº¦æ¡ 20 const progress = task.totalCount \u0026gt; 0 21 ? (task.exportedCount / task.totalCount * 100).toFixed(2) 22 : 0; 23 updateProgressBar(progress); 24 25 // æ£€æŸ¥çŠ¶æ€ 26 if (task.status === 2) { 27 // å¯¼å‡ºæˆåŠŸ 28 clearInterval(timer); 29 showDownloadLink(task.fileUrl); 30 } else if (task.status === 3) { 31 // å¯¼å‡ºå¤±è´¥ 32 clearInterval(timer); 33 showError(task.errorMsg); 34 } 35 }, 2000); // æ¯ 2 ç§’è½®è¯¢ä¸€æ¬¡ 36} æ€§èƒ½ä¼˜åŒ–æŠ€å·§ 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– 1/** 2 * åªæŸ¥è¯¢éœ€è¦å¯¼å‡ºçš„å­—æ®µ 3 */ 4@Select(\u0026#34;SELECT order_no, user_name, product_name, amount, status, create_time \u0026#34; + 5 \u0026#34;FROM t_order WHERE status = #{status}\u0026#34;) 6List\u0026lt;OrderExportDTO\u0026gt; selectForExport(@Param(\u0026#34;status\u0026#34;) Integer status); 7 8/** 9 * æ·»åŠ ç´¢å¼• 10 */ 11CREATE INDEX idx_status_create_time ON t_order(status, create_time); 2. çº¿ç¨‹æ± é…ç½® 1@Configuration 2public class ThreadPoolConfig { 3 4 @Bean(\u0026#34;exportExecutor\u0026#34;) 5 public ThreadPoolExecutor exportExecutor() { 6 return new ThreadPoolExecutor( 7 2, // æ ¸å¿ƒçº¿ç¨‹æ•° 8 5, // æœ€å¤§çº¿ç¨‹æ•° 9 60L, TimeUnit.SECONDS, 10 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 11 new ThreadFactoryBuilder() 12 .setNameFormat(\u0026#34;export-thread-%d\u0026#34;) 13 .build(), 14 new ThreadPoolExecutor.CallerRunsPolicy() 15 ); 16 } 17} 3. è‡ªå®šä¹‰æ ·å¼ 1/** 2 * è‡ªå®šä¹‰è¡¨å¤´æ ·å¼ 3 */ 4public class CustomCellWriteHandler implements CellWriteHandler { 5 6 @Override 7 public void afterCellDispose(WriteSheetHolder writeSheetHolder, 8 WriteTableHolder writeTableHolder, 9 List\u0026lt;WriteCellData\u0026lt;?\u0026gt;\u0026gt; cellDataList, 10 Cell cell, 11 Head head, 12 Integer relativeRowIndex, 13 Boolean isHead) { 14 if (isHead) { 15 // è®¾ç½®è¡¨å¤´æ ·å¼ 16 CellStyle cellStyle = cell.getSheet().getWorkbook().createCellStyle(); 17 cellStyle.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex()); 18 cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND); 19 20 Font font = cell.getSheet().getWorkbook().createFont(); 21 font.setBold(true); 22 font.setFontHeightInPoints((short) 12); 23 cellStyle.setFont(font); 24 25 cell.setCellStyle(cellStyle); 26 } 27 } 28} 29 30// ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼ 31EasyExcel.write(file, OrderExportDTO.class) 32 .registerWriteHandler(new CustomCellWriteHandler()) 33 .sheet(\u0026#34;è®¢å•æ•°æ®\u0026#34;) 34 .doWrite(data); 4. æ•°æ®è½¬æ¢å™¨ 1/** 2 * è®¢å•çŠ¶æ€è½¬æ¢å™¨ 3 */ 4public class OrderStatusConverter implements Converter\u0026lt;Integer\u0026gt; { 5 6 private static final Map\u0026lt;Integer, String\u0026gt; STATUS_MAP = new HashMap\u0026lt;\u0026gt;(); 7 8 static { 9 STATUS_MAP.put(0, \u0026#34;å¾…æ”¯ä»˜\u0026#34;); 10 STATUS_MAP.put(1, \u0026#34;å·²æ”¯ä»˜\u0026#34;); 11 STATUS_MAP.put(2, \u0026#34;å·²å‘è´§\u0026#34;); 12 STATUS_MAP.put(3, \u0026#34;å·²å®Œæˆ\u0026#34;); 13 STATUS_MAP.put(4, \u0026#34;å·²å–æ¶ˆ\u0026#34;); 14 } 15 16 @Override 17 public Class\u0026lt;Integer\u0026gt; supportJavaTypeKey() { 18 return Integer.class; 19 } 20 21 @Override 22 public CellDataTypeEnum supportExcelTypeKey() { 23 return CellDataTypeEnum.STRING; 24 } 25 26 @Override 27 public WriteCellData\u0026lt;?\u0026gt; convertToExcelData(Integer value, ExcelContentProperty contentProperty, 28 GlobalConfiguration globalConfiguration) { 29 return new WriteCellData\u0026lt;\u0026gt;(STATUS_MAP.getOrDefault(value, \u0026#34;æœªçŸ¥\u0026#34;)); 30 } 31} 5. å†…å­˜ç›‘æ§ 1@Component 2@Slf4j 3public class MemoryMonitor { 4 5 @Scheduled(fixedRate = 5000) 6 public void monitorMemory() { 7 Runtime runtime = Runtime.getRuntime(); 8 long totalMemory = runtime.totalMemory(); 9 long freeMemory = runtime.freeMemory(); 10 long usedMemory = totalMemory - freeMemory; 11 long maxMemory = runtime.maxMemory(); 12 13 double usedPercent = (double) usedMemory / maxMemory * 100; 14 15 if (usedPercent \u0026gt; 80) { 16 log.warn(\u0026#34;å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼š{:.2f}%ï¼Œå·²ä½¿ç”¨ï¼š{}MBï¼Œæœ€å¤§ï¼š{}MB\u0026#34;, 17 usedPercent, 18 usedMemory / 1024 / 1024, 19 maxMemory / 1024 / 1024); 20 } 21 } 22} é¿å‘æç¤ºï¼š åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ï¼š1) é™åˆ¶å•æ¬¡å¯¼å‡ºçš„æœ€å¤§è®°å½•æ•°ï¼ˆå¦‚ 100 ä¸‡æ¡ï¼‰ï¼›2) è®¾ç½®å¯¼å‡ºä»»åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼›3) å®šæœŸæ¸…ç†è¿‡æœŸçš„å¯¼å‡ºæ–‡ä»¶ï¼›4) ç›‘æ§å¯¼å‡ºä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºï¼Œä»å†…å­˜é—®é¢˜åˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œæä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼š\nå†…å­˜ä¼˜åŒ–ï¼šä½¿ç”¨ EasyExcel æ›¿ä»£ä¼ ç»Ÿ POIï¼Œå†…å­˜å ç”¨é™ä½ 90% åˆ†æ‰¹å¤„ç†ï¼šé€šè¿‡åˆ†é¡µæŸ¥è¯¢æˆ–æ¸¸æ ‡æŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ® å¼‚æ­¥å¯¼å‡ºï¼šå¯¹äºè¶…å¤§æ•°æ®é‡ï¼Œä½¿ç”¨å¼‚æ­¥ä»»åŠ¡ + è¿›åº¦åé¦ˆ æ€§èƒ½è°ƒä¼˜ï¼šæ•°æ®åº“ä¼˜åŒ–ã€çº¿ç¨‹æ± é…ç½®ã€æ ·å¼å®šåˆ¶ç­‰ ç”Ÿäº§å®è·µï¼šä»»åŠ¡ç®¡ç†ã€æ–‡ä»¶å­˜å‚¨ã€é€šçŸ¥æœºåˆ¶ç­‰ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦è€ƒè™‘ï¼š\næ•°æ®å®‰å…¨ï¼šå¯¼å‡ºæ–‡ä»¶çš„è®¿é—®æƒé™æ§åˆ¶ å¹¶å‘æ§åˆ¶ï¼šé™åˆ¶åŒæ—¶æ‰§è¡Œçš„å¯¼å‡ºä»»åŠ¡æ•°é‡ èµ„æºéš”ç¦»ï¼šå¯¼å‡ºä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥æ±  ç›‘æ§å‘Šè­¦ï¼šå¯¼å‡ºå¤±è´¥ç‡ã€å¹³å‡è€—æ—¶ç­‰æŒ‡æ ‡ ä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°å¤§æ•°æ®é‡å¯¼å‡ºåŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯• EasyExcel è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ã€‚\n","permalink":"http://localhost:1313/posts/2025/05/easyexcel-%E7%99%BE%E4%B8%87%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E7%9A%84%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¤§æ•°æ®é‡å¯¼å‡ºæ˜¯ä¸€ä¸ªå¸¸è§ä½†æ£˜æ‰‹çš„é—®é¢˜ã€‚ä¼ ç»Ÿçš„ Apache POI åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºï¼Œè€Œé˜¿é‡Œå¼€æºçš„ EasyExcel é€šè¿‡ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œå¯ä»¥è½»æ¾å¤„ç†ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†ä»å®é™…é—®é¢˜å‡ºå‘ï¼Œæ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ EasyExcel å®ç°é«˜æ€§èƒ½çš„å¤§æ•°æ®é‡å¯¼å‡ºï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¼˜åŒ–ç»éªŒã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ EasyExcel çš„æ ¸å¿ƒåŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¼‚æ­¥å¯¼å‡ºä¸è¿›åº¦åé¦ˆæ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¼ ç»Ÿ-poi-çš„å†…å­˜é—®é¢˜\"\u003eä¼ ç»Ÿ POI çš„å†…å­˜é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜åœºæ™¯\"\u003eé—®é¢˜åœºæ™¯\u003c/h3\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿéœ€è¦å¯¼å‡ºè®¢å•æ•°æ®ï¼Œæ•°æ®é‡è¾¾åˆ° 100 ä¸‡æ¡ã€‚ä½¿ç”¨ä¼ ç»Ÿçš„ Apache POI å®ç°ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// ä¼ ç»Ÿ POI å®ç°ï¼ˆæœ‰é—®é¢˜çš„ä»£ç ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eexportOrders\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eWorkbook\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eXSSFWorkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eSheet\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003esheet\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateSheet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;è®¢å•æ•°æ®\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æŸ¥è¯¢ 100 ä¸‡æ¡æ•°æ®\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectAll\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å†™å…¥ Excel\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eRow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003esheet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateRow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateCell\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003esetCellValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetOrderNo\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreateCell\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003esetCellValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserName\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ... æ›´å¤šå­—æ®µ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è¾“å‡ºæ–‡ä»¶\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eFileOutputStream\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eFileOutputStream\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;orders.xlsx\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eworkbook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003efos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"å†…å­˜åˆ†æ\"\u003eå†…å­˜åˆ†æ\u003c/h3\u003e\n\u003cp\u003eè¿™æ®µä»£ç å­˜åœ¨ä¸¥é‡çš„å†…å­˜é—®é¢˜ï¼š\u003c/p\u003e","title":"EasyExcel ç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºçš„å†…å­˜ä¼˜åŒ–å®æˆ˜"},{"content":"åœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå®æ—¶æ¶ˆæ¯æ¨é€å·²æˆä¸ºæ ‡é…åŠŸèƒ½ã€‚ä»å³æ—¶é€šè®¯ã€åœ¨çº¿å®¢æœåˆ°å®æ—¶ç›‘æ§å¤§å±ï¼Œéƒ½ç¦»ä¸å¼€é«˜æ€§èƒ½çš„æ¶ˆæ¯æ¨é€èƒ½åŠ›ã€‚ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼å­˜åœ¨å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹ç­‰é—®é¢˜ï¼Œè€Œ WebSocket åè®®çš„å‡ºç°å®Œç¾è§£å†³äº†è¿™äº›ç—›ç‚¹ã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty æ¡†æ¶å®ç°åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜ï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¨é€æœåŠ¡ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ WebSocket åè®®åŸç†ä¸æ¡æ‰‹æµç¨‹ å­¦ä¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨ ç†è§£å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ç®¡ç†ç­–ç•¥ æŒæ¡é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±æ–¹æ¡ˆ äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§ ä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket WebSocket åè®®ä¼˜åŠ¿ ç›¸æ¯”ä¼ ç»Ÿçš„ HTTP è½®è¯¢ï¼ŒWebSocket å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\nç‰¹æ€§ HTTP è½®è¯¢ WebSocket é€šä¿¡æ–¹å¼ åŠåŒå·¥ å…¨åŒå·¥ è¿æ¥å¼€é”€ æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥ ä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥ å®æ—¶æ€§ å–å†³äºè½®è¯¢é—´éš”ï¼ˆç§’çº§ï¼‰ æ¯«ç§’çº§ æœåŠ¡å™¨å‹åŠ› é«˜ï¼ˆé¢‘ç¹çš„ HTTP è¯·æ±‚ï¼‰ ä½ï¼ˆé•¿è¿æ¥ï¼‰ å¸¦å®½æ¶ˆè€— é«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰ HTTP å¤´ï¼‰ ä½ï¼ˆåªä¼ è¾“æ•°æ®å¸§ï¼‰ Netty æ¡†æ¶ä¼˜åŠ¿ Netty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\né«˜æ€§èƒ½ï¼šåŸºäº NIOï¼Œæ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥ æ˜“ç”¨æ€§ï¼šæä¾›äº†ä¸°å¯Œçš„ç¼–è§£ç å™¨å’Œå¤„ç†å™¨ ç¨³å®šæ€§ï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯ æ‰©å±•æ€§ï¼šçµæ´»çš„ Pipeline æœºåˆ¶ æ¶æ„æ€è€ƒï¼š é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œä¸ä»…è¦çœ‹æŠ€æœ¯æœ¬èº«çš„ä¼˜åŠ¿ï¼Œæ›´è¦è€ƒè™‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€è¿ç»´æˆæœ¬å’Œç¤¾åŒºç”Ÿæ€ã€‚Netty åœ¨ Java ç”Ÿæ€ä¸­å·²ç»æˆä¸ºäº‹å®æ ‡å‡†ï¼ŒDubboã€RocketMQã€Elasticsearch ç­‰çŸ¥åé¡¹ç›®éƒ½åœ¨ä½¿ç”¨ã€‚\nWebSocket åè®®åŸç† æ¡æ‰‹æµç¨‹ WebSocket åŸºäº HTTP åè®®è¿›è¡Œæ¡æ‰‹ï¼Œç„¶åå‡çº§ä¸º WebSocket åè®®ï¼š\n1å®¢æˆ·ç«¯è¯·æ±‚ï¼š 2GET /chat HTTP/1.1 3Host: server.example.com 4Upgrade: websocket 5Connection: Upgrade 6Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ== 7Sec-WebSocket-Version: 13 8 9æœåŠ¡ç«¯å“åº”ï¼š 10HTTP/1.1 101 Switching Protocols 11Upgrade: websocket 12Connection: Upgrade 13Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo= æ•°æ®å¸§æ ¼å¼ WebSocket ä½¿ç”¨å¸§ï¼ˆFrameï¼‰æ¥ä¼ è¾“æ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ï¼š\næ–‡æœ¬å¸§ï¼šä¼ è¾“ UTF-8 ç¼–ç çš„æ–‡æœ¬ äºŒè¿›åˆ¶å¸§ï¼šä¼ è¾“äºŒè¿›åˆ¶æ•°æ® æ§åˆ¶å¸§ï¼šPingã€Pongã€Close Netty WebSocket æœåŠ¡å™¨å®ç° é¡¹ç›®ä¾èµ– 1\u0026lt;dependencies\u0026gt; 2 \u0026lt;!-- Netty --\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;io.netty\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;netty-all\u0026lt;/artifactId\u0026gt; 6 \u0026lt;version\u0026gt;4.1.100.Final\u0026lt;/version\u0026gt; 7 \u0026lt;/dependency\u0026gt; 8 9 \u0026lt;!-- JSON å¤„ç† --\u0026gt; 10 \u0026lt;dependency\u0026gt; 11 \u0026lt;groupId\u0026gt;com.alibaba.fastjson2\u0026lt;/groupId\u0026gt; 12 \u0026lt;artifactId\u0026gt;fastjson2\u0026lt;/artifactId\u0026gt; 13 \u0026lt;version\u0026gt;2.0.43\u0026lt;/version\u0026gt; 14 \u0026lt;/dependency\u0026gt; 15\u0026lt;/dependencies\u0026gt; æœåŠ¡å™¨å¯åŠ¨ç±» 1@Slf4j 2@Component 3public class WebSocketServer { 4 5 private final int port = 8888; 6 private EventLoopGroup bossGroup; 7 private EventLoopGroup workerGroup; 8 9 @PostConstruct 10 public void start() throws InterruptedException { 11 bossGroup = new NioEventLoopGroup(1); 12 workerGroup = new NioEventLoopGroup(); 13 14 try { 15 ServerBootstrap bootstrap = new ServerBootstrap(); 16 bootstrap.group(bossGroup, workerGroup) 17 .channel(NioServerSocketChannel.class) 18 .childHandler(new WebSocketChannelInitializer()) 19 .option(ChannelOption.SO_BACKLOG, 128) 20 .childOption(ChannelOption.SO_KEEPALIVE, true); 21 22 ChannelFuture future = bootstrap.bind(port).sync(); 23 log.info(\u0026#34;WebSocket æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç«¯å£ï¼š{}\u0026#34;, port); 24 25 // ç­‰å¾…æœåŠ¡å™¨å…³é—­ 26 future.channel().closeFuture().sync(); 27 } finally { 28 shutdown(); 29 } 30 } 31 32 @PreDestroy 33 public void shutdown() { 34 if (bossGroup != null) { 35 bossGroup.shutdownGracefully(); 36 } 37 if (workerGroup != null) { 38 workerGroup.shutdownGracefully(); 39 } 40 log.info(\u0026#34;WebSocket æœåŠ¡å™¨å·²å…³é—­\u0026#34;); 41 } 42} Channel åˆå§‹åŒ–å™¨ 1public class WebSocketChannelInitializer extends ChannelInitializer\u0026lt;SocketChannel\u0026gt; { 2 3 @Override 4 protected void initChannel(SocketChannel ch) { 5 ChannelPipeline pipeline = ch.pipeline(); 6 7 // HTTP ç¼–è§£ç å™¨ 8 pipeline.addLast(new HttpServerCodec()); 9 // HTTP èšåˆå™¨ï¼ˆå°†å¤šä¸ª HTTP æ¶ˆæ¯èšåˆæˆä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼‰ 10 pipeline.addLast(new HttpObjectAggregator(65536)); 11 // HTTP å‹ç¼© 12 pipeline.addLast(new HttpContentCompressor()); 13 14 // WebSocket åè®®å¤„ç†å™¨ï¼ˆå¤„ç†æ¡æ‰‹ã€Closeã€Pingã€Pongï¼‰ 15 pipeline.addLast(new WebSocketServerProtocolHandler(\u0026#34;/ws\u0026#34;, null, true)); 16 17 // å¿ƒè·³æ£€æµ‹ï¼ˆè¯»ç©ºé—² 60 ç§’ï¼Œå†™ç©ºé—² 0 ç§’ï¼Œè¯»å†™ç©ºé—² 0 ç§’ï¼‰ 18 pipeline.addLast(new IdleStateHandler(60, 0, 0, TimeUnit.SECONDS)); 19 20 // è‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†å™¨ 21 pipeline.addLast(new WebSocketHandler()); 22 } 23} ä¸šåŠ¡å¤„ç†å™¨ 1@Slf4j 2@ChannelHandler.Sharable 3public class WebSocketHandler extends SimpleChannelInboundHandler\u0026lt;TextWebSocketFrame\u0026gt; { 4 5 @Override 6 public void channelActive(ChannelHandlerContext ctx) { 7 // è¿æ¥å»ºç«‹æ—¶ 8 Channel channel = ctx.channel(); 9 log.info(\u0026#34;å®¢æˆ·ç«¯è¿æ¥ï¼š{}\u0026#34;, channel.id().asShortText()); 10 11 // å°† Channel åŠ å…¥ç®¡ç†å™¨ 12 ChannelManager.addChannel(channel); 13 } 14 15 @Override 16 protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) { 17 // æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ 18 String content = msg.text(); 19 log.info(\u0026#34;æ”¶åˆ°æ¶ˆæ¯ï¼š{}\u0026#34;, content); 20 21 // è§£ææ¶ˆæ¯ 22 Message message = JSON.parseObject(content, Message.class); 23 24 // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ 25 switch (message.getType()) { 26 case \u0026#34;auth\u0026#34;: 27 handleAuth(ctx, message); 28 break; 29 case \u0026#34;heartbeat\u0026#34;: 30 handleHeartbeat(ctx); 31 break; 32 case \u0026#34;message\u0026#34;: 33 handleMessage(ctx, message); 34 break; 35 default: 36 log.warn(\u0026#34;æœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼š{}\u0026#34;, message.getType()); 37 } 38 } 39 40 @Override 41 public void channelInactive(ChannelHandlerContext ctx) { 42 // è¿æ¥æ–­å¼€æ—¶ 43 Channel channel = ctx.channel(); 44 log.info(\u0026#34;å®¢æˆ·ç«¯æ–­å¼€ï¼š{}\u0026#34;, channel.id().asShortText()); 45 46 // ä»ç®¡ç†å™¨ä¸­ç§»é™¤ 47 ChannelManager.removeChannel(channel); 48 } 49 50 @Override 51 public void userEventTriggered(ChannelHandlerContext ctx, Object evt) { 52 // å¤„ç†ç©ºé—²äº‹ä»¶ 53 if (evt instanceof IdleStateEvent) { 54 IdleStateEvent event = (IdleStateEvent) evt; 55 if (event.state() == IdleState.READER_IDLE) { 56 log.warn(\u0026#34;å®¢æˆ·ç«¯ {} è¯»ç©ºé—²ï¼Œå…³é—­è¿æ¥\u0026#34;, ctx.channel().id().asShortText()); 57 ctx.close(); 58 } 59 } 60 } 61 62 @Override 63 public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) { 64 log.error(\u0026#34;è¿æ¥å¼‚å¸¸ï¼š{}\u0026#34;, cause.getMessage(), cause); 65 ctx.close(); 66 } 67 68 /** 69 * å¤„ç†è®¤è¯æ¶ˆæ¯ 70 */ 71 private void handleAuth(ChannelHandlerContext ctx, Message message) { 72 String userId = message.getUserId(); 73 Channel channel = ctx.channel(); 74 75 // ç»‘å®šç”¨æˆ· ID å’Œ Channel 76 ChannelManager.bindUser(userId, channel); 77 78 // å‘é€è®¤è¯æˆåŠŸæ¶ˆæ¯ 79 Message response = Message.builder() 80 .type(\u0026#34;auth_response\u0026#34;) 81 .content(\u0026#34;è®¤è¯æˆåŠŸ\u0026#34;) 82 .build(); 83 ctx.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(response))); 84 85 log.info(\u0026#34;ç”¨æˆ· {} è®¤è¯æˆåŠŸ\u0026#34;, userId); 86 } 87 88 /** 89 * å¤„ç†å¿ƒè·³æ¶ˆæ¯ 90 */ 91 private void handleHeartbeat(ChannelHandlerContext ctx) { 92 Message response = Message.builder() 93 .type(\u0026#34;heartbeat_response\u0026#34;) 94 .content(\u0026#34;pong\u0026#34;) 95 .build(); 96 ctx.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(response))); 97 } 98 99 /** 100 * å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ 101 */ 102 private void handleMessage(ChannelHandlerContext ctx, Message message) { 103 // æ ¹æ®ä¸šåŠ¡é€»è¾‘å¤„ç†æ¶ˆæ¯ 104 log.info(\u0026#34;å¤„ç†ä¸šåŠ¡æ¶ˆæ¯ï¼š{}\u0026#34;, message.getContent()); 105 106 // ç¤ºä¾‹ï¼šå¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ· 107 ChannelManager.broadcast(message); 108 } 109} è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯æ¨é€ Channel ç®¡ç†å™¨ 1@Slf4j 2public class ChannelManager { 3 4 // æ‰€æœ‰è¿æ¥çš„ Channel 5 private static final ChannelGroup CHANNELS = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE); 6 7 // ç”¨æˆ· ID ä¸ Channel çš„æ˜ å°„ 8 private static final ConcurrentHashMap\u0026lt;String, Channel\u0026gt; USER_CHANNELS = new ConcurrentHashMap\u0026lt;\u0026gt;(); 9 10 /** 11 * æ·»åŠ  Channel 12 */ 13 public static void addChannel(Channel channel) { 14 CHANNELS.add(channel); 15 log.info(\u0026#34;å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}\u0026#34;, CHANNELS.size()); 16 } 17 18 /** 19 * ç§»é™¤ Channel 20 */ 21 public static void removeChannel(Channel channel) { 22 CHANNELS.remove(channel); 23 24 // ç§»é™¤ç”¨æˆ·ç»‘å®š 25 USER_CHANNELS.entrySet().removeIf(entry -\u0026gt; entry.getValue().equals(channel)); 26 27 log.info(\u0026#34;å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼š{}\u0026#34;, CHANNELS.size()); 28 } 29 30 /** 31 * ç»‘å®šç”¨æˆ·å’Œ Channel 32 */ 33 public static void bindUser(String userId, Channel channel) { 34 USER_CHANNELS.put(userId, channel); 35 log.info(\u0026#34;ç”¨æˆ· {} ç»‘å®šæˆåŠŸï¼Œå½“å‰åœ¨çº¿ç”¨æˆ·æ•°ï¼š{}\u0026#34;, userId, USER_CHANNELS.size()); 36 } 37 38 /** 39 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ· 40 */ 41 public static void pushToUser(String userId, Message message) { 42 Channel channel = USER_CHANNELS.get(userId); 43 if (channel != null \u0026amp;\u0026amp; channel.isActive()) { 44 channel.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(message))); 45 log.info(\u0026#34;æ¨é€æ¶ˆæ¯ç»™ç”¨æˆ· {}ï¼š{}\u0026#34;, userId, message.getContent()); 46 } else { 47 log.warn(\u0026#34;ç”¨æˆ· {} ä¸åœ¨çº¿æˆ–è¿æ¥å·²æ–­å¼€\u0026#34;, userId); 48 } 49 } 50 51 /** 52 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ· 53 */ 54 public static void broadcast(Message message) { 55 TextWebSocketFrame frame = new TextWebSocketFrame(JSON.toJSONString(message)); 56 CHANNELS.writeAndFlush(frame); 57 log.info(\u0026#34;å¹¿æ’­æ¶ˆæ¯ç»™ {} ä¸ªç”¨æˆ·ï¼š{}\u0026#34;, CHANNELS.size(), message.getContent()); 58 } 59 60 /** 61 * è·å–åœ¨çº¿ç”¨æˆ·æ•° 62 */ 63 public static int getOnlineUserCount() { 64 return USER_CHANNELS.size(); 65 } 66} æ¶ˆæ¯æ¨é€æœåŠ¡ 1@Slf4j 2@Service 3public class MessagePushService { 4 5 /** 6 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ· 7 */ 8 public void pushToUser(String userId, String content) { 9 Message message = Message.builder() 10 .type(\u0026#34;push\u0026#34;) 11 .content(content) 12 .timestamp(System.currentTimeMillis()) 13 .build(); 14 15 ChannelManager.pushToUser(userId, message); 16 } 17 18 /** 19 * æ¨é€æ¶ˆæ¯ç»™å¤šä¸ªç”¨æˆ· 20 */ 21 public void pushToUsers(List\u0026lt;String\u0026gt; userIds, String content) { 22 Message message = Message.builder() 23 .type(\u0026#34;push\u0026#34;) 24 .content(content) 25 .timestamp(System.currentTimeMillis()) 26 .build(); 27 28 userIds.forEach(userId -\u0026gt; ChannelManager.pushToUser(userId, message)); 29 } 30 31 /** 32 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ· 33 */ 34 public void broadcast(String content) { 35 Message message = Message.builder() 36 .type(\u0026#34;broadcast\u0026#34;) 37 .content(content) 38 .timestamp(System.currentTimeMillis()) 39 .build(); 40 41 ChannelManager.broadcast(message); 42 } 43} å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ä¿æ´» ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³ åœ¨é•¿è¿æ¥åœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nç½‘ç»œä¸­æ–­æ£€æµ‹ï¼šç½‘ç»œå¼‚å¸¸æ—¶ï¼ŒTCP è¿æ¥ä¸ä¼šç«‹å³æ–­å¼€ NAT è¶…æ—¶ï¼šNAT è®¾å¤‡ä¼šæ¸…ç†é•¿æ—¶é—´æ— æ•°æ®ä¼ è¾“çš„è¿æ¥ è´Ÿè½½å‡è¡¡è¶…æ—¶ï¼šè´Ÿè½½å‡è¡¡å™¨å¯èƒ½ä¼šå…³é—­ç©ºé—²è¿æ¥ å¿ƒè·³å®ç°æ–¹æ¡ˆ æœåŠ¡ç«¯å¿ƒè·³æ£€æµ‹ï¼š\n1// åœ¨ ChannelInitializer ä¸­æ·»åŠ  2pipeline.addLast(new IdleStateHandler(60, 0, 0, TimeUnit.SECONDS)); å®¢æˆ·ç«¯å¿ƒè·³å‘é€ï¼ˆJavaScript ç¤ºä¾‹ï¼‰ï¼š\n1class WebSocketClient { 2 constructor(url) { 3 this.url = url; 4 this.ws = null; 5 this.heartbeatTimer = null; 6 this.reconnectTimer = null; 7 } 8 9 connect() { 10 this.ws = new WebSocket(this.url); 11 12 this.ws.onopen = () =\u0026gt; { 13 console.log(\u0026#39;WebSocket è¿æ¥æˆåŠŸ\u0026#39;); 14 this.startHeartbeat(); 15 16 // å‘é€è®¤è¯æ¶ˆæ¯ 17 this.send({ 18 type: \u0026#39;auth\u0026#39;, 19 userId: \u0026#39;user123\u0026#39;, 20 token: \u0026#39;xxx\u0026#39; 21 }); 22 }; 23 24 this.ws.onmessage = (event) =\u0026gt; { 25 const message = JSON.parse(event.data); 26 console.log(\u0026#39;æ”¶åˆ°æ¶ˆæ¯ï¼š\u0026#39;, message); 27 28 // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ 29 switch (message.type) { 30 case \u0026#39;auth_response\u0026#39;: 31 console.log(\u0026#39;è®¤è¯æˆåŠŸ\u0026#39;); 32 break; 33 case \u0026#39;push\u0026#39;: 34 this.handlePush(message); 35 break; 36 case \u0026#39;heartbeat_response\u0026#39;: 37 // æ”¶åˆ°å¿ƒè·³å“åº” 38 break; 39 } 40 }; 41 42 this.ws.onclose = () =\u0026gt; { 43 console.log(\u0026#39;WebSocket è¿æ¥å…³é—­\u0026#39;); 44 this.stopHeartbeat(); 45 this.reconnect(); 46 }; 47 48 this.ws.onerror = (error) =\u0026gt; { 49 console.error(\u0026#39;WebSocket é”™è¯¯ï¼š\u0026#39;, error); 50 }; 51 } 52 53 send(message) { 54 if (this.ws \u0026amp;\u0026amp; this.ws.readyState === WebSocket.OPEN) { 55 this.ws.send(JSON.stringify(message)); 56 } 57 } 58 59 startHeartbeat() { 60 this.heartbeatTimer = setInterval(() =\u0026gt; { 61 this.send({ 62 type: \u0026#39;heartbeat\u0026#39;, 63 timestamp: Date.now() 64 }); 65 }, 30000); // æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ 66 } 67 68 stopHeartbeat() { 69 if (this.heartbeatTimer) { 70 clearInterval(this.heartbeatTimer); 71 this.heartbeatTimer = null; 72 } 73 } 74 75 reconnect() { 76 if (this.reconnectTimer) { 77 return; 78 } 79 80 this.reconnectTimer = setTimeout(() =\u0026gt; { 81 console.log(\u0026#39;å°è¯•é‡æ–°è¿æ¥...\u0026#39;); 82 this.reconnectTimer = null; 83 this.connect(); 84 }, 5000); // 5 ç§’åé‡è¿ 85 } 86 87 handlePush(message) { 88 // å¤„ç†æ¨é€æ¶ˆæ¯ 89 console.log(\u0026#39;æ”¶åˆ°æ¨é€ï¼š\u0026#39;, message.content); 90 } 91 92 close() { 93 this.stopHeartbeat(); 94 if (this.ws) { 95 this.ws.close(); 96 } 97 } 98} 99 100// ä½¿ç”¨ç¤ºä¾‹ 101const client = new WebSocketClient(\u0026#39;ws://localhost:8888/ws\u0026#39;); 102client.connect(); é¿å‘æç¤ºï¼š å¿ƒè·³é—´éš”çš„è®¾ç½®éœ€è¦æƒè¡¡ï¼šé—´éš”å¤ªçŸ­ä¼šå¢åŠ æœåŠ¡å™¨å‹åŠ›ï¼Œé—´éš”å¤ªé•¿å¯èƒ½æ— æ³•åŠæ—¶å‘ç°è¿æ¥æ–­å¼€ã€‚å»ºè®®å®¢æˆ·ç«¯å¿ƒè·³é—´éš”ä¸º 30 ç§’ï¼ŒæœåŠ¡ç«¯è¶…æ—¶æ—¶é—´ä¸º 60 ç§’ã€‚\né›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”± å•æœºæ¶æ„çš„å±€é™ å•æœº WebSocket æœåŠ¡å™¨å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nè¿æ¥æ•°é™åˆ¶ï¼šå•æœºæœ€å¤šæ”¯æŒå‡ ä¸‡åˆ°åå‡ ä¸‡è¿æ¥ å•ç‚¹æ•…éšœï¼šæœåŠ¡å™¨å®•æœºå¯¼è‡´æ‰€æœ‰è¿æ¥æ–­å¼€ æ¶ˆæ¯è·¯ç”±ï¼šæ— æ³•æ¨é€æ¶ˆæ¯ç»™å…¶ä»–æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ· é›†ç¾¤æ¶æ„æ–¹æ¡ˆ 1 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2 â”‚ Nginx â”‚ 3 â”‚ (è´Ÿè½½å‡è¡¡) â”‚ 4 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ 5 â”‚ 6 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 7 â”‚ â”‚ â”‚ 8 â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” 9 â”‚ WS Serverâ”‚ â”‚ WS Serverâ”‚ â”‚ WS Serverâ”‚ 10 â”‚ Node1 â”‚ â”‚ Node2 â”‚ â”‚ Node3 â”‚ 11 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ 12 â”‚ â”‚ â”‚ 13 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 14 â”‚ 15 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” 16 â”‚ Redis â”‚ 17 â”‚ (æ¶ˆæ¯è·¯ç”±) â”‚ 18 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Nginx é…ç½® 1upstream websocket { 2 # IP Hash ç­–ç•¥ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·è¿æ¥åˆ°åŒä¸€å°æœåŠ¡å™¨ 3 ip_hash; 4 5 server 192.168.1.101:8888; 6 server 192.168.1.102:8888; 7 server 192.168.1.103:8888; 8} 9 10server { 11 listen 80; 12 server_name ws.example.com; 13 14 location /ws { 15 proxy_pass http://websocket; 16 proxy_http_version 1.1; 17 proxy_set_header Upgrade $http_upgrade; 18 proxy_set_header Connection \u0026#34;upgrade\u0026#34;; 19 proxy_set_header Host $host; 20 proxy_set_header X-Real-IP $remote_addr; 21 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 22 23 # è¶…æ—¶è®¾ç½® 24 proxy_connect_timeout 60s; 25 proxy_send_timeout 60s; 26 proxy_read_timeout 60s; 27 } 28} Redis æ¶ˆæ¯è·¯ç”± 1@Slf4j 2@Component 3public class RedisMessageRouter { 4 5 @Autowired 6 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 7 8 private static final String CHANNEL_PREFIX = \u0026#34;ws:message:\u0026#34;; 9 10 @PostConstruct 11 public void init() { 12 // è®¢é˜… Redis é¢‘é“ 13 redisTemplate.getConnectionFactory().getConnection() 14 .subscribe((message, pattern) -\u0026gt; { 15 String msg = new String(message.getBody()); 16 handleMessage(msg); 17 }, (CHANNEL_PREFIX + \u0026#34;*\u0026#34;).getBytes()); 18 } 19 20 /** 21 * å‘å¸ƒæ¶ˆæ¯åˆ° Redis 22 */ 23 public void publish(String userId, Message message) { 24 String channel = CHANNEL_PREFIX + userId; 25 redisTemplate.convertAndSend(channel, JSON.toJSONString(message)); 26 } 27 28 /** 29 * å¤„ç†ä» Redis æ¥æ”¶åˆ°çš„æ¶ˆæ¯ 30 */ 31 private void handleMessage(String msg) { 32 Message message = JSON.parseObject(msg, Message.class); 33 String userId = message.getUserId(); 34 35 // å¦‚æœç”¨æˆ·åœ¨æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥æ¨é€ 36 ChannelManager.pushToUser(userId, message); 37 } 38} æ”¹è¿›çš„æ¨é€æœåŠ¡ 1@Slf4j 2@Service 3public class ClusterMessagePushService { 4 5 @Autowired 6 private RedisMessageRouter redisMessageRouter; 7 8 @Autowired 9 private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; 10 11 /** 12 * æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰ 13 */ 14 public void pushToUser(String userId, String content) { 15 Message message = Message.builder() 16 .type(\u0026#34;push\u0026#34;) 17 .userId(userId) 18 .content(content) 19 .timestamp(System.currentTimeMillis()) 20 .build(); 21 22 // å…ˆå°è¯•æœ¬åœ°æ¨é€ 23 Channel channel = ChannelManager.getUserChannel(userId); 24 if (channel != null \u0026amp;\u0026amp; channel.isActive()) { 25 ChannelManager.pushToUser(userId, message); 26 } else { 27 // ç”¨æˆ·ä¸åœ¨æœ¬èŠ‚ç‚¹ï¼Œé€šè¿‡ Redis è·¯ç”± 28 redisMessageRouter.publish(userId, message); 29 } 30 } 31 32 /** 33 * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆé›†ç¾¤ç‰ˆï¼‰ 34 */ 35 public void broadcast(String content) { 36 Message message = Message.builder() 37 .type(\u0026#34;broadcast\u0026#34;) 38 .content(content) 39 .timestamp(System.currentTimeMillis()) 40 .build(); 41 42 // å‘å¸ƒåˆ° Redis å¹¿æ’­é¢‘é“ 43 redisTemplate.convertAndSend(\u0026#34;ws:broadcast\u0026#34;, JSON.toJSONString(message)); 44 } 45} æ¶æ„æ€è€ƒï¼š åœ¨é›†ç¾¤æ¶æ„ä¸­ï¼Œæ¶ˆæ¯è·¯ç”±æ˜¯æ ¸å¿ƒé—®é¢˜ã€‚é™¤äº† Redis Pub/Subï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ RocketMQã€Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—ã€‚é€‰æ‹©æ—¶éœ€è¦è€ƒè™‘ï¼š1) æ¶ˆæ¯å¯é æ€§è¦æ±‚ï¼›2) æ¶ˆæ¯é¡ºåºæ€§è¦æ±‚ï¼›3) ç³»ç»Ÿå¤æ‚åº¦ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜ä½†å¯é æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼ŒRedis Pub/Sub æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚\nç”Ÿäº§ç¯å¢ƒä¼˜åŒ– æ€§èƒ½ä¼˜åŒ– 1. çº¿ç¨‹æ± é…ç½®\n1// Boss çº¿ç¨‹ç»„ï¼šå¤„ç†è¿æ¥è¯·æ±‚ 2EventLoopGroup bossGroup = new NioEventLoopGroup(1); 3 4// Worker çº¿ç¨‹ç»„ï¼šå¤„ç† I/O æ“ä½œ 5// é»˜è®¤çº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2 6EventLoopGroup workerGroup = new NioEventLoopGroup(); 7 8// ä¸šåŠ¡çº¿ç¨‹æ± ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ 9ThreadPoolExecutor businessExecutor = new ThreadPoolExecutor( 10 10, 50, 60L, TimeUnit.SECONDS, 11 new LinkedBlockingQueue\u0026lt;\u0026gt;(1000), 12 new ThreadFactoryBuilder().setNameFormat(\u0026#34;business-%d\u0026#34;).build(), 13 new ThreadPoolExecutor.CallerRunsPolicy() 14); 2. å†…å­˜ä¼˜åŒ–\n1// ä½¿ç”¨æ± åŒ–çš„ ByteBuf 2bootstrap.option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); 3bootstrap.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); 4 5// è®¾ç½®æ¥æ”¶ç¼“å†²åŒºå¤§å° 6bootstrap.childOption(ChannelOption.RCVBUF_ALLOCATOR, 7 new AdaptiveRecvByteBufAllocator(64, 1024, 65536)); 3. è¿æ¥æ•°ä¼˜åŒ–\n1// å¢åŠ  TCP è¿æ¥é˜Ÿåˆ—é•¿åº¦ 2bootstrap.option(ChannelOption.SO_BACKLOG, 1024); 3 4// å¯ç”¨ TCP_NODELAYï¼ˆç¦ç”¨ Nagle ç®—æ³•ï¼‰ 5bootstrap.childOption(ChannelOption.TCP_NODELAY, true); 6 7// å¯ç”¨ SO_KEEPALIVE 8bootstrap.childOption(ChannelOption.SO_KEEPALIVE, true); ç›‘æ§æŒ‡æ ‡ 1@Component 2public class WebSocketMetrics { 3 4 private final AtomicLong totalConnections = new AtomicLong(0); 5 private final AtomicLong activeConnections = new AtomicLong(0); 6 private final AtomicLong totalMessages = new AtomicLong(0); 7 8 /** 9 * è®°å½•è¿æ¥å»ºç«‹ 10 */ 11 public void recordConnect() { 12 totalConnections.incrementAndGet(); 13 activeConnections.incrementAndGet(); 14 } 15 16 /** 17 * è®°å½•è¿æ¥æ–­å¼€ 18 */ 19 public void recordDisconnect() { 20 activeConnections.decrementAndGet(); 21 } 22 23 /** 24 * è®°å½•æ¶ˆæ¯å‘é€ 25 */ 26 public void recordMessage() { 27 totalMessages.incrementAndGet(); 28 } 29 30 /** 31 * è·å–ç›‘æ§æ•°æ® 32 */ 33 public Map\u0026lt;String, Object\u0026gt; getMetrics() { 34 Map\u0026lt;String, Object\u0026gt; metrics = new HashMap\u0026lt;\u0026gt;(); 35 metrics.put(\u0026#34;totalConnections\u0026#34;, totalConnections.get()); 36 metrics.put(\u0026#34;activeConnections\u0026#34;, activeConnections.get()); 37 metrics.put(\u0026#34;totalMessages\u0026#34;, totalMessages.get()); 38 metrics.put(\u0026#34;onlineUsers\u0026#34;, ChannelManager.getOnlineUserCount()); 39 return metrics; 40 } 41} å®‰å…¨åŠ å›º 1. è®¤è¯é‰´æƒ\n1private void handleAuth(ChannelHandlerContext ctx, Message message) { 2 String token = message.getToken(); 3 4 // éªŒè¯ Token 5 if (!validateToken(token)) { 6 ctx.writeAndFlush(new TextWebSocketFrame( 7 JSON.toJSONString(Message.builder() 8 .type(\u0026#34;auth_response\u0026#34;) 9 .code(401) 10 .content(\u0026#34;è®¤è¯å¤±è´¥\u0026#34;) 11 .build()) 12 )); 13 ctx.close(); 14 return; 15 } 16 17 // è®¤è¯æˆåŠŸï¼Œç»‘å®šç”¨æˆ· 18 String userId = getUserIdFromToken(token); 19 ChannelManager.bindUser(userId, ctx.channel()); 20} 2. æ¶ˆæ¯é™æµ\n1@Component 2public class MessageRateLimiter { 3 4 private final LoadingCache\u0026lt;String, RateLimiter\u0026gt; limiters = CacheBuilder.newBuilder() 5 .maximumSize(10000) 6 .expireAfterAccess(1, TimeUnit.HOURS) 7 .build(new CacheLoader\u0026lt;String, RateLimiter\u0026gt;() { 8 @Override 9 public RateLimiter load(String key) { 10 // æ¯ç§’æœ€å¤š 10 æ¡æ¶ˆæ¯ 11 return RateLimiter.create(10.0); 12 } 13 }); 14 15 public boolean tryAcquire(String userId) { 16 try { 17 RateLimiter limiter = limiters.get(userId); 18 return limiter.tryAcquire(); 19 } catch (ExecutionException e) { 20 return false; 21 } 22 } 23} 3. XSS é˜²æŠ¤\n1private String sanitizeContent(String content) { 2 // è¿‡æ»¤ HTML æ ‡ç­¾å’Œè„šæœ¬ 3 return content.replaceAll(\u0026#34;\u0026lt;[^\u0026gt;]*\u0026gt;\u0026#34;, \u0026#34;\u0026#34;) 4 .replaceAll(\u0026#34;javascript:\u0026#34;, \u0026#34;\u0026#34;) 5 .replaceAll(\u0026#34;on\\\\w+\\\\s*=\u0026#34;, \u0026#34;\u0026#34;); 6} é¿å‘æç¤ºï¼š ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå®‰å…¨æ€§è‡³å…³é‡è¦ã€‚é™¤äº†ä¸Šè¿°æªæ–½ï¼Œè¿˜éœ€è¦ï¼š1) ä½¿ç”¨ WSSï¼ˆWebSocket over TLSï¼‰åŠ å¯†ä¼ è¾“ï¼›2) è®¾ç½®åˆç†çš„æ¶ˆæ¯å¤§å°é™åˆ¶ï¼›3) å®æ–½ IP é»‘ç™½åå•ï¼›4) è®°å½•å®¡è®¡æ—¥å¿—ã€‚\næ€»ç»“ä¸æ€è€ƒ æœ¬æ–‡æ·±å…¥è®²è§£äº†å¦‚ä½•ä½¿ç”¨ Netty å’Œ WebSocket æ„å»ºé«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œæ¶µç›–äº†ä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜çš„å®Œæ•´å†…å®¹ï¼š\nåè®®åŸç†ï¼šç†è§£ WebSocket æ¡æ‰‹æµç¨‹å’Œæ•°æ®å¸§æ ¼å¼ æœåŠ¡å™¨å®ç°ï¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨ è¿æ¥ç®¡ç†ï¼šå®ç° Channel ç®¡ç†å’Œæ¶ˆæ¯æ¨é€ å¿ƒè·³æœºåˆ¶ï¼šä¿è¯è¿æ¥å¯é æ€§å’ŒåŠæ—¶æ£€æµ‹æ–­çº¿ é›†ç¾¤éƒ¨ç½²ï¼šé€šè¿‡ Redis å®ç°è·¨èŠ‚ç‚¹æ¶ˆæ¯è·¯ç”± æ€§èƒ½ä¼˜åŒ–ï¼šçº¿ç¨‹æ± ã€å†…å­˜ã€è¿æ¥æ•°ç­‰å¤šæ–¹é¢ä¼˜åŒ– å®‰å…¨åŠ å›ºï¼šè®¤è¯é‰´æƒã€é™æµã€XSS é˜²æŠ¤ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜éœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯è¿›è¡Œè°ƒæ•´ã€‚ä¾‹å¦‚ï¼š\nå³æ—¶é€šè®¯ï¼šéœ€è¦è€ƒè™‘æ¶ˆæ¯å¯é æ€§ã€ç¦»çº¿æ¶ˆæ¯ã€æ¶ˆæ¯é¡ºåº åœ¨çº¿å®¢æœï¼šéœ€è¦è€ƒè™‘ä¼šè¯ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±ã€å®¢æœåˆ†é… å®æ—¶ç›‘æ§ï¼šéœ€è¦è€ƒè™‘æ•°æ®èšåˆã€å‘Šè­¦æ¨é€ã€å¤§å±å±•ç¤º ä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°å®æ—¶æ¶ˆæ¯æ¨é€åŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯• Netty + WebSocket è¿™ä¸ªå¼ºå¤§çš„ç»„åˆã€‚\n","permalink":"http://localhost:1313/posts/2025/04/netty--websocket-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eåœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå®æ—¶æ¶ˆæ¯æ¨é€å·²æˆä¸ºæ ‡é…åŠŸèƒ½ã€‚ä»å³æ—¶é€šè®¯ã€åœ¨çº¿å®¢æœåˆ°å®æ—¶ç›‘æ§å¤§å±ï¼Œéƒ½ç¦»ä¸å¼€é«˜æ€§èƒ½çš„æ¶ˆæ¯æ¨é€èƒ½åŠ›ã€‚ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼å­˜åœ¨å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹ç­‰é—®é¢˜ï¼Œè€Œ WebSocket åè®®çš„å‡ºç°å®Œç¾è§£å†³äº†è¿™äº›ç—›ç‚¹ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Netty æ¡†æ¶å®ç°åŸºäº WebSocket çš„å®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Œä»åè®®åŸç†åˆ°ç”Ÿäº§å®æˆ˜ï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¨é€æœåŠ¡ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ WebSocket åè®®åŸç†ä¸æ¡æ‰‹æµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ Netty æ„å»º WebSocket æœåŠ¡å™¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å¿ƒè·³æœºåˆ¶ä¸è¿æ¥ç®¡ç†ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é›†ç¾¤éƒ¨ç½²ä¸æ¶ˆæ¯è·¯ç”±æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆé€‰æ‹©-netty--websocket\"\u003eä¸ºä»€ä¹ˆé€‰æ‹© Netty + WebSocket\u003c/h2\u003e\n\u003ch3 id=\"websocket-åè®®ä¼˜åŠ¿\"\u003eWebSocket åè®®ä¼˜åŠ¿\u003c/h3\u003e\n\u003cp\u003eç›¸æ¯”ä¼ ç»Ÿçš„ HTTP è½®è¯¢ï¼ŒWebSocket å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eç‰¹æ€§\u003c/th\u003e\n          \u003cth\u003eHTTP è½®è¯¢\u003c/th\u003e\n          \u003cth\u003eWebSocket\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eé€šä¿¡æ–¹å¼\u003c/td\u003e\n          \u003ctd\u003eåŠåŒå·¥\u003c/td\u003e\n          \u003ctd\u003eå…¨åŒå·¥\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eè¿æ¥å¼€é”€\u003c/td\u003e\n          \u003ctd\u003eæ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥\u003c/td\u003e\n          \u003ctd\u003eä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå®æ—¶æ€§\u003c/td\u003e\n          \u003ctd\u003eå–å†³äºè½®è¯¢é—´éš”ï¼ˆç§’çº§ï¼‰\u003c/td\u003e\n          \u003ctd\u003eæ¯«ç§’çº§\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eæœåŠ¡å™¨å‹åŠ›\u003c/td\u003e\n          \u003ctd\u003eé«˜ï¼ˆé¢‘ç¹çš„ HTTP è¯·æ±‚ï¼‰\u003c/td\u003e\n          \u003ctd\u003eä½ï¼ˆé•¿è¿æ¥ï¼‰\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå¸¦å®½æ¶ˆè€—\u003c/td\u003e\n          \u003ctd\u003eé«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰ HTTP å¤´ï¼‰\u003c/td\u003e\n          \u003ctd\u003eä½ï¼ˆåªä¼ è¾“æ•°æ®å¸§ï¼‰\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"netty-æ¡†æ¶ä¼˜åŠ¿\"\u003eNetty æ¡†æ¶ä¼˜åŠ¿\u003c/h3\u003e\n\u003cp\u003eNetty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eé«˜æ€§èƒ½\u003c/strong\u003eï¼šåŸºäº NIOï¼Œæ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ˜“ç”¨æ€§\u003c/strong\u003eï¼šæä¾›äº†ä¸°å¯Œçš„ç¼–è§£ç å™¨å’Œå¤„ç†å™¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç¨³å®šæ€§\u003c/strong\u003eï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ‰©å±•æ€§\u003c/strong\u003eï¼šçµæ´»çš„ Pipeline æœºåˆ¶\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œä¸ä»…è¦çœ‹æŠ€æœ¯æœ¬èº«çš„ä¼˜åŠ¿ï¼Œæ›´è¦è€ƒè™‘å›¢é˜Ÿçš„æŠ€æœ¯æ ˆã€è¿ç»´æˆæœ¬å’Œç¤¾åŒºç”Ÿæ€ã€‚Netty åœ¨ Java ç”Ÿæ€ä¸­å·²ç»æˆä¸ºäº‹å®æ ‡å‡†ï¼ŒDubboã€RocketMQã€Elasticsearch ç­‰çŸ¥åé¡¹ç›®éƒ½åœ¨ä½¿ç”¨ã€‚\u003c/p\u003e","title":"Netty + WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼šä»åŸç†åˆ°ç”Ÿäº§å®æˆ˜"},{"content":"åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚ä½†ç¼“å­˜ä½¿ç”¨ä¸å½“ä¼šå¼•å‘ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æè¿™äº›é—®é¢˜çš„åŸç†ï¼Œå¹¶æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„æœ¬è´¨åŒºåˆ« æŒæ¡å¸ƒéš†è¿‡æ»¤å™¨ã€äº’æ–¥é”ç­‰é˜²æŠ¤æ‰‹æ®µ å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„ç¼“å­˜æ¶æ„ äº†è§£ç¼“å­˜é¢„çƒ­ã€é™çº§ç­‰æœ€ä½³å®è·µ ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜ é—®é¢˜å¯¹æ¯” é—®é¢˜ åŸå›  å½±å“ è§£å†³æ–¹æ¡ˆ ç¼“å­˜ç©¿é€ æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® å¤§é‡è¯·æ±‚æ‰“åˆ°DB å¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜ ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹keyè¿‡æœŸ ç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°DB äº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ ç¼“å­˜é›ªå´© å¤§é‡keyåŒæ—¶è¿‡æœŸ DBå‹åŠ›éª¤å¢ è¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜ ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® é—®é¢˜åœºæ™¯ 1// æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID 2for (int i = -1000000; i \u0026lt; 0; i--) { 3 User user = getUser(i); // ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æŸ¥DB 4} æµç¨‹ï¼š\n1è¯·æ±‚ â†’ æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ æŸ¥æ•°æ®åº“ï¼ˆæœªå‘½ä¸­ï¼‰â†’ è¿”å›null æ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\nè§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨ åŸç†ï¼š ç”¨ä½æ•°ç»„åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚\n1@Configuration 2public class BloomFilterConfig { 3 4 @Bean 5 public BloomFilter\u0026lt;Long\u0026gt; userBloomFilter() { 6 // é¢„æœŸå…ƒç´ æ•°é‡ï¼š1000ä¸‡ï¼Œè¯¯åˆ¤ç‡ï¼š0.01% 7 BloomFilter\u0026lt;Long\u0026gt; bloomFilter = BloomFilter.create( 8 Funnels.longFunnel(), 9 10000000, 10 0.0001 11 ); 12 13 // åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ 14 List\u0026lt;Long\u0026gt; userIds = userMapper.selectAllIds(); 15 userIds.forEach(bloomFilter::put); 16 17 return bloomFilter; 18 } 19} 1@Service 2public class UserService { 3 4 @Autowired 5 private BloomFilter\u0026lt;Long\u0026gt; userBloomFilter; 6 7 @Autowired 8 private RedisTemplate\u0026lt;String, User\u0026gt; redisTemplate; 9 10 @Autowired 11 private UserMapper userMapper; 12 13 public User getUser(Long userId) { 14 // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ 15 if (!userBloomFilter.mightContain(userId)) { 16 return null; // ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å› 17 } 18 19 // 2. æŸ¥ç¼“å­˜ 20 String key = \u0026#34;user:\u0026#34; + userId; 21 User user = redisTemplate.opsForValue().get(key); 22 if (user != null) { 23 return user; 24 } 25 26 // 3. æŸ¥æ•°æ®åº“ 27 user = userMapper.selectById(userId); 28 if (user != null) { 29 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 30 } 31 32 return user; 33 } 34} ä¼˜ç‚¹ï¼š\nå†…å­˜å ç”¨å°ï¼ˆ1000ä¸‡æ•°æ®åªéœ€çº¦12MBï¼‰ æŸ¥è¯¢é€Ÿåº¦å¿«ï¼ˆO(k)ï¼Œkä¸ºå“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼‰ ç¼ºç‚¹ï¼š\nå­˜åœ¨è¯¯åˆ¤ï¼ˆå¯èƒ½åˆ¤æ–­å­˜åœ¨ä½†å®é™…ä¸å­˜åœ¨ï¼‰ æ— æ³•åˆ é™¤å…ƒç´  è§£å†³æ–¹æ¡ˆ2ï¼šç¼“å­˜ç©ºå€¼ 1public User getUser(Long userId) { 2 String key = \u0026#34;user:\u0026#34; + userId; 3 4 // 1. æŸ¥ç¼“å­˜ 5 User user = redisTemplate.opsForValue().get(key); 6 if (user != null) { 7 // ç©ºå¯¹è±¡æ ‡è®° 8 if (user.getId() == null) { 9 return null; 10 } 11 return user; 12 } 13 14 // 2. æŸ¥æ•°æ®åº“ 15 user = userMapper.selectById(userId); 16 17 // 3. ç¼“å­˜ç»“æœï¼ˆåŒ…æ‹¬nullï¼‰ 18 if (user == null) { 19 // ç¼“å­˜ç©ºå¯¹è±¡ï¼Œè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ 20 User emptyUser = new User(); 21 redisTemplate.opsForValue().set(key, emptyUser, 5, TimeUnit.MINUTES); 22 } else { 23 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 24 } 25 26 return user; 27} ä¼˜ç‚¹ï¼š\nå®ç°ç®€å• å¯ä»¥é˜²æ­¢åŒä¸€ä¸ªä¸å­˜åœ¨çš„keyåå¤æŸ¥è¯¢ ç¼ºç‚¹ï¼š\nå ç”¨ç¼“å­˜ç©ºé—´ å¯èƒ½ç¼“å­˜å¤§é‡æ— æ•ˆæ•°æ® è§£å†³æ–¹æ¡ˆ3ï¼šå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜ 1public User getUser(Long userId) { 2 // 1. å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­ 3 if (!userBloomFilter.mightContain(userId)) { 4 return null; 5 } 6 7 String key = \u0026#34;user:\u0026#34; + userId; 8 9 // 2. æŸ¥ç¼“å­˜ï¼ˆåŒ…æ‹¬ç©ºå€¼ï¼‰ 10 User user = redisTemplate.opsForValue().get(key); 11 if (user != null) { 12 return user.getId() == null ? null : user; 13 } 14 15 // 3. æŸ¥æ•°æ®åº“ 16 user = userMapper.selectById(userId); 17 18 // 4. ç¼“å­˜ç»“æœ 19 if (user == null) { 20 User emptyUser = new User(); 21 redisTemplate.opsForValue().set(key, emptyUser, 5, TimeUnit.MINUTES); 22 } else { 23 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 24 } 25 26 return user; 27} æ¶æ„æ€è€ƒï¼š å¸ƒéš†è¿‡æ»¤å™¨é€‚åˆè¿‡æ»¤å¤§éƒ¨åˆ†ä¸å­˜åœ¨çš„è¯·æ±‚ï¼Œç©ºå€¼ç¼“å­˜é€‚åˆå¤„ç†å°‘é‡ä¸å­˜åœ¨ä½†è¢«é¢‘ç¹æŸ¥è¯¢çš„keyã€‚ä¸¤è€…ç»“åˆä½¿ç”¨ï¼Œå¯ä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœã€‚\nç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyè¿‡æœŸ é—®é¢˜åœºæ™¯ 1çƒ­ç‚¹å•†å“è¯¦æƒ…é¡µï¼Œç¼“å­˜è¿‡æœŸç¬é—´ï¼Œ1000ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“ æµç¨‹ï¼š\n1æ—¶åˆ»Tï¼šç¼“å­˜è¿‡æœŸ 2æ—¶åˆ»T+1msï¼š1000ä¸ªè¯·æ±‚åŒæ—¶æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ åŒæ—¶æŸ¥æ•°æ®åº“ è§£å†³æ–¹æ¡ˆ1ï¼šäº’æ–¥é” 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // 1. æŸ¥ç¼“å­˜ 5 Product product = redisTemplate.opsForValue().get(key); 6 if (product != null) { 7 return product; 8 } 9 10 // 2. è·å–äº’æ–¥é” 11 String lockKey = \u0026#34;lock:product:\u0026#34; + productId; 12 Boolean locked = redisTemplate.opsForValue() 13 .setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS); 14 15 if (locked) { 16 try { 17 // 3. åŒé‡æ£€æŸ¥ 18 product = redisTemplate.opsForValue().get(key); 19 if (product != null) { 20 return product; 21 } 22 23 // 4. æŸ¥æ•°æ®åº“ 24 product = productMapper.selectById(productId); 25 26 // 5. å†™å…¥ç¼“å­˜ 27 if (product != null) { 28 redisTemplate.opsForValue().set(key, product, 1, TimeUnit.HOURS); 29 } 30 31 return product; 32 } finally { 33 // 6. é‡Šæ”¾é” 34 redisTemplate.delete(lockKey); 35 } 36 } else { 37 // 7. æœªè·å–åˆ°é”ï¼Œç­‰å¾…åé‡è¯• 38 try { 39 Thread.sleep(50); 40 } catch (InterruptedException e) { 41 Thread.currentThread().interrupt(); 42 } 43 return getProduct(productId); // é€’å½’é‡è¯• 44 } 45} ä¼˜ç‚¹ï¼š\nä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®åº“ å®ç°ç®€å• ç¼ºç‚¹ï¼š\nå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾… å¯èƒ½å¯¼è‡´è¯·æ±‚å †ç§¯ è§£å†³æ–¹æ¡ˆ2ï¼šé€»è¾‘è¿‡æœŸ 1@Data 2public class CacheData\u0026lt;T\u0026gt; { 3 private T data; 4 private LocalDateTime expireTime; 5} 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // 1. æŸ¥ç¼“å­˜ï¼ˆæ°¸ä¸è¿‡æœŸï¼‰ 5 CacheData\u0026lt;Product\u0026gt; cacheData = redisTemplate.opsForValue().get(key); 6 7 if (cacheData == null) { 8 // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ 9 return loadAndCache(productId); 10 } 11 12 // 2. åˆ¤æ–­é€»è¾‘è¿‡æœŸ 13 if (cacheData.getExpireTime().isBefore(LocalDateTime.now())) { 14 // 3. å¼‚æ­¥æ›´æ–°ç¼“å­˜ 15 String lockKey = \u0026#34;lock:product:\u0026#34; + productId; 16 Boolean locked = redisTemplate.opsForValue() 17 .setIfAbsent(lockKey, \u0026#34;1\u0026#34;, 10, TimeUnit.SECONDS); 18 19 if (locked) { 20 CompletableFuture.runAsync(() -\u0026gt; { 21 try { 22 loadAndCache(productId); 23 } finally { 24 redisTemplate.delete(lockKey); 25 } 26 }); 27 } 28 } 29 30 // 4. è¿”å›æ—§æ•°æ® 31 return cacheData.getData(); 32} 33 34private Product loadAndCache(Long productId) { 35 Product product = productMapper.selectById(productId); 36 if (product != null) { 37 CacheData\u0026lt;Product\u0026gt; cacheData = new CacheData\u0026lt;\u0026gt;(); 38 cacheData.setData(product); 39 cacheData.setExpireTime(LocalDateTime.now().plusHours(1)); 40 41 redisTemplate.opsForValue().set(\u0026#34;product:\u0026#34; + productId, cacheData); 42 } 43 return product; 44} ä¼˜ç‚¹ï¼š\nä¸ä¼šé˜»å¡è¯·æ±‚ å§‹ç»ˆè¿”å›æ•°æ®ï¼ˆå³ä½¿æ˜¯æ—§æ•°æ®ï¼‰ ç¼ºç‚¹ï¼š\nå¯èƒ½è¿”å›è¿‡æœŸæ•°æ® å®ç°å¤æ‚ è§£å†³æ–¹æ¡ˆ3ï¼šçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ 1public Product getProduct(Long productId) { 2 String key = \u0026#34;product:\u0026#34; + productId; 3 4 // çƒ­ç‚¹å•†å“æ°¸ä¸è¿‡æœŸ 5 Product product = redisTemplate.opsForValue().get(key); 6 if (product != null) { 7 return product; 8 } 9 10 // æŸ¥æ•°æ®åº“å¹¶ç¼“å­˜ï¼ˆä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰ 11 product = productMapper.selectById(productId); 12 if (product != null) { 13 redisTemplate.opsForValue().set(key, product); 14 } 15 16 return product; 17} 18 19// é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ›´æ–°ç¼“å­˜ 20@RabbitListener(queues = \u0026#34;product.update\u0026#34;) 21public void updateProductCache(Long productId) { 22 Product product = productMapper.selectById(productId); 23 redisTemplate.opsForValue().set(\u0026#34;product:\u0026#34; + productId, product); 24} ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸ é—®é¢˜åœºæ™¯ 1å‡Œæ™¨2ç‚¹ï¼Œç³»ç»Ÿé‡å¯ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶åŠ è½½ï¼Œè®¾ç½®1å°æ—¶è¿‡æœŸ 2å‡Œæ™¨3ç‚¹ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ è§£å†³æ–¹æ¡ˆ1ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ– 1public void setCache(String key, Object value, long baseExpireSeconds) { 2 // åœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¸Šå¢åŠ éšæœºå€¼ 3 long randomSeconds = ThreadLocalRandom.current().nextLong(0, 300); 4 long expireSeconds = baseExpireSeconds + randomSeconds; 5 6 redisTemplate.opsForValue().set(key, value, expireSeconds, TimeUnit.SECONDS); 7} 1// ä½¿ç”¨ç¤ºä¾‹ 2setCache(\u0026#34;user:1\u0026#34;, user, 3600); // 3600 ~ 3900ç§’ 3setCache(\u0026#34;user:2\u0026#34;, user, 3600); // 3600 ~ 3900ç§’ è§£å†³æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜ 1è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â†’ Redis â†’ æ•°æ®åº“ 1@Configuration 2public class CacheConfig { 3 4 @Bean 5 public Cache\u0026lt;String, Object\u0026gt; localCache() { 6 return Caffeine.newBuilder() 7 .maximumSize(10000) 8 .expireAfterWrite(5, TimeUnit.MINUTES) 9 .build(); 10 } 11} 1@Service 2public class UserService { 3 4 @Autowired 5 private Cache\u0026lt;String, Object\u0026gt; localCache; 6 7 @Autowired 8 private RedisTemplate\u0026lt;String, User\u0026gt; redisTemplate; 9 10 @Autowired 11 private UserMapper userMapper; 12 13 public User getUser(Long userId) { 14 String key = \u0026#34;user:\u0026#34; + userId; 15 16 // 1. æŸ¥æœ¬åœ°ç¼“å­˜ 17 User user = (User) localCache.getIfPresent(key); 18 if (user != null) { 19 return user; 20 } 21 22 // 2. æŸ¥Redis 23 user = redisTemplate.opsForValue().get(key); 24 if (user != null) { 25 localCache.put(key, user); 26 return user; 27 } 28 29 // 3. æŸ¥æ•°æ®åº“ 30 user = userMapper.selectById(userId); 31 if (user != null) { 32 // å†™å…¥Rediså’Œæœ¬åœ°ç¼“å­˜ 33 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 34 localCache.put(key, user); 35 } 36 37 return user; 38 } 39} è§£å†³æ–¹æ¡ˆ3ï¼šç¼“å­˜é¢„çƒ­ 1@Component 2public class CacheWarmUp implements ApplicationRunner { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; 6 7 @Autowired 8 private ProductMapper productMapper; 9 10 @Override 11 public void run(ApplicationArguments args) { 12 log.info(\u0026#34;å¼€å§‹ç¼“å­˜é¢„çƒ­...\u0026#34;); 13 14 // åŠ è½½çƒ­ç‚¹å•†å“ 15 List\u0026lt;Product\u0026gt; hotProducts = productMapper.selectHotProducts(100); 16 for (Product product : hotProducts) { 17 String key = \u0026#34;product:\u0026#34; + product.getId(); 18 long expireSeconds = 3600 + ThreadLocalRandom.current().nextLong(0, 300); 19 redisTemplate.opsForValue().set(key, product, expireSeconds, TimeUnit.SECONDS); 20 } 21 22 log.info(\u0026#34;ç¼“å­˜é¢„çƒ­å®Œæˆï¼Œå…±åŠ è½½ {} ä¸ªå•†å“\u0026#34;, hotProducts.size()); 23 } 24} è§£å†³æ–¹æ¡ˆ4ï¼šé™æµé™çº§ 1@Service 2public class ProductService { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Product\u0026gt; redisTemplate; 6 7 @Autowired 8 private ProductMapper productMapper; 9 10 /** 11 * ä½¿ç”¨ Sentinel é™æµ 12 */ 13 @SentinelResource( 14 value = \u0026#34;getProduct\u0026#34;, 15 blockHandler = \u0026#34;getProductBlockHandler\u0026#34;, 16 fallback = \u0026#34;getProductFallback\u0026#34; 17 ) 18 public Product getProduct(Long productId) { 19 String key = \u0026#34;product:\u0026#34; + productId; 20 21 // æŸ¥ç¼“å­˜ 22 Product product = redisTemplate.opsForValue().get(key); 23 if (product != null) { 24 return product; 25 } 26 27 // æŸ¥æ•°æ®åº“ 28 product = productMapper.selectById(productId); 29 if (product != null) { 30 redisTemplate.opsForValue().set(key, product, 1, TimeUnit.HOURS); 31 } 32 33 return product; 34 } 35 36 /** 37 * é™æµé™çº§å¤„ç† 38 */ 39 public Product getProductBlockHandler(Long productId, BlockException ex) { 40 log.warn(\u0026#34;è§¦å‘é™æµ: productId={}\u0026#34;, productId); 41 // è¿”å›é»˜è®¤å•†å“æˆ–æç¤ºä¿¡æ¯ 42 return getDefaultProduct(); 43 } 44 45 /** 46 * å¼‚å¸¸é™çº§å¤„ç† 47 */ 48 public Product getProductFallback(Long productId, Throwable ex) { 49 log.error(\u0026#34;æŸ¥è¯¢å¼‚å¸¸: productId={}\u0026#34;, productId, ex); 50 // è¿”å›é»˜è®¤å•†å“ 51 return getDefaultProduct(); 52 } 53} ç¼“å­˜æ›´æ–°ç­–ç•¥ ç­–ç•¥å¯¹æ¯” ç­–ç•¥ ä¸€è‡´æ€§ å®ç°å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ Cache Aside å¼±ä¸€è‡´æ€§ ç®€å• è¯»å¤šå†™å°‘ Read/Write Through å¼ºä¸€è‡´æ€§ å¤æ‚ è¯»å†™å‡è¡¡ Write Behind æœ€ç»ˆä¸€è‡´æ€§ å¤æ‚ å†™å¤šè¯»å°‘ Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰ 1// è¯»æ“ä½œ 2public User getUser(Long userId) { 3 String key = \u0026#34;user:\u0026#34; + userId; 4 5 // 1. æŸ¥ç¼“å­˜ 6 User user = redisTemplate.opsForValue().get(key); 7 if (user != null) { 8 return user; 9 } 10 11 // 2. æŸ¥æ•°æ®åº“ 12 user = userMapper.selectById(userId); 13 14 // 3. å†™å…¥ç¼“å­˜ 15 if (user != null) { 16 redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS); 17 } 18 19 return user; 20} 21 22// å†™æ“ä½œ 23public void updateUser(User user) { 24 // 1. æ›´æ–°æ•°æ®åº“ 25 userMapper.updateById(user); 26 27 // 2. åˆ é™¤ç¼“å­˜ 28 String key = \u0026#34;user:\u0026#34; + user.getId(); 29 redisTemplate.delete(key); 30} ä¸ºä»€ä¹ˆæ˜¯åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ\næ›´æ–°ç¼“å­˜å¯èƒ½æµªè´¹ï¼ˆæ›´æ–°åå¯èƒ½æ²¡äººæŸ¥è¯¢ï¼‰ å¹¶å‘æ›´æ–°å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ å»¶è¿ŸåŒåˆ  1public void updateUser(User user) { 2 String key = \u0026#34;user:\u0026#34; + user.getId(); 3 4 // 1. åˆ é™¤ç¼“å­˜ 5 redisTemplate.delete(key); 6 7 // 2. æ›´æ–°æ•°æ®åº“ 8 userMapper.updateById(user); 9 10 // 3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜ 11 CompletableFuture.runAsync(() -\u0026gt; { 12 try { 13 Thread.sleep(500); // å»¶è¿Ÿ500ms 14 redisTemplate.delete(key); 15 } catch (InterruptedException e) { 16 Thread.currentThread().interrupt(); 17 } 18 }); 19} ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿ŸåŒåˆ ï¼Ÿ\né˜²æ­¢ä»¥ä¸‹åœºæ™¯çš„æ•°æ®ä¸ä¸€è‡´ï¼š\n1æ—¶åˆ»1ï¼šçº¿ç¨‹Aåˆ é™¤ç¼“å­˜ 2æ—¶åˆ»2ï¼šçº¿ç¨‹BæŸ¥è¯¢ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰ 3æ—¶åˆ»3ï¼šçº¿ç¨‹BæŸ¥è¯¢æ•°æ®åº“ï¼ˆæ—§æ•°æ®ï¼‰ 4æ—¶åˆ»4ï¼šçº¿ç¨‹Aæ›´æ–°æ•°æ®åº“ 5æ—¶åˆ»5ï¼šçº¿ç¨‹Bå†™å…¥ç¼“å­˜ï¼ˆæ—§æ•°æ®ï¼‰ å»¶è¿ŸåŒåˆ å¯ä»¥åˆ é™¤çº¿ç¨‹Bå†™å…¥çš„æ—§æ•°æ®ã€‚\nç¼“å­˜ç›‘æ§ å…³é”®æŒ‡æ ‡ 1@Component 2public class CacheMonitor { 3 4 @Autowired 5 private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; 6 7 @Scheduled(fixedDelay = 60000) 8 public void monitor() { 9 RedisConnection connection = redisTemplate.getConnectionFactory().getConnection(); 10 Properties info = connection.info(); 11 12 // 1. å†…å­˜ä½¿ç”¨ 13 long usedMemory = Long.parseLong(info.getProperty(\u0026#34;used_memory\u0026#34;)); 14 long maxMemory = Long.parseLong(info.getProperty(\u0026#34;maxmemory\u0026#34;)); 15 double memoryUsageRate = (double) usedMemory / maxMemory * 100; 16 17 // 2. å‘½ä¸­ç‡ 18 long hits = Long.parseLong(info.getProperty(\u0026#34;keyspace_hits\u0026#34;)); 19 long misses = Long.parseLong(info.getProperty(\u0026#34;keyspace_misses\u0026#34;)); 20 double hitRate = (double) hits / (hits + misses) * 100; 21 22 // 3. è¿æ¥æ•° 23 int connectedClients = Integer.parseInt(info.getProperty(\u0026#34;connected_clients\u0026#34;)); 24 25 log.info(\u0026#34;Redisç›‘æ§ - å†…å­˜ä½¿ç”¨ç‡: {}%, å‘½ä¸­ç‡: {}%, è¿æ¥æ•°: {}\u0026#34;, 26 memoryUsageRate, hitRate, connectedClients); 27 28 // 4. å‘Šè­¦ 29 if (memoryUsageRate \u0026gt; 80) { 30 log.warn(\u0026#34;Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, memoryUsageRate); 31 } 32 if (hitRate \u0026lt; 80) { 33 log.warn(\u0026#34;Rediså‘½ä¸­ç‡è¿‡ä½: {}%\u0026#34;, hitRate); 34 } 35 } 36} æœ€ä½³å®è·µ 1. åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´\nçƒ­ç‚¹æ•°æ®ï¼š1-2å°æ—¶ æ™®é€šæ•°æ®ï¼š30åˆ†é’Ÿ-1å°æ—¶ å†·æ•°æ®ï¼š5-10åˆ†é’Ÿ 2. ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„\nStringï¼šç®€å•key-value Hashï¼šå¯¹è±¡å­˜å‚¨ Listï¼šåˆ—è¡¨ã€é˜Ÿåˆ— Setï¼šå»é‡ã€äº¤é›† ZSetï¼šæ’è¡Œæ¦œ 3. é¿å…å¤§key\nå•ä¸ªkeyä¸è¶…è¿‡10KB é›†åˆå…ƒç´ ä¸è¶…è¿‡5000ä¸ª ä½¿ç”¨SCANä»£æ›¿KEYS 4. è®¾ç½®å†…å­˜æ·˜æ±°ç­–ç•¥\n1# redis.conf 2maxmemory 2gb 3maxmemory-policy allkeys-lru 5. ç›‘æ§å‘Šè­¦\nå†…å­˜ä½¿ç”¨ç‡ \u0026gt; 80% å‘½ä¸­ç‡ \u0026lt; 80% æ…¢æŸ¥è¯¢ \u0026gt; 10ms é¿å‘æç¤ºï¼š ç¼“å­˜ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¸è¦ä¸ºäº†ç¼“å­˜è€Œç¼“å­˜ã€‚åªæœ‰é«˜é¢‘è®¿é—®ã€å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®æ‰é€‚åˆç¼“å­˜ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜çš„æ•°æ®ï¼Œç›´æ¥æŸ¥æ•°æ®åº“å¯èƒ½æ›´åˆé€‚ã€‚\næ€»ç»“ä¸æ€è€ƒ Redis ç¼“å­˜æ¶æ„çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€ ä½¿ç”¨äº’æ–¥é”æˆ–é€»è¾‘è¿‡æœŸé˜²æ­¢ç¼“å­˜å‡»ç©¿ ä½¿ç”¨è¿‡æœŸæ—¶é—´éšæœºåŒ–å’Œå¤šçº§ç¼“å­˜é˜²æ­¢ç¼“å­˜é›ªå´© ä½¿ç”¨ Cache Aside æ¨¡å¼æ›´æ–°ç¼“å­˜ ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œå†…å­˜ä½¿ç”¨ç‡ ç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„åˆ©å™¨ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¤æ‚åº¦ã€‚åœ¨è®¾è®¡ç¼“å­˜æ¶æ„æ—¶è¦æƒè¡¡ï¼š\næ˜¯å¦çœŸçš„éœ€è¦ç¼“å­˜ï¼Ÿ ç¼“å­˜ä»€ä¹ˆæ•°æ®ï¼Ÿ å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ å¦‚ä½•åº”å¯¹ç¼“å­˜å¤±æ•ˆï¼Ÿ ä¸‹æ¬¡å½“ä½ çš„ç³»ç»Ÿé¢ä¸´é«˜å¹¶å‘æŒ‘æˆ˜æ—¶ï¼Œä¸å¦¨è¯•è¯•æœ¬æ–‡ä»‹ç»çš„ç¼“å­˜æ¶æ„æ–¹æ¡ˆï¼Œè®©ç³»ç»Ÿæ€§èƒ½æ›´ä¸Šä¸€å±‚æ¥¼ã€‚\n","permalink":"http://localhost:1313/posts/2025/03/redis-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E4%BB%8E%E7%A9%BF%E9%80%8F%E5%88%B0%E9%9B%AA%E5%B4%A9%E7%9A%84%E5%85%A8%E9%93%BE%E8%B7%AF%E9%98%B2%E6%8A%A4/","summary":"\u003cp\u003eåœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œç¼“å­˜æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚ä½†ç¼“å­˜ä½¿ç”¨ä¸å½“ä¼šå¼•å‘ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æè¿™äº›é—®é¢˜çš„åŸç†ï¼Œå¹¶æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„æœ¬è´¨åŒºåˆ«\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å¸ƒéš†è¿‡æ»¤å™¨ã€äº’æ–¥é”ç­‰é˜²æŠ¤æ‰‹æ®µ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„ç¼“å­˜æ¶æ„\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç¼“å­˜é¢„çƒ­ã€é™çº§ç­‰æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¼“å­˜çš„ä¸‰å¤§é—®é¢˜\"\u003eç¼“å­˜çš„ä¸‰å¤§é—®é¢˜\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜å¯¹æ¯”\"\u003eé—®é¢˜å¯¹æ¯”\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eé—®é¢˜\u003c/th\u003e\n          \u003cth\u003eåŸå› \u003c/th\u003e\n          \u003cth\u003eå½±å“\u003c/th\u003e\n          \u003cth\u003eè§£å†³æ–¹æ¡ˆ\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜ç©¿é€\u003c/td\u003e\n          \u003ctd\u003eæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\u003c/td\u003e\n          \u003ctd\u003eå¤§é‡è¯·æ±‚æ‰“åˆ°DB\u003c/td\u003e\n          \u003ctd\u003eå¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜å‡»ç©¿\u003c/td\u003e\n          \u003ctd\u003eçƒ­ç‚¹keyè¿‡æœŸ\u003c/td\u003e\n          \u003ctd\u003eç¬é—´å¤§é‡è¯·æ±‚æ‰“åˆ°DB\u003c/td\u003e\n          \u003ctd\u003eäº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eç¼“å­˜é›ªå´©\u003c/td\u003e\n          \u003ctd\u003eå¤§é‡keyåŒæ—¶è¿‡æœŸ\u003c/td\u003e\n          \u003ctd\u003eDBå‹åŠ›éª¤å¢\u003c/td\u003e\n          \u003ctd\u003eè¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¼“å­˜ç©¿é€æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\"\u003eç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜åœºæ™¯\"\u003eé—®é¢˜åœºæ™¯\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003e1000000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æŸ¥DB\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæµç¨‹ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eè¯·æ±‚ â†’ æŸ¥ç¼“å­˜ï¼ˆæœªå‘½ä¸­ï¼‰â†’ æŸ¥æ•°æ®åº“ï¼ˆæœªå‘½ä¸­ï¼‰â†’ è¿”å›null\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\u003c/p\u003e\n\u003ch3 id=\"è§£å†³æ–¹æ¡ˆ1å¸ƒéš†è¿‡æ»¤å™¨\"\u003eè§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eåŸç†ï¼š\u003c/strong\u003e ç”¨ä½æ•°ç»„åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBloomFilterConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// é¢„æœŸå…ƒç´ æ•°é‡ï¼š1000ä¸‡ï¼Œè¯¯åˆ¤ç‡ï¼š0.01%\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eFunnels\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003elongFunnel\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10000000\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003e0001\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserIds\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectAllIds\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003euserIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eforEach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eput\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBloomFilter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRedisTemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserMapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003euserBloomFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emightContain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æŸ¥ç¼“å­˜\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;user:\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. æŸ¥æ•°æ®åº“\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eHOURS\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eä¼˜ç‚¹ï¼š\u003c/strong\u003e\u003c/p\u003e","title":"Redis ç¼“å­˜æ¶æ„ï¼šä»ç©¿é€åˆ°é›ªå´©çš„å…¨é“¾è·¯é˜²æŠ¤"},{"content":"å½“å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§åˆ«æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆã€‚æœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ ShardingSphere å®ç°åˆ†åº“åˆ†è¡¨ï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒçš„å®æˆ˜ç»éªŒã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒæ¦‚å¿µå’Œåº”ç”¨åœºæ™¯ æŒæ¡ ShardingSphere çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³• å­¦ä¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡ç­–ç•¥ äº†è§£åˆ†åº“åˆ†è¡¨çš„æœ€ä½³å®è·µå’Œå¸¸è§é—®é¢˜ ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ åœºæ™¯ï¼šè®¢å•è¡¨æ•°æ®çˆ†ç‚¸\nç”µå•†ç³»ç»Ÿçš„è®¢å•è¡¨ï¼Œæ¯å¤©æ–°å¢10ä¸‡æ¡æ•°æ®ï¼Œä¸€å¹´å°±æ˜¯3600ä¸‡æ¡ã€‚éšç€æ•°æ®é‡å¢é•¿ï¼š\næŸ¥è¯¢å˜æ…¢ï¼šå•è¡¨æŸ¥è¯¢ä»æ¯«ç§’çº§å˜æˆç§’çº§ ç´¢å¼•å¤±æ•ˆï¼šB+æ ‘å±‚çº§å¢åŠ ï¼Œç´¢å¼•æ•ˆç‡ä¸‹é™ é”ç«äº‰ï¼šå¤§è¡¨çš„é”ç²’åº¦å¤§ï¼Œå¹¶å‘æ€§èƒ½å·® å¤‡ä»½å›°éš¾ï¼šå•è¡¨å¤‡ä»½æ—¶é—´è¿‡é•¿ ä¼ ç»Ÿä¼˜åŒ–æ–¹æ¡ˆçš„å±€é™\n1-- ä¼˜åŒ–ç´¢å¼• 2CREATE INDEX idx_user_id_create_time ON orders(user_id, create_time); 3 4-- åˆ†åŒºè¡¨ 5ALTER TABLE orders PARTITION BY RANGE (YEAR(create_time)) ( 6 PARTITION p2023 VALUES LESS THAN (2024), 7 PARTITION p2024 VALUES LESS THAN (2025) 8); è¿™äº›æ–¹æ¡ˆåªèƒ½ç¼“è§£é—®é¢˜ï¼Œæ— æ³•æ ¹æœ¬è§£å†³ã€‚å½“æ•°æ®é‡è¾¾åˆ°äº¿çº§æ—¶ï¼Œåˆ†åº“åˆ†è¡¨æ˜¯å¿…ç„¶é€‰æ‹©ã€‚\nåˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ å‚ç›´æ‹†åˆ† vs æ°´å¹³æ‹†åˆ† å‚ç›´æ‹†åˆ†ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†\n1åŸå§‹æ•°æ®åº“ 2â”œâ”€â”€ ç”¨æˆ·è¡¨ 3â”œâ”€â”€ è®¢å•è¡¨ 4â”œâ”€â”€ å•†å“è¡¨ 5â””â”€â”€ æ”¯ä»˜è¡¨ 6 7æ‹†åˆ†å 8â”œâ”€â”€ ç”¨æˆ·åº“ 9â”‚ â””â”€â”€ ç”¨æˆ·è¡¨ 10â”œâ”€â”€ è®¢å•åº“ 11â”‚ â””â”€â”€ è®¢å•è¡¨ 12â”œâ”€â”€ å•†å“åº“ 13â”‚ â””â”€â”€ å•†å“è¡¨ 14â””â”€â”€ æ”¯ä»˜åº“ 15 â””â”€â”€ æ”¯ä»˜è¡¨ æ°´å¹³æ‹†åˆ†ï¼šæŒ‰æ•°æ®è¡Œæ‹†åˆ†\n1è®¢å•è¡¨ï¼ˆ1äº¿æ¡æ•°æ®ï¼‰ 2 3æ‹†åˆ†å 4â”œâ”€â”€ orders_0ï¼ˆ2500ä¸‡æ¡ï¼‰ 5â”œâ”€â”€ orders_1ï¼ˆ2500ä¸‡æ¡ï¼‰ 6â”œâ”€â”€ orders_2ï¼ˆ2500ä¸‡æ¡ï¼‰ 7â””â”€â”€ orders_3ï¼ˆ2500ä¸‡æ¡ï¼‰ åˆ†ç‰‡é”®çš„é€‰æ‹© åˆ†ç‰‡é”®å†³å®šäº†æ•°æ®å¦‚ä½•åˆ†å¸ƒï¼Œé€‰æ‹©ä¸å½“ä¼šå¯¼è‡´æ•°æ®å€¾æ–œã€‚\nå¸¸è§åˆ†ç‰‡é”®ï¼š\nç”¨æˆ·IDï¼šé€‚åˆç”¨æˆ·ç»´åº¦æŸ¥è¯¢ è®¢å•IDï¼šé€‚åˆè®¢å•ç»´åº¦æŸ¥è¯¢ æ—¶é—´ï¼šé€‚åˆæ—¶é—´èŒƒå›´æŸ¥è¯¢ é€‰æ‹©åŸåˆ™ï¼š\né«˜é¢‘æŸ¥è¯¢å­—æ®µ æ•°æ®åˆ†å¸ƒå‡åŒ€ é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ ShardingSphere å¿«é€Ÿå…¥é—¨ å¼•å…¥ä¾èµ– 1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;org.apache.shardingsphere\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;shardingsphere-jdbc-core-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;5.3.2\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; åŸºç¡€é…ç½® 1spring: 2 shardingsphere: 3 # æ•°æ®æºé…ç½® 4 datasource: 5 names: ds0,ds1 6 ds0: 7 type: com.zaxxer.hikari.HikariDataSource 8 driver-class-name: com.mysql.cj.jdbc.Driver 9 jdbc-url: jdbc:mysql://localhost:3306/order_db_0 10 username: root 11 password: root 12 ds1: 13 type: com.zaxxer.hikari.HikariDataSource 14 driver-class-name: com.mysql.cj.jdbc.Driver 15 jdbc-url: jdbc:mysql://localhost:3306/order_db_1 16 username: root 17 password: root 18 19 # åˆ†ç‰‡è§„åˆ™ 20 rules: 21 sharding: 22 tables: 23 orders: 24 # å®é™…èŠ‚ç‚¹ 25 actual-data-nodes: ds$-\u0026gt;{0..1}.orders_$-\u0026gt;{0..3} 26 # åˆ†åº“ç­–ç•¥ 27 database-strategy: 28 standard: 29 sharding-column: user_id 30 sharding-algorithm-name: database-inline 31 # åˆ†è¡¨ç­–ç•¥ 32 table-strategy: 33 standard: 34 sharding-column: order_id 35 sharding-algorithm-name: table-inline 36 37 # åˆ†ç‰‡ç®—æ³• 38 sharding-algorithms: 39 database-inline: 40 type: INLINE 41 props: 42 algorithm-expression: ds$-\u0026gt;{user_id % 2} 43 table-inline: 44 type: INLINE 45 props: 46 algorithm-expression: orders_$-\u0026gt;{order_id % 4} 47 48 # å±æ€§é…ç½® 49 props: 50 sql-show: true å®ä½“ç±» 1@Data 2@TableName(\u0026#34;orders\u0026#34;) 3public class Order { 4 private Long orderId; 5 private Long userId; 6 private BigDecimal amount; 7 private Integer status; 8 private LocalDateTime createTime; 9} ä½¿ç”¨ç¤ºä¾‹ 1@Service 2public class OrderService { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 /** 8 * æ’å…¥è®¢å• 9 * ShardingSphere ä¼šæ ¹æ® user_id å’Œ order_id è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”çš„åº“è¡¨ 10 */ 11 public void createOrder(Order order) { 12 orderMapper.insert(order); 13 } 14 15 /** 16 * æ ¹æ®è®¢å•IDæŸ¥è¯¢ 17 * å•åˆ†ç‰‡æŸ¥è¯¢ï¼Œæ€§èƒ½æœ€ä¼˜ 18 */ 19 public Order getById(Long orderId) { 20 return orderMapper.selectById(orderId); 21 } 22 23 /** 24 * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è®¢å•åˆ—è¡¨ 25 * å•åº“å¤šè¡¨æŸ¥è¯¢ï¼Œéœ€è¦åˆå¹¶ç»“æœ 26 */ 27 public List\u0026lt;Order\u0026gt; listByUserId(Long userId) { 28 return orderMapper.selectList( 29 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 30 .eq(Order::getUserId, userId) 31 .orderByDesc(Order::getCreateTime) 32 ); 33 } 34} åˆ†ç‰‡ç­–ç•¥è¯¦è§£ 1. æ ‡å‡†åˆ†ç‰‡ç­–ç•¥ï¼ˆStandardï¼‰ é€‚ç”¨äºå•ä¸€åˆ†ç‰‡é”®çš„åœºæ™¯ã€‚\n1database-strategy: 2 standard: 3 sharding-column: user_id 4 sharding-algorithm-name: database-mod å–æ¨¡ç®—æ³•\n1sharding-algorithms: 2 database-mod: 3 type: MOD 4 props: 5 sharding-count: 2 å“ˆå¸Œå–æ¨¡ç®—æ³•\n1sharding-algorithms: 2 database-hash-mod: 3 type: HASH_MOD 4 props: 5 sharding-count: 2 2. å¤åˆåˆ†ç‰‡ç­–ç•¥ï¼ˆComplexï¼‰ é€‚ç”¨äºå¤šä¸ªåˆ†ç‰‡é”®çš„åœºæ™¯ã€‚\n1database-strategy: 2 complex: 3 sharding-columns: user_id,order_id 4 sharding-algorithm-name: complex-inline 1sharding-algorithms: 2 complex-inline: 3 type: CLASS_BASED 4 props: 5 strategy: COMPLEX 6 algorithm-class-name: com.example.ComplexShardingAlgorithm è‡ªå®šä¹‰å¤åˆç®—æ³•\n1public class ComplexShardingAlgorithm implements ComplexKeysShardingAlgorithm\u0026lt;Long\u0026gt; { 2 3 @Override 4 public Collection\u0026lt;String\u0026gt; doSharding( 5 Collection\u0026lt;String\u0026gt; availableTargetNames, 6 ComplexKeysShardingValue\u0026lt;Long\u0026gt; shardingValue) { 7 8 // è·å–åˆ†ç‰‡é”®å€¼ 9 Map\u0026lt;String, Collection\u0026lt;Long\u0026gt;\u0026gt; columnNameAndShardingValuesMap = 10 shardingValue.getColumnNameAndShardingValuesMap(); 11 12 Collection\u0026lt;Long\u0026gt; userIds = columnNameAndShardingValuesMap.get(\u0026#34;user_id\u0026#34;); 13 Collection\u0026lt;Long\u0026gt; orderIds = columnNameAndShardingValuesMap.get(\u0026#34;order_id\u0026#34;); 14 15 // è‡ªå®šä¹‰åˆ†ç‰‡é€»è¾‘ 16 Set\u0026lt;String\u0026gt; result = new HashSet\u0026lt;\u0026gt;(); 17 for (Long userId : userIds) { 18 for (Long orderId : orderIds) { 19 String suffix = String.valueOf((userId + orderId) % 4); 20 result.addAll(availableTargetNames.stream() 21 .filter(name -\u0026gt; name.endsWith(suffix)) 22 .collect(Collectors.toList())); 23 } 24 } 25 return result; 26 } 27} 3. èŒƒå›´åˆ†ç‰‡ç­–ç•¥ï¼ˆRangeï¼‰ é€‚ç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢ã€‚\n1table-strategy: 2 standard: 3 sharding-column: create_time 4 sharding-algorithm-name: table-range 1sharding-algorithms: 2 table-range: 3 type: CLASS_BASED 4 props: 5 strategy: STANDARD 6 algorithm-class-name: com.example.RangeShardingAlgorithm æŒ‰æœˆåˆ†ç‰‡\n1public class RangeShardingAlgorithm implements StandardShardingAlgorithm\u0026lt;LocalDateTime\u0026gt; { 2 3 @Override 4 public String doSharding( 5 Collection\u0026lt;String\u0026gt; availableTargetNames, 6 PreciseShardingValue\u0026lt;LocalDateTime\u0026gt; shardingValue) { 7 8 LocalDateTime createTime = shardingValue.getValue(); 9 int month = createTime.getMonthValue(); 10 String suffix = String.format(\u0026#34;%02d\u0026#34;, month); 11 12 return availableTargetNames.stream() 13 .filter(name -\u0026gt; name.endsWith(suffix)) 14 .findFirst() 15 .orElseThrow(() -\u0026gt; new IllegalArgumentException(\u0026#34;æ‰¾ä¸åˆ°å¯¹åº”çš„åˆ†ç‰‡è¡¨\u0026#34;)); 16 } 17 18 @Override 19 public Collection\u0026lt;String\u0026gt; doSharding( 20 Collection\u0026lt;String\u0026gt; availableTargetNames, 21 RangeShardingValue\u0026lt;LocalDateTime\u0026gt; shardingValue) { 22 23 Range\u0026lt;LocalDateTime\u0026gt; range = shardingValue.getValueRange(); 24 LocalDateTime start = range.lowerEndpoint(); 25 LocalDateTime end = range.upperEndpoint(); 26 27 Set\u0026lt;String\u0026gt; result = new HashSet\u0026lt;\u0026gt;(); 28 for (int month = start.getMonthValue(); month \u0026lt;= end.getMonthValue(); month++) { 29 String suffix = String.format(\u0026#34;%02d\u0026#34;, month); 30 result.addAll(availableTargetNames.stream() 31 .filter(name -\u0026gt; name.endsWith(suffix)) 32 .collect(Collectors.toList())); 33 } 34 return result; 35 } 36} åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆ åˆ†åº“åˆ†è¡¨åï¼Œè‡ªå¢ä¸»é”®ä¼šå†²çªï¼Œéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®ã€‚\nSnowflake ç®—æ³• 1rules: 2 sharding: 3 tables: 4 orders: 5 key-generate-strategy: 6 column: order_id 7 key-generator-name: snowflake 8 9 key-generators: 10 snowflake: 11 type: SNOWFLAKE 12 props: 13 worker-id: 1 è‡ªå®šä¹‰ä¸»é”®ç”Ÿæˆå™¨ 1public class CustomKeyGenerator implements KeyGenerateAlgorithm { 2 3 @Override 4 public Comparable\u0026lt;?\u0026gt; generateKey() { 5 // æ—¶é—´æˆ³ï¼ˆ41ä½ï¼‰+ æœºå™¨IDï¼ˆ10ä½ï¼‰+ åºåˆ—å·ï¼ˆ12ä½ï¼‰ 6 long timestamp = System.currentTimeMillis(); 7 long workerId = getWorkerId(); 8 long sequence = getSequence(); 9 10 return (timestamp \u0026lt;\u0026lt; 22) | (workerId \u0026lt;\u0026lt; 12) | sequence; 11 } 12} è¯»å†™åˆ†ç¦» ShardingSphere æ”¯æŒä¸»ä»è¯»å†™åˆ†ç¦»ã€‚\n1rules: 2 readwrite-splitting: 3 data-sources: 4 ds0: 5 type: Static 6 props: 7 write-data-source-name: ds0-master 8 read-data-source-names: ds0-slave0,ds0-slave1 9 load-balancer-name: round-robin 10 ds1: 11 type: Static 12 props: 13 write-data-source-name: ds1-master 14 read-data-source-names: ds1-slave0,ds1-slave1 15 load-balancer-name: round-robin 16 17 load-balancers: 18 round-robin: 19 type: ROUND_ROBIN å¼ºåˆ¶ä¸»åº“æŸ¥è¯¢\n1// ä½¿ç”¨ HintManager å¼ºåˆ¶è·¯ç”±åˆ°ä¸»åº“ 2HintManager hintManager = HintManager.getInstance(); 3hintManager.setWriteRouteOnly(); 4try { 5 Order order = orderMapper.selectById(orderId); 6} finally { 7 hintManager.close(); 8} è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ï¼šå…¨è¡¨æ‰«æ 1// ä¸å¸¦åˆ†ç‰‡é”®çš„æŸ¥è¯¢ï¼Œä¼šæ‰«ææ‰€æœ‰åˆ†ç‰‡ 2List\u0026lt;Order\u0026gt; orders = orderMapper.selectList( 3 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 4 .eq(Order::getStatus, 1) 5); è§£å†³æ–¹æ¡ˆ1ï¼šå†—ä½™åˆ†ç‰‡é”® 1// åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­æ·»åŠ åˆ†ç‰‡é”® 2List\u0026lt;Order\u0026gt; orders = orderMapper.selectList( 3 new LambdaQueryWrapper\u0026lt;Order\u0026gt;() 4 .eq(Order::getUserId, userId) // åˆ†ç‰‡é”® 5 .eq(Order::getStatus, 1) 6); è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨ Hint 1// æ‰‹åŠ¨æŒ‡å®šåˆ†ç‰‡ 2HintManager hintManager = HintManager.getInstance(); 3hintManager.addDatabaseShardingValue(\u0026#34;orders\u0026#34;, \u0026#34;user_id\u0026#34;, userId); 4hintManager.addTableShardingValue(\u0026#34;orders\u0026#34;, \u0026#34;order_id\u0026#34;, orderId); 5try { 6 Order order = orderMapper.selectById(orderId); 7} finally { 8 hintManager.close(); 9} è§£å†³æ–¹æ¡ˆ3ï¼šå»ºç«‹æ˜ å°„è¡¨ 1-- è®¢å•çŠ¶æ€æ˜ å°„è¡¨ï¼ˆä¸åˆ†ç‰‡ï¼‰ 2CREATE TABLE order_status_mapping ( 3 order_id BIGINT PRIMARY KEY, 4 user_id BIGINT, 5 status INT, 6 INDEX idx_status (status) 7); 1// å…ˆæŸ¥æ˜ å°„è¡¨è·å–åˆ†ç‰‡é”® 2List\u0026lt;Long\u0026gt; orderIds = mappingMapper.selectOrderIdsByStatus(status); 3 4// å†æ ¹æ®åˆ†ç‰‡é”®æŸ¥è¯¢è¯¦æƒ… 5List\u0026lt;Order\u0026gt; orders = orderIds.stream() 6 .map(orderMapper::selectById) 7 .collect(Collectors.toList()); åˆ†å¸ƒå¼äº‹åŠ¡ ShardingSphere æ”¯æŒ XA å’Œ Saga ä¸¤ç§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nXA äº‹åŠ¡ 1rules: 2 transaction: 3 default-type: XA 4 provider-type: Atomikos 1@Transactional 2public void createOrderWithXA(Order order, OrderItem item) { 3 // è·¨åˆ†ç‰‡çš„äº‹åŠ¡æ“ä½œ 4 orderMapper.insert(order); 5 orderItemMapper.insert(item); 6} Saga äº‹åŠ¡ 1rules: 2 transaction: 3 default-type: BASE 4 provider-type: Seata æ¶æ„æ€è€ƒï¼š XA äº‹åŠ¡ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½è¾ƒå·®ï¼›Saga äº‹åŠ¡ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½æ›´å¥½ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Sagaï¼Œé€šè¿‡è¡¥å¿æœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚\næ•°æ®è¿ç§»æ–¹æ¡ˆ æ–¹æ¡ˆä¸€ï¼šåŒå†™ + æ•°æ®æ ¡éªŒ 1@Service 2public class OrderMigrationService { 3 4 @Autowired 5 private OrderMapper oldOrderMapper; // æ—§è¡¨ 6 7 @Autowired 8 private OrderMapper newOrderMapper; // æ–°è¡¨ï¼ˆåˆ†ç‰‡ï¼‰ 9 10 /** 11 * åŒå†™é˜¶æ®µï¼šåŒæ—¶å†™å…¥æ—§è¡¨å’Œæ–°è¡¨ 12 */ 13 public void createOrder(Order order) { 14 // å†™å…¥æ—§è¡¨ 15 oldOrderMapper.insert(order); 16 17 // å¼‚æ­¥å†™å…¥æ–°è¡¨ 18 CompletableFuture.runAsync(() -\u0026gt; { 19 try { 20 newOrderMapper.insert(order); 21 } catch (Exception e) { 22 log.error(\u0026#34;æ–°è¡¨å†™å…¥å¤±è´¥\u0026#34;, e); 23 // è®°å½•å¤±è´¥æ—¥å¿—ï¼Œåç»­è¡¥å¿ 24 } 25 }); 26 } 27 28 /** 29 * æ•°æ®æ ¡éªŒï¼šå¯¹æ¯”æ–°æ—§è¡¨æ•°æ® 30 */ 31 public void verifyData(Long orderId) { 32 Order oldOrder = oldOrderMapper.selectById(orderId); 33 Order newOrder = newOrderMapper.selectById(orderId); 34 35 if (!Objects.equals(oldOrder, newOrder)) { 36 log.error(\u0026#34;æ•°æ®ä¸ä¸€è‡´: orderId={}\u0026#34;, orderId); 37 // è§¦å‘å‘Šè­¦ 38 } 39 } 40} æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Canal åŒæ­¥ 1# Canal é…ç½® 2canal: 3 server: 127.0.0.1:11111 4 destination: example 5 username: canal 6 password: canal 7 filter: order_db\\\\.orders 1@Component 2public class CanalDataSyncListener { 3 4 @Autowired 5 private OrderMapper shardingOrderMapper; 6 7 @CanalEventListener 8 public void onEvent(CanalEntry.Entry entry) { 9 if (entry.getEntryType() == CanalEntry.EntryType.ROWDATA) { 10 RowChange rowChange = RowChange.parseFrom(entry.getStoreValue()); 11 12 for (CanalEntry.RowData rowData : rowChange.getRowDatasList()) { 13 if (rowChange.getEventType() == CanalEntry.EventType.INSERT) { 14 Order order = parseOrder(rowData.getAfterColumnsList()); 15 shardingOrderMapper.insert(order); 16 } 17 } 18 } 19 } 20} æ€§èƒ½å¯¹æ¯” æµ‹è¯•ç¯å¢ƒ æ•°æ®é‡ï¼š5000ä¸‡æ¡ åˆ†ç‰‡é…ç½®ï¼š2åº“ Ã— 4è¡¨ = 8ä¸ªåˆ†ç‰‡ æ¯ä¸ªåˆ†ç‰‡ï¼š625ä¸‡æ¡æ•°æ® æŸ¥è¯¢æ€§èƒ½å¯¹æ¯” åœºæ™¯ å•è¡¨ åˆ†åº“åˆ†è¡¨ æå‡ ä¸»é”®æŸ¥è¯¢ 150ms 15ms 10å€ ç´¢å¼•æŸ¥è¯¢ 800ms 80ms 10å€ èŒƒå›´æŸ¥è¯¢ 2000ms 250ms 8å€ èšåˆæŸ¥è¯¢ 5000ms 800ms 6å€ å†™å…¥æ€§èƒ½å¯¹æ¯” åœºæ™¯ å•è¡¨ åˆ†åº“åˆ†è¡¨ æå‡ å•æ¡æ’å…¥ 5ms 6ms æŒå¹³ æ‰¹é‡æ’å…¥ï¼ˆ1000æ¡ï¼‰ 800ms 200ms 4å€ æœ€ä½³å®è·µ 1. åˆ†ç‰‡é”®é€‰æ‹©\nä¼˜å…ˆé€‰æ‹©é«˜é¢‘æŸ¥è¯¢å­—æ®µ ç¡®ä¿æ•°æ®åˆ†å¸ƒå‡åŒ€ é¿å…çƒ­ç‚¹æ•°æ® 2. é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢\nåœ¨æŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«åˆ†ç‰‡é”® ä½¿ç”¨æ˜ å°„è¡¨è¾…åŠ©æŸ¥è¯¢ åˆç†è®¾è®¡æ•°æ®æ¨¡å‹ 3. åˆ†ç‰‡æ•°é‡è§„åˆ’\nå•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨500ä¸‡ä»¥å†… é¢„ç•™æ‰©å±•ç©ºé—´ï¼ˆ2-3å€ï¼‰ åˆ†ç‰‡æ•°é‡å»ºè®®ä¸º2çš„å¹‚æ¬¡æ–¹ 4. ç›‘æ§å‘Šè­¦\nç›‘æ§å„åˆ†ç‰‡æ•°æ®é‡ ç›‘æ§æ…¢æŸ¥è¯¢ ç›‘æ§è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹ 5. ç°åº¦å‘å¸ƒ\nå…ˆè¿ç§»å†å²æ•°æ® å†å¼€å¯åŒå†™ æœ€ååˆ‡æ¢è¯»æµé‡ é¿å‘æç¤ºï¼š åˆ†åº“åˆ†è¡¨ä¸æ˜¯é“¶å¼¹ï¼Œä¼šå¢åŠ ç³»ç»Ÿå¤æ‚åº¦ã€‚åœ¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§ä¹‹å‰ï¼Œä¼˜å…ˆè€ƒè™‘ç´¢å¼•ä¼˜åŒ–ã€ç¼“å­˜ã€è¯»å†™åˆ†ç¦»ç­‰æ–¹æ¡ˆã€‚åªæœ‰åœ¨è¿™äº›æ–¹æ¡ˆéƒ½æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå†è€ƒè™‘åˆ†åº“åˆ†è¡¨ã€‚\næ€»ç»“ä¸æ€è€ƒ ShardingSphere åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒè¦ç‚¹ï¼š\né€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®ï¼Œé¿å…æ•°æ®å€¾æ–œ ä½¿ç”¨æ ‡å‡†åˆ†ç‰‡ç­–ç•¥ï¼Œç®€åŒ–é…ç½® é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½ ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®ï¼Œé¿å…IDå†²çª ç°åº¦è¿ç§»æ•°æ®ï¼Œé™ä½é£é™© åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¤æ‚åº¦ã€‚åœ¨å®æ–½å‰è¦å……åˆ†è¯„ä¼°ï¼š\næ˜¯å¦çœŸçš„éœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ åˆ†ç‰‡é”®å¦‚ä½•é€‰æ‹©ï¼Ÿ å¦‚ä½•å¤„ç†è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼Ÿ å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ ä¸‹æ¬¡å½“ä½ çš„å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§æ—¶ï¼Œä¸å¦¨è¯•è¯• ShardingSphereï¼Œè®©æ•°æ®åº“æ€§èƒ½é‡å›å·…å³°ã€‚\n","permalink":"http://localhost:1313/posts/2025/02/shardingsphere-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9A%84%E7%94%9F%E4%BA%A7%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eå½“å•è¡¨æ•°æ®é‡è¾¾åˆ°åƒä¸‡çº§åˆ«æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§æ•°æ®é‡é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆã€‚æœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ ShardingSphere å®ç°åˆ†åº“åˆ†è¡¨ï¼Œå¹¶åˆ†äº«ç”Ÿäº§ç¯å¢ƒçš„å®æˆ˜ç»éªŒã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒæ¦‚å¿µå’Œåº”ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ ShardingSphere çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†åº“åˆ†è¡¨çš„æœ€ä½³å®è·µå’Œå¸¸è§é—®é¢˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨\"\u003eä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼šè®¢å•è¡¨æ•°æ®çˆ†ç‚¸\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç”µå•†ç³»ç»Ÿçš„è®¢å•è¡¨ï¼Œæ¯å¤©æ–°å¢10ä¸‡æ¡æ•°æ®ï¼Œä¸€å¹´å°±æ˜¯3600ä¸‡æ¡ã€‚éšç€æ•°æ®é‡å¢é•¿ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæŸ¥è¯¢å˜æ…¢\u003c/strong\u003eï¼šå•è¡¨æŸ¥è¯¢ä»æ¯«ç§’çº§å˜æˆç§’çº§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç´¢å¼•å¤±æ•ˆ\u003c/strong\u003eï¼šB+æ ‘å±‚çº§å¢åŠ ï¼Œç´¢å¼•æ•ˆç‡ä¸‹é™\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eé”ç«äº‰\u003c/strong\u003eï¼šå¤§è¡¨çš„é”ç²’åº¦å¤§ï¼Œå¹¶å‘æ€§èƒ½å·®\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå¤‡ä»½å›°éš¾\u003c/strong\u003eï¼šå•è¡¨å¤‡ä»½æ—¶é—´è¿‡é•¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿä¼˜åŒ–æ–¹æ¡ˆçš„å±€é™\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e-- ä¼˜åŒ–ç´¢å¼•\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCREATE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eINDEX\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eidx_user_id_create_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eON\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser_id\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e-- åˆ†åŒºè¡¨\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eALTER\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorders\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eBY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRANGE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eYEAR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ep2023\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eLESS\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTHAN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2024\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePARTITION\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ep2024\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eLESS\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTHAN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2025\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™äº›æ–¹æ¡ˆåªèƒ½ç¼“è§£é—®é¢˜ï¼Œæ— æ³•æ ¹æœ¬è§£å†³ã€‚å½“æ•°æ®é‡è¾¾åˆ°äº¿çº§æ—¶ï¼Œåˆ†åº“åˆ†è¡¨æ˜¯å¿…ç„¶é€‰æ‹©ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ\"\u003eåˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003ch3 id=\"å‚ç›´æ‹†åˆ†-vs-æ°´å¹³æ‹†åˆ†\"\u003eå‚ç›´æ‹†åˆ† vs æ°´å¹³æ‹†åˆ†\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eå‚ç›´æ‹†åˆ†\u003c/strong\u003eï¼šæŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003eåŸå§‹æ•°æ®åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ ç”¨æˆ·è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ è®¢å•è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ å•†å“è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ æ”¯ä»˜è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003eæ‹†åˆ†å\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ ç”¨æˆ·åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ ç”¨æˆ·è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ è®¢å•åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ è®¢å•è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ å•†å“åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ å•†å“è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ æ”¯ä»˜åº“\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e    â””â”€â”€ æ”¯ä»˜è¡¨\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ°´å¹³æ‹†åˆ†\u003c/strong\u003eï¼šæŒ‰æ•°æ®è¡Œæ‹†åˆ†\u003c/p\u003e","title":"ShardingSphere åˆ†åº“åˆ†è¡¨çš„ç”Ÿäº§å®æˆ˜"},{"content":"åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°çš„é…ç½®å¾€å¾€éœ€è¦æ ¹æ®å®é™…è´Ÿè½½åŠ¨æ€è°ƒæ•´ã€‚ç¡¬ç¼–ç çš„å‚æ•°é…ç½®ç¼ºä¹çµæ´»æ€§ï¼Œé‡å¯æœåŠ¡åˆä¼šå½±å“ä¸šåŠ¡ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•è®¾è®¡ä¸€ä¸ªçº¿ç¨‹æ± ç®¡ç†åå°ï¼Œå®ç°å‚æ•°çš„åŠ¨æ€é…ç½®å’Œå®æ—¶ç›‘æ§ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£çº¿ç¨‹æ± å‚æ•°åŠ¨æ€è°ƒæ•´çš„åŸç†ä¸å®ç° æŒæ¡çº¿ç¨‹æ± ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†ä¸å±•ç¤º å­¦ä¼šè®¾è®¡ç”Ÿäº§çº§çš„çº¿ç¨‹æ± ç®¡ç†å¹³å° äº†è§£çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜çš„æœ€ä½³å®è·µ ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®ï¼Ÿ åœºæ™¯ä¸€ï¼šæµé‡çªå¢\nåŒåä¸€æœŸé—´ï¼Œè®¢å•å¤„ç†çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º 10ï¼Œæœ€å¤§çº¿ç¨‹æ•° 20ã€‚çªç„¶æµé‡æš´å¢ï¼Œé˜Ÿåˆ—å †ç§¯ä¸¥é‡ï¼Œå¯¼è‡´è®¢å•å¤„ç†å»¶è¿Ÿã€‚\nå¦‚æœèƒ½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼Œå°†æ ¸å¿ƒçº¿ç¨‹æ•°è°ƒæ•´ä¸º 50ï¼Œæœ€å¤§çº¿ç¨‹æ•°è°ƒæ•´ä¸º 100ï¼Œå°±èƒ½å¿«é€Ÿåº”å¯¹æµé‡é«˜å³°ã€‚\nåœºæ™¯äºŒï¼šèµ„æºæµªè´¹\nå‡Œæ™¨æ—¶æ®µæµé‡å¾ˆä½ï¼Œä½†çº¿ç¨‹æ± ä»ç„¶ä¿æŒé«˜å³°æœŸçš„é…ç½®ï¼Œæµªè´¹äº†å¤§é‡ç³»ç»Ÿèµ„æºã€‚\nä¼ ç»Ÿåšæ³•çš„é—®é¢˜\n1@Configuration 2public class ThreadPoolConfig { 3 @Bean(\u0026#34;orderThreadPool\u0026#34;) 4 public ThreadPoolExecutor orderThreadPool() { 5 return new ThreadPoolExecutor( 6 10, // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç  7 20, // æœ€å¤§çº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç  8 60, TimeUnit.SECONDS, 9 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 10 new ThreadFactoryBuilder().setNameFormat(\u0026#34;order-pool-%d\u0026#34;).build(), 11 new ThreadPoolExecutor.CallerRunsPolicy() 12 ); 13 } 14} é—®é¢˜ï¼š\nå‚æ•°ç¡¬ç¼–ç ï¼Œæ— æ³•åŠ¨æ€è°ƒæ•´ è°ƒæ•´å‚æ•°éœ€è¦é‡å¯æœåŠ¡ ç¼ºä¹ç›‘æ§ï¼Œæ— æ³•äº†è§£çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ ç³»ç»Ÿæ¶æ„è®¾è®¡ æ•´ä½“æ¶æ„ 1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ Admin ç®¡ç†åå° â”‚ 3â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 4â”‚ â”‚ çº¿ç¨‹æ± åˆ—è¡¨ â”‚ â”‚ å®æ—¶ç›‘æ§ â”‚ â”‚ å‚æ•°è°ƒæ•´ â”‚ â”‚ 5â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 6â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 7 â†“ HTTP API 8â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 9â”‚ Spring Boot åº”ç”¨ â”‚ 10â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 11â”‚ â”‚ ThreadPoolRegistry â”‚ â”‚ 12â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ 13â”‚ â”‚ â”‚ è®¢å•çº¿ç¨‹æ± â”‚ â”‚ æ”¯ä»˜çº¿ç¨‹æ± â”‚ â”‚ é€šçŸ¥çº¿ç¨‹æ± â”‚ â”‚ â”‚ 14â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ 15â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 16â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 17â”‚ â”‚ ThreadPoolMonitor â”‚ â”‚ 18â”‚ â”‚ (å®šæ—¶é‡‡é›†æŒ‡æ ‡ï¼Œä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ) â”‚ â”‚ 19â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 20â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒç»„ä»¶ ThreadPoolRegistryï¼šçº¿ç¨‹æ± æ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†æ‰€æœ‰çº¿ç¨‹æ± å®ä¾‹ ThreadPoolMonitorï¼šç›‘æ§ç»„ä»¶ï¼Œå®šæ—¶é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ ThreadPoolControllerï¼šREST APIï¼Œæä¾›æŸ¥è¯¢å’Œè°ƒæ•´æ¥å£ Admin ç®¡ç†åå°ï¼šå‰ç«¯é¡µé¢ï¼Œå±•ç¤ºç›‘æ§æ•°æ®å’Œå‚æ•°è°ƒæ•´ç•Œé¢ ç¬¬ä¸€æ­¥ï¼šçº¿ç¨‹æ± æ³¨å†Œä¸­å¿ƒ ThreadPoolRegistry\n1@Component 2public class ThreadPoolRegistry { 3 4 private final Map\u0026lt;String, ThreadPoolExecutor\u0026gt; executors = new ConcurrentHashMap\u0026lt;\u0026gt;(); 5 6 /** 7 * æ³¨å†Œçº¿ç¨‹æ±  8 */ 9 public void register(String name, ThreadPoolExecutor executor) { 10 executors.put(name, executor); 11 log.info(\u0026#34;æ³¨å†Œçº¿ç¨‹æ± : {}, æ ¸å¿ƒçº¿ç¨‹æ•°: {}, æœ€å¤§çº¿ç¨‹æ•°: {}\u0026#34;, 12 name, executor.getCorePoolSize(), executor.getMaximumPoolSize()); 13 } 14 15 /** 16 * è·å–æ‰€æœ‰çº¿ç¨‹æ±  17 */ 18 public Map\u0026lt;String, ThreadPoolExecutor\u0026gt; getAll() { 19 return Collections.unmodifiableMap(executors); 20 } 21 22 /** 23 * æ ¹æ®åç§°è·å–çº¿ç¨‹æ±  24 */ 25 public ThreadPoolExecutor get(String name) { 26 return executors.get(name); 27 } 28 29 /** 30 * åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 31 */ 32 public void adjust(String name, int corePoolSize, int maximumPoolSize) { 33 ThreadPoolExecutor executor = executors.get(name); 34 if (executor == null) { 35 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + name); 36 } 37 38 // å‚æ•°æ ¡éªŒ 39 if (corePoolSize \u0026lt;= 0 || maximumPoolSize \u0026lt;= 0) { 40 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± å‚æ•°å¿…é¡»å¤§äº 0\u0026#34;); 41 } 42 if (corePoolSize \u0026gt; maximumPoolSize) { 43 throw new IllegalArgumentException(\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å¤§äºæœ€å¤§çº¿ç¨‹æ•°\u0026#34;); 44 } 45 46 // è°ƒæ•´å‚æ•° 47 executor.setCorePoolSize(corePoolSize); 48 executor.setMaximumPoolSize(maximumPoolSize); 49 50 log.info(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°: {}, æ ¸å¿ƒçº¿ç¨‹æ•°: {} -\u0026gt; {}, æœ€å¤§çº¿ç¨‹æ•°: {} -\u0026gt; {}\u0026#34;, 51 name, executor.getCorePoolSize(), corePoolSize, 52 executor.getMaximumPoolSize(), maximumPoolSize); 53 } 54} è‡ªåŠ¨æ³¨å†Œçº¿ç¨‹æ± \nä½¿ç”¨ BeanPostProcessor è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰ ThreadPoolExecutorï¼š\n1@Component 2public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Override 8 public Object postProcessAfterInitialization(Object bean, String beanName) { 9 if (bean instanceof ThreadPoolExecutor) { 10 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 11 registry.register(beanName, executor); 12 } 13 return bean; 14 } 15} è¿™æ ·ï¼Œæ‰€æœ‰é€šè¿‡ Spring ç®¡ç†çš„ ThreadPoolExecutor éƒ½ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° Registry ä¸­ã€‚\nç¬¬äºŒæ­¥ï¼šç›‘æ§æŒ‡æ ‡é‡‡é›† ThreadPoolMetrics\n1@Data 2@Builder 3public class ThreadPoolMetrics { 4 private String name; // çº¿ç¨‹æ± åç§° 5 private int corePoolSize; // æ ¸å¿ƒçº¿ç¨‹æ•° 6 private int maximumPoolSize; // æœ€å¤§çº¿ç¨‹æ•° 7 private int activeCount; // æ´»è·ƒçº¿ç¨‹æ•° 8 private int poolSize; // å½“å‰çº¿ç¨‹æ•° 9 private int queueSize; // é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•° 10 private int queueRemainingCapacity; // é˜Ÿåˆ—å‰©ä½™å®¹é‡ 11 private long completedTaskCount; // å·²å®Œæˆä»»åŠ¡æ•° 12 private long taskCount; // æ€»ä»»åŠ¡æ•° 13 private String rejectedExecutionHandler; // æ‹’ç»ç­–ç•¥ 14 private long timestamp; // é‡‡é›†æ—¶é—´æˆ³ 15 16 /** 17 * è®¡ç®—çº¿ç¨‹æ± ä½¿ç”¨ç‡ 18 */ 19 public double getPoolUsageRate() { 20 return maximumPoolSize == 0 ? 0 : (double) poolSize / maximumPoolSize * 100; 21 } 22 23 /** 24 * è®¡ç®—é˜Ÿåˆ—ä½¿ç”¨ç‡ 25 */ 26 public double getQueueUsageRate() { 27 int capacity = queueSize + queueRemainingCapacity; 28 return capacity == 0 ? 0 : (double) queueSize / capacity * 100; 29 } 30} ThreadPoolMonitor\n1@Component 2@Slf4j 3public class ThreadPoolMonitor { 4 5 @Autowired 6 private ThreadPoolRegistry registry; 7 8 /** 9 * å®šæ—¶é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ 10 */ 11 @Scheduled(fixedDelay = 30000) // æ¯ 30 ç§’é‡‡é›†ä¸€æ¬¡ 12 public void collect() { 13 registry.getAll().forEach((name, executor) -\u0026gt; { 14 ThreadPoolMetrics metrics = collectMetrics(name, executor); 15 16 // æ‰“å°æ—¥å¿— 17 log.info(\u0026#34;çº¿ç¨‹æ± æŒ‡æ ‡: {}\u0026#34;, metrics); 18 19 // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€InfluxDB ç­‰ï¼‰ 20 reportToMonitor(metrics); 21 22 // æ£€æŸ¥å‘Šè­¦æ¡ä»¶ 23 checkAlert(metrics); 24 }); 25 } 26 27 /** 28 * é‡‡é›†å•ä¸ªçº¿ç¨‹æ± çš„æŒ‡æ ‡ 29 */ 30 private ThreadPoolMetrics collectMetrics(String name, ThreadPoolExecutor executor) { 31 return ThreadPoolMetrics.builder() 32 .name(name) 33 .corePoolSize(executor.getCorePoolSize()) 34 .maximumPoolSize(executor.getMaximumPoolSize()) 35 .activeCount(executor.getActiveCount()) 36 .poolSize(executor.getPoolSize()) 37 .queueSize(executor.getQueue().size()) 38 .queueRemainingCapacity(executor.getQueue().remainingCapacity()) 39 .completedTaskCount(executor.getCompletedTaskCount()) 40 .taskCount(executor.getTaskCount()) 41 .rejectedExecutionHandler(executor.getRejectedExecutionHandler().getClass().getSimpleName()) 42 .timestamp(System.currentTimeMillis()) 43 .build(); 44 } 45 46 /** 47 * ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ 48 */ 49 private void reportToMonitor(ThreadPoolMetrics metrics) { 50 // é›†æˆ Prometheusã€InfluxDB ç­‰ç›‘æ§ç³»ç»Ÿ 51 // è¿™é‡Œçœç•¥å…·ä½“å®ç° 52 } 53 54 /** 55 * æ£€æŸ¥å‘Šè­¦æ¡ä»¶ 56 */ 57 private void checkAlert(ThreadPoolMetrics metrics) { 58 // é˜Ÿåˆ—ä½¿ç”¨ç‡è¶…è¿‡ 80% 59 if (metrics.getQueueUsageRate() \u0026gt; 80) { 60 log.warn(\u0026#34;çº¿ç¨‹æ±  {} é˜Ÿåˆ—ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, 61 metrics.getName(), metrics.getQueueUsageRate()); 62 // å‘é€å‘Šè­¦ï¼ˆé’‰é’‰ã€é‚®ä»¶ç­‰ï¼‰ 63 } 64 65 // çº¿ç¨‹æ± ä½¿ç”¨ç‡è¶…è¿‡ 90% 66 if (metrics.getPoolUsageRate() \u0026gt; 90) { 67 log.warn(\u0026#34;çº¿ç¨‹æ±  {} ä½¿ç”¨ç‡è¿‡é«˜: {}%\u0026#34;, 68 metrics.getName(), metrics.getPoolUsageRate()); 69 } 70 } 71} æ¶æ„æ€è€ƒï¼š ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†é¢‘ç‡éœ€è¦æƒè¡¡ã€‚é¢‘ç‡å¤ªé«˜ä¼šå¢åŠ ç³»ç»Ÿå¼€é”€ï¼Œé¢‘ç‡å¤ªä½åˆæ— æ³•åŠæ—¶å‘ç°é—®é¢˜ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®® 30-60 ç§’é‡‡é›†ä¸€æ¬¡ï¼Œå‘Šè­¦é˜ˆå€¼å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚\nç¬¬ä¸‰æ­¥ï¼šREST API æ¥å£ ThreadPoolController\n1@RestController 2@RequestMapping(\u0026#34;/api/threadpool\u0026#34;) 3@Slf4j 4public class ThreadPoolController { 5 6 @Autowired 7 private ThreadPoolRegistry registry; 8 9 /** 10 * æŸ¥è¯¢æ‰€æœ‰çº¿ç¨‹æ±  11 */ 12 @GetMapping(\u0026#34;/list\u0026#34;) 13 public Result\u0026lt;List\u0026lt;ThreadPoolInfo\u0026gt;\u0026gt; list() { 14 List\u0026lt;ThreadPoolInfo\u0026gt; list = registry.getAll().entrySet().stream() 15 .map(entry -\u0026gt; ThreadPoolInfo.from(entry.getKey(), entry.getValue())) 16 .collect(Collectors.toList()); 17 return Result.success(list); 18 } 19 20 /** 21 * æŸ¥è¯¢å•ä¸ªçº¿ç¨‹æ± è¯¦æƒ… 22 */ 23 @GetMapping(\u0026#34;/detail/{name}\u0026#34;) 24 public Result\u0026lt;ThreadPoolInfo\u0026gt; detail(@PathVariable String name) { 25 ThreadPoolExecutor executor = registry.get(name); 26 if (executor == null) { 27 return Result.error(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + name); 28 } 29 return Result.success(ThreadPoolInfo.from(name, executor)); 30 } 31 32 /** 33 * åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 34 */ 35 @PostMapping(\u0026#34;/adjust\u0026#34;) 36 public Result\u0026lt;Void\u0026gt; adjust(@RequestBody ThreadPoolAdjustRequest request) { 37 try { 38 registry.adjust( 39 request.getName(), 40 request.getCorePoolSize(), 41 request.getMaximumPoolSize() 42 ); 43 return Result.success(); 44 } catch (Exception e) { 45 log.error(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°å¤±è´¥\u0026#34;, e); 46 return Result.error(e.getMessage()); 47 } 48 } 49} ThreadPoolInfo\n1@Data 2@Builder 3public class ThreadPoolInfo { 4 private String name; 5 private int corePoolSize; 6 private int maximumPoolSize; 7 private int activeCount; 8 private int poolSize; 9 private int queueSize; 10 private int queueCapacity; 11 private long completedTaskCount; 12 private long taskCount; 13 private String rejectedExecutionHandler; 14 private double poolUsageRate; 15 private double queueUsageRate; 16 17 public static ThreadPoolInfo from(String name, ThreadPoolExecutor executor) { 18 int queueSize = executor.getQueue().size(); 19 int queueCapacity = queueSize + executor.getQueue().remainingCapacity(); 20 21 return ThreadPoolInfo.builder() 22 .name(name) 23 .corePoolSize(executor.getCorePoolSize()) 24 .maximumPoolSize(executor.getMaximumPoolSize()) 25 .activeCount(executor.getActiveCount()) 26 .poolSize(executor.getPoolSize()) 27 .queueSize(queueSize) 28 .queueCapacity(queueCapacity) 29 .completedTaskCount(executor.getCompletedTaskCount()) 30 .taskCount(executor.getTaskCount()) 31 .rejectedExecutionHandler(executor.getRejectedExecutionHandler().getClass().getSimpleName()) 32 .poolUsageRate((double) executor.getPoolSize() / executor.getMaximumPoolSize() * 100) 33 .queueUsageRate(queueCapacity == 0 ? 0 : (double) queueSize / queueCapacity * 100) 34 .build(); 35 } 36} ThreadPoolAdjustRequest\n1@Data 2public class ThreadPoolAdjustRequest { 3 @NotBlank(message = \u0026#34;çº¿ç¨‹æ± åç§°ä¸èƒ½ä¸ºç©º\u0026#34;) 4 private String name; 5 6 @Min(value = 1, message = \u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°å¿…é¡»å¤§äº 0\u0026#34;) 7 private int corePoolSize; 8 9 @Min(value = 1, message = \u0026#34;æœ€å¤§çº¿ç¨‹æ•°å¿…é¡»å¤§äº 0\u0026#34;) 10 private int maximumPoolSize; 11} ç¬¬å››æ­¥ï¼šAdmin ç®¡ç†åå° å‰ç«¯æŠ€æœ¯æ ˆ\nVue 3 + Element Plus EChartsï¼ˆå›¾è¡¨å±•ç¤ºï¼‰ Axiosï¼ˆHTTP è¯·æ±‚ï¼‰ çº¿ç¨‹æ± åˆ—è¡¨é¡µé¢\n1\u0026lt;template\u0026gt; 2 \u0026lt;div class=\u0026#34;threadpool-list\u0026#34;\u0026gt; 3 \u0026lt;el-table :data=\u0026#34;threadPoolList\u0026#34; border\u0026gt; 4 \u0026lt;el-table-column prop=\u0026#34;name\u0026#34; label=\u0026#34;çº¿ç¨‹æ± åç§°\u0026#34; width=\u0026#34;200\u0026#34; /\u0026gt; 5 \u0026lt;el-table-column prop=\u0026#34;corePoolSize\u0026#34; label=\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 6 \u0026lt;el-table-column prop=\u0026#34;maximumPoolSize\u0026#34; label=\u0026#34;æœ€å¤§çº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 7 \u0026lt;el-table-column prop=\u0026#34;activeCount\u0026#34; label=\u0026#34;æ´»è·ƒçº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 8 \u0026lt;el-table-column prop=\u0026#34;poolSize\u0026#34; label=\u0026#34;å½“å‰çº¿ç¨‹æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 9 \u0026lt;el-table-column prop=\u0026#34;queueSize\u0026#34; label=\u0026#34;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#34; width=\u0026#34;120\u0026#34; /\u0026gt; 10 \u0026lt;el-table-column label=\u0026#34;çº¿ç¨‹æ± ä½¿ç”¨ç‡\u0026#34; width=\u0026#34;150\u0026#34;\u0026gt; 11 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 12 \u0026lt;el-progress 13 :percentage=\u0026#34;row.poolUsageRate\u0026#34; 14 :color=\u0026#34;getProgressColor(row.poolUsageRate)\u0026#34; 15 /\u0026gt; 16 \u0026lt;/template\u0026gt; 17 \u0026lt;/el-table-column\u0026gt; 18 \u0026lt;el-table-column label=\u0026#34;é˜Ÿåˆ—ä½¿ç”¨ç‡\u0026#34; width=\u0026#34;150\u0026#34;\u0026gt; 19 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 20 \u0026lt;el-progress 21 :percentage=\u0026#34;row.queueUsageRate\u0026#34; 22 :color=\u0026#34;getProgressColor(row.queueUsageRate)\u0026#34; 23 /\u0026gt; 24 \u0026lt;/template\u0026gt; 25 \u0026lt;/el-table-column\u0026gt; 26 \u0026lt;el-table-column label=\u0026#34;æ“ä½œ\u0026#34; width=\u0026#34;200\u0026#34;\u0026gt; 27 \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; 28 \u0026lt;el-button size=\u0026#34;small\u0026#34; @click=\u0026#34;showAdjustDialog(row)\u0026#34;\u0026gt; 29 è°ƒæ•´å‚æ•° 30 \u0026lt;/el-button\u0026gt; 31 \u0026lt;el-button size=\u0026#34;small\u0026#34; @click=\u0026#34;showMonitorDialog(row)\u0026#34;\u0026gt; 32 æŸ¥çœ‹ç›‘æ§ 33 \u0026lt;/el-button\u0026gt; 34 \u0026lt;/template\u0026gt; 35 \u0026lt;/el-table-column\u0026gt; 36 \u0026lt;/el-table\u0026gt; 37 38 \u0026lt;!-- å‚æ•°è°ƒæ•´å¯¹è¯æ¡† --\u0026gt; 39 \u0026lt;el-dialog v-model=\u0026#34;adjustDialogVisible\u0026#34; title=\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°\u0026#34;\u0026gt; 40 \u0026lt;el-form :model=\u0026#34;adjustForm\u0026#34; label-width=\u0026#34;120px\u0026#34;\u0026gt; 41 \u0026lt;el-form-item label=\u0026#34;çº¿ç¨‹æ± åç§°\u0026#34;\u0026gt; 42 \u0026lt;el-input v-model=\u0026#34;adjustForm.name\u0026#34; disabled /\u0026gt; 43 \u0026lt;/el-form-item\u0026gt; 44 \u0026lt;el-form-item label=\u0026#34;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#34;\u0026gt; 45 \u0026lt;el-input-number v-model=\u0026#34;adjustForm.corePoolSize\u0026#34; :min=\u0026#34;1\u0026#34; /\u0026gt; 46 \u0026lt;/el-form-item\u0026gt; 47 \u0026lt;el-form-item label=\u0026#34;æœ€å¤§çº¿ç¨‹æ•°\u0026#34;\u0026gt; 48 \u0026lt;el-input-number v-model=\u0026#34;adjustForm.maximumPoolSize\u0026#34; :min=\u0026#34;1\u0026#34; /\u0026gt; 49 \u0026lt;/el-form-item\u0026gt; 50 \u0026lt;/el-form\u0026gt; 51 \u0026lt;template #footer\u0026gt; 52 \u0026lt;el-button @click=\u0026#34;adjustDialogVisible = false\u0026#34;\u0026gt;å–æ¶ˆ\u0026lt;/el-button\u0026gt; 53 \u0026lt;el-button type=\u0026#34;primary\u0026#34; @click=\u0026#34;adjustThreadPool\u0026#34;\u0026gt;ç¡®å®š\u0026lt;/el-button\u0026gt; 54 \u0026lt;/template\u0026gt; 55 \u0026lt;/el-dialog\u0026gt; 56 \u0026lt;/div\u0026gt; 57\u0026lt;/template\u0026gt; 58 59\u0026lt;script setup\u0026gt; 60import { ref, onMounted } from \u0026#39;vue\u0026#39;; 61import { ElMessage } from \u0026#39;element-plus\u0026#39;; 62import axios from \u0026#39;axios\u0026#39;; 63 64const threadPoolList = ref([]); 65const adjustDialogVisible = ref(false); 66const adjustForm = ref({ 67 name: \u0026#39;\u0026#39;, 68 corePoolSize: 0, 69 maximumPoolSize: 0 70}); 71 72// åŠ è½½çº¿ç¨‹æ± åˆ—è¡¨ 73const loadThreadPoolList = async () =\u0026gt; { 74 const { data } = await axios.get(\u0026#39;/api/threadpool/list\u0026#39;); 75 threadPoolList.value = data.data; 76}; 77 78// æ˜¾ç¤ºè°ƒæ•´å¯¹è¯æ¡† 79const showAdjustDialog = (row) =\u0026gt; { 80 adjustForm.value = { 81 name: row.name, 82 corePoolSize: row.corePoolSize, 83 maximumPoolSize: row.maximumPoolSize 84 }; 85 adjustDialogVisible.value = true; 86}; 87 88// è°ƒæ•´çº¿ç¨‹æ± å‚æ•° 89const adjustThreadPool = async () =\u0026gt; { 90 try { 91 await axios.post(\u0026#39;/api/threadpool/adjust\u0026#39;, adjustForm.value); 92 ElMessage.success(\u0026#39;è°ƒæ•´æˆåŠŸ\u0026#39;); 93 adjustDialogVisible.value = false; 94 loadThreadPoolList(); 95 } catch (error) { 96 ElMessage.error(\u0026#39;è°ƒæ•´å¤±è´¥: \u0026#39; + error.message); 97 } 98}; 99 100// è¿›åº¦æ¡é¢œè‰² 101const getProgressColor = (percentage) =\u0026gt; { 102 if (percentage \u0026lt; 60) return \u0026#39;#67C23A\u0026#39;; 103 if (percentage \u0026lt; 80) return \u0026#39;#E6A23C\u0026#39;; 104 return \u0026#39;#F56C6C\u0026#39;; 105}; 106 107onMounted(() =\u0026gt; { 108 loadThreadPoolList(); 109 // æ¯ 30 ç§’åˆ·æ–°ä¸€æ¬¡ 110 setInterval(loadThreadPoolList, 30000); 111}); 112\u0026lt;/script\u0026gt; å®æ—¶ç›‘æ§é¡µé¢\nä½¿ç”¨ ECharts å±•ç¤ºçº¿ç¨‹æ± æŒ‡æ ‡çš„æ—¶é—´åºåˆ—å›¾ï¼š\n1// çº¿ç¨‹æ± ç›‘æ§å›¾è¡¨ 2const initChart = () =\u0026gt; { 3 const chart = echarts.init(document.getElementById(\u0026#39;chart\u0026#39;)); 4 5 const option = { 6 title: { text: \u0026#39;çº¿ç¨‹æ± ç›‘æ§\u0026#39; }, 7 tooltip: { trigger: \u0026#39;axis\u0026#39; }, 8 legend: { 9 data: [\u0026#39;æ´»è·ƒçº¿ç¨‹æ•°\u0026#39;, \u0026#39;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#39;, \u0026#39;å®Œæˆä»»åŠ¡æ•°\u0026#39;] 10 }, 11 xAxis: { 12 type: \u0026#39;category\u0026#39;, 13 data: timeLabels.value 14 }, 15 yAxis: { type: \u0026#39;value\u0026#39; }, 16 series: [ 17 { 18 name: \u0026#39;æ´»è·ƒçº¿ç¨‹æ•°\u0026#39;, 19 type: \u0026#39;line\u0026#39;, 20 data: activeCountData.value 21 }, 22 { 23 name: \u0026#39;é˜Ÿåˆ—ä»»åŠ¡æ•°\u0026#39;, 24 type: \u0026#39;line\u0026#39;, 25 data: queueSizeData.value 26 }, 27 { 28 name: \u0026#39;å®Œæˆä»»åŠ¡æ•°\u0026#39;, 29 type: \u0026#39;line\u0026#39;, 30 data: completedTaskCountData.value 31 } 32 ] 33 }; 34 35 chart.setOption(option); 36}; ç¬¬äº”æ­¥ï¼šæŒä¹…åŒ–é…ç½® å°†è°ƒæ•´åçš„å‚æ•°æŒä¹…åŒ–åˆ°æ•°æ®åº“æˆ–é…ç½®ä¸­å¿ƒï¼Œé‡å¯åè‡ªåŠ¨åŠ è½½ã€‚\næ•°æ®åº“è¡¨è®¾è®¡\n1CREATE TABLE threadpool_config ( 2 id BIGINT PRIMARY KEY AUTO_INCREMENT, 3 name VARCHAR(100) NOT NULL UNIQUE COMMENT \u0026#39;çº¿ç¨‹æ± åç§°\u0026#39;, 4 core_pool_size INT NOT NULL COMMENT \u0026#39;æ ¸å¿ƒçº¿ç¨‹æ•°\u0026#39;, 5 maximum_pool_size INT NOT NULL COMMENT \u0026#39;æœ€å¤§çº¿ç¨‹æ•°\u0026#39;, 6 keep_alive_time BIGINT NOT NULL COMMENT \u0026#39;ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰\u0026#39;, 7 queue_capacity INT NOT NULL COMMENT \u0026#39;é˜Ÿåˆ—å®¹é‡\u0026#39;, 8 rejected_execution_handler VARCHAR(100) COMMENT \u0026#39;æ‹’ç»ç­–ç•¥\u0026#39;, 9 created_time DATETIME NOT NULL, 10 updated_time DATETIME NOT NULL, 11 INDEX idx_name (name) 12) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;çº¿ç¨‹æ± é…ç½®è¡¨\u0026#39;; é…ç½®åŠ è½½\n1@Component 2public class ThreadPoolConfigLoader implements ApplicationRunner { 3 4 @Autowired 5 private ThreadPoolConfigMapper configMapper; 6 7 @Autowired 8 private ThreadPoolRegistry registry; 9 10 @Override 11 public void run(ApplicationArguments args) { 12 // ä»æ•°æ®åº“åŠ è½½é…ç½® 13 List\u0026lt;ThreadPoolConfig\u0026gt; configs = configMapper.selectAll(); 14 15 for (ThreadPoolConfig config : configs) { 16 ThreadPoolExecutor executor = registry.get(config.getName()); 17 if (executor != null) { 18 // åº”ç”¨é…ç½® 19 executor.setCorePoolSize(config.getCorePoolSize()); 20 executor.setMaximumPoolSize(config.getMaximumPoolSize()); 21 22 log.info(\u0026#34;åŠ è½½çº¿ç¨‹æ± é…ç½®: {}\u0026#34;, config); 23 } 24 } 25 } 26} é…ç½®ä¿å­˜\n1@Service 2public class ThreadPoolConfigService { 3 4 @Autowired 5 private ThreadPoolConfigMapper configMapper; 6 7 @Transactional 8 public void saveConfig(String name, int corePoolSize, int maximumPoolSize) { 9 ThreadPoolConfig config = configMapper.selectByName(name); 10 11 if (config == null) { 12 config = new ThreadPoolConfig(); 13 config.setName(name); 14 config.setCreatedTime(LocalDateTime.now()); 15 } 16 17 config.setCorePoolSize(corePoolSize); 18 config.setMaximumPoolSize(maximumPoolSize); 19 config.setUpdatedTime(LocalDateTime.now()); 20 21 configMapper.insertOrUpdate(config); 22 } 23} é¿å‘æç¤ºï¼š åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°æ—¶ï¼Œè¦æ³¨æ„å‚æ•°çš„åˆæ³•æ€§æ ¡éªŒã€‚æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å¤§äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¦åˆ™ä¼šæŠ›å‡º IllegalArgumentExceptionã€‚è°ƒæ•´å‚æ•°åï¼Œå»ºè®®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œé¿å…é‡å¯åé…ç½®ä¸¢å¤±ã€‚\nå‚æ•°è°ƒä¼˜æœ€ä½³å®è·µ 1. æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®\nCPU å¯†é›†å‹ä»»åŠ¡ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° + 1 IO å¯†é›†å‹ä»»åŠ¡ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2 2. æœ€å¤§çº¿ç¨‹æ•°è®¾ç½®\næœ€å¤§çº¿ç¨‹æ•° = æ ¸å¿ƒçº¿ç¨‹æ•° * 1.5 ~ 2\n3. é˜Ÿåˆ—å®¹é‡è®¾ç½®\næœ‰ç•Œé˜Ÿåˆ—ï¼šå»ºè®® 100-1000ï¼Œé¿å…å†…å­˜æº¢å‡º æ— ç•Œé˜Ÿåˆ—ï¼šæ…ç”¨ï¼Œå¯èƒ½å¯¼è‡´ OOM 4. æ‹’ç»ç­–ç•¥é€‰æ‹©\nç­–ç•¥ è¯´æ˜ é€‚ç”¨åœºæ™¯ AbortPolicy æŠ›å‡ºå¼‚å¸¸ éœ€è¦æ„ŸçŸ¥ä»»åŠ¡è¢«æ‹’ç» CallerRunsPolicy è°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ ä»»åŠ¡ä¸èƒ½ä¸¢å¤± DiscardPolicy é™é»˜ä¸¢å¼ƒ ä»»åŠ¡å¯ä»¥ä¸¢å¤± DiscardOldestPolicy ä¸¢å¼ƒæœ€è€çš„ä»»åŠ¡ ä¼˜å…ˆæ‰§è¡Œæ–°ä»»åŠ¡ 5. ç›‘æ§å‘Šè­¦\né˜Ÿåˆ—ä½¿ç”¨ç‡ \u0026gt; 80%ï¼šå‘Šè­¦ çº¿ç¨‹æ± ä½¿ç”¨ç‡ \u0026gt; 90%ï¼šå‘Šè­¦ ä»»åŠ¡æ‹’ç»æ¬¡æ•° \u0026gt; 0ï¼šå‘Šè­¦ æ€»ç»“ä¸æ€è€ƒ çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ ThreadPoolRegistry ç»Ÿä¸€ç®¡ç†æ‰€æœ‰çº¿ç¨‹æ±  é€šè¿‡ BeanPostProcessor è‡ªåŠ¨æ³¨å†Œçº¿ç¨‹æ±  å®šæ—¶é‡‡é›†ç›‘æ§æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ æä¾› REST API å’Œç®¡ç†åå°ï¼Œæ–¹ä¾¿è¿ç»´äººå‘˜è°ƒæ•´å‚æ•° å°†é…ç½®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œé‡å¯åè‡ªåŠ¨åŠ è½½ çº¿ç¨‹æ± å‚æ•°çš„è°ƒä¼˜æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®å®é™…è´Ÿè½½ä¸æ–­è°ƒæ•´ã€‚é€šè¿‡ç›‘æ§æ•°æ®åˆ†æï¼Œæ‰¾åˆ°æœ€ä¼˜çš„å‚æ•°é…ç½®ã€‚\nä¸‹æ¬¡å½“ä½ çš„çº¿ç¨‹æ± å‡ºç°æ€§èƒ½é—®é¢˜æ—¶ï¼Œä¸å¦¨è¯•è¯•æœ¬æ–‡ä»‹ç»çš„åŠ¨æ€é…ç½®æ–¹æ¡ˆï¼Œè®©çº¿ç¨‹æ± å‚æ•°è°ƒæ•´å˜å¾—æ›´åŠ çµæ´»å’Œé«˜æ•ˆã€‚\n","permalink":"http://localhost:1313/posts/2025/01/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8F%82%E6%95%B0%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AEadmin-%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1/","summary":"\u003cp\u003eåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°çš„é…ç½®å¾€å¾€éœ€è¦æ ¹æ®å®é™…è´Ÿè½½åŠ¨æ€è°ƒæ•´ã€‚ç¡¬ç¼–ç çš„å‚æ•°é…ç½®ç¼ºä¹çµæ´»æ€§ï¼Œé‡å¯æœåŠ¡åˆä¼šå½±å“ä¸šåŠ¡ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•è®¾è®¡ä¸€ä¸ªçº¿ç¨‹æ± ç®¡ç†åå°ï¼Œå®ç°å‚æ•°çš„åŠ¨æ€é…ç½®å’Œå®æ—¶ç›‘æ§ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£çº¿ç¨‹æ± å‚æ•°åŠ¨æ€è°ƒæ•´çš„åŸç†ä¸å®ç°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡çº¿ç¨‹æ± ç›‘æ§æŒ‡æ ‡çš„é‡‡é›†ä¸å±•ç¤º\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡ç”Ÿäº§çº§çš„çº¿ç¨‹æ± ç®¡ç†å¹³å°\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®\"\u003eä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šæµé‡çªå¢\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåŒåä¸€æœŸé—´ï¼Œè®¢å•å¤„ç†çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º 10ï¼Œæœ€å¤§çº¿ç¨‹æ•° 20ã€‚çªç„¶æµé‡æš´å¢ï¼Œé˜Ÿåˆ—å †ç§¯ä¸¥é‡ï¼Œå¯¼è‡´è®¢å•å¤„ç†å»¶è¿Ÿã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœèƒ½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼Œå°†æ ¸å¿ƒçº¿ç¨‹æ•°è°ƒæ•´ä¸º 50ï¼Œæœ€å¤§çº¿ç¨‹æ•°è°ƒæ•´ä¸º 100ï¼Œå°±èƒ½å¿«é€Ÿåº”å¯¹æµé‡é«˜å³°ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šèµ„æºæµªè´¹\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå‡Œæ™¨æ—¶æ®µæµé‡å¾ˆä½ï¼Œä½†çº¿ç¨‹æ± ä»ç„¶ä¿æŒé«˜å³°æœŸçš„é…ç½®ï¼Œæµªè´¹äº†å¤§é‡ç³»ç»Ÿèµ„æºã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿåšæ³•çš„é—®é¢˜\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eThreadPoolConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;orderThreadPool\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eorderThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æœ€å¤§çº¿ç¨‹æ•°ï¼šç¡¬ç¼–ç \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e60\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLinkedBlockingQueue\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadFactoryBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003esetNameFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;order-pool-%d\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003ebuild\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eCallerRunsPolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e","title":"çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®ï¼šAdmin ç®¡ç†åå°è®¾è®¡"},{"content":"ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚æœ¬æ–‡é€šè¿‡çœŸå®çš„ç”Ÿäº§æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Œè®©ä½ æŒæ¡ SQL æ€§èƒ½è°ƒä¼˜çš„å®Œæ•´æ–¹æ³•è®ºã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„åˆ†ææ–¹æ³• å­¦ä¼šä½¿ç”¨ Explain å®šä½æ€§èƒ½ç“¶é¢ˆ äº†è§£å¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§ ç†è§£æ•°æ®åº“å±‚é¢çš„æ€§èƒ½ä¼˜åŒ– æ¡ˆä¾‹èƒŒæ™¯ æŸç”µå•†ç³»ç»Ÿçš„è®¢å•åˆ—è¡¨æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´è¾¾åˆ° 5 ç§’ï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚\nåŸå§‹ SQL\n1SELECT o.*, u.username, u.phone 2FROM `order` o 3LEFT JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; æ•°æ®é‡ï¼š\norder è¡¨ï¼š100 ä¸‡æ¡ user è¡¨ï¼š50 ä¸‡æ¡ ç¬¬ä¸€æ­¥ï¼šå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— é…ç½® MySQL\n1[mysqld] 2slow_query_log = 1 3slow_query_log_file = /var/log/mysql/slow.log 4long_query_time = 1 5log_queries_not_using_indexes = 1 åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—\n1# ä½¿ç”¨ mysqldumpslow åˆ†æ 2mysqldumpslow -s t -t 10 /var/log/mysql/slow.log è¾“å‡ºï¼š\n1Count: 1000 Time=5.23s (5230s) Lock=0.00s (0s) Rows=20.0 (20000) 2SELECT o.*, u.username, u.phone FROM order o LEFT JOIN user u ... ç¬¬äºŒæ­¥ï¼šExplain åˆ†ææ‰§è¡Œè®¡åˆ’ 1EXPLAIN SELECT o.*, u.username, u.phone 2FROM `order` o 3LEFT JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; æ‰§è¡Œè®¡åˆ’åˆ†æ\nid table type key rows Extra 1 o ALL NULL 1000000 Using where; Using filesort 1 u eq_ref PRIMARY 1 Using where é—®é¢˜ï¼š\norder è¡¨å…¨è¡¨æ‰«æï¼ˆtype = ALLï¼‰ æ‰«æäº† 100 ä¸‡è¡Œæ•°æ® éœ€è¦é¢å¤–çš„æ’åºæ“ä½œï¼ˆUsing filesortï¼‰ ç¬¬ä¸‰æ­¥ï¼šä¼˜åŒ–ç´¢å¼• åˆ†ææŸ¥è¯¢æ¡ä»¶\nWHEREï¼šstatusã€create_time JOINï¼šuser_id ORDER BYï¼šcreate_time åˆ›å»ºè”åˆç´¢å¼•\n1CREATE INDEX idx_status_time ON `order`(status, create_time); å†æ¬¡ Explain\nid table type key rows Extra 1 o range idx_status_time 50000 Using index condition 1 u eq_ref PRIMARY 1 Using where æ”¹è¿›ï¼š\ntype ä» ALL å˜æˆ range rows ä» 100 ä¸‡é™ä½åˆ° 5 ä¸‡ å»æ‰äº† Using filesort æ‰§è¡Œæ—¶é—´ï¼šä» 5 ç§’é™ä½åˆ° 800ms\nç¬¬å››æ­¥ï¼šä¼˜åŒ– JOIN é—®é¢˜åˆ†æ\nLEFT JOIN ä¼šå…ˆæŸ¥è¯¢ order è¡¨çš„æ‰€æœ‰æ•°æ®ï¼Œç„¶åå†å…³è” user è¡¨ã€‚ä½†å®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦ city = \u0026lsquo;Beijing\u0026rsquo; çš„ç”¨æˆ·ã€‚\nä¼˜åŒ–æ–¹æ¡ˆï¼šæ”¹ä¸º INNER JOIN\n1SELECT o.*, u.username, u.phone 2FROM `order` o 3INNER JOIN user u ON o.user_id = u.id 4WHERE o.status IN (1, 2, 3) 5 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 6 AND u.city = \u0026#39;Beijing\u0026#39; 7ORDER BY o.create_time DESC 8LIMIT 20; ä¸º user è¡¨åˆ›å»ºç´¢å¼•\n1CREATE INDEX idx_city ON user(city); å†æ¬¡ Explain\nid table type key rows Extra 1 u ref idx_city 10000 Using where 1 o ref idx_user_status_time 100 Using where æ‰§è¡Œæ—¶é—´ï¼šä» 800ms é™ä½åˆ° 200ms\nç¬¬äº”æ­¥ï¼šé¿å… SELECT * é—®é¢˜\nSELECT * ä¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬ä¸éœ€è¦çš„å¤§å­—æ®µï¼ˆå¦‚è®¢å•è¯¦æƒ… JSONï¼‰ã€‚\nä¼˜åŒ–\n1SELECT o.id, o.order_no, o.amount, o.status, o.create_time, 2 u.username, u.phone 3FROM `order` o 4INNER JOIN user u ON o.user_id = u.id 5WHERE o.status IN (1, 2, 3) 6 AND o.create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; 7 AND u.city = \u0026#39;Beijing\u0026#39; 8ORDER BY o.create_time DESC 9LIMIT 20; æ‰§è¡Œæ—¶é—´ï¼šä» 200ms é™ä½åˆ° 120ms\nç¬¬å…­æ­¥ï¼šä½¿ç”¨è¦†ç›–ç´¢å¼• åˆ›å»ºè¦†ç›–ç´¢å¼•\n1CREATE INDEX idx_status_time_user ON `order`(status, create_time, user_id); ä¼˜åŒ–åçš„ Explain\nid table type key rows Extra 1 u ref idx_city 10000 Using index 1 o ref idx_status_time_user 100 Using index Extra å˜æˆäº† Using indexï¼Œè¯´æ˜ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ã€‚\næ‰§è¡Œæ—¶é—´ï¼šä» 120ms é™ä½åˆ° 50ms\nä¼˜åŒ–æ€»ç»“ ä¼˜åŒ–æ­¥éª¤ æ‰§è¡Œæ—¶é—´ ä¼˜åŒ–æ•ˆæœ åŸå§‹ SQL 5000ms - åˆ›å»ºç´¢å¼• 800ms æå‡ 6.25 å€ ä¼˜åŒ– JOIN 200ms æå‡ 4 å€ é¿å… SELECT * 120ms æå‡ 1.67 å€ ä½¿ç”¨è¦†ç›–ç´¢å¼• 50ms æå‡ 2.4 å€ æ€»ä½“æå‡ï¼š100 å€\nå¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§ 1. é¿å…åœ¨ WHERE ä¸­ä½¿ç”¨å‡½æ•°\n1-- ä¸å¥½ 2SELECT * FROM `order` WHERE DATE(create_time) = \u0026#39;2024-01-01\u0026#39;; 3 4-- å¥½ 5SELECT * FROM `order` WHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2024-01-02\u0026#39;; 2. ä½¿ç”¨ UNION ALL ä»£æ›¿ UNION\nUNION ä¼šå»é‡ï¼Œéœ€è¦é¢å¤–çš„æ’åºæ“ä½œã€‚å¦‚æœç¡®å®šæ²¡æœ‰é‡å¤æ•°æ®ï¼Œä½¿ç”¨ UNION ALLã€‚\n1-- ä¸å¥½ 2SELECT * FROM order WHERE status = 1 3UNION 4SELECT * FROM order WHERE status = 2; 5 6-- å¥½ 7SELECT * FROM order WHERE status = 1 8UNION ALL 9SELECT * FROM order WHERE status = 2; 3. ä½¿ç”¨ EXISTS ä»£æ›¿ IN\nå½“å­æŸ¥è¯¢ç»“æœé›†å¾ˆå¤§æ—¶ï¼ŒEXISTS æ€§èƒ½æ›´å¥½ã€‚\n1-- ä¸å¥½ 2SELECT * FROM user WHERE id IN (SELECT user_id FROM order); 3 4-- å¥½ 5SELECT * FROM user u WHERE EXISTS (SELECT 1 FROM order o WHERE o.user_id = u.id); 4. é¿å…ä½¿ç”¨å­æŸ¥è¯¢\nå­æŸ¥è¯¢ä¼šåˆ›å»ºä¸´æ—¶è¡¨ï¼Œæ€§èƒ½è¾ƒå·®ã€‚å¯ä»¥æ”¹ä¸º JOINã€‚\n1-- ä¸å¥½ 2SELECT * FROM user WHERE id IN (SELECT user_id FROM order WHERE status = 1); 3 4-- å¥½ 5SELECT DISTINCT u.* FROM user u 6INNER JOIN order o ON u.id = o.user_id 7WHERE o.status = 1; 5. åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é‡\n1-- ä¸å¥½ï¼šä¸€æ¬¡æ›´æ–° 100 ä¸‡æ¡æ•°æ® 2UPDATE order SET status = 2 WHERE status = 1; 3 4-- å¥½ï¼šåˆ†æ‰¹æ›´æ–° 5UPDATE order SET status = 2 WHERE status = 1 LIMIT 1000; 6. ä½¿ç”¨ LIMIT é™åˆ¶è¿”å›æ•°æ®é‡\n1-- ä¸å¥½ 2SELECT * FROM order WHERE status = 1; 3 4-- å¥½ 5SELECT * FROM order WHERE status = 1 LIMIT 100; æ•°æ®åº“å±‚é¢çš„ä¼˜åŒ– 1. è°ƒæ•´ InnoDB ç¼“å†²æ± å¤§å°\n1[mysqld] 2innodb_buffer_pool_size = 8G # è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 70-80% 2. å¼€å¯æŸ¥è¯¢ç¼“å­˜ï¼ˆMySQL 5.7 åŠä»¥ä¸‹ï¼‰\n1[mysqld] 2query_cache_type = 1 3query_cache_size = 256M æ³¨æ„ï¼šMySQL 8.0 å·²ç§»é™¤æŸ¥è¯¢ç¼“å­˜ã€‚\n3. è°ƒæ•´è¿æ¥æ•°\n1[mysqld] 2max_connections = 1000 4. å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\n1[mysqld] 2slow_query_log = 1 3long_query_time = 1 5. å®šæœŸåˆ†æè¡¨\n1ANALYZE TABLE order; æ›´æ–°è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¸®åŠ©ä¼˜åŒ–å™¨é€‰æ‹©æ›´å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚\nç›‘æ§ä¸é¢„è­¦ 1. ä½¿ç”¨ Prometheus + Grafana ç›‘æ§\nç›‘æ§æŒ‡æ ‡ï¼š\nQPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰ æ…¢æŸ¥è¯¢æ•°é‡ è¿æ¥æ•° ç¼“å†²æ± å‘½ä¸­ç‡ 2. è®¾ç½®æ…¢æŸ¥è¯¢å‘Šè­¦\nå½“æ…¢æŸ¥è¯¢æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œå‘é€å‘Šè­¦é€šçŸ¥ã€‚\n3. å®šæœŸå®¡æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—\næ¯å‘¨åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæ‰¾å‡ºéœ€è¦ä¼˜åŒ–çš„ SQLã€‚\næ€»ç»“ä¸æ€è€ƒ SQL æ€§èƒ½ä¼˜åŒ–çš„æ–¹æ³•è®ºï¼š\nå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå®šä½é—®é¢˜ SQL ä½¿ç”¨ Explain åˆ†ææ‰§è¡Œè®¡åˆ’ åˆ›å»ºåˆé€‚çš„ç´¢å¼• ä¼˜åŒ– SQL è¯­å¥ï¼ˆé¿å… SELECT *ã€ä¼˜åŒ– JOINï¼‰ æ•°æ®åº“å±‚é¢ä¼˜åŒ–ï¼ˆè°ƒæ•´å‚æ•°ã€ç›‘æ§ï¼‰ æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡å˜åŒ–ä¸æ–­è°ƒæ•´ã€‚\nè®°ä½ï¼šè¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚å…ˆä¿è¯åŠŸèƒ½æ­£ç¡®ï¼Œå†æ ¹æ®ç›‘æ§æ•°æ®ä¼˜åŒ–æ€§èƒ½ã€‚\nä¸‹æ¬¡å½“ä½ çš„ SQL æŸ¥è¯¢å¾ˆæ…¢æ—¶ï¼ŒæŒ‰ç…§è¿™ä¸ªæ–¹æ³•è®ºä¸€æ­¥æ­¥æ’æŸ¥ï¼Œä¸€å®šèƒ½æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚\n","permalink":"http://localhost:1313/posts/2024/12/mysql-%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/","summary":"\u003cp\u003eä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚æœ¬æ–‡é€šè¿‡çœŸå®çš„ç”Ÿäº§æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Œè®©ä½ æŒæ¡ SQL æ€§èƒ½è°ƒä¼˜çš„å®Œæ•´æ–¹æ³•è®ºã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ Explain å®šä½æ€§èƒ½ç“¶é¢ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¸¸è§çš„ SQL ä¼˜åŒ–æŠ€å·§\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£æ•°æ®åº“å±‚é¢çš„æ€§èƒ½ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¡ˆä¾‹èƒŒæ™¯\"\u003eæ¡ˆä¾‹èƒŒæ™¯\u003c/h2\u003e\n\u003cp\u003eæŸç”µå•†ç³»ç»Ÿçš„è®¢å•åˆ—è¡¨æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´è¾¾åˆ° 5 ç§’ï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåŸå§‹ SQL\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eusername\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ephone\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e`\u003c/span\u003e\u003cspan class=\"k\"\u003eorder\u003c/span\u003e\u003cspan class=\"o\"\u003e`\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eLEFT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eJOIN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eON\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003euser_id\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eWHERE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eIN\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003eAND\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;2024-01-01\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003eAND\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecity\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Beijing\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eORDER\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eBY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_time\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eDESC\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eLIMIT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ•°æ®é‡ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eorder è¡¨ï¼š100 ä¸‡æ¡\u003c/li\u003e\n\u003cli\u003euser è¡¨ï¼š50 ä¸‡æ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\"\u003eç¬¬ä¸€æ­¥ï¼šå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eé…ç½® MySQL\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[mysqld]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eslow_query_log\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eslow_query_log_file\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/log/mysql/slow.log\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elong_query_time\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elog_queries_not_using_indexes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—\u003c/strong\u003e\u003c/p\u003e","title":"MySQL æ…¢æŸ¥è¯¢ä¼˜åŒ–å®æˆ˜æ¡ˆä¾‹"},{"content":"åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŸMySQL é€šè¿‡äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œ MVCC æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡æ·±å…¥å‰–æ MySQL çš„å¹¶å‘æ§åˆ¶åŸç†ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯ æŒæ¡ MVCC çš„ ReadView æœºåˆ¶ å­¦ä¼šè§£å†³å¹»è¯»é—®é¢˜çš„æ–¹æ³• äº†è§£é”æœºåˆ¶ä¸ MVCC çš„é…åˆ äº‹åŠ¡çš„å¹¶å‘é—®é¢˜ è„è¯»ï¼ˆDirty Readï¼‰\näº‹åŠ¡ A è¯»å–äº†äº‹åŠ¡ B æœªæäº¤çš„æ•°æ®ï¼Œäº‹åŠ¡ B å›æ»šåï¼Œäº‹åŠ¡ A è¯»åˆ°çš„æ•°æ®æ˜¯æ— æ•ˆçš„ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ 3T2: äº‹åŠ¡ B å¼€å§‹ï¼Œå°† balance ä» 100 æ”¹ä¸º 200 4T3: äº‹åŠ¡ A è¯»å– balance = 200ï¼ˆè„è¯»ï¼‰ 5T4: äº‹åŠ¡ B å›æ»šï¼Œbalance æ¢å¤ä¸º 100 6T5: äº‹åŠ¡ A æäº¤ ä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readï¼‰\näº‹åŠ¡ A ä¸¤æ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸ä¸€è‡´ï¼ˆå› ä¸ºäº‹åŠ¡ B ä¿®æ”¹å¹¶æäº¤äº†æ•°æ®ï¼‰ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A è¯»å– balance = 100 3T2: äº‹åŠ¡ B å°† balance æ”¹ä¸º 200 å¹¶æäº¤ 4T3: äº‹åŠ¡ A å†æ¬¡è¯»å– balance = 200ï¼ˆä¸å¯é‡å¤è¯»ï¼‰ å¹»è¯»ï¼ˆPhantom Readï¼‰\näº‹åŠ¡ A ä¸¤æ¬¡æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢å¤šå‡ºäº†æ–°çš„è¡Œï¼ˆå› ä¸ºäº‹åŠ¡ B æ’å…¥äº†æ–°æ•°æ®ï¼‰ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A æŸ¥è¯¢ age \u0026gt; 20 çš„ç”¨æˆ·ï¼Œç»“æœ 2 æ¡ 3T2: äº‹åŠ¡ B æ’å…¥ä¸€æ¡ age = 25 çš„ç”¨æˆ·å¹¶æäº¤ 4T3: äº‹åŠ¡ A å†æ¬¡æŸ¥è¯¢ age \u0026gt; 20 çš„ç”¨æˆ·ï¼Œç»“æœ 3 æ¡ï¼ˆå¹»è¯»ï¼‰ å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ« éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» READ UNCOMMITTED å¯èƒ½ å¯èƒ½ å¯èƒ½ READ COMMITTED ä¸å¯èƒ½ å¯èƒ½ å¯èƒ½ REPEATABLE READï¼ˆé»˜è®¤ï¼‰ ä¸å¯èƒ½ ä¸å¯èƒ½ å¯èƒ½ SERIALIZABLE ä¸å¯èƒ½ ä¸å¯èƒ½ ä¸å¯èƒ½ æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«\n1SELECT @@transaction_isolation; è®¾ç½®éš”ç¦»çº§åˆ«\n1-- ä¼šè¯çº§åˆ« 2SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; 3 4-- å…¨å±€çº§åˆ« 5SET GLOBAL TRANSACTION ISOLATION LEVEL REPEATABLE READ; READ UNCOMMITTEDï¼šè¯»æœªæäº¤ ç‰¹ç‚¹ï¼š äº‹åŠ¡å¯ä»¥è¯»å–å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚\né—®é¢˜ï¼š ä¼šå‡ºç°è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€‚\né€‚ç”¨åœºæ™¯ï¼š å‡ ä¹ä¸ä½¿ç”¨ï¼Œæ•°æ®ä¸€è‡´æ€§æ— æ³•ä¿è¯ã€‚\næ¼”ç¤ºè„è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9 10-- äº‹åŠ¡ A 11SELECT balance FROM account WHERE id = 1; -- 200ï¼ˆè„è¯»ï¼‰ 12 13-- äº‹åŠ¡ B 14ROLLBACK; 15 16-- äº‹åŠ¡ A 17SELECT balance FROM account WHERE id = 1; -- 100 18COMMIT; READ COMMITTEDï¼šè¯»å·²æäº¤ ç‰¹ç‚¹ï¼š äº‹åŠ¡åªèƒ½è¯»å–å…¶ä»–äº‹åŠ¡å·²æäº¤çš„æ•°æ®ã€‚\né—®é¢˜ï¼š ä¼šå‡ºç°ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€‚\né€‚ç”¨åœºæ™¯ï¼š Oracleã€PostgreSQL çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚\næ¼”ç¤ºä¸å¯é‡å¤è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9COMMIT; 10 11-- äº‹åŠ¡ A 12SELECT balance FROM account WHERE id = 1; -- 200ï¼ˆä¸å¯é‡å¤è¯»ï¼‰ 13COMMIT; REPEATABLE READï¼šå¯é‡å¤è¯» ç‰¹ç‚¹ï¼š äº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸€è‡´ã€‚\né—®é¢˜ï¼š ç†è®ºä¸Šä¼šå‡ºç°å¹»è¯»ï¼Œä½† MySQL é€šè¿‡ MVCC + Next-Key Lock è§£å†³äº†å¤§éƒ¨åˆ†å¹»è¯»é—®é¢˜ã€‚\né€‚ç”¨åœºæ™¯ï¼š MySQL çš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ã€‚\næ¼”ç¤ºå¯é‡å¤è¯»\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ; 3START TRANSACTION; 4SELECT balance FROM account WHERE id = 1; -- 100 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; 9COMMIT; 10 11-- äº‹åŠ¡ A 12SELECT balance FROM account WHERE id = 1; -- 100ï¼ˆå¯é‡å¤è¯»ï¼‰ 13COMMIT; SERIALIZABLEï¼šä¸²è¡ŒåŒ– ç‰¹ç‚¹ï¼š äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œå®Œå…¨é¿å…å¹¶å‘é—®é¢˜ã€‚\né—®é¢˜ï¼š æ€§èƒ½æœ€å·®ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚\né€‚ç”¨åœºæ™¯ï¼š å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼ˆå¦‚é‡‘èç³»ç»Ÿï¼‰ã€‚\nå®ç°æ–¹å¼ï¼š å¯¹è¯»å–çš„æ¯ä¸€è¡Œæ•°æ®éƒ½åŠ é”ã€‚\n1-- äº‹åŠ¡ A 2SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE; 3START TRANSACTION; 4SELECT * FROM account WHERE id = 1; -- åŠ å…±äº«é” 5 6-- äº‹åŠ¡ B 7START TRANSACTION; 8UPDATE account SET balance = 200 WHERE id = 1; -- ç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é” MVCCï¼šå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ æ ¸å¿ƒæ€æƒ³ï¼š ä¸ºæ¯ä¸ªäº‹åŠ¡æä¾›æ•°æ®çš„å¿«ç…§ï¼Œä¸åŒäº‹åŠ¡çœ‹åˆ°ä¸åŒç‰ˆæœ¬çš„æ•°æ®ã€‚\nä¼˜åŠ¿ï¼š\nè¯»ä¸åŠ é”ï¼Œå†™ä¸é˜»å¡è¯» æå‡å¹¶å‘æ€§èƒ½ å®ç°æœºåˆ¶ï¼š\néšè—å­—æ®µï¼šDB_TRX_IDã€DB_ROLL_PTRã€DB_ROW_ID Undo Logï¼šè®°å½•æ•°æ®çš„å†å²ç‰ˆæœ¬ ReadViewï¼šåˆ¤æ–­æ•°æ®ç‰ˆæœ¬çš„å¯è§æ€§ éšè—å­—æ®µ InnoDB ä¸ºæ¯ä¸€è¡Œæ•°æ®æ·»åŠ äº†ä¸‰ä¸ªéšè—å­—æ®µï¼š\nå­—æ®µ è¯´æ˜ DB_TRX_ID æœ€åä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡ ID DB_ROLL_PTR æŒ‡å‘ Undo Log çš„æŒ‡é’ˆ DB_ROW_ID è¡Œ IDï¼ˆå¦‚æœæ²¡æœ‰ä¸»é”®ï¼‰ ç¤ºä¾‹\n1åŸå§‹æ•°æ®ï¼š 2id | name | age | DB_TRX_ID | DB_ROLL_PTR 31 | Alice | 20 | 100 | NULL 4 5äº‹åŠ¡ 101 ä¿®æ”¹ï¼š 6id | name | age | DB_TRX_ID | DB_ROLL_PTR 71 | Alice | 25 | 101 | â†’ Undo Log (age=20, TRX_ID=100) 8 9äº‹åŠ¡ 102 ä¿®æ”¹ï¼š 10id | name | age | DB_TRX_ID | DB_ROLL_PTR 111 | Alice | 30 | 102 | â†’ Undo Log (age=25, TRX_ID=101) é€šè¿‡ Undo Logï¼Œå¯ä»¥æ„å»ºç‰ˆæœ¬é“¾ï¼Œå›æº¯åˆ°ä»»æ„å†å²ç‰ˆæœ¬ã€‚\nReadViewï¼šå¯è§æ€§åˆ¤æ–­ ReadView æ˜¯äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºçš„å¿«ç…§ï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š\nå­—æ®µ è¯´æ˜ m_ids å½“å‰æ´»è·ƒçš„äº‹åŠ¡ ID åˆ—è¡¨ min_trx_id æœ€å°çš„æ´»è·ƒäº‹åŠ¡ ID max_trx_id ä¸‹ä¸€ä¸ªè¦åˆ†é…çš„äº‹åŠ¡ ID creator_trx_id åˆ›å»º ReadView çš„äº‹åŠ¡ ID å¯è§æ€§è§„åˆ™\nå¯¹äºæ•°æ®è¡Œçš„ DB_TRX_IDï¼š\nå¦‚æœ DB_TRX_ID \u0026lt; min_trx_idï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬åœ¨ ReadView åˆ›å»ºå‰å·²æäº¤ï¼Œå¯è§ å¦‚æœ DB_TRX_ID \u0026gt;= max_trx_idï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬åœ¨ ReadView åˆ›å»ºåæ‰å¼€å§‹ï¼Œä¸å¯è§ å¦‚æœ min_trx_id \u0026lt;= DB_TRX_ID \u0026lt; max_trx_idï¼š å¦‚æœ DB_TRX_ID åœ¨ m_ids ä¸­ï¼Œè¯´æ˜è¯¥äº‹åŠ¡è¿˜æœªæäº¤ï¼Œä¸å¯è§ å¦‚æœ DB_TRX_ID ä¸åœ¨ m_ids ä¸­ï¼Œè¯´æ˜è¯¥äº‹åŠ¡å·²æäº¤ï¼Œå¯è§ å¦‚æœ DB_TRX_ID == creator_trx_idï¼Œè¯´æ˜æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ä¿®æ”¹çš„ï¼Œå¯è§ å¦‚æœå½“å‰ç‰ˆæœ¬ä¸å¯è§ï¼Œé€šè¿‡ DB_ROLL_PTR æ‰¾åˆ° Undo Log ä¸­çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œç»§ç»­åˆ¤æ–­ã€‚\nREAD COMMITTED ä¸ REPEATABLE READ çš„åŒºåˆ« READ COMMITTED\næ¯æ¬¡ SELECT éƒ½åˆ›å»ºæ–°çš„ ReadViewã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ï¼ˆTRX_ID=100ï¼‰ 3T2: äº‹åŠ¡ A ç¬¬ä¸€æ¬¡ SELECTï¼Œåˆ›å»º ReadView1ï¼ˆm_ids=[100]ï¼‰ 4T3: äº‹åŠ¡ Bï¼ˆTRX_ID=101ï¼‰ä¿®æ”¹æ•°æ®å¹¶æäº¤ 5T4: äº‹åŠ¡ A ç¬¬äºŒæ¬¡ SELECTï¼Œåˆ›å»º ReadView2ï¼ˆm_ids=[100]ï¼‰ 6 æ­¤æ—¶äº‹åŠ¡ 101 å·²æäº¤ï¼Œä¸åœ¨ m_ids ä¸­ï¼Œå¯è§ ç»“æœï¼šä¸¤æ¬¡ SELECT ç»“æœä¸åŒï¼ˆä¸å¯é‡å¤è¯»ï¼‰ã€‚\nREPEATABLE READ\näº‹åŠ¡å¼€å§‹æ—¶åˆ›å»º ReadViewï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´å¤ç”¨ã€‚\n1æ—¶é—´çº¿ï¼š 2T1: äº‹åŠ¡ A å¼€å§‹ï¼ˆTRX_ID=100ï¼‰ï¼Œåˆ›å»º ReadViewï¼ˆm_ids=[100]ï¼‰ 3T2: äº‹åŠ¡ A ç¬¬ä¸€æ¬¡ SELECT 4T3: äº‹åŠ¡ Bï¼ˆTRX_ID=101ï¼‰ä¿®æ”¹æ•°æ®å¹¶æäº¤ 5T4: äº‹åŠ¡ A ç¬¬äºŒæ¬¡ SELECTï¼Œå¤ç”¨ ReadViewï¼ˆm_ids=[100]ï¼‰ 6 äº‹åŠ¡ 101 åœ¨ ReadView åˆ›å»ºåæ‰æäº¤ï¼Œä¸å¯è§ ç»“æœï¼šä¸¤æ¬¡ SELECT ç»“æœç›¸åŒï¼ˆå¯é‡å¤è¯»ï¼‰ã€‚\næ¶æ„æ€è€ƒï¼š MVCC çš„è®¾è®¡ä½“ç°äº†\u0026quot;ç©ºé—´æ¢æ—¶é—´\u0026quot;çš„æ€æƒ³ã€‚é€šè¿‡ Undo Log ä¿å­˜å†å²ç‰ˆæœ¬ï¼Œç‰ºç‰²äº†å­˜å‚¨ç©ºé—´ï¼Œæ¢å–äº†è¯»å†™å¹¶å‘çš„æ€§èƒ½æå‡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ Git çš„ç‰ˆæœ¬æ§åˆ¶ã€Redis çš„ RDB å¿«ç…§ã€‚\nå¹»è¯»é—®é¢˜ ä»€ä¹ˆæ˜¯å¹»è¯»ï¼Ÿ\näº‹åŠ¡ A ä¸¤æ¬¡æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢å¤šå‡ºäº†æ–°çš„è¡Œã€‚\nMVCC èƒ½è§£å†³å¹»è¯»å—ï¼Ÿ\néƒ¨åˆ†è§£å†³ã€‚å¯¹äºå¿«ç…§è¯»ï¼ˆæ™®é€š SELECTï¼‰ï¼ŒMVCC å¯ä»¥è§£å†³å¹»è¯»ã€‚ä½†å¯¹äºå½“å‰è¯»ï¼ˆSELECT FOR UPDATEã€UPDATEã€DELETEï¼‰ï¼ŒMVCC æ— æ³•è§£å†³å¹»è¯»ã€‚\næ¼”ç¤ºå¹»è¯»\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3SELECT * FROM user WHERE age \u0026gt; 20; -- 2 æ¡è®°å½• 4 5-- äº‹åŠ¡ B 6START TRANSACTION; 7INSERT INTO user (name, age) VALUES (\u0026#39;Charlie\u0026#39;, 25); 8COMMIT; 9 10-- äº‹åŠ¡ A 11SELECT * FROM user WHERE age \u0026gt; 20; -- ä»ç„¶ 2 æ¡ï¼ˆMVCC è§£å†³äº†å¿«ç…§è¯»çš„å¹»è¯»ï¼‰ 12 13-- ä½†æ˜¯ 14SELECT * FROM user WHERE age \u0026gt; 20 FOR UPDATE; -- 3 æ¡ï¼ˆå½“å‰è¯»å‡ºç°å¹»è¯»ï¼‰ è§£å†³æ–¹æ¡ˆï¼šNext-Key Lock\nNext-Key Lock = Record Lockï¼ˆè¡Œé”ï¼‰ + Gap Lockï¼ˆé—´éš™é”ï¼‰\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3SELECT * FROM user WHERE age \u0026gt; 20 FOR UPDATE; -- é”å®š age \u0026gt; 20 çš„æ‰€æœ‰è¡Œå’Œé—´éš™ 4 5-- äº‹åŠ¡ B 6INSERT INTO user (name, age) VALUES (\u0026#39;Charlie\u0026#39;, 25); -- ç­‰å¾…ï¼ˆè¢«é—´éš™é”é˜»å¡ï¼‰ é—´éš™é”é”å®šçš„æ˜¯ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥æ•°æ®ã€‚\né”æœºåˆ¶ å…±äº«é”ï¼ˆS Lockï¼‰\nè¯»é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ã€‚\n1SELECT * FROM user WHERE id = 1 LOCK IN SHARE MODE; æ’ä»–é”ï¼ˆX Lockï¼‰\nå†™é”ï¼Œåªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥æŒæœ‰ã€‚\n1SELECT * FROM user WHERE id = 1 FOR UPDATE; 2UPDATE user SET age = 25 WHERE id = 1; 3DELETE FROM user WHERE id = 1; è¡Œé”ï¼ˆRecord Lockï¼‰\né”å®šå•ä¸ªç´¢å¼•è®°å½•ã€‚\né—´éš™é”ï¼ˆGap Lockï¼‰\né”å®šç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ï¼Œé˜²æ­¢æ’å…¥ã€‚\nNext-Key Lock\nè¡Œé” + é—´éš™é”ï¼Œé”å®šç´¢å¼•è®°å½•åŠå…¶å‰é¢çš„é—´éš™ã€‚\né”çš„å…¼å®¹æ€§\nS Lock X Lock S Lock å…¼å®¹ å†²çª X Lock å†²çª å†²çª æ­»é” åœºæ™¯\n1-- äº‹åŠ¡ A 2START TRANSACTION; 3UPDATE user SET age = 25 WHERE id = 1; -- é”å®š id=1 4 5-- äº‹åŠ¡ B 6START TRANSACTION; 7UPDATE user SET age = 30 WHERE id = 2; -- é”å®š id=2 8 9-- äº‹åŠ¡ A 10UPDATE user SET age = 26 WHERE id = 2; -- ç­‰å¾…äº‹åŠ¡ B é‡Šæ”¾é” 11 12-- äº‹åŠ¡ B 13UPDATE user SET age = 31 WHERE id = 1; -- ç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é”ï¼ˆæ­»é”ï¼‰ æ£€æµ‹ä¸è§£å†³\nMySQL ä¼šè‡ªåŠ¨æ£€æµ‹æ­»é”ï¼Œå¹¶å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡ã€‚\né¿å…æ­»é”\næŒ‰ç›¸åŒé¡ºåºè®¿é—®èµ„æº ç¼©çŸ­äº‹åŠ¡æ—¶é—´ é™ä½éš”ç¦»çº§åˆ« ä½¿ç”¨ä¹è§‚é” å®æˆ˜æ¡ˆä¾‹ï¼šç§’æ€ç³»ç»Ÿçš„åº“å­˜æ‰£å‡ æ–¹æ¡ˆä¸€ï¼šæ‚²è§‚é”\n1START TRANSACTION; 2SELECT stock FROM product WHERE id = 1 FOR UPDATE; -- åŠ æ’ä»–é” 3UPDATE product SET stock = stock - 1 WHERE id = 1; 4COMMIT; ä¼˜ç‚¹ï¼šæ•°æ®ä¸€è‡´æ€§å¼º ç¼ºç‚¹ï¼šå¹¶å‘æ€§èƒ½å·®\næ–¹æ¡ˆäºŒï¼šä¹è§‚é”\n1-- æŸ¥è¯¢åº“å­˜å’Œç‰ˆæœ¬å· 2SELECT stock, version FROM product WHERE id = 1; 3 4-- æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å· 5UPDATE product SET stock = stock - 1, version = version + 1 6WHERE id = 1 AND version = #{oldVersion}; ä¼˜ç‚¹ï¼šå¹¶å‘æ€§èƒ½å¥½ ç¼ºç‚¹ï¼šé«˜å¹¶å‘ä¸‹æ›´æ–°å¤±è´¥ç‡é«˜\næ–¹æ¡ˆä¸‰ï¼šRedis + æ•°æ®åº“\n1// 1. Redis é¢„æ‰£å‡ 2Long stock = redisTemplate.opsForValue().decrement(\u0026#34;stock:1\u0026#34;); 3if (stock \u0026lt; 0) { 4 redisTemplate.opsForValue().increment(\u0026#34;stock:1\u0026#34;); 5 return \u0026#34;åº“å­˜ä¸è¶³\u0026#34;; 6} 7 8// 2. å¼‚æ­¥æ›´æ–°æ•°æ®åº“ 9rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, orderId); ä¼˜ç‚¹ï¼šæ€§èƒ½æœ€å¥½ ç¼ºç‚¹ï¼šå®ç°å¤æ‚ï¼Œéœ€è¦ä¿è¯æœ€ç»ˆä¸€è‡´æ€§\næ€»ç»“ä¸æ€è€ƒ MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ MVCC çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nå››ç§éš”ç¦»çº§åˆ«è§£å†³ä¸åŒçš„å¹¶å‘é—®é¢˜ MVCC é€šè¿‡ ReadView å’Œ Undo Log å®ç°å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ READ COMMITTED æ¯æ¬¡ SELECT åˆ›å»ºæ–° ReadView REPEATABLE READ äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»º ReadView å¹¶å¤ç”¨ Next-Key Lock è§£å†³å½“å‰è¯»çš„å¹»è¯»é—®é¢˜ ç†è§£è¿™äº›æœºåˆ¶ï¼Œæ‰èƒ½åœ¨å®é™…å¼€å‘ä¸­é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«å’Œé”ç­–ç•¥ã€‚\nä¸‹æ¬¡å½“ä½ é‡åˆ°å¹¶å‘é—®é¢˜æ—¶ï¼Œä¸å¦¨æƒ³æƒ³ï¼šè¿™æ˜¯è„è¯»ã€ä¸å¯é‡å¤è¯»è¿˜æ˜¯å¹»è¯»ï¼Ÿåº”è¯¥ç”¨ä»€ä¹ˆéš”ç¦»çº§åˆ«å’Œé”æœºåˆ¶ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/11/mysql-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8E-mvcc-%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŸMySQL é€šè¿‡äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œ MVCC æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡æ·±å…¥å‰–æ MySQL çš„å¹¶å‘æ§åˆ¶åŸç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ MVCC çš„ ReadView æœºåˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§£å†³å¹»è¯»é—®é¢˜çš„æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£é”æœºåˆ¶ä¸ MVCC çš„é…åˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"äº‹åŠ¡çš„å¹¶å‘é—®é¢˜\"\u003eäº‹åŠ¡çš„å¹¶å‘é—®é¢˜\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eè„è¯»ï¼ˆDirty Readï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eäº‹åŠ¡ A è¯»å–äº†äº‹åŠ¡ B æœªæäº¤çš„æ•°æ®ï¼Œäº‹åŠ¡ B å›æ»šåï¼Œäº‹åŠ¡ A è¯»åˆ°çš„æ•°æ®æ˜¯æ— æ•ˆçš„ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eæ—¶é—´çº¿ï¼š\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eT1: äº‹åŠ¡ A å¼€å§‹\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003eT2: äº‹åŠ¡ B å¼€å§‹ï¼Œå°† balance ä» 100 æ”¹ä¸º 200\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003eT3: äº‹åŠ¡ A è¯»å– balance = 200ï¼ˆè„è¯»ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003eT4: äº‹åŠ¡ B å›æ»šï¼Œbalance æ¢å¤ä¸º 100\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003eT5: äº‹åŠ¡ A æäº¤\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eäº‹åŠ¡ A ä¸¤æ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æœä¸ä¸€è‡´ï¼ˆå› ä¸ºäº‹åŠ¡ B ä¿®æ”¹å¹¶æäº¤äº†æ•°æ®ï¼‰ã€‚\u003c/p\u003e","title":"MySQL äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ MVCC æœºåˆ¶æ·±åº¦è§£æ"},{"content":"SQL æ€§èƒ½ä¼˜åŒ–æ˜¯åç«¯å¼€å‘çš„å¿…å¤‡æŠ€èƒ½ã€‚ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿï¼Œè€Œåˆç†çš„ç´¢å¼•è®¾è®¡èƒ½è®©æŸ¥è¯¢é€Ÿåº¦æå‡ç™¾å€ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ–¹æ³•è®ºã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ B+ æ ‘ç´¢å¼•çš„åº•å±‚åŸç† æŒæ¡ Explain æ‰§è¡Œè®¡åˆ’çš„åˆ†ææ–¹æ³• å­¦ä¼šè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é…è§„åˆ™ äº†è§£è¦†ç›–ç´¢å¼•ä¸ç´¢å¼•ä¸‹æ¨ä¼˜åŒ– B+ æ ‘ç´¢å¼•åŸç† ä¸ºä»€ä¹ˆé€‰æ‹© B+ æ ‘ï¼Ÿ\nå¸¸è§çš„æ•°æ®ç»“æ„å¯¹æ¯”ï¼š\næ•°æ®ç»“æ„ æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ é—®é¢˜ æ•°ç»„ O(n) æŸ¥è¯¢æ…¢ äºŒå‰æœç´¢æ ‘ O(log n) å¯èƒ½é€€åŒ–ä¸ºé“¾è¡¨ å¹³è¡¡äºŒå‰æ ‘ O(log n) æ ‘é«˜å¤ªé«˜ï¼ŒIO æ¬¡æ•°å¤š B æ ‘ O(log n) éå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œæµªè´¹ç©ºé—´ B+ æ ‘ O(log n) å¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜ç´¢å¼• B+ æ ‘çš„ç‰¹ç‚¹\næ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ å¶å­èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢ éå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šçš„é”®å€¼ æ ‘çš„é«˜åº¦ä½ï¼ŒIO æ¬¡æ•°å°‘ InnoDB çš„èšç°‡ç´¢å¼•\nInnoDB çš„ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨å®Œæ•´çš„è¡Œæ•°æ®ã€‚\n1ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰ 2 10 3 / \\ 4 5 15 5 / \\ / \\ 6 1 7 12 18 7 | | | | 8 [å®Œæ•´è¡Œæ•°æ®] äºŒçº§ç´¢å¼•ï¼ˆéä¸»é”®ç´¢å¼•ï¼‰çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼Œéœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\n1äºŒçº§ç´¢å¼•ï¼ˆname ç´¢å¼•ï¼‰ 2 \u0026#34;Bob\u0026#34; 3 / \\ 4 \u0026#34;Alice\u0026#34; \u0026#34;Charlie\u0026#34; 5 | | 6 [ä¸»é”®1] [ä¸»é”®3] 7 â†“ â†“ 8 å›è¡¨æŸ¥è¯¢å®Œæ•´æ•°æ® æ¶æ„æ€è€ƒï¼š èšç°‡ç´¢å¼•çš„è®¾è®¡ä½“ç°äº†\u0026quot;å±€éƒ¨æ€§åŸç†\u0026quot;ã€‚ç›¸é‚»çš„ä¸»é”®å€¼å­˜å‚¨åœ¨ç›¸é‚»çš„ç£ç›˜ä½ç½®ï¼ŒèŒƒå›´æŸ¥è¯¢æ—¶å¯ä»¥é¡ºåºè¯»å–ï¼Œå‡å°‘éšæœº IOã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨è‡ªå¢ä¸»é”®çš„åŸå› ã€‚\nExplain æ‰§è¡Œè®¡åˆ’åˆ†æ åŸºæœ¬ç”¨æ³•\n1EXPLAIN SELECT * FROM user WHERE age = 25; å…³é”®å­—æ®µè§£æ\n1. typeï¼ˆè®¿é—®ç±»å‹ï¼‰\næ€§èƒ½ä»å¥½åˆ°åï¼š\nsystemï¼šè¡¨åªæœ‰ä¸€è¡Œæ•°æ®ï¼ˆç³»ç»Ÿè¡¨ï¼‰ constï¼šé€šè¿‡ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æŸ¥è¯¢ï¼Œæœ€å¤šè¿”å›ä¸€è¡Œ eq_refï¼šå”¯ä¸€ç´¢å¼•æ‰«æï¼Œå¯¹äºæ¯ä¸ªç´¢å¼•é”®ï¼Œè¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•åŒ¹é… refï¼šéå”¯ä¸€ç´¢å¼•æ‰«æï¼Œè¿”å›åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„æ‰€æœ‰è¡Œ rangeï¼šç´¢å¼•èŒƒå›´æ‰«æï¼ˆBETWEENã€\u0026gt;ã€\u0026lt;ï¼‰ indexï¼šå…¨ç´¢å¼•æ‰«æ ALLï¼šå…¨è¡¨æ‰«æï¼ˆæœ€å·®ï¼‰ 1-- const 2EXPLAIN SELECT * FROM user WHERE id = 1; 3 4-- ref 5EXPLAIN SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6 7-- range 8EXPLAIN SELECT * FROM user WHERE age BETWEEN 20 AND 30; 9 10-- ALL 11EXPLAIN SELECT * FROM user WHERE email LIKE \u0026#39;%@gmail.com\u0026#39;; 2. keyï¼ˆå®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼‰\nå¦‚æœä¸º NULLï¼Œè¯´æ˜æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚\n3. rowsï¼ˆæ‰«æçš„è¡Œæ•°ï¼‰\né¢„ä¼°éœ€è¦æ‰«æçš„è¡Œæ•°ï¼Œè¶Šå°‘è¶Šå¥½ã€‚\n4. Extraï¼ˆé¢å¤–ä¿¡æ¯ï¼‰\nUsing indexï¼šä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ Using whereï¼šä½¿ç”¨äº† WHERE è¿‡æ»¤ Using filesortï¼šéœ€è¦é¢å¤–çš„æ’åºæ“ä½œï¼ˆæ€§èƒ½å·®ï¼‰ Using temporaryï¼šéœ€è¦åˆ›å»ºä¸´æ—¶è¡¨ï¼ˆæ€§èƒ½å·®ï¼‰ ç´¢å¼•å¤±æ•ˆçš„ 10 ç§åœºæ™¯ 1. ä½¿ç”¨å‡½æ•°æˆ–è¡¨è¾¾å¼\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE YEAR(create_time) = 2024; 3 4-- ä¼˜åŒ– 5SELECT * FROM user WHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2025-01-01\u0026#39;; 2. éšå¼ç±»å‹è½¬æ¢\n1-- phone æ˜¯ VARCHAR ç±»å‹ï¼Œç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE phone = 13800138000; 3 4-- ä¼˜åŒ– 5SELECT * FROM user WHERE phone = \u0026#39;13800138000\u0026#39;; 3. ä½¿ç”¨ OR è¿æ¥\n1-- å¦‚æœ age æ²¡æœ‰ç´¢å¼•ï¼Œæ•´ä¸ªæŸ¥è¯¢ä¸èµ°ç´¢å¼• 2SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; OR age = 25; 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨ UNION 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; 6UNION 7SELECT * FROM user WHERE age = 25; 4. LIKE ä»¥ % å¼€å¤´\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE name LIKE \u0026#39;%Alice\u0026#39;; 3 4-- ä¼˜åŒ–ï¼š% æ”¾åœ¨åé¢ 5SELECT * FROM user WHERE name LIKE \u0026#39;Alice%\u0026#39;; 5. ä¸ç­‰äºï¼ˆ!= æˆ– \u0026lt;\u0026gt;ï¼‰\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE age != 25; 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨èŒƒå›´æŸ¥è¯¢ 5SELECT * FROM user WHERE age \u0026lt; 25 OR age \u0026gt; 25; 6. IS NULL æˆ– IS NOT NULL\n1-- å¯èƒ½ç´¢å¼•å¤±æ•ˆï¼ˆå–å†³äº NULL å€¼çš„æ¯”ä¾‹ï¼‰ 2SELECT * FROM user WHERE age IS NULL; 3 4-- ä¼˜åŒ–ï¼šé¿å…å­—æ®µä¸º NULLï¼Œä½¿ç”¨é»˜è®¤å€¼ 7. NOT IN å’Œ NOT EXISTS\n1-- ç´¢å¼•å¤±æ•ˆ 2SELECT * FROM user WHERE id NOT IN (1, 2, 3); 3 4-- ä¼˜åŒ–ï¼šä½¿ç”¨ LEFT JOIN 5SELECT u.* FROM user u 6LEFT JOIN (SELECT 1 AS id UNION SELECT 2 UNION SELECT 3) t ON u.id = t.id 7WHERE t.id IS NULL; 8. è”åˆç´¢å¼•ä¸æ»¡è¶³æœ€å·¦å‰ç¼€\n1-- è”åˆç´¢å¼• (name, age, city) 2 3-- èµ°ç´¢å¼• 4SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25; 6 7-- ä¸èµ°ç´¢å¼• 8SELECT * FROM user WHERE age = 25; 9SELECT * FROM user WHERE city = \u0026#39;Beijing\u0026#39;; 9. èŒƒå›´æŸ¥è¯¢åçš„å­—æ®µä¸èµ°ç´¢å¼•\n1-- è”åˆç´¢å¼• (name, age, city) 2 3-- age èµ°ç´¢å¼•ï¼Œcity ä¸èµ°ç´¢å¼• 4SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age \u0026gt; 20 AND city = \u0026#39;Beijing\u0026#39;; 10. æ•°æ®é‡å¤ªå°\nå¦‚æœè¡¨çš„æ•°æ®é‡å¾ˆå°ï¼ˆå‡ ç™¾è¡Œï¼‰ï¼ŒMySQL å¯èƒ½é€‰æ‹©å…¨è¡¨æ‰«æè€Œä¸æ˜¯ç´¢å¼•ã€‚\nè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é… è§„åˆ™\nè”åˆç´¢å¼• (a, b, c) ç›¸å½“äºåˆ›å»ºäº†ä¸‰ä¸ªç´¢å¼•ï¼š\n(a) (a, b) (a, b, c) æ¡ˆä¾‹åˆ†æ\n1-- åˆ›å»ºè”åˆç´¢å¼• 2CREATE INDEX idx_name_age_city ON user(name, age, city); 3 4-- èµ°ç´¢å¼• 5SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25; 7SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND age = 25 AND city = \u0026#39;Beijing\u0026#39;; 8SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39; AND city = \u0026#39;Beijing\u0026#39;; -- name èµ°ç´¢å¼•ï¼Œcity ä¸èµ° 9 10-- ä¸èµ°ç´¢å¼• 11SELECT * FROM user WHERE age = 25; 12SELECT * FROM user WHERE city = \u0026#39;Beijing\u0026#39;; 13SELECT * FROM user WHERE age = 25 AND city = \u0026#39;Beijing\u0026#39;; ç´¢å¼•é¡ºåºçš„é€‰æ‹©\nåŒºåˆ†åº¦é«˜çš„å­—æ®µæ”¾åœ¨å‰é¢ã€‚\n1-- å‡è®¾ name æœ‰ 1000 ä¸ªä¸åŒå€¼ï¼Œage æœ‰ 50 ä¸ªä¸åŒå€¼ï¼Œcity æœ‰ 10 ä¸ªä¸åŒå€¼ 2-- åº”è¯¥åˆ›å»º (name, age, city)ï¼Œè€Œä¸æ˜¯ (city, age, name) è¦†ç›–ç´¢å¼• è¦†ç›–ç´¢å¼•æ˜¯æŒ‡æŸ¥è¯¢çš„å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­ï¼Œä¸éœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\næ¡ˆä¾‹\n1-- åˆ›å»ºç´¢å¼• 2CREATE INDEX idx_name_age ON user(name, age); 3 4-- è¦†ç›–ç´¢å¼•ï¼ˆä¸éœ€è¦å›è¡¨ï¼‰ 5SELECT name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; 6 7-- éœ€è¦å›è¡¨ 8SELECT * FROM user WHERE name = \u0026#39;Alice\u0026#39;; ä¼˜åŒ–å»ºè®®\nå¦‚æœæŸ¥è¯¢åªéœ€è¦å°‘æ•°å‡ ä¸ªå­—æ®µï¼Œå¯ä»¥åˆ›å»ºè”åˆç´¢å¼•è¦†ç›–è¿™äº›å­—æ®µã€‚\n1-- ä¼˜åŒ–å‰ 2SELECT id, name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; 3 4-- åˆ›å»ºè¦†ç›–ç´¢å¼• 5CREATE INDEX idx_name_age ON user(name, age); 6 7-- ä¼˜åŒ–åï¼ˆä¸éœ€è¦å›è¡¨ï¼‰ 8SELECT id, name, age FROM user WHERE name = \u0026#39;Alice\u0026#39;; ç´¢å¼•ä¸‹æ¨ï¼ˆICPï¼‰ MySQL 5.6 å¼•å…¥çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œå°†éƒ¨åˆ† WHERE æ¡ä»¶ä¸‹æ¨åˆ°å­˜å‚¨å¼•æ“å±‚è¿‡æ»¤ã€‚\næ¡ˆä¾‹\n1-- è”åˆç´¢å¼• (name, age) 2SELECT * FROM user WHERE name LIKE \u0026#39;A%\u0026#39; AND age = 25; æ²¡æœ‰ç´¢å¼•ä¸‹æ¨\nå­˜å‚¨å¼•æ“æ ¹æ® name LIKE \u0026lsquo;A%\u0026rsquo; æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„è®°å½• è¿”å›ç»™ Server å±‚ Server å±‚è¿‡æ»¤ age = 25 æœ‰ç´¢å¼•ä¸‹æ¨\nå­˜å‚¨å¼•æ“æ ¹æ® name LIKE \u0026lsquo;A%\u0026rsquo; æ‰¾åˆ°åŒ¹é…çš„è®°å½• åœ¨å­˜å‚¨å¼•æ“å±‚ç›´æ¥è¿‡æ»¤ age = 25 åªè¿”å›ç¬¦åˆæ¡ä»¶çš„è®°å½•ç»™ Server å±‚ å‡å°‘äº†å›è¡¨æ¬¡æ•°ï¼Œæå‡äº†æ€§èƒ½ã€‚\nåˆ†é¡µæŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ï¼šæ·±åº¦åˆ†é¡µ\n1-- æŸ¥è¯¢ç¬¬ 100 ä¸‡æ¡æ•°æ® 2SELECT * FROM user ORDER BY id LIMIT 1000000, 10; MySQL éœ€è¦æ‰«æ 100 ä¸‡ + 10 æ¡æ•°æ®ï¼Œç„¶åä¸¢å¼ƒå‰ 100 ä¸‡æ¡ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\nä¼˜åŒ–æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨å­æŸ¥è¯¢\n1SELECT * FROM user 2WHERE id \u0026gt;= (SELECT id FROM user ORDER BY id LIMIT 1000000, 1) 3LIMIT 10; å­æŸ¥è¯¢ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œåªè¿”å› idï¼Œç„¶åé€šè¿‡ id æŸ¥è¯¢å®Œæ•´æ•°æ®ã€‚\nä¼˜åŒ–æ–¹æ¡ˆäºŒï¼šè®°å½•ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§ ID\n1-- ç¬¬ä¸€æ¬¡æŸ¥è¯¢ 2SELECT * FROM user ORDER BY id LIMIT 10; 3 4-- ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ˆå‡è®¾ä¸Šæ¬¡æœ€å¤§ ID æ˜¯ 10ï¼‰ 5SELECT * FROM user WHERE id \u0026gt; 10 ORDER BY id LIMIT 10; è¿™ç§æ–¹å¼åªé€‚ç”¨äº ID è¿ç»­çš„åœºæ™¯ã€‚\nç´¢å¼•è®¾è®¡çš„æœ€ä½³å®è·µ 1. é€‰æ‹©åˆé€‚çš„å­—æ®µåˆ›å»ºç´¢å¼•\nWHEREã€ORDER BYã€GROUP BYã€JOIN çš„å­—æ®µ åŒºåˆ†åº¦é«˜çš„å­—æ®µï¼ˆä¸è¦ç»™æ€§åˆ«åˆ›å»ºç´¢å¼•ï¼‰ å­—æ®µé•¿åº¦å°çš„å­—æ®µ 2. ä½¿ç”¨å‰ç¼€ç´¢å¼•\nå¯¹äºé•¿å­—ç¬¦ä¸²å­—æ®µï¼Œå¯ä»¥åªç´¢å¼•å‰å‡ ä¸ªå­—ç¬¦ã€‚\n1CREATE INDEX idx_email ON user(email(10)); 3. é¿å…å†—ä½™ç´¢å¼•\nå¦‚æœå·²ç»æœ‰è”åˆç´¢å¼• (name, age)ï¼Œå°±ä¸éœ€è¦å•ç‹¬åˆ›å»º (name) ç´¢å¼•ã€‚\n4. å®šæœŸåˆ†æå’Œä¼˜åŒ–ç´¢å¼•\n1-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ 2SHOW INDEX FROM user; 3 4-- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼• 5DROP INDEX idx_unused ON user; 5. ä½¿ç”¨è‡ªå¢ä¸»é”®\né¿å…é¡µåˆ†è£‚ï¼Œæå‡æ’å…¥æ€§èƒ½ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šæ…¢æŸ¥è¯¢ä¼˜åŒ– é—®é¢˜ SQL\n1SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; æ‰§è¡Œæ—¶é—´ï¼š3 ç§’\nåˆ†æ\n1EXPLAIN SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; ç»“æœï¼štype = ALLï¼Œrows = 1000000ï¼ŒExtra = Using filesort\nä¼˜åŒ–æ­¥éª¤\nåˆ›å»ºè”åˆç´¢å¼• 1CREATE INDEX idx_user_status_time ON order(user_id, status, create_time); å†æ¬¡åˆ†æ 1EXPLAIN SELECT * FROM order 2WHERE user_id = 123 AND status = 1 AND create_time \u0026gt; \u0026#39;2024-01-01\u0026#39; 3ORDER BY create_time DESC 4LIMIT 10; ç»“æœï¼štype = rangeï¼Œrows = 100ï¼ŒExtra = Using index condition\næ‰§è¡Œæ—¶é—´ï¼š50ms\næ€§èƒ½æå‡ï¼š60 å€\næ€»ç»“ä¸æ€è€ƒ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nç†è§£ B+ æ ‘çš„åŸç†ï¼ŒçŸ¥é“ä¸ºä»€ä¹ˆç´¢å¼•èƒ½æå‡æ€§èƒ½ æŒæ¡ Explain çš„ä½¿ç”¨ï¼Œèƒ½å¤Ÿåˆ†ææ‰§è¡Œè®¡åˆ’ é¿å…ç´¢å¼•å¤±æ•ˆçš„ 10 ç§åœºæ™¯ åˆç†è®¾è®¡è”åˆç´¢å¼•ï¼Œåˆ©ç”¨æœ€å·¦å‰ç¼€åŒ¹é… ä½¿ç”¨è¦†ç›–ç´¢å¼•å’Œç´¢å¼•ä¸‹æ¨ä¼˜åŒ–æŸ¥è¯¢ ç´¢å¼•ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œæ¯ä¸ªç´¢å¼•éƒ½ä¼šå ç”¨å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”å½±å“å†™å…¥æ€§èƒ½ã€‚è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯åˆç†è®¾è®¡ç´¢å¼•ã€‚\nä¸‹æ¬¡å½“ä½ çš„ SQL æŸ¥è¯¢å¾ˆæ…¢æ—¶ï¼Œä¸å¦¨ç”¨ Explain åˆ†æä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦èµ°äº†ç´¢å¼•ã€‚\n","permalink":"http://localhost:1313/posts/2024/11/mysql-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E4%BB%8E-explain-%E5%88%B0%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/","summary":"\u003cp\u003eSQL æ€§èƒ½ä¼˜åŒ–æ˜¯åç«¯å¼€å‘çš„å¿…å¤‡æŠ€èƒ½ã€‚ä¸€æ¡æ…¢æŸ¥è¯¢å¯èƒ½æ‹–å®æ•´ä¸ªç³»ç»Ÿï¼Œè€Œåˆç†çš„ç´¢å¼•è®¾è®¡èƒ½è®©æŸ¥è¯¢é€Ÿåº¦æå‡ç™¾å€ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ MySQL ç´¢å¼•ä¼˜åŒ–çš„æ–¹æ³•è®ºã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ B+ æ ‘ç´¢å¼•çš„åº•å±‚åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Explain æ‰§è¡Œè®¡åˆ’çš„åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é…è§„åˆ™\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£è¦†ç›–ç´¢å¼•ä¸ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"b-æ ‘ç´¢å¼•åŸç†\"\u003eB+ æ ‘ç´¢å¼•åŸç†\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eä¸ºä»€ä¹ˆé€‰æ‹© B+ æ ‘ï¼Ÿ\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¸¸è§çš„æ•°æ®ç»“æ„å¯¹æ¯”ï¼š\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eæ•°æ®ç»“æ„\u003c/th\u003e\n          \u003cth\u003eæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦\u003c/th\u003e\n          \u003cth\u003eé—®é¢˜\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eæ•°ç»„\u003c/td\u003e\n          \u003ctd\u003eO(n)\u003c/td\u003e\n          \u003ctd\u003eæŸ¥è¯¢æ…¢\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eäºŒå‰æœç´¢æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eå¯èƒ½é€€åŒ–ä¸ºé“¾è¡¨\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eå¹³è¡¡äºŒå‰æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eæ ‘é«˜å¤ªé«˜ï¼ŒIO æ¬¡æ•°å¤š\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eB æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eéå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œæµªè´¹ç©ºé—´\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eB+ æ ‘\u003c/td\u003e\n          \u003ctd\u003eO(log n)\u003c/td\u003e\n          \u003ctd\u003eå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜ç´¢å¼•\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003eB+ æ ‘çš„ç‰¹ç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹\u003c/li\u003e\n\u003cli\u003eå¶å­èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢\u003c/li\u003e\n\u003cli\u003eéå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šçš„é”®å€¼\u003c/li\u003e\n\u003cli\u003eæ ‘çš„é«˜åº¦ä½ï¼ŒIO æ¬¡æ•°å°‘\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eInnoDB çš„èšç°‡ç´¢å¼•\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eInnoDB çš„ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨å®Œæ•´çš„è¡Œæ•°æ®ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e       10\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e      /  \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e     5    15\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    / \\   / \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e   1  7  12 18\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e   |  |  |  |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  [å®Œæ•´è¡Œæ•°æ®]\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eäºŒçº§ç´¢å¼•ï¼ˆéä¸»é”®ç´¢å¼•ï¼‰çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼Œéœ€è¦å›è¡¨æŸ¥è¯¢ã€‚\u003c/p\u003e","title":"MySQL ç´¢å¼•ä¼˜åŒ–ï¼šä» Explain åˆ°æ‰§è¡Œè®¡åˆ’"},{"content":"ç”Ÿäº§ç¯å¢ƒçš„ OOMï¼ˆOut Of Memoryï¼‰æ˜¯åç«¯å¼€å‘æœ€å¤´ç–¼çš„é—®é¢˜ä¹‹ä¸€ã€‚æœ¬æ–‡é€šè¿‡çœŸå®æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œè§£å†³ JVM å†…å­˜é—®é¢˜ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ JVM å†…å­˜æ¨¡å‹ä¸ GC æœºåˆ¶ æŒæ¡ Heap Dump çš„ç”Ÿæˆä¸åˆ†ææ–¹æ³• å­¦ä¼šä½¿ç”¨ MAT å·¥å…·å®šä½å†…å­˜æ³„æ¼ äº†è§£å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ JVM å†…å­˜æ¨¡å‹ å †å†…å­˜ï¼ˆHeapï¼‰\nå¹´è½»ä»£ï¼ˆYoung Generationï¼‰ Eden åŒºï¼šæ–°å¯¹è±¡åˆ†é…çš„åŒºåŸŸ Survivor åŒºï¼šS0 å’Œ S1ï¼Œå­˜æ”¾ç»è¿‡ä¸€æ¬¡ GC åå­˜æ´»çš„å¯¹è±¡ è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡ éå †å†…å­˜\næ–¹æ³•åŒºï¼ˆMetaspaceï¼‰ï¼šå­˜æ”¾ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ æ ˆï¼ˆStackï¼‰ï¼šå­˜æ”¾å±€éƒ¨å˜é‡ã€æ–¹æ³•è°ƒç”¨ ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ï¼šNIO ä½¿ç”¨çš„å †å¤–å†…å­˜ GC æœºåˆ¶\nMinor GCï¼šæ¸…ç†å¹´è½»ä»£ Major GCï¼šæ¸…ç†è€å¹´ä»£ Full GCï¼šæ¸…ç†æ•´ä¸ªå †å†…å­˜ å¯¹è±¡æ™‹å‡\næ–°å¯¹è±¡åœ¨ Eden åŒºåˆ†é… Eden åŒºæ»¡äº†ï¼Œè§¦å‘ Minor GC å­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ° Survivor åŒº ç»è¿‡å¤šæ¬¡ GC åï¼Œå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ æ¶æ„æ€è€ƒï¼š JVM çš„åˆ†ä»£æ”¶é›†ä½“ç°äº†\u0026quot;å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•æ­»\u0026quot;çš„ç‰¹ç‚¹ã€‚å¹´è½»ä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¿«é€Ÿå›æ”¶çŸ­å‘½å¯¹è±¡ï¼›è€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå¤„ç†é•¿æœŸå­˜æ´»çš„å¯¹è±¡ã€‚è¿™ç§è®¾è®¡åœ¨æ€§èƒ½å’Œå†…å­˜åˆ©ç”¨ç‡ä¹‹é—´æ‰¾åˆ°äº†å¹³è¡¡ã€‚\nOOM çš„å¸¸è§ç±»å‹ 1. java.lang.OutOfMemoryError: Java heap space\nå †å†…å­˜ä¸è¶³ï¼Œæœ€å¸¸è§çš„ OOMã€‚\nåŸå› ï¼š\nå†…å­˜æ³„æ¼ï¼šå¯¹è±¡æ— æ³•è¢« GC å›æ”¶ å†…å­˜æº¢å‡ºï¼šå¯¹è±¡å¤ªå¤šï¼Œè¶…è¿‡å †å†…å­˜å¤§å° 2. java.lang.OutOfMemoryError: GC overhead limit exceeded\nGC å ç”¨äº† 98% çš„æ—¶é—´ï¼Œä½†åªå›æ”¶äº†ä¸åˆ° 2% çš„å†…å­˜ã€‚\n3. java.lang.OutOfMemoryError: Metaspace\næ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰å†…å­˜ä¸è¶³ã€‚\nåŸå› ï¼š\nåŠ è½½äº†å¤ªå¤šçš„ç±» åŠ¨æ€ç”Ÿæˆç±»ï¼ˆå¦‚ CGLIB ä»£ç†ï¼‰ 4. java.lang.OutOfMemoryError: Direct buffer memory\nç›´æ¥å†…å­˜ä¸è¶³ï¼Œé€šå¸¸æ˜¯ NIO ä½¿ç”¨ä¸å½“ã€‚\næ¡ˆä¾‹ä¸€ï¼šThreadLocal å¯¼è‡´çš„å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOMã€‚\næ’æŸ¥æ­¥éª¤\n1. ç”Ÿæˆ Heap Dump\n1# æ–¹å¼ä¸€ï¼šOOM æ—¶è‡ªåŠ¨ç”Ÿæˆ 2java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/heapdump.hprof -jar app.jar 3 4# æ–¹å¼äºŒï¼šæ‰‹åŠ¨ç”Ÿæˆ 5jmap -dump:format=b,file=/tmp/heapdump.hprof \u0026lt;pid\u0026gt; 2. ä½¿ç”¨ MAT åˆ†æ\nä¸‹è½½ Eclipse Memory Analyzerï¼ˆMATï¼‰å·¥å…·ï¼Œæ‰“å¼€ Heap Dump æ–‡ä»¶ã€‚\n3. æŸ¥çœ‹ Dominator Tree\nDominator Tree æ˜¾ç¤ºå ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡ã€‚\nå‘ç°ï¼šThread å¯¹è±¡å ç”¨äº† 2GB å†…å­˜ã€‚\n4. æŸ¥çœ‹ Thread å¯¹è±¡çš„å¼•ç”¨é“¾\nå±•å¼€ Thread å¯¹è±¡ï¼Œå‘ç° threadLocals å­—æ®µä¸­æœ‰å¤§é‡ Entry å¯¹è±¡ã€‚\n5. æŸ¥çœ‹ Entry çš„ value\nå‘ç° value æ˜¯ä¸šåŠ¡å¯¹è±¡ï¼ˆUser Listï¼‰ï¼ŒåŒ…å« 10 ä¸‡æ¡æ•°æ®ã€‚\næ ¹å› \nä»£ç ä¸­ä½¿ç”¨äº† ThreadLocalï¼Œä½†æ²¡æœ‰è°ƒç”¨ remove()ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 8 cache.set(users); 9 10 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 11 doSomething(users); 12 13 // å¿˜è®°è°ƒç”¨ remove() 14 } 15} è§£å†³æ–¹æ¡ˆ\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 try { 8 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 9 cache.set(users); 10 doSomething(users); 11 } finally { 12 cache.remove(); // å¿…é¡»åœ¨ finally ä¸­æ¸…ç† 13 } 14 } 15} æ¡ˆä¾‹äºŒï¼šå¤§å¯¹è±¡å¯¼è‡´çš„ OOM é—®é¢˜ç°è±¡\nå¯¼å‡º Excel æ—¶ï¼Œåº”ç”¨ OOMã€‚\næ’æŸ¥æ­¥éª¤\n1. æŸ¥çœ‹ GC æ—¥å¿—\n1java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/tmp/gc.log -jar app.jar GC æ—¥å¿—æ˜¾ç¤ºï¼šFull GC é¢‘ç¹ï¼Œä½†å›æ”¶æ•ˆæœä¸æ˜æ˜¾ã€‚\n2. åˆ†æ Heap Dump\nå‘ç°å¤§é‡çš„ ArrayList å¯¹è±¡ï¼Œæ¯ä¸ªåŒ…å« 10 ä¸‡æ¡æ•°æ®ã€‚\næ ¹å› \nä½¿ç”¨ä¼ ç»Ÿçš„ POI å¯¼å‡º Excelï¼Œä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ã€‚\n1public void exportExcel() { 2 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); // æŸ¥è¯¢ 10 ä¸‡æ¡æ•°æ® 3 4 Workbook workbook = new XSSFWorkbook(); 5 Sheet sheet = workbook.createSheet(); 6 7 for (int i = 0; i \u0026lt; users.size(); i++) { 8 Row row = sheet.createRow(i); 9 // å¡«å……æ•°æ® 10 } 11 12 workbook.write(outputStream); 13} è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ EasyExcel æµå¼å†™å…¥\n1public void exportExcel() { 2 EasyExcel.write(outputStream, User.class) 3 .registerWriteHandler(new LongestMatchColumnWidthStyleStrategy()) 4 .sheet(\u0026#34;ç”¨æˆ·åˆ—è¡¨\u0026#34;) 5 .doWrite(() -\u0026gt; { 6 // åˆ†æ‰¹æŸ¥è¯¢ 7 int pageSize = 1000; 8 int pageNum = 1; 9 List\u0026lt;User\u0026gt; users; 10 List\u0026lt;User\u0026gt; allUsers = new ArrayList\u0026lt;\u0026gt;(); 11 12 do { 13 users = userMapper.selectPage(pageNum, pageSize); 14 allUsers.addAll(users); 15 pageNum++; 16 } while (users.size() == pageSize); 17 18 return allUsers; 19 }); 20} æ›´å¥½çš„æ–¹æ¡ˆï¼šä½¿ç”¨ EasyExcel çš„åˆ†æ‰¹å†™å…¥\n1public void exportExcel() { 2 ExcelWriter excelWriter = EasyExcel.write(outputStream, User.class).build(); 3 WriteSheet writeSheet = EasyExcel.writerSheet(\u0026#34;ç”¨æˆ·åˆ—è¡¨\u0026#34;).build(); 4 5 int pageSize = 1000; 6 int pageNum = 1; 7 List\u0026lt;User\u0026gt; users; 8 9 do { 10 users = userMapper.selectPage(pageNum, pageSize); 11 excelWriter.write(users, writeSheet); 12 pageNum++; 13 } while (users.size() == pageSize); 14 15 excelWriter.finish(); 16} æ¡ˆä¾‹ä¸‰ï¼šé™æ€é›†åˆå¯¼è‡´çš„å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nåº”ç”¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå†…å­˜æŒç»­å¢é•¿ã€‚\næ ¹å› \nä½¿ç”¨é™æ€é›†åˆç¼“å­˜æ•°æ®ï¼Œä½†æ²¡æœ‰æ¸…ç†æœºåˆ¶ã€‚\n1public class CacheManager { 2 3 private static final Map\u0026lt;String, Object\u0026gt; cache = new HashMap\u0026lt;\u0026gt;(); 4 5 public static void put(String key, Object value) { 6 cache.put(key, value); 7 } 8 9 public static Object get(String key) { 10 return cache.get(key); 11 } 12} è§£å†³æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ WeakHashMap\n1private static final Map\u0026lt;String, Object\u0026gt; cache = new WeakHashMap\u0026lt;\u0026gt;(); WeakHashMap çš„ key æ˜¯å¼±å¼•ç”¨ï¼Œå½“ key æ²¡æœ‰å¼ºå¼•ç”¨æ—¶ï¼Œä¼šè¢« GC å›æ”¶ã€‚\nè§£å†³æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Guava Cache\n1private static final Cache\u0026lt;String, Object\u0026gt; cache = CacheBuilder.newBuilder() 2 .maximumSize(10000) // æœ€å¤§ç¼“å­˜æ•°é‡ 3 .expireAfterWrite(10, TimeUnit.MINUTES) // å†™å…¥å 10 åˆ†é’Ÿè¿‡æœŸ 4 .build(); è§£å†³æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨ Redis\nå°†ç¼“å­˜æ”¾åˆ° Redisï¼Œé¿å…å ç”¨ JVM å†…å­˜ã€‚\nå¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ 1. ThreadLocal æœªæ¸…ç†\nåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹ï¼ŒThreadLocal å¿…é¡»è°ƒç”¨ remove()ã€‚\n2. é™æ€é›†åˆ\né™æ€é›†åˆçš„ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç›¸åŒï¼Œå®¹æ˜“å¯¼è‡´å†…å­˜æ³„æ¼ã€‚\n3. ç›‘å¬å™¨æœªæ³¨é”€\n1// æ³¨å†Œç›‘å¬å™¨ 2eventBus.register(listener); 3 4// å¿˜è®°æ³¨é”€ 5// eventBus.unregister(listener); 4. æ•°æ®åº“è¿æ¥æœªå…³é—­\n1Connection conn = DriverManager.getConnection(url); 2// å¿˜è®°å…³é—­ 3// conn.close(); 5. IO æµæœªå…³é—­\n1FileInputStream fis = new FileInputStream(file); 2// å¿˜è®°å…³é—­ 3// fis.close(); ä½¿ç”¨ try-with-resources è‡ªåŠ¨å…³é—­èµ„æºï¼š\n1try (FileInputStream fis = new FileInputStream(file)) { 2 // ä½¿ç”¨æµ 3} JVM å‚æ•°è°ƒä¼˜ å †å†…å­˜è®¾ç½®\n1-Xms4g # åˆå§‹å †å†…å­˜ 2-Xmx4g # æœ€å¤§å †å†…å­˜ï¼ˆå»ºè®®ä¸ Xms ç›¸åŒï¼Œé¿å…åŠ¨æ€æ‰©å®¹ï¼‰ å¹´è½»ä»£è®¾ç½®\n1-Xmn2g # å¹´è½»ä»£å¤§å°ï¼ˆå»ºè®®ä¸ºå †å†…å­˜çš„ 1/3 åˆ° 1/2ï¼‰ å…ƒç©ºé—´è®¾ç½®\n1-XX:MetaspaceSize=256m # åˆå§‹å…ƒç©ºé—´å¤§å° 2-XX:MaxMetaspaceSize=512m # æœ€å¤§å…ƒç©ºé—´å¤§å° GC æ—¥å¿—\n1-XX:+PrintGCDetails # æ‰“å° GC è¯¦ç»†ä¿¡æ¯ 2-XX:+PrintGCDateStamps # æ‰“å° GC æ—¶é—´æˆ³ 3-Xloggc:/tmp/gc.log # GC æ—¥å¿—æ–‡ä»¶ OOM æ—¶ç”Ÿæˆ Heap Dump\n1-XX:+HeapDumpOnOutOfMemoryError 2-XX:HeapDumpPath=/tmp/heapdump.hprof GC æ”¶é›†å™¨é€‰æ‹©\n1# G1 æ”¶é›†å™¨ï¼ˆæ¨èï¼‰ 2-XX:+UseG1GC 3-XX:MaxGCPauseMillis=200 # æœ€å¤§ GC åœé¡¿æ—¶é—´ 4 5# ZGCï¼ˆJDK 11+ï¼‰ 6-XX:+UseZGC ç›‘æ§ä¸é¢„è­¦ 1. ä½¿ç”¨ JVM ç›‘æ§å·¥å…·\nJConsoleï¼šJDK è‡ªå¸¦çš„ç›‘æ§å·¥å…· VisualVMï¼šå¯è§†åŒ–ç›‘æ§å·¥å…· Arthasï¼šé˜¿é‡Œå¼€æºçš„è¯Šæ–­å·¥å…· 2. ä½¿ç”¨ APM å·¥å…·\nSkyWalkingï¼šåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ Prometheus + Grafanaï¼šç›‘æ§ä¸å¯è§†åŒ– 3. è®¾ç½®å†…å­˜å‘Šè­¦\nå½“å †å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 80% æ—¶ï¼Œå‘é€å‘Šè­¦é€šçŸ¥ã€‚\næ€»ç»“ä¸æ€è€ƒ JVM OOM æ’æŸ¥çš„æ–¹æ³•è®ºï¼š\nç”Ÿæˆ Heap Dump ä½¿ç”¨ MAT åˆ†æå†…å­˜å ç”¨ æŸ¥çœ‹ Dominator Treeï¼Œæ‰¾åˆ°å ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡ åˆ†æå¼•ç”¨é“¾ï¼Œæ‰¾åˆ°æ ¹å›  ä¿®å¤ä»£ç ï¼Œé¿å…å†…å­˜æ³„æ¼ å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ï¼š\nThreadLocal æœªæ¸…ç† é™æ€é›†åˆæ— é™å¢é•¿ ç›‘å¬å™¨æœªæ³¨é”€ èµ„æºæœªå…³é—­ é¢„é˜²æªæ–½ï¼š\nCode Review é‡ç‚¹å…³æ³¨èµ„æºç®¡ç† ä½¿ç”¨ try-with-resources è‡ªåŠ¨å…³é—­èµ„æº å®šæœŸåˆ†æ Heap Dumpï¼Œæå‰å‘ç°é—®é¢˜ è®¾ç½®åˆç†çš„ JVM å‚æ•°å’Œç›‘æ§å‘Šè­¦ ä¸‹æ¬¡å½“ä½ çš„åº”ç”¨ OOM æ—¶ï¼ŒæŒ‰ç…§è¿™ä¸ªæ–¹æ³•è®ºä¸€æ­¥æ­¥æ’æŸ¥ï¼Œä¸€å®šèƒ½æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚\n","permalink":"http://localhost:1313/posts/2024/10/jvm-oom-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98%E4%BB%8E-heap-dump-%E5%88%B0%E6%A0%B9%E5%9B%A0%E5%88%86%E6%9E%90/","summary":"\u003cp\u003eç”Ÿäº§ç¯å¢ƒçš„ OOMï¼ˆOut Of Memoryï¼‰æ˜¯åç«¯å¼€å‘æœ€å¤´ç–¼çš„é—®é¢˜ä¹‹ä¸€ã€‚æœ¬æ–‡é€šè¿‡çœŸå®æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä½å’Œè§£å†³ JVM å†…å­˜é—®é¢˜ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ JVM å†…å­˜æ¨¡å‹ä¸ GC æœºåˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Heap Dump çš„ç”Ÿæˆä¸åˆ†ææ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨ MAT å·¥å…·å®šä½å†…å­˜æ³„æ¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"jvm-å†…å­˜æ¨¡å‹\"\u003eJVM å†…å­˜æ¨¡å‹\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå †å†…å­˜ï¼ˆHeapï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¹´è½»ä»£ï¼ˆYoung Generationï¼‰\n\u003cul\u003e\n\u003cli\u003eEden åŒºï¼šæ–°å¯¹è±¡åˆ†é…çš„åŒºåŸŸ\u003c/li\u003e\n\u003cli\u003eSurvivor åŒºï¼šS0 å’Œ S1ï¼Œå­˜æ”¾ç»è¿‡ä¸€æ¬¡ GC åå­˜æ´»çš„å¯¹è±¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eè€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eéå †å†…å­˜\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ–¹æ³•åŒºï¼ˆMetaspaceï¼‰ï¼šå­˜æ”¾ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡\u003c/li\u003e\n\u003cli\u003eæ ˆï¼ˆStackï¼‰ï¼šå­˜æ”¾å±€éƒ¨å˜é‡ã€æ–¹æ³•è°ƒç”¨\u003c/li\u003e\n\u003cli\u003eç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ï¼šNIO ä½¿ç”¨çš„å †å¤–å†…å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eGC æœºåˆ¶\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMinor GCï¼šæ¸…ç†å¹´è½»ä»£\u003c/li\u003e\n\u003cli\u003eMajor GCï¼šæ¸…ç†è€å¹´ä»£\u003c/li\u003e\n\u003cli\u003eFull GCï¼šæ¸…ç†æ•´ä¸ªå †å†…å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå¯¹è±¡æ™‹å‡\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ–°å¯¹è±¡åœ¨ Eden åŒºåˆ†é…\u003c/li\u003e\n\u003cli\u003eEden åŒºæ»¡äº†ï¼Œè§¦å‘ Minor GC\u003c/li\u003e\n\u003cli\u003eå­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ° Survivor åŒº\u003c/li\u003e\n\u003cli\u003eç»è¿‡å¤šæ¬¡ GC åï¼Œå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶æ„æ€è€ƒï¼š\u003c/strong\u003e JVM çš„åˆ†ä»£æ”¶é›†ä½“ç°äº†\u0026quot;å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•æ­»\u0026quot;çš„ç‰¹ç‚¹ã€‚å¹´è½»ä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¿«é€Ÿå›æ”¶çŸ­å‘½å¯¹è±¡ï¼›è€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå¤„ç†é•¿æœŸå­˜æ´»çš„å¯¹è±¡ã€‚è¿™ç§è®¾è®¡åœ¨æ€§èƒ½å’Œå†…å­˜åˆ©ç”¨ç‡ä¹‹é—´æ‰¾åˆ°äº†å¹³è¡¡ã€‚\u003c/p\u003e","title":"JVM OOM é—®é¢˜æ’æŸ¥å®æˆ˜ï¼šä» Heap Dump åˆ°æ ¹å› åˆ†æ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´çš„åŒæ­¥è°ƒç”¨ä¼šå¯¼è‡´å¼ºè€¦åˆå’Œæ€§èƒ½ç“¶é¢ˆã€‚æ¶ˆæ¯é˜Ÿåˆ—é€šè¿‡å¼‚æ­¥è§£è€¦ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚æœ¬æ–‡è®²è§£ RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å®æˆ˜åº”ç”¨ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒä»·å€¼ä¸é€‰å‹æ ‡å‡† æŒæ¡ RabbitMQ çš„æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæ¨¡å¼ å­¦ä¼šä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆ äº†è§£æ¶ˆæ¯å¹‚ç­‰æ€§ä¸é¡ºåºæ€§çš„å¤„ç† ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ åœºæ™¯ï¼šè®¢å•åˆ›å»ºæµç¨‹\nåŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š\n1@Service 2public class OrderService { 3 4 @Autowired 5 private InventoryService inventoryService; 6 7 @Autowired 8 private PaymentService paymentService; 9 10 @Autowired 11 private NotificationService notificationService; 12 13 public void createOrder(Order order) { 14 // 1. ä¿å­˜è®¢å• 15 orderMapper.insert(order); 16 17 // 2. æ‰£å‡åº“å­˜ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 18 inventoryService.deduct(order.getProductId(), order.getQuantity()); 19 20 // 3. åˆ›å»ºæ”¯ä»˜å•ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 21 paymentService.createPayment(order.getId()); 22 23 // 4. å‘é€é€šçŸ¥ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ 24 notificationService.sendOrderCreatedNotification(order.getUserId()); 25 } 26} é—®é¢˜ï¼š\nå“åº”æ—¶é—´é•¿ï¼šæ€»è€—æ—¶ = ä¿å­˜è®¢å• + æ‰£å‡åº“å­˜ + åˆ›å»ºæ”¯ä»˜å• + å‘é€é€šçŸ¥ å¼ºè€¦åˆï¼šä»»ä½•ä¸€ä¸ªæœåŠ¡ä¸å¯ç”¨ï¼Œæ•´ä¸ªæµç¨‹å¤±è´¥ æ€§èƒ½ç“¶é¢ˆï¼šä¸‹æ¸¸æœåŠ¡çš„æ€§èƒ½å½±å“ä¸Šæ¸¸æœåŠ¡ å¼‚æ­¥è§£è€¦çš„æ–¹æ¡ˆ\n1@Service 2public class OrderService { 3 4 @Autowired 5 private RabbitTemplate rabbitTemplate; 6 7 public void createOrder(Order order) { 8 // 1. ä¿å­˜è®¢å• 9 orderMapper.insert(order); 10 11 // 2. å‘é€æ¶ˆæ¯åˆ° MQ 12 OrderCreatedEvent event = new OrderCreatedEvent(order.getId(), order.getUserId()); 13 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, event); 14 } 15} 16 17// åº“å­˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ 18@Component 19public class InventoryListener { 20 21 @RabbitListener(queues = \u0026#34;inventory.queue\u0026#34;) 22 public void handleOrderCreated(OrderCreatedEvent event) { 23 inventoryService.deduct(event.getOrderId()); 24 } 25} å¥½å¤„ï¼š\nå“åº”æ—¶é—´çŸ­ï¼šåªéœ€è¦ä¿å­˜è®¢å• + å‘é€æ¶ˆæ¯ æ¾è€¦åˆï¼šä¸‹æ¸¸æœåŠ¡ä¸å¯ç”¨ä¸å½±å“è®¢å•åˆ›å»º å‰Šå³°å¡«è°·ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²æµé‡é«˜å³° æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹ï¼šRabbitMQ vs Kafka ç‰¹æ€§ RabbitMQ Kafka æ¶ˆæ¯æ¨¡å‹ æ¨æ¨¡å¼ï¼ˆPushï¼‰ æ‹‰æ¨¡å¼ï¼ˆPullï¼‰ ååé‡ ä¸‡çº§ ç™¾ä¸‡çº§ å»¶è¿Ÿ å¾®ç§’çº§ æ¯«ç§’çº§ æ¶ˆæ¯é¡ºåº é˜Ÿåˆ—çº§åˆ« åˆ†åŒºçº§åˆ« æ¶ˆæ¯æŒä¹…åŒ– æ”¯æŒ æ”¯æŒ é€‚ç”¨åœºæ™¯ ä¸šåŠ¡è§£è€¦ã€ä»»åŠ¡é˜Ÿåˆ— æ—¥å¿—æ”¶é›†ã€æµå¤„ç† é€‰æ‹© RabbitMQ çš„ç†ç”±\nä¸šåŠ¡åœºæ™¯éœ€è¦å¤æ‚çš„è·¯ç”±è§„åˆ™ï¼ˆExchange + Routing Keyï¼‰ éœ€è¦æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆACKï¼‰ æ¶ˆæ¯é‡ä¸å¤§ï¼Œæ›´å…³æ³¨å¯é æ€§ é€‰æ‹© Kafka çš„ç†ç”±\næµ·é‡æ—¥å¿—æ”¶é›† å®æ—¶æµå¤„ç† éœ€è¦æ¶ˆæ¯å›æº¯ RabbitMQ æ ¸å¿ƒæ¦‚å¿µ æ¶æ„å›¾\n1Producer â†’ Exchange â†’ Queue â†’ Consumer Exchangeï¼ˆäº¤æ¢æœºï¼‰\næ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œæ ¹æ®è·¯ç”±è§„åˆ™åˆ†å‘åˆ°é˜Ÿåˆ—ã€‚\nå››ç§ç±»å‹ï¼š\nDirectï¼šç²¾ç¡®åŒ¹é… Routing Key Topicï¼šæ¨¡ç³ŠåŒ¹é… Routing Keyï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰ Fanoutï¼šå¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ— Headersï¼šæ ¹æ®æ¶ˆæ¯å¤´åŒ¹é… Queueï¼ˆé˜Ÿåˆ—ï¼‰\nå­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚\nBindingï¼ˆç»‘å®šï¼‰\nExchange å’Œ Queue ä¹‹é—´çš„è·¯ç”±è§„åˆ™ã€‚\nå·¥ä½œæ¨¡å¼ 1. Simple æ¨¡å¼ï¼ˆç®€å•é˜Ÿåˆ—ï¼‰\nä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ã€‚\n1// ç”Ÿäº§è€… 2rabbitTemplate.convertAndSend(\u0026#34;simple.queue\u0026#34;, \u0026#34;Hello\u0026#34;); 3 4// æ¶ˆè´¹è€… 5@RabbitListener(queues = \u0026#34;simple.queue\u0026#34;) 6public void receive(String message) { 7 System.out.println(\u0026#34;æ”¶åˆ°æ¶ˆæ¯: \u0026#34; + message); 8} 2. Work æ¨¡å¼ï¼ˆå·¥ä½œé˜Ÿåˆ—ï¼‰\nä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯è½®è¯¢åˆ†å‘ã€‚\n1@RabbitListener(queues = \u0026#34;work.queue\u0026#34;) 2public void worker1(String message) { 3 System.out.println(\u0026#34;Worker1: \u0026#34; + message); 4} 5 6@RabbitListener(queues = \u0026#34;work.queue\u0026#34;) 7public void worker2(String message) { 8 System.out.println(\u0026#34;Worker2: \u0026#34; + message); 9} 3. Publish/Subscribe æ¨¡å¼ï¼ˆå‘å¸ƒè®¢é˜…ï¼‰\nä½¿ç”¨ Fanout Exchangeï¼Œæ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰é˜Ÿåˆ—ã€‚\n1// é…ç½® 2@Bean 3public FanoutExchange fanoutExchange() { 4 return new FanoutExchange(\u0026#34;fanout.exchange\u0026#34;); 5} 6 7@Bean 8public Queue queue1() { 9 return new Queue(\u0026#34;queue1\u0026#34;); 10} 11 12@Bean 13public Binding binding1(FanoutExchange fanoutExchange, Queue queue1) { 14 return BindingBuilder.bind(queue1).to(fanoutExchange); 15} 16 17// ç”Ÿäº§è€… 18rabbitTemplate.convertAndSend(\u0026#34;fanout.exchange\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;Hello\u0026#34;); 4. Routing æ¨¡å¼ï¼ˆè·¯ç”±ï¼‰\nä½¿ç”¨ Direct Exchangeï¼Œæ ¹æ® Routing Key ç²¾ç¡®åŒ¹é…ã€‚\n1// é…ç½® 2@Bean 3public DirectExchange directExchange() { 4 return new DirectExchange(\u0026#34;direct.exchange\u0026#34;); 5} 6 7@Bean 8public Binding bindingError(Queue errorQueue, DirectExchange directExchange) { 9 return BindingBuilder.bind(errorQueue).to(directExchange).with(\u0026#34;error\u0026#34;); 10} 11 12// ç”Ÿäº§è€… 13rabbitTemplate.convertAndSend(\u0026#34;direct.exchange\u0026#34;, \u0026#34;error\u0026#34;, \u0026#34;Error message\u0026#34;); 5. Topic æ¨¡å¼ï¼ˆä¸»é¢˜ï¼‰\nä½¿ç”¨ Topic Exchangeï¼Œæ”¯æŒé€šé…ç¬¦åŒ¹é…ã€‚\n*ï¼šåŒ¹é…ä¸€ä¸ªå•è¯ #ï¼šåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå•è¯ 1// é…ç½® 2@Bean 3public TopicExchange topicExchange() { 4 return new TopicExchange(\u0026#34;topic.exchange\u0026#34;); 5} 6 7@Bean 8public Binding bindingOrder(Queue orderQueue, TopicExchange topicExchange) { 9 return BindingBuilder.bind(orderQueue).to(topicExchange).with(\u0026#34;order.*\u0026#34;); 10} 11 12// ç”Ÿäº§è€… 13rabbitTemplate.convertAndSend(\u0026#34;topic.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, \u0026#34;Order created\u0026#34;); 14rabbitTemplate.convertAndSend(\u0026#34;topic.exchange\u0026#34;, \u0026#34;order.paid\u0026#34;, \u0026#34;Order paid\u0026#34;); æ¶æ„æ€è€ƒï¼š RabbitMQ çš„ Exchange æœºåˆ¶ä½“ç°äº†\u0026quot;ç­–ç•¥æ¨¡å¼\u0026quot;çš„æ€æƒ³ã€‚ä¸åŒç±»å‹çš„ Exchange å®ç°ä¸åŒçš„è·¯ç”±ç­–ç•¥ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸éœ€è¦å…³å¿ƒè·¯ç”±ç»†èŠ‚ã€‚è¿™ç§è®¾è®¡è®©ç³»ç»Ÿæ›´åŠ çµæ´»ï¼Œæ˜“äºæ‰©å±•ã€‚\næ¶ˆæ¯å¯é æ€§ä¿éšœ é—®é¢˜ä¸€ï¼šç”Ÿäº§è€…æ¶ˆæ¯ä¸¢å¤±\nç”Ÿäº§è€…å‘é€æ¶ˆæ¯åï¼ŒRabbitMQ å®•æœºï¼Œæ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼ˆPublisher Confirmï¼‰\n1spring: 2 rabbitmq: 3 publisher-confirm-type: correlated 4 publisher-returns: true 1@Configuration 2public class RabbitConfig { 3 4 @Bean 5 public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) { 6 RabbitTemplate template = new RabbitTemplate(connectionFactory); 7 8 // æ¶ˆæ¯å‘é€åˆ° Exchange çš„ç¡®è®¤ 9 template.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { 10 if (ack) { 11 log.info(\u0026#34;æ¶ˆæ¯å‘é€æˆåŠŸ\u0026#34;); 12 } else { 13 log.error(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥: {}\u0026#34;, cause); 14 // é‡è¯•æˆ–è®°å½•åˆ°æ•°æ®åº“ 15 } 16 }); 17 18 // æ¶ˆæ¯ä» Exchange è·¯ç”±åˆ° Queue çš„ç¡®è®¤ 19 template.setReturnsCallback(returned -\u0026gt; { 20 log.error(\u0026#34;æ¶ˆæ¯è·¯ç”±å¤±è´¥: {}\u0026#34;, returned.getMessage()); 21 }); 22 23 return template; 24 } 25} é—®é¢˜äºŒï¼šæ¶ˆæ¯åœ¨ RabbitMQ ä¸­ä¸¢å¤±\nRabbitMQ å®•æœºï¼Œå†…å­˜ä¸­çš„æ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ¶ˆæ¯æŒä¹…åŒ–\n1// 1. Exchange æŒä¹…åŒ– 2@Bean 3public DirectExchange directExchange() { 4 return new DirectExchange(\u0026#34;direct.exchange\u0026#34;, true, false); 5} 6 7// 2. Queue æŒä¹…åŒ– 8@Bean 9public Queue queue() { 10 return new Queue(\u0026#34;my.queue\u0026#34;, true); 11} 12 13// 3. æ¶ˆæ¯æŒä¹…åŒ– 14rabbitTemplate.convertAndSend(\u0026#34;direct.exchange\u0026#34;, \u0026#34;routing.key\u0026#34;, message, msg -\u0026gt; { 15 msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); 16 return msg; 17}); é—®é¢˜ä¸‰ï¼šæ¶ˆè´¹è€…æ¶ˆæ¯ä¸¢å¤±\næ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯åï¼Œè¿˜æ²¡å¤„ç†å®Œå°±å®•æœºï¼Œæ¶ˆæ¯ä¸¢å¤±ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨ ACK\n1spring: 2 rabbitmq: 3 listener: 4 simple: 5 acknowledge-mode: manual 1@RabbitListener(queues = \u0026#34;my.queue\u0026#34;) 2public void receive(String message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag) { 3 try { 4 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 5 processMessage(message); 6 7 // æ‰‹åŠ¨ç¡®è®¤ 8 channel.basicAck(tag, false); 9 } catch (Exception e) { 10 log.error(\u0026#34;æ¶ˆæ¯å¤„ç†å¤±è´¥\u0026#34;, e); 11 12 // æ‹’ç»æ¶ˆæ¯ï¼Œé‡æ–°å…¥é˜Ÿ 13 channel.basicNack(tag, false, true); 14 } 15} é¿å‘æç¤ºï¼š æ‰‹åŠ¨ ACK æ—¶ï¼Œå¦‚æœå¿˜è®°è°ƒç”¨ basicAck æˆ– basicNackï¼Œæ¶ˆæ¯ä¼šä¸€ç›´å¤„äº Unacked çŠ¶æ€ï¼Œå ç”¨å†…å­˜ã€‚å»ºè®®åœ¨ finally å—ä¸­ç¡®ä¿æ¶ˆæ¯è¢«ç¡®è®¤ã€‚\næ¶ˆæ¯å¹‚ç­‰æ€§ æ¶ˆæ¯å¯èƒ½è¢«é‡å¤æ¶ˆè´¹ï¼ˆç½‘ç»œæŠ–åŠ¨ã€æ¶ˆè´¹è€…é‡å¯ï¼‰ï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§ã€‚\næ–¹æ¡ˆä¸€ï¼šå”¯ä¸€ ID + æ•°æ®åº“å»é‡\n1@RabbitListener(queues = \u0026#34;order.queue\u0026#34;) 2public void handleOrder(OrderMessage message) { 3 String messageId = message.getMessageId(); 4 5 // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç† 6 if (messageLogMapper.exists(messageId)) { 7 log.info(\u0026#34;æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: {}\u0026#34;, messageId); 8 return; 9 } 10 11 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 12 processOrder(message); 13 14 // è®°å½•æ¶ˆæ¯ ID 15 messageLogMapper.insert(new MessageLog(messageId)); 16} æ–¹æ¡ˆäºŒï¼šRedis å»é‡\n1@RabbitListener(queues = \u0026#34;order.queue\u0026#34;) 2public void handleOrder(OrderMessage message) { 3 String messageId = message.getMessageId(); 4 String key = \u0026#34;message:processed:\u0026#34; + messageId; 5 6 // ä½¿ç”¨ SETNX ä¿è¯åŸå­æ€§ 7 Boolean success = redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;, 1, TimeUnit.HOURS); 8 if (!success) { 9 log.info(\u0026#34;æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: {}\u0026#34;, messageId); 10 return; 11 } 12 13 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 14 processOrder(message); 15} æ¶ˆæ¯é¡ºåºæ€§ RabbitMQ ä¸ä¿è¯å…¨å±€é¡ºåºï¼Œåªä¿è¯å•ä¸ªé˜Ÿåˆ—çš„é¡ºåºã€‚\næ–¹æ¡ˆï¼šæŒ‰ä¸šåŠ¡ ID è·¯ç”±åˆ°åŒä¸€é˜Ÿåˆ—\n1// ç”Ÿäº§è€…ï¼šæ ¹æ®è®¢å• ID è®¡ç®— Routing Key 2public void sendMessage(OrderMessage message) { 3 String routingKey = \u0026#34;order.\u0026#34; + (message.getOrderId() % 10); 4 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, routingKey, message); 5} 6 7// æ¶ˆè´¹è€…ï¼šæ¯ä¸ªé˜Ÿåˆ—åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€… 8@RabbitListener(queues = \u0026#34;order.queue.0\u0026#34;, concurrency = \u0026#34;1\u0026#34;) 9public void handleOrder0(OrderMessage message) { 10 processOrder(message); 11} æ­»ä¿¡é˜Ÿåˆ— æ¶ˆæ¯å¤„ç†å¤±è´¥åï¼Œå¯ä»¥å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Œé¿å…é˜»å¡æ­£å¸¸æ¶ˆæ¯ã€‚\né…ç½®æ­»ä¿¡é˜Ÿåˆ—\n1@Bean 2public Queue normalQueue() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-dead-letter-exchange\u0026#34;, \u0026#34;dlx.exchange\u0026#34;); 5 args.put(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;dlx.routing.key\u0026#34;); 6 return new Queue(\u0026#34;normal.queue\u0026#34;, true, false, false, args); 7} 8 9@Bean 10public Queue deadLetterQueue() { 11 return new Queue(\u0026#34;dead.letter.queue\u0026#34;); 12} 13 14@Bean 15public DirectExchange dlxExchange() { 16 return new DirectExchange(\u0026#34;dlx.exchange\u0026#34;); 17} 18 19@Bean 20public Binding dlxBinding() { 21 return BindingBuilder.bind(deadLetterQueue()).to(dlxExchange()).with(\u0026#34;dlx.routing.key\u0026#34;); 22} æ¶ˆè´¹è€…æ‹’ç»æ¶ˆæ¯\n1@RabbitListener(queues = \u0026#34;normal.queue\u0026#34;) 2public void receive(String message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag) { 3 try { 4 processMessage(message); 5 channel.basicAck(tag, false); 6 } catch (Exception e) { 7 // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ— 8 channel.basicNack(tag, false, false); 9 } 10} å»¶è¿Ÿé˜Ÿåˆ— å®ç°å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆã€‚\næ–¹æ¡ˆä¸€ï¼šTTL + æ­»ä¿¡é˜Ÿåˆ—\n1@Bean 2public Queue delayQueue() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-message-ttl\u0026#34;, 30000); // 30 ç§’åè¿‡æœŸ 5 args.put(\u0026#34;x-dead-letter-exchange\u0026#34;, \u0026#34;order.exchange\u0026#34;); 6 args.put(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;order.timeout\u0026#34;); 7 return new Queue(\u0026#34;delay.queue\u0026#34;, true, false, false, args); 8} æ–¹æ¡ˆäºŒï¼šRabbitMQ å»¶è¿Ÿæ’ä»¶\n1rabbitmq-plugins enable rabbitmq_delayed_message_exchange 1@Bean 2public CustomExchange delayExchange() { 3 Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); 4 args.put(\u0026#34;x-delayed-type\u0026#34;, \u0026#34;direct\u0026#34;); 5 return new CustomExchange(\u0026#34;delay.exchange\u0026#34;, \u0026#34;x-delayed-message\u0026#34;, true, false, args); 6} 7 8// å‘é€å»¶è¿Ÿæ¶ˆæ¯ 9rabbitTemplate.convertAndSend(\u0026#34;delay.exchange\u0026#34;, \u0026#34;routing.key\u0026#34;, message, msg -\u0026gt; { 10 msg.getMessageProperties().setDelay(30000); // å»¶è¿Ÿ 30 ç§’ 11 return msg; 12}); æ€»ç»“ä¸æ€è€ƒ RabbitMQ çš„æ ¸å¿ƒä»·å€¼æ˜¯å¼‚æ­¥è§£è€¦ï¼Œæå‡ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚\nä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆï¼š\nç”Ÿäº§è€…ç¡®è®¤ï¼šPublisher Confirm æ¶ˆæ¯æŒä¹…åŒ–ï¼šExchangeã€Queueã€Message éƒ½æŒä¹…åŒ– æ¶ˆè´¹è€…ç¡®è®¤ï¼šæ‰‹åŠ¨ ACK å¹‚ç­‰æ€§ï¼šå”¯ä¸€ ID + å»é‡ æ­»ä¿¡é˜Ÿåˆ—ï¼šå¤„ç†å¤±è´¥æ¶ˆæ¯ ä¸‹æ¬¡å½“ä½ çš„ç³»ç»Ÿéœ€è¦å¼‚æ­¥è§£è€¦æ—¶ï¼Œä¸å¦¨è¯•è¯• RabbitMQï¼Œä½“éªŒæ¶ˆæ¯é˜Ÿåˆ—çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/10/rabbitmq-%E5%9C%A8%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E8%A7%A3%E8%80%A6%E5%AE%9E%E8%B7%B5/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´çš„åŒæ­¥è°ƒç”¨ä¼šå¯¼è‡´å¼ºè€¦åˆå’Œæ€§èƒ½ç“¶é¢ˆã€‚æ¶ˆæ¯é˜Ÿåˆ—é€šè¿‡å¼‚æ­¥è§£è€¦ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚æœ¬æ–‡è®²è§£ RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å®æˆ˜åº”ç”¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒä»·å€¼ä¸é€‰å‹æ ‡å‡†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ RabbitMQ çš„æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæ¨¡å¼\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä¿éšœæ¶ˆæ¯å¯é æ€§çš„å®Œæ•´æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£æ¶ˆæ¯å¹‚ç­‰æ€§ä¸é¡ºåºæ€§çš„å¤„ç†\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—\"\u003eä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼šè®¢å•åˆ›å»ºæµç¨‹\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Service\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrderService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eInventoryService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einventoryService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epaymentService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Autowired\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eNotificationService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enotificationService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecreateOrder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. ä¿å­˜è®¢å•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eorderMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einsert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. æ‰£å‡åº“å­˜ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003einventoryService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ededuct\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetProductId\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆ›å»ºæ”¯ä»˜å•ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003epaymentService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecreatePayment\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. å‘é€é€šçŸ¥ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003enotificationService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esendOrderCreatedNotification\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e","title":"RabbitMQ åœ¨äº¤æ˜“ç³»ç»Ÿä¸­çš„å¼‚æ­¥è§£è€¦å®è·µ"},{"content":"DDDï¼ˆDomain-Driven Designï¼‰æ˜¯ä¸€å¥—å¤æ‚ä¸šåŠ¡ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•è®ºã€‚ä½†å¾ˆå¤šäººå­¦äº† DDD çš„æ¦‚å¿µï¼Œå´ä¸çŸ¥é“å¦‚ä½•è½åœ°ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªç”µå•†è®¢å•ç³»ç»Ÿçš„æ¡ˆä¾‹ï¼Œè®²è§£ DDD çš„å®æˆ˜åº”ç”¨ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ DDD çš„æ ¸å¿ƒæ¦‚å¿µï¼šå®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡ æŒæ¡é™ç•Œä¸Šä¸‹æ–‡çš„åˆ’åˆ†æ–¹æ³• å­¦ä¼šç”¨é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦ äº†è§£ DDD åˆ†å±‚æ¶æ„çš„ä»£ç ç»„ç»‡ ä¸ºä»€ä¹ˆéœ€è¦ DDDï¼Ÿ ä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨ç®€å•ä¸šåŠ¡åœºæ™¯ä¸‹å¤Ÿç”¨ï¼Œä½†å½“ä¸šåŠ¡å¤æ‚åº¦å¢åŠ æ—¶ï¼Œä¼šå‡ºç°å‡ ä¸ªé—®é¢˜ï¼š\nService å±‚é€»è¾‘è‡ƒè‚¿\næ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å †åœ¨ Service å±‚ï¼Œä¸€ä¸ª OrderService å¯èƒ½æœ‰å‡ åƒè¡Œä»£ç ã€‚\nä¸šåŠ¡è§„åˆ™æ•£è½å„å¤„\nè®¢å•çš„çŠ¶æ€æµè½¬è§„åˆ™å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ª Service æ–¹æ³•ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚\né¢†åŸŸçŸ¥è¯†æµå¤±\nä»£ç ä¸­å……æ–¥ç€ updateStatus(orderId, 3)ï¼Œæ²¡äººçŸ¥é“ 3 ä»£è¡¨ä»€ä¹ˆçŠ¶æ€ã€‚\nDDD é€šè¿‡é¢†åŸŸå»ºæ¨¡ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ï¼Œæå‡å¯ç»´æŠ¤æ€§ã€‚\nDDD æ ¸å¿ƒæ¦‚å¿µ å®ä½“ï¼ˆEntityï¼‰\næœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå†…æ ‡è¯†ä¸å˜ã€‚æ¯”å¦‚è®¢å•ã€ç”¨æˆ·ã€‚\n1public class Order { 2 private OrderId id; // å”¯ä¸€æ ‡è¯† 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 // ä¸šåŠ¡æ–¹æ³• 8 public void pay() { 9 if (this.status != OrderStatus.PENDING_PAYMENT) { 10 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 11 } 12 this.status = OrderStatus.PAID; 13 } 14} å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰\næ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œé€šè¿‡å±æ€§å€¼åˆ¤æ–­ç›¸ç­‰æ€§ã€‚æ¯”å¦‚åœ°å€ã€é‡‘é¢ã€‚\n1public class Money { 2 private final BigDecimal amount; 3 private final Currency currency; 4 5 public Money(BigDecimal amount, Currency currency) { 6 if (amount.compareTo(BigDecimal.ZERO) \u0026lt; 0) { 7 throw new IllegalArgumentException(\u0026#34;é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°\u0026#34;); 8 } 9 this.amount = amount; 10 this.currency = currency; 11 } 12 13 public Money add(Money other) { 14 if (!this.currency.equals(other.currency)) { 15 throw new IllegalArgumentException(\u0026#34;è´§å¸ç±»å‹ä¸ä¸€è‡´\u0026#34;); 16 } 17 return new Money(this.amount.add(other.amount), this.currency); 18 } 19} å€¼å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€æœ‰æ“ä½œéƒ½è¿”å›æ–°å¯¹è±¡ã€‚\nèšåˆæ ¹ï¼ˆAggregate Rootï¼‰\nèšåˆæ˜¯ä¸€ç»„ç›¸å…³å¯¹è±¡çš„é›†åˆï¼Œèšåˆæ ¹æ˜¯èšåˆçš„å…¥å£ã€‚å¤–éƒ¨åªèƒ½é€šè¿‡èšåˆæ ¹è®¿é—®èšåˆå†…çš„å¯¹è±¡ã€‚\n1public class Order { // èšåˆæ ¹ 2 private OrderId id; 3 private List\u0026lt;OrderItem\u0026gt; items; // èšåˆå†…çš„å®ä½“ 4 5 // å¤–éƒ¨ä¸èƒ½ç›´æ¥ä¿®æ”¹ itemsï¼Œå¿…é¡»é€šè¿‡èšåˆæ ¹çš„æ–¹æ³• 6 public void addItem(Product product, int quantity) { 7 OrderItem item = new OrderItem(product, quantity); 8 this.items.add(item); 9 } 10} èšåˆæ ¹çš„ä½œç”¨æ˜¯ä¿æŠ¤èšåˆçš„ä¸å˜æ€§ï¼ˆInvariantï¼‰ã€‚\né¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰\nä¸å±äºä»»ä½•å®ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ”¾åœ¨é¢†åŸŸæœåŠ¡ä¸­ã€‚\n1public class PricingService { 2 3 public Money calculateTotalPrice(Order order) { 4 Money total = Money.zero(); 5 for (OrderItem item : order.getItems()) { 6 Money itemPrice = item.getProduct().getPrice().multiply(item.getQuantity()); 7 total = total.add(itemPrice); 8 } 9 return total; 10 } 11} æ¶æ„æ€è€ƒï¼š å®ä½“å’Œå€¼å¯¹è±¡çš„åŒºåˆ«åœ¨äºæ˜¯å¦æœ‰å”¯ä¸€æ ‡è¯†ã€‚è®¢å•æœ‰è®¢å•å·ï¼Œæ˜¯å®ä½“ï¼›é‡‘é¢æ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œæ˜¯å€¼å¯¹è±¡ã€‚åˆ¤æ–­æ ‡å‡†æ˜¯ï¼šå¦‚æœä¸¤ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§éƒ½ç›¸åŒï¼Œå®ƒä»¬æ˜¯å¦åº”è¯¥è¢«è§†ä¸ºåŒä¸€ä¸ªå¯¹è±¡ï¼Ÿ\né™ç•Œä¸Šä¸‹æ–‡ï¼šåˆ’åˆ†é¢†åŸŸè¾¹ç•Œ ä¸€ä¸ªå¤æ‚ç³»ç»ŸåŒ…å«å¤šä¸ªå­åŸŸï¼Œæ¯ä¸ªå­åŸŸæœ‰è‡ªå·±çš„é¢†åŸŸæ¨¡å‹ã€‚é™ç•Œä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰å®šä¹‰äº†é¢†åŸŸæ¨¡å‹çš„è¾¹ç•Œã€‚\næ¡ˆä¾‹ï¼šç”µå•†ç³»ç»Ÿçš„é™ç•Œä¸Šä¸‹æ–‡\nè®¢å•ä¸Šä¸‹æ–‡ï¼š è®¢å•ã€è®¢å•é¡¹ã€è®¢å•çŠ¶æ€ åº“å­˜ä¸Šä¸‹æ–‡ï¼š å•†å“ã€åº“å­˜ã€åº“å­˜æ‰£å‡ æ”¯ä»˜ä¸Šä¸‹æ–‡ï¼š æ”¯ä»˜å•ã€æ”¯ä»˜æ–¹å¼ã€æ”¯ä»˜çŠ¶æ€ ç‰©æµä¸Šä¸‹æ–‡ï¼š ç‰©æµå•ã€ç‰©æµçŠ¶æ€ã€ç‰©æµå…¬å¸ æ¯ä¸ªä¸Šä¸‹æ–‡æœ‰è‡ªå·±çš„é¢†åŸŸæ¨¡å‹ã€‚æ¯”å¦‚\u0026quot;å•†å“\u0026quot;åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„å«ä¹‰ä¸åŒï¼š\nè®¢å•ä¸Šä¸‹æ–‡ï¼šå•†å“æ˜¯è®¢å•é¡¹çš„ä¸€éƒ¨åˆ†ï¼Œå…³æ³¨å•†å“åç§°ã€ä»·æ ¼ åº“å­˜ä¸Šä¸‹æ–‡ï¼šå•†å“æ˜¯åº“å­˜ç®¡ç†çš„å¯¹è±¡ï¼Œå…³æ³¨åº“å­˜æ•°é‡ã€ä»“åº“ä½ç½® ä¸Šä¸‹æ–‡æ˜ å°„ï¼ˆContext Mappingï¼‰\nä¸åŒä¸Šä¸‹æ–‡ä¹‹é—´éœ€è¦åä½œï¼Œé€šè¿‡ä¸Šä¸‹æ–‡æ˜ å°„å®šä¹‰åä½œæ–¹å¼ï¼š\nå…±äº«å†…æ ¸ï¼ˆShared Kernelï¼‰ï¼š ä¸¤ä¸ªä¸Šä¸‹æ–‡å…±äº«éƒ¨åˆ†é¢†åŸŸæ¨¡å‹ å®¢æˆ·-ä¾›åº”å•†ï¼ˆCustomer-Supplierï¼‰ï¼š ä¸€ä¸ªä¸Šä¸‹æ–‡ä¾èµ–å¦ä¸€ä¸ªä¸Šä¸‹æ–‡ é˜²è…å±‚ï¼ˆAnti-Corruption Layerï¼‰ï¼š é€šè¿‡é€‚é…å™¨éš”ç¦»å¤–éƒ¨ç³»ç»Ÿ æ¡ˆä¾‹ï¼šè®¢å•ä¸Šä¸‹æ–‡ä¾èµ–åº“å­˜ä¸Šä¸‹æ–‡\n1// è®¢å•ä¸Šä¸‹æ–‡ä¸­çš„é˜²è…å±‚ 2public class InventoryAdapter { 3 4 @Autowired 5 private InventoryClient inventoryClient; 6 7 public boolean checkStock(ProductId productId, int quantity) { 8 // è°ƒç”¨åº“å­˜ä¸Šä¸‹æ–‡çš„æ¥å£ 9 InventoryDTO inventory = inventoryClient.getInventory(productId.getValue()); 10 return inventory.getStock() \u0026gt;= quantity; 11 } 12} é˜²è…å±‚çš„ä½œç”¨æ˜¯ï¼šéš”ç¦»å¤–éƒ¨ç³»ç»Ÿçš„å˜åŒ–ï¼Œä¿æŠ¤æœ¬ä¸Šä¸‹æ–‡çš„é¢†åŸŸæ¨¡å‹ã€‚\né¢†åŸŸäº‹ä»¶ï¼šå®ç°æœåŠ¡è§£è€¦ é¢†åŸŸäº‹ä»¶æ˜¯é¢†åŸŸä¸­å‘ç”Ÿçš„é‡è¦äº‹æƒ…ï¼Œæ¯”å¦‚\u0026quot;è®¢å•å·²åˆ›å»º\u0026quot;ã€\u0026ldquo;è®¢å•å·²æ”¯ä»˜\u0026rdquo;ã€‚\nå‘å¸ƒé¢†åŸŸäº‹ä»¶\n1public class Order { 2 3 public void pay() { 4 if (this.status != OrderStatus.PENDING_PAYMENT) { 5 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 6 } 7 this.status = OrderStatus.PAID; 8 9 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ 10 DomainEventPublisher.publish(new OrderPaidEvent(this.id, this.userId)); 11 } 12} ç›‘å¬é¢†åŸŸäº‹ä»¶\n1@Component 2public class OrderEventListener { 3 4 @Autowired 5 private InventoryService inventoryService; 6 7 @EventListener 8 public void handleOrderPaid(OrderPaidEvent event) { 9 // è®¢å•æ”¯ä»˜åï¼Œæ‰£å‡åº“å­˜ 10 inventoryService.deduct(event.getOrderId()); 11 } 12} é¢†åŸŸäº‹ä»¶çš„å¥½å¤„ï¼š\nè§£è€¦ï¼šè®¢å•ä¸Šä¸‹æ–‡ä¸éœ€è¦çŸ¥é“åº“å­˜ä¸Šä¸‹æ–‡çš„å­˜åœ¨ æ‰©å±•æ€§ï¼šæ–°å¢ç›‘å¬å™¨ä¸éœ€è¦ä¿®æ”¹è®¢å•ä»£ç  å®¡è®¡ï¼šäº‹ä»¶æµè®°å½•äº†ç³»ç»Ÿçš„æ‰€æœ‰å˜åŒ– æ¶æ„æ€è€ƒï¼š é¢†åŸŸäº‹ä»¶æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEDAï¼‰çš„åŸºç¡€ã€‚å®ƒè®©ç³»ç»Ÿä»\u0026quot;è°ƒç”¨é©±åŠ¨\u0026quot;å˜æˆ\u0026quot;äº‹ä»¶é©±åŠ¨\u0026quot;ï¼Œæå‡äº†ç³»ç»Ÿçš„æ¾è€¦åˆæ€§ã€‚ç±»ä¼¼çš„æ€æƒ³è¿˜æœ‰ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€å‘å¸ƒè®¢é˜…æ¨¡å¼ã€CQRSã€‚\nDDD åˆ†å±‚æ¶æ„ DDD æ¨èçš„åˆ†å±‚æ¶æ„ï¼š\n1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ ç”¨æˆ·æ¥å£å±‚ï¼ˆUser Interfaceï¼‰ â”‚ Controllerã€DTO 3â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 4â”‚ åº”ç”¨å±‚ï¼ˆApplicationï¼‰ â”‚ ApplicationServiceã€äº‹ä»¶å‘å¸ƒ 5â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 6â”‚ é¢†åŸŸå±‚ï¼ˆDomainï¼‰ â”‚ Entityã€ValueObjectã€DomainService 7â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 8â”‚ åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰ â”‚ Repositoryã€MQã€ç¼“å­˜ 9â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ç”¨æˆ·æ¥å£å±‚\nå¤„ç† HTTP è¯·æ±‚ï¼Œè°ƒç”¨åº”ç”¨å±‚æœåŠ¡ã€‚\n1@RestController 2@RequestMapping(\u0026#34;/orders\u0026#34;) 3public class OrderController { 4 5 @Autowired 6 private OrderApplicationService orderApplicationService; 7 8 @PostMapping 9 public OrderDTO createOrder(@RequestBody CreateOrderRequest request) { 10 OrderId orderId = orderApplicationService.createOrder(request); 11 return orderApplicationService.getOrder(orderId); 12 } 13} åº”ç”¨å±‚\nç¼–æ’é¢†åŸŸå¯¹è±¡ï¼Œå¤„ç†äº‹åŠ¡å’Œäº‹ä»¶å‘å¸ƒã€‚\n1@Service 2public class OrderApplicationService { 3 4 @Autowired 5 private OrderRepository orderRepository; 6 7 @Autowired 8 private DomainEventPublisher eventPublisher; 9 10 @Transactional 11 public OrderId createOrder(CreateOrderRequest request) { 12 // åˆ›å»ºè®¢å•èšåˆ 13 Order order = Order.create(request.getUserId(), request.getItems()); 14 15 // ä¿å­˜è®¢å• 16 orderRepository.save(order); 17 18 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ 19 eventPublisher.publish(new OrderCreatedEvent(order.getId())); 20 21 return order.getId(); 22 } 23} é¢†åŸŸå±‚\næ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨æ¡†æ¶ã€‚\n1public class Order { 2 private OrderId id; 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 public static Order create(UserId userId, List\u0026lt;OrderItem\u0026gt; items) { 8 if (items.isEmpty()) { 9 throw new IllegalArgumentException(\u0026#34;è®¢å•é¡¹ä¸èƒ½ä¸ºç©º\u0026#34;); 10 } 11 Order order = new Order(); 12 order.id = OrderId.generate(); 13 order.userId = userId; 14 order.status = OrderStatus.PENDING_PAYMENT; 15 order.items = items; 16 return order; 17 } 18 19 public void pay() { 20 if (this.status != OrderStatus.PENDING_PAYMENT) { 21 throw new IllegalStateException(\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;); 22 } 23 this.status = OrderStatus.PAID; 24 } 25} åŸºç¡€è®¾æ–½å±‚\nå®ç°é¢†åŸŸå±‚å®šä¹‰çš„æ¥å£ï¼Œå¤„ç†æŒä¹…åŒ–ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ã€‚\n1@Repository 2public class OrderRepositoryImpl implements OrderRepository { 3 4 @Autowired 5 private OrderMapper orderMapper; 6 7 @Override 8 public void save(Order order) { 9 OrderPO po = OrderConverter.toPO(order); 10 orderMapper.insert(po); 11 } 12 13 @Override 14 public Order findById(OrderId id) { 15 OrderPO po = orderMapper.selectById(id.getValue()); 16 return OrderConverter.toDomain(po); 17 } 18} é¿å‘æç¤ºï¼š é¢†åŸŸå±‚ä¸åº”è¯¥ä¾èµ–åŸºç¡€è®¾æ–½å±‚ã€‚Repository æ¥å£å®šä¹‰åœ¨é¢†åŸŸå±‚ï¼Œå®ç°åœ¨åŸºç¡€è®¾æ–½å±‚ã€‚è¿™æ˜¯ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰çš„ä½“ç°ã€‚\nDDD çš„é€‚ç”¨åœºæ™¯ DDD ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒé€‚åˆå¤æ‚ä¸šåŠ¡ç³»ç»Ÿï¼Œä¸é€‚åˆç®€å•çš„ CRUD åº”ç”¨ã€‚\né€‚åˆ DDD çš„åœºæ™¯ï¼š\nä¸šåŠ¡è§„åˆ™å¤æ‚ï¼Œéœ€è¦é¢‘ç¹å˜æ›´ å¤šä¸ªå›¢é˜Ÿåä½œå¼€å‘ ç³»ç»Ÿéœ€è¦é•¿æœŸæ¼”è¿› ä¸é€‚åˆ DDD çš„åœºæ™¯ï¼š\nç®€å•çš„å¢åˆ æ”¹æŸ¥ ä¸šåŠ¡é€»è¾‘å¾ˆå°‘ é¡¹ç›®å‘¨æœŸçŸ­ï¼Œä¸éœ€è¦é•¿æœŸç»´æŠ¤ æ€»ç»“ä¸æ€è€ƒ DDD çš„æ ¸å¿ƒæ˜¯ï¼šç”¨ä»£ç è¡¨è¾¾ä¸šåŠ¡è¯­è¨€ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ã€‚\né€šè¿‡å®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹å»ºæ¨¡é¢†åŸŸå¯¹è±¡ é€šè¿‡é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†é¢†åŸŸè¾¹ç•Œ é€šè¿‡é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦ é€šè¿‡åˆ†å±‚æ¶æ„éš”ç¦»ä¸šåŠ¡é€»è¾‘å’ŒæŠ€æœ¯å®ç° DDD ä¸æ˜¯æŠ€æœ¯ï¼Œè€Œæ˜¯æ€ç»´æ–¹å¼ã€‚å®ƒè¦æ±‚å¼€å‘è€…æ·±å…¥ç†è§£ä¸šåŠ¡ï¼Œä¸ä¸šåŠ¡ä¸“å®¶å…±åŒå»ºæ¨¡ã€‚è¿™æ˜¯ä¸€ä¸ªæŒç»­è¿­ä»£çš„è¿‡ç¨‹ã€‚\nä¸‹æ¬¡å½“ä½ çš„ Service å±‚ä»£ç è¶…è¿‡ 500 è¡Œæ—¶ï¼Œä¸å¦¨è¯•è¯• DDDï¼Œé‡æ–°å®¡è§†ä½ çš„é¢†åŸŸæ¨¡å‹ã€‚\n","permalink":"http://localhost:1313/posts/2024/09/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1ddd%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E4%BB%A3%E7%A0%81/","summary":"\u003cp\u003eDDDï¼ˆDomain-Driven Designï¼‰æ˜¯ä¸€å¥—å¤æ‚ä¸šåŠ¡ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•è®ºã€‚ä½†å¾ˆå¤šäººå­¦äº† DDD çš„æ¦‚å¿µï¼Œå´ä¸çŸ¥é“å¦‚ä½•è½åœ°ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªç”µå•†è®¢å•ç³»ç»Ÿçš„æ¡ˆä¾‹ï¼Œè®²è§£ DDD çš„å®æˆ˜åº”ç”¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ DDD çš„æ ¸å¿ƒæ¦‚å¿µï¼šå®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é™ç•Œä¸Šä¸‹æ–‡çš„åˆ’åˆ†æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç”¨é¢†åŸŸäº‹ä»¶å®ç°æœåŠ¡è§£è€¦\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ DDD åˆ†å±‚æ¶æ„çš„ä»£ç ç»„ç»‡\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦-ddd\"\u003eä¸ºä»€ä¹ˆéœ€è¦ DDDï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨ç®€å•ä¸šåŠ¡åœºæ™¯ä¸‹å¤Ÿç”¨ï¼Œä½†å½“ä¸šåŠ¡å¤æ‚åº¦å¢åŠ æ—¶ï¼Œä¼šå‡ºç°å‡ ä¸ªé—®é¢˜ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eService å±‚é€»è¾‘è‡ƒè‚¿\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å †åœ¨ Service å±‚ï¼Œä¸€ä¸ª OrderService å¯èƒ½æœ‰å‡ åƒè¡Œä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¸šåŠ¡è§„åˆ™æ•£è½å„å¤„\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eè®¢å•çš„çŠ¶æ€æµè½¬è§„åˆ™å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ª Service æ–¹æ³•ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé¢†åŸŸçŸ¥è¯†æµå¤±\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eä»£ç ä¸­å……æ–¥ç€ \u003ccode\u003eupdateStatus(orderId, 3)\u003c/code\u003eï¼Œæ²¡äººçŸ¥é“ 3 ä»£è¡¨ä»€ä¹ˆçŠ¶æ€ã€‚\u003c/p\u003e\n\u003cp\u003eDDD é€šè¿‡é¢†åŸŸå»ºæ¨¡ï¼Œè®©ä»£ç æ›´è´´è¿‘ä¸šåŠ¡ï¼Œæå‡å¯ç»´æŠ¤æ€§ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"ddd-æ ¸å¿ƒæ¦‚å¿µ\"\u003eDDD æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå®ä½“ï¼ˆEntityï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå†…æ ‡è¯†ä¸å˜ã€‚æ¯”å¦‚è®¢å•ã€ç”¨æˆ·ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å”¯ä¸€æ ‡è¯†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸šåŠ¡æ–¹æ³•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epay\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePENDING_PAYMENT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ethrow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eIllegalStateException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePAID\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eå€¼å¯¹è±¡ï¼ˆValue Objectï¼‰\u003c/strong\u003e\u003c/p\u003e","title":"é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰è½åœ°å®è·µï¼šä»ç†è®ºåˆ°ä»£ç "},{"content":"å®¹å™¨åŒ–å·²ç»æˆä¸ºç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†æ–¹å¼ã€‚Docker è®©åº”ç”¨éƒ¨ç½²å˜å¾—ç®€å•ã€å¯é ã€å¯ç§»æ¤ã€‚æœ¬æ–‡è®²è§£ Docker åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ Dockerfile çš„ç¼–å†™æŠ€å·§ä¸ä¼˜åŒ–æ–¹æ³• ç†è§£ Docker é•œåƒçš„åˆ†å±‚æ„å»ºåŸç† å­¦ä¼šä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒä½“ç§¯ äº†è§£ Docker Compose ç¼–æ’å¤šæœåŠ¡ç¯å¢ƒ ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–ï¼Ÿ ä¼ ç»Ÿéƒ¨ç½²çš„ç—›ç‚¹\nç¯å¢ƒä¸ä¸€è‡´ï¼š\u0026ldquo;åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘\u0026rdquo; ä¾èµ–ç®¡ç†å¤æ‚ï¼šJDKã€Tomcatã€MySQL ç‰ˆæœ¬ä¸ä¸€è‡´ éƒ¨ç½²æµç¨‹ç¹çï¼šæ‰‹åŠ¨ä¸Šä¼ ã€è§£å‹ã€é…ç½®ã€å¯åŠ¨ èµ„æºåˆ©ç”¨ç‡ä½ï¼šä¸€å°æœåŠ¡å™¨åªè·‘ä¸€ä¸ªåº”ç”¨ å®¹å™¨åŒ–çš„ä¼˜åŠ¿\nç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´ å¿«é€Ÿéƒ¨ç½²ï¼šç§’çº§å¯åŠ¨ï¼Œä¸€é”®éƒ¨ç½² èµ„æºéš”ç¦»ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“ æ˜“äºæ‰©å±•ï¼šæ°´å¹³æ‰©å±•åªéœ€å¯åŠ¨æ›´å¤šå®¹å™¨ Dockerfile åŸºç¡€ æœ€ç®€å•çš„ Dockerfile\n1FROM openjdk:11-jre-slim 2COPY app.jar /app.jar 3ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] æ„å»ºé•œåƒ\n1docker build -t myapp:1.0 . è¿è¡Œå®¹å™¨\n1docker run -d -p 8080:8080 myapp:1.0 Dockerfile æœ€ä½³å®è·µ 1. é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ ä¸å¥½çš„åšæ³•\n1FROM ubuntu:20.04 2RUN apt-get update \u0026amp;\u0026amp; apt-get install -y openjdk-11-jdk é•œåƒå¤§å°ï¼š600MB+\nå¥½çš„åšæ³•\n1FROM openjdk:11-jre-slim é•œåƒå¤§å°ï¼š200MB\næ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨ Alpine\n1FROM openjdk:11-jre-alpine é•œåƒå¤§å°ï¼š150MB\né€‰æ‹©åŸåˆ™ï¼š ä¼˜å…ˆä½¿ç”¨å®˜æ–¹é•œåƒï¼Œé€‰æ‹©æœ€å°çš„æ»¡è¶³éœ€æ±‚çš„ç‰ˆæœ¬ï¼ˆslim \u0026gt; alpineï¼‰\n2. åˆ©ç”¨æ„å»ºç¼“å­˜ Docker æ„å»ºé•œåƒæ—¶ï¼Œä¼šç¼“å­˜æ¯ä¸€å±‚ã€‚å¦‚æœæŸä¸€å±‚æ²¡æœ‰å˜åŒ–ï¼Œä¼šç›´æ¥ä½¿ç”¨ç¼“å­˜ã€‚\nä¸å¥½çš„åšæ³•\n1FROM openjdk:11-jre-slim 2COPY . /app 3RUN cd /app \u0026amp;\u0026amp; ./mvnw clean package æ¯æ¬¡ä»£ç å˜åŒ–ï¼Œéƒ½è¦é‡æ–°ä¸‹è½½ä¾èµ–ã€‚\nå¥½çš„åšæ³•ï¼šåˆ†ç¦»ä¾èµ–å’Œä»£ç \n1FROM openjdk:11-jre-slim 2 3# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ 4COPY pom.xml /app/ 5COPY mvnw /app/ 6COPY .mvn /app/.mvn 7WORKDIR /app 8RUN ./mvnw dependency:go-offline 9 10# å†å¤åˆ¶ä»£ç  11COPY src /app/src 12RUN ./mvnw clean package -DskipTests 13 14ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app/target/app.jar\u0026#34;] è¿™æ ·ï¼Œåªæœ‰ pom.xml å˜åŒ–æ—¶æ‰ä¼šé‡æ–°ä¸‹è½½ä¾èµ–ã€‚\n3. å¤šé˜¶æ®µæ„å»º é—®é¢˜ï¼š æ„å»ºå·¥å…·ï¼ˆMavenã€Gradleï¼‰ä¼šå¢åŠ é•œåƒä½“ç§¯ã€‚\nè§£å†³æ–¹æ¡ˆï¼š ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œåªä¿ç•™è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶ã€‚\n1# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º 2FROM maven:3.8-openjdk-11 AS builder 3WORKDIR /app 4COPY pom.xml . 5RUN mvn dependency:go-offline 6COPY src ./src 7RUN mvn clean package -DskipTests 8 9# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ 10FROM openjdk:11-jre-slim 11WORKDIR /app 12COPY --from=builder /app/target/app.jar . 13EXPOSE 8080 14ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;app.jar\u0026#34;] æ•ˆæœï¼š\næ„å»ºé˜¶æ®µé•œåƒï¼š800MB æœ€ç»ˆé•œåƒï¼š200MB 4. å‡å°‘é•œåƒå±‚æ•° ä¸å¥½çš„åšæ³•\n1RUN apt-get update 2RUN apt-get install -y curl 3RUN apt-get install -y vim 4RUN apt-get clean æ¯ä¸ª RUN éƒ½ä¼šåˆ›å»ºä¸€å±‚ï¼Œå¢åŠ é•œåƒä½“ç§¯ã€‚\nå¥½çš„åšæ³•ï¼šåˆå¹¶å‘½ä»¤\n1RUN apt-get update \u0026amp;\u0026amp; \\ 2 apt-get install -y curl vim \u0026amp;\u0026amp; \\ 3 apt-get clean \u0026amp;\u0026amp; \\ 4 rm -rf /var/lib/apt/lists/* 5. ä½¿ç”¨ .dockerignore ç±»ä¼¼ .gitignoreï¼Œé¿å…å°†ä¸å¿…è¦çš„æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­ã€‚\n1# .dockerignore 2target/ 3*.log 4.git/ 5.idea/ 6*.md 6. ä¸è¦åœ¨å®¹å™¨ä¸­å­˜å‚¨æ•°æ® å®¹å™¨æ˜¯ä¸´æ—¶çš„ï¼Œæ•°æ®åº”è¯¥å­˜å‚¨åœ¨å¤–éƒ¨ã€‚\nä½¿ç”¨ Volume æŒ‚è½½æ•°æ®\n1docker run -d -v /data/mysql:/var/lib/mysql mysql:8.0 ä½¿ç”¨å‘½åå·\n1docker volume create mysql-data 2docker run -d -v mysql-data:/var/lib/mysql mysql:8.0 7. å¥åº·æ£€æŸ¥ 1FROM openjdk:11-jre-slim 2COPY app.jar /app.jar 3 4HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \\ 5 CMD curl -f http://localhost:8080/actuator/health || exit 1 6 7ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] Docker ä¼šå®šæœŸæ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€ï¼Œä¸å¥åº·çš„å®¹å™¨ä¼šè¢«é‡å¯ã€‚\n8. ä½¿ç”¨é root ç”¨æˆ· å®‰å…¨é£é™©ï¼š é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨å†…çš„è¿›ç¨‹ä»¥ root ç”¨æˆ·è¿è¡Œã€‚\nè§£å†³æ–¹æ¡ˆï¼š åˆ›å»ºæ™®é€šç”¨æˆ·\n1FROM openjdk:11-jre-slim 2 3# åˆ›å»ºç”¨æˆ· 4RUN groupadd -r appuser \u0026amp;\u0026amp; useradd -r -g appuser appuser 5 6# å¤åˆ¶æ–‡ä»¶ 7COPY app.jar /app.jar 8RUN chown appuser:appuser /app.jar 9 10# åˆ‡æ¢ç”¨æˆ· 11USER appuser 12 13ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] ä¼˜åŒ– Spring Boot åº”ç”¨çš„ Dockerfile å®Œæ•´ç¤ºä¾‹\n1# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º 2FROM maven:3.8-openjdk-11-slim AS builder 3WORKDIR /build 4 5# å¤åˆ¶ä¾èµ–æ–‡ä»¶ 6COPY pom.xml . 7COPY .mvn .mvn 8COPY mvnw . 9RUN ./mvnw dependency:go-offline -B 10 11# å¤åˆ¶æºç å¹¶æ„å»º 12COPY src src 13RUN ./mvnw package -DskipTests -B 14 15# è§£å‹ jar åŒ…ï¼ˆåˆ©ç”¨ Spring Boot çš„åˆ†å±‚ç‰¹æ€§ï¼‰ 16RUN mkdir -p target/dependency \u0026amp;\u0026amp; \\ 17 cd target/dependency \u0026amp;\u0026amp; \\ 18 jar -xf ../*.jar 19 20# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ 21FROM openjdk:11-jre-slim 22WORKDIR /app 23 24# åˆ›å»ºé root ç”¨æˆ· 25RUN groupadd -r spring \u0026amp;\u0026amp; useradd -r -g spring spring 26 27# åˆ†å±‚å¤åˆ¶ï¼ˆåˆ©ç”¨ Docker ç¼“å­˜ï¼‰ 28COPY --from=builder /build/target/dependency/BOOT-INF/lib /app/lib 29COPY --from=builder /build/target/dependency/META-INF /app/META-INF 30COPY --from=builder /build/target/dependency/BOOT-INF/classes /app 31 32# ä¿®æ”¹æ‰€æœ‰è€… 33RUN chown -R spring:spring /app 34 35# åˆ‡æ¢ç”¨æˆ· 36USER spring 37 38# å¥åº·æ£€æŸ¥ 39HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \\ 40 CMD curl -f http://localhost:8080/actuator/health || exit 1 41 42# å¯åŠ¨åº”ç”¨ 43ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-cp\u0026#34;, \u0026#34;/app:/app/lib/*\u0026#34;, \u0026#34;com.example.Application\u0026#34;] ä¼˜åŒ–æ•ˆæœï¼š\nåˆ©ç”¨åˆ†å±‚ç¼“å­˜ï¼Œä¾èµ–å˜åŒ–æ—¶ä¸éœ€è¦é‡æ–°æ„å»ºæ•´ä¸ªåº”ç”¨ ä½¿ç”¨é root ç”¨æˆ·ï¼Œæå‡å®‰å…¨æ€§ æ·»åŠ å¥åº·æ£€æŸ¥ï¼Œæå‡å¯é æ€§ Docker Composeï¼šç¼–æ’å¤šæœåŠ¡ åœºæ™¯ï¼š åº”ç”¨éœ€è¦ MySQLã€Redisã€Nginx\ndocker-compose.yml\n1version: \u0026#39;3.8\u0026#39; 2 3services: 4 # MySQL æ•°æ®åº“ 5 mysql: 6 image: mysql:8.0 7 container_name: mysql 8 environment: 9 MYSQL_ROOT_PASSWORD: root123 10 MYSQL_DATABASE: myapp 11 volumes: 12 - mysql-data:/var/lib/mysql 13 ports: 14 - \u0026#34;3306:3306\u0026#34; 15 networks: 16 - app-network 17 healthcheck: 18 test: [\u0026#34;CMD\u0026#34;, \u0026#34;mysqladmin\u0026#34;, \u0026#34;ping\u0026#34;, \u0026#34;-h\u0026#34;, \u0026#34;localhost\u0026#34;] 19 interval: 10s 20 timeout: 5s 21 retries: 5 22 23 # Redis ç¼“å­˜ 24 redis: 25 image: redis:7-alpine 26 container_name: redis 27 ports: 28 - \u0026#34;6379:6379\u0026#34; 29 networks: 30 - app-network 31 healthcheck: 32 test: [\u0026#34;CMD\u0026#34;, \u0026#34;redis-cli\u0026#34;, \u0026#34;ping\u0026#34;] 33 interval: 10s 34 timeout: 3s 35 retries: 5 36 37 # Spring Boot åº”ç”¨ 38 app: 39 build: 40 context: . 41 dockerfile: Dockerfile 42 container_name: myapp 43 environment: 44 SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/myapp 45 SPRING_REDIS_HOST: redis 46 ports: 47 - \u0026#34;8080:8080\u0026#34; 48 depends_on: 49 mysql: 50 condition: service_healthy 51 redis: 52 condition: service_healthy 53 networks: 54 - app-network 55 restart: unless-stopped 56 57 # Nginx åå‘ä»£ç† 58 nginx: 59 image: nginx:alpine 60 container_name: nginx 61 volumes: 62 - ./nginx.conf:/etc/nginx/nginx.conf:ro 63 ports: 64 - \u0026#34;80:80\u0026#34; 65 depends_on: 66 - app 67 networks: 68 - app-network 69 70volumes: 71 mysql-data: 72 73networks: 74 app-network: 75 driver: bridge å¯åŠ¨æ‰€æœ‰æœåŠ¡\n1docker-compose up -d æŸ¥çœ‹æ—¥å¿—\n1docker-compose logs -f app åœæ­¢æ‰€æœ‰æœåŠ¡\n1docker-compose down ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² 1. ä½¿ç”¨ç¯å¢ƒå˜é‡ ä¸è¦åœ¨é•œåƒä¸­ç¡¬ç¼–ç é…ç½®\n1# ä¸å¥½ 2ENV SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/myapp ä½¿ç”¨ç¯å¢ƒå˜é‡\n1docker run -d \\ 2 -e SPRING_DATASOURCE_URL=jdbc:mysql://prod-mysql:3306/myapp \\ 3 -e SPRING_DATASOURCE_PASSWORD=prod_password \\ 4 myapp:1.0 2. èµ„æºé™åˆ¶ 1docker run -d \\ 2 --memory=\u0026#34;512m\u0026#34; \\ 3 --cpus=\u0026#34;1.0\u0026#34; \\ 4 myapp:1.0 3. æ—¥å¿—ç®¡ç† ä½¿ç”¨æ—¥å¿—é©±åŠ¨\n1docker run -d \\ 2 --log-driver=json-file \\ 3 --log-opt max-size=10m \\ 4 --log-opt max-file=3 \\ 5 myapp:1.0 4. è‡ªåŠ¨é‡å¯ 1docker run -d --restart=unless-stopped myapp:1.0 é‡å¯ç­–ç•¥ï¼š\nnoï¼šä¸è‡ªåŠ¨é‡å¯ï¼ˆé»˜è®¤ï¼‰ on-failureï¼šå¤±è´¥æ—¶é‡å¯ alwaysï¼šæ€»æ˜¯é‡å¯ unless-stoppedï¼šé™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™æ€»æ˜¯é‡å¯ CI/CD é›†æˆ GitLab CI ç¤ºä¾‹\n1# .gitlab-ci.yml 2stages: 3 - build 4 - deploy 5 6build: 7 stage: build 8 script: 9 - docker build -t myapp:$CI_COMMIT_SHA . 10 - docker tag myapp:$CI_COMMIT_SHA myapp:latest 11 - docker push myapp:$CI_COMMIT_SHA 12 - docker push myapp:latest 13 14deploy: 15 stage: deploy 16 script: 17 - docker pull myapp:$CI_COMMIT_SHA 18 - docker stop myapp || true 19 - docker rm myapp || true 20 - docker run -d --name myapp -p 8080:8080 myapp:$CI_COMMIT_SHA 21 only: 22 - main å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ 1. å®¹å™¨æ—¶åŒºé—®é¢˜ 1FROM openjdk:11-jre-slim 2ENV TZ=Asia/Shanghai 3RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \u0026amp;\u0026amp; echo $TZ \u0026gt; /etc/timezone 2. å®¹å™¨å†…æ— æ³•è®¿é—®å®¿ä¸»æœºæœåŠ¡ ä½¿ç”¨ host.docker.internalï¼ˆMac/Windowsï¼‰æˆ– 172.17.0.1ï¼ˆLinuxï¼‰\n1environment: 2 SPRING_DATASOURCE_URL: jdbc:mysql://host.docker.internal:3306/myapp 3. é•œåƒæ„å»ºæ…¢ ä½¿ç”¨å›½å†…é•œåƒæº åˆ©ç”¨æ„å»ºç¼“å­˜ ä½¿ç”¨å¤šé˜¶æ®µæ„å»º 4. å®¹å™¨å†…å­˜æº¢å‡º è®¾ç½® JVM å‚æ•°ï¼š\n1ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-Xmx512m\u0026#34;, \u0026#34;-Xms512m\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] æ€»ç»“ä¸æ€è€ƒ Docker å®¹å™¨åŒ–çš„æ ¸å¿ƒè¦ç‚¹ï¼š\né€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒï¼Œå‡å°‘é•œåƒä½“ç§¯ åˆ©ç”¨æ„å»ºç¼“å­˜å’Œå¤šé˜¶æ®µæ„å»ºï¼Œæå‡æ„å»ºé€Ÿåº¦ ä½¿ç”¨é root ç”¨æˆ·ï¼Œæå‡å®‰å…¨æ€§ ä½¿ç”¨ Docker Compose ç¼–æ’å¤šæœåŠ¡ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾ç½®èµ„æºé™åˆ¶å’Œå¥åº·æ£€æŸ¥ å®¹å™¨åŒ–ä¸ä»…ä»…æ˜¯æŠ€æœ¯ï¼Œæ›´æ˜¯ä¸€ç§æ€ç»´æ–¹å¼ã€‚å®ƒè®©æˆ‘ä»¬é‡æ–°æ€è€ƒåº”ç”¨çš„éƒ¨ç½²å’Œè¿ç»´æ–¹å¼ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦éƒ¨ç½²åº”ç”¨æ—¶ï¼Œä¸å¦¨è¯•è¯• Dockerï¼Œä½“éªŒå®¹å™¨åŒ–å¸¦æ¥çš„ä¾¿åˆ©ã€‚\n","permalink":"http://localhost:1313/posts/2024/09/docker-%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%BB%8E-dockerfile-%E5%88%B0%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83/","summary":"\u003cp\u003eå®¹å™¨åŒ–å·²ç»æˆä¸ºç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†æ–¹å¼ã€‚Docker è®©åº”ç”¨éƒ¨ç½²å˜å¾—ç®€å•ã€å¯é ã€å¯ç§»æ¤ã€‚æœ¬æ–‡è®²è§£ Docker åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Dockerfile çš„ç¼–å†™æŠ€å·§ä¸ä¼˜åŒ–æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Docker é•œåƒçš„åˆ†å±‚æ„å»ºåŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒä½“ç§¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ Docker Compose ç¼–æ’å¤šæœåŠ¡ç¯å¢ƒ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–\"\u003eä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨åŒ–ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿéƒ¨ç½²çš„ç—›ç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eç¯å¢ƒä¸ä¸€è‡´ï¼š\u0026ldquo;åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘\u0026rdquo;\u003c/li\u003e\n\u003cli\u003eä¾èµ–ç®¡ç†å¤æ‚ï¼šJDKã€Tomcatã€MySQL ç‰ˆæœ¬ä¸ä¸€è‡´\u003c/li\u003e\n\u003cli\u003eéƒ¨ç½²æµç¨‹ç¹çï¼šæ‰‹åŠ¨ä¸Šä¼ ã€è§£å‹ã€é…ç½®ã€å¯åŠ¨\u003c/li\u003e\n\u003cli\u003eèµ„æºåˆ©ç”¨ç‡ä½ï¼šä¸€å°æœåŠ¡å™¨åªè·‘ä¸€ä¸ªåº”ç”¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eå®¹å™¨åŒ–çš„ä¼˜åŠ¿\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´\u003c/li\u003e\n\u003cli\u003eå¿«é€Ÿéƒ¨ç½²ï¼šç§’çº§å¯åŠ¨ï¼Œä¸€é”®éƒ¨ç½²\u003c/li\u003e\n\u003cli\u003eèµ„æºéš”ç¦»ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“\u003c/li\u003e\n\u003cli\u003eæ˜“äºæ‰©å±•ï¼šæ°´å¹³æ‰©å±•åªéœ€å¯åŠ¨æ›´å¤šå®¹å™¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"dockerfile-åŸºç¡€\"\u003eDockerfile åŸºç¡€\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eæœ€ç®€å•çš„ Dockerfile\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dockerfile\" data-lang=\"dockerfile\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eopenjdk:11-jre-slim\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCOPY\u003c/span\u003e app.jar /app.jar\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eENTRYPOINT\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;java\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;-jar\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/app.jar\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eæ„å»ºé•œåƒ\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003edocker build -t myapp:1.0 .\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eè¿è¡Œå®¹å™¨\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003edocker run -d -p 8080:8080 myapp:1.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"dockerfile-æœ€ä½³å®è·µ\"\u003eDockerfile æœ€ä½³å®è·µ\u003c/h2\u003e\n\u003ch3 id=\"1-é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ\"\u003e1. é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eä¸å¥½çš„åšæ³•\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dockerfile\" data-lang=\"dockerfile\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eubuntu:20.04\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eRUN\u003c/span\u003e apt-get update \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e apt-get install -y openjdk-11-jdk\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé•œåƒå¤§å°ï¼š600MB+\u003c/p\u003e","title":"Docker å®¹å™¨åŒ–éƒ¨ç½²æœ€ä½³å®è·µï¼šä» Dockerfile åˆ°ç”Ÿäº§ç¯å¢ƒ"},{"content":"åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å®ä¾‹å¯èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œéœ€è¦åˆ†å¸ƒå¼é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚Redis æ˜¯å®ç°åˆ†å¸ƒå¼é”çš„å¸¸ç”¨æ–¹æ¡ˆï¼Œä½†å¾ˆå¤šäººåªä¼šç”¨ SETNXï¼Œä¸çŸ¥é“å…¶ä¸­çš„å‘ã€‚æœ¬æ–‡æ·±å…¥å‰–æ Redis åˆ†å¸ƒå¼é”çš„å®ç°ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Redis åˆ†å¸ƒå¼é”çš„å®ç°åŸç†ä¸å¸¸è§é—®é¢˜ æŒæ¡ Redisson çœ‹é—¨ç‹—æœºåˆ¶çš„è®¾è®¡æ€æƒ³ å­¦ä¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„é”ä¼˜åŒ–æ–¹æ¡ˆ äº†è§£åˆ†å¸ƒå¼é”çš„æœ€ä½³å®è·µ ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ åœºæ™¯ä¸€ï¼šåº“å­˜æ‰£å‡\n1// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰åŠ é” 2public void deductStock(Long productId, int quantity) { 3 Stock stock = stockMapper.selectById(productId); 4 if (stock.getQuantity() \u0026gt;= quantity) { 5 stock.setQuantity(stock.getQuantity() - quantity); 6 stockMapper.updateById(stock); 7 } 8} åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–åº“å­˜ï¼Œå¯èƒ½å¯¼è‡´è¶…å–ã€‚\nåœºæ™¯äºŒï¼šå®šæ—¶ä»»åŠ¡å»é‡\nå¤šä¸ªæœåŠ¡å®ä¾‹éƒ¨ç½²æ—¶ï¼Œå®šæ—¶ä»»åŠ¡ä¼šé‡å¤æ‰§è¡Œï¼Œéœ€è¦åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œã€‚\nåŸºç¡€å®ç°ï¼šSETNX + EXPIRE ç‰ˆæœ¬ä¸€ï¼šæœ€ç®€å•çš„å®ç°\n1public boolean tryLock(String key) { 2 return redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;); 3} 4 5public void unlock(String key) { 6 redisTemplate.delete(key); 7} é—®é¢˜ï¼šå¦‚æœè·å–é”åï¼ŒæœåŠ¡å®•æœºï¼Œé”æ°¸è¿œä¸ä¼šé‡Šæ”¾ï¼Œå¯¼è‡´æ­»é”ã€‚\nç‰ˆæœ¬äºŒï¼šåŠ ä¸Šè¿‡æœŸæ—¶é—´\n1public boolean tryLock(String key, long expireTime) { 2 Boolean result = redisTemplate.opsForValue().setIfAbsent(key, \u0026#34;1\u0026#34;); 3 if (result) { 4 redisTemplate.expire(key, expireTime, TimeUnit.SECONDS); 5 } 6 return result; 7} é—®é¢˜ï¼šSETNX å’Œ EXPIRE ä¸æ˜¯åŸå­æ“ä½œï¼Œå¦‚æœåœ¨ä¸¤è€…ä¹‹é—´å®•æœºï¼Œä»ç„¶ä¼šæ­»é”ã€‚\nç‰ˆæœ¬ä¸‰ï¼šåŸå­æ“ä½œ\n1public boolean tryLock(String key, long expireTime) { 2 return redisTemplate.opsForValue() 3 .setIfAbsent(key, \u0026#34;1\u0026#34;, expireTime, TimeUnit.SECONDS); 4} Redis 2.6.12 ä¹‹åï¼ŒSET å‘½ä»¤æ”¯æŒ NX å’Œ EX å‚æ•°ï¼Œä¿è¯åŸå­æ€§ã€‚\n1SET lock_key unique_value NX EX 30 NXï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶è®¾ç½® EXï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ è¿›é˜¶é—®é¢˜ï¼šé”è¯¯åˆ  é—®é¢˜åœºæ™¯\n11. çº¿ç¨‹ A è·å–é”ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ 30 ç§’ 22. çº¿ç¨‹ A æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œè€—æ—¶ 35 ç§’ 33. 30 ç§’åï¼Œé”è‡ªåŠ¨è¿‡æœŸï¼Œçº¿ç¨‹ B è·å–é” 44. çº¿ç¨‹ A æ‰§è¡Œå®Œæ¯•ï¼Œåˆ é™¤é”ï¼ˆè¯¯åˆ äº†çº¿ç¨‹ B çš„é”ï¼‰ è§£å†³æ–¹æ¡ˆï¼šé”çš„å”¯ä¸€æ ‡è¯†\n1public boolean tryLock(String key, String requestId, long expireTime) { 2 return redisTemplate.opsForValue() 3 .setIfAbsent(key, requestId, expireTime, TimeUnit.SECONDS); 4} 5 6public void unlock(String key, String requestId) { 7 String value = redisTemplate.opsForValue().get(key); 8 if (requestId.equals(value)) { 9 redisTemplate.delete(key); 10 } 11} æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å”¯ä¸€çš„ requestIdï¼ˆå¦‚ UUIDï¼‰ï¼Œé‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„é”ã€‚\nä½†è¿™é‡Œä»æœ‰é—®é¢˜ï¼šGET å’Œ DELETE ä¸æ˜¯åŸå­æ“ä½œã€‚\nLua è„šæœ¬ä¿è¯åŸå­æ€§\n1public void unlock(String key, String requestId) { 2 String script = 3 \u0026#34;if redis.call(\u0026#39;get\u0026#39;, KEYS[1]) == ARGV[1] then \u0026#34; + 4 \u0026#34; return redis.call(\u0026#39;del\u0026#39;, KEYS[1]) \u0026#34; + 5 \u0026#34;else \u0026#34; + 6 \u0026#34; return 0 \u0026#34; + 7 \u0026#34;end\u0026#34;; 8 9 redisTemplate.execute( 10 new DefaultRedisScript\u0026lt;\u0026gt;(script, Long.class), 11 Collections.singletonList(key), 12 requestId 13 ); 14} Lua è„šæœ¬åœ¨ Redis ä¸­æ˜¯åŸå­æ‰§è¡Œçš„ï¼Œä¿è¯äº†åˆ¤æ–­å’Œåˆ é™¤çš„åŸå­æ€§ã€‚\næ¶æ„æ€è€ƒï¼š åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒé—®é¢˜æ˜¯\u0026quot;åŸå­æ€§\u0026quot;ã€‚SETNX + EXPIRE ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦ç”¨ SET NX EXï¼›GET + DELETE ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦ç”¨ Lua è„šæœ¬ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šåœºæ™¯éƒ½é€‚ç”¨ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚\nRedissonï¼šç”Ÿäº§çº§çš„åˆ†å¸ƒå¼é” Redisson æ˜¯ Redis å®˜æ–¹æ¨èçš„ Java å®¢æˆ·ç«¯ï¼Œæä¾›äº†å¼€ç®±å³ç”¨çš„åˆ†å¸ƒå¼é”ã€‚\nåŸºæœ¬ä½¿ç”¨\n1@Autowired 2private RedissonClient redissonClient; 3 4public void doSomething() { 5 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 6 try { 7 // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾… 10 ç§’ï¼Œé”è‡ªåŠ¨è¿‡æœŸæ—¶é—´ 30 ç§’ 8 boolean isLocked = lock.tryLock(10, 30, TimeUnit.SECONDS); 9 if (isLocked) { 10 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 11 } 12 } catch (InterruptedException e) { 13 Thread.currentThread().interrupt(); 14 } finally { 15 lock.unlock(); 16 } 17} çœ‹é—¨ç‹—æœºåˆ¶ï¼ˆWatchdogï¼‰\nå¦‚æœä¸æŒ‡å®šé”çš„è¿‡æœŸæ—¶é—´ï¼ŒRedisson ä¼šå¯åŠ¨çœ‹é—¨ç‹—æœºåˆ¶ï¼š\n1lock.lock(); // é»˜è®¤è¿‡æœŸæ—¶é—´ 30 ç§’ çœ‹é—¨ç‹—ä¼šæ¯éš” 10 ç§’ï¼ˆè¿‡æœŸæ—¶é—´çš„ 1/3ï¼‰æ£€æŸ¥é”æ˜¯å¦è¿˜è¢«æŒæœ‰ï¼Œå¦‚æœæ˜¯ï¼Œè‡ªåŠ¨ç»­æœŸ 30 ç§’ã€‚\nçœ‹é—¨ç‹—çš„å®ç°åŸç†\n1private void scheduleExpirationRenewal(long threadId) { 2 ExpirationEntry entry = new ExpirationEntry(); 3 ExpirationEntry oldEntry = EXPIRATION_RENEWAL_MAP.putIfAbsent(getEntryName(), entry); 4 5 if (oldEntry != null) { 6 oldEntry.addThreadId(threadId); 7 } else { 8 entry.addThreadId(threadId); 9 renewExpiration(); 10 } 11} 12 13private void renewExpiration() { 14 ExpirationEntry ee = EXPIRATION_RENEWAL_MAP.get(getEntryName()); 15 if (ee == null) { 16 return; 17 } 18 19 Timeout task = commandExecutor.getConnectionManager().newTimeout(timeout -\u0026gt; { 20 // ç»­æœŸé” 21 RFuture\u0026lt;Boolean\u0026gt; future = renewExpirationAsync(threadId); 22 future.onComplete((res, e) -\u0026gt; { 23 if (e != null) { 24 return; 25 } 26 if (res) { 27 // ç»­æœŸæˆåŠŸï¼Œç»§ç»­è°ƒåº¦ä¸‹ä¸€æ¬¡ç»­æœŸ 28 renewExpiration(); 29 } 30 }); 31 }, internalLockLeaseTime / 3, TimeUnit.MILLISECONDS); 32 33 ee.setTimeout(task); 34} çœ‹é—¨ç‹—çš„å¥½å¤„ï¼š\né¿å…ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”è¿‡æœŸ é¿å…æ‰‹åŠ¨è®¾ç½®è¿‡æœŸæ—¶é—´ä¸å‡†ç¡® é¿å‘æç¤ºï¼š çœ‹é—¨ç‹—åªåœ¨æœªæŒ‡å®šè¿‡æœŸæ—¶é—´æ—¶ç”Ÿæ•ˆã€‚å¦‚æœä½ è°ƒç”¨ lock.tryLock(10, 30, TimeUnit.SECONDS)ï¼Œçœ‹é—¨ç‹—ä¸ä¼šå¯åŠ¨ï¼Œé”ä¼šåœ¨ 30 ç§’åè‡ªåŠ¨è¿‡æœŸã€‚\nå¯é‡å…¥é” Redisson çš„é”æ˜¯å¯é‡å…¥çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”ã€‚\n1public void methodA() { 2 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 3 lock.lock(); 4 try { 5 methodB(); // å¯ä»¥å†æ¬¡è·å–é” 6 } finally { 7 lock.unlock(); 8 } 9} 10 11public void methodB() { 12 RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 13 lock.lock(); 14 try { 15 // ä¸šåŠ¡é€»è¾‘ 16 } finally { 17 lock.unlock(); 18 } 19} å®ç°åŸç†ï¼šHash ç»“æ„\n1HSET myLock thread-1 1 # ç¬¬ä¸€æ¬¡åŠ é” 2HINCRBY myLock thread-1 1 # ç¬¬äºŒæ¬¡åŠ é”ï¼Œè®¡æ•°å™¨ +1 é‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°å™¨ -1ï¼Œåªæœ‰è®¡æ•°å™¨ä¸º 0 æ—¶æ‰çœŸæ­£é‡Šæ”¾é”ã€‚\né«˜å¹¶å‘ä¼˜åŒ–ï¼šåˆ†æ®µé” åœ¨ç§’æ€åœºæ™¯ä¸‹ï¼Œæ‰€æœ‰è¯·æ±‚ç«äº‰åŒä¸€æŠŠé”ï¼Œæ€§èƒ½å¾ˆå·®ã€‚å¯ä»¥ä½¿ç”¨åˆ†æ®µé”ä¼˜åŒ–ã€‚\nåœºæ™¯ï¼šåº“å­˜æ‰£å‡\n1public void deductStock(Long productId, int quantity) { 2 // æ ¹æ®å•†å“ ID åˆ†æ®µ 3 int segment = (int) (productId % 10); 4 String lockKey = \u0026#34;stock_lock:\u0026#34; + productId + \u0026#34;:\u0026#34; + segment; 5 6 RLock lock = redissonClient.getLock(lockKey); 7 lock.lock(); 8 try { 9 // æ‰£å‡åº“å­˜ 10 Stock stock = stockMapper.selectById(productId); 11 if (stock.getQuantity() \u0026gt;= quantity) { 12 stock.setQuantity(stock.getQuantity() - quantity); 13 stockMapper.updateById(stock); 14 } 15 } finally { 16 lock.unlock(); 17 } 18} å°†åº“å­˜åˆ†æˆ 10 æ®µï¼Œæ¯æ®µç‹¬ç«‹åŠ é”ï¼Œæå‡å¹¶å‘åº¦ã€‚\nè¯»å†™é”\nå¦‚æœè¯»å¤šå†™å°‘ï¼Œå¯ä»¥ä½¿ç”¨è¯»å†™é”ï¼š\n1RReadWriteLock rwLock = redissonClient.getReadWriteLock(\u0026#34;myLock\u0026#34;); 2 3// è¯»é”ï¼ˆå…±äº«é”ï¼‰ 4RLock readLock = rwLock.readLock(); 5readLock.lock(); 6try { 7 // è¯»æ“ä½œ 8} finally { 9 readLock.unlock(); 10} 11 12// å†™é”ï¼ˆæ’ä»–é”ï¼‰ 13RLock writeLock = rwLock.writeLock(); 14writeLock.lock(); 15try { 16 // å†™æ“ä½œ 17} finally { 18 writeLock.unlock(); 19} å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰è¯»é”ï¼Œä½†å†™é”æ˜¯æ’ä»–çš„ã€‚\nçº¢é”ï¼ˆRedLockï¼‰ï¼šå¤šèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é” å•èŠ‚ç‚¹ Redis å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ï¼ŒRedLock é€šè¿‡å¤šä¸ªç‹¬ç«‹çš„ Redis èŠ‚ç‚¹å®ç°é«˜å¯ç”¨ã€‚\nRedLock ç®—æ³•\nè·å–å½“å‰æ—¶é—´æˆ³ ä¾æ¬¡å‘ N ä¸ª Redis èŠ‚ç‚¹è¯·æ±‚åŠ é” å¦‚æœè¶…è¿‡åŠæ•°èŠ‚ç‚¹åŠ é”æˆåŠŸï¼Œä¸”æ€»è€—æ—¶å°äºé”çš„è¿‡æœŸæ—¶é—´ï¼Œåˆ™è®¤ä¸ºåŠ é”æˆåŠŸ å¦‚æœåŠ é”å¤±è´¥ï¼Œå‘æ‰€æœ‰èŠ‚ç‚¹é‡Šæ”¾é” Redisson å®ç°\n1RLock lock1 = redissonClient1.getLock(\u0026#34;myLock\u0026#34;); 2RLock lock2 = redissonClient2.getLock(\u0026#34;myLock\u0026#34;); 3RLock lock3 = redissonClient3.getLock(\u0026#34;myLock\u0026#34;); 4 5RedissonRedLock redLock = new RedissonRedLock(lock1, lock2, lock3); 6redLock.lock(); 7try { 8 // ä¸šåŠ¡é€»è¾‘ 9} finally { 10 redLock.unlock(); 11} RedLock çš„äº‰è®®ï¼š\nMartin Kleppmann è®¤ä¸º RedLock ä¸å®‰å…¨ï¼ˆæ—¶é’Ÿæ¼‚ç§»é—®é¢˜ï¼‰ Redis ä½œè€… Antirez è®¤ä¸º RedLock åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹å¤Ÿç”¨ å®é™…ç”Ÿäº§ä¸­ï¼Œå•èŠ‚ç‚¹ + ä¸»ä»å¤åˆ¶ + å“¨å…µæ¨¡å¼å·²ç»è¶³å¤Ÿã€‚\næœ€ä½³å®è·µ 1. è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´\nè¿‡æœŸæ—¶é—´å¤ªçŸ­ï¼Œä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œé”å°±è¿‡æœŸäº†ï¼›è¿‡æœŸæ—¶é—´å¤ªé•¿ï¼Œå®•æœºåé”é•¿æ—¶é—´ä¸é‡Šæ”¾ã€‚\nå»ºè®®ï¼šæ ¹æ®ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è®¾ç½®ï¼Œæˆ–ä½¿ç”¨ Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶ã€‚\n2. ä½¿ç”¨ try-finally é‡Šæ”¾é”\n1lock.lock(); 2try { 3 // ä¸šåŠ¡é€»è¾‘ 4} finally { 5 lock.unlock(); 6} 3. é¿å…é•¿æ—¶é—´æŒæœ‰é”\né”çš„ç²’åº¦è¦å°½é‡å°ï¼Œåªé”å¿…è¦çš„ä»£ç å—ã€‚\n1// ä¸å¥½ï¼šé”çš„ç²’åº¦å¤ªå¤§ 2lock.lock(); 3try { 4 queryDatabase(); // è€—æ—¶æ“ä½œ 5 updateCache(); 6 sendMessage(); 7} finally { 8 lock.unlock(); 9} 10 11// å¥½ï¼šåªé”å¿…è¦çš„ä»£ç  12queryDatabase(); 13lock.lock(); 14try { 15 updateCache(); 16} finally { 17 lock.unlock(); 18} 19sendMessage(); 4. é”é™çº§\nå¦‚æœ Redis ä¸å¯ç”¨ï¼Œå¯ä»¥é™çº§ä¸ºæœ¬åœ°é”æˆ–ç›´æ¥æ”¾è¡Œã€‚\n1RLock lock = redissonClient.getLock(\u0026#34;myLock\u0026#34;); 2try { 3 boolean isLocked = lock.tryLock(1, 30, TimeUnit.SECONDS); 4 if (!isLocked) { 5 // é™çº§å¤„ç† 6 log.warn(\u0026#34;è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼Œé™çº§ä¸ºæœ¬åœ°é”\u0026#34;); 7 synchronized (this) { 8 // ä¸šåŠ¡é€»è¾‘ 9 } 10 } 11} catch (Exception e) { 12 log.error(\u0026#34;åˆ†å¸ƒå¼é”å¼‚å¸¸\u0026#34;, e); 13 // é™çº§å¤„ç† 14} æ€»ç»“ä¸æ€è€ƒ Redis åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ SET NX EX ä¿è¯åŠ é”çš„åŸå­æ€§ ä½¿ç”¨ Lua è„šæœ¬ä¿è¯è§£é”çš„åŸå­æ€§ ä½¿ç”¨å”¯ä¸€æ ‡è¯†é¿å…é”è¯¯åˆ  ä½¿ç”¨ Redisson ç®€åŒ–å®ç°ï¼Œåˆ©ç”¨çœ‹é—¨ç‹—æœºåˆ¶è‡ªåŠ¨ç»­æœŸ åˆ†å¸ƒå¼é”ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚åœ¨è®¾è®¡æ—¶è¦æƒè¡¡ï¼š\næ˜¯å¦çœŸçš„éœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿèƒ½å¦é€šè¿‡æ•°æ®åº“çš„ä¹è§‚é”è§£å†³ï¼Ÿ é”çš„ç²’åº¦æ˜¯å¦åˆç†ï¼Ÿèƒ½å¦é€šè¿‡åˆ†æ®µé”æå‡å¹¶å‘åº¦ï¼Ÿ æ˜¯å¦éœ€è¦é«˜å¯ç”¨ï¼Ÿå•èŠ‚ç‚¹æ˜¯å¦å¤Ÿç”¨ï¼Ÿ ä¸‹æ¬¡å½“ä½ éœ€è¦åˆ†å¸ƒå¼é”æ—¶ï¼Œä¸å¦¨å…ˆé—®é—®è‡ªå·±ï¼šè¿™ä¸ªåœºæ™¯çœŸçš„éœ€è¦å¼ºä¸€è‡´æ€§å—ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/08/redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E7%94%9F%E4%BA%A7%E7%BA%A7%E5%AE%9E%E8%B7%B5%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0-redisson/","summary":"\u003cp\u003eåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å®ä¾‹å¯èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œéœ€è¦åˆ†å¸ƒå¼é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚Redis æ˜¯å®ç°åˆ†å¸ƒå¼é”çš„å¸¸ç”¨æ–¹æ¡ˆï¼Œä½†å¾ˆå¤šäººåªä¼šç”¨ SETNXï¼Œä¸çŸ¥é“å…¶ä¸­çš„å‘ã€‚æœ¬æ–‡æ·±å…¥å‰–æ Redis åˆ†å¸ƒå¼é”çš„å®ç°ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Redis åˆ†å¸ƒå¼é”çš„å®ç°åŸç†ä¸å¸¸è§é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Redisson çœ‹é—¨ç‹—æœºåˆ¶çš„è®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„é”ä¼˜åŒ–æ–¹æ¡ˆ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†å¸ƒå¼é”çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”\"\u003eä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šåº“å­˜æ‰£å‡\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰åŠ é”\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003edeductStock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLong\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eproductId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eStock\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estockMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eselectById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eproductId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQuantity\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003equantity\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003estockMapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eupdateById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estock\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–åº“å­˜ï¼Œå¯èƒ½å¯¼è‡´è¶…å–ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šå®šæ—¶ä»»åŠ¡å»é‡\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¤šä¸ªæœåŠ¡å®ä¾‹éƒ¨ç½²æ—¶ï¼Œå®šæ—¶ä»»åŠ¡ä¼šé‡å¤æ‰§è¡Œï¼Œéœ€è¦åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"åŸºç¡€å®ç°setnx--expire\"\u003eåŸºç¡€å®ç°ï¼šSETNX + EXPIRE\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eç‰ˆæœ¬ä¸€ï¼šæœ€ç®€å•çš„å®ç°\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003etryLock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003esetIfAbsent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eunlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edelete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼šå¦‚æœè·å–é”åï¼ŒæœåŠ¡å®•æœºï¼Œé”æ°¸è¿œä¸ä¼šé‡Šæ”¾ï¼Œå¯¼è‡´æ­»é”ã€‚\u003c/p\u003e","title":"Redis åˆ†å¸ƒå¼é”çš„ç”Ÿäº§çº§å®è·µï¼šä»åŸç†åˆ° Redisson"},{"content":"Spring Boot çš„æ ¸å¿ƒé­…åŠ›åœ¨äº\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;ï¼Œè€Œ Starter æœºåˆ¶æ˜¯å®ç°è¿™ä¸€ç†å¿µçš„å…³é”®ã€‚æœ¬æ–‡é€šè¿‡å®æˆ˜æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å¼€å‘ä¸€ä¸ªç”Ÿäº§çº§çš„è‡ªå®šä¹‰ Starterã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ Spring Boot è‡ªåŠ¨è£…é…çš„åº•å±‚åŸç† æŒæ¡ BeanPostProcessor çš„ä½¿ç”¨åœºæ™¯ å­¦ä¼šè®¾è®¡é›¶ä¾µå…¥å¼çš„åŸºç¡€ç»„ä»¶ äº†è§£ Starter çš„æœ€ä½³å®è·µä¸è§„èŒƒ ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ Starterï¼Ÿ åœºæ™¯ï¼š å…¬å¸æœ‰å¤šä¸ª Spring Boot é¡¹ç›®ï¼Œéƒ½éœ€è¦é›†æˆçº¿ç¨‹æ± ç›‘æ§åŠŸèƒ½ã€‚\nä¼ ç»Ÿåšæ³•ï¼š æ¯ä¸ªé¡¹ç›®éƒ½å¤åˆ¶ä¸€éé…ç½®ä»£ç ã€‚\né—®é¢˜ï¼š\nä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜ é…ç½®ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“å‡ºé”™ å‡çº§å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æ‰€æœ‰é¡¹ç›® Starter çš„ä¼˜åŠ¿ï¼š\nä¸€æ¬¡å¼€å‘ï¼Œå¤šå¤„å¤ç”¨ é›¶ä¾µå…¥ï¼Œå¼•å…¥ä¾èµ–å³å¯ä½¿ç”¨ ç»Ÿä¸€ç®¡ç†ï¼Œå‡çº§æ–¹ä¾¿ æ¡ˆä¾‹ï¼šå¼€å‘çº¿ç¨‹æ± ç›‘æ§ Starter åŠŸèƒ½éœ€æ±‚ï¼š\nè‡ªåŠ¨æ‰«æé¡¹ç›®ä¸­çš„ ThreadPoolExecutor å®šæ—¶ä¸ŠæŠ¥çº¿ç¨‹æ± æŒ‡æ ‡ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰ æä¾›ç®¡ç†åå°æŸ¥çœ‹å’Œè°ƒæ•´çº¿ç¨‹æ± å‚æ•° ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Starter é¡¹ç›® é¡¹ç›®ç»“æ„\n1threadpool-spring-boot-starter 2â”œâ”€â”€ src/main/java 3â”‚ â””â”€â”€ com/example/threadpool 4â”‚ â”œâ”€â”€ autoconfigure 5â”‚ â”‚ â”œâ”€â”€ ThreadPoolAutoConfiguration.java 6â”‚ â”‚ â””â”€â”€ ThreadPoolProperties.java 7â”‚ â”œâ”€â”€ core 8â”‚ â”‚ â”œâ”€â”€ ThreadPoolMonitor.java 9â”‚ â”‚ â””â”€â”€ ThreadPoolRegistry.java 10â”‚ â””â”€â”€ processor 11â”‚ â””â”€â”€ ThreadPoolBeanPostProcessor.java 12â”œâ”€â”€ src/main/resources 13â”‚ â””â”€â”€ META-INF 14â”‚ â””â”€â”€ spring.factories 15â””â”€â”€ pom.xml pom.xml\n1\u0026lt;dependencies\u0026gt; 2 \u0026lt;!-- Spring Boot è‡ªåŠ¨é…ç½® --\u0026gt; 3 \u0026lt;dependency\u0026gt; 4 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 5 \u0026lt;artifactId\u0026gt;spring-boot-autoconfigure\u0026lt;/artifactId\u0026gt; 6 \u0026lt;/dependency\u0026gt; 7 8 \u0026lt;!-- é…ç½®æç¤º --\u0026gt; 9 \u0026lt;dependency\u0026gt; 10 \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; 11 \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; 12 \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; 13 \u0026lt;/dependency\u0026gt; 14\u0026lt;/dependencies\u0026gt; ç¬¬äºŒæ­¥ï¼šå®šä¹‰é…ç½®å±æ€§ 1@ConfigurationProperties(prefix = \u0026#34;threadpool.monitor\u0026#34;) 2public class ThreadPoolProperties { 3 4 /** 5 * æ˜¯å¦å¯ç”¨çº¿ç¨‹æ± ç›‘æ§ 6 */ 7 private boolean enabled = true; 8 9 /** 10 * ä¸ŠæŠ¥é—´éš”ï¼ˆç§’ï¼‰ 11 */ 12 private int reportInterval = 60; 13 14 /** 15 * æ˜¯å¦å¯ç”¨åŠ¨æ€è°ƒæ•´ 16 */ 17 private boolean dynamicAdjust = false; 18 19 // getter/setter 20} é…ç½®æç¤º\nåˆ›å»º src/main/resources/META-INF/spring-configuration-metadata.jsonï¼š\n1{ 2 \u0026#34;properties\u0026#34;: [ 3 { 4 \u0026#34;name\u0026#34;: \u0026#34;threadpool.monitor.enabled\u0026#34;, 5 \u0026#34;type\u0026#34;: \u0026#34;java.lang.Boolean\u0026#34;, 6 \u0026#34;description\u0026#34;: \u0026#34;æ˜¯å¦å¯ç”¨çº¿ç¨‹æ± ç›‘æ§\u0026#34;, 7 \u0026#34;defaultValue\u0026#34;: true 8 }, 9 { 10 \u0026#34;name\u0026#34;: \u0026#34;threadpool.monitor.report-interval\u0026#34;, 11 \u0026#34;type\u0026#34;: \u0026#34;java.lang.Integer\u0026#34;, 12 \u0026#34;description\u0026#34;: \u0026#34;ä¸ŠæŠ¥é—´éš”ï¼ˆç§’ï¼‰\u0026#34;, 13 \u0026#34;defaultValue\u0026#34;: 60 14 } 15 ] 16} è¿™æ ·åœ¨ application.yml ä¸­é…ç½®æ—¶ï¼ŒIDE ä¼šæœ‰æ™ºèƒ½æç¤ºã€‚\nç¬¬ä¸‰æ­¥ï¼šå®ç° BeanPostProcessor æ ¸å¿ƒæ€æƒ³ï¼š åœ¨ Bean åˆå§‹åŒ–åï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ ThreadPoolExecutorï¼Œå¦‚æœæ˜¯ï¼Œæ³¨å†Œåˆ°ç›‘æ§ä¸­å¿ƒã€‚\n1@Component 2public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Override 8 public Object postProcessAfterInitialization(Object bean, String beanName) { 9 if (bean instanceof ThreadPoolExecutor) { 10 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 11 registry.register(beanName, executor); 12 log.info(\u0026#34;æ³¨å†Œçº¿ç¨‹æ± : {}\u0026#34;, beanName); 13 } 14 return bean; 15 } 16} ThreadPoolRegistry\n1@Component 2public class ThreadPoolRegistry { 3 4 private final Map\u0026lt;String, ThreadPoolExecutor\u0026gt; executors = new ConcurrentHashMap\u0026lt;\u0026gt;(); 5 6 public void register(String name, ThreadPoolExecutor executor) { 7 executors.put(name, executor); 8 } 9 10 public Map\u0026lt;String, ThreadPoolExecutor\u0026gt; getAll() { 11 return Collections.unmodifiableMap(executors); 12 } 13 14 public ThreadPoolExecutor get(String name) { 15 return executors.get(name); 16 } 17} ç¬¬å››æ­¥ï¼šå®ç°ç›‘æ§é€»è¾‘ 1@Component 2public class ThreadPoolMonitor { 3 4 @Autowired 5 private ThreadPoolRegistry registry; 6 7 @Autowired 8 private ThreadPoolProperties properties; 9 10 @Scheduled(fixedDelayString = \u0026#34;${threadpool.monitor.report-interval:60}000\u0026#34;) 11 public void report() { 12 if (!properties.isEnabled()) { 13 return; 14 } 15 16 registry.getAll().forEach((name, executor) -\u0026gt; { 17 ThreadPoolMetrics metrics = collectMetrics(name, executor); 18 log.info(\u0026#34;çº¿ç¨‹æ± æŒ‡æ ‡: {}\u0026#34;, metrics); 19 20 // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€InfluxDB ç­‰ï¼‰ 21 reportToMonitor(metrics); 22 }); 23 } 24 25 private ThreadPoolMetrics collectMetrics(String name, ThreadPoolExecutor executor) { 26 return ThreadPoolMetrics.builder() 27 .name(name) 28 .corePoolSize(executor.getCorePoolSize()) 29 .maximumPoolSize(executor.getMaximumPoolSize()) 30 .activeCount(executor.getActiveCount()) 31 .poolSize(executor.getPoolSize()) 32 .queueSize(executor.getQueue().size()) 33 .queueRemainingCapacity(executor.getQueue().remainingCapacity()) 34 .completedTaskCount(executor.getCompletedTaskCount()) 35 .taskCount(executor.getTaskCount()) 36 .build(); 37 } 38 39 private void reportToMonitor(ThreadPoolMetrics metrics) { 40 // å®ç°ä¸ŠæŠ¥é€»è¾‘ 41 } 42} ç¬¬äº”æ­¥ï¼šè‡ªåŠ¨é…ç½®ç±» 1@Configuration 2@EnableConfigurationProperties(ThreadPoolProperties.class) 3@ConditionalOnProperty(prefix = \u0026#34;threadpool.monitor\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;, matchIfMissing = true) 4@EnableScheduling 5public class ThreadPoolAutoConfiguration { 6 7 @Bean 8 public ThreadPoolRegistry threadPoolRegistry() { 9 return new ThreadPoolRegistry(); 10 } 11 12 @Bean 13 public ThreadPoolBeanPostProcessor threadPoolBeanPostProcessor() { 14 return new ThreadPoolBeanPostProcessor(); 15 } 16 17 @Bean 18 public ThreadPoolMonitor threadPoolMonitor() { 19 return new ThreadPoolMonitor(); 20 } 21} æ³¨è§£è¯´æ˜ï¼š\n@EnableConfigurationPropertiesï¼šå¯ç”¨é…ç½®å±æ€§ @ConditionalOnPropertyï¼šæ¡ä»¶è£…é…ï¼Œåªæœ‰é…ç½®å¯ç”¨æ—¶æ‰ç”Ÿæ•ˆ @EnableSchedulingï¼šå¯ç”¨å®šæ—¶ä»»åŠ¡ ç¬¬å…­æ­¥ï¼šæ³¨å†Œè‡ªåŠ¨é…ç½® åˆ›å»º src/main/resources/META-INF/spring.factoriesï¼š\n1org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 2com.example.threadpool.autoconfigure.ThreadPoolAutoConfiguration Spring Boot å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½è¿™ä¸ªé…ç½®ç±»ã€‚\nç¬¬ä¸ƒæ­¥ï¼šä½¿ç”¨ Starter 1. å¼•å…¥ä¾èµ–\n1\u0026lt;dependency\u0026gt; 2 \u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt; 3 \u0026lt;artifactId\u0026gt;threadpool-spring-boot-starter\u0026lt;/artifactId\u0026gt; 4 \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; 5\u0026lt;/dependency\u0026gt; 2. é…ç½®ï¼ˆå¯é€‰ï¼‰\n1threadpool: 2 monitor: 3 enabled: true 4 report-interval: 30 3. å®šä¹‰çº¿ç¨‹æ± \n1@Configuration 2public class ThreadPoolConfig { 3 4 @Bean(\u0026#34;orderThreadPool\u0026#34;) 5 public ThreadPoolExecutor orderThreadPool() { 6 return new ThreadPoolExecutor( 7 10, 20, 60, TimeUnit.SECONDS, 8 new LinkedBlockingQueue\u0026lt;\u0026gt;(100), 9 new ThreadFactoryBuilder().setNameFormat(\u0026#34;order-pool-%d\u0026#34;).build(), 10 new ThreadPoolExecutor.CallerRunsPolicy() 11 ); 12 } 13} 4. è‡ªåŠ¨ç›‘æ§\næ— éœ€ä»»ä½•é¢å¤–ä»£ç ï¼ŒStarter ä¼šè‡ªåŠ¨æ‰«æå¹¶ç›‘æ§æ‰€æœ‰ ThreadPoolExecutorã€‚\nè¿›é˜¶ï¼šåŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•° æä¾› REST API\n1@RestController 2@RequestMapping(\u0026#34;/threadpool\u0026#34;) 3public class ThreadPoolController { 4 5 @Autowired 6 private ThreadPoolRegistry registry; 7 8 @GetMapping(\u0026#34;/list\u0026#34;) 9 public List\u0026lt;ThreadPoolInfo\u0026gt; list() { 10 return registry.getAll().entrySet().stream() 11 .map(entry -\u0026gt; ThreadPoolInfo.from(entry.getKey(), entry.getValue())) 12 .collect(Collectors.toList()); 13 } 14 15 @PostMapping(\u0026#34;/adjust\u0026#34;) 16 public void adjust(@RequestBody ThreadPoolAdjustRequest request) { 17 ThreadPoolExecutor executor = registry.get(request.getName()); 18 if (executor == null) { 19 throw new IllegalArgumentException(\u0026#34;çº¿ç¨‹æ± ä¸å­˜åœ¨: \u0026#34; + request.getName()); 20 } 21 22 executor.setCorePoolSize(request.getCorePoolSize()); 23 executor.setMaximumPoolSize(request.getMaximumPoolSize()); 24 25 log.info(\u0026#34;è°ƒæ•´çº¿ç¨‹æ± å‚æ•°: {}\u0026#34;, request); 26 } 27} è‡ªåŠ¨è£…é…åŸç† @SpringBootApplication æ³¨è§£\n1@SpringBootConfiguration 2@EnableAutoConfiguration // å…³é”®æ³¨è§£ 3@ComponentScan 4public @interface SpringBootApplication { 5} @EnableAutoConfiguration æ³¨è§£\n1@Import(AutoConfigurationImportSelector.class) 2public @interface EnableAutoConfiguration { 3} AutoConfigurationImportSelector\n1public class AutoConfigurationImportSelector { 2 3 protected List\u0026lt;String\u0026gt; getCandidateConfigurations() { 4 // è¯»å– META-INF/spring.factories 5 return SpringFactoriesLoader.loadFactoryNames( 6 EnableAutoConfiguration.class, 7 getBeanClassLoader() 8 ); 9 } 10} æµç¨‹ï¼š\nSpring Boot å¯åŠ¨æ—¶ï¼Œæ‰«ææ‰€æœ‰ jar åŒ…çš„ META-INF/spring.factories åŠ è½½ EnableAutoConfiguration å¯¹åº”çš„é…ç½®ç±» æ ¹æ® @Conditional æ³¨è§£åˆ¤æ–­æ˜¯å¦ç”Ÿæ•ˆ æ³¨å†Œ Bean åˆ° Spring å®¹å™¨ æ¶æ„æ€è€ƒï¼š Spring Boot çš„è‡ªåŠ¨è£…é…ä½“ç°äº†\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;çš„æ€æƒ³ã€‚é€šè¿‡ SPI æœºåˆ¶ï¼ˆspring.factoriesï¼‰å’Œæ¡ä»¶è£…é…ï¼ˆ@Conditionalï¼‰ï¼Œå®ç°äº†çµæ´»çš„æ¨¡å—åŒ–è®¾è®¡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šæ¡†æ¶ä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ Dubbo çš„ SPIã€Java çš„ ServiceLoaderã€‚\nStarter å¼€å‘è§„èŒƒ 1. å‘½åè§„èŒƒ\nå®˜æ–¹ Starterï¼šspring-boot-starter-{name} ç¬¬ä¸‰æ–¹ Starterï¼š{name}-spring-boot-starter 2. æ¨¡å—æ‹†åˆ†\n1{name}-spring-boot-starter # ä¾èµ–ç®¡ç†ï¼Œä¸åŒ…å«ä»£ç  2â””â”€â”€ {name}-spring-boot-autoconfigure # è‡ªåŠ¨é…ç½®ä»£ç  3. é…ç½®å‰ç¼€\nä½¿ç”¨ç»Ÿä¸€çš„é…ç½®å‰ç¼€ï¼Œé¿å…å†²çªã€‚\n1mycompany: 2 threadpool: 3 enabled: true 4. æ¡ä»¶è£…é…\nä½¿ç”¨ @ConditionalOnClassã€@ConditionalOnProperty ç­‰æ³¨è§£ï¼Œé¿å…å¼ºä¾èµ–ã€‚\n1@ConditionalOnClass(RedisTemplate.class) 2@ConditionalOnProperty(prefix = \u0026#34;redis.cache\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) 5. æä¾›é»˜è®¤é…ç½®\n1@ConfigurationProperties(prefix = \u0026#34;threadpool.monitor\u0026#34;) 2public class ThreadPoolProperties { 3 private boolean enabled = true; // é»˜è®¤å¯ç”¨ 4 private int reportInterval = 60; // é»˜è®¤ 60 ç§’ 5} 6. æ–‡æ¡£å®Œå–„\næä¾› README.mdï¼Œè¯´æ˜ï¼š\nåŠŸèƒ½ä»‹ç» å¿«é€Ÿå¼€å§‹ é…ç½®è¯´æ˜ ç¤ºä¾‹ä»£ç  æ€»ç»“ä¸æ€è€ƒ è‡ªå®šä¹‰ Starter çš„æ ¸å¿ƒè¦ç‚¹ï¼š\nä½¿ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼æ‰«æ é€šè¿‡ @ConfigurationProperties æä¾›çµæ´»çš„é…ç½® ä½¿ç”¨ @Conditional æ³¨è§£å®ç°æ¡ä»¶è£…é… åœ¨ spring.factories ä¸­æ³¨å†Œè‡ªåŠ¨é…ç½®ç±» Starter ä¸ä»…ä»…æ˜¯ä»£ç å¤ç”¨ï¼Œæ›´æ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ã€‚å®ƒè®©æˆ‘ä»¬é‡æ–°æ€è€ƒå¦‚ä½•è®¾è®¡å¯å¤ç”¨çš„åŸºç¡€ç»„ä»¶ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åœ¨å¤šä¸ªé¡¹ç›®ä¸­å¤ç”¨åŠŸèƒ½æ—¶ï¼Œä¸å¦¨è¯•è¯•å¼€å‘ä¸€ä¸ª Starterï¼Œä½“éªŒ\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/08/spring-boot-starter-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%80%E5%8F%91%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eSpring Boot çš„æ ¸å¿ƒé­…åŠ›åœ¨äº\u0026quot;çº¦å®šä¼˜äºé…ç½®\u0026quot;ï¼Œè€Œ Starter æœºåˆ¶æ˜¯å®ç°è¿™ä¸€ç†å¿µçš„å…³é”®ã€‚æœ¬æ–‡é€šè¿‡å®æˆ˜æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•å¼€å‘ä¸€ä¸ªç”Ÿäº§çº§çš„è‡ªå®šä¹‰ Starterã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ Spring Boot è‡ªåŠ¨è£…é…çš„åº•å±‚åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ BeanPostProcessor çš„ä½¿ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè®¾è®¡é›¶ä¾µå…¥å¼çš„åŸºç¡€ç»„ä»¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ Starter çš„æœ€ä½³å®è·µä¸è§„èŒƒ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰-starter\"\u003eä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ Starterï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ï¼š\u003c/strong\u003e å…¬å¸æœ‰å¤šä¸ª Spring Boot é¡¹ç›®ï¼Œéƒ½éœ€è¦é›†æˆçº¿ç¨‹æ± ç›‘æ§åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¼ ç»Ÿåšæ³•ï¼š\u003c/strong\u003e æ¯ä¸ªé¡¹ç›®éƒ½å¤åˆ¶ä¸€éé…ç½®ä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé—®é¢˜ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜\u003c/li\u003e\n\u003cli\u003eé…ç½®ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“å‡ºé”™\u003c/li\u003e\n\u003cli\u003eå‡çº§å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æ‰€æœ‰é¡¹ç›®\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eStarter çš„ä¼˜åŠ¿ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eä¸€æ¬¡å¼€å‘ï¼Œå¤šå¤„å¤ç”¨\u003c/li\u003e\n\u003cli\u003eé›¶ä¾µå…¥ï¼Œå¼•å…¥ä¾èµ–å³å¯ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eç»Ÿä¸€ç®¡ç†ï¼Œå‡çº§æ–¹ä¾¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¡ˆä¾‹å¼€å‘çº¿ç¨‹æ± ç›‘æ§-starter\"\u003eæ¡ˆä¾‹ï¼šå¼€å‘çº¿ç¨‹æ± ç›‘æ§ Starter\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåŠŸèƒ½éœ€æ±‚ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eè‡ªåŠ¨æ‰«æé¡¹ç›®ä¸­çš„ ThreadPoolExecutor\u003c/li\u003e\n\u003cli\u003eå®šæ—¶ä¸ŠæŠ¥çº¿ç¨‹æ± æŒ‡æ ‡ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰\u003c/li\u003e\n\u003cli\u003eæä¾›ç®¡ç†åå°æŸ¥çœ‹å’Œè°ƒæ•´çº¿ç¨‹æ± å‚æ•°\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"ç¬¬ä¸€æ­¥åˆ›å»º-starter-é¡¹ç›®\"\u003eç¬¬ä¸€æ­¥ï¼šåˆ›å»º Starter é¡¹ç›®\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eé¡¹ç›®ç»“æ„\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003ethreadpool-spring-boot-starter\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ src/main/java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ com/example/threadpool\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”œâ”€â”€ autoconfigure\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â”œâ”€â”€ ThreadPoolAutoConfiguration.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â””â”€â”€ ThreadPoolProperties.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”œâ”€â”€ core\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â”œâ”€â”€ ThreadPoolMonitor.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â”‚   â””â”€â”€ ThreadPoolRegistry.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â””â”€â”€ processor\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚           â””â”€â”€ ThreadPoolBeanPostProcessor.java\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”œâ”€â”€ src/main/resources\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚   â””â”€â”€ META-INF\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ”‚       â””â”€â”€ spring.factories\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003eâ””â”€â”€ pom.xml\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003epom.xml\u003c/strong\u003e\u003c/p\u003e","title":"Spring Boot Starter è‡ªå®šä¹‰å¼€å‘ï¼šä»åŸç†åˆ°å®æˆ˜"},{"content":"åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”Ÿæˆå…¨å±€å”¯ä¸€ ID æ˜¯ä¸€ä¸ªåŸºç¡€éœ€æ±‚ã€‚æ•°æ®åº“è‡ªå¢ ID åœ¨åˆ†åº“åˆ†è¡¨åæ— æ³•ä½¿ç”¨ï¼ŒUUID è™½ç„¶ç®€å•ä½†ä¸é€‚åˆä½œä¸ºä¸»é”®ã€‚æœ¬æ–‡å¯¹æ¯”ä¸»æµçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚ æŒæ¡é›ªèŠ±ç®—æ³•çš„å®ç°ä¸æ—¶é’Ÿå›æ‹¨é—®é¢˜ äº†è§£ç¾å›¢ Leaf æ–¹æ¡ˆçš„è®¾è®¡æ€æƒ³ å­¦ä¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚ å…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½é‡å¤ è¶‹åŠ¿é€’å¢ï¼šæ–¹ä¾¿æ’åºå’Œç´¢å¼• é«˜æ€§èƒ½ï¼šç”Ÿæˆé€Ÿåº¦å¿« é«˜å¯ç”¨ï¼šæœåŠ¡ä¸èƒ½æŒ‚ ä¿¡æ¯å®‰å…¨ï¼šä¸èƒ½æ³„éœ²ä¸šåŠ¡ä¿¡æ¯ æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“è‡ªå¢ ID 1CREATE TABLE id_generator ( 2 id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY, 3 stub CHAR(1) NOT NULL DEFAULT \u0026#39;\u0026#39;, 4 UNIQUE KEY stub (stub) 5); 6 7INSERT INTO id_generator (stub) VALUES (\u0026#39;a\u0026#39;); 8SELECT LAST_INSERT_ID(); ä¼˜ç‚¹ï¼šç®€å•ï¼Œè¶‹åŠ¿é€’å¢\nç¼ºç‚¹ï¼š\næ€§èƒ½ç“¶é¢ˆï¼šæ•°æ®åº“å‹åŠ›å¤§ å•ç‚¹æ•…éšœï¼šæ•°æ®åº“æŒ‚äº†å°±æ— æ³•ç”Ÿæˆ ID æ‰©å±•æ€§å·®ï¼šåˆ†åº“åˆ†è¡¨åéœ€è¦è®¾ç½®ä¸åŒçš„æ­¥é•¿ æ–¹æ¡ˆäºŒï¼šUUID 1String id = UUID.randomUUID().toString(); ä¼˜ç‚¹ï¼šç®€å•ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ€§èƒ½é«˜\nç¼ºç‚¹ï¼š\næ— åºï¼šä¸åˆ©äºæ•°æ®åº“ç´¢å¼• é•¿åº¦é•¿ï¼š36 ä¸ªå­—ç¬¦ï¼Œå ç”¨ç©ºé—´å¤§ ä¸é€‚åˆä½œä¸ºä¸»é”®ï¼šB+ æ ‘ç´¢å¼•æ€§èƒ½å·® æ–¹æ¡ˆä¸‰ï¼šé›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰ Twitter å¼€æºçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆç®—æ³•ï¼Œç”Ÿæˆ 64 ä½ long å‹ IDã€‚\nID ç»“æ„\n10 - 41ä½æ—¶é—´æˆ³ - 10ä½æœºå™¨ID - 12ä½åºåˆ—å· 1 ä½ï¼šç¬¦å·ä½ï¼Œå›ºå®šä¸º 0 41 ä½ï¼šæ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼Œå¯ç”¨ 69 å¹´ 10 ä½ï¼šæœºå™¨ IDï¼ˆ5 ä½æ•°æ®ä¸­å¿ƒ ID + 5 ä½æœºå™¨ IDï¼‰ï¼Œæ”¯æŒ 1024 å°æœºå™¨ 12 ä½ï¼šåºåˆ—å·ï¼ŒåŒä¸€æ¯«ç§’å†…å¯ç”Ÿæˆ 4096 ä¸ª ID å®ç°ä»£ç \n1public class SnowflakeIdGenerator { 2 3 private final long twepoch = 1288834974657L; // èµ·å§‹æ—¶é—´æˆ³ 4 private final long workerIdBits = 5L; 5 private final long datacenterIdBits = 5L; 6 private final long sequenceBits = 12L; 7 8 private final long workerIdShift = sequenceBits; 9 private final long datacenterIdShift = sequenceBits + workerIdBits; 10 private final long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits; 11 private final long sequenceMask = -1L ^ (-1L \u0026lt;\u0026lt; sequenceBits); 12 13 private long workerId; 14 private long datacenterId; 15 private long sequence = 0L; 16 private long lastTimestamp = -1L; 17 18 public synchronized long nextId() { 19 long timestamp = System.currentTimeMillis(); 20 21 // æ—¶é’Ÿå›æ‹¨æ£€æµ‹ 22 if (timestamp \u0026lt; lastTimestamp) { 23 throw new RuntimeException(\u0026#34;Clock moved backwards\u0026#34;); 24 } 25 26 // åŒä¸€æ¯«ç§’å†…ï¼Œåºåˆ—å·è‡ªå¢ 27 if (lastTimestamp == timestamp) { 28 sequence = (sequence + 1) \u0026amp; sequenceMask; 29 if (sequence == 0) { 30 // åºåˆ—å·ç”¨å®Œï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’ 31 timestamp = tilNextMillis(lastTimestamp); 32 } 33 } else { 34 sequence = 0L; 35 } 36 37 lastTimestamp = timestamp; 38 39 // ç»„è£… ID 40 return ((timestamp - twepoch) \u0026lt;\u0026lt; timestampLeftShift) 41 | (datacenterId \u0026lt;\u0026lt; datacenterIdShift) 42 | (workerId \u0026lt;\u0026lt; workerIdShift) 43 | sequence; 44 } 45 46 private long tilNextMillis(long lastTimestamp) { 47 long timestamp = System.currentTimeMillis(); 48 while (timestamp \u0026lt;= lastTimestamp) { 49 timestamp = System.currentTimeMillis(); 50 } 51 return timestamp; 52 } 53} æ—¶é’Ÿå›æ‹¨é—®é¢˜\nå¦‚æœç³»ç»Ÿæ—¶é—´è¢«å›æ‹¨ï¼Œä¼šå¯¼è‡´ ID é‡å¤ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\næ‹’ç»ç”Ÿæˆ IDï¼ŒæŠ›å‡ºå¼‚å¸¸ ç­‰å¾…æ—¶é’Ÿè¿½ä¸Š ä½¿ç”¨æ‰©å±•ä½è®°å½•æ—¶é’Ÿå›æ‹¨æ¬¡æ•° æ–¹æ¡ˆå››ï¼šç¾å›¢ Leaf ç¾å›¢å¼€æºçš„åˆ†å¸ƒå¼ ID ç”ŸæˆæœåŠ¡ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š\nLeaf-segmentï¼šå·æ®µæ¨¡å¼\nä»æ•°æ®åº“æ‰¹é‡è·å– ID å·æ®µï¼Œç¼“å­˜åœ¨å†…å­˜ä¸­åˆ†é…ã€‚\n1CREATE TABLE leaf_alloc ( 2 biz_tag VARCHAR(128) NOT NULL, 3 max_id BIGINT NOT NULL, 4 step INT NOT NULL, 5 PRIMARY KEY (biz_tag) 6); æµç¨‹ï¼š\næœåŠ¡å¯åŠ¨æ—¶ï¼Œä»æ•°æ®åº“è·å–å·æ®µï¼ˆå¦‚ 1-1000ï¼‰ åœ¨å†…å­˜ä¸­åˆ†é… ID å·æ®µç”¨å®Œåï¼Œå†æ¬¡ä»æ•°æ®åº“è·å–ä¸‹ä¸€ä¸ªå·æ®µ ä¼˜ç‚¹ï¼š\nå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•° æ”¯æŒåŠ¨æ€è°ƒæ•´æ­¥é•¿ Leaf-snowflakeï¼šé›ªèŠ±æ¨¡å¼\nåŸºäº Zookeeper ç”Ÿæˆæœºå™¨ IDï¼Œè§£å†³äº†é›ªèŠ±ç®—æ³•çš„æœºå™¨ ID åˆ†é…é—®é¢˜ã€‚\næ–¹æ¡ˆå¯¹æ¯” æ–¹æ¡ˆ æ€§èƒ½ å¯ç”¨æ€§ è¶‹åŠ¿é€’å¢ å¤æ‚åº¦ æ•°æ®åº“è‡ªå¢ ä½ ä½ æ˜¯ ä½ UUID é«˜ é«˜ å¦ ä½ é›ªèŠ±ç®—æ³• é«˜ é«˜ æ˜¯ ä¸­ Leaf-segment ä¸­ ä¸­ æ˜¯ ä¸­ Leaf-snowflake é«˜ é«˜ æ˜¯ é«˜ é€‰å‹å»ºè®® å°å‹é¡¹ç›®ï¼šæ•°æ®åº“è‡ªå¢ ID å¯¹é¡ºåºæ— è¦æ±‚ï¼šUUID é«˜æ€§èƒ½è¦æ±‚ï¼šé›ªèŠ±ç®—æ³• éœ€è¦é›†ä¸­ç®¡ç†ï¼šLeaf æ€»ç»“ä¸æ€è€ƒ åˆ†å¸ƒå¼ ID ç”Ÿæˆæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€é—®é¢˜ï¼Œä¸åŒæ–¹æ¡ˆé€‚ç”¨äºä¸åŒåœºæ™¯ã€‚\né›ªèŠ±ç®—æ³•æ€§èƒ½é«˜ï¼Œä½†éœ€è¦è§£å†³æ—¶é’Ÿå›æ‹¨å’Œæœºå™¨ ID åˆ†é…é—®é¢˜ Leaf æä¾›äº†æ›´å®Œå–„çš„è§£å†³æ–¹æ¡ˆï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ ä¸‹æ¬¡å½“ä½ éœ€è¦ç”Ÿæˆåˆ†å¸ƒå¼ ID æ—¶ï¼Œæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\n","permalink":"http://localhost:1313/posts/2024/07/%E5%88%86%E5%B8%83%E5%BC%8F-id-%E7%94%9F%E6%88%90%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94%E4%B8%8E%E9%80%89%E5%9E%8B%E6%8C%87%E5%8D%97/","summary":"\u003cp\u003eåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”Ÿæˆå…¨å±€å”¯ä¸€ ID æ˜¯ä¸€ä¸ªåŸºç¡€éœ€æ±‚ã€‚æ•°æ®åº“è‡ªå¢ ID åœ¨åˆ†åº“åˆ†è¡¨åæ— æ³•ä½¿ç”¨ï¼ŒUUID è™½ç„¶ç®€å•ä½†ä¸é€‚åˆä½œä¸ºä¸»é”®ã€‚æœ¬æ–‡å¯¹æ¯”ä¸»æµçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£åˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡é›ªèŠ±ç®—æ³•çš„å®ç°ä¸æ—¶é’Ÿå›æ‹¨é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ç¾å›¢ Leaf æ–¹æ¡ˆçš„è®¾è®¡æ€æƒ³\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"åˆ†å¸ƒå¼-id-çš„æ ¸å¿ƒè¦æ±‚\"\u003eåˆ†å¸ƒå¼ ID çš„æ ¸å¿ƒè¦æ±‚\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eå…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½é‡å¤\u003c/li\u003e\n\u003cli\u003eè¶‹åŠ¿é€’å¢ï¼šæ–¹ä¾¿æ’åºå’Œç´¢å¼•\u003c/li\u003e\n\u003cli\u003eé«˜æ€§èƒ½ï¼šç”Ÿæˆé€Ÿåº¦å¿«\u003c/li\u003e\n\u003cli\u003eé«˜å¯ç”¨ï¼šæœåŠ¡ä¸èƒ½æŒ‚\u003c/li\u003e\n\u003cli\u003eä¿¡æ¯å®‰å…¨ï¼šä¸èƒ½æ³„éœ²ä¸šåŠ¡ä¿¡æ¯\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ–¹æ¡ˆä¸€æ•°æ®åº“è‡ªå¢-id\"\u003eæ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“è‡ªå¢ ID\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eCREATE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid_generator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003eBIGINT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTO_INCREMENT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ePRIMARY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003eCHAR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eDEFAULT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eUNIQUE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eINSERT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eINTO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid_generator\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estub\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;a\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLAST_INSERT_ID\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¼˜ç‚¹ï¼šç®€å•ï¼Œè¶‹åŠ¿é€’å¢\u003c/p\u003e\n\u003cp\u003eç¼ºç‚¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ€§èƒ½ç“¶é¢ˆï¼šæ•°æ®åº“å‹åŠ›å¤§\u003c/li\u003e\n\u003cli\u003eå•ç‚¹æ•…éšœï¼šæ•°æ®åº“æŒ‚äº†å°±æ— æ³•ç”Ÿæˆ ID\u003c/li\u003e\n\u003cli\u003eæ‰©å±•æ€§å·®ï¼šåˆ†åº“åˆ†è¡¨åéœ€è¦è®¾ç½®ä¸åŒçš„æ­¥é•¿\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ–¹æ¡ˆäºŒuuid\"\u003eæ–¹æ¡ˆäºŒï¼šUUID\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUUID\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erandomUUID\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003etoString\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¼˜ç‚¹ï¼šç®€å•ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ€§èƒ½é«˜\u003c/p\u003e","title":"åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹æŒ‡å—"},{"content":"ç†è§£ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯æŒæ¡ Spring æ¡†æ¶çš„å…³é”®ã€‚æœ¬æ–‡ä»æºç å±‚é¢å‰–æ Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ Spring çš„æ ¸å¿ƒæœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ Bean ç”Ÿå‘½å‘¨æœŸçš„å®Œæ•´æµç¨‹ ç†è§£ BeanPostProcessor çš„æ‰§è¡Œæ—¶æœº å­¦ä¼šè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ äº†è§£ InitializingBean vs @PostConstruct çš„åŒºåˆ« Bean ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ 1å®ä¾‹åŒ– â†’ å±æ€§å¡«å…… â†’ åˆå§‹åŒ–å‰ â†’ åˆå§‹åŒ– â†’ åˆå§‹åŒ–å â†’ ä½¿ç”¨ â†’ é”€æ¯ è¯¦ç»†æµç¨‹ï¼š\nå®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ï¼šé€šè¿‡åå°„åˆ›å»º Bean å®ä¾‹ å±æ€§å¡«å……ï¼ˆPopulateï¼‰ï¼šæ³¨å…¥ä¾èµ–çš„ Bean Aware æ¥å£å›è°ƒï¼šBeanNameAwareã€BeanFactoryAware ç­‰ BeanPostProcessor.postProcessBeforeInitialization InitializingBean.afterPropertiesSet è‡ªå®šä¹‰ init-method BeanPostProcessor.postProcessAfterInitialization Bean å¯ä»¥ä½¿ç”¨ DisposableBean.destroy è‡ªå®šä¹‰ destroy-method å®ä¾‹åŒ–ï¼šåå°„åˆ›å»ºå¯¹è±¡ 1protected Object doCreateBean(String beanName, RootBeanDefinition mbd, Object[] args) { 2 // 1. å®ä¾‹åŒ– Bean 3 BeanWrapper instanceWrapper = createBeanInstance(beanName, mbd, args); 4 Object bean = instanceWrapper.getWrappedInstance(); 5 6 // 2. å±æ€§å¡«å…… 7 populateBean(beanName, mbd, instanceWrapper); 8 9 // 3. åˆå§‹åŒ– 10 Object exposedObject = initializeBean(beanName, bean, mbd); 11 12 return exposedObject; 13} å±æ€§å¡«å……ï¼šä¾èµ–æ³¨å…¥ 1protected void populateBean(String beanName, RootBeanDefinition mbd, BeanWrapper bw) { 2 // è·å–å±æ€§å€¼ 3 PropertyValues pvs = mbd.getPropertyValues(); 4 5 // è‡ªåŠ¨è£…é…ï¼ˆbyNameã€byTypeï¼‰ 6 if (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_NAME) { 7 autowireByName(beanName, mbd, bw, newPvs); 8 } 9 if (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_TYPE) { 10 autowireByType(beanName, mbd, bw, newPvs); 11 } 12 13 // åº”ç”¨å±æ€§å€¼ 14 applyPropertyValues(beanName, mbd, bw, pvs); 15} åˆå§‹åŒ–ï¼šå›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘ 1protected Object initializeBean(String beanName, Object bean, RootBeanDefinition mbd) { 2 // 1. Aware æ¥å£å›è°ƒ 3 invokeAwareMethods(beanName, bean); 4 5 // 2. BeanPostProcessor å‰ç½®å¤„ç† 6 Object wrappedBean = applyBeanPostProcessorsBeforeInitialization(bean, beanName); 7 8 // 3. åˆå§‹åŒ–æ–¹æ³• 9 invokeInitMethods(beanName, wrappedBean, mbd); 10 11 // 4. BeanPostProcessor åç½®å¤„ç† 12 wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); 13 14 return wrappedBean; 15} BeanPostProcessorï¼šæ‰©å±•ç‚¹ 1public interface BeanPostProcessor { 2 3 // åˆå§‹åŒ–å‰å›è°ƒ 4 default Object postProcessBeforeInitialization(Object bean, String beanName) { 5 return bean; 6 } 7 8 // åˆå§‹åŒ–åå›è°ƒ 9 default Object postProcessAfterInitialization(Object bean, String beanName) { 10 return bean; 11 } 12} åº”ç”¨åœºæ™¯ï¼š\n@Autowired æ³¨è§£çš„å¤„ç†ï¼ˆAutowiredAnnotationBeanPostProcessorï¼‰ AOP ä»£ç†çš„åˆ›å»ºï¼ˆAbstractAutoProxyCreatorï¼‰ @PostConstruct æ³¨è§£çš„å¤„ç†ï¼ˆCommonAnnotationBeanPostProcessorï¼‰ å¾ªç¯ä¾èµ–ï¼šä¸‰çº§ç¼“å­˜ 1@Service 2public class A { 3 @Autowired 4 private B b; 5} 6 7@Service 8public class B { 9 @Autowired 10 private A a; 11} Spring é€šè¿‡ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼š\n1// ä¸€çº§ç¼“å­˜ï¼šå®Œæ•´çš„ Bean 2private final Map\u0026lt;String, Object\u0026gt; singletonObjects = new ConcurrentHashMap\u0026lt;\u0026gt;(); 3 4// äºŒçº§ç¼“å­˜ï¼šæ—©æœŸçš„ Beanï¼ˆå·²å®ä¾‹åŒ–ï¼Œæœªåˆå§‹åŒ–ï¼‰ 5private final Map\u0026lt;String, Object\u0026gt; earlySingletonObjects = new HashMap\u0026lt;\u0026gt;(); 6 7// ä¸‰çº§ç¼“å­˜ï¼šBean å·¥å‚ 8private final Map\u0026lt;String, ObjectFactory\u0026lt;?\u0026gt;\u0026gt; singletonFactories = new HashMap\u0026lt;\u0026gt;(); è§£å†³æµç¨‹ï¼š\nåˆ›å»º Aï¼Œå®ä¾‹åŒ–åæ”¾å…¥ä¸‰çº§ç¼“å­˜ å¡«å…… A çš„å±æ€§ï¼Œå‘ç°ä¾èµ– B åˆ›å»º Bï¼Œå®ä¾‹åŒ–åæ”¾å…¥ä¸‰çº§ç¼“å­˜ å¡«å…… B çš„å±æ€§ï¼Œå‘ç°ä¾èµ– A ä»ä¸‰çº§ç¼“å­˜è·å– A çš„æ—©æœŸå¼•ç”¨ï¼Œæ³¨å…¥åˆ° B B åˆå§‹åŒ–å®Œæˆï¼Œæ³¨å…¥åˆ° A A åˆå§‹åŒ–å®Œæˆ é¿å‘æç¤ºï¼š æ„é€ å™¨æ³¨å…¥æ— æ³•è§£å†³å¾ªç¯ä¾èµ–ï¼Œå› ä¸ºå®ä¾‹åŒ–æ—¶å°±éœ€è¦ä¾èµ–å¯¹è±¡ã€‚åªæœ‰ setter æ³¨å…¥å’Œå­—æ®µæ³¨å…¥å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–ã€‚\nInitializingBean vs @PostConstruct ä¸‰ç§åˆå§‹åŒ–æ–¹å¼çš„æ‰§è¡Œé¡ºåºï¼š\n1@Component 2public class MyBean implements InitializingBean { 3 4 @PostConstruct 5 public void postConstruct() { 6 System.out.println(\u0026#34;1. @PostConstruct\u0026#34;); 7 } 8 9 @Override 10 public void afterPropertiesSet() { 11 System.out.println(\u0026#34;2. InitializingBean.afterPropertiesSet\u0026#34;); 12 } 13 14 public void initMethod() { 15 System.out.println(\u0026#34;3. init-method\u0026#34;); 16 } 17} æ¨èä½¿ç”¨ @PostConstructï¼Œå› ä¸ºå®ƒæ˜¯ JSR-250 æ ‡å‡†ï¼Œä¸ä¾èµ– Springã€‚\næ€»ç»“ä¸æ€è€ƒ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸä½“ç°äº†\u0026quot;æ¨¡æ¿æ–¹æ³•æ¨¡å¼\u0026quot;å’Œ\u0026quot;è´£ä»»é“¾æ¨¡å¼\u0026quot;çš„è®¾è®¡æ€æƒ³ã€‚\næ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰äº† Bean åˆ›å»ºçš„éª¨æ¶æµç¨‹ è´£ä»»é“¾ï¼šBeanPostProcessor å½¢æˆå¤„ç†é“¾ ç†è§£ Bean ç”Ÿå‘½å‘¨æœŸï¼Œæ‰èƒ½æ›´å¥½åœ°æ‰©å±• Spring æ¡†æ¶ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åœ¨ Bean åˆå§‹åŒ–æ—¶æ‰§è¡Œé€»è¾‘ï¼Œä¸å¦¨è¯•è¯• @PostConstruct æˆ– BeanPostProcessorã€‚\n","permalink":"http://localhost:1313/posts/2024/06/spring-bean-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eç†è§£ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯æŒæ¡ Spring æ¡†æ¶çš„å…³é”®ã€‚æœ¬æ–‡ä»æºç å±‚é¢å‰–æ Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ Spring çš„æ ¸å¿ƒæœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ Bean ç”Ÿå‘½å‘¨æœŸçš„å®Œæ•´æµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ BeanPostProcessor çš„æ‰§è¡Œæ—¶æœº\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ InitializingBean vs @PostConstruct çš„åŒºåˆ«\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"bean-ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ\"\u003eBean ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eå®ä¾‹åŒ– â†’ å±æ€§å¡«å…… â†’ åˆå§‹åŒ–å‰ â†’ åˆå§‹åŒ– â†’ åˆå§‹åŒ–å â†’ ä½¿ç”¨ â†’ é”€æ¯\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¯¦ç»†æµç¨‹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ï¼šé€šè¿‡åå°„åˆ›å»º Bean å®ä¾‹\u003c/li\u003e\n\u003cli\u003eå±æ€§å¡«å……ï¼ˆPopulateï¼‰ï¼šæ³¨å…¥ä¾èµ–çš„ Bean\u003c/li\u003e\n\u003cli\u003eAware æ¥å£å›è°ƒï¼šBeanNameAwareã€BeanFactoryAware ç­‰\u003c/li\u003e\n\u003cli\u003eBeanPostProcessor.postProcessBeforeInitialization\u003c/li\u003e\n\u003cli\u003eInitializingBean.afterPropertiesSet\u003c/li\u003e\n\u003cli\u003eè‡ªå®šä¹‰ init-method\u003c/li\u003e\n\u003cli\u003eBeanPostProcessor.postProcessAfterInitialization\u003c/li\u003e\n\u003cli\u003eBean å¯ä»¥ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eDisposableBean.destroy\u003c/li\u003e\n\u003cli\u003eè‡ªå®šä¹‰ destroy-method\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"å®ä¾‹åŒ–åå°„åˆ›å»ºå¯¹è±¡\"\u003eå®ä¾‹åŒ–ï¼šåå°„åˆ›å»ºå¯¹è±¡\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003edoCreateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. å®ä¾‹åŒ– Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eBeanWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecreateBeanInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetWrappedInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. å±æ€§å¡«å……\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003epopulateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einstanceWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆå§‹åŒ–\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexposedObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einitializeBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexposedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"å±æ€§å¡«å……ä¾èµ–æ³¨å…¥\"\u003eå±æ€§å¡«å……ï¼šä¾èµ–æ³¨å…¥\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epopulateBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eBeanWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è·å–å±æ€§å€¼\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ePropertyValues\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epvs\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetPropertyValues\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// è‡ªåŠ¨è£…é…ï¼ˆbyNameã€byTypeï¼‰\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetResolvedAutowireMode\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTOWIRE_BY_NAME\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eautowireByName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enewPvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetResolvedAutowireMode\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTOWIRE_BY_TYPE\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eautowireByType\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003enewPvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åº”ç”¨å±æ€§å€¼\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyPropertyValues\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003epvs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"åˆå§‹åŒ–å›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘\"\u003eåˆå§‹åŒ–ï¼šå›è°ƒä¸è‡ªå®šä¹‰é€»è¾‘\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003einitializeBean\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eRootBeanDefinition\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 1. Aware æ¥å£å›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003einvokeAwareMethods\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 2. BeanPostProcessor å‰ç½®å¤„ç†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyBeanPostProcessorsBeforeInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 3. åˆå§‹åŒ–æ–¹æ³•\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003einvokeInitMethods\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003embd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// 4. BeanPostProcessor åç½®å¤„ç†\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eapplyBeanPostProcessorsAfterInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrappedBean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch2 id=\"beanpostprocessoræ‰©å±•ç‚¹\"\u003eBeanPostProcessorï¼šæ‰©å±•ç‚¹\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eBeanPostProcessor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–å‰å›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epostProcessBeforeInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åˆå§‹åŒ–åå›è°ƒ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003epostProcessAfterInitialization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebeanName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåº”ç”¨åœºæ™¯ï¼š\u003c/p\u003e","title":"Spring Bean ç”Ÿå‘½å‘¨æœŸå®Œå…¨è§£æ"},{"content":"Spring äº‹åŠ¡ç®¡ç†æ˜¯åç«¯å¼€å‘çš„åŸºç¡€æŠ€èƒ½ï¼Œä½†å¾ˆå¤šäººåªä¼šåœ¨æ–¹æ³•ä¸ŠåŠ  @Transactionalï¼Œå´ä¸çŸ¥é“äº‹åŠ¡ä¼ æ’­æœºåˆ¶å’Œå¤±æ•ˆåœºæ™¯ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ Spring äº‹åŠ¡çš„æ ¸å¿ƒåŸç†ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯ æŒæ¡äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§å¸¸è§åœºæ™¯ å­¦ä¼šç¼–ç¨‹å¼äº‹åŠ¡çš„ä½¿ç”¨æ–¹æ³• äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ äº‹åŠ¡çš„ ACID ç‰¹æ€§ Atomicityï¼ˆåŸå­æ€§ï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€ Isolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¹¶å‘äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰° Durabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º REQUIREDï¼ˆé»˜è®¤ï¼‰\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°äº‹åŠ¡ã€‚\n1@Transactional(propagation = Propagation.REQUIRED) 2public void methodA() { 3 // æ“ä½œ 1 4 methodB(); // åŠ å…¥ methodA çš„äº‹åŠ¡ 5} 6 7@Transactional(propagation = Propagation.REQUIRED) 8public void methodB() { 9 // æ“ä½œ 2 10} å¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼ŒmethodA å’Œ methodB çš„æ“ä½œéƒ½ä¼šå›æ»šã€‚\nREQUIRES_NEW\næ— è®ºå½“å‰æ˜¯å¦å­˜åœ¨äº‹åŠ¡ï¼Œéƒ½åˆ›å»ºæ–°äº‹åŠ¡ã€‚å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚\n1@Transactional 2public void methodA() { 3 // æ“ä½œ 1 4 methodB(); // åˆ›å»ºæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ· methodA çš„äº‹åŠ¡ 5 // æ“ä½œ 3 6} 7 8@Transactional(propagation = Propagation.REQUIRES_NEW) 9public void methodB() { 10 // æ“ä½œ 2 11} å¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼Œåªå›æ»šæ“ä½œ 2ï¼Œæ“ä½œ 1 å’Œæ“ä½œ 3 ä¸å—å½±å“ã€‚\nNESTED\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ›å»ºåµŒå¥—äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œç­‰åŒäº REQUIREDã€‚\n1@Transactional 2public void methodA() { 3 // æ“ä½œ 1 4 try { 5 methodB(); // åˆ›å»ºåµŒå¥—äº‹åŠ¡ï¼ˆä¿å­˜ç‚¹ï¼‰ 6 } catch (Exception e) { 7 // methodB å›æ»šï¼Œä½† methodA å¯ä»¥ç»§ç»­ 8 } 9 // æ“ä½œ 3 10} 11 12@Transactional(propagation = Propagation.NESTED) 13public void methodB() { 14 // æ“ä½œ 2 15} åµŒå¥—äº‹åŠ¡åŸºäºæ•°æ®åº“çš„ Savepoint æœºåˆ¶å®ç°ã€‚\nSUPPORTS\nå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚\né€‚ç”¨äºæŸ¥è¯¢æ–¹æ³•ã€‚\nNOT_SUPPORTED\nä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚\nMANDATORY\nå¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦‚æœå½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\nNEVER\nå¿…é¡»åœ¨éäº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\næ¶æ„æ€è€ƒï¼š äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„è®¾è®¡ä½“ç°äº†\u0026quot;çµæ´»æ€§ä¸å®‰å…¨æ€§çš„å¹³è¡¡\u0026quot;ã€‚REQUIRED ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§ï¼ŒREQUIRES_NEW æä¾›äº†äº‹åŠ¡éš”ç¦»ï¼ŒNESTED æ”¯æŒéƒ¨åˆ†å›æ»šã€‚ä¸åŒçš„ä¸šåŠ¡åœºæ™¯éœ€è¦ä¸åŒçš„ä¼ æ’­è¡Œä¸ºã€‚\näº‹åŠ¡å¤±æ•ˆçš„ 5 ç§åœºæ™¯ åœºæ™¯ä¸€ï¼šæ–¹æ³•ä¸æ˜¯ public\n@Transactional åªå¯¹ public æ–¹æ³•ç”Ÿæ•ˆã€‚\n1@Service 2public class UserService { 3 4 @Transactional 5 private void addUser(User user) { // äº‹åŠ¡å¤±æ•ˆ 6 userMapper.insert(user); 7 } 8} åŸå› ï¼šSpring AOP åŸºäºä»£ç†ï¼Œåªèƒ½ä»£ç† public æ–¹æ³•ã€‚\nåœºæ™¯äºŒï¼šæ–¹æ³•å†…éƒ¨è°ƒç”¨\nåŒä¸€ä¸ªç±»ä¸­ï¼Œæ–¹æ³• A è°ƒç”¨æ–¹æ³• Bï¼Œæ–¹æ³• B çš„äº‹åŠ¡å¤±æ•ˆã€‚\n1@Service 2public class UserService { 3 4 public void methodA() { 5 methodB(); // ç›´æ¥è°ƒç”¨ï¼Œä¸èµ°ä»£ç† 6 } 7 8 @Transactional 9 public void methodB() { // äº‹åŠ¡å¤±æ•ˆ 10 userMapper.insert(user); 11 } 12} åŸå› ï¼šå†…éƒ¨è°ƒç”¨ä¸èµ°ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ this.methodB()ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\n1@Service 2public class UserService { 3 4 @Autowired 5 private UserService self; // æ³¨å…¥è‡ªå·± 6 7 public void methodA() { 8 self.methodB(); // é€šè¿‡ä»£ç†è°ƒç”¨ 9 } 10 11 @Transactional 12 public void methodB() { 13 userMapper.insert(user); 14 } 15} åœºæ™¯ä¸‰ï¼šå¼‚å¸¸è¢«æ•è·\n1@Transactional 2public void addUser(User user) { 3 try { 4 userMapper.insert(user); 5 int i = 1 / 0; // æŠ›å‡ºå¼‚å¸¸ 6 } catch (Exception e) { 7 log.error(\u0026#34;å¼‚å¸¸\u0026#34;, e); // å¼‚å¸¸è¢«æ•è·ï¼Œäº‹åŠ¡ä¸å›æ»š 8 } 9} è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨å›æ»š\n1@Transactional 2public void addUser(User user) { 3 try { 4 userMapper.insert(user); 5 int i = 1 / 0; 6 } catch (Exception e) { 7 log.error(\u0026#34;å¼‚å¸¸\u0026#34;, e); 8 TransactionAspectSupport.currentTransactionStatus().setRollbackOnly(); 9 } 10} åœºæ™¯å››ï¼šå¼‚å¸¸ç±»å‹ä¸åŒ¹é…\n@Transactional é»˜è®¤åªå›æ»š RuntimeException å’Œ Errorã€‚\n1@Transactional 2public void addUser(User user) throws Exception { 3 userMapper.insert(user); 4 throw new Exception(\u0026#34;checked exception\u0026#34;); // äº‹åŠ¡ä¸å›æ»š 5} è§£å†³æ–¹æ¡ˆï¼šæŒ‡å®šå›æ»šçš„å¼‚å¸¸ç±»å‹\n1@Transactional(rollbackFor = Exception.class) 2public void addUser(User user) throws Exception { 3 userMapper.insert(user); 4 throw new Exception(\u0026#34;checked exception\u0026#34;); 5} åœºæ™¯äº”ï¼šæ•°æ®åº“ä¸æ”¯æŒäº‹åŠ¡\nMyISAM å¼•æ“ä¸æ”¯æŒäº‹åŠ¡ï¼Œåªæœ‰ InnoDB æ”¯æŒã€‚\nç¼–ç¨‹å¼äº‹åŠ¡ å£°æ˜å¼äº‹åŠ¡ï¼ˆ@Transactionalï¼‰ç®€å•æ˜“ç”¨ï¼Œä½†ä¸å¤Ÿçµæ´»ã€‚ç¼–ç¨‹å¼äº‹åŠ¡æä¾›äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚\n1@Service 2public class UserService { 3 4 @Autowired 5 private TransactionTemplate transactionTemplate; 6 7 public void addUser(User user) { 8 transactionTemplate.execute(status -\u0026gt; { 9 try { 10 userMapper.insert(user); 11 // å…¶ä»–æ“ä½œ 12 return true; 13 } catch (Exception e) { 14 status.setRollbackOnly(); 15 return false; 16 } 17 }); 18 } 19} åˆ†å¸ƒå¼äº‹åŠ¡ å•ä½“åº”ç”¨çš„äº‹åŠ¡ç”±æ•°æ®åº“ä¿è¯ï¼Œä½†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡å¯èƒ½æ¶‰åŠå¤šä¸ªæœåŠ¡å’Œæ•°æ®åº“ï¼Œéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nè§£å†³æ–¹æ¡ˆä¸€ï¼šä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰\nåè°ƒè€…å…ˆè¯¢é—®æ‰€æœ‰å‚ä¸è€…æ˜¯å¦å¯ä»¥æäº¤ï¼Œå¦‚æœéƒ½åŒæ„ï¼Œå†é€šçŸ¥æäº¤ã€‚\nç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œå­˜åœ¨å•ç‚¹æ•…éšœã€‚\nè§£å†³æ–¹æ¡ˆäºŒï¼šTCC\nTry-Confirm-Cancelï¼Œä¸šåŠ¡å±‚é¢çš„ä¸¤é˜¶æ®µæäº¤ã€‚\nTryï¼šé¢„ç•™èµ„æº Confirmï¼šç¡®è®¤æäº¤ Cancelï¼šå–æ¶ˆå›æ»š è§£å†³æ–¹æ¡ˆä¸‰ï¼šSeata AT æ¨¡å¼\nè‡ªåŠ¨è®°å½• SQL çš„å‰åé•œåƒï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›æ»šã€‚\nè§£å†³æ–¹æ¡ˆå››ï¼šæœ€ç»ˆä¸€è‡´æ€§\né€šè¿‡æ¶ˆæ¯é˜Ÿåˆ— + è¡¥å¿æœºåˆ¶å®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚\næ€»ç»“ä¸æ€è€ƒ Spring äº‹åŠ¡çš„æ ¸å¿ƒæ˜¯ AOP ä»£ç†ï¼Œç†è§£ä»£ç†æœºåˆ¶æ‰èƒ½é¿å…äº‹åŠ¡å¤±æ•ˆã€‚\n7 ç§ä¼ æ’­è¡Œä¸ºé€‚ç”¨äºä¸åŒåœºæ™¯ äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§åœºæ™¯è¦ç‰¢è®° åˆ†å¸ƒå¼äº‹åŠ¡è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©æ–¹æ¡ˆ ä¸‹æ¬¡å½“ä½ çš„äº‹åŠ¡ä¸ç”Ÿæ•ˆæ—¶ï¼Œæ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯è¸©äº†è¿™äº›å‘ã€‚\n","permalink":"http://localhost:1313/posts/2024/05/spring-%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eSpring äº‹åŠ¡ç®¡ç†æ˜¯åç«¯å¼€å‘çš„åŸºç¡€æŠ€èƒ½ï¼Œä½†å¾ˆå¤šäººåªä¼šåœ¨æ–¹æ³•ä¸ŠåŠ  @Transactionalï¼Œå´ä¸çŸ¥é“äº‹åŠ¡ä¼ æ’­æœºåˆ¶å’Œå¤±æ•ˆåœºæ™¯ã€‚æœ¬æ–‡ç³»ç»Ÿè®²è§£ Spring äº‹åŠ¡çš„æ ¸å¿ƒåŸç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„åŒºåˆ«ä¸é€‚ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡äº‹åŠ¡å¤±æ•ˆçš„ 5 ç§å¸¸è§åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šç¼–ç¨‹å¼äº‹åŠ¡çš„ä½¿ç”¨æ–¹æ³•\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"äº‹åŠ¡çš„-acid-ç‰¹æ€§\"\u003eäº‹åŠ¡çš„ ACID ç‰¹æ€§\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eAtomicityï¼ˆåŸå­æ€§ï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥\u003c/li\u003e\n\u003cli\u003eConsistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€\u003c/li\u003e\n\u003cli\u003eIsolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¹¶å‘äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°\u003c/li\u003e\n\u003cli\u003eDurabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"7-ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º\"\u003e7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eREQUIREDï¼ˆé»˜è®¤ï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒåŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°äº‹åŠ¡ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Transactional\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epropagation\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePropagation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eREQUIRED\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003emethodA\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ“ä½œ 1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003emethodB\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// åŠ å…¥ methodA çš„äº‹åŠ¡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Transactional\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epropagation\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ePropagation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eREQUIRED\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003emethodB\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ“ä½œ 2\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¦‚æœ methodB æŠ›å‡ºå¼‚å¸¸ï¼ŒmethodA å’Œ methodB çš„æ“ä½œéƒ½ä¼šå›æ»šã€‚\u003c/p\u003e","title":"Spring äº‹åŠ¡ä¼ æ’­æœºåˆ¶ä¸å¤±æ•ˆåœºæ™¯å®Œå…¨è§£æ"},{"content":"åœ¨ä¼ ç»Ÿ Java åº”ç”¨ä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°ä¸€æ—¦åœ¨ä»£ç ä¸­å†™æ­»ï¼Œå°±åªèƒ½é€šè¿‡é‡å¯åº”ç”¨æ¥è°ƒæ•´ã€‚å½“çº¿ä¸Šæµé‡çªå¢å¯¼è‡´çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯æ—¶ï¼Œå¼€å‘è€…åªèƒ½çœ¼çççœ‹ç€ç³»ç»Ÿå´©æºƒã€‚æœ¬é¡¹ç›®é€šè¿‡è‡ªå®šä¹‰ Spring Boot Starterï¼Œå®ç°äº†çº¿ç¨‹æ± å‚æ•°çš„åŠ¨æ€è°ƒæ•´ã€å®æ—¶ç›‘æ§å’Œå¯è§†åŒ–ç®¡ç†ã€‚\né¡¹ç›®äº®ç‚¹ æ·±å…¥ç ”ç©¶ Spring Boot Starter åŸç†ï¼Œåˆ©ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼ SDK åŸºäº Redisson Pub/Sub æœºåˆ¶å®ç°é…ç½®å®æ—¶æ¨é€ï¼Œæ— éœ€é‡å¯åº”ç”¨ è®¾è®¡ ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ä¸ŠæŠ¥ Redis å¼€å‘ Admin ç®¡ç†åå°ï¼Œæä¾›å¯è§†åŒ–çš„å‚æ•°é…ç½®å’Œç›‘æ§ç•Œé¢ é—®é¢˜èƒŒæ™¯ï¼šçº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹ åœ¨ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œçº¿ç¨‹æ± çš„åˆ›å»ºæ–¹å¼é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š\n1@Configuration 2public class ThreadPoolConfig { 3 @Bean 4 public ThreadPoolExecutor bizThreadPool() { 5 return new ThreadPoolExecutor( 6 10, // æ ¸å¿ƒçº¿ç¨‹æ•° 7 20, // æœ€å¤§çº¿ç¨‹æ•° 8 60, TimeUnit.SECONDS, 9 new LinkedBlockingQueue\u0026lt;\u0026gt;(100) 10 ); 11 } 12} è¿™ç§ç¡¬ç¼–ç æ–¹å¼æœ‰ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\nå‚æ•°è°ƒæ•´éœ€è¦é‡å¯ï¼š å½“å‘ç°çº¿ç¨‹æ± é…ç½®ä¸åˆç†æ—¶ï¼Œå¿…é¡»ä¿®æ”¹ä»£ç ã€é‡æ–°æ‰“åŒ…ã€é‡å¯åº”ç”¨ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé‡å¯æ„å‘³ç€æœåŠ¡ä¸­æ–­ã€‚\nç¼ºä¹ç›‘æ§æ‰‹æ®µï¼š æ— æ³•å®æ—¶æŸ¥çœ‹çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ï¼ˆæ´»è·ƒçº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ï¼‰ï¼Œåªèƒ½ç­‰åˆ°å‡ºé—®é¢˜åé€šè¿‡æ—¥å¿—æ’æŸ¥ã€‚\né…ç½®åˆ†æ•£ç®¡ç†ï¼š ä¸åŒæœåŠ¡çš„çº¿ç¨‹æ± é…ç½®æ•£è½åœ¨å„è‡ªçš„ä»£ç ä¸­ï¼Œç¼ºä¹ç»Ÿä¸€çš„ç®¡ç†å¹³å°ã€‚\nè¿™äº›ç—›ç‚¹å€’é€¼æˆ‘ä»¬å¿…é¡»è®¾è®¡ä¸€å¥—åŠ¨æ€çº¿ç¨‹æ± ç®¡ç†æ–¹æ¡ˆã€‚\næ¶æ„è®¾è®¡ï¼šé›¶ä¾µå…¥å¼ SDK æ ¸å¿ƒè®¾è®¡æ€è·¯æ˜¯ï¼šé€šè¿‡ Spring Boot Starter æœºåˆ¶ï¼Œè®©ä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥åœ°æ¥å…¥åŠ¨æ€çº¿ç¨‹æ± èƒ½åŠ›ã€‚å¼€å‘è€…åªéœ€è¦å¼•å…¥ä¾èµ–ï¼Œçº¿ç¨‹æ± å°±è‡ªåŠ¨å…·å¤‡äº†åŠ¨æ€è°ƒæ•´å’Œç›‘æ§èƒ½åŠ›ã€‚\næŠ€æœ¯é€‰å‹ï¼š\nBeanPostProcessorï¼š æ‹¦æˆª Spring å®¹å™¨ä¸­çš„ ThreadPoolExecutor Beanï¼Œæ›¿æ¢ä¸ºå¯åŠ¨æ€è°ƒæ•´çš„ä»£ç†å¯¹è±¡ Redisson Pub/Subï¼š å®ç°é…ç½®ä¸­å¿ƒåˆ°åº”ç”¨å®ä¾‹çš„å®æ—¶æ¨é€ å®šæ—¶ä»»åŠ¡ï¼š æ¯ 20 ç§’é‡‡é›†ä¸€æ¬¡çº¿ç¨‹æ± æŒ‡æ ‡ï¼Œä¸ŠæŠ¥åˆ° Redis Admin åå°ï¼š æä¾› Web ç•Œé¢ï¼Œç®¡ç†æ‰€æœ‰æœåŠ¡çš„çº¿ç¨‹æ± é…ç½® æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š\n1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” é…ç½®å˜æ›´ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2â”‚ Admin åå° â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\u0026gt; â”‚ Redis â”‚ 3â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 4 â”‚ 5 â”‚ Pub/Sub æ¨é€ 6 â†“ 7 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 8 â”‚ åº”ç”¨å®ä¾‹ A/B/C â”‚ 9 â”‚ (SDK è‡ªåŠ¨æ¥å…¥) â”‚ 10 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 11 â”‚ 12 â”‚ å®šæ—¶ä¸ŠæŠ¥æŒ‡æ ‡ 13 â†“ 14 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 15 â”‚ Redis â”‚ 16 â”‚ (ç›‘æ§æ•°æ®å­˜å‚¨) â”‚ 17 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒå®ç°ï¼šBeanPostProcessor æ‹¦æˆªä¸æ›¿æ¢ Spring Boot Starter çš„æ ¸å¿ƒæ˜¯è‡ªåŠ¨è£…é…æœºåˆ¶ã€‚æˆ‘ä»¬é€šè¿‡ spring.factories æ–‡ä»¶å£°æ˜è‡ªåŠ¨é…ç½®ç±»ï¼š\n1# META-INF/spring.factories 2org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ 3com.example.threadpool.autoconfigure.ThreadPoolAutoConfiguration åœ¨è‡ªåŠ¨é…ç½®ç±»ä¸­ï¼Œæ³¨å†Œ BeanPostProcessorï¼š\n1@Configuration 2public class ThreadPoolAutoConfiguration { 3 4 @Bean 5 public ThreadPoolBeanPostProcessor threadPoolBeanPostProcessor() { 6 return new ThreadPoolBeanPostProcessor(); 7 } 8} BeanPostProcessor ä¼šåœ¨ Spring å®¹å™¨åˆå§‹åŒ–æ¯ä¸ª Bean åæ‰§è¡Œå›è°ƒï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ‹¦æˆª ThreadPoolExecutorï¼š\n1public class ThreadPoolBeanPostProcessor implements BeanPostProcessor { 2 3 @Override 4 public Object postProcessAfterInitialization(Object bean, String beanName) { 5 if (bean instanceof ThreadPoolExecutor) { 6 ThreadPoolExecutor executor = (ThreadPoolExecutor) bean; 7 // å°†åŸå§‹çº¿ç¨‹æ± åŒ…è£…ä¸ºåŠ¨æ€çº¿ç¨‹æ±  8 return new DynamicThreadPoolExecutor(executor, beanName); 9 } 10 return bean; 11 } 12} DynamicThreadPoolExecutor æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„çº¿ç¨‹æ± åŒ…è£…ç±»ï¼Œå®ƒæŒæœ‰åŸå§‹ ThreadPoolExecutor çš„å¼•ç”¨ï¼Œå¹¶æä¾›åŠ¨æ€è°ƒæ•´èƒ½åŠ›ï¼š\n1public class DynamicThreadPoolExecutor extends ThreadPoolExecutor { 2 3 private final String poolName; 4 5 public void updateConfig(ThreadPoolConfig config) { 6 // åŠ¨æ€è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•° 7 this.setCorePoolSize(config.getCorePoolSize()); 8 // åŠ¨æ€è°ƒæ•´æœ€å¤§çº¿ç¨‹æ•° 9 this.setMaximumPoolSize(config.getMaxPoolSize()); 10 // åŠ¨æ€è°ƒæ•´é˜Ÿåˆ—å®¹é‡ï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰ 11 this.setQueue(new ResizableLinkedBlockingQueue\u0026lt;\u0026gt;(config.getQueueCapacity())); 12 } 13} æ¶æ„æ€è€ƒï¼š BeanPostProcessor æ˜¯ Spring æ¡†æ¶çš„æ‰©å±•ç‚¹ä¹‹ä¸€ï¼Œå¾ˆå¤šä¸­é—´ä»¶ï¼ˆå¦‚ MyBatisã€Dubboï¼‰éƒ½é€šè¿‡å®ƒå®ç°é›¶ä¾µå…¥å¼æ¥å…¥ã€‚ç†è§£è¿™ä¸ªæœºåˆ¶ï¼Œå°±èƒ½è®¾è®¡å‡ºå¯¹ä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥çš„åŸºç¡€ç»„ä»¶ã€‚\nåŠ¨æ€å‚æ•°è°ƒæ•´ï¼šRedisson Pub/Sub å®æ—¶æ¨é€ å½“ç®¡ç†å‘˜åœ¨ Admin åå°ä¿®æ”¹çº¿ç¨‹æ± é…ç½®åï¼Œå¦‚ä½•å®æ—¶é€šçŸ¥åˆ°æ‰€æœ‰åº”ç”¨å®ä¾‹ï¼Ÿæˆ‘ä»¬ä½¿ç”¨ Redisson çš„ Pub/Sub æœºåˆ¶ã€‚\nå‘å¸ƒç«¯ï¼ˆAdmin åå°ï¼‰ï¼š\n1@Service 2public class ThreadPoolConfigService { 3 4 @Autowired 5 private RedissonClient redisson; 6 7 public void updateConfig(String appName, String poolName, ThreadPoolConfig config) { 8 // ä¿å­˜é…ç½®åˆ° Redis 9 String key = \u0026#34;threadpool:config:\u0026#34; + appName + \u0026#34;:\u0026#34; + poolName; 10 redisson.getBucket(key).set(config); 11 12 // å‘å¸ƒé…ç½®å˜æ›´æ¶ˆæ¯ 13 RTopic topic = redisson.getTopic(\u0026#34;threadpool:config:update\u0026#34;); 14 topic.publish(new ConfigUpdateMessage(appName, poolName, config)); 15 } 16} è®¢é˜…ç«¯ï¼ˆåº”ç”¨å®ä¾‹ï¼‰ï¼š\n1@Component 2public class ThreadPoolConfigListener implements ApplicationListener\u0026lt;ContextRefreshedEvent\u0026gt; { 3 4 @Autowired 5 private RedissonClient redisson; 6 7 @Autowired 8 private Map\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; threadPoolMap; 9 10 @Override 11 public void onApplicationEvent(ContextRefreshedEvent event) { 12 // è®¢é˜…é…ç½®å˜æ›´æ¶ˆæ¯ 13 RTopic topic = redisson.getTopic(\u0026#34;threadpool:config:update\u0026#34;); 14 topic.addListener(ConfigUpdateMessage.class, (channel, msg) -\u0026gt; { 15 // åªå¤„ç†æœ¬åº”ç”¨çš„é…ç½® 16 if (!msg.getAppName().equals(appName)) { 17 return; 18 } 19 // åŠ¨æ€æ›´æ–°çº¿ç¨‹æ± é…ç½® 20 DynamicThreadPoolExecutor executor = threadPoolMap.get(msg.getPoolName()); 21 if (executor != null) { 22 executor.updateConfig(msg.getConfig()); 23 log.info(\u0026#34;çº¿ç¨‹æ±  {} é…ç½®å·²æ›´æ–°: {}\u0026#34;, msg.getPoolName(), msg.getConfig()); 24 } 25 }); 26 } 27} è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šé…ç½®å˜æ›´å¯ä»¥åœ¨ç§’çº§å†…æ¨é€åˆ°æ‰€æœ‰å®ä¾‹ï¼Œæ— éœ€é‡å¯åº”ç”¨ã€‚å³ä½¿æœ‰ä¸Šç™¾ä¸ªå®ä¾‹ï¼Œä¹Ÿèƒ½ä¿è¯é…ç½®çš„ä¸€è‡´æ€§ã€‚\né¿å‘æç¤ºï¼š Redisson çš„ Pub/Sub æ˜¯åŸºäº Redis çš„å‘å¸ƒè®¢é˜…æœºåˆ¶ï¼Œæ¶ˆæ¯ä¸ä¼šæŒä¹…åŒ–ã€‚å¦‚æœåº”ç”¨å®ä¾‹åœ¨é…ç½®å˜æ›´æ—¶å¤„äºç¦»çº¿çŠ¶æ€ï¼Œé‡æ–°ä¸Šçº¿åéœ€è¦ä¸»åŠ¨ä» Redis æ‹‰å–æœ€æ–°é…ç½®ã€‚\nç›‘æ§æŒ‡æ ‡é‡‡é›†ï¼šå®šæ—¶ä»»åŠ¡ä¸ŠæŠ¥ åŠ¨æ€è°ƒæ•´åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œæ›´é‡è¦çš„æ˜¯å®æ—¶ç›‘æ§çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ã€‚æˆ‘ä»¬è®¾è®¡äº† ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œæ¯ 20 ç§’é‡‡é›†ä¸€æ¬¡æŒ‡æ ‡ï¼š\n1@Component 2public class ThreadPoolDataReportJob { 3 4 @Autowired 5 private Map\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; threadPoolMap; 6 7 @Autowired 8 private RedissonClient redisson; 9 10 @Scheduled(fixedRate = 20000) 11 public void reportMetrics() { 12 for (Map.Entry\u0026lt;String, DynamicThreadPoolExecutor\u0026gt; entry : threadPoolMap.entrySet()) { 13 String poolName = entry.getKey(); 14 ThreadPoolExecutor executor = entry.getValue(); 15 16 // é‡‡é›†æŒ‡æ ‡ 17 ThreadPoolMetrics metrics = ThreadPoolMetrics.builder() 18 .poolName(poolName) 19 .corePoolSize(executor.getCorePoolSize()) 20 .maximumPoolSize(executor.getMaximumPoolSize()) 21 .activeCount(executor.getActiveCount()) // æ´»è·ƒçº¿ç¨‹æ•° 22 .queueSize(executor.getQueue().size()) // é˜Ÿåˆ—é•¿åº¦ 23 .completedTaskCount(executor.getCompletedTaskCount()) 24 .rejectedCount(getRejectedCount(executor)) // æ‹’ç»æ¬¡æ•° 25 .timestamp(System.currentTimeMillis()) 26 .build(); 27 28 // ä¸ŠæŠ¥åˆ° Redisï¼ˆä½¿ç”¨ List ç»“æ„ï¼Œä¿ç•™æœ€è¿‘ 100 æ¡è®°å½•ï¼‰ 29 String key = \u0026#34;threadpool:metrics:\u0026#34; + appName + \u0026#34;:\u0026#34; + poolName; 30 RList\u0026lt;ThreadPoolMetrics\u0026gt; list = redisson.getList(key); 31 list.add(metrics); 32 if (list.size() \u0026gt; 100) { 33 list.remove(0); // ç§»é™¤æœ€æ—§çš„è®°å½• 34 } 35 } 36 } 37} ä¸ºäº†ç»Ÿè®¡æ‹’ç»æ¬¡æ•°ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ RejectedExecutionHandlerï¼š\n1public class MonitorableRejectedHandler implements RejectedExecutionHandler { 2 3 private final AtomicLong rejectedCount = new AtomicLong(0); 4 5 @Override 6 public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) { 7 rejectedCount.incrementAndGet(); 8 // é™çº§ç­–ç•¥ï¼šè°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ 9 new ThreadPoolExecutor.CallerRunsPolicy().rejectedExecution(r, executor); 10 } 11 12 public long getRejectedCount() { 13 return rejectedCount.get(); 14 } 15} å¯è§†åŒ–ç®¡ç†ï¼šAdmin åå°è®¾è®¡ Admin åå°æä¾›ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š\n1. é…ç½®ç®¡ç†ç•Œé¢\nå±•ç¤ºæ‰€æœ‰åº”ç”¨çš„çº¿ç¨‹æ± åˆ—è¡¨ï¼Œæ”¯æŒåœ¨çº¿ä¿®æ”¹å‚æ•°ï¼š\n1@RestController 2@RequestMapping(\u0026#34;/api/threadpool\u0026#34;) 3public class ThreadPoolController { 4 5 @GetMapping(\u0026#34;/list\u0026#34;) 6 public List\u0026lt;ThreadPoolInfo\u0026gt; listThreadPools(@RequestParam String appName) { 7 // ä» Redis æŸ¥è¯¢æ‰€æœ‰çº¿ç¨‹æ± é…ç½® 8 String pattern = \u0026#34;threadpool:config:\u0026#34; + appName + \u0026#34;:*\u0026#34;; 9 return redisson.getKeys().getKeysByPattern(pattern).stream() 10 .map(key -\u0026gt; redisson.getBucket(key).get()) 11 .collect(Collectors.toList()); 12 } 13 14 @PostMapping(\u0026#34;/update\u0026#34;) 15 public void updateConfig(@RequestBody ThreadPoolUpdateRequest request) { 16 threadPoolConfigService.updateConfig( 17 request.getAppName(), 18 request.getPoolName(), 19 request.getConfig() 20 ); 21 } 22} 2. ç›‘æ§å¤§ç›˜\nå®æ—¶å±•ç¤ºçº¿ç¨‹æ± çš„è¿è¡ŒæŒ‡æ ‡ï¼Œæ”¯æŒå›¾è¡¨å¯è§†åŒ–ï¼š\næ´»è·ƒçº¿ç¨‹æ•°è¶‹åŠ¿å›¾ é˜Ÿåˆ—é•¿åº¦å˜åŒ–æ›²çº¿ ä»»åŠ¡æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ ä»»åŠ¡å®Œæˆé€Ÿç‡ å‰ç«¯ä½¿ç”¨ ECharts æ¸²æŸ“å›¾è¡¨ï¼Œæ¯ 5 ç§’è½®è¯¢ä¸€æ¬¡åç«¯æ¥å£è·å–æœ€æ–°æ•°æ®ã€‚\næ¶æ„æ€è€ƒï¼š ç›‘æ§æ•°æ®çš„å­˜å‚¨æ–¹å¼æœ‰å¤šç§é€‰æ‹©ï¼šRedisã€InfluxDBã€Prometheusã€‚æˆ‘ä»¬é€‰æ‹© Redis æ˜¯å› ä¸ºå®ƒéƒ¨ç½²ç®€å•ï¼Œä¸”æˆ‘ä»¬çš„ç›‘æ§æ•°æ®é‡ä¸å¤§ï¼ˆæ¯ä¸ªçº¿ç¨‹æ± æ¯ 20 ç§’ä¸€æ¡è®°å½•ï¼‰ã€‚å¦‚æœéœ€è¦é•¿æœŸå­˜å‚¨å’Œå¤æ‚æŸ¥è¯¢ï¼Œå»ºè®®ä½¿ç”¨æ—¶åºæ•°æ®åº“ã€‚\né¡¹ç›®æˆæœä¸åæ€ è¿™ä¸ª SDK åœ¨å…¬å¸å†…éƒ¨æ¨å¹¿åï¼Œæ¥å…¥äº† 20+ ä¸ªæœåŠ¡ï¼Œç´¯è®¡ç®¡ç† 50+ ä¸ªçº¿ç¨‹æ± ã€‚æ ¸å¿ƒæ”¶ç›Šï¼š\nçº¿ä¸Šé—®é¢˜å“åº”æ—¶é—´ä»\u0026quot;å°æ—¶çº§\u0026quot;é™ä½åˆ°\u0026quot;åˆ†é’Ÿçº§\u0026quot;ï¼ˆæ— éœ€é‡å¯è°ƒæ•´å‚æ•°ï¼‰ é€šè¿‡ç›‘æ§å¤§ç›˜æå‰å‘ç° 3 æ¬¡æ½œåœ¨çš„çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯é—®é¢˜ ç»Ÿä¸€çš„é…ç½®ç®¡ç†é™ä½äº†è¿ç»´æˆæœ¬ å¦‚æœé‡æ–°è®¾è®¡ï¼Œæˆ‘ä¼šè€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–ï¼š\næ”¯æŒæ›´å¤šçº¿ç¨‹æ± ç±»å‹ï¼š ç›®å‰åªæ”¯æŒ ThreadPoolExecutorï¼Œæœªæ¥å¯ä»¥æ‰©å±•åˆ° ScheduledThreadPoolExecutorã€ForkJoinPool ç­‰ã€‚\nå‘Šè­¦æœºåˆ¶ï¼š å½“é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼æˆ–æ‹’ç»æ¬¡æ•°æ¿€å¢æ—¶ï¼Œè‡ªåŠ¨å‘é€é’‰é’‰/é‚®ä»¶å‘Šè­¦ã€‚\nå†å²é…ç½®å›æ»šï¼š è®°å½•æ¯æ¬¡é…ç½®å˜æ›´çš„å†å²ï¼Œæ”¯æŒä¸€é”®å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚\nè¿™ä¸ªé¡¹ç›®æœ€å¤§çš„æ”¶è·æ˜¯ï¼šç†è§£äº† Spring Boot Starter çš„è®¾è®¡å“²å­¦â€”â€”é€šè¿‡çº¦å®šå’Œè‡ªåŠ¨åŒ–ï¼Œè®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯åŸºç¡€è®¾æ–½çš„æ­å»ºã€‚è¿™ç§\u0026quot;é›¶ä¾µå…¥å¼\u0026quot;çš„è®¾è®¡æ€æƒ³ï¼Œå€¼å¾—åœ¨å…¶ä»–åŸºç¡€ç»„ä»¶ä¸­æ¨å¹¿ã€‚\n","permalink":"http://localhost:1313/projects/thread-pool-sdk/","summary":"\u003cp\u003eåœ¨ä¼ ç»Ÿ Java åº”ç”¨ä¸­ï¼Œçº¿ç¨‹æ± å‚æ•°ä¸€æ—¦åœ¨ä»£ç ä¸­å†™æ­»ï¼Œå°±åªèƒ½é€šè¿‡é‡å¯åº”ç”¨æ¥è°ƒæ•´ã€‚å½“çº¿ä¸Šæµé‡çªå¢å¯¼è‡´çº¿ç¨‹æ± é˜Ÿåˆ—å †ç§¯æ—¶ï¼Œå¼€å‘è€…åªèƒ½çœ¼çççœ‹ç€ç³»ç»Ÿå´©æºƒã€‚æœ¬é¡¹ç›®é€šè¿‡è‡ªå®šä¹‰ Spring Boot Starterï¼Œå®ç°äº†çº¿ç¨‹æ± å‚æ•°çš„åŠ¨æ€è°ƒæ•´ã€å®æ—¶ç›‘æ§å’Œå¯è§†åŒ–ç®¡ç†ã€‚\u003c/p\u003e\n\u003ch3 id=\"é¡¹ç›®äº®ç‚¹\"\u003eé¡¹ç›®äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æ·±å…¥ç ”ç©¶ Spring Boot Starter åŸç†ï¼Œåˆ©ç”¨ BeanPostProcessor å®ç°é›¶ä¾µå…¥å¼ SDK\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e åŸºäº Redisson Pub/Sub æœºåˆ¶å®ç°é…ç½®å®æ—¶æ¨é€ï¼Œæ— éœ€é‡å¯åº”ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è®¾è®¡ ThreadPoolDataReportJob å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨é‡‡é›†çº¿ç¨‹æ± æŒ‡æ ‡ä¸ŠæŠ¥ Redis\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å¼€å‘ Admin ç®¡ç†åå°ï¼Œæä¾›å¯è§†åŒ–çš„å‚æ•°é…ç½®å’Œç›‘æ§ç•Œé¢\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"é—®é¢˜èƒŒæ™¯çº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹\"\u003eé—®é¢˜èƒŒæ™¯ï¼šçº¿ç¨‹æ± å‚æ•°å›ºåŒ–çš„ç—›ç‚¹\u003c/h2\u003e\n\u003cp\u003eåœ¨ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œçº¿ç¨‹æ± çš„åˆ›å»ºæ–¹å¼é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eThreadPoolConfig\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Bean\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ebizThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ ¸å¿ƒçº¿ç¨‹æ•°\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æœ€å¤§çº¿ç¨‹æ•°\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"n\"\u003e60\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eLinkedBlockingQueue\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™ç§ç¡¬ç¼–ç æ–¹å¼æœ‰ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\u003c/p\u003e","title":"åŠ¨æ€çº¿ç¨‹æ±  SDKï¼šä»é›¶å®ç° Spring Boot Starter"},{"content":"AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡ AOPï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰ä»ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ä½† AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæœ¬æ–‡æ·±å…¥å‰–æ Spring AOP çš„åº•å±‚æœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ AOP çš„æ ¸å¿ƒæ¦‚å¿µï¼šåˆ‡é¢ã€åˆ‡ç‚¹ã€é€šçŸ¥ã€è¿æ¥ç‚¹ æŒæ¡ JDK åŠ¨æ€ä»£ç†ä¸ CGLIB ä»£ç†çš„å®ç°åŸç† å­¦ä¼š ProxyFactory çš„åˆ›å»ºæµç¨‹ äº†è§£åˆ‡é¢æ‰§è¡Œé¡ºåºä¸è´£ä»»é“¾æ¨¡å¼ AOP æ ¸å¿ƒæ¦‚å¿µ åˆ‡é¢ï¼ˆAspectï¼‰\næ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–ï¼Œæ¯”å¦‚æ—¥å¿—åˆ‡é¢ã€äº‹åŠ¡åˆ‡é¢ã€‚\n1@Aspect 2@Component 3public class LogAspect { 4 5 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 6 public void logBefore(JoinPoint joinPoint) { 7 log.info(\u0026#34;æ–¹æ³•æ‰§è¡Œå‰: {}\u0026#34;, joinPoint.getSignature().getName()); 8 } 9} åˆ‡ç‚¹ï¼ˆPointcutï¼‰\nå®šä¹‰åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨é€šçŸ¥ï¼Œé€šè¿‡è¡¨è¾¾å¼åŒ¹é…ã€‚\n1@Pointcut(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 2public void serviceLayer() {} é€šçŸ¥ï¼ˆAdviceï¼‰\nåœ¨åˆ‡ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼Œåˆ†ä¸ºäº”ç§ç±»å‹ï¼š\n@Beforeï¼šå‰ç½®é€šçŸ¥ @Afterï¼šåç½®é€šçŸ¥ @AfterReturningï¼šè¿”å›é€šçŸ¥ @AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥ @Aroundï¼šç¯ç»•é€šçŸ¥ è¿æ¥ç‚¹ï¼ˆJoinPointï¼‰\nç¨‹åºæ‰§è¡Œçš„æŸä¸ªç‚¹ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºã€‚\nJDK åŠ¨æ€ä»£ç† vs CGLIB ä»£ç† Spring AOP ä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼š\nJDK åŠ¨æ€ä»£ç†\nåŸºäºæ¥å£çš„ä»£ç†ï¼Œè¦æ±‚ç›®æ ‡ç±»å®ç°æ¥å£ã€‚\n1public interface UserService { 2 void addUser(User user); 3} 4 5@Service 6public class UserServiceImpl implements UserService { 7 @Override 8 public void addUser(User user) { 9 // ä¸šåŠ¡é€»è¾‘ 10 } 11} JDK åŠ¨æ€ä»£ç†çš„å®ç°ï¼š\n1public class JdkProxyFactory implements InvocationHandler { 2 3 private Object target; 4 5 public Object createProxy(Object target) { 6 this.target = target; 7 return Proxy.newProxyInstance( 8 target.getClass().getClassLoader(), 9 target.getClass().getInterfaces(), 10 this 11 ); 12 } 13 14 @Override 15 public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { 16 System.out.println(\u0026#34;Before method\u0026#34;); 17 Object result = method.invoke(target, args); 18 System.out.println(\u0026#34;After method\u0026#34;); 19 return result; 20 } 21} CGLIB ä»£ç†\nåŸºäºç»§æ‰¿çš„ä»£ç†ï¼Œé€šè¿‡ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»å®ç°ã€‚\n1@Service 2public class UserService { // æ²¡æœ‰å®ç°æ¥å£ 3 public void addUser(User user) { 4 // ä¸šåŠ¡é€»è¾‘ 5 } 6} CGLIB ä»£ç†çš„å®ç°ï¼š\n1public class CglibProxyFactory implements MethodInterceptor { 2 3 public Object createProxy(Object target) { 4 Enhancer enhancer = new Enhancer(); 5 enhancer.setSuperclass(target.getClass()); 6 enhancer.setCallback(this); 7 return enhancer.create(); 8 } 9 10 @Override 11 public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable { 12 System.out.println(\u0026#34;Before method\u0026#34;); 13 Object result = proxy.invokeSuper(obj, args); 14 System.out.println(\u0026#34;After method\u0026#34;); 15 return result; 16 } 17} é€‰æ‹©è§„åˆ™\nå¦‚æœç›®æ ‡ç±»å®ç°äº†æ¥å£ï¼Œé»˜è®¤ä½¿ç”¨ JDK åŠ¨æ€ä»£ç† å¦‚æœç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œä½¿ç”¨ CGLIB ä»£ç† å¯ä»¥é€šè¿‡é…ç½®å¼ºåˆ¶ä½¿ç”¨ CGLIBï¼š@EnableAspectJAutoProxy(proxyTargetClass = true) æ¶æ„æ€è€ƒï¼š JDK åŠ¨æ€ä»£ç†å’Œ CGLIB ä»£ç†ä½“ç°äº†\u0026quot;ç­–ç•¥æ¨¡å¼\u0026quot;çš„æ€æƒ³ã€‚Spring æ ¹æ®ç›®æ ‡ç±»çš„ç‰¹å¾ï¼Œé€‰æ‹©åˆé€‚çš„ä»£ç†ç­–ç•¥ã€‚è¿™ç§è®¾è®¡è®©æ¡†æ¶æ›´åŠ çµæ´»ï¼Œèƒ½å¤Ÿé€‚åº”ä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚\nProxyFactory åˆ›å»ºæµç¨‹ Spring AOP é€šè¿‡ ProxyFactory åˆ›å»ºä»£ç†å¯¹è±¡ï¼š\n1@Component 2public class AopProxyCreator { 3 4 public Object createProxy(Object target) { 5 ProxyFactory proxyFactory = new ProxyFactory(); 6 proxyFactory.setTarget(target); 7 8 // æ·»åŠ é€šçŸ¥ 9 proxyFactory.addAdvice(new MethodBeforeAdvice() { 10 @Override 11 public void before(Method method, Object[] args, Object target) { 12 System.out.println(\u0026#34;Before: \u0026#34; + method.getName()); 13 } 14 }); 15 16 return proxyFactory.getProxy(); 17 } 18} ProxyFactory çš„åˆ›å»ºæµç¨‹ï¼š\nåˆ›å»º AopProxyFactoryï¼ˆé»˜è®¤æ˜¯ DefaultAopProxyFactoryï¼‰ æ ¹æ®ç›®æ ‡ç±»é€‰æ‹©ä»£ç†æ–¹å¼ï¼ˆJDK æˆ– CGLIBï¼‰ åˆ›å»º AopProxy å¯¹è±¡ï¼ˆJdkDynamicAopProxy æˆ– CglibAopProxyï¼‰ ç”Ÿæˆä»£ç†å¯¹è±¡ åˆ‡é¢æ‰§è¡Œé¡ºåº å½“æœ‰å¤šä¸ªåˆ‡é¢æ—¶ï¼Œæ‰§è¡Œé¡ºåºç”± @Order æ³¨è§£æ§åˆ¶ï¼š\n1@Aspect 2@Component 3@Order(1) 4public class LogAspect { 5 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 6 public void logBefore() { 7 System.out.println(\u0026#34;Log Before\u0026#34;); 8 } 9} 10 11@Aspect 12@Component 13@Order(2) 14public class TransactionAspect { 15 @Before(\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;) 16 public void transactionBefore() { 17 System.out.println(\u0026#34;Transaction Before\u0026#34;); 18 } 19} æ‰§è¡Œé¡ºåºï¼š\n1Log Before 2Transaction Before 3ç›®æ ‡æ–¹æ³•æ‰§è¡Œ 4Transaction After 5Log After è¿™æ˜¯è´£ä»»é“¾æ¨¡å¼çš„å…¸å‹åº”ç”¨ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šè‡ªå®šä¹‰æ³¨è§£å®ç°æƒé™æ ¡éªŒ 1@Target(ElementType.METHOD) 2@Retention(RetentionPolicy.RUNTIME) 3public @interface RequirePermission { 4 String value(); 5} 6 7@Aspect 8@Component 9public class PermissionAspect { 10 11 @Around(\u0026#34;@annotation(requirePermission)\u0026#34;) 12 public Object checkPermission(ProceedingJoinPoint joinPoint, RequirePermission requirePermission) throws Throwable { 13 String permission = requirePermission.value(); 14 User user = UserContext.getUser(); 15 16 if (!user.hasPermission(permission)) { 17 throw new PermissionDeniedException(\u0026#34;æ— æƒé™è®¿é—®\u0026#34;); 18 } 19 20 return joinPoint.proceed(); 21 } 22} 23 24// ä½¿ç”¨ 25@Service 26public class UserService { 27 28 @RequirePermission(\u0026#34;user:delete\u0026#34;) 29 public void deleteUser(Long userId) { 30 // ä¸šåŠ¡é€»è¾‘ 31 } 32} æ€»ç»“ä¸æ€è€ƒ Spring AOP çš„æ ¸å¿ƒæ˜¯åŠ¨æ€ä»£ç†ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡åœ¨ç›®æ ‡æ–¹æ³•å‰åæ’å…¥æ¨ªåˆ‡é€»è¾‘ã€‚\nJDK åŠ¨æ€ä»£ç†åŸºäºæ¥å£ï¼ŒCGLIB ä»£ç†åŸºäºç»§æ‰¿ ProxyFactory è´Ÿè´£åˆ›å»ºä»£ç†å¯¹è±¡ å¤šä¸ªåˆ‡é¢é€šè¿‡è´£ä»»é“¾æ¨¡å¼ä¸²è”æ‰§è¡Œ ç†è§£ AOP çš„å®ç°åŸç†ï¼Œæ‰èƒ½æ›´å¥½åœ°ä½¿ç”¨å®ƒï¼Œé¿å…è¸©å‘ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹æ—¶ï¼Œä¸å¦¨è¯•è¯• AOPï¼Œè®©ä»£ç æ›´åŠ ä¼˜é›…ã€‚\n","permalink":"http://localhost:1313/posts/2024/04/spring-aop-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eAOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡ AOPï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰ä»ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ä½† AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæœ¬æ–‡æ·±å…¥å‰–æ Spring AOP çš„åº•å±‚æœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ AOP çš„æ ¸å¿ƒæ¦‚å¿µï¼šåˆ‡é¢ã€åˆ‡ç‚¹ã€é€šçŸ¥ã€è¿æ¥ç‚¹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ JDK åŠ¨æ€ä»£ç†ä¸ CGLIB ä»£ç†çš„å®ç°åŸç†\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼š ProxyFactory çš„åˆ›å»ºæµç¨‹\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£åˆ‡é¢æ‰§è¡Œé¡ºåºä¸è´£ä»»é“¾æ¨¡å¼\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"aop-æ ¸å¿ƒæ¦‚å¿µ\"\u003eAOP æ ¸å¿ƒæ¦‚å¿µ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ‡é¢ï¼ˆAspectï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–ï¼Œæ¯”å¦‚æ—¥å¿—åˆ‡é¢ã€äº‹åŠ¡åˆ‡é¢ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Aspect\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Component\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eLogAspect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Before\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003elogBefore\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eJoinPoint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ejoinPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;æ–¹æ³•æ‰§è¡Œå‰: {}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ejoinPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetSignature\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003egetName\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ‡ç‚¹ï¼ˆPointcutï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå®šä¹‰åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨é€šçŸ¥ï¼Œé€šè¿‡è¡¨è¾¾å¼åŒ¹é…ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@Pointcut\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;execution(* com.example.service.*.*(..))\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eserviceLayer\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eé€šçŸ¥ï¼ˆAdviceï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨åˆ‡ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼Œåˆ†ä¸ºäº”ç§ç±»å‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e@Beforeï¼šå‰ç½®é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@Afterï¼šåç½®é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@AfterReturningï¼šè¿”å›é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥\u003c/li\u003e\n\u003cli\u003e@Aroundï¼šç¯ç»•é€šçŸ¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eè¿æ¥ç‚¹ï¼ˆJoinPointï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç¨‹åºæ‰§è¡Œçš„æŸä¸ªç‚¹ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"jdk-åŠ¨æ€ä»£ç†-vs-cglib-ä»£ç†\"\u003eJDK åŠ¨æ€ä»£ç† vs CGLIB ä»£ç†\u003c/h2\u003e\n\u003cp\u003eSpring AOP ä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼š\u003c/p\u003e","title":"Spring AOP åŸç†ä¸åŠ¨æ€ä»£ç†å®ç°æ·±åº¦è§£æ"},{"content":"åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªæ¥å£å¾€å¾€éœ€è¦è°ƒç”¨å¤šä¸ªä¸‹æ¸¸æœåŠ¡ã€‚å¦‚æœä¸²è¡Œè°ƒç”¨ï¼Œå“åº”æ—¶é—´ä¼šç´¯åŠ ï¼›å¦‚æœç”¨ä¼ ç»Ÿçš„ Futureï¼Œä»£ç ä¼šå˜å¾—å¤æ‚éš¾ç»´æŠ¤ã€‚CompletableFuture æä¾›äº†ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ¡ˆã€‚\næœ¬æ–‡äº®ç‚¹ æŒæ¡ CompletableFuture çš„é“¾å¼è°ƒç”¨ä¸ç»„åˆæ“ä½œ å­¦ä¼šå¼‚å¸¸å¤„ç†ä¸è¶…æ—¶æ§åˆ¶ ç†è§£ä¸çº¿ç¨‹æ± çš„é…åˆä½¿ç”¨ äº†è§£å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ ä¼ ç»Ÿ Future çš„ç—›ç‚¹ JDK 1.5 å¼•å…¥çš„ Future æ¥å£åªèƒ½é€šè¿‡ get() æ–¹æ³•é˜»å¡ç­‰å¾…ç»“æœï¼š\n1ExecutorService executor = Executors.newFixedThreadPool(10); 2 3Future\u0026lt;String\u0026gt; future = executor.submit(() -\u0026gt; { 4 Thread.sleep(1000); 5 return \u0026#34;Hello\u0026#34;; 6}); 7 8// é˜»å¡ç­‰å¾…ç»“æœ 9String result = future.get(); é—®é¢˜ï¼š\nget() ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ— æ³•å¼‚æ­¥å¤„ç†ç»“æœ æ— æ³•ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ å¼‚å¸¸å¤„ç†ä¸æ–¹ä¾¿ CompletableFuture è§£å†³äº†è¿™äº›é—®é¢˜ã€‚\nCompletableFuture åŸºç¡€ç”¨æ³• åˆ›å»º CompletableFuture\n1// æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨å®Œæˆ 2CompletableFuture\u0026lt;String\u0026gt; future = new CompletableFuture\u0026lt;\u0026gt;(); 3future.complete(\u0026#34;Hello\u0026#34;); 4 5// æ–¹å¼äºŒï¼šå¼‚æ­¥æ‰§è¡Œ 6CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 7 return \u0026#34;Hello\u0026#34;; 8}); 9 10// æ–¹å¼ä¸‰ï¼šæ— è¿”å›å€¼çš„å¼‚æ­¥æ‰§è¡Œ 11CompletableFuture\u0026lt;Void\u0026gt; future = CompletableFuture.runAsync(() -\u0026gt; { 12 System.out.println(\u0026#34;Hello\u0026#34;); 13}); è·å–ç»“æœ\n1// é˜»å¡ç­‰å¾…ï¼ˆä¸æ¨èï¼‰ 2String result = future.get(); 3 4// é˜»å¡ç­‰å¾…ï¼Œå¸¦è¶…æ—¶ 5String result = future.get(1, TimeUnit.SECONDS); 6 7// éé˜»å¡è·å–ï¼Œå¦‚æœæœªå®Œæˆè¿”å›é»˜è®¤å€¼ 8String result = future.getNow(\u0026#34;default\u0026#34;); 9 10// é˜»å¡ç­‰å¾…ï¼Œä¸æŠ›å‡ºå—æ£€å¼‚å¸¸ 11String result = future.join(); é“¾å¼è°ƒç”¨ï¼šä¼˜é›…çš„å¼‚æ­¥æµæ°´çº¿ thenApplyï¼šè½¬æ¢ç»“æœ\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenApply(s -\u0026gt; { 4 return s + \u0026#34; World\u0026#34;; 5}).thenApply(s -\u0026gt; { 6 return s.toUpperCase(); 7}); 8 9System.out.println(future.join()); // HELLO WORLD thenAcceptï¼šæ¶ˆè´¹ç»“æœ\n1CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenAccept(s -\u0026gt; { 4 System.out.println(s); // ä¸è¿”å›ç»“æœ 5}); thenRunï¼šæ‰§è¡Œåç»­æ“ä½œ\n1CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}).thenRun(() -\u0026gt; { 4 System.out.println(\u0026#34;Done\u0026#34;); // ä¸å…³å¿ƒå‰é¢çš„ç»“æœ 5}); thenComposeï¼šæ‰å¹³åŒ–åµŒå¥—çš„ CompletableFuture\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;user123\u0026#34;; 3}).thenCompose(userId -\u0026gt; { 4 // æ ¹æ® userId æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆè¿”å› CompletableFutureï¼‰ 5 return getUserInfo(userId); 6}); 7 8CompletableFuture\u0026lt;User\u0026gt; getUserInfo(String userId) { 9 return CompletableFuture.supplyAsync(() -\u0026gt; { 10 return userMapper.selectById(userId); 11 }); 12} æ¶æ„æ€è€ƒï¼š thenApply å’Œ thenCompose çš„åŒºåˆ«ç±»ä¼¼äº Stream çš„ map å’Œ flatMapã€‚thenApply ç”¨äºç®€å•çš„è½¬æ¢ï¼ŒthenCompose ç”¨äºæ‰å¹³åŒ–åµŒå¥—çš„å¼‚æ­¥æ“ä½œã€‚\nç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ thenCombineï¼šåˆå¹¶ä¸¤ä¸ªä»»åŠ¡çš„ç»“æœ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Hello\u0026#34;; 3}); 4 5CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; { 6 return \u0026#34;World\u0026#34;; 7}); 8 9CompletableFuture\u0026lt;String\u0026gt; result = future1.thenCombine(future2, (s1, s2) -\u0026gt; { 10 return s1 + \u0026#34; \u0026#34; + s2; 11}); 12 13System.out.println(result.join()); // Hello World allOfï¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task1\u0026#34;); 2CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task2\u0026#34;); 3CompletableFuture\u0026lt;String\u0026gt; future3 = CompletableFuture.supplyAsync(() -\u0026gt; \u0026#34;Task3\u0026#34;); 4 5CompletableFuture\u0026lt;Void\u0026gt; allFutures = CompletableFuture.allOf(future1, future2, future3); 6 7// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ 8allFutures.join(); 9 10// è·å–æ‰€æœ‰ç»“æœ 11List\u0026lt;String\u0026gt; results = Stream.of(future1, future2, future3) 12 .map(CompletableFuture::join) 13 .collect(Collectors.toList()); anyOfï¼šç­‰å¾…ä»»æ„ä¸€ä¸ªä»»åŠ¡å®Œæˆ\n1CompletableFuture\u0026lt;String\u0026gt; future1 = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(1000); 3 return \u0026#34;Task1\u0026#34;; 4}); 5 6CompletableFuture\u0026lt;String\u0026gt; future2 = CompletableFuture.supplyAsync(() -\u0026gt; { 7 Thread.sleep(500); 8 return \u0026#34;Task2\u0026#34;; 9}); 10 11CompletableFuture\u0026lt;Object\u0026gt; anyFuture = CompletableFuture.anyOf(future1, future2); 12 13System.out.println(anyFuture.join()); // Task2ï¼ˆå…ˆå®Œæˆçš„ï¼‰ å®æˆ˜æ¡ˆä¾‹ï¼šå¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡ å‡è®¾ä¸€ä¸ªå•†å“è¯¦æƒ…é¡µéœ€è¦è°ƒç”¨ä¸‰ä¸ªæœåŠ¡ï¼š\nå•†å“æœåŠ¡ï¼šæŸ¥è¯¢å•†å“ä¿¡æ¯ åº“å­˜æœåŠ¡ï¼šæŸ¥è¯¢åº“å­˜ è¯„è®ºæœåŠ¡ï¼šæŸ¥è¯¢è¯„è®º ä¸²è¡Œè°ƒç”¨ï¼ˆæ…¢ï¼‰\n1public ProductDetailDTO getProductDetail(Long productId) { 2 Product product = productService.getProduct(productId); // 100ms 3 Stock stock = stockService.getStock(productId); // 100ms 4 List\u0026lt;Comment\u0026gt; comments = commentService.getComments(productId); // 100ms 5 6 return ProductDetailDTO.builder() 7 .product(product) 8 .stock(stock) 9 .comments(comments) 10 .build(); 11} 12// æ€»è€—æ—¶ï¼š300ms å¹¶è¡Œè°ƒç”¨ï¼ˆå¿«ï¼‰\n1public ProductDetailDTO getProductDetail(Long productId) { 2 CompletableFuture\u0026lt;Product\u0026gt; productFuture = CompletableFuture.supplyAsync(() -\u0026gt; 3 productService.getProduct(productId) 4 ); 5 6 CompletableFuture\u0026lt;Stock\u0026gt; stockFuture = CompletableFuture.supplyAsync(() -\u0026gt; 7 stockService.getStock(productId) 8 ); 9 10 CompletableFuture\u0026lt;List\u0026lt;Comment\u0026gt;\u0026gt; commentsFuture = CompletableFuture.supplyAsync(() -\u0026gt; 11 commentService.getComments(productId) 12 ); 13 14 // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ 15 CompletableFuture.allOf(productFuture, stockFuture, commentsFuture).join(); 16 17 return ProductDetailDTO.builder() 18 .product(productFuture.join()) 19 .stock(stockFuture.join()) 20 .comments(commentsFuture.join()) 21 .build(); 22} 23// æ€»è€—æ—¶ï¼š100msï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰ æ€§èƒ½æå‡ï¼šä» 300ms é™ä½åˆ° 100msã€‚\nå¼‚å¸¸å¤„ç† exceptionallyï¼šæ•è·å¼‚å¸¸å¹¶è¿”å›é»˜è®¤å€¼\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 if (Math.random() \u0026gt; 0.5) { 3 throw new RuntimeException(\u0026#34;Error\u0026#34;); 4 } 5 return \u0026#34;Success\u0026#34;; 6}).exceptionally(ex -\u0026gt; { 7 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 8 return \u0026#34;Default\u0026#34;; 9}); handleï¼šåŒæ—¶å¤„ç†æ­£å¸¸ç»“æœå’Œå¼‚å¸¸\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 if (Math.random() \u0026gt; 0.5) { 3 throw new RuntimeException(\u0026#34;Error\u0026#34;); 4 } 5 return \u0026#34;Success\u0026#34;; 6}).handle((result, ex) -\u0026gt; { 7 if (ex != null) { 8 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 9 return \u0026#34;Default\u0026#34;; 10 } 11 return result; 12}); whenCompleteï¼šä¸æ”¹å˜ç»“æœï¼Œåªåšå‰¯ä½œç”¨æ“ä½œ\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 return \u0026#34;Success\u0026#34;; 3}).whenComplete((result, ex) -\u0026gt; { 4 if (ex != null) { 5 log.error(\u0026#34;å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); 6 } else { 7 log.info(\u0026#34;ç»“æœ: {}\u0026#34;, result); 8 } 9}); é¿å‘æç¤ºï¼š exceptionally å’Œ handle ä¼šæ”¹å˜ CompletableFuture çš„ç»“æœï¼Œè€Œ whenComplete ä¸ä¼šã€‚é€‰æ‹©å“ªä¸ªå–å†³äºä½ æ˜¯å¦éœ€è¦æ”¹å˜ç»“æœã€‚\nè¶…æ—¶æ§åˆ¶ JDK 9 å¼•å…¥äº†è¶…æ—¶æ§åˆ¶æ–¹æ³•ï¼š\n1CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(2000); 3 return \u0026#34;Success\u0026#34;; 4}).orTimeout(1, TimeUnit.SECONDS) // è¶…æ—¶æŠ›å‡º TimeoutException 5 .exceptionally(ex -\u0026gt; { 6 return \u0026#34;Timeout\u0026#34;; 7 }); JDK 8 å¯ä»¥é€šè¿‡ CompletableFuture.anyOf å®ç°ï¼š\n1CompletableFuture\u0026lt;String\u0026gt; taskFuture = CompletableFuture.supplyAsync(() -\u0026gt; { 2 Thread.sleep(2000); 3 return \u0026#34;Success\u0026#34;; 4}); 5 6CompletableFuture\u0026lt;String\u0026gt; timeoutFuture = new CompletableFuture\u0026lt;\u0026gt;(); 7scheduler.schedule(() -\u0026gt; { 8 timeoutFuture.completeExceptionally(new TimeoutException()); 9}, 1, TimeUnit.SECONDS); 10 11CompletableFuture\u0026lt;String\u0026gt; result = (CompletableFuture\u0026lt;String\u0026gt;) CompletableFuture.anyOf( 12 taskFuture, timeoutFuture 13); ä¸çº¿ç¨‹æ± çš„é…åˆ é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompletableFuture ä½¿ç”¨ ForkJoinPool.commonPool()ï¼Œçº¿ç¨‹æ•°ç­‰äº CPU æ ¸å¿ƒæ•°ã€‚\nå¯¹äº IO å¯†é›†å‹ä»»åŠ¡ï¼Œåº”è¯¥ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š\n1ExecutorService executor = Executors.newFixedThreadPool(20); 2 3CompletableFuture\u0026lt;String\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { 4 // IO å¯†é›†å‹ä»»åŠ¡ 5 return httpClient.get(url); 6}, executor); æ³¨æ„äº‹é¡¹\nä¸åŒç±»å‹çš„ä»»åŠ¡ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼ˆCPU å¯†é›†å‹ vs IO å¯†é›†å‹ï¼‰ çº¿ç¨‹æ± è¦åˆç†é…ç½®å¤§å°ï¼Œé¿å…èµ„æºè€—å°½ åº”ç”¨å…³é—­æ—¶è¦ä¼˜é›…åœ°å…³é—­çº¿ç¨‹æ±  1@PreDestroy 2public void shutdown() { 3 executor.shutdown(); 4 try { 5 if (!executor.awaitTermination(60, TimeUnit.SECONDS)) { 6 executor.shutdownNow(); 7 } 8 } catch (InterruptedException e) { 9 executor.shutdownNow(); 10 } 11} æœ€ä½³å®è·µ 1. é¿å…é˜»å¡æ“ä½œ\nä¸è¦åœ¨ CompletableFuture çš„å›è°ƒä¸­æ‰§è¡Œé˜»å¡æ“ä½œï¼Œä¼šå ç”¨çº¿ç¨‹æ± èµ„æºã€‚\n1// ä¸å¥½ï¼šé˜»å¡æ“ä½œ 2CompletableFuture.supplyAsync(() -\u0026gt; { 3 Thread.sleep(1000); // é˜»å¡çº¿ç¨‹ 4 return \u0026#34;Result\u0026#34;; 5}); 6 7// å¥½ï¼šä½¿ç”¨å¼‚æ­¥ API 8CompletableFuture.supplyAsync(() -\u0026gt; { 9 return asyncHttpClient.get(url).join(); 10}); 2. åˆç†è®¾ç½®è¶…æ—¶\né¿å…ä»»åŠ¡æ— é™ç­‰å¾…ï¼Œå¯¼è‡´èµ„æºæ³„æ¼ã€‚\n3. å¼‚å¸¸å¤„ç†è¦å®Œå–„\nç¡®ä¿æ¯ä¸ª CompletableFuture éƒ½æœ‰å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œé¿å…å¼‚å¸¸è¢«åæ‰ã€‚\n4. é¿å…è¿‡åº¦å¹¶è¡Œ\nå¹¶è¡Œä»»åŠ¡æ•°ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè¦æ ¹æ®ç³»ç»Ÿèµ„æºå’Œä¸‹æ¸¸æœåŠ¡çš„æ‰¿è½½èƒ½åŠ›è°ƒæ•´ã€‚\næ€»ç»“ä¸æ€è€ƒ CompletableFuture æ˜¯ Java å¼‚æ­¥ç¼–ç¨‹çš„åˆ©å™¨ï¼Œå®ƒæä¾›äº†ï¼š\né“¾å¼è°ƒç”¨ï¼šä¼˜é›…çš„å¼‚æ­¥æµæ°´çº¿ ç»„åˆæ“ä½œï¼šçµæ´»çš„ä»»åŠ¡ç¼–æ’ å¼‚å¸¸å¤„ç†ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ çº¿ç¨‹æ± é›†æˆï¼šé«˜æ•ˆçš„èµ„æºåˆ©ç”¨ æŒæ¡ CompletableFutureï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å’Œä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡æ—¶ï¼Œä¸å¦¨è¯•è¯• CompletableFutureï¼Œä½“éªŒå¼‚æ­¥ç¼–ç¨‹çš„é­…åŠ›ã€‚\n","permalink":"http://localhost:1313/posts/2024/03/completablefuture-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/","summary":"\u003cp\u003eåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªæ¥å£å¾€å¾€éœ€è¦è°ƒç”¨å¤šä¸ªä¸‹æ¸¸æœåŠ¡ã€‚å¦‚æœä¸²è¡Œè°ƒç”¨ï¼Œå“åº”æ—¶é—´ä¼šç´¯åŠ ï¼›å¦‚æœç”¨ä¼ ç»Ÿçš„ Futureï¼Œä»£ç ä¼šå˜å¾—å¤æ‚éš¾ç»´æŠ¤ã€‚CompletableFuture æä¾›äº†ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ CompletableFuture çš„é“¾å¼è°ƒç”¨ä¸ç»„åˆæ“ä½œ\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šå¼‚å¸¸å¤„ç†ä¸è¶…æ—¶æ§åˆ¶\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ä¸çº¿ç¨‹æ± çš„é…åˆä½¿ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¼ ç»Ÿ-future-çš„ç—›ç‚¹\"\u003eä¼ ç»Ÿ Future çš„ç—›ç‚¹\u003c/h2\u003e\n\u003cp\u003eJDK 1.5 å¼•å…¥çš„ Future æ¥å£åªèƒ½é€šè¿‡ get() æ–¹æ³•é˜»å¡ç­‰å¾…ç»“æœï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eExecutorService\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexecutor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eExecutors\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003enewFixedThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eexecutor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esubmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// é˜»å¡ç­‰å¾…ç»“æœ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé—®é¢˜ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eget() ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ— æ³•å¼‚æ­¥å¤„ç†ç»“æœ\u003c/li\u003e\n\u003cli\u003eæ— æ³•ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡\u003c/li\u003e\n\u003cli\u003eå¼‚å¸¸å¤„ç†ä¸æ–¹ä¾¿\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eCompletableFuture è§£å†³äº†è¿™äº›é—®é¢˜ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"completablefuture-åŸºç¡€ç”¨æ³•\"\u003eCompletableFuture åŸºç¡€ç”¨æ³•\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ›å»º CompletableFuture\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨å®Œæˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecomplete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼äºŒï¼šå¼‚æ­¥æ‰§è¡Œ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esupplyAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// æ–¹å¼ä¸‰ï¼šæ— è¿”å›å€¼çš„å¼‚æ­¥æ‰§è¡Œ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eVoid\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003efuture\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eCompletableFuture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erunAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eè·å–ç»“æœ\u003c/strong\u003e\u003c/p\u003e","title":"CompletableFuture å¼‚æ­¥ç¼–ç¨‹å®æˆ˜æŒ‡å—"},{"content":"åœ¨ç”µå•†ä¸šåŠ¡é«˜é€Ÿå‘å±•çš„èƒŒæ™¯ä¸‹ï¼Œæ‹¼å›¢æ¨¡å¼å› å…¶ç¤¾äº¤è£‚å˜å±æ€§æˆä¸ºæµé‡å¢é•¿çš„åˆ©å™¨ã€‚ä½†çœ‹ä¼¼ç®€å•çš„\u0026quot;å‡‘å¤Ÿ N äººæˆå›¢\u0026quot;èƒŒåï¼Œéšè—ç€åº“å­˜è¶…å–ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€æµ·é‡æ•°æ®å­˜å‚¨ç­‰ä¸€ç³»åˆ—æŠ€æœ¯æŒ‘æˆ˜ã€‚æœ¬æ–‡å¤ç›˜æˆ‘åœ¨æ‹¼å›¢äº¤æ˜“å¹³å°é¡¹ç›®ä¸­çš„æ¶æ„è®¾è®¡ä¸æŠ€æœ¯é€‰å‹æ€è€ƒã€‚\né¡¹ç›®äº®ç‚¹ åŸºäº DDD æ€æƒ³çš„é¢†åŸŸæ¨¡å‹è®¾è®¡ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦ Redis åˆ†å¸ƒå¼é” + åˆ†åº“åˆ†è¡¨è§£å†³é«˜å¹¶å‘åº“å­˜æ‰£å‡é—®é¢˜ RabbitMQ å¼‚æ­¥è§£è€¦å®ç°å•æ­¥æµæ°´çº¿ï¼Œæå‡ç³»ç»Ÿååé‡ ShardingSphere åˆ†åº“åˆ†è¡¨æ”¯æ’‘æµ·é‡è®¢å•æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢ ä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜ æ‹¼å›¢äº¤æ˜“çš„æ ¸å¿ƒæµç¨‹çœ‹ä¼¼ç®€å•ï¼šç”¨æˆ·å‘èµ·æ‹¼å›¢ â†’ å…¶ä»–ç”¨æˆ·å‚å›¢ â†’ è¾¾åˆ°äººæ•°åæˆå›¢ â†’ æ‰£å‡åº“å­˜ â†’ é€šçŸ¥æ”¯ä»˜ã€‚ä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªæµç¨‹ä¼šé‡åˆ°ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\nåº“å­˜è¶…å–ï¼š 100 ä»¶å•†å“ï¼Œ1000 äººåŒæ—¶ä¸‹å•ï¼Œå¦‚ä½•ä¿è¯ä¸ä¼šè¶…å–ï¼Ÿä¼ ç»Ÿçš„æ•°æ®åº“è¡Œé”åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤±æ•ˆã€‚\nåˆ†å¸ƒå¼äº‹åŠ¡ï¼š è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡ã€æ”¯ä»˜é€šçŸ¥åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\næµ·é‡æ•°æ®ï¼š è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚ä½•ä¿è¯æŸ¥è¯¢æ€§èƒ½ä¸éšæ•°æ®é‡å¢é•¿è€ŒåŠ£åŒ–ï¼Ÿ\nè¿™äº›é—®é¢˜å€’é€¼æˆ‘ä»¬å¿…é¡»ä»æ¶æ„å±‚é¢é‡æ–°æ€è€ƒç³»ç»Ÿè®¾è®¡ã€‚\næ¶æ„è®¾è®¡ï¼šDDD æ€æƒ³çš„è½åœ°å®è·µ ä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹ä¼šå¯¼è‡´ Service å±‚é€»è¾‘è‡ƒè‚¿ï¼Œä¸šåŠ¡è§„åˆ™æ•£è½åœ¨å„å¤„ã€‚æˆ‘ä»¬é‡‡ç”¨ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ€æƒ³ï¼Œå°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒé¢†åŸŸï¼š\nè®¢å•åŸŸï¼ˆOrderï¼‰ï¼š è´Ÿè´£æ‹¼å›¢è®¢å•çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€çŠ¶æ€æµè½¬ã€è¶…æ—¶å–æ¶ˆç­‰ã€‚\nåº“å­˜åŸŸï¼ˆInventoryï¼‰ï¼š è´Ÿè´£å•†å“åº“å­˜çš„æ‰£å‡ã€å›æ»šã€é¢„å ç­‰æ“ä½œï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒç“¶é¢ˆã€‚\næ”¯ä»˜åŸŸï¼ˆPaymentï¼‰ï¼š è´Ÿè´£æ”¯ä»˜æµç¨‹çš„ç¼–æ’ï¼ŒåŒ…æ‹¬æ”¯ä»˜é€šçŸ¥ã€é€€æ¬¾å¤„ç†ç­‰ã€‚\næ¯ä¸ªé¢†åŸŸéƒ½æœ‰è‡ªå·±çš„èšåˆæ ¹ï¼ˆAggregate Rootï¼‰å’Œé¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰ã€‚æ¯”å¦‚è®¢å•åŸŸçš„èšåˆæ ¹æ˜¯ Orderï¼Œå®ƒå°è£…äº†è®¢å•çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™ï¼š\n1public class Order { 2 private OrderId id; 3 private UserId userId; 4 private OrderStatus status; 5 private List\u0026lt;OrderItem\u0026gt; items; 6 7 // ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰å¾…æ”¯ä»˜çŠ¶æ€æ‰èƒ½å–æ¶ˆ 8 public void cancel() { 9 if (this.status != OrderStatus.PENDING_PAYMENT) { 10 throw new OrderCannotCancelException(); 11 } 12 this.status = OrderStatus.CANCELLED; 13 // å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼šè®¢å•å·²å–æ¶ˆ 14 DomainEventPublisher.publish(new OrderCancelledEvent(this.id)); 15 } 16} è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šä¸šåŠ¡è§„åˆ™å†…èšåœ¨é¢†åŸŸå¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨ Service å±‚çš„å„ç§ if-else é‡Œã€‚å½“äº§å“ç»ç†è¯´\u0026quot;å¢åŠ ä¸€ä¸ªæ‹¼å›¢å¤±è´¥è‡ªåŠ¨é€€æ¬¾çš„é€»è¾‘\u0026quot;æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç›‘å¬ OrderCancelledEvent äº‹ä»¶ï¼Œè€Œä¸éœ€è¦æ”¹åŠ¨è®¢å•å–æ¶ˆçš„æ ¸å¿ƒé€»è¾‘ã€‚\næ¶æ„æ€è€ƒï¼š DDD çš„æœ¬è´¨æ˜¯\u0026quot;ç”¨ä»£ç è¡¨è¾¾ä¸šåŠ¡è¯­è¨€\u0026quot;ã€‚å½“ä½ çš„ä»£ç ä¸­å‡ºç° Order.cancel() è€Œä¸æ˜¯ orderService.updateStatus(orderId, 3)ï¼Œä¸šåŠ¡äººå‘˜ä¹Ÿèƒ½çœ‹æ‡‚ä»£ç åœ¨åšä»€ä¹ˆã€‚è¿™ç§\u0026quot;é€šç”¨è¯­è¨€\u0026quot;ï¼ˆUbiquitous Languageï¼‰æ˜¯ DDD æœ€å¤§çš„ä»·å€¼ã€‚\næ ¸å¿ƒéš¾ç‚¹ï¼šåˆ†å¸ƒå¼é”è§£å†³åº“å­˜è¶…å– åº“å­˜æ‰£å‡æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚æœ€ç®€å•çš„æ–¹æ¡ˆæ˜¯åœ¨æ•°æ®åº“å±‚é¢åŠ è¡Œé”ï¼š\n1UPDATE inventory SET stock = stock - 1 WHERE product_id = ? AND stock \u0026gt; 0 ä½†è¿™ç§æ–¹æ¡ˆåœ¨é«˜å¹¶å‘ä¸‹ä¼šå¯¼è‡´å¤§é‡çº¿ç¨‹é˜»å¡åœ¨æ•°æ®åº“é”ä¸Šï¼ŒTPS ä¸Šä¸å»ã€‚æˆ‘ä»¬çš„ä¼˜åŒ–æ€è·¯æ˜¯ï¼šç”¨ Redis åˆ†å¸ƒå¼é” + é¢„æ‰£å‡æœºåˆ¶ã€‚\nç¬¬ä¸€æ­¥ï¼šRedis é¢„æ‰£å‡\nç”¨æˆ·ä¸‹å•æ—¶ï¼Œå…ˆåœ¨ Redis ä¸­æ‰£å‡åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰ï¼š\n1public boolean preDeductStock(String productId, int quantity) { 2 String key = \u0026#34;stock:\u0026#34; + productId; 3 Long remaining = redisTemplate.opsForValue().decrement(key, quantity); 4 return remaining != null \u0026amp;\u0026amp; remaining \u0026gt;= 0; 5} å¦‚æœ Redis æ‰£å‡æˆåŠŸï¼Œè¯´æ˜æœ‰åº“å­˜ï¼Œå…è®¸åˆ›å»ºè®¢å•ã€‚å¦‚æœå¤±è´¥ï¼Œç›´æ¥è¿”å›\u0026quot;åº“å­˜ä¸è¶³\u0026quot;ï¼Œä¸éœ€è¦è®¿é—®æ•°æ®åº“ã€‚\nç¬¬äºŒæ­¥ï¼šå¼‚æ­¥åŒæ­¥åˆ°æ•°æ®åº“\né€šè¿‡ RabbitMQ å‘é€æ¶ˆæ¯ï¼Œå¼‚æ­¥å°†åº“å­˜å˜æ›´åŒæ­¥åˆ° MySQLï¼š\n1rabbitTemplate.convertAndSend(\u0026#34;inventory.exchange\u0026#34;, \u0026#34;stock.deduct\u0026#34;, 2 new StockDeductMessage(productId, quantity, orderId)); æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯ï¼Œæ›´æ–°æ•°æ®åº“åº“å­˜ï¼š\n1@RabbitListener(queues = \u0026#34;stock.deduct.queue\u0026#34;) 2public void handleStockDeduct(StockDeductMessage msg) { 3 inventoryMapper.deductStock(msg.getProductId(), msg.getQuantity()); 4} ç¬¬ä¸‰æ­¥ï¼šRedisson çœ‹é—¨ç‹—æœºåˆ¶\nä¸ºäº†é˜²æ­¢ Redis å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬ç”¨ Redisson çš„åˆ†å¸ƒå¼é”ä¿æŠ¤æ•´ä¸ªæ‰£å‡æµç¨‹ï¼š\n1RLock lock = redisson.getLock(\u0026#34;lock:stock:\u0026#34; + productId); 2try { 3 lock.lock(10, TimeUnit.SECONDS); 4 // æ‰§è¡Œæ‰£å‡é€»è¾‘ 5} finally { 6 lock.unlock(); 7} Redisson çš„çœ‹é—¨ç‹—æœºåˆ¶ä¼šè‡ªåŠ¨ç»­æœŸé”ï¼Œé¿å…ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”æå‰é‡Šæ”¾ã€‚\né¿å‘æç¤ºï¼š Redis é¢„æ‰£å‡æ–¹æ¡ˆæœ‰ä¸ªéšæ‚£ï¼šå¦‚æœè®¢å•è¶…æ—¶æœªæ”¯ä»˜ï¼Œéœ€è¦å›æ»šåº“å­˜ã€‚è¿™æ—¶å¿…é¡»ä¿è¯ Redis å’Œæ•°æ®åº“çš„åº“å­˜æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚æˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šå®šæ—¶ä»»åŠ¡æ‰«æè¶…æ—¶è®¢å•ï¼ŒåŒæ—¶å›æ»š Redis å’Œæ•°æ®åº“åº“å­˜ã€‚\nå¼‚æ­¥è§£è€¦ï¼šRabbitMQ å•æ­¥æµæ°´çº¿è®¾è®¡ ä¼ ç»Ÿçš„åŒæ­¥è°ƒç”¨é“¾è·¯æ˜¯ï¼šåˆ›å»ºè®¢å• â†’ æ‰£å‡åº“å­˜ â†’ å‘é€æ”¯ä»˜é€šçŸ¥ã€‚å¦‚æœæ¯ä¸€æ­¥éƒ½åŒæ­¥ç­‰å¾…ï¼Œæ•´ä¸ªæ¥å£çš„ RTï¼ˆå“åº”æ—¶é—´ï¼‰ä¼šç´¯åŠ ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå·®ã€‚\næˆ‘ä»¬ç”¨ RabbitMQ å®ç°å¼‚æ­¥è§£è€¦ï¼š\nç”¨æˆ·ä¸‹å•åï¼Œç«‹å³è¿”å›\u0026quot;è®¢å•åˆ›å»ºæˆåŠŸ\u0026quot; å‘é€æ¶ˆæ¯åˆ° order.created é˜Ÿåˆ— åº“å­˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ï¼Œæ‰£å‡åº“å­˜åå‘é€ stock.deducted æ¶ˆæ¯ æ”¯ä»˜æœåŠ¡ç›‘å¬æ¶ˆæ¯ï¼Œå‘é€æ”¯ä»˜é€šçŸ¥ è¿™ç§å•æ­¥æµæ°´çº¿è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šæ¯ä¸ªæœåŠ¡åªå…³å¿ƒè‡ªå·±çš„èŒè´£ï¼Œé€šè¿‡æ¶ˆæ¯é©±åŠ¨å®ç°æ¾è€¦åˆã€‚å¦‚æœåº“å­˜æœåŠ¡æŒ‚äº†ï¼Œæ¶ˆæ¯ä¼šå †ç§¯åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ¢å¤åè‡ªåŠ¨æ¶ˆè´¹ï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ã€‚\n1// è®¢å•æœåŠ¡ï¼šå‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶ 2@Transactional 3public void createOrder(OrderDTO dto) { 4 Order order = orderMapper.insert(dto); 5 rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.created\u0026#34;, 6 new OrderCreatedEvent(order.getId())); 7} 8 9// åº“å­˜æœåŠ¡ï¼šç›‘å¬è®¢å•åˆ›å»ºäº‹ä»¶ 10@RabbitListener(queues = \u0026#34;order.created.queue\u0026#34;) 11public void handleOrderCreated(OrderCreatedEvent event) { 12 inventoryService.deductStock(event.getOrderId()); 13 rabbitTemplate.convertAndSend(\u0026#34;inventory.exchange\u0026#34;, \u0026#34;stock.deducted\u0026#34;, 14 new StockDeductedEvent(event.getOrderId())); 15} æ¶æ„æ€è€ƒï¼š å¼‚æ­¥åŒ–çš„ä»£ä»·æ˜¯è°ƒè¯•å¤æ‚åº¦å¢åŠ ã€‚å½“è®¢å•åˆ›å»ºæˆåŠŸä½†åº“å­˜æ‰£å‡å¤±è´¥æ—¶ï¼Œå¦‚ä½•æ’æŸ¥é—®é¢˜ï¼Ÿæˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šæ¯æ¡æ¶ˆæ¯éƒ½å¸¦ä¸Š traceIdï¼Œé€šè¿‡æ—¥å¿—ç³»ç»Ÿä¸²è”æ•´ä¸ªè°ƒç”¨é“¾è·¯ã€‚\næµ·é‡æ•°æ®ï¼šShardingSphere åˆ†åº“åˆ†è¡¨å®æˆ˜ è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚æœä¸åšåˆ†åº“åˆ†è¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šéšç€æ•°æ®é‡å¢é•¿è€Œæ€¥å‰§ä¸‹é™ã€‚æˆ‘ä»¬ç”¨ ShardingSphere å®ç°æ°´å¹³åˆ†è¡¨ï¼š\nåˆ†ç‰‡ç­–ç•¥ï¼š æŒ‰ user_id å–æ¨¡åˆ† 16 å¼ è¡¨ï¼ˆt_order_0 ~ t_order_15ï¼‰\n1shardingRule: 2 tables: 3 t_order: 4 actualDataNodes: ds0.t_order_${0..15} 5 tableStrategy: 6 standard: 7 shardingColumn: user_id 8 shardingAlgorithmName: order_mod 9 shardingAlgorithms: 10 order_mod: 11 type: MOD 12 props: 13 sharding-count: 16 ä¸ºä»€ä¹ˆé€‰æ‹© user_id è€Œä¸æ˜¯ order_idï¼Ÿ\nå› ä¸ºå¤§éƒ¨åˆ†æŸ¥è¯¢åœºæ™¯æ˜¯\u0026quot;æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„è®¢å•åˆ—è¡¨\u0026quot;ï¼ŒæŒ‰ user_id åˆ†ç‰‡å¯ä»¥ä¿è¯å•ä¸ªç”¨æˆ·çš„è®¢å•éƒ½åœ¨åŒä¸€å¼ è¡¨ï¼Œé¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ã€‚\nè·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–ï¼š\nå¦‚æœéœ€è¦æŒ‰ order_id æŸ¥è¯¢ï¼ˆæ¯”å¦‚è®¢å•è¯¦æƒ…é¡µï¼‰ï¼Œä¼šè§¦å‘å…¨è¡¨æ‰«æã€‚æˆ‘ä»¬çš„ä¼˜åŒ–æ–¹æ¡ˆæ˜¯ï¼šåœ¨ Redis ä¸­ç»´æŠ¤ order_id -\u0026gt; user_id çš„æ˜ å°„å…³ç³»ï¼Œå…ˆæŸ¥ Redis è·å– user_idï¼Œå†ç²¾å‡†è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡ã€‚\n1public Order getOrderById(String orderId) { 2 // å…ˆä» Redis è·å– user_id 3 String userId = redisTemplate.opsForValue().get(\u0026#34;order:user:\u0026#34; + orderId); 4 if (userId != null) { 5 // ç²¾å‡†è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡ 6 return orderMapper.selectByOrderIdAndUserId(orderId, userId); 7 } 8 // é™çº§æ–¹æ¡ˆï¼šå…¨è¡¨æ‰«æ 9 return orderMapper.selectByOrderId(orderId); 10} é¿å‘æç¤ºï¼š åˆ†åº“åˆ†è¡¨åï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¼šå˜å¾—æ›´å¤æ‚ã€‚æˆ‘ä»¬çš„åšæ³•æ˜¯ï¼šå°½é‡é¿å…è·¨åˆ†ç‰‡äº‹åŠ¡ï¼Œé€šè¿‡ä¸šåŠ¡è®¾è®¡ä¿è¯å•ä¸ªäº‹åŠ¡åªæ“ä½œä¸€ä¸ªåˆ†ç‰‡ã€‚å¦‚æœå®åœ¨éœ€è¦è·¨åˆ†ç‰‡ï¼Œä½¿ç”¨ Seata çš„ AT æ¨¡å¼ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚\né¡¹ç›®æˆæœä¸æ€è€ƒ ç»è¿‡ä¸‰ä¸ªæœˆçš„è¿­ä»£ï¼Œæ‹¼å›¢äº¤æ˜“å¹³å°æˆåŠŸä¸Šçº¿ï¼Œæ ¸å¿ƒæŒ‡æ ‡å¦‚ä¸‹ï¼š\nè®¢å•åˆ›å»ºæ¥å£ RT ä» 800ms é™ä½åˆ° 120ms åº“å­˜æ‰£å‡ TPS ä» 500 æå‡åˆ° 3000+ æ”¯æŒå•æ—¥ç™¾ä¸‡çº§è®¢å•æ•°æ®å†™å…¥ï¼ŒæŸ¥è¯¢æ€§èƒ½ç¨³å®šåœ¨ 50ms ä»¥å†… è¿™ä¸ªé¡¹ç›®æœ€å¤§çš„æ”¶è·ä¸æ˜¯æŠ€æœ¯æ ˆçš„å †ç Œï¼Œè€Œæ˜¯å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„æ·±åº¦ç†è§£ï¼š\næ²¡æœ‰é“¶å¼¹ï¼š Redis åˆ†å¸ƒå¼é”ã€RabbitMQ å¼‚æ­¥ã€ShardingSphere åˆ†åº“åˆ†è¡¨ï¼Œæ¯ä¸ªæŠ€æœ¯æ–¹æ¡ˆéƒ½æœ‰é€‚ç”¨åœºæ™¯å’Œä»£ä»·ã€‚é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆçš„æœ¬è´¨æ˜¯åœ¨æ€§èƒ½ã€ä¸€è‡´æ€§ã€å¤æ‚åº¦ä¹‹é—´åšæƒè¡¡ã€‚\næ¶æ„æ¼”è¿›ï¼š ç³»ç»Ÿä¸æ˜¯ä¸€å¼€å§‹å°±è®¾è®¡æˆåˆ†å¸ƒå¼çš„ã€‚æˆ‘ä»¬æœ€åˆæ˜¯å•ä½“åº”ç”¨ + MySQL ä¸»ä»ï¼Œå½“ TPS åˆ°è¾¾ç“¶é¢ˆåæ‰å¼•å…¥ Redis å’Œ RabbitMQã€‚è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚\nå¯è§‚æµ‹æ€§ï¼š åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤§çš„æŒ‘æˆ˜æ˜¯æ’æŸ¥é—®é¢˜ã€‚æˆ‘ä»¬åœ¨æ¯ä¸ªå…³é”®èŠ‚ç‚¹éƒ½åŸ‹ç‚¹ä¸ŠæŠ¥ç›‘æ§æ•°æ®ï¼ˆè®¢å•åˆ›å»ºæ•°ã€åº“å­˜æ‰£å‡æ•°ã€æ¶ˆæ¯å †ç§¯æ•°ï¼‰ï¼Œé€šè¿‡ Grafana å®æ—¶ç›‘æ§ç³»ç»Ÿå¥åº·åº¦ã€‚\nå¦‚æœè®©æˆ‘é‡æ–°è®¾è®¡è¿™ä¸ªç³»ç»Ÿï¼Œæˆ‘ä¼šåœ¨é¡¹ç›®åˆæœŸå°±å¼•å…¥å…¨é“¾è·¯å‹æµ‹ï¼Œæå‰å‘ç°æ€§èƒ½ç“¶é¢ˆï¼Œè€Œä¸æ˜¯ç­‰åˆ°ä¸Šçº¿åæ‰å‘ç°é—®é¢˜ã€‚\n","permalink":"http://localhost:1313/projects/pindan-trading-platform/","summary":"\u003cp\u003eåœ¨ç”µå•†ä¸šåŠ¡é«˜é€Ÿå‘å±•çš„èƒŒæ™¯ä¸‹ï¼Œæ‹¼å›¢æ¨¡å¼å› å…¶ç¤¾äº¤è£‚å˜å±æ€§æˆä¸ºæµé‡å¢é•¿çš„åˆ©å™¨ã€‚ä½†çœ‹ä¼¼ç®€å•çš„\u0026quot;å‡‘å¤Ÿ N äººæˆå›¢\u0026quot;èƒŒåï¼Œéšè—ç€åº“å­˜è¶…å–ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€æµ·é‡æ•°æ®å­˜å‚¨ç­‰ä¸€ç³»åˆ—æŠ€æœ¯æŒ‘æˆ˜ã€‚æœ¬æ–‡å¤ç›˜æˆ‘åœ¨æ‹¼å›¢äº¤æ˜“å¹³å°é¡¹ç›®ä¸­çš„æ¶æ„è®¾è®¡ä¸æŠ€æœ¯é€‰å‹æ€è€ƒã€‚\u003c/p\u003e\n\u003ch3 id=\"é¡¹ç›®äº®ç‚¹\"\u003eé¡¹ç›®äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e åŸºäº DDD æ€æƒ³çš„é¢†åŸŸæ¨¡å‹è®¾è®¡ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e Redis åˆ†å¸ƒå¼é” + åˆ†åº“åˆ†è¡¨è§£å†³é«˜å¹¶å‘åº“å­˜æ‰£å‡é—®é¢˜\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e RabbitMQ å¼‚æ­¥è§£è€¦å®ç°å•æ­¥æµæ°´çº¿ï¼Œæå‡ç³»ç»Ÿååé‡\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ShardingSphere åˆ†åº“åˆ†è¡¨æ”¯æ’‘æµ·é‡è®¢å•æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"ä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜\"\u003eä¸šåŠ¡åœºæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜\u003c/h2\u003e\n\u003cp\u003eæ‹¼å›¢äº¤æ˜“çš„æ ¸å¿ƒæµç¨‹çœ‹ä¼¼ç®€å•ï¼šç”¨æˆ·å‘èµ·æ‹¼å›¢ â†’ å…¶ä»–ç”¨æˆ·å‚å›¢ â†’ è¾¾åˆ°äººæ•°åæˆå›¢ â†’ æ‰£å‡åº“å­˜ â†’ é€šçŸ¥æ”¯ä»˜ã€‚ä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªæµç¨‹ä¼šé‡åˆ°ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåº“å­˜è¶…å–ï¼š\u003c/strong\u003e 100 ä»¶å•†å“ï¼Œ1000 äººåŒæ—¶ä¸‹å•ï¼Œå¦‚ä½•ä¿è¯ä¸ä¼šè¶…å–ï¼Ÿä¼ ç»Ÿçš„æ•°æ®åº“è¡Œé”åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤±æ•ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ†å¸ƒå¼äº‹åŠ¡ï¼š\u003c/strong\u003e è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡ã€æ”¯ä»˜é€šçŸ¥åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæµ·é‡æ•°æ®ï¼š\u003c/strong\u003e è®¢å•è¡¨å•æ—¥æ–°å¢ç™¾ä¸‡çº§æ•°æ®ï¼Œå¦‚ä½•ä¿è¯æŸ¥è¯¢æ€§èƒ½ä¸éšæ•°æ®é‡å¢é•¿è€ŒåŠ£åŒ–ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eè¿™äº›é—®é¢˜å€’é€¼æˆ‘ä»¬å¿…é¡»ä»æ¶æ„å±‚é¢é‡æ–°æ€è€ƒç³»ç»Ÿè®¾è®¡ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"æ¶æ„è®¾è®¡ddd-æ€æƒ³çš„è½åœ°å®è·µ\"\u003eæ¶æ„è®¾è®¡ï¼šDDD æ€æƒ³çš„è½åœ°å®è·µ\u003c/h2\u003e\n\u003cp\u003eä¼ ç»Ÿçš„ä¸‰å±‚æ¶æ„ï¼ˆController-Service-DAOï¼‰åœ¨å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹ä¼šå¯¼è‡´ Service å±‚é€»è¾‘è‡ƒè‚¿ï¼Œä¸šåŠ¡è§„åˆ™æ•£è½åœ¨å„å¤„ã€‚æˆ‘ä»¬é‡‡ç”¨ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ€æƒ³ï¼Œå°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒé¢†åŸŸï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè®¢å•åŸŸï¼ˆOrderï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£æ‹¼å›¢è®¢å•çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€çŠ¶æ€æµè½¬ã€è¶…æ—¶å–æ¶ˆç­‰ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåº“å­˜åŸŸï¼ˆInventoryï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£å•†å“åº“å­˜çš„æ‰£å‡ã€å›æ»šã€é¢„å ç­‰æ“ä½œï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒç“¶é¢ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ”¯ä»˜åŸŸï¼ˆPaymentï¼‰ï¼š\u003c/strong\u003e è´Ÿè´£æ”¯ä»˜æµç¨‹çš„ç¼–æ’ï¼ŒåŒ…æ‹¬æ”¯ä»˜é€šçŸ¥ã€é€€æ¬¾å¤„ç†ç­‰ã€‚\u003c/p\u003e\n\u003cp\u003eæ¯ä¸ªé¢†åŸŸéƒ½æœ‰è‡ªå·±çš„èšåˆæ ¹ï¼ˆAggregate Rootï¼‰å’Œé¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰ã€‚æ¯”å¦‚è®¢å•åŸŸçš„èšåˆæ ¹æ˜¯ \u003ccode\u003eOrder\u003c/code\u003eï¼Œå®ƒå°è£…äº†è®¢å•çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOrder\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrderItem\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c1\"\u003e// ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰å¾…æ”¯ä»˜çŠ¶æ€æ‰èƒ½å–æ¶ˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ecancel\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e!=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePENDING_PAYMENT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"k\"\u003ethrow\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderCannotCancelException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003estatus\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eCANCELLED\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e// å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼šè®¢å•å·²å–æ¶ˆ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eDomainEventPublisher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003epublish\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOrderCancelledEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šä¸šåŠ¡è§„åˆ™å†…èšåœ¨é¢†åŸŸå¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨ Service å±‚çš„å„ç§ if-else é‡Œã€‚å½“äº§å“ç»ç†è¯´\u0026quot;å¢åŠ ä¸€ä¸ªæ‹¼å›¢å¤±è´¥è‡ªåŠ¨é€€æ¬¾çš„é€»è¾‘\u0026quot;æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç›‘å¬ \u003ccode\u003eOrderCancelledEvent\u003c/code\u003e äº‹ä»¶ï¼Œè€Œä¸éœ€è¦æ”¹åŠ¨è®¢å•å–æ¶ˆçš„æ ¸å¿ƒé€»è¾‘ã€‚\u003c/p\u003e","title":"æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿï¼šDDD æ¶æ„ä¸‹çš„åˆ†å¸ƒå¼å®æˆ˜"},{"content":"ThreadLocal æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦å·¥å…·ï¼Œå®ƒä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚ä½†å¾ˆå¤šäººåªçŸ¥é“æ€ä¹ˆç”¨ï¼Œä¸çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œæ›´ä¸çŸ¥é“å®ƒå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚æœ¬æ–‡æ·±å…¥å‰–æ ThreadLocal çš„åº•å±‚æœºåˆ¶ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ ThreadLocal çš„å®ç°åŸç†ä¸ ThreadLocalMap ç»“æ„ æŒæ¡å¼±å¼•ç”¨çš„è®¾è®¡æ„å›¾ä¸å†…å­˜æ³„æ¼çš„æ ¹å›  å­¦ä¼šåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹æ­£ç¡®ä½¿ç”¨ ThreadLocal äº†è§£ InheritableThreadLocal çš„ä½¿ç”¨åœºæ™¯ ThreadLocal çš„ä½¿ç”¨åœºæ™¯ ThreadLocal å¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\nåœºæ™¯ä¸€ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’\n1public class UserContext { 2 private static final ThreadLocal\u0026lt;User\u0026gt; context = new ThreadLocal\u0026lt;\u0026gt;(); 3 4 public static void setUser(User user) { 5 context.set(user); 6 } 7 8 public static User getUser() { 9 return context.get(); 10 } 11 12 public static void remove() { 13 context.remove(); 14 } 15} 16 17// åœ¨ Controller ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯ 18@RestController 19public class UserController { 20 21 @GetMapping(\u0026#34;/user/info\u0026#34;) 22 public UserDTO getUserInfo() { 23 User user = UserContext.getUser(); 24 return UserDTO.from(user); 25 } 26} åœºæ™¯äºŒï¼šæ•°æ®åº“è¿æ¥ç®¡ç†\n1public class ConnectionManager { 2 private static final ThreadLocal\u0026lt;Connection\u0026gt; connectionHolder = new ThreadLocal\u0026lt;\u0026gt;(); 3 4 public static Connection getConnection() { 5 Connection conn = connectionHolder.get(); 6 if (conn == null) { 7 conn = DriverManager.getConnection(url, user, password); 8 connectionHolder.set(conn); 9 } 10 return conn; 11 } 12 13 public static void closeConnection() { 14 Connection conn = connectionHolder.get(); 15 if (conn != null) { 16 conn.close(); 17 connectionHolder.remove(); 18 } 19 } 20} åœºæ™¯ä¸‰ï¼šSimpleDateFormat çº¿ç¨‹å®‰å…¨\nSimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥ç”¨ ThreadLocal ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºç‹¬ç«‹å®ä¾‹ï¼š\n1public class DateUtil { 2 private static final ThreadLocal\u0026lt;SimpleDateFormat\u0026gt; formatter = 3 ThreadLocal.withInitial(() -\u0026gt; new SimpleDateFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;)); 4 5 public static String format(Date date) { 6 return formatter.get().format(date); 7 } 8} ThreadLocal çš„å®ç°åŸç† ThreadLocalMapï¼šçœŸæ­£çš„å­˜å‚¨ç»“æ„\nThreadLocal æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œæ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡çš„ threadLocals å­—æ®µä¸­ï¼š\n1public class Thread { 2 ThreadLocal.ThreadLocalMap threadLocals = null; 3} ThreadLocalMap æ˜¯ ThreadLocal çš„é™æ€å†…éƒ¨ç±»ï¼Œç±»ä¼¼äº HashMapï¼Œä½†å®ç°æ›´ç®€å•ï¼š\n1static class ThreadLocalMap { 2 3 static class Entry extends WeakReference\u0026lt;ThreadLocal\u0026lt;?\u0026gt;\u0026gt; { 4 Object value; 5 6 Entry(ThreadLocal\u0026lt;?\u0026gt; k, Object v) { 7 super(k); // key æ˜¯å¼±å¼•ç”¨ 8 value = v; 9 } 10 } 11 12 private Entry[] table; 13 private int size = 0; 14 private int threshold; 15} å…³é”®ç‚¹ï¼šEntry çš„ key æ˜¯ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ã€‚\nset æ–¹æ³•çš„å®ç°\n1public void set(T value) { 2 Thread t = Thread.currentThread(); 3 ThreadLocalMap map = getMap(t); 4 if (map != null) { 5 map.set(this, value); 6 } else { 7 createMap(t, value); 8 } 9} 10 11ThreadLocalMap getMap(Thread t) { 12 return t.threadLocals; 13} 14 15void createMap(Thread t, T firstValue) { 16 t.threadLocals = new ThreadLocalMap(this, firstValue); 17} æµç¨‹ï¼š\nè·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¦‚æœ map ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ map å°† ThreadLocal ä½œä¸º keyï¼Œvalue ä½œä¸ºå€¼å­˜å…¥ map get æ–¹æ³•çš„å®ç°\n1public T get() { 2 Thread t = Thread.currentThread(); 3 ThreadLocalMap map = getMap(t); 4 if (map != null) { 5 ThreadLocalMap.Entry e = map.getEntry(this); 6 if (e != null) { 7 return (T) e.value; 8 } 9 } 10 return setInitialValue(); 11} 12 13private T setInitialValue() { 14 T value = initialValue(); // é»˜è®¤è¿”å› null 15 Thread t = Thread.currentThread(); 16 ThreadLocalMap map = getMap(t); 17 if (map != null) { 18 map.set(this, value); 19 } else { 20 createMap(t, value); 21 } 22 return value; 23} æ¶æ„æ€è€ƒï¼š ThreadLocal çš„è®¾è®¡å·§å¦™ä¹‹å¤„åœ¨äºï¼šæ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯ ThreadLocal å¯¹è±¡ä¸­ã€‚è¿™æ ·ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®è‡ªå·±çš„æ•°æ®æ—¶ï¼Œä¸éœ€è¦åŠ é”ï¼Œé¿å…äº†çº¿ç¨‹ç«äº‰ã€‚\nå¼±å¼•ç”¨ï¼šä¸ºä»€ä¹ˆ key æ˜¯å¼±å¼•ç”¨ï¼Ÿ å››ç§å¼•ç”¨ç±»å‹\nå¼ºå¼•ç”¨ï¼šæ™®é€šçš„å¯¹è±¡å¼•ç”¨ï¼Œåªè¦å¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶ è½¯å¼•ç”¨ï¼šå†…å­˜ä¸è¶³æ—¶ä¼šè¢«å›æ”¶ å¼±å¼•ç”¨ï¼šä¸‹æ¬¡ GC æ—¶ä¸€å®šä¼šè¢«å›æ”¶ è™šå¼•ç”¨ï¼šæ— æ³•é€šè¿‡å¼•ç”¨è·å–å¯¹è±¡ï¼Œåªç”¨äºè·Ÿè¸ªå¯¹è±¡è¢«å›æ”¶çš„çŠ¶æ€ ä¸ºä»€ä¹ˆ key æ˜¯å¼±å¼•ç”¨ï¼Ÿ\nå‡è®¾ key æ˜¯å¼ºå¼•ç”¨ï¼š\n1ThreadLocal\u0026lt;User\u0026gt; userThreadLocal = new ThreadLocal\u0026lt;\u0026gt;(); 2userThreadLocal.set(new User()); 3 4// ä¸šåŠ¡ä»£ç ä¸å†ä½¿ç”¨ userThreadLocal 5userThreadLocal = null; æ­¤æ—¶ï¼Œè™½ç„¶ userThreadLocal å˜é‡è¢«ç½®ä¸º nullï¼Œä½† ThreadLocalMap ä¸­çš„ Entry ä»ç„¶æŒæœ‰ ThreadLocal çš„å¼ºå¼•ç”¨ï¼Œå¯¼è‡´ ThreadLocal å¯¹è±¡æ— æ³•è¢«å›æ”¶ã€‚\nå¦‚æœ key æ˜¯å¼±å¼•ç”¨ï¼š\n1userThreadLocal = null; 2// ä¸‹æ¬¡ GC æ—¶ï¼ŒThreadLocal å¯¹è±¡ä¼šè¢«å›æ”¶ 3// ThreadLocalMap ä¸­çš„ Entry çš„ key å˜æˆ null è¿™æ ·ï¼ŒThreadLocal å¯¹è±¡å¯ä»¥è¢«åŠæ—¶å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚\nä½†æ˜¯ï¼Œvalue ä»ç„¶æ˜¯å¼ºå¼•ç”¨ï¼\nå³ä½¿ key è¢«å›æ”¶ï¼Œvalue ä»ç„¶å­˜åœ¨ï¼Œè¿™å°±æ˜¯å†…å­˜æ³„æ¼çš„æ ¹æºã€‚\nå†…å­˜æ³„æ¼ï¼šçº¿ç¨‹æ± ç¯å¢ƒä¸‹çš„é™·é˜± é—®é¢˜åœºæ™¯\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); // å‡è®¾æœ‰ 10 ä¸‡æ¡æ•°æ® 8 cache.set(users); 9 10 // å¤„ç†ä¸šåŠ¡é€»è¾‘ 11 doSomething(users); 12 13 // å¿˜è®°è°ƒç”¨ remove() 14 } 15} åœ¨ Tomcat çº¿ç¨‹æ± ç¯å¢ƒä¸‹ï¼š\nè¯·æ±‚åˆ°è¾¾ï¼Œçº¿ç¨‹æ± åˆ†é…çº¿ç¨‹ A å¤„ç†è¯·æ±‚ çº¿ç¨‹ A æ‰§è¡Œ processUsers()ï¼Œå°† 10 ä¸‡æ¡æ•°æ®å­˜å…¥ ThreadLocal è¯·æ±‚ç»“æŸï¼Œçº¿ç¨‹ A è¿”å›çº¿ç¨‹æ± ï¼Œä½† ThreadLocal ä¸­çš„æ•°æ®æ²¡æœ‰æ¸…ç† ä¸‹æ¬¡è¯·æ±‚å¤ç”¨çº¿ç¨‹ A æ—¶ï¼ŒThreadLocal ä¸­ä»ç„¶ä¿å­˜ç€ä¸Šæ¬¡çš„æ•°æ® éšç€è¯·æ±‚å¢å¤šï¼Œæ¯ä¸ªçº¿ç¨‹çš„ ThreadLocal éƒ½ä¼šç§¯ç´¯å¤§é‡æ•°æ®ï¼Œæœ€ç»ˆå¯¼è‡´ OOMã€‚\nå†…å­˜æ³„æ¼çš„æ ¹å› \n1Thread (å¼ºå¼•ç”¨) 2 â†“ 3ThreadLocalMap (å¼ºå¼•ç”¨) 4 â†“ 5Entry[] (å¼ºå¼•ç”¨) 6 â†“ 7Entry.key (å¼±å¼•ç”¨) â†’ ThreadLocal (å¯èƒ½è¢«å›æ”¶) 8Entry.value (å¼ºå¼•ç”¨) â†’ User List (æ— æ³•è¢«å›æ”¶) å³ä½¿ ThreadLocal å¯¹è±¡è¢«å›æ”¶ï¼Œvalue ä»ç„¶è¢« Entry å¼ºå¼•ç”¨ï¼Œæ— æ³•è¢« GC å›æ”¶ã€‚\næ­£ç¡®çš„ä½¿ç”¨æ–¹å¼\n1@Service 2public class UserService { 3 4 private static final ThreadLocal\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; cache = new ThreadLocal\u0026lt;\u0026gt;(); 5 6 public void processUsers() { 7 try { 8 List\u0026lt;User\u0026gt; users = userMapper.selectAll(); 9 cache.set(users); 10 doSomething(users); 11 } finally { 12 cache.remove(); // å¿…é¡»åœ¨ finally ä¸­æ¸…ç† 13 } 14 } 15} ThreadLocal çš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶\nThreadLocalMap åœ¨ setã€getã€remove æ—¶ä¼šè§¦å‘æ¸…ç†ï¼š\n1private int expungeStaleEntry(int staleSlot) { 2 Entry[] tab = table; 3 int len = tab.length; 4 5 // æ¸…ç† key ä¸º null çš„ Entry 6 tab[staleSlot].value = null; 7 tab[staleSlot] = null; 8 size--; 9 10 // ç»§ç»­æ‰«æåç»­çš„ Entry 11 Entry e; 12 int i; 13 for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) { 14 ThreadLocal\u0026lt;?\u0026gt; k = e.get(); 15 if (k == null) { 16 e.value = null; 17 tab[i] = null; 18 size--; 19 } 20 } 21 return i; 22} ä½†è¿™ç§æ¸…ç†æ˜¯è¢«åŠ¨çš„ï¼Œä¸èƒ½å®Œå…¨ä¾èµ–ã€‚æœ€ä½³å®è·µæ˜¯æ‰‹åŠ¨è°ƒç”¨ remove()ã€‚\né¿å‘æç¤ºï¼š åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„ç¯å¢ƒä¸‹ï¼ŒThreadLocal å¿…é¡»åœ¨ finally å—ä¸­è°ƒç”¨ remove()ã€‚å¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼å’Œæ•°æ®æ··ä¹±ï¼ˆä¸‹ä¸€ä¸ªè¯·æ±‚å¯èƒ½è¯»åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚çš„æ•°æ®ï¼‰ã€‚\nInheritableThreadLocalï¼šçˆ¶å­çº¿ç¨‹ä¼ é€’ ThreadLocal çš„æ•°æ®æ— æ³•åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä¼ é€’ï¼š\n1ThreadLocal\u0026lt;String\u0026gt; threadLocal = new ThreadLocal\u0026lt;\u0026gt;(); 2threadLocal.set(\u0026#34;parent\u0026#34;); 3 4new Thread(() -\u0026gt; { 5 System.out.println(threadLocal.get()); // è¾“å‡º null 6}).start(); InheritableThreadLocal è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼š\n1InheritableThreadLocal\u0026lt;String\u0026gt; inheritableThreadLocal = new InheritableThreadLocal\u0026lt;\u0026gt;(); 2inheritableThreadLocal.set(\u0026#34;parent\u0026#34;); 3 4new Thread(() -\u0026gt; { 5 System.out.println(inheritableThreadLocal.get()); // è¾“å‡º parent 6}).start(); å®ç°åŸç†\nThread ç±»æœ‰ä¸¤ä¸ª ThreadLocalMap å­—æ®µï¼š\n1public class Thread { 2 ThreadLocal.ThreadLocalMap threadLocals = null; 3 ThreadLocal.ThreadLocalMap inheritableThreadLocals = null; 4} åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œä¼šå¤åˆ¶çˆ¶çº¿ç¨‹çš„ inheritableThreadLocalsï¼š\n1private void init(ThreadGroup g, Runnable target, String name, long stackSize) { 2 Thread parent = currentThread(); 3 4 if (parent.inheritableThreadLocals != null) { 5 this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); 6 } 7} æ³¨æ„äº‹é¡¹\nInheritableThreadLocal åªåœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶å¤åˆ¶æ•°æ®ï¼Œå¦‚æœä½¿ç”¨çº¿ç¨‹æ± ï¼Œå­çº¿ç¨‹ä¼šè¢«å¤ç”¨ï¼Œæ•°æ®ä¸ä¼šæ›´æ–°ã€‚\nè§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨é˜¿é‡Œå¼€æºçš„ TransmittableThreadLocalï¼ˆTTLï¼‰ã€‚\nå®æˆ˜æ¡ˆä¾‹ï¼šæ’æŸ¥ ThreadLocal å†…å­˜æ³„æ¼ é—®é¢˜ç°è±¡\nç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOMã€‚é€šè¿‡ MAT åˆ†æ Heap Dumpï¼Œå‘ç°å¤§é‡ ThreadLocalMap.Entry å¯¹è±¡ã€‚\næ’æŸ¥æ­¥éª¤\næŸ¥çœ‹ Dominator Treeï¼Œå‘ç° Thread å¯¹è±¡å ç”¨äº†å¤§é‡å†…å­˜ å±•å¼€ Thread å¯¹è±¡ï¼Œå‘ç° threadLocals å­—æ®µä¸­æœ‰å¤§é‡ Entry æŸ¥çœ‹ Entry çš„ valueï¼Œå‘ç°æ˜¯ä¸šåŠ¡å¯¹è±¡ï¼ˆUser Listï¼‰ é€šè¿‡å¼•ç”¨é“¾æ‰¾åˆ°åˆ›å»º ThreadLocal çš„ä»£ç ä½ç½® ä¿®å¤æ–¹æ¡ˆ\nåœ¨æ‰€æœ‰ä½¿ç”¨ ThreadLocal çš„åœ°æ–¹ï¼Œæ·»åŠ  finally å—è°ƒç”¨ remove()ï¼š\n1try { 2 threadLocal.set(value); 3 // ä¸šåŠ¡é€»è¾‘ 4} finally { 5 threadLocal.remove(); 6} é¢„é˜²æªæ–½\nCode Review é‡ç‚¹å…³æ³¨ ThreadLocal çš„ä½¿ç”¨ ä½¿ç”¨ Alibaba Java Coding Guidelines æ’ä»¶ï¼Œè‡ªåŠ¨æ£€æµ‹ ThreadLocal æœªè°ƒç”¨ remove() åœ¨å•å…ƒæµ‹è¯•ä¸­æ¨¡æ‹Ÿçº¿ç¨‹æ± ç¯å¢ƒï¼Œæ£€æµ‹å†…å­˜æ³„æ¼ æ€»ç»“ä¸æ€è€ƒ ThreadLocal çš„æ ¸å¿ƒåŸç†ï¼š\næ•°æ®å­˜å‚¨åœ¨ Thread å¯¹è±¡çš„ ThreadLocalMap ä¸­ key æ˜¯ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ å¼±å¼•ç”¨è®¾è®¡é¿å…äº† ThreadLocal å¯¹è±¡çš„å†…å­˜æ³„æ¼ï¼Œä½† value ä»å¯èƒ½æ³„æ¼ ä½¿ç”¨ ThreadLocal çš„æœ€ä½³å®è·µï¼š\nåœ¨ finally å—ä¸­è°ƒç”¨ remove() é¿å…å­˜å‚¨å¤§å¯¹è±¡ ä½¿ç”¨ try-with-resources æ¨¡å¼å°è£… ThreadLocal ä¸‹æ¬¡å½“ä½ ä½¿ç”¨ ThreadLocal æ—¶ï¼Œè®°å¾—é—®è‡ªå·±ï¼šæˆ‘åœ¨ finally ä¸­è°ƒç”¨ remove() äº†å—ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/02/threadlocal-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98/","summary":"\u003cp\u003eThreadLocal æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦å·¥å…·ï¼Œå®ƒä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚ä½†å¾ˆå¤šäººåªçŸ¥é“æ€ä¹ˆç”¨ï¼Œä¸çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œæ›´ä¸çŸ¥é“å®ƒå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚æœ¬æ–‡æ·±å…¥å‰–æ ThreadLocal çš„åº•å±‚æœºåˆ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ ThreadLocal çš„å®ç°åŸç†ä¸ ThreadLocalMap ç»“æ„\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡å¼±å¼•ç”¨çš„è®¾è®¡æ„å›¾ä¸å†…å­˜æ³„æ¼çš„æ ¹å› \u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šåœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹æ­£ç¡®ä½¿ç”¨ ThreadLocal\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ InheritableThreadLocal çš„ä½¿ç”¨åœºæ™¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"threadlocal-çš„ä½¿ç”¨åœºæ™¯\"\u003eThreadLocal çš„ä½¿ç”¨åœºæ™¯\u003c/h2\u003e\n\u003cp\u003eThreadLocal å¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœºæ™¯ä¸€ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserContext\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003efinal\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadLocal\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eThreadLocal\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003esetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// åœ¨ Controller ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nd\"\u003e@RestController\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUserController\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nd\"\u003e@GetMapping\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/user/info\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserDTO\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetUserInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetUser\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eUserDTO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåœºæ™¯äºŒï¼šæ•°æ®åº“è¿æ¥ç®¡ç†\u003c/strong\u003e\u003c/p\u003e","title":"ThreadLocal åŸç†ä¸å†…å­˜æ³„æ¼æ’æŸ¥å®æˆ˜"},{"content":"å¼€å§‹å†™åšå®¢ é‚£æ˜¯ä¸€æ¡ç¥å¥‡çš„å¤©è·¯å•Š ğŸµ\nä»Šå¤©å¼€å§‹äº†æˆ‘çš„åšå®¢ä¹‹æ—…ï¼Œå¸Œæœ›èƒ½åœ¨è¿™é‡Œè®°å½•ä¸‹ï¼š\nğŸ’¡ æŠ€æœ¯å­¦ä¹ çš„å¿ƒå¾— ğŸš€ é¡¹ç›®å¼€å‘çš„ç»éªŒ ğŸ“– è¯»ä¹¦æ€è€ƒçš„æ€»ç»“ ğŸŒŸ ç”Ÿæ´»ä¸­çš„æ„Ÿæ‚Ÿ ä¸ºä»€ä¹ˆå†™åšå®¢ å†™åšå®¢ä¸ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯ï¼š\næ•´ç†æ€è·¯ï¼šé€šè¿‡å†™ä½œæ¢³ç†çŸ¥è¯†ä½“ç³» æ·±åŒ–ç†è§£ï¼šæ•™æ˜¯æœ€å¥½çš„å­¦ åˆ†äº«äº¤æµï¼šä¸ä»–äººäº¤æµæƒ³æ³• è®°å½•æˆé•¿ï¼šè§è¯è‡ªå·±çš„è¿›æ­¥ æœªæ¥è®¡åˆ’ æ¥ä¸‹æ¥æˆ‘ä¼šåˆ†äº«æ›´å¤šå…³äºæŠ€æœ¯å’Œç”Ÿæ´»çš„å†…å®¹ï¼Œæ•¬è¯·æœŸå¾…ï¼\n\u0026ldquo;The journey of a thousand miles begins with one step.\u0026rdquo; - è€å­\n","permalink":"http://localhost:1313/posts/2024/02/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0/","summary":"\u003ch2 id=\"å¼€å§‹å†™åšå®¢\"\u003eå¼€å§‹å†™åšå®¢\u003c/h2\u003e\n\u003cp\u003eé‚£æ˜¯ä¸€æ¡ç¥å¥‡çš„å¤©è·¯å•Š ğŸµ\u003c/p\u003e\n\u003cp\u003eä»Šå¤©å¼€å§‹äº†æˆ‘çš„åšå®¢ä¹‹æ—…ï¼Œå¸Œæœ›èƒ½åœ¨è¿™é‡Œè®°å½•ä¸‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eğŸ’¡ æŠ€æœ¯å­¦ä¹ çš„å¿ƒå¾—\u003c/li\u003e\n\u003cli\u003eğŸš€ é¡¹ç›®å¼€å‘çš„ç»éªŒ\u003c/li\u003e\n\u003cli\u003eğŸ“– è¯»ä¹¦æ€è€ƒçš„æ€»ç»“\u003c/li\u003e\n\u003cli\u003eğŸŒŸ ç”Ÿæ´»ä¸­çš„æ„Ÿæ‚Ÿ\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆå†™åšå®¢\"\u003eä¸ºä»€ä¹ˆå†™åšå®¢\u003c/h2\u003e\n\u003cp\u003eå†™åšå®¢ä¸ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæ•´ç†æ€è·¯\u003c/strong\u003eï¼šé€šè¿‡å†™ä½œæ¢³ç†çŸ¥è¯†ä½“ç³»\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ·±åŒ–ç†è§£\u003c/strong\u003eï¼šæ•™æ˜¯æœ€å¥½çš„å­¦\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåˆ†äº«äº¤æµ\u003c/strong\u003eï¼šä¸ä»–äººäº¤æµæƒ³æ³•\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè®°å½•æˆé•¿\u003c/strong\u003eï¼šè§è¯è‡ªå·±çš„è¿›æ­¥\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"æœªæ¥è®¡åˆ’\"\u003eæœªæ¥è®¡åˆ’\u003c/h2\u003e\n\u003cp\u003eæ¥ä¸‹æ¥æˆ‘ä¼šåˆ†äº«æ›´å¤šå…³äºæŠ€æœ¯å’Œç”Ÿæ´»çš„å†…å®¹ï¼Œæ•¬è¯·æœŸå¾…ï¼\u003c/p\u003e\n\u003chr\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u0026ldquo;The journey of a thousand miles begins with one step.\u0026rdquo; - è€å­\u003c/p\u003e\n\u003c/blockquote\u003e","title":"æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢æ–‡ç« "},{"content":"åœ¨ Java å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ ¸å¿ƒæœºåˆ¶ã€‚ä»æœ€æ—©çš„ synchronized åˆ° JDK 1.5 å¼•å…¥çš„ AQS æ¡†æ¶ï¼ŒJava çš„é”æœºåˆ¶ç»å†äº†å·¨å¤§çš„æ¼”è¿›ã€‚ç†è§£è¿™ä¸ªæ¼”è¿›è¿‡ç¨‹ï¼Œæ˜¯æŒæ¡ Java å¹¶å‘ç¼–ç¨‹çš„å…³é”®ã€‚\næœ¬æ–‡äº®ç‚¹ ç†è§£ synchronized çš„é”å‡çº§è¿‡ç¨‹ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼‰ æŒæ¡ AQS çš„æ ¸å¿ƒåŸç†ä¸åº”ç”¨åœºæ™¯ å­¦ä¼šé€‰æ‹© ReentrantLock è¿˜æ˜¯ synchronized äº†è§£ CAS æ“ä½œä¸è‡ªæ—‹é”çš„å®ç° synchronizedï¼šä»é‡é‡çº§åˆ°è½»é‡çº§ åœ¨ JDK 1.6 ä¹‹å‰ï¼Œsynchronized æ˜¯é‡é‡çº§é”ï¼Œæ¯æ¬¡åŠ é”éƒ½éœ€è¦æ“ä½œç³»ç»Ÿçš„ mutex äº’æ–¥é‡ï¼Œæ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\nJDK 1.6 å¯¹ synchronized è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œå¼•å…¥äº†é”å‡çº§æœºåˆ¶ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”ã€‚\nå¯¹è±¡å¤´ï¼šé”ä¿¡æ¯çš„å­˜å‚¨ä½ç½®\nJava å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……ã€‚é”ä¿¡æ¯å­˜å‚¨åœ¨å¯¹è±¡å¤´çš„ Mark Word ä¸­ã€‚\nMark Word çš„ç»“æ„ï¼ˆ64 ä½ JVMï¼‰ï¼š\n1|--------------------------------------------------------------| 2| é”çŠ¶æ€ | 25bit | 31bit | 1bit | 4bit | 1bitåå‘é” | 2bité”æ ‡å¿— | 3|--------------------------------------------------------------| 4| æ— é” | unused | hashcode | unused | age | 0 | 01 | 5| åå‘é” | ThreadID | Epoch | unused | age | 1 | 01 | 6| è½»é‡çº§é” | æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ | 00 | 7| é‡é‡çº§é” | æŒ‡å‘äº’æ–¥é‡çš„æŒ‡é’ˆ | 10 | åå‘é”ï¼šå•çº¿ç¨‹åœºæ™¯çš„ä¼˜åŒ–\nå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–ã€‚åå‘é”çš„æ€æƒ³æ˜¯ï¼šç¬¬ä¸€æ¬¡è·å–é”æ—¶ï¼Œåœ¨å¯¹è±¡å¤´ä¸­è®°å½•çº¿ç¨‹ IDï¼Œåç»­è¯¥çº¿ç¨‹å†æ¬¡è·å–é”æ—¶ï¼Œåªéœ€è¦åˆ¤æ–­ Mark Word ä¸­çš„çº¿ç¨‹ ID æ˜¯å¦æ˜¯è‡ªå·±ï¼Œæ— éœ€ CAS æ“ä½œã€‚\n1public class BiasedLockDemo { 2 private static Object lock = new Object(); 3 4 public static void main(String[] args) { 5 // ç¬¬ä¸€æ¬¡åŠ é”ï¼šå‡çº§ä¸ºåå‘é” 6 synchronized (lock) { 7 System.out.println(\u0026#34;ç¬¬ä¸€æ¬¡åŠ é”\u0026#34;); 8 } 9 10 // ç¬¬äºŒæ¬¡åŠ é”ï¼šç›´æ¥è·å–åå‘é”ï¼Œæ— éœ€ CAS 11 synchronized (lock) { 12 System.out.println(\u0026#34;ç¬¬äºŒæ¬¡åŠ é”\u0026#34;); 13 } 14 } 15} åå‘é”çš„æ’¤é”€ï¼šå½“å…¶ä»–çº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œåå‘é”ä¼šæ’¤é”€ï¼Œå‡çº§ä¸ºè½»é‡çº§é”ã€‚\nè½»é‡çº§é”ï¼šå¤šçº¿ç¨‹äº¤æ›¿æ‰§è¡Œçš„ä¼˜åŒ–\nå½“æœ‰ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿è·å–é”ï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä½¿ç”¨è½»é‡çº§é”ã€‚è½»é‡çº§é”é€šè¿‡ CAS æ“ä½œå°† Mark Word æ›¿æ¢ä¸ºæŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆã€‚\n1// çº¿ç¨‹ A 2synchronized (lock) { 3 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 4} 5 6// çº¿ç¨‹ Bï¼ˆåœ¨ A é‡Šæ”¾é”åæ‰è·å–ï¼‰ 7synchronized (lock) { 8 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 9} è½»é‡çº§é”çš„åŠ é”æµç¨‹ï¼š\nåœ¨æ ˆå¸§ä¸­åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰ å°†å¯¹è±¡å¤´çš„ Mark Word å¤åˆ¶åˆ°é”è®°å½•ä¸­ é€šè¿‡ CAS å°†å¯¹è±¡å¤´çš„ Mark Word æ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆ å¦‚æœ CAS æˆåŠŸï¼Œè·å–é”ï¼›å¦‚æœå¤±è´¥ï¼Œè‡ªæ—‹é‡è¯• é‡é‡çº§é”ï¼šå¤šçº¿ç¨‹ç«äº‰çš„æœ€ç»ˆæ–¹æ¡ˆ\nå½“è‡ªæ—‹æ¬¡æ•°è¿‡å¤šï¼ˆé»˜è®¤ 10 æ¬¡ï¼‰ï¼Œæˆ–è€…æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰é”ï¼Œè½»é‡çº§é”ä¼šå‡çº§ä¸ºé‡é‡çº§é”ã€‚é‡é‡çº§é”ä¼šé˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œé€šè¿‡æ“ä½œç³»ç»Ÿçš„ mutex å®ç°ã€‚\n1// å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰ 2for (int i = 0; i \u0026lt; 10; i++) { 3 new Thread(() -\u0026gt; { 4 synchronized (lock) { 5 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 6 } 7 }).start(); 8} æ¶æ„æ€è€ƒï¼š synchronized çš„é”å‡çº§ä½“ç°äº†\u0026quot;é€‚åº”æ€§ä¼˜åŒ–\u0026quot;çš„æ€æƒ³ã€‚åœ¨ä¸åŒçš„ç«äº‰åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ä¸åŒçš„é”å®ç°ï¼Œåœ¨æ€§èƒ½å’Œæ­£ç¡®æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚è¿™ç§æ€æƒ³åœ¨å¾ˆå¤šç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ MySQL çš„è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ã€JVM çš„åˆ†å±‚ç¼–è¯‘ã€‚\nAQSï¼šå¹¶å‘å·¥å…·çš„åŸºçŸ³ AQSï¼ˆAbstractQueuedSynchronizerï¼‰æ˜¯ JDK 1.5 å¼•å…¥çš„å¹¶å‘æ¡†æ¶ï¼ŒReentrantLockã€Semaphoreã€CountDownLatch ç­‰å·¥å…·éƒ½åŸºäº AQS å®ç°ã€‚\nAQS çš„æ ¸å¿ƒæ€æƒ³\nAQS ç»´æŠ¤äº†ä¸€ä¸ª volatile int state å˜é‡å’Œä¸€ä¸ª FIFO é˜Ÿåˆ—ã€‚\nstateï¼šè¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼ˆ0 è¡¨ç¤ºæœªé”å®šï¼Œ1 è¡¨ç¤ºå·²é”å®šï¼‰ FIFO é˜Ÿåˆ—ï¼šå­˜å‚¨ç­‰å¾…è·å–é”çš„çº¿ç¨‹ ç‹¬å æ¨¡å¼ï¼šReentrantLock çš„å®ç°\nReentrantLock çš„åŠ é”æµç¨‹ï¼š\n1public class ReentrantLock { 2 3 private final Sync sync; 4 5 public void lock() { 6 sync.acquire(1); 7 } 8 9 abstract static class Sync extends AbstractQueuedSynchronizer { 10 11 final boolean tryAcquire(int acquires) { 12 final Thread current = Thread.currentThread(); 13 int c = getState(); 14 15 // å¦‚æœ state == 0ï¼Œè¯´æ˜é”æœªè¢«å ç”¨ 16 if (c == 0) { 17 if (compareAndSetState(0, acquires)) { 18 setExclusiveOwnerThread(current); 19 return true; 20 } 21 } 22 // å¦‚æœæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é”ï¼Œæ”¯æŒé‡å…¥ 23 else if (current == getExclusiveOwnerThread()) { 24 int nextc = c + acquires; 25 setState(nextc); 26 return true; 27 } 28 return false; 29 } 30 } 31} å¦‚æœ tryAcquire å¤±è´¥ï¼Œçº¿ç¨‹ä¼šè¢«åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼š\n1private Node addWaiter(Node mode) { 2 Node node = new Node(Thread.currentThread(), mode); 3 Node pred = tail; 4 5 // å¿«é€Ÿå°è¯•åœ¨é˜Ÿå°¾æ·»åŠ  6 if (pred != null) { 7 node.prev = pred; 8 if (compareAndSetTail(pred, node)) { 9 pred.next = node; 10 return node; 11 } 12 } 13 14 // å¦‚æœå¤±è´¥ï¼Œé€šè¿‡è‡ªæ—‹æ·»åŠ  15 enq(node); 16 return node; 17} ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å«çº¿ç¨‹å¼•ç”¨å’Œç­‰å¾…çŠ¶æ€ã€‚\nå…±äº«æ¨¡å¼ï¼šSemaphore çš„å®ç°\nSemaphore å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®èµ„æºï¼Œé€šè¿‡ state è¡¨ç¤ºå¯ç”¨è®¸å¯æ•°ã€‚\n1public class Semaphore { 2 3 private final Sync sync; 4 5 public void acquire() throws InterruptedException { 6 sync.acquireSharedInterruptibly(1); 7 } 8 9 abstract static class Sync extends AbstractQueuedSynchronizer { 10 11 final int tryAcquireShared(int acquires) { 12 for (;;) { 13 int available = getState(); 14 int remaining = available - acquires; 15 16 // å¦‚æœè®¸å¯ä¸è¶³ï¼Œè¿”å›è´Ÿæ•° 17 if (remaining \u0026lt; 0) { 18 return remaining; 19 } 20 21 // é€šè¿‡ CAS æ‰£å‡è®¸å¯ 22 if (compareAndSetState(available, remaining)) { 23 return remaining; 24 } 25 } 26 } 27 } 28} å…±äº«æ¨¡å¼ä¸‹ï¼Œé‡Šæ”¾é”æ—¶ä¼šå”¤é†’é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚\né¿å‘æç¤ºï¼š AQS çš„ state æ˜¯ volatile çš„ï¼Œä¿è¯äº†å¯è§æ€§ï¼Œä½†ä¸ä¿è¯åŸå­æ€§ã€‚æ‰€ä»¥ä¿®æ”¹ state æ—¶å¿…é¡»ä½¿ç”¨ CAS æ“ä½œã€‚\nReentrantLock vs synchronized åŠŸèƒ½å¯¹æ¯”\nç‰¹æ€§ synchronized ReentrantLock é”çš„å®ç° JVM å±‚é¢ JDK å±‚é¢ å¯é‡å…¥æ€§ æ”¯æŒ æ”¯æŒ å…¬å¹³é” ä¸æ”¯æŒ æ”¯æŒ å¯ä¸­æ–­ ä¸æ”¯æŒ æ”¯æŒ è¶…æ—¶è·å– ä¸æ”¯æŒ æ”¯æŒ æ¡ä»¶å˜é‡ å•ä¸ªï¼ˆwait/notifyï¼‰ å¤šä¸ªï¼ˆConditionï¼‰ æ€§èƒ½å¯¹æ¯”\nåœ¨ JDK 1.6 ä¹‹åï¼Œsynchronized ç»è¿‡ä¼˜åŒ–ï¼Œæ€§èƒ½å·²ç»å’Œ ReentrantLock ç›¸å½“ã€‚åœ¨ä½ç«äº‰åœºæ™¯ä¸‹ï¼Œsynchronized ç”šè‡³æ›´å¿«ï¼ˆå› ä¸ºæœ‰é”æ¶ˆé™¤å’Œé”ç²—åŒ–ä¼˜åŒ–ï¼‰ã€‚\nä½¿ç”¨å»ºè®®\nä¼˜å…ˆä½¿ç”¨ synchronizedï¼šä»£ç ç®€æ´ï¼ŒJVM ä¼šè‡ªåŠ¨ä¼˜åŒ– éœ€è¦é«˜çº§ç‰¹æ€§æ—¶ä½¿ç”¨ ReentrantLockï¼šå…¬å¹³é”ã€å¯ä¸­æ–­ã€è¶…æ—¶è·å– å®æˆ˜æ¡ˆä¾‹ï¼šå¯ä¸­æ–­é”\n1public class InterruptibleLockDemo { 2 3 private final ReentrantLock lock = new ReentrantLock(); 4 5 public void doWork() throws InterruptedException { 6 // å¯ä¸­æ–­åœ°è·å–é” 7 lock.lockInterruptibly(); 8 try { 9 // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 10 Thread.sleep(10000); 11 } finally { 12 lock.unlock(); 13 } 14 } 15 16 public static void main(String[] args) throws InterruptedException { 17 InterruptibleLockDemo demo = new InterruptibleLockDemo(); 18 19 Thread t1 = new Thread(() -\u0026gt; { 20 try { 21 demo.doWork(); 22 } catch (InterruptedException e) { 23 System.out.println(\u0026#34;çº¿ç¨‹è¢«ä¸­æ–­\u0026#34;); 24 } 25 }); 26 27 t1.start(); 28 Thread.sleep(1000); 29 t1.interrupt(); // ä¸­æ–­çº¿ç¨‹ 30 } 31} å¦‚æœä½¿ç”¨ synchronizedï¼Œçº¿ç¨‹æ— æ³•è¢«ä¸­æ–­ï¼Œåªèƒ½ç­‰å¾…é”é‡Šæ”¾ã€‚\nCAS ä¸è‡ªæ—‹é” CASï¼ˆCompare And Swapï¼‰æ˜¯å®ç°æ— é”å¹¶å‘çš„åŸºç¡€ã€‚\nCAS çš„åŸç†\nCAS åŒ…å«ä¸‰ä¸ªæ“ä½œæ•°ï¼šå†…å­˜ä½ç½® Vã€é¢„æœŸå€¼ Aã€æ–°å€¼ Bã€‚åªæœ‰å½“ V çš„å€¼ç­‰äº A æ—¶ï¼Œæ‰ä¼šå°† V æ›´æ–°ä¸º Bã€‚\n1public class AtomicInteger { 2 3 private volatile int value; 4 5 public final boolean compareAndSet(int expect, int update) { 6 return unsafe.compareAndSwapInt(this, valueOffset, expect, update); 7 } 8 9 public final int incrementAndGet() { 10 for (;;) { 11 int current = get(); 12 int next = current + 1; 13 if (compareAndSet(current, next)) { 14 return next; 15 } 16 } 17 } 18} CAS çš„ä¼˜åŠ¿ï¼šæ— éœ€åŠ é”ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\nCAS çš„é—®é¢˜ï¼š\nABA é—®é¢˜ï¼šå€¼ä» A å˜æˆ Bï¼Œå†å˜å› Aï¼ŒCAS æ— æ³•æ„ŸçŸ¥ è‡ªæ—‹å¼€é”€ï¼šå¦‚æœé•¿æ—¶é—´ CAS å¤±è´¥ï¼Œä¼šæµªè´¹ CPU åªèƒ½ä¿è¯å•ä¸ªå˜é‡çš„åŸå­æ€§ è‡ªæ—‹é”çš„å®ç°\n1public class SpinLock { 2 3 private AtomicReference\u0026lt;Thread\u0026gt; owner = new AtomicReference\u0026lt;\u0026gt;(); 4 5 public void lock() { 6 Thread current = Thread.currentThread(); 7 // è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ° CAS æˆåŠŸ 8 while (!owner.compareAndSet(null, current)) { 9 } 10 } 11 12 public void unlock() { 13 Thread current = Thread.currentThread(); 14 owner.compareAndSet(current, null); 15 } 16} è‡ªæ—‹é”é€‚åˆé”æŒæœ‰æ—¶é—´å¾ˆçŸ­çš„åœºæ™¯ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡çš„å¼€é”€ã€‚\næ€»ç»“ä¸æ€è€ƒ Java é”æœºåˆ¶çš„æ¼”è¿›ä½“ç°äº†æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€æƒ³ï¼šåœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ã€‚\nsynchronizedï¼šä»é‡é‡çº§é”ä¼˜åŒ–ä¸ºé”å‡çº§æœºåˆ¶ï¼Œé€‚åº”ä¸åŒç«äº‰åœºæ™¯ AQSï¼šæä¾›äº†çµæ´»çš„å¹¶å‘å·¥å…·æ¡†æ¶ï¼Œæ”¯æŒç‹¬å å’Œå…±äº«æ¨¡å¼ CASï¼šæ— é”å¹¶å‘çš„åŸºç¡€ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡ ç†è§£è¿™äº›æœºåˆ¶ï¼Œæ‰èƒ½åœ¨å®é™…å¼€å‘ä¸­é€‰æ‹©åˆé€‚çš„å¹¶å‘å·¥å…·ï¼Œå†™å‡ºé«˜æ€§èƒ½çš„å¹¶å‘ä»£ç ã€‚\nä¸‹æ¬¡å½“ä½ éœ€è¦åŠ é”æ—¶ï¼Œä¸å¦¨æƒ³æƒ³ï¼šè¿™ä¸ªåœºæ™¯é€‚åˆ synchronized è¿˜æ˜¯ ReentrantLockï¼Ÿæ˜¯å¦å¯ä»¥ç”¨ CAS å®ç°æ— é”å¹¶å‘ï¼Ÿ\n","permalink":"http://localhost:1313/posts/2024/01/java-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%BB%8E-synchronized-%E5%88%B0-aqs-%E7%9A%84%E6%BC%94%E8%BF%9B/","summary":"\u003cp\u003eåœ¨ Java å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ ¸å¿ƒæœºåˆ¶ã€‚ä»æœ€æ—©çš„ synchronized åˆ° JDK 1.5 å¼•å…¥çš„ AQS æ¡†æ¶ï¼ŒJava çš„é”æœºåˆ¶ç»å†äº†å·¨å¤§çš„æ¼”è¿›ã€‚ç†è§£è¿™ä¸ªæ¼”è¿›è¿‡ç¨‹ï¼Œæ˜¯æŒæ¡ Java å¹¶å‘ç¼–ç¨‹çš„å…³é”®ã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬æ–‡äº®ç‚¹\"\u003eæœ¬æ–‡äº®ç‚¹\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e ç†è§£ synchronized çš„é”å‡çº§è¿‡ç¨‹ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼‰\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e æŒæ¡ AQS çš„æ ¸å¿ƒåŸç†ä¸åº”ç”¨åœºæ™¯\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å­¦ä¼šé€‰æ‹© ReentrantLock è¿˜æ˜¯ synchronized\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e äº†è§£ CAS æ“ä½œä¸è‡ªæ—‹é”çš„å®ç°\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"synchronizedä»é‡é‡çº§åˆ°è½»é‡çº§\"\u003esynchronizedï¼šä»é‡é‡çº§åˆ°è½»é‡çº§\u003c/h2\u003e\n\u003cp\u003eåœ¨ JDK 1.6 ä¹‹å‰ï¼Œsynchronized æ˜¯é‡é‡çº§é”ï¼Œæ¯æ¬¡åŠ é”éƒ½éœ€è¦æ“ä½œç³»ç»Ÿçš„ mutex äº’æ–¥é‡ï¼Œæ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ€§èƒ½å¾ˆå·®ã€‚\u003c/p\u003e\n\u003cp\u003eJDK 1.6 å¯¹ synchronized è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œå¼•å…¥äº†é”å‡çº§æœºåˆ¶ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå¯¹è±¡å¤´ï¼šé”ä¿¡æ¯çš„å­˜å‚¨ä½ç½®\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eJava å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šå¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……ã€‚é”ä¿¡æ¯å­˜å‚¨åœ¨å¯¹è±¡å¤´çš„ Mark Word ä¸­ã€‚\u003c/p\u003e\n\u003cp\u003eMark Word çš„ç»“æ„ï¼ˆ64 ä½ JVMï¼‰ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e|--------------------------------------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e| é”çŠ¶æ€   | 25bit | 31bit | 1bit | 4bit | 1bitåå‘é” | 2bité”æ ‡å¿— |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e|--------------------------------------------------------------|\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e| æ— é”     | unused | hashcode | unused | age | 0 | 01 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e| åå‘é”   | ThreadID | Epoch | unused | age | 1 | 01 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e| è½»é‡çº§é” | æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ | 00 |\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e| é‡é‡çº§é” | æŒ‡å‘äº’æ–¥é‡çš„æŒ‡é’ˆ | 10 |\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåå‘é”ï¼šå•çº¿ç¨‹åœºæ™¯çš„ä¼˜åŒ–\u003c/strong\u003e\u003c/p\u003e","title":"Java å¹¶å‘ç¼–ç¨‹ï¼šä» synchronized åˆ° AQS çš„æ¼”è¿›"},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"","permalink":"http://localhost:1313/posts/1/01/","summary":"","title":""},{"content":"ä½ å¥½ï¼Œæˆ‘æ˜¯ wawayu ä¸€åä¸“æ³¨äºåˆ†å¸ƒå¼ç³»ç»Ÿå’Œé«˜å¹¶å‘æ¶æ„çš„ Java åç«¯å¼€å‘å·¥ç¨‹å¸ˆã€‚æˆ‘çƒ­è¡·äºç”¨æŠ€æœ¯è§£å†³å®é™…ä¸šåŠ¡é—®é¢˜ï¼Œæ“…é•¿ä» 0 åˆ° 1 è®¾è®¡å’Œå®ç°å¤æ‚ç³»ç»Ÿã€‚\nç›®å‰åœ¨æŸæ˜•ç½‘ç»œç§‘æŠ€å…¬å¸æ‹…ä»» Java å¼€å‘å®ä¹ ç”Ÿï¼Œè´Ÿè´£å¿«é€Ÿè¿­ä»£ä¸äº¤ä»˜ 20+ ä¸ªå®šåˆ¶åŒ–é¡¹ç›®ï¼Œç§¯ç´¯äº†ä¸°å¯Œçš„ä¸šåŠ¡å¼€å‘å’Œç³»ç»Ÿä¼˜åŒ–ç»éªŒã€‚\næˆ‘çš„æŠ€æœ¯ç†å¿µ ä»£ç æ˜¯å†™ç»™äººçœ‹çš„ï¼Œé¡ºä¾¿è®©æœºå™¨æ‰§è¡Œ æ¶æ„è®¾è®¡è¦é€‚é…ä¸šåŠ¡å¤æ‚åº¦ï¼Œé¿å…è¿‡åº¦è®¾è®¡ æ€§èƒ½ä¼˜åŒ–è¦åŸºäºæ•°æ®é©±åŠ¨ï¼Œè€Œä¸æ˜¯å‡­æ„Ÿè§‰ æŠ€æœ¯çš„æœ¬è´¨æ˜¯è§£å†³é—®é¢˜ï¼Œè€Œä¸æ˜¯ç‚«æŠ€ æ•™è‚²èƒŒæ™¯ å¤ªåŸç†å·¥å¤§å­¦ - è½¯ä»¶å·¥ç¨‹ï¼ˆåŒä¸€æµï¼‰ - æœ¬ç§‘ (2022.09 - 2026.06) å·¥ä½œç»å† æŸæ˜•ç½‘ç»œç§‘æŠ€å…¬å¸ - Java å¼€å‘å®ä¹ ç”Ÿ (2024.06 - 2024.12)\nè´Ÿè´£å¿«é€Ÿå¼€å‘ä¸äº¤ä»˜ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¸»åŠ¨æ•´ç†é€šç”¨ä»£ç æ¨¡ç‰ˆï¼Œå‡å°‘äº†é‡å¤ CRUD å·¥ä½œï¼Œé…åˆå›¢é˜Ÿé«˜æ•ˆäº¤ä»˜äº† 20+ ä¸ªå®šåˆ¶åŒ–é¡¹ç›®ã€‚\næ ¸å¿ƒæˆæœï¼š\nè®¾è®¡å¹¶å®ç°åŠ¨æ€çº¿ç¨‹æ±  SDKï¼Œæ”¯æŒå‚æ•°å®æ—¶è°ƒæ•´å’Œå¯è§†åŒ–ç›‘æ§ å‚ä¸æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿå¼€å‘ï¼Œè´Ÿè´£ DDD æ¶æ„è®¾è®¡å’Œåˆ†å¸ƒå¼é”ä¼˜åŒ– ä¼˜åŒ–æ ¸å¿ƒæ¥å£æ€§èƒ½ï¼ŒRT ä» 800ms é™ä½åˆ° 120ms æŠ€æœ¯ä¸“é•¿ è¯¦è§ æŠ€èƒ½æ ˆ\né¡¹ç›®ä½œå“ è¯¦è§ é¡¹ç›®å±•ç¤º\nå¼€æºè´¡çŒ® æ­£åœ¨ç­¹å¤‡ä¸­ï¼Œè®¡åˆ’å¼€æºåŠ¨æ€çº¿ç¨‹æ±  SDK å’Œä¸€äº›å®ç”¨å·¥å…·åº“ã€‚\nè”ç³»æ–¹å¼ Email: your-email@example.com GitHub: github.com/wawayu-dev åšå®¢: ä½ æ­£åœ¨æµè§ˆçš„è¿™ä¸ªç«™ç‚¹ å…³äºè¿™ä¸ªåšå®¢ è¿™ä¸ªåšå®¢æ˜¯æˆ‘çš„æŠ€æœ¯ç¬”è®°å’Œæ€è€ƒæ²‰æ·€çš„åœ°æ–¹ã€‚æˆ‘ä¼šåœ¨è¿™é‡Œåˆ†äº«ï¼š\né¡¹ç›®å®æˆ˜ç»éªŒå’Œè¸©å‘è®°å½• æŠ€æœ¯åŸç†çš„æ·±åº¦å‰–æ æ¶æ„è®¾è®¡çš„æ€è€ƒä¸å®è·µ å­¦ä¹ æ–¹æ³•å’Œæˆé•¿å¿ƒå¾— å¦‚æœä½ å¯¹æŸä¸ªè¯é¢˜æ„Ÿå…´è¶£ï¼Œæˆ–è€…å‘ç°æ–‡ç« ä¸­çš„é—®é¢˜ï¼Œæ¬¢è¿é€šè¿‡é‚®ä»¶æˆ– GitHub ä¸æˆ‘äº¤æµã€‚\nè¿™ä¸ªç½‘ç«™ä½¿ç”¨ Hugo + PaperMod æ­å»ºï¼Œæ‰˜ç®¡åœ¨ GitHub Pages\n","permalink":"http://localhost:1313/about/","summary":"Java åç«¯å¼€å‘å·¥ç¨‹å¸ˆ | åˆ†å¸ƒå¼ç³»ç»Ÿå®è·µè€…","title":"å…³äºæˆ‘"},{"content":"ç¼–ç¨‹è¯­è¨€ è¯­è¨€ ç†Ÿç»ƒåº¦ ä¸»è¦ç”¨é€” Java â­â­â­â­â­ åç«¯å¼€å‘ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€å¾®æœåŠ¡æ¶æ„ SQL â­â­â­â­ æ•°æ®åº“è®¾è®¡ã€æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•è°ƒä¼˜ JavaScript â­â­â­ å‰ç«¯å¼€å‘ã€Vue 3 åº”ç”¨ æ ¸å¿ƒæŠ€æœ¯æ ˆ åç«¯æ¡†æ¶ä¸ä¸­é—´ä»¶ Spring ç”Ÿæ€\nSpring Bootï¼šç†Ÿæ‚‰è‡ªåŠ¨è£…é…åŸç†ï¼Œèƒ½å¤Ÿè‡ªå®šä¹‰ Starter Spring AOP/IOCï¼šç†è§£æ ¸å¿ƒæ€æƒ³ï¼Œç†Ÿæ‚‰ Bean ç”Ÿå‘½å‘¨æœŸ MyBatis-Plusï¼šå¿«é€Ÿå¼€å‘ CRUDï¼Œç†Ÿæ‚‰ä»£ç ç”Ÿæˆå’Œé€šç”¨ Mapper åˆ†å¸ƒå¼ä¸é«˜å¹¶å‘\nRedisï¼šåˆ†å¸ƒå¼é”ï¼ˆRedissonï¼‰ã€ç¼“å­˜æ¶æ„è®¾è®¡ã€Pub/Sub æœºåˆ¶ RabbitMQï¼šæ¶ˆæ¯å¯é æ€§ä¿éšœã€å¼‚æ­¥è§£è€¦ã€æ­»ä¿¡é˜Ÿåˆ— Netty + WebSocketï¼šå®æ—¶æ¶ˆæ¯æ¨é€ã€é•¿è¿æ¥ç®¡ç† æ•°æ®åº“\nMySQLï¼šç´¢å¼•ä¼˜åŒ–ã€äº‹åŠ¡éš”ç¦»çº§åˆ«ã€MVCC æœºåˆ¶ã€B+ æ ‘ç´¢å¼•å¼•æ“ ShardingSphereï¼šåˆ†åº“åˆ†è¡¨å®æˆ˜ã€åˆ†ç‰‡ç­–ç•¥è®¾è®¡ æ¶æ„è®¾è®¡ è®¾è®¡æ¨¡å¼ä¸æ¶æ„æ€æƒ³\nDDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰ï¼šèšåˆæ ¹ã€é™ç•Œä¸Šä¸‹æ–‡ã€é¢†åŸŸäº‹ä»¶ è®¾è®¡æ¨¡å¼ï¼šç†Ÿæ‚‰ç­–ç•¥ã€æ¨¡æ¿æ–¹æ³•ã€è´£ä»»é“¾ç­‰å¸¸ç”¨æ¨¡å¼ è§„åˆ™å¼•æ“ï¼šç†è§£å¦‚ä½•é€šè¿‡è§„åˆ™å¼•æ“åˆ¤æ–­å¤æ‚ä¸šåŠ¡é€»è¾‘ æ€§èƒ½ä¼˜åŒ–\nJVM è°ƒä¼˜ï¼šç†è§£ GC æœºåˆ¶ã€å†…å­˜æ¨¡å‹ã€OOM æ’æŸ¥ æ¥å£ä¼˜åŒ–ï¼šä» 800ms ä¼˜åŒ–åˆ° 120ms çš„å®æˆ˜ç»éªŒ æ•°æ®åº“ä¼˜åŒ–ï¼šSQL è°ƒä¼˜ã€ç´¢å¼•è®¾è®¡ã€åˆ†åº“åˆ†è¡¨ å‰ç«¯æŠ€æœ¯ Vue 3ï¼šComposition APIã€å‰åç«¯åˆ†ç¦»å¼€å‘ EasyExcelï¼šç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºã€å†…å­˜ä¼˜åŒ– å·¥å…·ä¸è¿ç»´ å¼€å‘å·¥å…·\nGitï¼šåˆ†æ”¯ç®¡ç†ã€ä»£ç å®¡æŸ¥ã€å›¢é˜Ÿåä½œ Mavenï¼šä¾èµ–ç®¡ç†ã€å¤šæ¨¡å—é¡¹ç›®æ„å»º Dockerï¼šå®¹å™¨åŒ–éƒ¨ç½²ã€å¤šé˜¶æ®µæ„å»ºã€Docker Compose è¿ç»´ä¸éƒ¨ç½²\nNginxï¼šåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€é™æ€èµ„æºç¼“å­˜ Linuxï¼šå¸¸ç”¨å‘½ä»¤ã€Shell è„šæœ¬ã€æœåŠ¡å™¨è¿ç»´ ä¸­é—´ä»¶ä¸å·¥å…·\nZookeeperï¼šåˆ†å¸ƒå¼åè°ƒã€æœåŠ¡æ³¨å†Œå‘ç° Dubboï¼šRPC æ¡†æ¶ã€æœåŠ¡æ²»ç† æŠ€æœ¯æ·±åº¦ æºç é˜…è¯»èƒ½åŠ› Spring Boot Starter è‡ªåŠ¨è£…é…æœºåˆ¶ Redisson çœ‹é—¨ç‹—ç»­æœŸåŸç† MyBatis åŠ¨æ€ SQL ç”Ÿæˆæµç¨‹ é—®é¢˜æ’æŸ¥èƒ½åŠ› çº¿ä¸Š OOM é—®é¢˜å®šä½ï¼ˆjmapã€MAT å·¥å…·ï¼‰ æ¥å£æ€§èƒ½ç“¶é¢ˆåˆ†æï¼ˆArthasã€JProfilerï¼‰ åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜æ’æŸ¥ æ¶æ„è®¾è®¡èƒ½åŠ› ä» 0 åˆ° 1 è®¾è®¡æ‹¼å›¢äº¤æ˜“å¹³å°ï¼ˆDDD æ¶æ„ï¼‰ è®¾è®¡åŠ¨æ€çº¿ç¨‹æ±  SDKï¼ˆé›¶ä¾µå…¥å¼ï¼‰ åˆ†å¸ƒå¼é”æ–¹æ¡ˆè®¾è®¡ï¼ˆRedis + Redissonï¼‰ å­¦ä¹ æ–¹æ³• æˆ‘ç›¸ä¿¡\u0026quot;æºç æ˜¯æœ€å¥½çš„è€å¸ˆ\u0026quot;ã€‚åœ¨å­¦ä¹ æ–°æŠ€æœ¯æ—¶ï¼Œæˆ‘ä¼šï¼š\nå…ˆç†è§£æ ¸å¿ƒæ¦‚å¿µå’Œä½¿ç”¨åœºæ™¯ é€šè¿‡å®æˆ˜é¡¹ç›®åŠ æ·±ç†è§£ é˜…è¯»æºç ç†è§£åº•å±‚å®ç° æ€»ç»“æˆåšå®¢æ–‡ç« æ²‰æ·€çŸ¥è¯† æ­£åœ¨å­¦ä¹  Kubernetesï¼šå®¹å™¨ç¼–æ’ã€æœåŠ¡ç½‘æ ¼ Elasticsearchï¼šå…¨æ–‡æœç´¢ã€æ—¥å¿—åˆ†æ Go è¯­è¨€ï¼šé«˜å¹¶å‘ç¼–ç¨‹ã€å¾®æœåŠ¡å¼€å‘ æŠ€èƒ½è®¤è¯ ç†Ÿæ‚‰ JUC å¹¶å‘å·¥å…·ã€ç†è§£ AQSã€CAS åŠé”å‡çº§è¿‡ç¨‹ ç†Ÿæ‚‰çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜å’Œç›‘æ§ ç†è§£ volatileã€synchronized çš„å†…å­˜è¯­ä¹‰ä¸å¯è§æ€§ ä»¥ä¸ŠæŠ€èƒ½å‡æ¥è‡ªå®é™…é¡¹ç›®ç»éªŒå’Œæ·±åº¦å­¦ä¹ ï¼ŒæŒç»­æ›´æ–°ä¸­\n","permalink":"http://localhost:1313/skills/","summary":"æŠ€æœ¯èƒ½åŠ›æ€»è§ˆ - ä¸“æ³¨åç«¯å¼€å‘ä¸åˆ†å¸ƒå¼ç³»ç»Ÿ","title":"æŠ€èƒ½æ ˆ"}]